#!/usr/bin/env python3
# -*- coding: utf-8 -*-

from flask import Flask, render_template_string, request, redirect, url_for, session, jsonify, flash, send_from_directory
from flask_socketio import SocketIO, emit, join_room, leave_room
from werkzeug.security import generate_password_hash, check_password_hash
import sqlite3
import os
import random
import secrets
import string
import json
import hashlib
from datetime import datetime, timedelta
from functools import wraps
import re
import base64
import threading
import time
from io import BytesIO
from PIL import Image
import io
import requests

app = Flask(__name__)

SECRET_KEY = os.getenv('SECRET_KEY')

WEAK_KEYS = [
    'secret', 'password', '123456', 'admin', 'test', 'demo',
    'gaming_site_secret_key', 'my_secret_key', 'changeme',
    'SECRET_KEY', 'secret_key', 'mysecret', 'default'
]

def validate_secret_key(key):
    """Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù‚ÙˆØ© ÙˆØ£Ù…Ø§Ù† Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø³Ø±ÙŠ"""
    if not key:
        print("âŒ Ø®Ø·Ø£: SECRET_KEY ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!")
        print("âš ï¸ ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© SECRET_KEY ÙƒÙ€ Secret Ù…Ø´ÙØ± ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Replit")
        return False
    
    if len(key) < 32:
        print("âŒ Ø®Ø·Ø£: SECRET_KEY Ù‚ØµÙŠØ± Ø¬Ø¯Ø§Ù‹ (Ø£Ù‚Ù„ Ù…Ù† 32 Ø­Ø±Ù)!")
        print("âš ï¸ ÙŠØ¬Ø¨ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ÙØªØ§Ø­ Ø·ÙˆÙŠÙ„ ÙˆØ¢Ù…Ù†")
        return False
    
    key_lower = key.lower()
    for weak in WEAK_KEYS:
        if weak in key_lower:
            print(f"âŒ Ø®Ø·Ø£: SECRET_KEY ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ÙƒÙ„Ù…Ø© Ø¶Ø¹ÙŠÙØ© '{weak}'!")
            print("âš ï¸ ÙŠØ¬Ø¨ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ÙØªØ§Ø­ Ø¹Ø´ÙˆØ§Ø¦ÙŠ ÙˆØ¢Ù…Ù†")
            return False
    
    return True

if not validate_secret_key(SECRET_KEY):
    print("\n" + "="*50)
    print("ğŸ” Ù„Ø¥Ø¹Ø¯Ø§Ø¯ SECRET_KEY Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­:")
    print("1. Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ Secrets ÙÙŠ Ù„ÙˆØ­Ø© Replit")
    print("2. Ø£Ø¶Ù secret Ø¬Ø¯ÙŠØ¯ Ø¨Ø§Ø³Ù… SECRET_KEY")
    print("3. Ø§Ø³ØªØ®Ø¯Ù… Ù‚ÙŠÙ…Ø© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© Ø·ÙˆÙŠÙ„Ø© (32+ Ø­Ø±Ù)")
    print("="*50 + "\n")
    import sys
    sys.exit(1)

print("âœ… SECRET_KEY ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù†Ù‡ Ø¨Ù†Ø¬Ø§Ø­")
app.secret_key = SECRET_KEY
app.config['MAX_CONTENT_LENGTH'] = 16 * 1024 * 1024
app.config['PERMANENT_SESSION_LIFETIME'] = timedelta(days=30)
app.config['SESSION_COOKIE_SAMESITE'] = 'Lax'
app.config['SESSION_COOKIE_SECURE'] = False

socketio = SocketIO(
    app, 
    cors_allowed_origins="*", 
    async_mode='eventlet',
    ping_interval=25,
    ping_timeout=60,
    max_http_buffer_size=1e7
)

STATIC_DIR = os.path.join(os.path.dirname(__file__), 'static')

DATABASE_PATH = 'gaming_site.db'

USE_POSTGRESQL = os.getenv('USE_POSTGRESQL', 'false').lower() == 'true'
POSTGRES_URL = os.getenv('DATABASE_URL', '')

ADMIN_USERNAME = os.getenv('ADMIN_USERNAME', '').strip()
ADMIN_PASSWORD = os.getenv('ADMIN_PASSWORD', '').strip()
ADMIN_PIN = os.getenv('ADMIN_PIN', '').strip()

if not ADMIN_USERNAME or not ADMIN_PASSWORD or not ADMIN_PIN:
    ADMIN_ENABLED = False
else:
    ADMIN_ENABLED = True


BNB_WALLET_ADDRESS = os.getenv('BNB_WALLET_ADDRESS', '0xa3a6afdf80d1966fc83acf8b06a1bbab2c6634c0')

GIFT_PRICE_MAP = {
    0.10: 0.09,
    0.25: 0.20,
    0.30: 0.09,
    0.50: 0.35,
    1.00: 0.70,
    2.00: 1.50,
    5.00: 4.00,
    10.00: 7.00,
    20.00: 15.00,
}

VALID_GIFT_IDS = {
    'heart': {'price': 0.10, 'emoji': 'â¤ï¸', 'name': 'Ù‚Ù„Ø¨'},
    'rose': {'price': 0.25, 'emoji': 'ğŸŒ¹', 'name': 'ÙˆØ±Ø¯Ø©'},
    'diamond': {'price': 0.50, 'emoji': 'ğŸ’', 'name': 'Ù…Ø§Ø³Ø©'},
    'trophy': {'price': 1.00, 'emoji': 'ğŸ†', 'name': 'ÙƒØ£Ø³'},
    'crown': {'price': 2.00, 'emoji': 'ğŸ‘‘', 'name': 'ØªØ§Ø¬'},
    'car': {'price': 5.00, 'emoji': 'ğŸš—', 'name': 'Ø³ÙŠØ§Ø±Ø©'},
    'plane': {'price': 10.00, 'emoji': 'âœˆï¸', 'name': 'Ø·Ø§Ø¦Ø±Ø©'},
    'castle': {'price': 20.00, 'emoji': 'ğŸ°', 'name': 'Ù‚Ù„Ø¹Ø©'},
}

gift_processing_lock = threading.Lock()
processed_gift_tokens = set()

def calculate_gift_value(original_price):
    """Ø­Ø³Ø§Ø¨ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„ÙØ¹Ù„ÙŠØ© Ù„Ù„Ù‡Ø¯ÙŠØ© Ø¨Ø¹Ø¯ Ø®ØµÙ… Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©"""
    original_price = round(float(original_price), 2)
    if original_price in GIFT_PRICE_MAP:
        return GIFT_PRICE_MAP[original_price]
    if original_price <= 0.30:
        return round(original_price * 0.30, 2)
    elif original_price <= 1.00:
        return round(original_price * 0.70, 2)
    elif original_price <= 5.00:
        return round(original_price * 0.75, 2)
    else:
        return round(original_price * 0.75, 2)

def generate_gift_token():
    """ØªÙˆÙ„ÙŠØ¯ Ø±Ù…Ø² ÙØ±ÙŠØ¯ Ù„Ù„Ù‡Ø¯ÙŠØ©"""
    timestamp = int(time.time() * 1000000)
    random_part = secrets.token_hex(8)
    return f"GIFT_{timestamp}_{random_part}"

def validate_gift_request(gift_id, gift_price):
    """Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø·Ù„Ø¨ Ø§Ù„Ù‡Ø¯ÙŠØ©"""
    if gift_id not in VALID_GIFT_IDS:
        return False, "Ù‡Ø¯ÙŠØ© ØºÙŠØ± ØµØ§Ù„Ø­Ø©"
    expected_price = VALID_GIFT_IDS[gift_id]['price']
    if abs(float(gift_price) - expected_price) > 0.001:
        return False, "Ø³Ø¹Ø± Ø§Ù„Ù‡Ø¯ÙŠØ© ØºÙŠØ± ØµØ­ÙŠØ­"
    return True, None

STREAMING_REQUIREMENTS = {
    'wins_030': {'bet_amount': 0.30, 'required': 7, 'label': 'Ø§Ù„ÙÙˆØ² ÙÙŠ Ù…Ø¨Ø§Ø±Ø§Ø© Ù„ÙˆØ¯Ùˆ Ø¨Ù‚ÙŠÙ…Ø© 0.30$'},
    'wins_100': {'bet_amount': 1.00, 'required': 5, 'label': 'Ø§Ù„ÙÙˆØ² ÙÙŠ Ù…Ø¨Ø§Ø±Ø§Ø© Ù„ÙˆØ¯Ùˆ Ø¨Ù‚ÙŠÙ…Ø© 1$'},
    'wins_300': {'bet_amount': 3.00, 'required': 3, 'label': 'Ø§Ù„ÙÙˆØ² ÙÙŠ Ù…Ø¨Ø§Ø±Ø§Ø© Ù„ÙˆØ¯Ùˆ Ø¨Ù‚ÙŠÙ…Ø© 3$'},
    'gifts_sent': {'required': 15.00, 'label': 'Ø¥Ø±Ø³Ø§Ù„ Ù‡Ø¯Ø§ÙŠØ§ ÙÙŠ Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ø¨Ù‚ÙŠÙ…Ø© 15$'}
}

def get_streaming_requirements_progress(user_id):
    """Ø­Ø³Ø§Ø¨ ØªÙ‚Ø¯Ù… Ø´Ø±ÙˆØ· ØªÙØ¹ÙŠÙ„ Ù…ÙŠØ²Ø© Ø§Ù„Ø¨Ø«"""
    try:
        conn = get_db()
        cursor = conn.cursor()
        
        # Ø­Ø³Ø§Ø¨ Ø§Ù†ØªØµØ§Ø±Ø§Øª Ø§Ù„Ù„ÙˆØ¯Ùˆ Ø­Ø³Ø¨ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø±Ù‡Ø§Ù† Ù…Ù† Ø³Ø¬Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø¨Ù…Ø§ ÙÙŠ Ø°Ù„Ùƒ Ø§Ù„ÙÙˆØ² Ø¨Ø³Ø¨Ø¨ Ø§Ù†Ø³Ø­Ø§Ø¨ Ø§Ù„Ø®ØµÙ…)
        cursor.execute('''
            SELECT bet_amount, COUNT(*) as wins
            FROM ludo_game_history
            WHERE winner_id = ?
            GROUP BY bet_amount
        ''', (user_id,))
        wins_by_bet = {round(float(row['bet_amount']), 2): row['wins'] for row in cursor.fetchall()}
        
        # Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ø§Ù„Ù…Ø±Ø³Ù„Ø© ÙÙŠ Ø§Ù„Ø¨Ø«
        cursor.execute('''
            SELECT COALESCE(SUM(original_price), 0) as total_gifts_sent
            FROM stream_gift_transactions
            WHERE sender_id = ? AND status = 'completed'
        ''', (user_id,))
        gifts_result = cursor.fetchone()
        total_gifts_sent = round(float(gifts_result['total_gifts_sent']), 2) if gifts_result else 0
        
        # Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙ‚Ø¯Ù… Ù„ÙƒÙ„ Ø´Ø±Ø·
        progress = {
            'wins_030': {
                'current': wins_by_bet.get(0.30, 0),
                'required': STREAMING_REQUIREMENTS['wins_030']['required'],
                'label': STREAMING_REQUIREMENTS['wins_030']['label'],
                'completed': wins_by_bet.get(0.30, 0) >= STREAMING_REQUIREMENTS['wins_030']['required']
            },
            'wins_100': {
                'current': wins_by_bet.get(1.00, 0),
                'required': STREAMING_REQUIREMENTS['wins_100']['required'],
                'label': STREAMING_REQUIREMENTS['wins_100']['label'],
                'completed': wins_by_bet.get(1.00, 0) >= STREAMING_REQUIREMENTS['wins_100']['required']
            },
            'wins_300': {
                'current': wins_by_bet.get(3.00, 0),
                'required': STREAMING_REQUIREMENTS['wins_300']['required'],
                'label': STREAMING_REQUIREMENTS['wins_300']['label'],
                'completed': wins_by_bet.get(3.00, 0) >= STREAMING_REQUIREMENTS['wins_300']['required']
            },
            'gifts_sent': {
                'current': total_gifts_sent,
                'required': STREAMING_REQUIREMENTS['gifts_sent']['required'],
                'label': STREAMING_REQUIREMENTS['gifts_sent']['label'],
                'completed': total_gifts_sent >= STREAMING_REQUIREMENTS['gifts_sent']['required'],
                'is_money': True
            }
        }
        
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ÙƒØªÙ…Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ø±ÙˆØ·
        all_completed = all(p['completed'] for p in progress.values())
        
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        cursor.execute('SELECT streaming_enabled FROM users WHERE id = ?', (user_id,))
        user_result = cursor.fetchone()
        streaming_enabled = user_result['streaming_enabled'] if user_result and user_result['streaming_enabled'] else 0
        
        # ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¨Ø« ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¥Ø°Ø§ Ø§ÙƒØªÙ…Ù„Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ø±ÙˆØ·
        if all_completed and not streaming_enabled:
            cursor.execute('UPDATE users SET streaming_enabled = 1 WHERE id = ?', (user_id,))
            conn.commit()
            streaming_enabled = 1
        
        conn.close()
        
        return {
            'progress': progress,
            'all_completed': all_completed,
            'streaming_enabled': streaming_enabled == 1
        }
    except Exception as e:
        print(f"Ø®Ø·Ø£ ÙÙŠ Ø­Ø³Ø§Ø¨ Ø´Ø±ÙˆØ· Ø§Ù„Ø¨Ø«: {e}")
        return {
            'progress': {},
            'all_completed': False,
            'streaming_enabled': False
        }

def check_user_streaming_enabled(user_id):
    """Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙØ¹ÙŠÙ„ Ù…ÙŠØ²Ø© Ø§Ù„Ø¨Ø« Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…"""
    try:
        conn = get_db()
        cursor = conn.cursor()
        cursor.execute('SELECT streaming_enabled FROM users WHERE id = ?', (user_id,))
        result = cursor.fetchone()
        conn.close()
        if result and result['streaming_enabled']:
            return True
        # Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø´Ø±ÙˆØ· Ù„Ù„ØªØ£ÙƒØ¯
        progress_data = get_streaming_requirements_progress(user_id)
        return progress_data.get('streaming_enabled', False)
    except Exception as e:
        print(f"Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¨Ø«: {e}")
        return False

ludo_rate_limits = {}
LUDO_RATE_LIMIT_SECONDS = 0.3

stream_viewers = {}
stream_viewers_lock = threading.Lock()

def _decrement_viewer_count(game_id, sid=None):
    """Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¥Ù†Ù‚Ø§Øµ Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ†"""
    try:
        conn = get_db()
        cursor = conn.cursor()
        cursor.execute('UPDATE ludo_streams SET viewer_count = MAX(0, viewer_count - 1) WHERE game_id = ? AND is_active = 1', (game_id,))
        conn.commit()
        
        cursor.execute('SELECT viewer_count FROM ludo_streams WHERE game_id = ? AND is_active = 1', (game_id,))
        stream_info = cursor.fetchone()
        viewer_count = stream_info['viewer_count'] if stream_info else 0
        
        socketio.emit('stream_viewer_update', {
            'game_id': game_id,
            'viewer_count': viewer_count
        }, room=f'ludo_game_{game_id}')
        
        socketio.emit('stream_viewer_update', {
            'game_id': game_id,
            'viewer_count': viewer_count
        }, room=f'ludo_stream_{game_id}')
        
        conn.close()
        print(f'ğŸ‘ ØªÙ… Ø¥Ù†Ù‚Ø§Øµ Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ† Ù„Ù„Ø¨Ø« {game_id} - Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ: {viewer_count}')
        return viewer_count
    except Exception as e:
        print(f'âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ù‚Ø§Øµ Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ†: {e}')
        return 0

def check_ludo_rate_limit(user_id, action):
    """Check if user is sending requests too fast - uses single key per user"""
    key = str(user_id)
    current_time = time.time()
    
    if key in ludo_rate_limits:
        last_time = ludo_rate_limits[key]
        if current_time - last_time < LUDO_RATE_LIMIT_SECONDS:
            return False
    
    ludo_rate_limits[key] = current_time
    
    if len(ludo_rate_limits) > 10000:
        old_keys = [k for k, v in ludo_rate_limits.items() if current_time - v > 60]
        for k in old_keys:
            del ludo_rate_limits[k]
    
    return True

BSCSCAN_API_KEY = os.getenv('BSCSCAN_API_KEY', 'UB3BJ3AD49JAQR3ACKQUN23IYGW4FS8ZQJ')
BSCSCAN_BASE_URL = 'https://api.bscscan.com/api'







DEFAULT_DEPOSIT_INFO = """ğŸ’³ Ø¨Ø§ÙŠÙŠØ±: P1069518585
ğŸ’ Ø¨Ø§ÙŠÙ†Ø§Ù†Ø³: 474900045

âš ï¸ Ø¨Ø¹Ø¯ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº ÙˆÙŠØ´ØªØ±Ø· Ø£Ù† ÙŠÙƒÙˆÙ† Ø£ÙƒØ«Ø± Ù…Ù† 0.30 Ø¯ÙˆÙ„Ø§Ø±
Ø¨Ø¹Ø¯Ù‡Ø§ Ù…Ø¨Ø§Ø´Ø±Ø© Ù‚Ù… Ø¨Ø¥Ø±Ø³Ø§Ù„ ØµÙˆØ±Ø© Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹"""

def get_db():
    """
    Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§ØªØµØ§Ù„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø³Ù‘Ù†
    ÙŠØ¯Ø¹Ù… SQLite (Ø§ÙØªØ±Ø§Ø¶ÙŠ) Ùˆ PostgreSQL (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
    """
    if USE_POSTGRESQL and POSTGRES_URL:
        try:
            import psycopg2
            import psycopg2.extras
            conn = psycopg2.connect(POSTGRES_URL)
            conn.set_session(autocommit=False)
            return conn
        except ImportError:
            print("âš ï¸ psycopg2 ØºÙŠØ± Ù…Ø«Ø¨ØªØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… SQLite")
        except Exception as e:
            print(f"âš ï¸ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ PostgreSQL: {e}ØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… SQLite")
    
    conn = sqlite3.connect(DATABASE_PATH, timeout=20.0, check_same_thread=False)
    conn.row_factory = sqlite3.Row
    conn.execute('PRAGMA journal_mode=WAL')
    conn.execute('PRAGMA synchronous=NORMAL')
    conn.execute('PRAGMA busy_timeout=10000')
    conn.execute('PRAGMA cache_size=-64000')
    conn.execute('PRAGMA temp_store=MEMORY')
    return conn

def init_db():
    conn = sqlite3.connect(DATABASE_PATH)
    cursor = conn.cursor()
    
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS users (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            username TEXT UNIQUE NOT NULL,
            password_hash TEXT NOT NULL,
            pin TEXT NOT NULL,
            balance REAL DEFAULT 0.0,
            warnings INTEGER DEFAULT 0,
            is_banned INTEGER DEFAULT 0,
            is_admin INTEGER DEFAULT 0,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            last_username_change TIMESTAMP,
            session_id TEXT,
            session_created_at TIMESTAMP
        )
    ''')
    
    try:
        cursor.execute('SELECT session_id FROM users LIMIT 1')
    except sqlite3.OperationalError:
        cursor.execute('ALTER TABLE users ADD COLUMN session_id TEXT')
        cursor.execute('ALTER TABLE users ADD COLUMN session_created_at TIMESTAMP')
    
    # Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙˆØ¯ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
    try:
        cursor.execute('SELECT streaming_enabled FROM users LIMIT 1')
    except sqlite3.OperationalError:
        cursor.execute('ALTER TABLE users ADD COLUMN streaming_enabled INTEGER DEFAULT 0')
    
    # Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙˆØ¯ Ø§Ù„Ù…Ù†Ø­ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ Ù„Ù„Ø¨Ø«
    try:
        cursor.execute('SELECT streaming_granted_free FROM users LIMIT 1')
    except sqlite3.OperationalError:
        cursor.execute('ALTER TABLE users ADD COLUMN streaming_granted_free INTEGER DEFAULT 0')
    
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS deposit_requests (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER,
            photo_data TEXT,
            amount REAL DEFAULT 0.0,
            status TEXT DEFAULT 'pending',
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            processed_at TIMESTAMP,
            processed_by INTEGER,
            reject_reason TEXT,
            FOREIGN KEY (user_id) REFERENCES users(id)
        )
    ''')
    
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS withdrawal_requests (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER,
            amount REAL NOT NULL,
            method TEXT NOT NULL,
            account_info TEXT NOT NULL,
            status TEXT DEFAULT 'pending',
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            processed_at TIMESTAMP,
            processed_by INTEGER,
            FOREIGN KEY (user_id) REFERENCES users(id)
        )
    ''')
    
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS game_rooms (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            game_type TEXT NOT NULL,
            status TEXT DEFAULT 'waiting',
            max_players INTEGER DEFAULT 2,
            bet_amount REAL NOT NULL,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            started_at TIMESTAMP,
            finished_at TIMESTAMP,
            result INTEGER
        )
    ''')
    
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS game_players (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            room_id INTEGER,
            user_id INTEGER,
            chosen_number INTEGER,
            won INTEGER DEFAULT 0,
            profit REAL DEFAULT 0,
            joined_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (room_id) REFERENCES game_rooms(id),
            FOREIGN KEY (user_id) REFERENCES users(id)
        )
    ''')
    
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS settings (
            key TEXT PRIMARY KEY,
            value TEXT
        )
    ''')
    
    cursor.execute('''
        INSERT OR IGNORE INTO settings (key, value) 
        VALUES ('deposit_info', ?)
    ''', (DEFAULT_DEPOSIT_INFO,))
    
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS notifications (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER,
            message TEXT NOT NULL,
            is_read INTEGER DEFAULT 0,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (user_id) REFERENCES users(id)
        )
    ''')
    
    
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS matchmaking_queue (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER,
            bet_amount REAL NOT NULL,
            status TEXT DEFAULT 'waiting',
            matched_user_id INTEGER,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            expires_at TIMESTAMP,
            FOREIGN KEY (user_id) REFERENCES users(id)
        )
    ''')
    
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS active_games (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            player1_id INTEGER,
            player2_id INTEGER,
            bet_amount REAL NOT NULL,
            current_turn INTEGER DEFAULT 1,
            round_number INTEGER DEFAULT 1,
            player1_rolls TEXT DEFAULT '[]',
            player2_rolls TEXT DEFAULT '[]',
            player1_total INTEGER DEFAULT 0,
            player2_total INTEGER DEFAULT 0,
            game_status TEXT DEFAULT 'playing',
            is_tiebreaker INTEGER DEFAULT 0,
            winner_id INTEGER,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            finished_at TIMESTAMP,
            last_action_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            turn_start_time TIMESTAMP,
            turn_deadline TIMESTAMP,
            FOREIGN KEY (player1_id) REFERENCES users(id),
            FOREIGN KEY (player2_id) REFERENCES users(id)
        )
    ''')
    
    try:
        cursor.execute('SELECT last_action_time FROM active_games LIMIT 1')
    except sqlite3.OperationalError:
        cursor.execute('ALTER TABLE active_games ADD COLUMN last_action_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP')
    
    try:
        cursor.execute('SELECT turn_start_time FROM active_games LIMIT 1')
    except sqlite3.OperationalError:
        cursor.execute('ALTER TABLE active_games ADD COLUMN turn_start_time TIMESTAMP')
    
    try:
        cursor.execute('SELECT turn_deadline FROM active_games LIMIT 1')
    except sqlite3.OperationalError:
        cursor.execute('ALTER TABLE active_games ADD COLUMN turn_deadline TIMESTAMP')
    
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS domino_matchmaking_queue (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER,
            bet_amount REAL NOT NULL,
            status TEXT DEFAULT 'waiting',
            matched_user_id INTEGER,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            expires_at TIMESTAMP,
            FOREIGN KEY (user_id) REFERENCES users(id)
        )
    ''')
    
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS domino_active_games (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            player1_id INTEGER,
            player2_id INTEGER,
            bet_amount REAL NOT NULL,
            game_status TEXT DEFAULT 'playing',
            current_turn INTEGER DEFAULT 1,
            player1_hand TEXT DEFAULT '[]',
            player2_hand TEXT DEFAULT '[]',
            table_tiles TEXT DEFAULT '[]',
            stock_tiles TEXT DEFAULT '[]',
            left_value INTEGER,
            right_value INTEGER,
            player1_score INTEGER DEFAULT 0,
            player2_score INTEGER DEFAULT 0,
            player1_total_points INTEGER DEFAULT 0,
            player2_total_points INTEGER DEFAULT 0,
            turn_deadline TIMESTAMP,
            last_move TEXT,
            winner_id INTEGER,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            finished_at TIMESTAMP,
            FOREIGN KEY (player1_id) REFERENCES users(id),
            FOREIGN KEY (player2_id) REFERENCES users(id)
        )
    ''')
    
    try:
        cursor.execute('SELECT current_turn FROM domino_active_games LIMIT 1')
    except sqlite3.OperationalError:
        cursor.execute('ALTER TABLE domino_active_games ADD COLUMN current_turn INTEGER DEFAULT 1')
        cursor.execute('ALTER TABLE domino_active_games ADD COLUMN player1_hand TEXT DEFAULT \'[]\'')
        cursor.execute('ALTER TABLE domino_active_games ADD COLUMN player2_hand TEXT DEFAULT \'[]\'')
        cursor.execute('ALTER TABLE domino_active_games ADD COLUMN table_tiles TEXT DEFAULT \'[]\'')
        cursor.execute('ALTER TABLE domino_active_games ADD COLUMN stock_tiles TEXT DEFAULT \'[]\'')
        cursor.execute('ALTER TABLE domino_active_games ADD COLUMN left_value INTEGER')
        cursor.execute('ALTER TABLE domino_active_games ADD COLUMN right_value INTEGER')
        cursor.execute('ALTER TABLE domino_active_games ADD COLUMN player1_score INTEGER DEFAULT 0')
        cursor.execute('ALTER TABLE domino_active_games ADD COLUMN player2_score INTEGER DEFAULT 0')
        cursor.execute('ALTER TABLE domino_active_games ADD COLUMN player1_total_points INTEGER DEFAULT 0')
        cursor.execute('ALTER TABLE domino_active_games ADD COLUMN player2_total_points INTEGER DEFAULT 0')
        cursor.execute('ALTER TABLE domino_active_games ADD COLUMN turn_deadline TIMESTAMP')
        cursor.execute('ALTER TABLE domino_active_games ADD COLUMN last_move TEXT')
    
    try:
        cursor.execute('SELECT player1_joined FROM domino_active_games LIMIT 1')
    except sqlite3.OperationalError:
        cursor.execute('ALTER TABLE domino_active_games ADD COLUMN player1_joined INTEGER DEFAULT 0')
        cursor.execute('ALTER TABLE domino_active_games ADD COLUMN player2_joined INTEGER DEFAULT 0')
        cursor.execute('ALTER TABLE domino_active_games ADD COLUMN both_players_ready INTEGER DEFAULT 0')
    
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS ludo_matchmaking_queue (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER UNIQUE,
            bet_amount REAL NOT NULL,
            status TEXT DEFAULT 'queued',
            matched_user_id INTEGER,
            lock_version INTEGER DEFAULT 0,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            expires_at TIMESTAMP,
            match_id INTEGER,
            FOREIGN KEY (user_id) REFERENCES users(id)
        )
    ''')
    
    try:
        cursor.execute('SELECT lock_version FROM ludo_matchmaking_queue LIMIT 1')
    except sqlite3.OperationalError:
        cursor.execute('ALTER TABLE ludo_matchmaking_queue ADD COLUMN lock_version INTEGER DEFAULT 0')
    
    try:
        cursor.execute('SELECT match_id FROM ludo_matchmaking_queue LIMIT 1')
    except sqlite3.OperationalError:
        cursor.execute('ALTER TABLE ludo_matchmaking_queue ADD COLUMN match_id INTEGER')
    
    cursor.execute('CREATE INDEX IF NOT EXISTS idx_ludo_queue_status_bet ON ludo_matchmaking_queue(status, bet_amount, created_at)')
    
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS ludo_active_games (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            player1_id INTEGER,
            player2_id INTEGER,
            bet_amount REAL NOT NULL,
            game_status TEXT DEFAULT 'playing',
            current_turn INTEGER DEFAULT 1,
            player1_position TEXT DEFAULT '{"red": [0,0,0,0], "green": [0,0,0,0], "yellow": [0,0,0,0], "blue": [0,0,0,0]}',
            player2_position TEXT DEFAULT '{"red": [0,0,0,0], "green": [0,0,0,0], "yellow": [0,0,0,0], "blue": [0,0,0,0]}',
            last_roll INTEGER,
            turn_deadline TIMESTAMP,
            winner_id INTEGER,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            finished_at TIMESTAMP,
            FOREIGN KEY (player1_id) REFERENCES users(id),
            FOREIGN KEY (player2_id) REFERENCES users(id)
        )
    ''')
    
    try:
        cursor.execute('SELECT last_roll_timestamp FROM ludo_active_games LIMIT 1')
    except sqlite3.OperationalError:
        cursor.execute('ALTER TABLE ludo_active_games ADD COLUMN last_roll_timestamp TIMESTAMP')
    
    try:
        cursor.execute('SELECT dice_roll_start_time FROM ludo_active_games LIMIT 1')
    except sqlite3.OperationalError:
        cursor.execute('ALTER TABLE ludo_active_games ADD COLUMN dice_roll_start_time TIMESTAMP')
        cursor.execute('ALTER TABLE ludo_active_games ADD COLUMN dice_animation_duration REAL DEFAULT 2.0')
        cursor.execute('ALTER TABLE ludo_active_games ADD COLUMN dice_animation_state TEXT DEFAULT "idle"')
        cursor.execute('ALTER TABLE ludo_active_games ADD COLUMN piece_animation_data TEXT DEFAULT "{}"')
        cursor.execute('ALTER TABLE ludo_active_games ADD COLUMN game_event_version INTEGER DEFAULT 0')
        cursor.execute('ALTER TABLE ludo_active_games ADD COLUMN last_event_timestamp TIMESTAMP')
    
    try:
        cursor.execute('SELECT waiting_for_piece_selection FROM ludo_active_games LIMIT 1')
    except sqlite3.OperationalError:
        cursor.execute('ALTER TABLE ludo_active_games ADD COLUMN waiting_for_piece_selection INTEGER DEFAULT 0')
    
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS bnb_transactions (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER,
            tx_hash TEXT UNIQUE NOT NULL,
            amount REAL NOT NULL,
            status TEXT DEFAULT 'pending',
            from_address TEXT,
            to_address TEXT,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            verified_at TIMESTAMP,
            FOREIGN KEY (user_id) REFERENCES users(id)
        )
    ''')
    
    try:
        cursor.execute('SELECT tx_hash FROM bnb_transactions LIMIT 1')
    except sqlite3.OperationalError:
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS bnb_transactions (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER,
                tx_hash TEXT UNIQUE NOT NULL,
                amount REAL NOT NULL,
                status TEXT DEFAULT 'pending',
                from_address TEXT,
                to_address TEXT,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                verified_at TIMESTAMP,
                FOREIGN KEY (user_id) REFERENCES users(id)
            )
        ''')
    
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS user_bnb_wallets (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER,
            wallet_address TEXT NOT NULL,
            is_verified INTEGER DEFAULT 0,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (user_id) REFERENCES users(id),
            UNIQUE(user_id, wallet_address)
        )
    ''')
    
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS support_tickets (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER,
            category TEXT NOT NULL,
            message TEXT NOT NULL,
            status TEXT DEFAULT 'pending',
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            processed_at TIMESTAMP,
            processed_by INTEGER,
            admin_response TEXT,
            FOREIGN KEY (user_id) REFERENCES users(id)
        )
    ''')
    
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS cheat_audit_reports (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            ticket_id INTEGER,
            complainant_id INTEGER,
            accused_id INTEGER,
            game_id INTEGER,
            game_type TEXT DEFAULT 'ludo',
            audit_result TEXT,
            verdict TEXT,
            cheater_id INTEGER,
            cheat_method TEXT,
            cheat_amount REAL DEFAULT 0,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (ticket_id) REFERENCES support_tickets(id),
            FOREIGN KEY (complainant_id) REFERENCES users(id),
            FOREIGN KEY (accused_id) REFERENCES users(id)
        )
    ''')
    
    # Ø¬Ø¯ÙˆÙ„ ØªØ³Ø¬ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù„Ø¹Ø¨Ø© (Telemetry)
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS game_events_log (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            game_id INTEGER NOT NULL,
            game_type TEXT DEFAULT 'ludo',
            event_type TEXT NOT NULL,
            player_id INTEGER,
            event_data TEXT,
            state_before TEXT,
            state_after TEXT,
            event_hash TEXT,
            server_timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            client_timestamp TEXT,
            ip_address TEXT,
            is_valid INTEGER DEFAULT 1,
            validation_notes TEXT,
            FOREIGN KEY (game_id) REFERENCES ludo_active_games(id),
            FOREIGN KEY (player_id) REFERENCES users(id)
        )
    ''')
    cursor.execute('CREATE INDEX IF NOT EXISTS idx_game_events_game ON game_events_log(game_id, event_type)')
    cursor.execute('CREATE INDEX IF NOT EXISTS idx_game_events_player ON game_events_log(player_id, server_timestamp)')
    
    # Ø¬Ø¯ÙˆÙ„ ØªØªØ¨Ø¹ ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ø±ØµÙŠØ¯ (Balance Audit Trail)
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS balance_audit_log (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER NOT NULL,
            balance_before REAL NOT NULL,
            balance_after REAL NOT NULL,
            change_amount REAL NOT NULL,
            change_type TEXT NOT NULL,
            change_source TEXT NOT NULL,
            reference_id INTEGER,
            reference_type TEXT,
            is_legitimate INTEGER DEFAULT 1,
            audit_hash TEXT,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (user_id) REFERENCES users(id)
        )
    ''')
    cursor.execute('CREATE INDEX IF NOT EXISTS idx_balance_audit_user ON balance_audit_log(user_id, created_at)')
    cursor.execute('CREATE INDEX IF NOT EXISTS idx_balance_audit_suspicious ON balance_audit_log(is_legitimate, created_at)')
    
    # Ø¬Ø¯ÙˆÙ„ ÙƒØ´Ù Ø§Ù„ØªÙ„Ø§Ø¹Ø¨ (Tampering Detection)
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS tampering_alerts (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            alert_type TEXT NOT NULL,
            severity TEXT DEFAULT 'medium',
            user_id INTEGER,
            game_id INTEGER,
            details TEXT,
            evidence TEXT,
            is_resolved INTEGER DEFAULT 0,
            resolved_by INTEGER,
            resolved_at TIMESTAMP,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (user_id) REFERENCES users(id)
        )
    ''')
    cursor.execute('CREATE INDEX IF NOT EXISTS idx_tampering_alerts ON tampering_alerts(is_resolved, severity)')
    
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS ludo_game_history (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            game_id INTEGER,
            player1_id INTEGER,
            player2_id INTEGER,
            bet_amount REAL,
            winner_id INTEGER,
            game_duration INTEGER,
            total_moves INTEGER,
            player1_final_position TEXT,
            player2_final_position TEXT,
            dice_rolls_log TEXT,
            moves_log TEXT,
            balance_before_p1 REAL,
            balance_before_p2 REAL,
            balance_after_p1 REAL,
            balance_after_p2 REAL,
            game_hash TEXT,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            finished_at TIMESTAMP,
            FOREIGN KEY (game_id) REFERENCES ludo_active_games(id),
            FOREIGN KEY (player1_id) REFERENCES users(id),
            FOREIGN KEY (player2_id) REFERENCES users(id)
        )
    ''')
    
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS player_stats (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER UNIQUE,
            total_games INTEGER DEFAULT 0,
            total_wins INTEGER DEFAULT 0,
            total_losses INTEGER DEFAULT 0,
            win_streak INTEGER DEFAULT 0,
            max_win_streak INTEGER DEFAULT 0,
            total_earnings REAL DEFAULT 0,
            avg_game_duration REAL DEFAULT 0,
            suspicious_activities INTEGER DEFAULT 0,
            last_game_at TIMESTAMP,
            FOREIGN KEY (user_id) REFERENCES users(id)
        )
    ''')
    
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS ludo_streams (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            game_id INTEGER UNIQUE,
            streamer_id INTEGER,
            is_active INTEGER DEFAULT 1,
            viewer_count INTEGER DEFAULT 0,
            total_earnings REAL DEFAULT 0,
            started_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            ended_at TIMESTAMP,
            FOREIGN KEY (game_id) REFERENCES ludo_active_games(id),
            FOREIGN KEY (streamer_id) REFERENCES users(id)
        )
    ''')
    
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS stream_gift_transactions (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            transaction_token TEXT UNIQUE NOT NULL,
            stream_id INTEGER,
            game_id INTEGER,
            sender_id INTEGER NOT NULL,
            receiver_id INTEGER NOT NULL,
            gift_id TEXT NOT NULL,
            gift_name TEXT NOT NULL,
            gift_emoji TEXT,
            original_price REAL NOT NULL,
            calculated_value REAL NOT NULL,
            status TEXT DEFAULT 'completed',
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (sender_id) REFERENCES users(id),
            FOREIGN KEY (receiver_id) REFERENCES users(id)
        )
    ''')
    cursor.execute('CREATE INDEX IF NOT EXISTS idx_gift_trans_token ON stream_gift_transactions(transaction_token)')
    cursor.execute('CREATE INDEX IF NOT EXISTS idx_gift_trans_receiver ON stream_gift_transactions(receiver_id, created_at)')
    cursor.execute('CREATE INDEX IF NOT EXISTS idx_gift_trans_stream ON stream_gift_transactions(stream_id)')
    
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS stream_messages (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            game_id INTEGER NOT NULL,
            sender_id INTEGER NOT NULL,
            sender_name TEXT NOT NULL,
            message TEXT NOT NULL,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (game_id) REFERENCES ludo_active_games(id),
            FOREIGN KEY (sender_id) REFERENCES users(id)
        )
    ''')
    cursor.execute('CREATE INDEX IF NOT EXISTS idx_stream_messages_game ON stream_messages(game_id, created_at)')
    
    try:
        cursor.execute('SELECT total_earnings FROM ludo_streams LIMIT 1')
    except sqlite3.OperationalError:
        cursor.execute('ALTER TABLE ludo_streams ADD COLUMN total_earnings REAL DEFAULT 0')
    cursor.execute('CREATE INDEX IF NOT EXISTS idx_ludo_streams_active ON ludo_streams(is_active, started_at)')
    
    cursor.execute('UPDATE ludo_streams SET viewer_count = 0 WHERE is_active = 1')
    print('ğŸ”„ ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ† Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨Ø«ÙˆØ« Ø§Ù„Ù†Ø´Ø·Ø©')
    
    conn.commit()
    conn.close()

def verify_bnb_transaction(tx_hash):
    """Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ù…Ù„ÙŠØ© BNB Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ù„ÙˆÙƒØªØ´ÙŠÙ†"""
    try:
        url = f"{BSCSCAN_BASE_URL}?module=proxy&action=eth_getTransactionByHash&txhash={tx_hash}&apikey={BSCSCAN_API_KEY}"
        response = requests.get(url, timeout=10)
        data = response.json()
        
        if data.get('result'):
            tx = data['result']
            to_addr = tx.get('to', '').lower() if tx.get('to') else ''
            wallet_addr = BNB_WALLET_ADDRESS.lower()
            
            if to_addr == wallet_addr:
                amount_wei = int(tx.get('value', '0'), 16)
                amount_bnb = amount_wei / (10 ** 18)
                
                return {
                    'valid': True,
                    'amount': amount_bnb,
                    'from': tx.get('from'),
                    'to': tx.get('to'),
                    'hash': tx_hash
                }
        
        return {'valid': False, 'error': 'Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©'}
    except Exception as e:
        return {'valid': False, 'error': str(e)}

def hash_password(password):
    """Ø§Ø³ØªØ®Ø¯Ù… werkzeug security - Ø£Ù‚ÙˆÙ‰ Ù…Ù† SHA256"""
    return generate_password_hash(password, method='pbkdf2:sha256')

def log_game_event(game_id, event_type, player_id, event_data, state_before=None, state_after=None, ip_address=None):
    """
    ØªØ³Ø¬ÙŠÙ„ Ø­Ø¯Ø« ÙÙŠ Ø§Ù„Ù„Ø¹Ø¨Ø© Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­ØªÙ‡
    ÙŠØ³ØªØ®Ø¯Ù… Ù„ØªØªØ¨Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«: Ø±Ù…ÙŠ Ø§Ù„Ù†Ø±Ø¯ØŒ ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø­Ø¬Ø±ØŒ ØªØºÙŠÙŠØ± Ø§Ù„Ø¯ÙˆØ±ØŒ Ø§Ù„ÙÙˆØ²/Ø§Ù„Ø®Ø³Ø§Ø±Ø©
    """
    try:
        conn = get_db()
        cursor = conn.cursor()
        
        event_string = f"{game_id}:{event_type}:{player_id}:{json.dumps(event_data)}:{datetime.now().isoformat()}"
        event_hash = hashlib.sha256(event_string.encode()).hexdigest()[:32]
        
        cursor.execute('''
            INSERT INTO game_events_log 
            (game_id, event_type, player_id, event_data, state_before, state_after, event_hash, ip_address)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?)
        ''', (
            game_id, event_type, player_id,
            json.dumps(event_data, ensure_ascii=False) if event_data else None,
            json.dumps(state_before, ensure_ascii=False) if state_before else None,
            json.dumps(state_after, ensure_ascii=False) if state_after else None,
            event_hash, ip_address
        ))
        conn.commit()
        conn.close()
        return True
    except Exception as e:
        print(f"Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø­Ø¯Ø« Ø§Ù„Ù„Ø¹Ø¨Ø©: {e}")
        return False

def log_balance_change(user_id, balance_before, balance_after, change_type, change_source, reference_id=None, reference_type=None):
    """
    ØªØ³Ø¬ÙŠÙ„ ØªØºÙŠÙŠØ± ÙÙŠ Ø§Ù„Ø±ØµÙŠØ¯ Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù…Ø´Ø±ÙˆØ¹ÙŠØªÙ‡
    change_type: deposit, withdrawal, game_win, game_loss, admin_add, admin_deduct
    change_source: deposit_request, withdrawal_request, ludo_game, admin_panel
    """
    try:
        conn = get_db()
        cursor = conn.cursor()
        
        change_amount = balance_after - balance_before
        
        audit_string = f"{user_id}:{balance_before}:{balance_after}:{change_type}:{change_source}:{datetime.now().isoformat()}"
        audit_hash = hashlib.sha256(audit_string.encode()).hexdigest()[:32]
        
        is_legitimate = 1
        if change_type not in ['deposit', 'withdrawal', 'game_win', 'game_loss', 'admin_add', 'admin_deduct', 'refund']:
            is_legitimate = 0
        
        cursor.execute('''
            INSERT INTO balance_audit_log 
            (user_id, balance_before, balance_after, change_amount, change_type, change_source, reference_id, reference_type, is_legitimate, audit_hash)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        ''', (
            user_id, balance_before, balance_after, change_amount,
            change_type, change_source, reference_id, reference_type,
            is_legitimate, audit_hash
        ))
        conn.commit()
        conn.close()
        return True
    except Exception as e:
        print(f"Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ ØªØºÙŠÙŠØ± Ø§Ù„Ø±ØµÙŠØ¯: {e}")
        return False

def create_tampering_alert(alert_type, severity, user_id=None, game_id=None, details=None, evidence=None):
    """
    Ø¥Ù†Ø´Ø§Ø¡ ØªÙ†Ø¨ÙŠÙ‡ ØªÙ„Ø§Ø¹Ø¨
    alert_type: database_tampering, impossible_state, suspicious_pattern, balance_mismatch
    severity: low, medium, high, critical
    """
    try:
        conn = get_db()
        cursor = conn.cursor()
        
        cursor.execute('''
            INSERT INTO tampering_alerts 
            (alert_type, severity, user_id, game_id, details, evidence)
            VALUES (?, ?, ?, ?, ?, ?)
        ''', (
            alert_type, severity, user_id, game_id,
            details, json.dumps(evidence, ensure_ascii=False) if evidence else None
        ))
        conn.commit()
        conn.close()
        return True
    except Exception as e:
        print(f"Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„ØªÙ„Ø§Ø¹Ø¨: {e}")
        return False

def detect_balance_tampering(user_id):
    """
    ÙƒØ´Ù Ø§Ù„ØªÙ„Ø§Ø¹Ø¨ ÙÙŠ Ø§Ù„Ø±ØµÙŠØ¯ Ø¹Ù† Ø·Ø±ÙŠÙ‚ Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ø¹ Ø³Ø¬Ù„ Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚
    ÙŠÙƒØªØ´Ù: ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¨Ø§Ø´Ø± Ø¹Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŒ Ø¥Ø¶Ø§ÙØ© Ø±ØµÙŠØ¯ Ø¨Ø¯ÙˆÙ† Ù…ØµØ¯Ø±
    """
    try:
        conn = get_db()
        cursor = conn.cursor()
        
        cursor.execute('SELECT balance FROM users WHERE id = ?', (user_id,))
        user = cursor.fetchone()
        if not user:
            conn.close()
            return {'is_tampered': False, 'details': 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'}
        
        current_balance = user['balance']
        
        cursor.execute('''
            SELECT SUM(amount) as total FROM deposit_requests 
            WHERE user_id = ? AND status = 'approved'
        ''', (user_id,))
        total_deposits = cursor.fetchone()['total'] or 0
        
        cursor.execute('''
            SELECT SUM(amount) as total FROM withdrawal_requests 
            WHERE user_id = ? AND status = 'approved'
        ''', (user_id,))
        total_withdrawals = cursor.fetchone()['total'] or 0
        
        cursor.execute('''
            SELECT 
                SUM(CASE WHEN winner_id = ? THEN bet_amount ELSE 0 END) as total_wins,
                SUM(CASE WHEN winner_id != ? AND winner_id IS NOT NULL THEN bet_amount ELSE 0 END) as total_losses
            FROM ludo_active_games 
            WHERE (player1_id = ? OR player2_id = ?) AND game_status = 'finished'
        ''', (user_id, user_id, user_id, user_id))
        game_results = cursor.fetchone()
        total_game_wins = game_results['total_wins'] or 0
        total_game_losses = game_results['total_losses'] or 0
        
        cursor.execute('''
            SELECT 
                SUM(CASE WHEN winner_id = ? THEN bet_amount ELSE 0 END) as total_wins,
                SUM(CASE WHEN winner_id != ? AND winner_id IS NOT NULL THEN bet_amount ELSE 0 END) as total_losses
            FROM active_games 
            WHERE (player1_id = ? OR player2_id = ?) AND game_status = 'finished'
        ''', (user_id, user_id, user_id, user_id))
        dice_results = cursor.fetchone()
        total_dice_wins = (dice_results['total_wins'] or 0) if dice_results else 0
        total_dice_losses = (dice_results['total_losses'] or 0) if dice_results else 0
        
        expected_balance = total_deposits - total_withdrawals + total_game_wins - total_game_losses + total_dice_wins - total_dice_losses
        
        balance_diff = abs(current_balance - expected_balance)
        tolerance = 0.01
        
        conn.close()
        
        if balance_diff > tolerance:
            return {
                'is_tampered': True,
                'severity': 'critical' if balance_diff > 100 else 'high' if balance_diff > 10 else 'medium',
                'current_balance': current_balance,
                'expected_balance': expected_balance,
                'difference': balance_diff,
                'details': f'Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ ({current_balance:.2f}$) Ù„Ø§ ÙŠØªØ·Ø§Ø¨Ù‚ Ù…Ø¹ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ ({expected_balance:.2f}$)',
                'evidence': {
                    'deposits': total_deposits,
                    'withdrawals': total_withdrawals,
                    'game_wins': total_game_wins + total_dice_wins,
                    'game_losses': total_game_losses + total_dice_losses
                }
            }
        
        return {
            'is_tampered': False,
            'current_balance': current_balance,
            'expected_balance': expected_balance,
            'details': 'Ø§Ù„Ø±ØµÙŠØ¯ Ù…ØªØ·Ø§Ø¨Ù‚ Ù…Ø¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª'
        }
    except Exception as e:
        return {'is_tampered': False, 'error': str(e)}

def row_to_dict(row):
    """ØªØ­ÙˆÙŠÙ„ sqlite3.Row Ø¥Ù„Ù‰ dictionary Ù„Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹Ù‡ Ø¨Ø³Ù‡ÙˆÙ„Ø©"""
    if row is None:
        return None
    if isinstance(row, dict):
        return row
    try:
        return dict(row)
    except:
        return {key: row[key] for key in row.keys()}

def safe_get(row, key, default=None):
    """Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù‚ÙŠÙ…Ø© Ù…Ù† sqlite3.Row Ø¨Ø£Ù…Ø§Ù†"""
    if row is None:
        return default
    try:
        if isinstance(row, dict):
            return row.get(key, default)
        return row[key] if key in row.keys() else default
    except:
        return default

def detect_impossible_game_state(game_id):
    """
    ÙƒØ´Ù Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ù…Ø³ØªØ­ÙŠÙ„Ø©
    ÙŠÙƒØªØ´Ù: Ù…ÙˆØ§Ù‚Ø¹ Ø£Ø­Ø¬Ø§Ø± Ø®Ø§Ø·Ø¦Ø©ØŒ ÙÙˆØ² Ø¨Ø¯ÙˆÙ† Ø¥ÙƒÙ…Ø§Ù„ØŒ Ù…Ø¯Ø© Ù„Ø¹Ø¨Ø© Ù…Ø³ØªØ­ÙŠÙ„Ø©
    """
    try:
        conn = get_db()
        cursor = conn.cursor()
        
        cursor.execute('''
            SELECT g.*, 
                   u1.username as player1_name,
                   u2.username as player2_name
            FROM ludo_active_games g
            LEFT JOIN users u1 ON g.player1_id = u1.id
            LEFT JOIN users u2 ON g.player2_id = u2.id
            WHERE g.id = ?
        ''', (game_id,))
        game = cursor.fetchone()
        
        if not game:
            cursor.execute('''
                SELECT * FROM ludo_game_history WHERE game_id = ?
            ''', (game_id,))
            game = cursor.fetchone()
            if not game:
                conn.close()
                return {'has_issues': False, 'details': 'Ø§Ù„Ù„Ø¹Ø¨Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©'}
        
        issues = []
        
        try:
            if safe_get(game, 'player1_position'):
                p1_pos = json.loads(game['player1_position']) if isinstance(game['player1_position'], str) else game['player1_position']
            else:
                p1_pos = {}
            if safe_get(game, 'player2_position'):
                p2_pos = json.loads(game['player2_position']) if isinstance(game['player2_position'], str) else game['player2_position']
            else:
                p2_pos = {}
        except:
            p1_pos = {}
            p2_pos = {}
        
        all_pieces = []
        for color, pieces in p1_pos.items():
            if isinstance(pieces, list):
                for i, pos in enumerate(pieces):
                    if pos < 0 or pos > 58:
                        issues.append({
                            'type': 'invalid_position',
                            'severity': 'critical',
                            'details': f'Ø­Ø¬Ø± {color} {i+1} ÙÙŠ Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù‚Ø§Ù†ÙˆÙ†ÙŠ: {pos}'
                        })
                    all_pieces.append(pos)
        
        for color, pieces in p2_pos.items():
            if isinstance(pieces, list):
                for i, pos in enumerate(pieces):
                    if pos < 0 or pos > 58:
                        issues.append({
                            'type': 'invalid_position',
                            'severity': 'critical',
                            'details': f'Ø­Ø¬Ø± {color} {i+1} ÙÙŠ Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù‚Ø§Ù†ÙˆÙ†ÙŠ: {pos}'
                        })
                    all_pieces.append(pos)
        
        game_status = safe_get(game, 'game_status')
        # ÙØ­Øµ Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ© Ø¨Ø´ÙƒÙ„ Ø¹Ø§Ø¯ÙŠ Ø£Ùˆ Ø¨Ø§Ù„Ø§Ù†Ø³Ø­Ø§Ø¨
        if safe_get(game, 'created_at') and safe_get(game, 'finished_at') and game_status in ['finished', 'forfeited', 'forfeit']:
            try:
                created = datetime.strptime(str(game['created_at']), '%Y-%m-%d %H:%M:%S')
                finished = datetime.strptime(str(game['finished_at']), '%Y-%m-%d %H:%M:%S')
                duration_seconds = (finished - created).total_seconds()
                duration_minutes = duration_seconds / 60
                
                # Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù†ØªÙ‡Øª Ø¨Ø§Ù„Ø§Ù†Ø³Ø­Ø§Ø¨ - Ù„Ø§ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ù‚ØµÙŠØ±Ø©
                if game_status in ['forfeited', 'forfeit']:
                    # Ù„Ø§ Ù†Ø¶ÙŠÙ Ø£ÙŠ Ù…Ø´ÙƒÙ„Ø© - Ø§Ù„Ø§Ù†Ø³Ø­Ø§Ø¨ ÙŠØ¨Ø±Ø± Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ù‚ØµÙŠØ±Ø©
                    pass
                elif duration_seconds < 60:
                    issues.append({
                        'type': 'impossible_duration',
                        'severity': 'critical',
                        'details': f'Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù†ØªÙ‡Øª ÙÙŠ {duration_seconds:.0f} Ø«Ø§Ù†ÙŠØ© ÙÙ‚Ø· - Ù…Ø³ØªØ­ÙŠÙ„ Ø¨Ø¯ÙˆÙ† Ø§Ù†Ø³Ø­Ø§Ø¨!'
                    })
                elif duration_minutes < 5:
                    issues.append({
                        'type': 'suspicious_duration',
                        'severity': 'high',
                        'details': f'Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù†ØªÙ‡Øª ÙÙŠ {duration_minutes:.1f} Ø¯Ù‚ÙŠÙ‚Ø© - Ø³Ø±ÙŠØ¹Ø© Ø¬Ø¯Ø§Ù‹!'
                    })
                elif duration_minutes < 20:
                    issues.append({
                        'type': 'fast_game',
                        'severity': 'medium',
                        'details': f'Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù†ØªÙ‡Øª ÙÙŠ {duration_minutes:.1f} Ø¯Ù‚ÙŠÙ‚Ø© - Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ù…ØªÙˆØ³Ø· (20-30 Ø¯Ù‚ÙŠÙ‚Ø©)'
                    })
            except:
                pass
        
        if safe_get(game, 'winner_id') and game_status in ['finished', 'forfeited', 'forfeit']:
            winner_id = game['winner_id']
            p1_finished = 0
            p2_finished = 0
            
            for color, pieces in p1_pos.items():
                if isinstance(pieces, list):
                    p1_finished += sum(1 for p in pieces if p >= 58)
            
            for color, pieces in p2_pos.items():
                if isinstance(pieces, list):
                    p2_finished += sum(1 for p in pieces if p >= 58)
            
            # Ù„Ø§ Ù†ÙØ­Øµ ØªØ·Ø§Ø¨Ù‚ Ø§Ù„ÙØ§Ø¦Ø² ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ù†Ø³Ø­Ø§Ø¨ Ù„Ø£Ù† Ø§Ù„ÙÙˆØ² ÙŠÙƒÙˆÙ† ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù„Ù„Ø®ØµÙ…
            if game_status not in ['forfeited', 'forfeit']:
                if winner_id == safe_get(game, 'player1_id') and p1_finished < 4:
                    issues.append({
                        'type': 'winner_mismatch',
                        'severity': 'critical',
                        'details': f'Ø§Ù„Ù„Ø§Ø¹Ø¨ 1 ÙØ§Ø² Ù„ÙƒÙ† Ù„Ø¯ÙŠÙ‡ {p1_finished}/4 Ø£Ø­Ø¬Ø§Ø± ÙÙŠ Ø§Ù„Ù†Ù‡Ø§ÙŠØ© ÙÙ‚Ø·!'
                    })
                elif winner_id == safe_get(game, 'player2_id') and p2_finished < 4:
                    issues.append({
                        'type': 'winner_mismatch',
                        'severity': 'critical',
                        'details': f'Ø§Ù„Ù„Ø§Ø¹Ø¨ 2 ÙØ§Ø² Ù„ÙƒÙ† Ù„Ø¯ÙŠÙ‡ {p2_finished}/4 Ø£Ø­Ø¬Ø§Ø± ÙÙŠ Ø§Ù„Ù†Ù‡Ø§ÙŠØ© ÙÙ‚Ø·!'
                    })
        
        conn.close()
        
        return {
            'has_issues': len(issues) > 0,
            'issues': issues,
            'severity': max([i['severity'] for i in issues], key=lambda x: {'low': 0, 'medium': 1, 'high': 2, 'critical': 3}.get(x, 0)) if issues else None
        }
    except Exception as e:
        return {'has_issues': False, 'error': str(e)}

def detect_suspicious_patterns(user_id):
    """
    ÙƒØ´Ù Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ù…Ø±ÙŠØ¨Ø© ÙÙŠ Ø³Ù„ÙˆÙƒ Ø§Ù„Ù„Ø§Ø¹Ø¨
    ÙŠÙƒØªØ´Ù: Ù†Ø³Ø¨Ø© ÙÙˆØ² ØºÙŠØ± Ø·Ø¨ÙŠØ¹ÙŠØ©ØŒ Ø³Ù„Ø³Ù„Ø© Ø§Ù†ØªØµØ§Ø±Ø§ØªØŒ Ø£Ù„Ø¹Ø§Ø¨ Ø³Ø±ÙŠØ¹Ø© Ù…ØªÙƒØ±Ø±Ø©
    """
    try:
        conn = get_db()
        cursor = conn.cursor()
        
        patterns = []
        
        cursor.execute('''
            SELECT COUNT(*) as total,
                   SUM(CASE WHEN winner_id = ? THEN 1 ELSE 0 END) as wins
            FROM ludo_active_games 
            WHERE (player1_id = ? OR player2_id = ?) AND game_status = 'finished'
        ''', (user_id, user_id, user_id))
        stats = cursor.fetchone()
        
        total_games = stats['total'] or 0
        wins = stats['wins'] or 0
        
        if total_games >= 10:
            win_rate = (wins / total_games) * 100
            if win_rate > 90:
                patterns.append({
                    'type': 'abnormal_win_rate',
                    'severity': 'critical',
                    'details': f'Ù†Ø³Ø¨Ø© ÙÙˆØ² {win_rate:.1f}% Ù…Ù† {total_games} Ù„Ø¹Ø¨Ø© - ØºÙŠØ± Ø·Ø¨ÙŠØ¹ÙŠ!',
                    'value': win_rate
                })
            elif win_rate > 80:
                patterns.append({
                    'type': 'high_win_rate',
                    'severity': 'high',
                    'details': f'Ù†Ø³Ø¨Ø© ÙÙˆØ² {win_rate:.1f}% Ù…Ù† {total_games} Ù„Ø¹Ø¨Ø© - Ù…Ø±ØªÙØ¹Ø©',
                    'value': win_rate
                })
        
        cursor.execute('''
            SELECT COUNT(*) as wins FROM ludo_active_games 
            WHERE winner_id = ? AND game_status = 'finished'
            AND created_at > datetime('now', '-1 hour')
        ''', (user_id,))
        hourly_wins = cursor.fetchone()['wins'] or 0
        
        if hourly_wins >= 5:
            patterns.append({
                'type': 'win_streak',
                'severity': 'high' if hourly_wins >= 8 else 'medium',
                'details': f'{hourly_wins} ÙÙˆØ² ÙÙŠ Ø§Ù„Ø³Ø§Ø¹Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø©',
                'value': hourly_wins
            })
        
        cursor.execute('''
            SELECT id, created_at, finished_at, bet_amount, game_status
            FROM ludo_active_games 
            WHERE winner_id = ? AND game_status = 'finished'
            ORDER BY created_at DESC
            LIMIT 20
        ''', (user_id,))
        recent_wins = cursor.fetchall()
        
        fast_games = 0
        for game in recent_wins:
            if game['created_at'] and game['finished_at']:
                try:
                    created = datetime.strptime(str(game['created_at']), '%Y-%m-%d %H:%M:%S')
                    finished = datetime.strptime(str(game['finished_at']), '%Y-%m-%d %H:%M:%S')
                    duration = (finished - created).total_seconds() / 60
                    if duration < 10:
                        fast_games += 1
                except:
                    pass
        
        if fast_games >= 3:
            patterns.append({
                'type': 'fast_wins',
                'severity': 'high' if fast_games >= 5 else 'medium',
                'details': f'{fast_games} Ø£Ù„Ø¹Ø§Ø¨ Ø³Ø±ÙŠØ¹Ø© (<10 Ø¯Ù‚Ø§Ø¦Ù‚) Ù…Ù† Ø¢Ø®Ø± 20 ÙÙˆØ²',
                'value': fast_games
            })
        
        cursor.execute('''
            SELECT SUM(bet_amount) as total_earnings
            FROM ludo_active_games 
            WHERE winner_id = ? AND game_status = 'finished'
            AND created_at > datetime('now', '-24 hours')
        ''', (user_id,))
        daily_earnings = cursor.fetchone()['total_earnings'] or 0
        
        if daily_earnings > 500:
            patterns.append({
                'type': 'high_daily_earnings',
                'severity': 'high',
                'details': f'Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„ÙŠÙˆÙ…: {daily_earnings:.2f}$ - Ù…Ø±ØªÙØ¹Ø© Ø¬Ø¯Ø§Ù‹',
                'value': daily_earnings
            })
        
        conn.close()
        
        return {
            'has_patterns': len(patterns) > 0,
            'patterns': patterns,
            'total_games': total_games,
            'win_rate': (wins / total_games * 100) if total_games > 0 else 0
        }
    except Exception as e:
        return {'has_patterns': False, 'error': str(e)}

def analyze_smart_forfeit(cursor, game_id, game_data, duration_seconds):
    """
    ØªØ­Ù„ÙŠÙ„ Ø°ÙƒÙŠ Ù…ØªØ·ÙˆØ± Ù„Ø´Ø±Ø¹ÙŠØ© Ø§Ù„Ø§Ù†Ø³Ø­Ø§Ø¨
    ÙŠÙØ­Øµ:
    1. Ù‡Ù„ Ø§Ù„Ø§Ù†Ø³Ø­Ø§Ø¨ ØªÙ… Ø¹Ø¨Ø± Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ (ÙØ­Øµ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ù…Ø§Ù†)
    2. Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø±ÙƒØ§Øª Ù‚Ø¨Ù„ Ø§Ù„Ø§Ù†Ø³Ø­Ø§Ø¨
    3. Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ (Ø±Ø§Ø¨Ø­/Ø®Ø§Ø³Ø±) Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù†Ø³Ø­Ø§Ø¨
    4. Ù‡Ù„ Ù‡Ù†Ø§Ùƒ Ø£Ø­Ø¯Ø§Ø« Ù…Ø´Ø¨ÙˆÙ‡Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø§Ù†Ø³Ø­Ø§Ø¨
    5. ØªÙƒØ±Ø§Ø± Ø§Ù„Ø§Ù†Ø³Ø­Ø§Ø¨Ø§Øª Ù…Ù† Ù†ÙØ³ Ø§Ù„Ù„Ø§Ø¹Ø¨
    6. ÙØ­Øµ Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ù‡Ø§ÙƒØ± (Ø·Ù„Ø¨Ø§Øª ØºÙŠØ± Ø·Ø¨ÙŠØ¹ÙŠØ©)
    """
    try:
        result = {
            'is_legitimate': False,
            'is_suspicious': False,
            'is_hacker_attack': False,
            'reason': '',
            'details': '',
            'penalty_score': 0,
            'security_checks': []
        }
        
        duration_minutes = duration_seconds / 60
        winner_id = safe_get(game_data, 'winner_id')
        player1_id = safe_get(game_data, 'player1_id')
        player2_id = safe_get(game_data, 'player2_id')
        
        # ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ù†Ø³Ø­Ø¨ (Ø§Ù„Ø®Ø§Ø³Ø±)
        forfeiter_id = player2_id if winner_id == player1_id else player1_id
        
        # 1. ÙØ­Øµ Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù„Ø¹Ø¨Ø© Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø­Ø¯Ø« Ø§Ù†Ø³Ø­Ø§Ø¨ Ø·Ø¨ÙŠØ¹ÙŠ
        cursor.execute('''
            SELECT event_type, event_data, player_id FROM game_events_log 
            WHERE game_id = ? 
            ORDER BY server_timestamp DESC
        ''', (game_id,))
        events = cursor.fetchall()
        
        forfeit_event_found = False
        forfeit_event_data = None
        total_moves = 0
        total_dice_rolls = 0
        last_events = []
        
        for event in events:
            event_type = event['event_type']
            if event_type in ['forfeit', 'player_forfeit', 'game_forfeit', 'leave_game']:
                forfeit_event_found = True
                try:
                    forfeit_event_data = json.loads(event['event_data']) if event['event_data'] else {}
                except:
                    forfeit_event_data = {}
            if event_type in ['piece_move', 'piece_move_complete']:
                total_moves += 1
            if event_type == 'dice_roll':
                total_dice_rolls += 1
            if len(last_events) < 5:
                last_events.append(event_type)
        
        # ========== ÙØ­ÙˆØµØ§Øª Ø§Ù„Ø£Ù…Ø§Ù† Ø¶Ø¯ Ø§Ù„Ù‡Ø§ÙƒØ± ==========
        security_score = 100  # ÙŠØ¨Ø¯Ø£ Ù…Ù† 100 ÙˆÙŠÙ†Ù‚Øµ
        security_issues = []
        
        if forfeit_event_found and forfeit_event_data:
            security = forfeit_event_data.get('security', {})
            verification = forfeit_event_data.get('verification', {})
            
            # ÙØ­Øµ 1: Ù‡Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¬Ø§Ø¡ Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©ØŸ
            if not verification.get('request_from_game_page', False):
                security_score -= 30
                security_issues.append('Ø·Ù„Ø¨ Ø§Ù„Ø§Ù†Ø³Ø­Ø§Ø¨ Ù„Ù… ÙŠØ£ØªÙ Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©')
            
            # ÙØ­Øµ 2: Ù‡Ù„ Ø§Ù„Ù€ Referer ØµØ­ÙŠØ­ØŸ
            if not verification.get('has_valid_referer', False):
                security_score -= 20
                security_issues.append('Ø§Ù„Ù€ Referer ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ Ù…ÙÙ‚ÙˆØ¯')
            
            # ÙØ­Øµ 3: Ù‡Ù„ Ø§Ù„Ù€ User-Agent Ø·Ø¨ÙŠØ¹ÙŠØŸ
            if not verification.get('normal_user_agent', True):
                security_score -= 25
                security_issues.append('User-Agent Ù‚ØµÙŠØ± Ø¬Ø¯Ø§Ù‹ Ø£Ùˆ ØºÙŠØ± Ø·Ø¨ÙŠØ¹ÙŠ')
            
            # ÙØ­Øµ 4: Ù‡Ù„ IP Ø§Ù„Ø§Ù†Ø³Ø­Ø§Ø¨ ÙŠØ·Ø§Ø¨Ù‚ IP Ø§Ù„Ù„Ø¹Ø¨Ø©ØŸ
            forfeit_ip = security.get('ip_address', '')
            # Ù†Ø­Ø§ÙˆÙ„ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ IP Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù„Ø¹Ø¨Ø©
            cursor.execute('''
                SELECT event_data FROM game_events_log 
                WHERE game_id = ? AND event_type = 'game_start' AND player_id = ?
                LIMIT 1
            ''', (game_id, forfeiter_id))
            start_event = cursor.fetchone()
            if start_event:
                try:
                    start_data = json.loads(start_event['event_data']) if start_event['event_data'] else {}
                    start_ip = start_data.get('ip_address', '')
                    if start_ip and forfeit_ip and start_ip != forfeit_ip:
                        security_score -= 40
                        security_issues.append(f'ØªØºÙŠØ± IP Ù…Ù† {start_ip} Ø¥Ù„Ù‰ {forfeit_ip}')
                except:
                    pass
        else:
            # Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø¯Ø« Ø§Ù†Ø³Ø­Ø§Ø¨ Ù…Ø³Ø¬Ù„ - Ù…Ø±ÙŠØ¨
            security_score -= 50
            security_issues.append('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø­Ø¯Ø« Ø§Ù†Ø³Ø­Ø§Ø¨ Ù…Ø³Ø¬Ù„')
        
        result['security_checks'] = security_issues
        
        # 2. ØªØ­Ù„ÙŠÙ„ Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø£Ø­Ø¬Ø§Ø± Ù„Ù…Ø¹Ø±ÙØ© Ù…Ù† ÙƒØ§Ù† Ø±Ø§Ø¨Ø­Ø§Ù‹
        try:
            p1_pos = json.loads(game_data['player1_position']) if safe_get(game_data, 'player1_position') else {}
            p2_pos = json.loads(game_data['player2_position']) if safe_get(game_data, 'player2_position') else {}
            
            p1_home = 0
            p2_home = 0
            p1_progress = 0
            p2_progress = 0
            
            for color, pieces in p1_pos.items():
                if isinstance(pieces, list):
                    for pos in pieces:
                        if pos >= 58:
                            p1_home += 1
                        p1_progress += pos
            
            for color, pieces in p2_pos.items():
                if isinstance(pieces, list):
                    for pos in pieces:
                        if pos >= 58:
                            p2_home += 1
                        p2_progress += pos
            
            forfeiter_was_losing = (forfeiter_id == player1_id and p1_progress < p2_progress) or \
                                   (forfeiter_id == player2_id and p2_progress < p1_progress)
            forfeiter_was_winning = not forfeiter_was_losing
            
        except:
            forfeiter_was_losing = False
            forfeiter_was_winning = False
            p1_home = 0
            p2_home = 0
        
        # 3. ÙØ­Øµ ØªÙƒØ±Ø§Ø± Ø§Ù„Ø§Ù†Ø³Ø­Ø§Ø¨Ø§Øª Ù…Ù† Ø§Ù„Ù…Ù†Ø³Ø­Ø¨
        cursor.execute('''
            SELECT COUNT(*) as forfeit_count FROM ludo_active_games 
            WHERE (player1_id = ? OR player2_id = ?) 
            AND winner_id != ?
            AND game_status IN ('forfeited', 'forfeit')
            AND created_at > datetime('now', '-24 hours')
        ''', (forfeiter_id, forfeiter_id, forfeiter_id))
        recent_forfeits = cursor.fetchone()
        forfeit_count_24h = recent_forfeits['forfeit_count'] if recent_forfeits else 0
        
        # 4. ÙØ­Øµ Ù‡Ù„ Ø§Ù„ÙØ§Ø¦Ø² Ù„Ø¯ÙŠÙ‡ Ù†Ù…Ø· Ø§Ù†Ø³Ø­Ø§Ø¨Ø§Øª Ù…Ø±ÙŠØ¨ Ø¶Ø¯Ù‡
        cursor.execute('''
            SELECT COUNT(*) as opponent_forfeit_wins FROM ludo_active_games 
            WHERE winner_id = ?
            AND game_status IN ('forfeited', 'forfeit')
            AND created_at > datetime('now', '-24 hours')
        ''', (winner_id,))
        opponent_forfeit_wins = cursor.fetchone()
        forfeit_wins_count = opponent_forfeit_wins['opponent_forfeit_wins'] if opponent_forfeit_wins else 0
        
        # ========== Ù…Ù†Ø·Ù‚ Ø§Ù„Ø­ÙƒÙ… Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„Ù…ØªØ·ÙˆØ± ==========
        
        # Ø£ÙˆÙ„Ø§Ù‹: ÙØ­Øµ Ù‡Ø¬ÙˆÙ… Ø§Ù„Ù‡Ø§ÙƒØ± (Ø£ÙˆÙ„ÙˆÙŠØ© Ù‚ØµÙˆÙ‰)
        if security_score < 50:
            result['is_hacker_attack'] = True
            result['is_suspicious'] = True
            result['reason'] = 'Ø§Ø´ØªØ¨Ø§Ù‡ Ø¨Ù‡Ø¬ÙˆÙ… Ù‡Ø§ÙƒØ±!'
            result['details'] = f'Ø¯Ø±Ø¬Ø© Ø§Ù„Ø£Ù…Ø§Ù†: {security_score}/100 - Ø§Ù„Ù…Ø´Ø§ÙƒÙ„: {", ".join(security_issues)}'
            result['penalty_score'] = 60
            return result
        
        # Ø¥Ø°Ø§ Ø§Ù„Ø£Ù…Ø§Ù† Ù…Ù†Ø®ÙØ¶ Ù„ÙƒÙ† Ù„ÙŠØ³ Ø­Ø±Ø¬Ø§Ù‹ - Ù…Ø±ÙŠØ¨
        if security_score < 70:
            result['is_suspicious'] = True
            result['reason'] = f'Ù…Ø´Ø§ÙƒÙ„ Ø£Ù…Ù†ÙŠØ© ÙÙŠ Ø§Ù„Ø§Ù†Ø³Ø­Ø§Ø¨ (Ø¯Ø±Ø¬Ø©: {security_score}/100)'
            result['details'] = f'Ø§Ù„Ù…Ø´Ø§ÙƒÙ„: {", ".join(security_issues)}'
            result['penalty_score'] = 30
            return result
        
        # Ø­Ø§Ù„Ø© 1: Ø§Ù†Ø³Ø­Ø§Ø¨ Ø·Ø¨ÙŠØ¹ÙŠ ØªÙ…Ø§Ù…Ø§Ù‹
        if total_moves >= 2 and forfeiter_was_losing and forfeit_wins_count < 5 and security_score >= 70:
            result['is_legitimate'] = True
            result['reason'] = f'Ù„Ø§Ø¹Ø¨ Ø®Ø§Ø³Ø± Ø§Ù†Ø³Ø­Ø¨ Ø¨Ø¹Ø¯ {total_moves} Ø­Ø±ÙƒØ©'
            result['details'] = f'Ø§Ù„Ù…Ù†Ø³Ø­Ø¨ ÙƒØ§Ù† Ù…ØªØ£Ø®Ø±Ø§Ù‹ - Ø§Ù†Ø³Ø­Ø§Ø¨ Ù…Ù†Ø·Ù‚ÙŠ (Ø£Ù…Ø§Ù†: {security_score}/100)'
            return result
        
        # Ø­Ø§Ù„Ø© 2: Ø§Ù†Ø³Ø­Ø§Ø¨ Ù…Ø¨ÙƒØ± Ù„ÙƒÙ† Ø·Ø¨ÙŠØ¹ÙŠ
        if duration_seconds >= 30 and total_dice_rolls >= 2 and security_score >= 70:
            result['is_legitimate'] = True
            result['reason'] = f'Ø§Ù†Ø³Ø­Ø§Ø¨ Ù…Ø¨ÙƒØ± Ø¨Ø¹Ø¯ {total_dice_rolls} Ø±Ù…ÙŠØ© Ù†Ø±Ø¯'
            result['details'] = f'Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù‚Ø±Ø± Ø§Ù„Ø§Ù†Ø³Ø­Ø§Ø¨ Ù…Ø¨ÙƒØ±Ø§Ù‹ - Ù…Ø³Ù…ÙˆØ­ (Ø£Ù…Ø§Ù†: {security_score}/100)'
            return result
        
        # Ø­Ø§Ù„Ø© 3: Ø§Ù†Ø³Ø­Ø§Ø¨ ÙÙˆØ±ÙŠ Ø¨Ø¯ÙˆÙ† Ù„Ø¹Ø¨
        if duration_seconds < 30 and total_moves == 0 and total_dice_rolls == 0:
            if security_score >= 80:
                result['is_legitimate'] = True
                result['reason'] = 'Ø§Ù†Ø³Ø­Ø§Ø¨ ÙÙˆØ±ÙŠ Ø¨Ø¯ÙˆÙ† Ù„Ø¹Ø¨'
                result['details'] = 'Ø±Ø¨Ù…Ø§ Ù…Ø´ÙƒÙ„Ø© Ø§ØªØµØ§Ù„ - Ù„Ø§ ÙŠØ¹ØªØ¨Ø± ØºØ´'
                return result
            else:
                result['is_suspicious'] = True
                result['reason'] = 'Ø§Ù†Ø³Ø­Ø§Ø¨ ÙÙˆØ±ÙŠ Ù…Ø¹ Ù…Ø´Ø§ÙƒÙ„ Ø£Ù…Ù†ÙŠØ©'
                result['details'] = f'Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ù‡Ø¬ÙˆÙ… (Ø£Ù…Ø§Ù†: {security_score}/100)'
                result['penalty_score'] = 25
                return result
        
        # Ø­Ø§Ù„Ø© 4: Ù†Ù…Ø· Ù…Ø±ÙŠØ¨ - Ø§Ù„ÙØ§Ø¦Ø² Ù„Ø¯ÙŠÙ‡ Ø§Ù†Ø³Ø­Ø§Ø¨Ø§Øª ÙƒØ«ÙŠØ±Ø© Ø¶Ø¯Ù‡
        if forfeit_wins_count >= 5:
            result['is_suspicious'] = True
            result['is_hacker_attack'] = True
            result['reason'] = f'Ø§Ù„ÙØ§Ø¦Ø² Ù„Ø¯ÙŠÙ‡ {forfeit_wins_count} ÙÙˆØ² Ø¨Ø§Ù†Ø³Ø­Ø§Ø¨ Ø®Ù„Ø§Ù„ 24 Ø³Ø§Ø¹Ø©!'
            result['details'] = 'Ù†Ù…Ø· Ù‡Ø¬ÙˆÙ… Ù‡Ø§ÙƒØ± Ù…Ø­ØªÙ…Ù„ - Ø§Ù„Ø®ØµÙˆÙ… ÙŠÙ†Ø³Ø­Ø¨ÙˆÙ† Ø¯Ø§Ø¦Ù…Ø§Ù‹'
            result['penalty_score'] = 50
            return result
        
        # Ø­Ø§Ù„Ø© 5: Ø§Ù„Ù…Ù†Ø³Ø­Ø¨ ÙƒØ§Ù† Ø±Ø§Ø¨Ø­Ø§Ù‹
        if forfeiter_was_winning and total_moves >= 5:
            result['is_suspicious'] = True
            result['reason'] = 'Ø§Ù„Ù…Ù†Ø³Ø­Ø¨ ÙƒØ§Ù† Ù…ØªÙ‚Ø¯Ù…Ø§Ù‹ ÙÙŠ Ø§Ù„Ù„Ø¹Ø¨Ø©!'
            result['details'] = 'Ù…Ù† ØºÙŠØ± Ø§Ù„Ù…Ù†Ø·Ù‚ÙŠ Ø§Ù„Ø§Ù†Ø³Ø­Ø§Ø¨ ÙˆØ£Ù†Øª Ø±Ø§Ø¨Ø­ - Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø¥Ø¬Ø¨Ø§Ø± Ø®Ø§Ø±Ø¬ÙŠ'
            result['penalty_score'] = 35
            return result
        
        # Ø­Ø§Ù„Ø© 6: Ø§Ù„Ù…Ù†Ø³Ø­Ø¨ ÙŠÙ†Ø³Ø­Ø¨ ÙƒØ«ÙŠØ±Ø§Ù‹
        if forfeit_count_24h >= 3:
            result['is_suspicious'] = True
            result['reason'] = f'Ø§Ù„Ù…Ù†Ø³Ø­Ø¨ Ù„Ø¯ÙŠÙ‡ {forfeit_count_24h} Ø§Ù†Ø³Ø­Ø§Ø¨ Ø®Ù„Ø§Ù„ 24 Ø³Ø§Ø¹Ø©'
            result['details'] = 'ØªÙƒØ±Ø§Ø± Ø§Ù„Ø§Ù†Ø³Ø­Ø§Ø¨Ø§Øª Ù…Ø±ÙŠØ¨'
            result['penalty_score'] = 20
            return result
        
        # Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© - Ø§Ù†Ø³Ø­Ø§Ø¨ Ø¹Ø§Ø¯ÙŠ
        result['is_legitimate'] = True
        result['reason'] = 'Ø§Ù†Ø³Ø­Ø§Ø¨ Ø·Ø¨ÙŠØ¹ÙŠ'
        result['details'] = f'Ù…Ø¯Ø©: {duration_minutes:.1f} Ø¯Ù‚ÙŠÙ‚Ø©ØŒ Ø­Ø±ÙƒØ§Øª: {total_moves}ØŒ Ø£Ù…Ø§Ù†: {security_score}/100'
        
        return result
        
    except Exception as e:
        return {
            'is_legitimate': True,
            'is_suspicious': False,
            'is_hacker_attack': False,
            'reason': f'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„: {str(e)}',
            'details': 'ØªÙ… Ø§Ø¹ØªØ¨Ø§Ø±Ù‡ Ø§Ù†Ø³Ø­Ø§Ø¨ Ø·Ø¨ÙŠØ¹ÙŠ Ø¨Ø³Ø¨Ø¨ Ø®Ø·Ø£',
            'penalty_score': 0,
            'security_checks': []
        }

def perform_cheat_audit(ticket_id, complainant_id):
    """
    Ù†Ø¸Ø§Ù… Ø§Ù„ÙØ­Øµ Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„Ù…ØªÙ‚Ø¯Ù… Ù„Ù…ÙƒØ§ÙØ­Ø© Ø§Ù„ØºØ´
    ÙŠÙ‚ÙˆÙ… Ø¨ØªØ­Ù„ÙŠÙ„ Ø´Ø§Ù…Ù„ Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ø·Ø¨Ù‚Ø§Øª:
    1. ÙƒØ´Ù Ø§Ù„ØªÙ„Ø§Ø¹Ø¨ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    2. ÙƒØ´Ù Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ù…Ø³ØªØ­ÙŠÙ„Ø©
    3. ÙƒØ´Ù Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ù…Ø±ÙŠØ¨Ø©
    4. ØªØ­Ù„ÙŠÙ„ ØªÙ†Ø§Ø³Ù‚ Ø§Ù„Ø±ØµÙŠØ¯
    """
    conn = get_db()
    cursor = conn.cursor()
    
    audit_result = {
        'ticket_id': ticket_id,
        'complainant_id': complainant_id,
        'checks': [],
        'verdict': 'clean',
        'cheater_id': None,
        'cheat_method': None,
        'cheat_amount': 0,
        'summary': '',
        'game_info': None,
        'timestamp': datetime.now().isoformat(),
        'cheat_score': 0
    }
    
    try:
        cursor.execute('SELECT * FROM support_tickets WHERE id = ?', (ticket_id,))
        ticket = cursor.fetchone()
        if not ticket:
            audit_result['summary'] = 'Ø§Ù„ØªØ°ÙƒØ±Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©'
            return audit_result
        
        cursor.execute('SELECT id, username, balance FROM users WHERE id = ?', (complainant_id,))
        complainant = cursor.fetchone()
        if not complainant:
            audit_result['summary'] = 'Ø§Ù„Ù…Ø´ØªÙƒÙŠ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'
            return audit_result
        complainant_name = complainant['username']
        
        cursor.execute('''
            SELECT g.*, 
                   u1.username as player1_name, u1.balance as player1_balance,
                   u2.username as player2_name, u2.balance as player2_balance
            FROM ludo_active_games g
            LEFT JOIN users u1 ON g.player1_id = u1.id
            LEFT JOIN users u2 ON g.player2_id = u2.id
            WHERE (g.player1_id = ? OR g.player2_id = ?)
            ORDER BY g.created_at DESC
            LIMIT 1
        ''', (complainant_id, complainant_id))
        last_game = cursor.fetchone()
        
        if not last_game:
            cursor.execute('''
                SELECT h.*, 
                       u1.username as player1_name,
                       u2.username as player2_name
                FROM ludo_game_history h
                LEFT JOIN users u1 ON h.player1_id = u1.id
                LEFT JOIN users u2 ON h.player2_id = u2.id
                WHERE h.player1_id = ? OR h.player2_id = ?
                ORDER BY h.created_at DESC
                LIMIT 1
            ''', (complainant_id, complainant_id))
            last_game = cursor.fetchone()
        
        if not last_game:
            audit_result['checks'].append({
                'name': 'Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù„Ø¹Ø¨Ø©',
                'status': 'fail',
                'icon': 'âŒ',
                'details': 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£ÙŠ Ù„Ø¹Ø¨Ø© Ù„ÙˆØ¯Ùˆ Ø³Ø§Ø¨Ù‚Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù„Ø§Ø¹Ø¨ ÙÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø© Ø£Ùˆ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©'
            })
            audit_result['summary'] = 'âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù„Ø¹Ø§Ø¨ Ù…Ø³Ø¬Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù„Ø§Ø¹Ø¨'
            conn.close()
            return audit_result
        
        game_id = safe_get(last_game, 'id') or safe_get(last_game, 'game_id')
        opponent_id = last_game['player2_id'] if last_game['player1_id'] == complainant_id else last_game['player1_id']
        opponent_name = last_game['player2_name'] if last_game['player1_id'] == complainant_id else last_game['player1_name']
        bet_amount = safe_get(last_game, 'bet_amount', 0)
        
        audit_result['game_info'] = {
            'game_id': game_id,
            'complainant_name': complainant_name,
            'opponent_id': opponent_id,
            'opponent_name': opponent_name or 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ',
            'bet_amount': bet_amount,
            'game_status': safe_get(last_game, 'game_status', 'unknown'),
            'winner_id': safe_get(last_game, 'winner_id'),
            'created_at': str(safe_get(last_game, 'created_at', '')),
            'finished_at': str(safe_get(last_game, 'finished_at', ''))
        }
        
        audit_result['checks'].append({
            'name': 'ğŸ® ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù„Ø¹Ø¨Ø©',
            'status': 'pass',
            'icon': 'âœ…',
            'details': f'Ù„Ø¹Ø¨Ø© #{game_id} Ø¨ÙŠÙ† {complainant_name} Ùˆ {opponent_name or "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"} - Ø§Ù„Ø±Ù‡Ø§Ù†: {bet_amount:.2f}$'
        })
        
        cheat_score = 0
        
        game_state_result = detect_impossible_game_state(game_id)
        if game_state_result.get('has_issues'):
            for issue in game_state_result.get('issues', []):
                severity_score = {'low': 5, 'medium': 15, 'high': 30, 'critical': 50}.get(issue['severity'], 10)
                cheat_score += severity_score
                audit_result['checks'].append({
                    'name': f"ğŸ” {issue['type']}",
                    'status': 'fail' if issue['severity'] in ['critical', 'high'] else 'warning',
                    'icon': 'âŒ' if issue['severity'] in ['critical', 'high'] else 'âš ï¸',
                    'details': issue['details']
                })
        else:
            audit_result['checks'].append({
                'name': 'ğŸ” Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©',
                'status': 'pass',
                'icon': 'âœ…',
                'details': 'Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© Ø·Ø¨ÙŠØ¹ÙŠØ© ÙˆÙ„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ù‚Ø¹ Ù…Ø³ØªØ­ÙŠÙ„Ø©'
            })
        
        if opponent_id:
            balance_result = detect_balance_tampering(opponent_id)
            if balance_result.get('is_tampered'):
                severity_score = {'medium': 20, 'high': 40, 'critical': 60}.get(balance_result.get('severity', 'medium'), 20)
                cheat_score += severity_score
                audit_result['checks'].append({
                    'name': 'ğŸ’° ØªÙ„Ø§Ø¹Ø¨ Ø¨Ø§Ù„Ø±ØµÙŠØ¯',
                    'status': 'fail',
                    'icon': 'âŒ',
                    'details': balance_result['details'],
                    'evidence': balance_result.get('evidence')
                })
            else:
                audit_result['checks'].append({
                    'name': 'ğŸ’° ØªÙ†Ø§Ø³Ù‚ Ø§Ù„Ø±ØµÙŠØ¯',
                    'status': 'pass',
                    'icon': 'âœ…',
                    'details': f'Ø±ØµÙŠØ¯ Ø§Ù„Ø®ØµÙ… Ù…ØªØ·Ø§Ø¨Ù‚ Ù…Ø¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª ({balance_result.get("current_balance", 0):.2f}$)'
                })
        
        if opponent_id:
            patterns_result = detect_suspicious_patterns(opponent_id)
            if patterns_result.get('has_patterns'):
                for pattern in patterns_result.get('patterns', []):
                    severity_score = {'low': 5, 'medium': 15, 'high': 25, 'critical': 40}.get(pattern['severity'], 10)
                    cheat_score += severity_score
                    audit_result['checks'].append({
                        'name': f"ğŸ“Š {pattern['type']}",
                        'status': 'fail' if pattern['severity'] in ['critical', 'high'] else 'warning',
                        'icon': 'âŒ' if pattern['severity'] in ['critical', 'high'] else 'âš ï¸',
                        'details': pattern['details']
                    })
            else:
                audit_result['checks'].append({
                    'name': 'ğŸ“Š Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ù„Ø¹Ø¨',
                    'status': 'pass',
                    'icon': 'âœ…',
                    'details': f'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù†Ù…Ø§Ø· Ù…Ø±ÙŠØ¨Ø© - Ù†Ø³Ø¨Ø© Ø§Ù„ÙÙˆØ²: {patterns_result.get("win_rate", 0):.1f}%'
                })
        
        try:
            p1_pos = json.loads(last_game['player1_position']) if safe_get(last_game, 'player1_position') else {}
            p2_pos = json.loads(last_game['player2_position']) if safe_get(last_game, 'player2_position') else {}
            
            all_pieces = []
            for color, pieces in {**p1_pos, **p2_pos}.items():
                if isinstance(pieces, list):
                    all_pieces.extend(pieces)
            
            invalid_count = sum(1 for p in all_pieces if p < 0 or p > 58)
            if invalid_count > 0:
                cheat_score += 50
                audit_result['checks'].append({
                    'name': 'ğŸ“ Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø£Ø­Ø¬Ø§Ø±',
                    'status': 'fail',
                    'icon': 'âŒ',
                    'details': f'{invalid_count} Ø­Ø¬Ø± ÙÙŠ Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù‚Ø§Ù†ÙˆÙ†ÙŠ (Ø®Ø§Ø±Ø¬ 0-58)'
                })
            else:
                audit_result['checks'].append({
                    'name': 'ğŸ“ Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø£Ø­Ø¬Ø§Ø±',
                    'status': 'pass',
                    'icon': 'âœ…',
                    'details': 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø­Ø¬Ø§Ø± ÙÙŠ Ù…ÙˆØ§Ù‚Ø¹ Ù‚Ø§Ù†ÙˆÙ†ÙŠØ© (0-58)'
                })
        except:
            audit_result['checks'].append({
                'name': 'ğŸ“ Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø£Ø­Ø¬Ø§Ø±',
                'status': 'warning',
                'icon': 'âš ï¸',
                'details': 'ØªØ¹Ø°Ø± ØªØ­Ù„ÙŠÙ„ Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø£Ø­Ø¬Ø§Ø±'
            })
        
        if safe_get(last_game, 'created_at') and safe_get(last_game, 'finished_at'):
            try:
                created = datetime.strptime(str(last_game['created_at']), '%Y-%m-%d %H:%M:%S')
                finished = datetime.strptime(str(last_game['finished_at']), '%Y-%m-%d %H:%M:%S')
                duration_seconds = (finished - created).total_seconds()
                duration_minutes = duration_seconds / 60
                game_status = safe_get(last_game, 'game_status')
                
                # Ù†Ø¸Ø§Ù… ÙØ­Øµ Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„Ù…ØªØ·ÙˆØ±
                if game_status == 'forfeited' or game_status == 'forfeit':
                    # ØªØ­Ù„ÙŠÙ„ Ø°ÙƒÙŠ Ù„Ù„Ø§Ù†Ø³Ø­Ø§Ø¨ Ù…Ø¹ ÙØ­Øµ Ø§Ù„Ù‡Ø§ÙƒØ±
                    forfeit_analysis = analyze_smart_forfeit(cursor, game_id, last_game, duration_seconds)
                    
                    if forfeit_analysis.get('is_hacker_attack'):
                        # Ø§Ø´ØªØ¨Ø§Ù‡ Ø¨Ù‡Ø¬ÙˆÙ… Ù‡Ø§ÙƒØ±!
                        cheat_score += forfeit_analysis.get('penalty_score', 60)
                        audit_result['checks'].append({
                            'name': 'ğŸš¨ Ø§Ø´ØªØ¨Ø§Ù‡ Ù‡Ø¬ÙˆÙ… Ù‡Ø§ÙƒØ±',
                            'status': 'fail',
                            'icon': 'ğŸ”´',
                            'details': f'{forfeit_analysis["reason"]} - {forfeit_analysis.get("details", "")}'
                        })
                        # Ø¥Ø¶Ø§ÙØ© ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØ­ÙˆØµØ§Øª Ø§Ù„Ø£Ù…Ù†ÙŠØ©
                        security_checks = forfeit_analysis.get('security_checks', [])
                        if security_checks:
                            audit_result['checks'].append({
                                'name': 'ğŸ”’ ÙØ­ÙˆØµØ§Øª Ø§Ù„Ø£Ù…Ø§Ù†',
                                'status': 'fail',
                                'icon': 'âŒ',
                                'details': ' | '.join(security_checks)
                            })
                    elif forfeit_analysis['is_legitimate']:
                        # Ø§Ù†Ø³Ø­Ø§Ø¨ Ø·Ø¨ÙŠØ¹ÙŠ Ø´Ø±Ø¹ÙŠ
                        audit_result['checks'].append({
                            'name': 'â±ï¸ Ù…Ø¯Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© (Ø§Ù†Ø³Ø­Ø§Ø¨)',
                            'status': 'pass',
                            'icon': 'âœ…',
                            'details': f'Ø§Ù†Ø³Ø­Ø§Ø¨ Ø·Ø¨ÙŠØ¹ÙŠ Ø¨Ø¹Ø¯ {duration_minutes:.1f} Ø¯Ù‚ÙŠÙ‚Ø© - {forfeit_analysis["reason"]}'
                        })
                    elif forfeit_analysis['is_suspicious']:
                        # Ø§Ù†Ø³Ø­Ø§Ø¨ Ù…Ø±ÙŠØ¨ ÙŠØ­ØªØ§Ø¬ ØªØ­Ù‚ÙŠÙ‚
                        cheat_score += forfeit_analysis.get('penalty_score', 25)
                        audit_result['checks'].append({
                            'name': 'â±ï¸ Ù…Ø¯Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© (Ø§Ù†Ø³Ø­Ø§Ø¨ Ù…Ø±ÙŠØ¨)',
                            'status': 'warning',
                            'icon': 'âš ï¸',
                            'details': f'Ø§Ù†Ø³Ø­Ø§Ø¨ Ù…Ø±ÙŠØ¨: {forfeit_analysis["reason"]} - {forfeit_analysis.get("details", "")}'
                        })
                    else:
                        # Ø§Ù†Ø³Ø­Ø§Ø¨ Ø®Ø·ÙŠØ± Ù…Ø­ØªÙ…Ù„ ØºØ´
                        cheat_score += forfeit_analysis.get('penalty_score', 50)
                        audit_result['checks'].append({
                            'name': 'â±ï¸ Ù…Ø¯Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© (Ø§Ù†Ø³Ø­Ø§Ø¨ Ø®Ø·ÙŠØ±)',
                            'status': 'fail',
                            'icon': 'âŒ',
                            'details': f'Ø§Ù†Ø³Ø­Ø§Ø¨ ØºÙŠØ± Ø·Ø¨ÙŠØ¹ÙŠ: {forfeit_analysis["reason"]} - {forfeit_analysis.get("details", "")}'
                        })
                else:
                    # Ù„Ø¹Ø¨Ø© Ø¹Ø§Ø¯ÙŠØ© Ø¨Ø¯ÙˆÙ† Ø§Ù†Ø³Ø­Ø§Ø¨
                    if duration_minutes < 2:
                        cheat_score += 50
                        audit_result['checks'].append({
                            'name': 'â±ï¸ Ù…Ø¯Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©',
                            'status': 'fail',
                            'icon': 'âŒ',
                            'details': f'Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù†ØªÙ‡Øª ÙÙŠ {duration_minutes:.1f} Ø¯Ù‚ÙŠÙ‚Ø© - Ù…Ø³ØªØ­ÙŠÙ„ Ø¨Ø¯ÙˆÙ† Ø§Ù†Ø³Ø­Ø§Ø¨!'
                        })
                    elif duration_minutes < 20:
                        cheat_score += 15
                        audit_result['checks'].append({
                            'name': 'â±ï¸ Ù…Ø¯Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©',
                            'status': 'warning',
                            'icon': 'âš ï¸',
                            'details': f'Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù†ØªÙ‡Øª ÙÙŠ {duration_minutes:.1f} Ø¯Ù‚ÙŠÙ‚Ø© - Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ (20 Ø¯Ù‚ÙŠÙ‚Ø©)'
                        })
                    else:
                        audit_result['checks'].append({
                            'name': 'â±ï¸ Ù…Ø¯Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©',
                            'status': 'pass',
                            'icon': 'âœ…',
                            'details': f'Ù…Ø¯Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© {duration_minutes:.1f} Ø¯Ù‚ÙŠÙ‚Ø© - Ø·Ø¨ÙŠØ¹ÙŠØ©'
                        })
            except:
                pass
        
        try:
            cursor.execute('''
                SELECT event_type, event_data FROM game_events_log 
                WHERE game_id = ? ORDER BY server_timestamp
            ''', (game_id,))
            game_events = cursor.fetchall()
            
            if len(game_events) > 0:
                dice_rolls = []
                invalid_attempts = 0
                
                for event in game_events:
                    event_type = event['event_type']
                    try:
                        event_data = json.loads(event['event_data']) if event['event_data'] else {}
                    except:
                        event_data = {}
                    
                    if event_type == 'dice_roll' and 'roll' in event_data:
                        dice_rolls.append(event_data['roll'])
                    elif event_type == 'invalid_move_attempt':
                        invalid_attempts += 1
                    elif event_type == 'piece_move_complete':
                        pass
                
                if len(dice_rolls) >= 10:
                    six_count = dice_rolls.count(6)
                    six_percentage = (six_count / len(dice_rolls)) * 100
                    expected_percentage = 16.67
                    
                    if six_percentage > 50:
                        cheat_score += 40
                        audit_result['checks'].append({
                            'name': 'ğŸ² ØªØ­Ù„ÙŠÙ„ Ø±Ù…ÙŠØ§Øª Ø§Ù„Ù†Ø±Ø¯',
                            'status': 'fail',
                            'icon': 'âŒ',
                            'details': f'Ù†Ø³Ø¨Ø© Ø±Ù…ÙŠ 6 ØºÙŠØ± Ø·Ø¨ÙŠØ¹ÙŠØ©: {six_percentage:.1f}% ({six_count}/{len(dice_rolls)}) - Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ ~16.7%'
                        })
                    elif six_percentage > 35:
                        cheat_score += 20
                        audit_result['checks'].append({
                            'name': 'ğŸ² ØªØ­Ù„ÙŠÙ„ Ø±Ù…ÙŠØ§Øª Ø§Ù„Ù†Ø±Ø¯',
                            'status': 'warning',
                            'icon': 'âš ï¸',
                            'details': f'Ù†Ø³Ø¨Ø© Ø±Ù…ÙŠ 6 Ù…Ø±ØªÙØ¹Ø©: {six_percentage:.1f}% ({six_count}/{len(dice_rolls)})'
                        })
                    else:
                        audit_result['checks'].append({
                            'name': 'ğŸ² ØªØ­Ù„ÙŠÙ„ Ø±Ù…ÙŠØ§Øª Ø§Ù„Ù†Ø±Ø¯',
                            'status': 'pass',
                            'icon': 'âœ…',
                            'details': f'ØªÙˆØ²ÙŠØ¹ Ø±Ù…ÙŠØ§Øª Ø§Ù„Ù†Ø±Ø¯ Ø·Ø¨ÙŠØ¹ÙŠ: {six_percentage:.1f}% Ø±Ù…ÙŠ 6 ({six_count}/{len(dice_rolls)})'
                        })
                else:
                    audit_result['checks'].append({
                        'name': 'ğŸ² ØªØ­Ù„ÙŠÙ„ Ø±Ù…ÙŠØ§Øª Ø§Ù„Ù†Ø±Ø¯',
                        'status': 'warning',
                        'icon': 'âš ï¸',
                        'details': f'Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ù…ÙŠØ§Øª Ù‚Ù„ÙŠÙ„ ({len(dice_rolls)}) - Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠ'
                    })
                
                if invalid_attempts > 5:
                    cheat_score += 30
                    audit_result['checks'].append({
                        'name': 'ğŸš« Ù…Ø­Ø§ÙˆÙ„Ø§Øª ØºØ´ Ù…Ø±ÙÙˆØ¶Ø©',
                        'status': 'fail',
                        'icon': 'âŒ',
                        'details': f'ØªÙ… Ø±ØµØ¯ {invalid_attempts} Ù…Ø­Ø§ÙˆÙ„Ø© Ø­Ø±ÙƒØ© ØºÙŠØ± Ù‚Ø§Ù†ÙˆÙ†ÙŠØ© Ù…Ø±ÙÙˆØ¶Ø© Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…'
                    })
                elif invalid_attempts > 0:
                    cheat_score += 10
                    audit_result['checks'].append({
                        'name': 'ğŸš« Ù…Ø­Ø§ÙˆÙ„Ø§Øª ØºØ´ Ù…Ø±ÙÙˆØ¶Ø©',
                        'status': 'warning',
                        'icon': 'âš ï¸',
                        'details': f'ØªÙ… Ø±ØµØ¯ {invalid_attempts} Ù…Ø­Ø§ÙˆÙ„Ø© Ø­Ø±ÙƒØ© ØºÙŠØ± Ù‚Ø§Ù†ÙˆÙ†ÙŠØ©'
                    })
                else:
                    audit_result['checks'].append({
                        'name': 'ğŸš« Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ø­Ø±ÙƒØ§Øª',
                        'status': 'pass',
                        'icon': 'âœ…',
                        'details': 'Ù„Ù… ÙŠØªÙ… Ø±ØµØ¯ Ø£ÙŠ Ù…Ø­Ø§ÙˆÙ„Ø§Øª ØºØ´ ÙÙŠ Ø§Ù„Ø­Ø±ÙƒØ§Øª'
                    })
                
                audit_result['game_events_count'] = len(game_events)
                audit_result['dice_rolls_count'] = len(dice_rolls)
            else:
                cursor.execute('''
                    SELECT dice_rolls_log, moves_log FROM ludo_game_history WHERE game_id = ?
                ''', (game_id,))
                history = cursor.fetchone()
                
                if history and history['dice_rolls_log']:
                    try:
                        dice_data = json.loads(history['dice_rolls_log'])
                        audit_result['checks'].append({
                            'name': 'ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ù„Ø¹Ø¨Ø©',
                            'status': 'pass',
                            'icon': 'âœ…',
                            'details': f'ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø³Ø¬Ù„ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸ ({len(dice_data)} Ø±Ù…ÙŠØ© Ù†Ø±Ø¯)'
                        })
                    except:
                        pass
                else:
                    audit_result['checks'].append({
                        'name': 'ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«',
                        'status': 'warning',
                        'icon': 'âš ï¸',
                        'details': 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ø£Ø­Ø¯Ø§Ø« Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù„Ø¹Ø¨Ø© (Ù„Ø¹Ø¨Ø© Ù‚Ø¯ÙŠÙ…Ø© Ù‚Ø¨Ù„ ØªÙØ¹ÙŠÙ„ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„)'
                    })
        except Exception as e:
            audit_result['checks'].append({
                'name': 'ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«',
                'status': 'warning',
                'icon': 'âš ï¸',
                'details': f'ØªØ¹Ø°Ø± ØªØ­Ù„ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«: {str(e)}'
            })
        
        audit_result['cheat_score'] = cheat_score
        
        if cheat_score >= 80:
            audit_result['verdict'] = 'cheating_detected'
            audit_result['cheater_id'] = opponent_id
            audit_result['cheat_method'] = 'ØªÙ„Ø§Ø¹Ø¨ Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹'
            audit_result['cheat_amount'] = safe_get(last_game, 'bet_amount', 0) * 2
            audit_result['summary'] = f'â›” ØºØ´ Ù…Ø¤ÙƒØ¯! Ø¯Ø±Ø¬Ø© Ø§Ù„Ø®Ø·ÙˆØ±Ø©: {cheat_score}/100 - Ø§Ù„Ù…ØªÙ‡Ù…: {opponent_name}'
        elif cheat_score >= 40:
            audit_result['verdict'] = 'suspicious'
            audit_result['summary'] = f'âš ï¸ Ù†Ø´Ø§Ø· Ù…Ø±ÙŠØ¨! Ø¯Ø±Ø¬Ø© Ø§Ù„Ø®Ø·ÙˆØ±Ø©: {cheat_score}/100 - ÙŠØ­ØªØ§Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø©'
        else:
            audit_result['verdict'] = 'clean'
            audit_result['summary'] = f'âœ… Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¯Ù„ÙŠÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØºØ´ - Ø¯Ø±Ø¬Ø© Ø§Ù„Ø®Ø·ÙˆØ±Ø©: {cheat_score}/100'
        
        cursor.execute('''
            INSERT INTO cheat_audit_reports 
            (ticket_id, complainant_id, accused_id, game_id, game_type, audit_result, verdict, cheater_id, cheat_method, cheat_amount)
            VALUES (?, ?, ?, ?, 'ludo', ?, ?, ?, ?, ?)
        ''', (
            ticket_id, complainant_id, opponent_id, game_id,
            json.dumps(audit_result, ensure_ascii=False),
            audit_result['verdict'],
            audit_result['cheater_id'],
            audit_result['cheat_method'],
            audit_result['cheat_amount']
        ))
        conn.commit()
        
    except Exception as e:
        audit_result['checks'].append({
            'name': 'âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„',
            'status': 'fail',
            'icon': 'âŒ',
            'details': f'Ø­Ø¯Ø« Ø®Ø·Ø£: {str(e)}'
        })
        audit_result['summary'] = f'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„: {str(e)}'
        import traceback
        print(f"Ø®Ø·Ø£ ÙÙŠ perform_cheat_audit: {traceback.format_exc()}")
    finally:
        conn.close()
    
    return audit_result

def validate_image(image_data):
    """
    Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„ÙØ¹Ù„ÙŠ Ø¨Ø¯Ù„ Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù…ØªØ¯Ø§Ø¯
    ÙŠÙØ­Øµ:
    - ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ù„Ù (Magic Bytes)
    - Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù
    - Ù†ÙˆØ¹ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„ÙØ¹Ù„ÙŠ
    """
    if not image_data or len(image_data) == 0:
        return False, "Ø§Ù„Ù…Ù„Ù ÙØ§Ø±Øº"
    
    MAX_SIZE = 5 * 1024 * 1024
    if len(image_data) > MAX_SIZE:
        return False, f"Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹ (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 5MB)"
    
    JPEG_MAGIC = b'\xff\xd8\xff'
    PNG_MAGIC = b'\x89PNG'
    GIF_MAGIC = b'GIF8'
    
    is_jpeg = image_data[:3] == JPEG_MAGIC
    is_png = image_data[:4] == PNG_MAGIC
    is_gif = image_data[:4] == GIF_MAGIC
    
    if not (is_jpeg or is_png or is_gif):
        return False, "ØµÙŠØºØ© Ø§Ù„Ù…Ù„Ù ØºÙŠØ± ØµØ­ÙŠØ­Ø© (ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† ØµÙˆØ±Ø© JPEG Ø£Ùˆ PNG Ø£Ùˆ GIF)"
    
    try:
        img = Image.open(BytesIO(image_data))
        img.verify()
        img = Image.open(BytesIO(image_data))
        width, height = img.size
        
        MIN_SIZE = 50
        MAX_DIM = 10000
        
        if width < MIN_SIZE or height < MIN_SIZE:
            return False, f"Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„ØµÙˆØ±Ø© ØµØºÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹ (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ {MIN_SIZE}x{MIN_SIZE})"
        
        if width > MAX_DIM or height > MAX_DIM:
            return False, f"Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹ (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ {MAX_DIM}x{MAX_DIM})"
        
        return True, "Ø§Ù„ØµÙˆØ±Ø© Ø³Ù„ÙŠÙ…Ø©"
    
    except Exception as e:
        return False, f"Ø§Ù„Ù…Ù„Ù ØªØ§Ù„Ù Ø£Ùˆ ØºÙŠØ± Ù‚Ø§Ø¨Ù„ Ù„Ù„Ù‚Ø±Ø§Ø¡Ø©: {str(e)}"

def compress_image(image_data, quality=30, max_size=(800, 800)):
    """
    Ø¶ØºØ· Ø§Ù„ØµÙˆØ±Ø© Ù„ØªÙˆÙÙŠØ± Ø§Ù„Ù…Ø³Ø§Ø­Ø© (ØªÙ‚Ù„ÙŠÙ„ 70-90%)
    Args:
        image_data: Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙˆØ±Ø© (bytes)
        quality: Ø¬ÙˆØ¯Ø© Ø§Ù„Ø¶ØºØ· (10-95ØŒ Ø£Ù‚Ù„ = Ø£ØµØºØ± Ø­Ø¬Ù…)
        max_size: Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø£Ø¨Ø¹Ø§Ø¯
    Returns:
        str: ØµÙˆØ±Ø© Ù…Ø¶ØºÙˆØ·Ø© Ø¨ØµÙŠØºØ© base64
    """
    try:
        img = Image.open(BytesIO(image_data))
        
        if img.mode in ('RGBA', 'LA', 'P'):
            background = Image.new('RGB', img.size, (255, 255, 255))
            if img.mode == 'P':
                img = img.convert('RGBA')
            background.paste(img, mask=img.split()[-1] if img.mode in ('RGBA', 'LA') else None)
            img = background
        elif img.mode != 'RGB':
            img = img.convert('RGB')
        
        img.thumbnail(max_size, Image.Resampling.LANCZOS)
        
        output = BytesIO()
        img.save(output, format='JPEG', quality=quality, optimize=True)
        compressed_data = output.getvalue()
        
        original_size = len(image_data)
        compressed_size = len(compressed_data)
        reduction = ((original_size - compressed_size) / original_size) * 100
        
        print(f"ğŸ“Š Ø¶ØºØ· Ø§Ù„ØµÙˆØ±Ø©: {original_size/1024:.1f}KB -> {compressed_size/1024:.1f}KB (ØªÙˆÙÙŠØ± {reduction:.1f}%)")
        
        return base64.b64encode(compressed_data).decode('utf-8')
    except Exception as e:
        print(f"âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø¶ØºØ· Ø§Ù„ØµÙˆØ±Ø©: {e}")
        return base64.b64encode(image_data).decode('utf-8')

def cleanup_old_data():
    """
    ØªÙ†Ø¸ÙŠÙ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ØºÙŠØ± Ø§Ù„Ù…Ù‡Ù…Ø©
    - Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ© (Ø£Ù‚Ø¯Ù… Ù…Ù† 30 ÙŠÙˆÙ…)
    - Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø© (Ø£Ù‚Ø¯Ù… Ù…Ù† 7 Ø£ÙŠØ§Ù…)
    - Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹/Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© (Ø£Ù‚Ø¯Ù… Ù…Ù† 90 ÙŠÙˆÙ…)
    """
    try:
        conn = get_db()
        cursor = conn.cursor()
        
        now = datetime.now()
        
        cursor.execute('''
            DELETE FROM active_games 
            WHERE game_status = 'finished' 
            AND datetime(finished_at) <= datetime(?, '-30 days')
        ''', (now.strftime('%Y-%m-%d %H:%M:%S'),))
        games_deleted = cursor.rowcount
        
        cursor.execute('''
            DELETE FROM ludo_active_games 
            WHERE game_status = 'finished' 
            AND datetime(finished_at) <= datetime(?, '-30 days')
        ''', (now.strftime('%Y-%m-%d %H:%M:%S'),))
        ludo_deleted = cursor.rowcount
        
        cursor.execute('''
            DELETE FROM domino_active_games 
            WHERE game_status = 'finished' 
            AND datetime(finished_at) <= datetime(?, '-30 days')
        ''', (now.strftime('%Y-%m-%d %H:%M:%S'),))
        domino_deleted = cursor.rowcount
        
        cursor.execute('''
            DELETE FROM notifications 
            WHERE is_read = 1 
            AND datetime(created_at) <= datetime(?, '-7 days')
        ''', (now.strftime('%Y-%m-%d %H:%M:%S'),))
        notif_deleted = cursor.rowcount
        
        cursor.execute('''
            DELETE FROM deposit_requests 
            WHERE status IN ('approved', 'rejected') 
            AND datetime(processed_at) <= datetime(?, '-90 days')
        ''', (now.strftime('%Y-%m-%d %H:%M:%S'),))
        deposit_deleted = cursor.rowcount
        
        cursor.execute('''
            DELETE FROM withdrawal_requests 
            WHERE status IN ('approved', 'rejected') 
            AND datetime(processed_at) <= datetime(?, '-90 days')
        ''', (now.strftime('%Y-%m-%d %H:%M:%S'),))
        withdrawal_deleted = cursor.rowcount
        
        cursor.execute('''
            DELETE FROM matchmaking_queue 
            WHERE status = 'cancelled'
            AND datetime(created_at) <= datetime(?, '-1 hours')
        ''', (now.strftime('%Y-%m-%d %H:%M:%S'),))
        matchmaking_deleted = cursor.rowcount
        
        cursor.execute('''
            DELETE FROM ludo_matchmaking_queue 
            WHERE status = 'cancelled'
            AND datetime(created_at) <= datetime(?, '-1 hours')
        ''', (now.strftime('%Y-%m-%d %H:%M:%S'),))
        ludo_matchmaking_deleted = cursor.rowcount
        
        cursor.execute('''
            DELETE FROM domino_matchmaking_queue 
            WHERE status = 'cancelled'
            AND datetime(created_at) <= datetime(?, '-1 hours')
        ''', (now.strftime('%Y-%m-%d %H:%M:%S'),))
        domino_matchmaking_deleted = cursor.rowcount
        
        conn.commit()
        
        total = games_deleted + ludo_deleted + domino_deleted + notif_deleted + deposit_deleted + withdrawal_deleted + matchmaking_deleted + ludo_matchmaking_deleted + domino_matchmaking_deleted
        
        if total > 0:
            print(f"ğŸ§¹ ØªÙ†Ø¸ÙŠÙ ØªÙ„Ù‚Ø§Ø¦ÙŠ: Ø­Ø°Ù {total} Ø³Ø¬Ù„ Ù‚Ø¯ÙŠÙ… ({games_deleted} Ø£Ù„Ø¹Ø§Ø¨ØŒ {notif_deleted} Ø¥Ø´Ø¹Ø§Ø±Ø§ØªØŒ {deposit_deleted} Ø¥ÙŠØ¯Ø§Ø¹Ø§ØªØŒ {withdrawal_deleted} Ø³Ø­ÙˆØ¨Ø§Øª)")
        
        cursor.execute('VACUUM')
        
        conn.close()
        return total
    except Exception as e:
        print(f"âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ: {e}")
        return 0

def optimize_database_indexes():
    """Ø¥Ø¶Ø§ÙØ© ÙˆØªØ­Ø³ÙŠÙ† Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ù„ØªØ³Ø±ÙŠØ¹ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª"""
    try:
        conn = get_db()
        cursor = conn.cursor()
        
        indexes = [
            'CREATE INDEX IF NOT EXISTS idx_users_username ON users(username)',
            'CREATE INDEX IF NOT EXISTS idx_users_balance ON users(balance)',
            'CREATE INDEX IF NOT EXISTS idx_deposit_status ON deposit_requests(status, created_at)',
            'CREATE INDEX IF NOT EXISTS idx_withdrawal_status ON withdrawal_requests(status, created_at)',
            'CREATE INDEX IF NOT EXISTS idx_active_games_status ON active_games(game_status, created_at)',
            'CREATE INDEX IF NOT EXISTS idx_ludo_games_status ON ludo_active_games(game_status, created_at)',
            'CREATE INDEX IF NOT EXISTS idx_domino_games_status ON domino_active_games(game_status, created_at)',
            'CREATE INDEX IF NOT EXISTS idx_notifications_user ON notifications(user_id, is_read)',
            'CREATE INDEX IF NOT EXISTS idx_matchmaking_status ON matchmaking_queue(status, bet_amount)',
            'CREATE INDEX IF NOT EXISTS idx_ludo_matchmaking_status ON ludo_matchmaking_queue(status, bet_amount)',
            'CREATE INDEX IF NOT EXISTS idx_domino_matchmaking_status ON domino_matchmaking_queue(status, bet_amount)',
        ]
        
        for index_sql in indexes:
            cursor.execute(index_sql)
        
        conn.commit()
        conn.close()
        print("âœ… ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª: ØªÙ… Ø¥Ù†Ø´Ø§Ø¡/ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª")
        return True
    except Exception as e:
        print(f"âš ï¸ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª: {e}")
        return False

def auto_skip_expired_turns():
    """
    Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ Ø§Ù„Ù†Ø´Ø·Ø© Ø§Ù„ØªÙŠ Ø§Ù†ØªÙ‡Ù‰ ÙˆÙ‚ØªÙ‡Ø§ ÙˆØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¯ÙˆØ± Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø¢Ø®Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
    ÙŠØ¹Ù…Ù„ Ù‡Ø°Ø§ ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø­ØªÙ‰ Ù„Ùˆ ÙƒØ§Ù† Ø§Ù„Ù„Ø§Ø¹Ø¨Ø§Ù† ØºØ§Ø¦Ø¨Ø§Ù† Ø£Ùˆ Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„
    Ø§Ù„Ø¹Ø¯Ø§Ø¯ ÙŠØ³ØªÙ…Ø± Ø¨Ø¯ÙˆÙ† ØªÙˆÙ‚Ù Ø¨ÙŠÙ† Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
    """
    try:
        conn = get_db()
        cursor = conn.cursor()
        
        cursor.execute('''
            SELECT id, player1_id, player2_id, current_turn, turn_deadline, bet_amount
            FROM ludo_active_games 
            WHERE game_status = 'playing' 
            AND turn_deadline IS NOT NULL
        ''')
        
        all_games = cursor.fetchall()
        skipped_count = 0
        
        for game in all_games:
            game_id = game['id']
            current_turn = game['current_turn']
            turn_deadline = game['turn_deadline']
            
            try:
                deadline = datetime.strptime(turn_deadline, '%Y-%m-%d %H:%M:%S')
                now = datetime.now()
                
                if deadline <= now:
                    next_turn = 2 if current_turn == 1 else 1
                    
                    cursor.execute('''
                        UPDATE ludo_active_games 
                        SET current_turn = ?,
                            turn_deadline = datetime(CURRENT_TIMESTAMP, '+30 seconds'),
                            game_event_version = game_event_version + 1,
                            last_event_timestamp = CURRENT_TIMESTAMP,
                            waiting_for_piece_selection = 0,
                            last_roll = NULL,
                            dice_roll_start_time = NULL,
                            dice_animation_state = 'idle'
                        WHERE id = ?
                    ''', (next_turn, game_id))
                    
                    conn.commit()
                    skipped_count += 1
                    print(f"â­ï¸ ØªØ®Ø·ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø§Ù„Ù„Ø¹Ø¨Ø© {game_id}: Ø§Ù„Ù„Ø§Ø¹Ø¨ {current_turn} â†’ Ø§Ù„Ù„Ø§Ø¹Ø¨ {next_turn}")
            except Exception as e:
                print(f"âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© {game_id}: {e}")
                continue
        
        conn.close()
        return skipped_count
    except Exception as e:
        print(f"âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ®Ø·ÙŠ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ: {e}")
        return 0

def auto_skip_worker():
    """Worker ÙŠØ¹Ù…Ù„ ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ÙˆÙ‚Øª ÙƒÙ„ 1 Ø«Ø§Ù†ÙŠØ© - Ø¨Ø¯ÙˆÙ† ØªÙˆÙ‚Ù Ø­ØªÙ‰ Ù…Ø¹ Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„"""
    while True:
        try:
            time.sleep(1)
            skipped_count = auto_skip_expired_turns()
            if skipped_count > 0:
                print(f"â­ï¸ ØªÙ… ØªØ®Ø·ÙŠ {skipped_count} Ù„Ø¹Ø¨Ø©(Ù„Ø¹Ø¨) - Ø§Ù„Ø¹Ø¯Ø§Ø¯ ÙŠØ¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† ØªÙˆÙ‚Ù")
        except Exception as e:
            print(f"âš ï¸ Ø®Ø·Ø£ ÙÙŠ worker Ø§Ù„ØªØ®Ø·ÙŠ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ: {e}")
            time.sleep(1)





def calculate_dice_animation_progress(start_time_str, duration=2.0):
    """
    Ø­Ø³Ø§Ø¨ ØªÙ‚Ø¯Ù… Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ù…ØªØ­Ø±Ùƒ Ù„Ù„Ù†Ø±Ø¯ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ù†Ù‚Ø¶ÙŠ
    
    Args:
        start_time_str: ÙˆÙ‚Øª Ø¨Ø¯Ø¡ Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ù…ØªØ­Ø±Ùƒ (string timestamp)
        duration: Ù…Ø¯Ø© Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ù…ØªØ­Ø±Ùƒ Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ (Ø§ÙØªØ±Ø§Ø¶ÙŠ 2.0)
    
    Returns:
        dict: {
            'is_rolling': bool,
            'progress': float (0.0 to 1.0),
            'elapsed_time': float,
            'remaining_time': float
        }
    """
    if not start_time_str:
        return {
            'is_rolling': False,
            'progress': 1.0,
            'elapsed_time': 0,
            'remaining_time': 0
        }
    
    try:
        start_time = datetime.fromisoformat(start_time_str)
        current_time = datetime.now()
        elapsed = (current_time - start_time).total_seconds()
        
        if elapsed >= duration:
            return {
                'is_rolling': False,
                'progress': 1.0,
                'elapsed_time': elapsed,
                'remaining_time': 0
            }
        
        progress = elapsed / duration
        remaining = duration - elapsed
        
        return {
            'is_rolling': True,
            'progress': progress,
            'elapsed_time': elapsed,
            'remaining_time': remaining
        }
    except Exception as e:
        print(f"Ø®Ø·Ø£ ÙÙŠ Ø­Ø³Ø§Ø¨ ØªÙ‚Ø¯Ù… Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ù…ØªØ­Ø±Ùƒ: {e}")
        return {
            'is_rolling': False,
            'progress': 1.0,
            'elapsed_time': 0,
            'remaining_time': 0
        }

def get_ludo_game_realtime_state(game_id):
    """
    Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙØ¹Ù„ÙŠ Ù…Ø¹ Ø­Ø³Ø§Ø¨ Ù…ÙˆØ¶Ø¹ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ù…ØªØ­Ø±ÙƒØ©
    """
    try:
        conn = get_db()
        cursor = conn.cursor()
        
        cursor.execute('''
            SELECT * FROM ludo_active_games WHERE id = ?
        ''', (game_id,))
        
        game = cursor.fetchone()
        conn.close()
        
        if not game:
            return None
        
        dice_progress = calculate_dice_animation_progress(
            game['dice_roll_start_time'],
            game['dice_animation_duration'] or 2.0
        )
        
        piece_animations = {}
        try:
            piece_animations = json.loads(game['piece_animation_data'] or '{}')
        except:
            piece_animations = {}
        
        active_piece_animations = {}
        for piece_id, anim_data in piece_animations.items():
            if 'start_time' in anim_data:
                progress = calculate_dice_animation_progress(
                    anim_data['start_time'],
                    anim_data.get('duration', 0.5)
                )
                if progress['is_rolling']:
                    active_piece_animations[piece_id] = {
                        **anim_data,
                        'progress': progress['progress'],
                        'remaining_time': progress['remaining_time']
                    }
        
        return {
            'game_id': game['id'],
            'current_turn': game['current_turn'],
            'last_roll': game['last_roll'],
            'player1_position': game['player1_position'],
            'player2_position': game['player2_position'],
            'dice_animation': dice_progress,
            'piece_animations': active_piece_animations,
            'game_event_version': game['game_event_version'] or 0,
            'last_event_timestamp': game['last_event_timestamp']
        }
    except Exception as e:
        print(f"Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©: {e}")
        return None

def login_required(f):
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if 'user_id' not in session:
            return redirect(url_for('login'))
        return f(*args, **kwargs)
    return decorated_function

def api_login_required(f):
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if 'user_id' not in session:
            return jsonify({'success': False, 'error': 'ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„'}), 401
        return f(*args, **kwargs)
    return decorated_function

def admin_required(f):
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if 'user_id' not in session or not session.get('is_admin'):
            return redirect(url_for('dashboard'))
        return f(*args, **kwargs)
    return decorated_function

def contains_emoji(text):
    emoji_pattern = re.compile("["
        u"\U0001F600-\U0001F64F"
        u"\U0001F300-\U0001F5FF"
        u"\U0001F680-\U0001F6FF"
        u"\U0001F1E0-\U0001F1FF"
        "]+", flags=re.UNICODE)
    return bool(emoji_pattern.search(text))

def has_bad_words(text):
    bad_words = ['ÙƒÙ„Ø¨', 'Ø­Ù…Ø§Ø±', 'ØºØ¨ÙŠ', 'Ø§Ø­Ù…Ù‚', 'Ù‚Ø°Ø±']
    text_lower = text.lower()
    for word in bad_words:
        if word in text_lower:
            return True
    return False

@app.before_request
def check_session_and_active_game():
    if request.endpoint in ['login', 'register', 'forgot_password', 'static', 'serve_static']:
        return None
    
    if 'user_id' in session and session['user_id'] != 'admin':
        conn = get_db()
        cursor = conn.cursor()
        
        cursor.execute('SELECT id FROM users WHERE id = ?', (session['user_id'],))
        user = cursor.fetchone()
        
        if not user:
            conn.close()
            session.clear()
            return redirect(url_for('login'))
        
        if request.endpoint not in ['ludo_arena', 'ludo_roll', 'ludo_state', 'ludo_move', 'check_ludo_match', 'cancel_ludo_matchmaking', 'exit_ludo_game']:
            
            
            cursor.execute('''
                SELECT id, game_status
                FROM ludo_active_games
                WHERE (player1_id = ? OR player2_id = ?) 
                AND game_status = 'playing'
                ORDER BY created_at DESC LIMIT 1
            ''', (session['user_id'], session['user_id']))
            ludo_game = cursor.fetchone()
            
            if ludo_game and not session.get('intentional_exit'):
                conn.close()
                return redirect(url_for('ludo_arena', game_id=ludo_game['id']))
            
            
        
        conn.close()
    
    session.pop('intentional_exit', None)
    return None

BASE_TEMPLATE = '''
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨{% endblock %}</title>
    <style>
        html, body {
            background-color: #667eea !important;
            background-image: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            background-attachment: fixed !important;
        }
    </style>
    <style>
        html {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            background-attachment: fixed !important;
        }
        
        body {
            background: transparent !important;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            max-width: 500px;
            width: 100%;
        }
        
        .dashboard-container {
            max-width: 1200px;
            width: 100%;
        }
        
        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 30px;
            font-size: 28px;
        }
        
        h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 22px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }
        
        input[type="text"],
        input[type="password"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border 0.3s;
        }
        
        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            margin-top: 10px;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }
        
        .btn-small {
            width: auto;
            padding: 8px 16px;
            font-size: 14px;
            display: inline-block;
            margin: 5px;
        }
        
        .link {
            text-align: center;
            margin-top: 20px;
        }
        
        .link a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }
        
        .link a:hover {
            text-decoration: underline;
        }
        
        .alert {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th, td {
            padding: 12px;
            text-align: right;
            border-bottom: 1px solid #e0e0e0;
        }
        
        th {
            background: #f5f5f5;
            font-weight: 600;
        }
        
        .badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .badge-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .badge-approved {
            background: #d4edda;
            color: #155724;
        }
        
        .badge-rejected {
            background: #f8d7da;
            color: #721c24;
        }
        
        .deposit-withdraw-nav {
            display: flex;
            gap: 25px;
            margin-bottom: 30px;
            padding-bottom: 10px;
            padding-top: 50px;
            justify-content: center;
        }
        
        .deposit-withdraw-btn {
            padding: 15px 40px !important;
            background: #d3d3d3 !important;
            border: none !important;
            color: #333 !important;
            border-radius: 12px !important;
            font-size: 16px !important;
            font-weight: 600 !important;
            text-decoration: none !important;
            cursor: pointer !important;
            transition: all 0s !important;
            display: inline-block !important;
            text-align: center !important;
            min-width: 150px !important;
        }
        
        .deposit-withdraw-btn:hover {
            background: #b0b0b0 !important;
            transform: translateY(-2px) !important;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2) !important;
        }
        
        .deposit-withdraw-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3) !important;
        }
        
        .game-room {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
        }
        
        .dice {
            font-size: 48px;
            text-align: center;
            margin: 20px 0;
        }
        
        .note {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            font-size: 12px;
            color: #856404;
        }
        
        .logout {
            text-align: center;
            margin-top: 20px;
        }
        
        .logout a {
            color: #dc3545;
            text-decoration: none;
            font-weight: 600;
        }
        
        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .nav-tab {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }
        
        .nav-tab.active {
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .image-preview {
            max-width: 100%;
            max-height: 400px;
            margin: 10px 0;
            border-radius: 8px;
        }
        
        .logout-btn {
            display: none;
        }
        
        .page-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            min-height: 500px;
            margin-bottom: 100px;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
            animation: slideDown 0.3s ease-out;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .fade-out {
            animation: fadeOut 0.5s ease-out forwards;
        }
        
        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
                transform: translateY(-10px);
            }
        }

        .deposit-info-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            white-space: pre-line;
            font-size: 16px;
            line-height: 1.8;
        }

        .upload-section {
            background: #f8f9fa;
            border: 2px dashed #667eea;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            margin-top: 20px;
        }

        .upload-section input[type="file"] {
            margin: 15px 0;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .username-badge {
            background: #f8f9fa;
            padding: 8px 15px;
            border-radius: 8px;
            font-weight: 600;
            color: #667eea;
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 25px 20px;
                border-radius: 15px;
            }
            
            h1 {
                font-size: 22px;
                margin-bottom: 25px;
            }
            
            h2 {
                font-size: 18px;
            }
            
            input[type="text"],
            input[type="password"],
            input[type="number"],
            textarea,
            select {
                font-size: 14px;
                padding: 10px;
            }
            
            .btn {
                padding: 12px;
                font-size: 15px;
            }
            
            label {
                font-size: 14px;
            }
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 20px 15px;
            }
            
            h1 {
                font-size: 20px;
            }
            
            .btn {
                padding: 11px;
                font-size: 14px;
            }
        }
    </style>
    {% block extra_style %}{% endblock %}
</head>
<body>
    
    {% block content %}{% endblock %}
    
    <script>
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        function hideMessageAfterDelay(elementId, delay) {
            setTimeout(function() {
                var element = document.getElementById(elementId);
                if (element) {
                    element.classList.add('fade-out');
                    setTimeout(function() {
                        element.style.display = 'none';
                    }, 500);
                }
            }, delay);
        }

        window.onload = function() {
            var successMsg = document.getElementById('success-message');
            if (successMsg) {
                hideMessageAfterDelay('success-message', 5000);
            }
            
            // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø²Ø± Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
            var liveBtn = document.getElementById('live-btn');
            if (liveBtn) {
                liveBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    showPage('live');
                });
            }
        }
    </script>
    {% block extra_script %}{% endblock %}
</body>
</html>
'''

LOGIN_PAGE = BASE_TEMPLATE.replace('{% block content %}{% endblock %}', '''
{% block content %}
<div class="container">
    <h1>ğŸ® ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h1>
    
    {% if error %}
    <div class="alert alert-error">{{ error }}</div>
    {% endif %}
    
    <form method="POST" action="{{ url_for('login') }}">
        <div class="form-group">
            <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
            <input type="text" name="username" required>
        </div>
        
        <div class="form-group">
            <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
            <input type="password" name="password" required>
        </div>
        
        <button type="submit" class="btn">Ø¯Ø®ÙˆÙ„</button>
        
        <div class="link">
            <a href="{{ url_for('forgot_password') }}">Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ</a>
        </div>
        
        <div class="link">
            Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ <a href="{{ url_for('register') }}">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</a>
        </div>
    </form>
</div>
{% endblock %}
''')

REGISTER_PAGE = BASE_TEMPLATE.replace('{% block content %}{% endblock %}', '''
{% block content %}
<div class="container">
    <h1>ğŸ® Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</h1>
    
    {% if error %}
    <div class="alert alert-error">{{ error }}</div>
    {% endif %}
    
    <form method="POST" action="{{ url_for('register') }}">
        <div class="form-group">
            <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
            <input type="text" name="username" required minlength="3" maxlength="15">
        </div>
        
        <div class="form-group">
            <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
            <input type="password" name="password" required minlength="6">
        </div>
        
        <div class="form-group">
            <label>Ø±Ù…Ø² PIN (3 Ø£Ø±Ù‚Ø§Ù…)</label>
            <input type="text" name="pin" required pattern="[0-9]{3}" maxlength="3">
            <div class="note">âš ï¸ ÙŠØ¬Ø¨ Ø­ÙØ¸ Ø§Ù„Ø±Ù…Ø² ÙÙŠ Ù…ÙƒØ§Ù† Ø¢Ù…Ù† ÙÙ…Ù† Ø®Ù„Ø§Ù„Ù‡ ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ±Ø¬Ø§Ø¹ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ</div>
        </div>
        
        <button type="submit" class="btn">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
        
        <div class="link">
            Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ <a href="{{ url_for('login') }}">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a>
        </div>
    </form>
</div>
{% endblock %}
''')

FORGOT_PASSWORD_PAGE = BASE_TEMPLATE.replace('{% block content %}{% endblock %}', '''
{% block content %}
<div class="container">
    <h1>ğŸ”‘ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h1>
    
    {% if error %}
    <div class="alert alert-error">{{ error }}</div>
    {% endif %}
    
    {% if success %}
    <div class="alert alert-success">{{ success }}</div>
    <div class="link">
        <a href="{{ url_for('login') }}">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a>
    </div>
    {% else %}
    <form method="POST" action="{{ url_for('forgot_password') }}">
        <div class="form-group">
            <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
            <input type="text" name="username" required>
        </div>
        
        <div class="form-group">
            <label>Ø±Ù…Ø² PIN</label>
            <input type="text" name="pin" required pattern="[0-9]{3}" maxlength="3">
        </div>
        
        <div class="form-group">
            <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label>
            <input type="password" name="new_password" required minlength="6">
        </div>
        
        <button type="submit" class="btn">Ø§Ø³ØªØ±Ø¬Ø§Ø¹ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</button>
        
        <div class="link">
            <a href="{{ url_for('login') }}">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a>
        </div>
    </form>
    {% endif %}
</div>
{% endblock %}
''')

DASHBOARD_PAGE = '''
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        /* Ø¨Ø¯ÙˆÙ† ÙˆÙ…ÙŠØ¶ - Ù†Ø¸Ø§Ù… SPA ÙŠØ­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ù„ÙÙŠØ© */
        /* Ø¨Ø¯ÙˆÙ† ÙˆÙ…ÙŠØ¶ - Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø£ØµÙ„ÙŠØ© ØªØ¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ù…Ø´Ø§ÙƒÙ„ */
        /* Ø¨Ø¯ÙˆÙ† ÙˆÙ…ÙŠØ¶ - Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø£ØµÙ„ÙŠØ© ØªØ¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ù…Ø´Ø§ÙƒÙ„ */
    </style>
    <style>
        /* Ø¨Ø¯ÙˆÙ† ÙˆÙ…ÙŠØ¶ - Ù†Ø¸Ø§Ù… SPA ÙŠØ­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ù„ÙÙŠØ© */
        /* Ø¨Ø¯ÙˆÙ† ÙˆÙ…ÙŠØ¶ - Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø£ØµÙ„ÙŠØ© ØªØ¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ù…Ø´Ø§ÙƒÙ„ */
        /* Ø¨Ø¯ÙˆÙ† ÙˆÙ…ÙŠØ¶ - Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø£ØµÙ„ÙŠØ© ØªØ¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ù…Ø´Ø§ÙƒÙ„ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        html {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) fixed;
            min-height: 100vh;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: transparent;
            min-height: 100vh;
            padding: 20px;
            padding-top: 90px;
        }
        
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .top-info-bar {
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 2px 2px;
            border-radius: 0 0 15px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 101;
            width: 100%;
            box-sizing: border-box;
        }
        
        .top-info-bar .balance-display {
            order: 1;
            margin-right: 50px;
        }
        
        .top-info-bar .username-display {
            order: 2;
            margin-right: 80px;
        }
        
        .top-navbar {
            background: white;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            padding: 15px 30px;
            border-radius: 15px 15px 0 0;
            margin-bottom: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 100;
        }
        
        .nav-right {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            gap: 20px;
            padding: 0 20px;
            margin-bottom: 10px;
            order: -1;
        }
        
        .balance-display {
            background: transparent;
            color: #22c55e;
            padding: 10px 25px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            order: 2;
            white-space: nowrap;
        }
        
        .username-display {
            background: #f8f9fa;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 600;
            color: #667eea;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 15px;
            order: 1;
        }
        
        .language-toggle-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 6px 10px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 32px;
            height: 32px;
        }
        
        .language-toggle-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .language-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .language-modal-overlay.active {
            display: flex;
        }
        
        .language-modal {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            text-align: center;
            min-width: 300px;
            animation: modalSlideIn 0.3s ease-out;
        }
        
        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .language-modal h2 {
            margin: 0 0 30px 0;
            color: #667eea;
            font-size: 24px;
        }
        
        .language-option {
            display: block;
            width: 100%;
            padding: 15px;
            margin-bottom: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .language-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        .language-option:last-child {
            margin-bottom: 0;
        }
        
        .close-language-modal {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            transition: all 0.3s ease;
        }
        
        .close-language-modal:hover {
            color: #333;
            transform: rotate(90deg);
        }
        
        .nav-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: nowrap;
            width: 100%;
            justify-content: space-around;
            align-items: flex-end;
            padding: 0 10px 2px 10px;
            height: 30px;
        }
        
        .nav-btn {
            padding: 8px 12px;
            background: transparent;
            color: #666;
            border: none;
            border-radius: 12px;
            font-size: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            height: 30px;
            position: relative;
            min-width: 60px;
        }
        
        .nav-btn.games-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin: 0 10px -5px 10px;
            font-size: 14px;
            box-shadow: 0 -5px 15px rgba(102, 126, 234, 0.3);
            min-width: auto;
            flex: 0 0 auto;
        }
        
        .games-text {
            transition: transform 0.3s ease;
        }
        
        .games-text.raised {
            transform: translateY(-8px) !important;
        }
        
        
        .nav-btn:hover {
            color: #667eea;
            transform: translateY(-3px);
        }
        
        .nav-btn.games-btn:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            transform: scale(1.1) translateY(-5px);
            box-shadow: 0 -8px 20px rgba(102, 126, 234, 0.4);
        }
        
        .nav-btn.active {
            color: #667eea;
        }
        
        .nav-btn.games-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .page-content {
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            min-height: 600px;
            margin-bottom: 100px;
        }
        
        h1 {
            color: #667eea;
            margin-bottom: 30px;
            font-size: 32px;
        }
        
        h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 24px;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
            animation: slideDown 0.3s ease-out;
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-out {
            animation: fadeOut 0.5s ease-out forwards;
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; transform: translateY(-10px); }
        }
        
        .deposit-info-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            white-space: pre-line;
            font-size: 17px;
            line-height: 1.8;
        }
        
        .upload-section {
            background: #f8f9fa;
            border: 2px dashed #667eea;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            margin-top: 25px;
        }
        
        .upload-section input[type="file"] {
            margin: 15px 0;
            padding: 10px;
        }
        
        .btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 15px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 10px;
            color: #333;
            font-weight: 600;
            font-size: 16px;
        }
        
        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border 0.3s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .game-room {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .game-room-info {
            font-size: 18px;
            font-weight: 600;
        }
        
        .btn-small {
            width: auto;
            padding: 10px 25px;
            margin: 0;
            font-size: 15px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th, td {
            padding: 15px;
            text-align: right;
            border-bottom: 1px solid #e0e0e0;
        }
        
        th {
            background: #f5f5f5;
            font-weight: 600;
            font-size: 16px;
        }
        
        .badge {
            padding: 5px 15px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
        }
        
        .badge-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .badge-approved {
            background: #d4edda;
            color: #155724;
        }
        
        .badge-rejected {
            background: #f8d7da;
            color: #721c24;
        }
        
        .logout-btn {
            padding: 8px 12px;
            background: transparent;
            color: #666;
            border: none;
            border-radius: 12px;
            font-size: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            height: 70px;
            position: relative;
            min-width: 60px;
        }
        
        .logout-btn:hover {
            color: #fa709a;
            transform: translateY(-3px);
        }
        
        .note {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 12px;
            margin-top: 10px;
            font-size: 14px;
            color: #856404;
        }
        
        .games-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 20px;
            margin-top: 30px;
            padding: 20px 0;
        }
        
        .game-card {
            background: linear-gradient(135deg, #1a472a 0%, #0d261a 100%);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            text-decoration: none;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            min-height: 200px;
            position: relative;
            overflow: hidden;
        }
        
        .game-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(to bottom, rgba(0,0,0,0.2) 0%, rgba(0,0,0,0.6) 100%);
            z-index: 1;
        }
        
        .dice-container {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 80px;
            height: 80px;
            transform-style: preserve-3d;
            transform: translate(-50%, -50%) rotateX(-25deg) rotateY(-35deg);
            z-index: 0;
        }
        
        .dice-face {
            position: absolute;
            width: 80px;
            height: 80px;
            background: linear-gradient(145deg, #ffffff, #e8e8e8);
            border: none;
            border-radius: 12px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            padding: 8px;
            gap: 6px;
            box-shadow: inset 0 2px 8px rgba(255, 255, 255, 0.5),
                        inset 0 -2px 8px rgba(0, 0, 0, 0.15),
                        0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .dice-face.front {
            transform: translateZ(40px);
        }
        
        .dice-face.back {
            transform: rotateY(180deg) translateZ(40px);
        }
        
        .dice-face.right {
            transform: rotateY(90deg) translateZ(40px);
        }
        
        .dice-face.left {
            transform: rotateY(-90deg) translateZ(40px);
        }
        
        .dice-face.top {
            transform: rotateX(90deg) translateZ(40px);
        }
        
        .dice-face.bottom {
            transform: rotateX(-90deg) translateZ(40px);
        }
        
        .dice-dot {
            width: 10px;
            height: 10px;
            background: radial-gradient(circle, #1a1a1a, #000000);
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.5),
                        inset 0 1px 2px rgba(0, 0, 0, 0.3);
        }
        
        .face-1 .dice-dot:nth-child(5) { display: block; }
        .face-1 .dice-dot:not(:nth-child(5)) { display: none; }
        
        .face-2 .dice-dot:nth-child(1),
        .face-2 .dice-dot:nth-child(9) { display: block; }
        .face-2 .dice-dot:not(:nth-child(1)):not(:nth-child(9)) { display: none; }
        
        .face-3 .dice-dot:nth-child(1),
        .face-3 .dice-dot:nth-child(5),
        .face-3 .dice-dot:nth-child(9) { display: block; }
        .face-3 .dice-dot:not(:nth-child(1)):not(:nth-child(5)):not(:nth-child(9)) { display: none; }
        
        .face-4 .dice-dot:nth-child(1),
        .face-4 .dice-dot:nth-child(3),
        .face-4 .dice-dot:nth-child(7),
        .face-4 .dice-dot:nth-child(9) { display: block; }
        .face-4 .dice-dot:nth-child(5),
        .face-4 .dice-dot:nth-child(2),
        .face-4 .dice-dot:nth-child(4),
        .face-4 .dice-dot:nth-child(6),
        .face-4 .dice-dot:nth-child(8) { display: none; }
        
        .face-5 .dice-dot { display: block; }
        .face-5 .dice-dot:nth-child(2),
        .face-5 .dice-dot:nth-child(4),
        .face-5 .dice-dot:nth-child(6),
        .face-5 .dice-dot:nth-child(8) { display: none; }
        
        .face-6 .dice-dot:nth-child(2),
        .face-6 .dice-dot:nth-child(5),
        .face-6 .dice-dot:nth-child(8) { display: none; }
        .face-6 .dice-dot { display: block; }
        
        .game-card-title {
            position: relative;
            z-index: 2;
            margin-bottom: 10px;
            font-size: 18px;
            font-weight: 700;
            text-shadow: 2px 2px 6px rgba(0,0,0,0.7);
        }
        
        .game-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        
        .game-card-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        .game-card-title {
            font-size: 16px;
            font-weight: 600;
            color: white;
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .main-container {
                padding: 0;
            }
            
            .top-navbar {
                padding: 10px 15px;
                border-radius: 15px 15px 0 0;
                flex-direction: row;
                gap: 5px;
                align-items: flex-end;
            }
            
            .nav-right {
                display: flex;
                width: 100%;
                justify-content: space-between;
                gap: 10px;
                order: -1;
                margin-bottom: 8px;
            }
            
            .balance-display {
                font-size: 16px;
                padding: 8px 15px;
                flex: 1;
                text-align: center;
                order: 2;
                white-space: nowrap;
            }
            
            .username-display {
                font-size: 14px;
                padding: 8px 15px;
                flex: 1;
                text-align: center;
                display: flex;
                order: 1;
            }
            
            .nav-buttons {
                width: 100%;
                flex-direction: row;
                gap: 5px;
                justify-content: space-around;
                height: 30px;
                padding: 0 10px 2px 10px;
            }
            
            .nav-btn {
                width: auto;
                padding: 8px 12px;
                font-size: 18px;
                text-align: center;
                height: 30px;
                min-width: 50px;
            }
            
            .nav-btn[href*="games"] {
                width: 70px;
                height: 70px;
                margin: 0 5px -5px 5px;
                font-size: 22px;
            }
            
            .logout-btn {
                width: 100%;
                padding: 12px 20px;
                font-size: 15px;
                text-align: center;
            }
            
            .page-content {
                padding: 20px 15px;
                border-radius: 12px;
                min-height: 400px;
            }
            
            h1 {
                font-size: 24px;
                margin-bottom: 20px;
            }
            
            h2 {
                font-size: 20px;
                margin-bottom: 15px;
            }
            
            .form-group {
                margin-bottom: 15px;
            }
            
            label {
                font-size: 14px;
                margin-bottom: 8px;
            }
            
            input[type="text"],
            input[type="number"],
            select {
                font-size: 14px;
                padding: 10px;
            }
            
            .btn {
                font-size: 16px;
                padding: 12px;
            }
            
            .game-room {
                flex-direction: column;
                gap: 12px;
                padding: 15px;
                text-align: center;
            }
            
            .game-room-info {
                font-size: 16px;
            }
            
            .btn-small {
                width: 100%;
                padding: 10px;
                font-size: 14px;
            }
            
            table {
                font-size: 13px;
            }
            
            th, td {
                padding: 10px 8px;
                font-size: 13px;
            }
            
            .deposit-info-box {
                padding: 15px;
                font-size: 14px;
                line-height: 1.6;
            }
            
            .upload-section {
                padding: 20px 15px;
            }
            
            .badge {
                font-size: 11px;
                padding: 4px 10px;
            }
        }
        
        @media (max-width: 480px) {
            .top-navbar {
                padding: 10px;
            }
            
            .balance-display,
            .username-display {
                font-size: 14px;
                padding: 7px 12px;
            }
            
            .nav-btn,
            .logout-btn {
                font-size: 14px;
                padding: 10px 15px;
            }
            
            h1 {
                font-size: 20px;
            }
            
            h2 {
                font-size: 18px;
            }
            
            .page-content {
                padding: 15px 10px;
            }
        }
        
        .page-transition {
            animation: none;
        }
        
        .deposit-withdraw-nav {
            display: flex;
            gap: 25px;
            margin-bottom: 30px;
            padding-bottom: 10px;
            padding-top: 50px;
            justify-content: center;
        }
        
        .deposit-withdraw-btn {
            padding: 15px 40px !important;
            background: #d3d3d3 !important;
            border: none !important;
            color: #333 !important;
            border-radius: 12px !important;
            font-size: 16px !important;
            font-weight: 600 !important;
            text-decoration: none !important;
            cursor: pointer !important;
            transition: all 0s !important;
            display: inline-block !important;
            text-align: center !important;
            min-width: 150px !important;
        }
        
        .deposit-withdraw-btn:hover {
            background: #b0b0b0 !important;
            transform: translateY(-2px) !important;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2) !important;
        }
        
        .deposit-withdraw-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3) !important;
        }
        
        .development-notification {
            position: fixed;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
            z-index: 1000;
            animation: slideUp 0.3s ease-out, slideDown 0.3s ease-in 1.7s;
            white-space: nowrap;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }
        
        @keyframes slideDown {
            from {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
            to {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }
        }
        
        .live-btn {
            padding: 5px 8px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            min-width: auto !important;
            background: transparent !important;
            border: none !important;
            color: #555 !important;
            font-size: 14px !important;
            text-decoration: none !important;
            cursor: pointer !important;
            transition: all 0s !important;
            height: auto !important;
            width: auto !important;
            transform: translateY(5px) !important;
        }
        
        .live-btn:hover svg {
            transform: scale(1.1) !important;
            filter: brightness(1.1) !important;
        }
        
        .live-btn svg {
            color: #555;
            transition: all 0.3s ease-in-out;
        }
    </style>
    <script>
        // ØªØ·Ø¨ÙŠÙ‚ ÙÙˆØ±ÙŠ Ù„Ù„ØªØ±Ø¬Ù…Ø§Øª Ù‚Ø¨Ù„ Ø±Ø³Ù… Ø§Ù„ØµÙØ­Ø©
        (function() {
            const lang = localStorage.getItem('language') || 'ar';
            document.documentElement.lang = lang;
            
            // Ø¥Ø¶Ø§ÙØ© class ready Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ DOM Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØµÙØ­Ø©
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function() {
                    document.body.classList.add('ready');
                });
            } else {
                document.body.classList.add('ready');
            }
        })();
    </script>
</head>
<body>
    
    <div class="top-info-bar">
        <div class="balance-display">{{ "%.2f"|format(user['balance']) }} $</div>
        <div class="username-display">
            {{ user['username'] }}
            <button class="language-toggle-btn" id="lang-toggle" title="ØªØºÙŠÙŠØ± Ø§Ù„Ù„ØºØ©">ğŸŒ</button>
        </div>
    </div>
    
    <div class="language-modal-overlay" id="language-modal">
        <div class="language-modal">
            <button class="close-language-modal" id="close-lang-modal">âœ•</button>
            <h2 data-i18n="choose_language">Ø§Ø®ØªØ± Ø§Ù„Ù„ØºØ©</h2>
            <button class="language-option" data-lang="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</button>
            <button class="language-option" data-lang="en">English</button>
            <button class="language-option" data-lang="ru">Ğ ÑƒÑÑĞºĞ¸Ğ¹</button>
        </div>
    </div>
    
    <div class="main-container page-transition">
        <div class="top-navbar">
            <div class="nav-buttons">
                <button class="nav-btn" onclick="showPage('notifications')" style="font-size: 18px; cursor: pointer; background: none; border: none; padding: 10px 15px; position: relative;">ğŸ””<span id="notification-badge" style="position: absolute; top: -5px; right: 5px; background: #dc3545; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 11px; font-weight: bold; display: flex; align-items: center; justify-content: center; display: none;">0</span></button>
                <button class="nav-btn" onclick="showPage('profile')" style="font-size: 14px; font-weight: bold; color: #555555; transform: translateY(9.5px);" data-i18n="account">Ø§Ù„Ø­Ø³Ø§Ø¨</button>
                <button class="nav-btn games-btn" onclick="showPage('games')"><span class="games-text" data-i18n="games">Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨</span></button>
                <button class="nav-btn" onclick="showPage('deposit')" style="font-size: 14px; font-weight: bold; color: #555555; transform: translateY(10px);" data-i18n="wallet">Ù…Ø­ÙØ¸Ø©</button>
                <button class="nav-btn live-btn" id="live-btn" data-i18n="live">Ù…Ø¨Ø§Ø´Ø±</button>
            </div>
        </div>
        
        <script>
        function showPage(pageName) {
            // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙØ­Ø§Øª
            document.querySelectorAll('.page-section').forEach(el => el.style.display = 'none');
            // Ø¥Ø²Ø§Ù„Ø© active Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
            document.querySelectorAll('.nav-buttons .nav-btn').forEach(btn => btn.classList.remove('active'));
            
            // Ø¹Ø±Ø¶ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
            const pageEl = document.getElementById('page-' + pageName);
            if (pageEl) {
                pageEl.style.display = 'block';
            }
            
            // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø± Ø§Ù„Ù…Ø®ØªØ§Ø±
            event.target.classList.add('active');
        }
        </script>
        
        <div id="development-notification" class="development-notification" style="display: none;">
            ğŸ”¨ <span data-i18n="feature_in_development">Ø§Ù„Ù…ÙŠØ²Ø© Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±</span>
        </div>
        
        <div class="page-content page-transition">
            {% with messages = get_flashed_messages() %}
            {% if messages %}
                {% for message in messages %}
                <div class="success-message" id="success-message">{{ message }}</div>
                {% endfor %}
            {% endif %}
            {% endwith %}
            
            <!-- SPA Pages Container -->
            <div id="page-games" class="page-section" style="display: block;">
                {% block page_content %}{% endblock %}
            </div>
            <div id="page-profile" class="page-section" style="display: none;">
                <h1 style="margin-top: 30px;">ğŸ‘¤ Ø§Ù„Ø­Ø³Ø§Ø¨</h1>
                
                <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ù„Ù„Ø­Ø³Ø§Ø¨ -->
                <div style="display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap;">
                    <button onclick="toggleProfileSection('profile-info')" id="profile-info-btn" style="flex: 1; min-width: 150px; padding: 15px 25px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3); transition: all 0.3s ease;">ğŸ‘¤ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</button>
                    <button onclick="toggleProfileSection('change-username')" id="change-username-btn" style="flex: 1; min-width: 150px; padding: 15px 25px; background: linear-gradient(135deg, #00bcd4 0%, #0097a7 100%); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(0, 188, 212, 0.3); transition: all 0.3s ease;">âœï¸ ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</button>
                </div>
                
                <!-- Ù‚Ø³Ù… Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ -->
                <div id="profile-info" style="display: none;">
                    <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 25px; border-radius: 12px; margin-bottom: 30px; border: 2px solid #667eea;">
                        <h3 style="color: #667eea; margin-bottom: 20px; font-size: 20px;">ğŸ“‹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨</h3>
                        <div style="background: white; padding: 20px; border-radius: 10px;">
                            <p style="margin-bottom: 15px; font-size: 16px; padding: 10px; background: #f8f9fa; border-radius: 6px;"><strong>ğŸ‘¤ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</strong> <span style="color: #667eea; font-weight: bold;">{{ user['username'] }}</span></p>
                            <p style="margin-bottom: 15px; font-size: 16px; padding: 10px; background: #f8f9fa; border-radius: 6px;"><strong>ğŸ’° Ø§Ù„Ø±ØµÙŠØ¯:</strong> <span id="profile-balance" style="color: #28a745; font-weight: bold;">{{ "%.2f"|format(user['balance']) }}</span> $</p>
                            <p style="margin-bottom: 15px; font-size: 16px; padding: 10px; background: #f8f9fa; border-radius: 6px;"><strong>âš ï¸ Ø§Ù„ØªØ­Ø°ÙŠØ±Ø§Øª:</strong> <span style="color: {% if user['warnings'] > 0 %}#dc3545{% else %}#28a745{% endif %}; font-weight: bold;">{{ user['warnings'] }}</span></p>
                            <p style="font-size: 16px; padding: 10px; background: #f8f9fa; border-radius: 6px;"><strong>ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„:</strong> <span style="color: #6c757d;">{{ user['created_at'] }}</span></p>
                        </div>
                    </div>
                </div>
                
                <!-- Ù‚Ø³Ù… ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… -->
                <div id="change-username" style="display: none;">
                    <div style="background: linear-gradient(135deg, #e8f4f8 0%, #d4edda 100%); padding: 25px; border-radius: 12px; margin-bottom: 30px; border: 2px solid #00bcd4;">
                        <h3 style="color: #00bcd4; margin-bottom: 20px; font-size: 20px;">âœï¸ ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h3>
                        <div id="username-change-message" style="display: none; padding: 15px; border-radius: 8px; margin-bottom: 15px; font-weight: bold; text-align: center;"></div>
                        <form id="change-username-form" onsubmit="return changeUsernameAjax(event)">
                            <div class="form-group" style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 10px; font-weight: bold; color: #333;">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯</label>
                                <input type="text" id="new-username-input" name="new_username" required minlength="3" maxlength="15" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯" style="width: 100%; padding: 12px; border: 2px solid #00bcd4; border-radius: 8px; font-size: 16px;">
                                <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 6px; padding: 10px; margin-top: 10px;">
                                    <p style="color: #856404; margin: 0; font-size: 14px;">â±ï¸ ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙƒÙ„ 30 ÙŠÙˆÙ…</p>
                                </div>
                            </div>
                            <button type="submit" id="change-username-submit-btn" class="btn" style="width: 100%; padding: 15px; font-size: 16px; background: linear-gradient(135deg, #00bcd4 0%, #0097a7 100%);">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯</button>
                        </form>
                    </div>
                </div>
                
                <div style="margin-top: 40px; padding-top: 30px; border-top: 2px solid #e0e0e0; text-align: center;">
                    <form method="GET" action="{{ url_for('logout') }}" style="display: inline;">
                        <button type="submit" class="btn" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); padding: 12px 30px; font-size: 16px;">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
                    </form>
                </div>
            </div>
            <div id="page-deposit" class="page-section" style="display: none;">
                <div class="deposit-withdraw-nav">
                    <button onclick="switchTab('deposit-tab')" class="deposit-withdraw-btn active">ğŸ’³ Ø´Ø­Ù† Ø§Ù„Ø­Ø³Ø§Ø¨</button>
                    <button onclick="switchTab('withdraw-tab')" class="deposit-withdraw-btn">ğŸ’° Ø³Ø­Ø¨ Ø±ØµÙŠØ¯</button>
                </div>
                
                <!-- Deposit Tab -->
                <div id="deposit-tab" style="display: block;">
                    <h1>ğŸ’³ Ø´Ø­Ù† Ø§Ù„Ø­Ø³Ø§Ø¨</h1>
                    
                    <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ù„Ù„Ø´Ø­Ù† -->
                    <div style="display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap;">
                        <button onclick="toggleDepositMethod('usdt-method')" id="usdt-btn" style="flex: 1; min-width: 150px; padding: 15px 25px; background: linear-gradient(135deg, #00bcd4 0%, #0097a7 100%); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(0, 188, 212, 0.3); transition: all 0.3s ease;">ğŸ’ Ø´Ø­Ù† ÙÙˆØ±ÙŠ USDT</button>
                        <button onclick="toggleDepositMethod('manual-method')" id="manual-btn" style="flex: 1; min-width: 150px; padding: 15px 25px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3); transition: all 0.3s ease;">ğŸ“¤ Ø´Ø­Ù† ÙŠØ¯ÙˆÙŠ</button>
                    </div>
                    
                    <!-- Ù‚Ø³Ù… Ø´Ø­Ù† USDT Ø§Ù„ÙÙˆØ±ÙŠ -->
                    <div id="usdt-method" style="display: none;">
                        <div style="background: #e8f4f8; border-right: 4px solid #00bcd4; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
                            <h3 style="color: #00bcd4; margin-bottom: 15px;">ğŸ¯ Ø·Ø±ÙŠÙ‚Ø© Ø´Ø­Ù† Ù…Ù† BNB Ù…Ø¨Ø§Ø´Ø±!</h3>
                            <p style="margin-bottom: 10px;"><strong>âœ… Ø§Ù„Ø®Ø·ÙˆØ§Øª:</strong></p>
                            <ol style="margin-right: 20px; color: #333;">
                                <li>Ø§Ù†Ø³Ø® Ø¹Ù†ÙˆØ§Ù† Ù…Ø­ÙØ¸ØªÙ†Ø§ Ù…Ù† Ø§Ù„Ø£Ø³ÙÙ„</li>
                                <li>Ø¥Ø¯Ø®Ù„ Ø§Ù„Ù‰ Ø§ÙŠ Ù…Ù†ØµØ© ØªØ¯Ø¹Ù… BNB Smart Chain . BSC</li>
                                <li>Ø§Ù„ØµÙ‚ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ£Ø±Ø³Ù„ Ø§Ù„Ù…Ø¨Ù„Øº</li>
                                <li>Ø§Ù†Ø³Ø® Ù…Ø¹Ø±Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ÙˆØ¶Ø¹Ù‡ ÙÙŠ Ø§Ù„Ø­Ù‚Ù„ Ø£Ø³ÙÙ„Ù‡</li>
                                <li>Ø§Ø¶ØºØ· ØªØ­Ù‚Ù‚ - Ø³ÙŠØªÙ… Ø´Ø­Ù†Ùƒ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹!</li>
                            </ol>
                        </div>
                        <div style="background: #fff3cd; border: 2px dashed #ffc107; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
                            <h3 style="color: #ff6f00; margin-bottom: 15px;">ğŸ“ Ø¹Ù†ÙˆØ§Ù† Ù…Ø­ÙØ¸ØªÙ†Ø§ BNB:</h3>
                            <div style="background: white; padding: 15px; border-radius: 6px; word-break: break-all; font-family: monospace; font-size: 14px; user-select: all;">
                                0xa3a6afdf80d1966fc83acf8b06a1bbab2c6634c0
                            </div>
                            <button id="copyBtn" onclick="copyToClipboard('0xa3a6afdf80d1966fc83acf8b06a1bbab2c6634c0')" style="margin-top: 10px; padding: 10px 20px; background: #ffc107; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">ğŸ“‹ Ø§Ù†Ø³Ø® Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</button>
                        </div>
                        
                        <div style="background: #f0f8ff; border-left: 4px solid #2196f3; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
                            <h3 style="color: #2196f3; margin-bottom: 15px;">ğŸ” Ø£Ø¯Ø®Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ©:</h3>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <input type="text" id="txHash" placeholder="Ø£Ø¯Ø®Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ©" style="flex: 1; min-width: 250px; padding: 12px; border: 2px solid #2196f3; border-radius: 6px; font-size: 14px;">
                                <button onclick="verifyTransaction()" style="padding: 12px 30px; background: #2196f3; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">âœ… ØªØ­Ù‚Ù‚</button>
                            </div>
                            <div id="verifyMessage" style="margin-top: 15px; padding: 15px; border-radius: 6px; display: none;"></div>
                        </div>
                        
                        <h2 style="margin-top: 40px; color: #00bcd4;">ğŸ“Š Ø³Ø¬Ù„Ø§Øª Ø´Ø­Ù† BNB Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</h2>
                        <div style="background: #f0f8ff; padding: 20px; border-radius: 8px; margin-bottom: 30px; overflow-x: auto;">
                            {% if bnb_transactions %}
                            <table style="width: 100%; border-collapse: collapse;">
                                <tr style="background: #e0f2f7; border-bottom: 2px solid #2196f3;">
                                    <th style="padding: 12px; text-align: right;">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                    <th style="padding: 12px; text-align: right;">Ù…Ø¹Ø±Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th>
                                    <th style="padding: 12px; text-align: right;">Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                    <th style="padding: 12px; text-align: right;">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                </tr>
                                {% for tx in bnb_transactions %}
                                <tr style="border-bottom: 1px solid #e0e0e0;">
                                    <td style="padding: 12px;">{{ tx['created_at'][:10] }}</td>
                                    <td style="padding: 12px; font-family: monospace; font-size: 12px; direction: ltr; text-align: left;">{{ tx['tx_hash'][:16] }}...</td>
                                    <td style="padding: 12px;">{{ "%.6f"|format(tx['amount']) }} BNB</td>
                                    <td style="padding: 12px; white-space: nowrap;">
                                        {% if tx['status'] == 'confirmed' %}
                                        <span style="background: #4caf50; color: white; padding: 5px 10px; border-radius: 4px; font-size: 12px; white-space: nowrap;">âœ… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚</span>
                                        {% else %}
                                        <span style="background: #ff9800; color: white; padding: 5px 10px; border-radius: 4px; font-size: 12px; white-space: nowrap;">â³ Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ù‚Ù‚</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </table>
                            {% else %}
                            <p style="text-align: center; color: #666; padding: 40px; font-size: 16px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª BNB Ø³Ø§Ø¨Ù‚Ø© ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ</p>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Ù‚Ø³Ù… Ø§Ù„Ø´Ø­Ù† Ø§Ù„ÙŠØ¯ÙˆÙŠ -->
                    <div id="manual-method" style="display: none;">
                        <div class="upload-section">
                            <h2 style="color: #667eea; margin-bottom: 20px;">ğŸ“¤ Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹</h2>
                            
                            <div style="background: linear-gradient(135deg, #e8f4fd 0%, #f0e6ff 100%); border: 2px solid #667eea; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                                <h3 style="color: #667eea; margin-bottom: 15px; font-size: 18px;">ğŸ“‹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹:</h3>
                                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                                    <p style="font-size: 16px; margin: 8px 0; color: #333;">ğŸ’³ <strong>Ø¨Ø§ÙŠÙŠØ±:</strong> <span style="color: #667eea; font-weight: bold; font-size: 18px;">P1069518585</span></p>
                                    <p style="font-size: 16px; margin: 8px 0; color: #333;">ğŸ’ <strong>Ø¨Ø§ÙŠÙ†Ø§Ù†Ø³:</strong> <span style="color: #f0b90b; font-weight: bold; font-size: 18px;">474900045</span></p>
                                </div>
                                <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 12px; margin-top: 10px;">
                                    <p style="color: #856404; margin: 0; font-size: 14px;">âš ï¸ <strong>Ø¨Ø¹Ø¯ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº ÙˆÙŠØ´ØªØ±Ø· Ø£Ù† ÙŠÙƒÙˆÙ† Ø£ÙƒØ«Ø± Ù…Ù† 0.30 Ø¯ÙˆÙ„Ø§Ø±</strong></p>
                                    <p style="color: #856404; margin: 5px 0 0 0; font-size: 14px;">Ø¨Ø¹Ø¯Ù‡Ø§ Ù…Ø¨Ø§Ø´Ø±Ø© Ù‚Ù… Ø¨Ø¥Ø±Ø³Ø§Ù„ ØµÙˆØ±Ø© Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹</p>
                                </div>
                            </div>
                            
                            <p style="color: #666; margin-bottom: 15px;">Ù‚Ù… Ø¨ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø© ÙˆØ§Ø¶Ø­Ø© Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹</p>
                            <form id="depositForm" enctype="multipart/form-data">
                                <input type="file" id="depositPhoto" name="photo" accept="image/*" required>
                                <button id="depositBtn" type="button" class="btn" onclick="submitDepositForm()">Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø´Ø­Ù†</button>
                            </form>
                            <div id="depositMessage" style="margin-top: 15px; padding: 15px; border-radius: 6px; display: none;"></div>
                        </div>
                        
                        <h2 style="margin-top: 40px; color: #667eea;">ğŸ“‹ Ø³Ø¬Ù„Ø§Øª Ø´Ø­Ù† Ø§Ù„ØµÙˆØ± Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</h2>
                        <div id="deposit-history-container" style="background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 30px; overflow-x: auto;">
                            {% if deposits %}
                            <table style="width: 100%; border-collapse: collapse;">
                                <tr style="background: #f0e6ff; border-bottom: 2px solid #667eea;">
                                    <th style="padding: 12px; text-align: right;">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                    <th style="padding: 12px; text-align: right;">Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                    <th style="padding: 12px; text-align: right;">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                </tr>
                                {% for deposit in deposits %}
                                <tr style="border-bottom: 1px solid #e0e0e0;" data-deposit-id="{{ deposit['id'] }}">
                                    <td style="padding: 12px;">{{ deposit['created_at'][:10] }}</td>
                                    <td style="padding: 12px;" class="deposit-amount">{{ "%.2f"|format(deposit['amount']) if deposit['amount'] else 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©' }} $</td>
                                    <td style="padding: 12px; white-space: nowrap;" class="deposit-status">
                                        {% if deposit['status'] == 'pending' %}
                                        <span style="background: #ff9800; color: white; padding: 5px 10px; border-radius: 4px; font-size: 12px; white-space: nowrap;">â³ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</span>
                                        {% elif deposit['status'] == 'approved' %}
                                        <span style="background: #4caf50; color: white; padding: 5px 10px; border-radius: 4px; font-size: 12px; white-space: nowrap;">âœ… Ù…Ù‚Ø¨ÙˆÙ„</span>
                                        {% else %}
                                        <span style="background: #f44336; color: white; padding: 5px 10px; border-radius: 4px; font-size: 12px; white-space: nowrap;">âŒ Ù…Ø±ÙÙˆØ¶</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </table>
                            {% else %}
                            <p style="text-align: center; color: #666; padding: 40px; font-size: 16px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø´Ø­Ù† Ø¨ØµÙˆØ± Ø³Ø§Ø¨Ù‚Ø©</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Withdraw Tab -->
                <div id="withdraw-tab" style="display: none;">
                    <h1>ğŸ’° Ø³Ø­Ø¨ Ø§Ù„Ø±ØµÙŠØ¯</h1>
                    <div class="note" style="margin-bottom: 25px;">
                        Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø³Ø­Ø¨: 1.00 $
                    </div>
                    
                    {% if has_pending_withdrawal %}
                    <div style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 25px; text-align: center;">
                        <div style="font-size: 40px; margin-bottom: 10px;">â³</div>
                        <h3 style="margin: 0 0 10px 0;">Ù„Ø¯ÙŠÙƒ Ø·Ù„Ø¨ Ø³Ø­Ø¨ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</h3>
                        <p style="margin: 0; opacity: 0.9;">Ø§Ù„Ù…Ø¨Ù„Øº: {{ "%.2f"|format(pending_withdrawal['amount']) }} $</p>
                        <p style="margin: 5px 0 0 0; font-size: 13px; opacity: 0.8;">ÙŠØ±Ø¬Ù‰ Ø§Ù†ØªØ¸Ø§Ø± Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</p>
                    </div>
                    {% else %}
                    <form method="POST" action="{{ url_for('submit_withdrawal') }}" id="withdrawal-form">
                        <div class="form-group">
                            <label>Ø§Ù„Ù…Ø¨Ù„Øº ($)</label>
                            <input type="number" name="amount" step="0.01" min="1" required>
                        </div>
                        <div class="form-group">
                            <label>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø³Ø­Ø¨</label>
                            <select name="method" required>
                                <option value="payeer">Payeer</option>
                                <option value="binance">Binance</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨</label>
                            <input type="text" name="account_info" required placeholder="Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ Ø£Ùˆ Ø§Ù„Ù…Ø­ÙØ¸Ø©">
                        </div>
                        <button type="submit" class="btn" id="withdraw-btn">Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨</button>
                    </form>
                    {% endif %}
                    
                    <h2 style="margin-top: 40px; color: #667eea;">ğŸ“‹ Ø³Ø¬Ù„Ø§Øª Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</h2>
                    <div id="withdrawals-container" style="background: #f0f8f8; padding: 20px; border-radius: 8px; margin-bottom: 30px; overflow-x: auto;">
                        {% if withdrawals %}
                        <table id="withdrawals-table" style="width: 100%; border-collapse: collapse;">
                            <thead>
                            <tr style="background: #d4edee; border-bottom: 2px solid #009688;">
                                <th style="padding: 12px; text-align: right;">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                <th style="padding: 12px; text-align: right;">Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                <th style="padding: 12px; text-align: right;">Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©</th>
                                <th style="padding: 12px; text-align: right;">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            </tr>
                            </thead>
                            <tbody id="withdrawals-tbody">
                            {% for withdrawal in withdrawals %}
                            <tr style="border-bottom: 1px solid #e0e0e0;" data-withdrawal-id="{{ withdrawal['id'] }}">
                                <td style="padding: 12px;">{{ withdrawal['created_at'][:10] }}</td>
                                <td style="padding: 12px;">{{ "%.2f"|format(withdrawal['amount']) }} $</td>
                                <td style="padding: 12px;">{{ withdrawal['method'] }}</td>
                                <td style="padding: 12px; white-space: nowrap;" class="withdrawal-status">
                                    {% if withdrawal['status'] == 'pending' %}
                                    <span style="background: #ff9800; color: white; padding: 5px 10px; border-radius: 4px; font-size: 12px; white-space: nowrap;">â³ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</span>
                                    {% elif withdrawal['status'] == 'approved' %}
                                    <span style="background: #4caf50; color: white; padding: 5px 10px; border-radius: 4px; font-size: 12px; white-space: nowrap;">âœ… Ù…ÙƒØªÙ…Ù„</span>
                                    {% else %}
                                    <span style="background: #f44336; color: white; padding: 5px 10px; border-radius: 4px; font-size: 12px; white-space: nowrap;">âŒ Ù…Ø±ÙÙˆØ¶</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                        {% else %}
                        <p id="no-withdrawals-msg" style="text-align: center; color: #666; padding: 40px; font-size: 16px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø³Ø­Ø¨ Ø³Ø§Ø¨Ù‚Ø©</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <script>
            let recordsRefreshInterval;
            
            function switchTab(tabName) {
                document.getElementById('deposit-tab').style.display = 'none';
                document.getElementById('withdraw-tab').style.display = 'none';
                document.getElementById(tabName).style.display = 'block';
                
                const btns = document.querySelectorAll('.deposit-withdraw-btn');
                btns.forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');
                
                if (tabName === 'deposit-tab' || tabName === 'withdraw-tab') {
                    refreshRecords();
                    if (recordsRefreshInterval) clearInterval(recordsRefreshInterval);
                    recordsRefreshInterval = setInterval(refreshRecords, 5000);
                }
            }
            
            // Ù…Ø¹Ø§Ù„Ø¬Ø© Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø³Ø­Ø¨ Ø¨Ù€ AJAX
            document.addEventListener('DOMContentLoaded', function() {
                const withdrawalForm = document.getElementById('withdrawal-form');
                if (withdrawalForm) {
                    withdrawalForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                        
                        const submitBtn = document.getElementById('withdraw-btn');
                        const formData = new FormData(withdrawalForm);
                        const amount = formData.get('amount');
                        const method = formData.get('method');
                        
                        submitBtn.disabled = true;
                        submitBtn.textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';
                        
                        fetch('{{ url_for("submit_withdrawal") }}', {
                            method: 'POST',
                            body: formData,
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest'
                            }
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø¬Ø¯ÙˆÙ„ ÙÙˆØ±Ø§Ù‹
                                addWithdrawalToTable(data.withdrawal_id, amount, method);
                                
                                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯
                                if (data.new_balance !== undefined) {
                                    const balanceDisplay = document.querySelector('.balance-display');
                                    if (balanceDisplay) {
                                        balanceDisplay.textContent = data.new_balance.toFixed(2) + ' $';
                                        balanceDisplay.style.color = '#ff9800';
                                        setTimeout(() => { balanceDisplay.style.color = ''; }, 2000);
                                    }
                                }
                                
                                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
                                withdrawalForm.reset();
                                
                                // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
                                showWithdrawalMessage(data.message, 'success');
                            } else {
                                showWithdrawalMessage(data.message, 'error');
                            }
                            
                            submitBtn.disabled = false;
                            submitBtn.textContent = 'Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨';
                        })
                        .catch(error => {
                            console.error('Ø®Ø·Ø£:', error);
                            showWithdrawalMessage('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰', 'error');
                            submitBtn.disabled = false;
                            submitBtn.textContent = 'Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨';
                        });
                    });
                }
            });
            
            function addWithdrawalToTable(withdrawalId, amount, method) {
                const container = document.getElementById('withdrawals-container');
                const noWithdrawalsMsg = document.getElementById('no-withdrawals-msg');
                let table = document.getElementById('withdrawals-table');
                let tbody = document.getElementById('withdrawals-tbody');
                
                // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø¬Ø¯ÙˆÙ„ØŒ Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ§Ø­Ø¯ Ø¬Ø¯ÙŠØ¯
                if (!table) {
                    if (noWithdrawalsMsg) {
                        noWithdrawalsMsg.remove();
                    }
                    container.innerHTML = `
                        <table id="withdrawals-table" style="width: 100%; border-collapse: collapse;">
                            <thead>
                            <tr style="background: #d4edee; border-bottom: 2px solid #009688;">
                                <th style="padding: 12px; text-align: right;">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                <th style="padding: 12px; text-align: right;">Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                <th style="padding: 12px; text-align: right;">Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©</th>
                                <th style="padding: 12px; text-align: right;">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            </tr>
                            </thead>
                            <tbody id="withdrawals-tbody">
                            </tbody>
                        </table>
                    `;
                    tbody = document.getElementById('withdrawals-tbody');
                }
                
                // Ø¥Ù†Ø´Ø§Ø¡ ØµÙ Ø¬Ø¯ÙŠØ¯
                const today = new Date().toISOString().split('T')[0];
                const newRow = document.createElement('tr');
                newRow.style.borderBottom = '1px solid #e0e0e0';
                newRow.setAttribute('data-withdrawal-id', withdrawalId);
                newRow.style.animation = 'fadeIn 0.5s ease-in';
                newRow.innerHTML = `
                    <td style="padding: 12px;">${today}</td>
                    <td style="padding: 12px;">${parseFloat(amount).toFixed(2)} $</td>
                    <td style="padding: 12px;">${method}</td>
                    <td style="padding: 12px; white-space: nowrap;" class="withdrawal-status">
                        <span style="background: #ff9800; color: white; padding: 5px 10px; border-radius: 4px; font-size: 12px; white-space: nowrap;">â³ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</span>
                    </td>
                `;
                
                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙ ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
                tbody.insertBefore(newRow, tbody.firstChild);
            }
            
            function showWithdrawalMessage(message, type) {
                // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ø±Ø³Ø§Ù„Ø© Ø³Ø§Ø¨Ù‚Ø©
                const oldMsg = document.getElementById('withdrawal-message');
                if (oldMsg) oldMsg.remove();
                
                const msgDiv = document.createElement('div');
                msgDiv.id = 'withdrawal-message';
                msgDiv.style.cssText = `
                    padding: 15px; border-radius: 8px; margin-bottom: 15px; text-align: center; font-weight: 600;
                    ${type === 'success' ? 'background: #d4edda; color: #155724; border: 1px solid #c3e6cb;' : 'background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;'}
                `;
                msgDiv.textContent = message;
                
                const form = document.getElementById('withdrawal-form');
                if (form) {
                    form.parentNode.insertBefore(msgDiv, form);
                } else {
                    const withdrawTab = document.getElementById('withdraw-tab');
                    if (withdrawTab) {
                        withdrawTab.insertBefore(msgDiv, withdrawTab.firstChild.nextSibling);
                    }
                }
                
                // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†Ù
                setTimeout(() => {
                    if (msgDiv) msgDiv.remove();
                }, 5000);
            }
            
            function toggleDepositMethod(methodId) {
                const usdtSection = document.getElementById('usdt-method');
                const manualSection = document.getElementById('manual-method');
                const usdtBtn = document.getElementById('usdt-btn');
                const manualBtn = document.getElementById('manual-btn');
                
                if (methodId === 'usdt-method') {
                    if (usdtSection.style.display === 'none') {
                        usdtSection.style.display = 'block';
                        manualSection.style.display = 'none';
                        usdtBtn.style.opacity = '1';
                        usdtBtn.style.transform = 'scale(1.02)';
                        manualBtn.style.opacity = '0.7';
                        manualBtn.style.transform = 'scale(1)';
                    } else {
                        usdtSection.style.display = 'none';
                        usdtBtn.style.opacity = '1';
                        usdtBtn.style.transform = 'scale(1)';
                    }
                } else if (methodId === 'manual-method') {
                    if (manualSection.style.display === 'none') {
                        manualSection.style.display = 'block';
                        usdtSection.style.display = 'none';
                        manualBtn.style.opacity = '1';
                        manualBtn.style.transform = 'scale(1.02)';
                        usdtBtn.style.opacity = '0.7';
                        usdtBtn.style.transform = 'scale(1)';
                    } else {
                        manualSection.style.display = 'none';
                        manualBtn.style.opacity = '1';
                        manualBtn.style.transform = 'scale(1)';
                    }
                }
            }
            
            function toggleProfileSection(sectionId) {
                const profileInfo = document.getElementById('profile-info');
                const changeUsername = document.getElementById('change-username');
                const profileInfoBtn = document.getElementById('profile-info-btn');
                const changeUsernameBtn = document.getElementById('change-username-btn');
                
                if (sectionId === 'profile-info') {
                    if (profileInfo.style.display === 'none') {
                        profileInfo.style.display = 'block';
                        changeUsername.style.display = 'none';
                        profileInfoBtn.style.opacity = '1';
                        profileInfoBtn.style.transform = 'scale(1.02)';
                        changeUsernameBtn.style.opacity = '0.7';
                        changeUsernameBtn.style.transform = 'scale(1)';
                    } else {
                        profileInfo.style.display = 'none';
                        profileInfoBtn.style.opacity = '1';
                        profileInfoBtn.style.transform = 'scale(1)';
                    }
                } else if (sectionId === 'change-username') {
                    if (changeUsername.style.display === 'none') {
                        changeUsername.style.display = 'block';
                        profileInfo.style.display = 'none';
                        changeUsernameBtn.style.opacity = '1';
                        changeUsernameBtn.style.transform = 'scale(1.02)';
                        profileInfoBtn.style.opacity = '0.7';
                        profileInfoBtn.style.transform = 'scale(1)';
                    } else {
                        changeUsername.style.display = 'none';
                        changeUsernameBtn.style.opacity = '1';
                        changeUsernameBtn.style.transform = 'scale(1)';
                    }
                }
            }
            
            function changeUsernameAjax(event) {
                event.preventDefault();
                
                const newUsername = document.getElementById('new-username-input').value.trim();
                const messageDiv = document.getElementById('username-change-message');
                const submitBtn = document.getElementById('change-username-submit-btn');
                
                if (newUsername.length < 3 || newUsername.length > 15) {
                    messageDiv.style.display = 'block';
                    messageDiv.style.background = '#f8d7da';
                    messageDiv.style.color = '#721c24';
                    messageDiv.style.border = '1px solid #f5c6cb';
                    messageDiv.textContent = 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨ÙŠÙ† 3 Ùˆ 15 Ø­Ø±Ù';
                    return false;
                }
                
                submitBtn.disabled = true;
                submitBtn.textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
                
                fetch('/api/change-username', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ new_username: newUsername })
                })
                .then(response => response.json())
                .then(data => {
                    messageDiv.style.display = 'block';
                    
                    if (data.success) {
                        messageDiv.style.background = '#d4edda';
                        messageDiv.style.color = '#155724';
                        messageDiv.style.border = '1px solid #c3e6cb';
                        messageDiv.textContent = 'âœ… ' + data.message;
                        
                        document.getElementById('new-username-input').value = '';
                        
                        const usernameDisplays = document.querySelectorAll('.username-display, [class*="username"]');
                        usernameDisplays.forEach(el => {
                            if (el.textContent.includes('ğŸ‘¤')) {
                                el.innerHTML = 'ğŸ‘¤ ' + data.new_username;
                            }
                        });
                        
                        const profileUsername = document.querySelector('#profile-info strong');
                        if (profileUsername && profileUsername.textContent.includes('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…')) {
                            profileUsername.parentElement.innerHTML = '<strong>ğŸ‘¤ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</strong> <span style="color: #667eea; font-weight: bold;">' + data.new_username + '</span>';
                        }
                    } else {
                        messageDiv.style.background = '#f8d7da';
                        messageDiv.style.color = '#721c24';
                        messageDiv.style.border = '1px solid #f5c6cb';
                        messageDiv.textContent = 'âŒ ' + data.message;
                    }
                    
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯';
                })
                .catch(error => {
                    messageDiv.style.display = 'block';
                    messageDiv.style.background = '#f8d7da';
                    messageDiv.style.color = '#721c24';
                    messageDiv.style.border = '1px solid #f5c6cb';
                    messageDiv.textContent = 'âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰';
                    
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯';
                });
                
                return false;
            }
            
            function refreshRecords() {
                fetch('/games')
                    .then(res => res.text())
                    .then(html => {
                        const parser = new DOMParser();
                        const newDoc = parser.parseFromString(html, 'text/html');
                        
                        // ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø´Ø­Ù†
                        const newDepositTable = newDoc.querySelector('#page-deposit table');
                        const currentDepositTable = document.querySelector('#page-deposit table');
                        
                        if (newDepositTable && currentDepositTable) {
                            const newRows = Array.from(newDepositTable.querySelectorAll('tbody tr, tr:not(:first-child)'));
                            const currentRows = Array.from(currentDepositTable.querySelectorAll('tbody tr, tr:not(:first-child)'));
                            
                            // ØªØ­Ø¯ÙŠØ« ÙƒÙ„ ØµÙ
                            newRows.forEach((newRow, idx) => {
                                if (currentRows[idx]) {
                                    const newStatus = newRow.querySelector('td:last-child')?.innerHTML;
                                    const currentStatus = currentRows[idx].querySelector('td:last-child');
                                    if (newStatus && currentStatus && currentStatus.innerHTML !== newStatus) {
                                        currentStatus.innerHTML = newStatus;
                                    }
                                }
                            });
                        }
                        
                        // ØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø³Ø­Ø¨ Ø£ÙŠØ¶Ø§Ù‹
                        const newWithdrawTable = newDoc.querySelector('#page-withdraw table');
                        const currentWithdrawTable = document.querySelector('#page-withdraw table');
                        
                        if (newWithdrawTable && currentWithdrawTable) {
                            const newRows = Array.from(newWithdrawTable.querySelectorAll('tbody tr, tr:not(:first-child)'));
                            const currentRows = Array.from(currentWithdrawTable.querySelectorAll('tbody tr, tr:not(:first-child)'));
                            
                            newRows.forEach((newRow, idx) => {
                                if (currentRows[idx]) {
                                    const newStatus = newRow.querySelector('td:last-child')?.innerHTML;
                                    const currentStatus = currentRows[idx].querySelector('td:last-child');
                                    if (newStatus && currentStatus && currentStatus.innerHTML !== newStatus) {
                                        currentStatus.innerHTML = newStatus;
                                    }
                                }
                            });
                        }
                    })
                    .catch(err => console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„Ø§Øª:', err));
            }
            
            function loadNotifications() {
                const container = document.getElementById('notifications-container');
                fetch('/notifications')
                    .then(res => res.text())
                    .then(html => {
                        const parser = new DOMParser();
                        const newDoc = parser.parseFromString(html, 'text/html');
                        
                        const notifContent = newDoc.querySelector('#page-notif-tab-content');
                        if (notifContent) {
                            container.innerHTML = notifContent.innerHTML || `<div style="text-align: center; color: #666; padding: 40px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</div>`;
                        } else {
                            container.innerHTML = `<div style="text-align: center; color: #666; padding: 40px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</div>`;
                        }
                    })
                    .catch(err => {
                        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª:', err);
                        container.innerHTML = `<div style="text-align: center; color: #f44336; padding: 40px;">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</div>`;
                    });
            }
            
            let notificationsRefreshInterval;
            
            function startNotificationsRefresh() {
                loadNotifications();
                if (notificationsRefreshInterval) clearInterval(notificationsRefreshInterval);
                notificationsRefreshInterval = setInterval(loadNotifications, 5000);
            }
            
            function showPage(pageId) {
                document.querySelectorAll('.page-section').forEach(el => el.style.display = 'none');
                const page = document.getElementById('page-' + pageId);
                if (page) {
                    page.style.display = 'block';
                    if (pageId === 'notifications') {
                        startNotificationsRefresh();
                    } else {
                        if (notificationsRefreshInterval) clearInterval(notificationsRefreshInterval);
                    }
                    if (pageId === 'live') {
                        if (typeof loadActiveStreams === 'function') {
                            loadActiveStreams();
                        }
                    }
                }
            }
            
            </script>
            <div id="page-notifications" class="page-section" style="display: none;">
                <style>
                    .notifications-tabs {
                        display: flex;
                        gap: 8px;
                        margin-top: 50px;
                        margin-bottom: 25px;
                        flex-wrap: nowrap;
                        justify-content: center;
                        white-space: nowrap;
                    }
                    .notifications-tab-btn {
                        padding: 10px 16px;
                        background: linear-gradient(135deg, #e0e0e0 0%, #c0c0c0 100%);
                        color: #555;
                        border: none;
                        border-radius: 25px;
                        font-size: 14px;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                        flex-shrink: 0;
                    }
                    .notifications-tab-btn:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                    }
                    .notifications-tab-btn.active {
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
                    }
                    .notifications-tab-content {
                        display: none;
                        animation: fadeInTab 0.3s ease;
                    }
                    .notifications-tab-content.active {
                        display: block;
                    }
                    @keyframes fadeInTab {
                        from { opacity: 0; transform: translateY(10px); }
                        to { opacity: 1; transform: translateY(0); }
                    }
                    .messages-container, .support-container {
                        max-width: 800px;
                        text-align: center;
                        padding: 60px 40px;
                    }
                    .coming-soon-icon {
                        font-size: 64px;
                        margin-bottom: 20px;
                    }
                    .coming-soon-text {
                        color: #666;
                        font-size: 18px;
                        margin-bottom: 10px;
                    }
                    .coming-soon-subtext {
                        color: #999;
                        font-size: 14px;
                    }
                </style>
                
                <div class="notifications-tabs" id="spa-notifications-tabs">
                    <button class="notifications-tab-btn active" onclick="showSpaNotificationsTab('spa-notifications', this)">ğŸ”” Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</button>
                    <button class="notifications-tab-btn" onclick="showSpaNotificationsTab('spa-messages', this)" style="position: relative;">ğŸ’¬ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„<span id="messages-badge" style="position: absolute; top: -8px; right: -8px; background: #dc3545; color: white; border-radius: 50%; min-width: 20px; height: 20px; font-size: 11px; font-weight: bold; display: none; align-items: center; justify-content: center; padding: 0 4px;">0</span></button>
                    <button class="notifications-tab-btn" onclick="showSpaNotificationsTab('spa-support', this)">ğŸ§ Ø§Ù„Ø¯Ø¹Ù…</button>
                </div>
                
                <div id="spa-notifications-tab-content" class="notifications-tab-content active">
                    <div id="notifications-container" style="max-width: 800px;">
                        <p style="text-align: center; color: #666; padding: 60px 40px; font-size: 18px;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª...</p>
                    </div>
                </div>
                
                <div id="spa-messages-tab-content" class="notifications-tab-content">
                    <div id="messages-container" style="max-width: 800px;">
                        <p style="text-align: center; color: #666; padding: 60px 40px; font-size: 18px;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„...</p>
                    </div>
                </div>
                
                <div id="spa-support-tab-content" class="notifications-tab-content">
                    <div class="support-container" style="max-width: 800px; margin: 0 auto;">
                        <h3 style="text-align: center; color: #333; margin-bottom: 20px;">ğŸ§ Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©</h3>
                        
                        <div class="support-category-tabs" style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-bottom: 20px;">
                            <button class="support-cat-btn" onclick="showSupportCategory('spa-withdrawal', this)" style="padding: 12px 20px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; border-radius: 25px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">ğŸ’¸ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø³Ø­Ø¨</button>
                            <button class="support-cat-btn" onclick="showSupportCategory('spa-deposit', this)" style="padding: 12px 20px; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white; border: none; border-radius: 25px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">ğŸ’³ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø´Ø­Ù†</button>
                            <button class="support-cat-btn" onclick="showSupportCategory('spa-cheat', this)" style="padding: 12px 20px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none; border-radius: 25px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">ğŸš« Ø´ÙƒÙˆÙ‰ Ø¶Ø¯ Ø§Ù„ØºØ´</button>
                            <button class="support-cat-btn" onclick="showSupportCategory('spa-other', this)" style="padding: 12px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 25px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">ğŸ“ Ø´ÙŠØ¡ Ø¢Ø®Ø±</button>
                        </div>
                        
                        <div id="spa-withdrawal-form" class="support-form-section" style="display: none;">
                            <div style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); border: 2px solid #ef4444; border-radius: 15px; padding: 20px;">
                                <h4 style="color: #dc2626; margin-bottom: 15px;">ğŸ’¸ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø³Ø­Ø¨</h4>
                                <textarea id="spa-withdrawal-message" placeholder="Ø§ÙƒØªØ¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ù‡Ù†Ø§..." style="width: 100%; height: 120px; padding: 12px; border: 1px solid #fca5a5; border-radius: 10px; font-size: 14px; resize: vertical;"></textarea>
                                <button onclick="submitSupportTicket('withdrawal', 'spa-withdrawal-message')" style="margin-top: 15px; width: 100%; padding: 14px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer;">ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„</button>
                            </div>
                        </div>
                        
                        <div id="spa-deposit-form" class="support-form-section" style="display: none;">
                            <div style="background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); border: 2px solid #22c55e; border-radius: 15px; padding: 20px;">
                                <h4 style="color: #16a34a; margin-bottom: 15px;">ğŸ’³ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø´Ø­Ù†</h4>
                                <textarea id="spa-deposit-message" placeholder="Ø§ÙƒØªØ¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ù‡Ù†Ø§..." style="width: 100%; height: 120px; padding: 12px; border: 1px solid #86efac; border-radius: 10px; font-size: 14px; resize: vertical;"></textarea>
                                <button onclick="submitSupportTicket('deposit', 'spa-deposit-message')" style="margin-top: 15px; width: 100%; padding: 14px; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer;">ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„</button>
                            </div>
                        </div>
                        
                        <div id="spa-cheat-form" class="support-form-section" style="display: none;">
                            <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #f59e0b; border-radius: 15px; padding: 20px;">
                                <h4 style="color: #d97706; margin-bottom: 15px;">ğŸš« Ø´ÙƒÙˆÙ‰ Ø¶Ø¯ Ø§Ù„ØºØ´</h4>
                                <textarea id="spa-cheat-message" placeholder="Ø§ÙƒØªØ¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø´ÙƒÙˆÙ‰ ÙˆØ§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ù…Ø´ÙƒÙˆÙƒ Ø¨Ù‡..." style="width: 100%; height: 120px; padding: 12px; border: 1px solid #fcd34d; border-radius: 10px; font-size: 14px; resize: vertical;"></textarea>
                                <button onclick="submitSupportTicket('cheat', 'spa-cheat-message')" style="margin-top: 15px; width: 100%; padding: 14px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer;">ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„</button>
                            </div>
                        </div>
                        
                        <div id="spa-other-form" class="support-form-section" style="display: none;">
                            <div style="background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); border: 2px solid #667eea; border-radius: 15px; padding: 20px;">
                                <h4 style="color: #764ba2; margin-bottom: 15px;">ğŸ“ Ø´ÙŠØ¡ Ø¢Ø®Ø±</h4>
                                <textarea id="spa-other-message" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..." style="width: 100%; height: 120px; padding: 12px; border: 1px solid #a5b4fc; border-radius: 10px; font-size: 14px; resize: vertical;"></textarea>
                                <button onclick="submitSupportTicket('other', 'spa-other-message')" style="margin-top: 15px; width: 100%; padding: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer;">ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <script>
                    function showSpaNotificationsTab(tabName, btn) {
                        var container = document.getElementById('spa-notifications-tabs').parentElement;
                        container.querySelectorAll('.notifications-tab-content').forEach(el => el.classList.remove('active'));
                        container.querySelectorAll('.notifications-tab-btn').forEach(el => el.classList.remove('active'));
                        
                        document.getElementById(tabName + '-tab-content').classList.add('active');
                        btn.classList.add('active');
                        
                        if (tabName === 'spa-messages') {
                            loadAdminMessages();
                        }
                    }
                    
                    function loadAdminMessages() {
                        fetch('/api/admin-messages')
                            .then(response => response.json())
                            .then(data => {
                                var container = document.getElementById('messages-container');
                                if (data.messages && data.messages.length > 0) {
                                    var html = '';
                                    data.messages.forEach(msg => {
                                        var readClass = msg.is_read ? 'read' : 'unread';
                                        html += '<div class="message-item ' + readClass + '" style="background: ' + (msg.is_read ? '#f8f9fa' : 'linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%)') + '; border: 2px solid ' + (msg.is_read ? '#e0e0e0' : '#4caf50') + '; border-radius: 15px; padding: 15px; margin-bottom: 15px; cursor: pointer;" onclick="markMessageRead(' + msg.id + ', this)">';
                                        html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">';
                                        html += '<span style="font-weight: bold; color: #333;">ğŸ“© Ø±Ø¯ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</span>';
                                        html += '<span style="font-size: 12px; color: #666;">' + msg.date + '</span>';
                                        html += '</div>';
                                        html += '<p style="color: #444; line-height: 1.6; margin: 0; white-space: pre-wrap;">' + msg.message + '</p>';
                                        if (!msg.is_read) {
                                            html += '<span style="display: inline-block; margin-top: 10px; background: #4caf50; color: white; padding: 3px 10px; border-radius: 10px; font-size: 11px;">Ø¬Ø¯ÙŠØ¯</span>';
                                        }
                                        html += '</div>';
                                    });
                                    container.innerHTML = html;
                                } else {
                                    container.innerHTML = '<div style="text-align: center; padding: 60px 40px;"><div style="font-size: 64px; margin-bottom: 20px;">ğŸ“­</div><p style="color: #666; font-size: 18px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø­Ø§Ù„ÙŠØ§Ù‹</p><p style="color: #999; font-size: 14px;">Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ Ø±Ø¯ÙˆØ¯ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø¹Ù„Ù‰ Ø´ÙƒØ§ÙˆØ§Ùƒ</p></div>';
                                }
                            })
                            .catch(error => {
                                console.error('Error loading messages:', error);
                            });
                    }
                    
                    function markMessageRead(msgId, element) {
                        fetch('/api/mark-message-read', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({message_id: msgId})
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                element.style.background = '#f8f9fa';
                                element.style.border = '2px solid #e0e0e0';
                                var newBadge = element.querySelector('span[style*="background: #4caf50"]');
                                if (newBadge) newBadge.remove();
                                updateMessagesBadge();
                            }
                        });
                    }
                    
                    function updateMessagesBadge() {
                        fetch('/api/unread-messages-count')
                            .then(response => response.json())
                            .then(data => {
                                var badge = document.getElementById('messages-badge');
                                if (badge) {
                                    if (data.count > 0) {
                                        badge.style.display = 'flex';
                                        badge.textContent = data.count > 9 ? '+9' : data.count;
                                    } else {
                                        badge.style.display = 'none';
                                    }
                                }
                            });
                    }
                    
                    updateMessagesBadge();
                    setInterval(updateMessagesBadge, 10000);
                    
                    function showSupportCategory(category, btn) {
                        document.querySelectorAll('#spa-support-tab-content .support-form-section').forEach(el => {
                            el.style.display = 'none';
                        });
                        document.querySelectorAll('#spa-support-tab-content .support-cat-btn').forEach(el => {
                            el.style.opacity = '0.6';
                            el.style.transform = 'scale(0.95)';
                        });
                        
                        document.getElementById(category + '-form').style.display = 'block';
                        btn.style.opacity = '1';
                        btn.style.transform = 'scale(1.05)';
                    }
                    
                    function submitSupportTicket(category, textareaId) {
                        var message = document.getElementById(textareaId).value.trim();
                        if (!message) {
                            alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø±Ø³Ø§Ù„ØªÙƒ Ø£ÙˆÙ„Ø§Ù‹');
                            return;
                        }
                        
                        fetch('/api/support/submit', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({category: category, message: message})
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                alert('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­! Ø³ÙŠØªÙ… Ø§Ù„Ø±Ø¯ Ø¹Ù„ÙŠÙƒ Ù‚Ø±ÙŠØ¨Ø§Ù‹');
                                document.getElementById(textareaId).value = '';
                            } else {
                                alert(data.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„');
                            }
                        })
                        .catch(error => {
                            alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
                        });
                    }
                </script>
            </div>
            
            <!-- ØµÙØ­Ø© Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± -->
            <div id="page-live" class="page-section" style="display: none;">
                <style>
                    .live-tabs {
                        display: flex;
                        gap: 10px;
                        margin-top: 50px;
                        margin-bottom: 25px;
                        flex-wrap: nowrap;
                        overflow-x: auto;
                        -webkit-overflow-scrolling: touch;
                        scroll-behavior: smooth;
                        scrollbar-width: none;
                        -ms-overflow-style: none;
                        padding: 10px 15px;
                        touch-action: pan-x;
                    }
                    .live-tabs::-webkit-scrollbar {
                        display: none;
                    }
                    .live-tab-btn {
                        padding: 12px 18px;
                        background: linear-gradient(135deg, #e0e0e0 0%, #c0c0c0 100%);
                        color: #555;
                        border: none;
                        border-radius: 25px;
                        font-size: 13px;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                        flex-shrink: 0;
                        white-space: nowrap;
                    }
                    .live-tab-btn:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                    }
                    .live-tab-btn.active {
                        background: linear-gradient(135deg, #e11d48 0%, #be123c 100%);
                        color: white;
                        box-shadow: 0 4px 15px rgba(225, 29, 72, 0.4);
                    }
                    .live-tab-content {
                        display: none;
                        animation: fadeInLiveTab 0.3s ease;
                    }
                    .live-tab-content.active {
                        display: block;
                    }
                    @keyframes fadeInLiveTab {
                        from { opacity: 0; transform: translateY(10px); }
                        to { opacity: 1; transform: translateY(0); }
                    }
                    .live-stream-container {
                        background: white;
                        border-radius: 15px;
                        padding: 30px;
                        text-align: center;
                        min-height: 60vh;
                    }
                    #viewer-game-view {
                        text-align: center !important;
                        position: fixed !important;
                        top: 0 !important;
                        left: 0 !important;
                        right: 0 !important;
                        bottom: 0 !important;
                        width: 100vw !important;
                        height: 100vh !important;
                        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%) !important;
                        z-index: 9999 !important;
                        overflow-y: auto !important;
                        padding: 15px !important;
                        box-sizing: border-box !important;
                    }
                    .live-earnings-container {
                        background: white;
                        border-radius: 15px;
                        padding: 30px;
                        min-height: 60vh;
                    }
                    .live-activate-container {
                        background: white;
                        border-radius: 15px;
                        padding: 30px;
                        text-align: center;
                        min-height: 60vh;
                    }
                </style>
                
                <div class="live-tabs">
                    <button class="live-tab-btn active" onclick="showLiveTab('stream', this)">ğŸ“º Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</button>
                    <button class="live-tab-btn" onclick="showLiveTab('earnings', this)">ğŸ’° Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</button>
                    <button class="live-tab-btn" onclick="showLiveTab('activate', this)">âš¡ ØªÙØ¹ÙŠÙ„ Ù…ÙŠØ²Ø© Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</button>
                </div>
                
                <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± -->
                <div id="live-stream-tab" class="live-tab-content active">
                    <div class="live-stream-container">
                        <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¨Ø«ÙˆØ« Ø§Ù„Ù…ØªØ§Ø­Ø© -->
                        <div id="streams-list-view">
                            <h2 style="color: #e11d48; margin-bottom: 20px;">ğŸ“º Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</h2>
                            <p style="color: #666; margin-bottom: 20px;">Ø´Ø§Ù‡Ø¯ Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ø§Ù„Ù„ÙˆØ¯Ùˆ Ù…Ø¨Ø§Ø´Ø±Ø©</p>
                            <div id="active-streams-list" style="display: flex; flex-direction: column; gap: 15px;"></div>
                            <div id="no-streams-msg" style="display: none; padding: 40px; color: #999; font-size: 18px;">
                                <div style="font-size: 50px; margin-bottom: 20px;">ğŸ“º</div>
                                <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø«ÙˆØ« Ù…Ø¨Ø§Ø´Ø±Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</p>
                                <p style="font-size: 14px; margin-top: 10px;">Ø¹Ù†Ø¯Ù…Ø§ ÙŠØ¨Ø¯Ø£ Ù„Ø§Ø¹Ø¨ Ø¨Ø« Ù…Ø¨Ø§Ø±Ø§ØªÙ‡ØŒ Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§</p>
                            </div>
                        </div>
                        
                        <!-- Ø¹Ø±Ø¶ Ø§Ù„Ù„Ø¹Ø¨Ø© Ù„Ù„Ù…Ø´Ø§Ù‡Ø¯ -->
                        <div id="viewer-game-view" style="display: none;">
                            <!-- Ø¹Ù†Ø§ØµØ± Ø§Ù„ØµÙˆØª Ù„Ù„Ù…Ø´Ø§Ù‡Ø¯ -->
                            <audio id="viewerRemoteAudio1" autoplay playsinline style="display:none;"></audio>
                            <audio id="viewerRemoteAudio2" autoplay playsinline style="display:none;"></audio>
                            
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <button onclick="exitWatching()" style="background: #dc2626; color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-weight: bold;">ğŸ”™ Ø±Ø¬ÙˆØ¹</button>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <button id="viewerAudioToggle" onclick="toggleViewerAudio()" style="background: #22c55e; color: white; border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-weight: bold; display: none;">ğŸ”Š Ø§Ù„ØµÙˆØª</button>
                                    <div id="viewer-count-display" style="background: #e11d48; color: white; padding: 8px 16px; border-radius: 20px; font-weight: bold;">ğŸ‘¤ 0</div>
                                </div>
                            </div>
                            <div id="viewer-players-info" style="display: flex; justify-content: space-between; margin-bottom: 10px; padding: 10px; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border-radius: 10px;">
                                <div style="color: #22c55e; font-weight: bold;">ğŸŸ¢ <span id="viewer-player1-name">Ù„Ø§Ø¹Ø¨ 1</span></div>
                                <div style="color: #ffd700; font-weight: bold;"><span id="viewer-bet-amount">0</span>$</div>
                                <div style="color: #3b82f6; font-weight: bold;"><span id="viewer-player2-name">Ù„Ø§Ø¹Ø¨ 2</span> ğŸ”µ</div>
                            </div>
                            <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ù„ÙˆØ¯Ùˆ Ù„Ù„Ù…Ø´Ø§Ù‡Ø¯ - Ù…Ø·Ø§Ø¨Ù‚Ø© ØªÙ…Ø§Ù…Ø§Ù‹ Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† -->
                            <div id="viewer-ludo-board" class="viewer-game-container">
                                <div class="viewer-player-home green">
                                    <svg class="viewer-turn-timer-ring" data-player="green"><circle cx="50%" cy="50%" r="43%" stroke-dasharray="0 1000" id="viewerTimerRingGreen"></circle></svg>
                                    <div class="viewer-player-circle">
                                        <div class="viewer-token green" data-piece-player="green" data-piece-index="0"></div>
                                        <div class="viewer-token green" data-piece-player="green" data-piece-index="1"></div>
                                        <div class="viewer-token green" data-piece-player="green" data-piece-index="2"></div>
                                        <div class="viewer-token green" data-piece-player="green" data-piece-index="3"></div>
                                    </div>
                                    <div class="viewer-player-progress" id="viewer-green-progress">0%</div>
                                </div>
                                <div class="viewer-player-home red">
                                    <div class="viewer-player-circle">
                                        <div class="viewer-token red" data-piece-player="red" data-piece-index="0"></div>
                                        <div class="viewer-token red" data-piece-player="red" data-piece-index="1"></div>
                                        <div class="viewer-token red" data-piece-player="red" data-piece-index="2"></div>
                                        <div class="viewer-token red" data-piece-player="red" data-piece-index="3"></div>
                                    </div>
                                    <div class="viewer-player-progress">0%</div>
                                </div>
                                <div class="viewer-player-home yellow">
                                    <div class="viewer-player-circle">
                                        <div class="viewer-token yellow" data-piece-player="yellow" data-piece-index="0"></div>
                                        <div class="viewer-token yellow" data-piece-player="yellow" data-piece-index="1"></div>
                                        <div class="viewer-token yellow" data-piece-player="yellow" data-piece-index="2"></div>
                                        <div class="viewer-token yellow" data-piece-player="yellow" data-piece-index="3"></div>
                                    </div>
                                    <div class="viewer-player-progress">0%</div>
                                </div>
                                <div class="viewer-player-home blue">
                                    <svg class="viewer-turn-timer-ring" data-player="blue"><circle cx="50%" cy="50%" r="43%" stroke-dasharray="0 1000" id="viewerTimerRingBlue"></circle></svg>
                                    <div class="viewer-player-circle">
                                        <div class="viewer-token blue" data-piece-player="blue" data-piece-index="0"></div>
                                        <div class="viewer-token blue" data-piece-player="blue" data-piece-index="1"></div>
                                        <div class="viewer-token blue" data-piece-player="blue" data-piece-index="2"></div>
                                        <div class="viewer-token blue" data-piece-player="blue" data-piece-index="3"></div>
                                    </div>
                                    <div class="viewer-player-progress" id="viewer-blue-progress">0%</div>
                                </div>
                                <div class="viewer-path-container top">
                                    <div class="viewer-path-cells">
                                        <div class="viewer-cell"></div><div class="viewer-cell"></div><div class="viewer-cell"></div>
                                        <div class="viewer-cell safe green-path"></div><div class="viewer-cell green-path"></div><div class="viewer-cell safe"></div>
                                        <div class="viewer-cell"></div><div class="viewer-cell green-path"></div><div class="viewer-cell"></div>
                                        <div class="viewer-cell"></div><div class="viewer-cell green-path"></div><div class="viewer-cell"></div>
                                        <div class="viewer-cell"></div><div class="viewer-cell green-path"></div><div class="viewer-cell"></div>
                                        <div class="viewer-cell"></div><div class="viewer-cell green-path"></div><div class="viewer-cell"></div>
                                    </div>
                                </div>
                                <div class="viewer-path-container right">
                                    <div class="viewer-path-cells">
                                        <div class="viewer-cell"></div><div class="viewer-cell"></div><div class="viewer-cell"></div>
                                        <div class="viewer-cell"></div><div class="viewer-cell safe red-path"></div><div class="viewer-cell"></div>
                                        <div class="viewer-cell red-path"></div><div class="viewer-cell red-path"></div><div class="viewer-cell red-path"></div>
                                        <div class="viewer-cell red-path"></div><div class="viewer-cell red-path"></div><div class="viewer-cell"></div>
                                        <div class="viewer-cell"></div><div class="viewer-cell"></div><div class="viewer-cell"></div>
                                        <div class="viewer-cell"></div><div class="viewer-cell safe"></div><div class="viewer-cell"></div>
                                    </div>
                                </div>
                                <div class="viewer-path-container bottom">
                                    <div class="viewer-path-cells">
                                        <div class="viewer-cell"></div><div class="viewer-cell blue-path"></div><div class="viewer-cell"></div>
                                        <div class="viewer-cell"></div><div class="viewer-cell blue-path"></div><div class="viewer-cell"></div>
                                        <div class="viewer-cell"></div><div class="viewer-cell blue-path"></div><div class="viewer-cell"></div>
                                        <div class="viewer-cell"></div><div class="viewer-cell blue-path"></div><div class="viewer-cell"></div>
                                        <div class="viewer-cell safe"></div><div class="viewer-cell blue-path"></div><div class="viewer-cell safe blue-path"></div>
                                        <div class="viewer-cell"></div><div class="viewer-cell"></div><div class="viewer-cell"></div>
                                    </div>
                                </div>
                                <div class="viewer-path-container left">
                                    <div class="viewer-path-cells">
                                        <div class="viewer-cell"></div><div class="viewer-cell safe"></div><div class="viewer-cell"></div>
                                        <div class="viewer-cell"></div><div class="viewer-cell"></div><div class="viewer-cell"></div>
                                        <div class="viewer-cell"></div><div class="viewer-cell yellow-path"></div><div class="viewer-cell yellow-path"></div>
                                        <div class="viewer-cell yellow-path"></div><div class="viewer-cell yellow-path"></div><div class="viewer-cell yellow-path"></div>
                                        <div class="viewer-cell"></div><div class="viewer-cell safe yellow-path"></div><div class="viewer-cell"></div>
                                        <div class="viewer-cell"></div><div class="viewer-cell"></div><div class="viewer-cell"></div>
                                    </div>
                                </div>
                                <div class="viewer-center-area">
                                    <div class="viewer-golden-ring">
                                        <div class="viewer-dice" id="viewerDice">
                                            <div class="viewer-dice-face front dice-1">
                                                <div class="dot"></div><div class="dot"></div><div class="dot"></div>
                                                <div class="dot"></div><div class="dot"></div><div class="dot"></div>
                                                <div class="dot"></div><div class="dot"></div><div class="dot"></div>
                                            </div>
                                            <div class="viewer-dice-face back dice-6">
                                                <div class="dot"></div><div class="dot"></div>
                                                <div class="dot"></div><div class="dot"></div>
                                                <div class="dot"></div><div class="dot"></div>
                                            </div>
                                            <div class="viewer-dice-face right dice-3">
                                                <div class="dot"></div><div class="dot"></div><div class="dot"></div>
                                            </div>
                                            <div class="viewer-dice-face left dice-4">
                                                <div class="dot"></div><div class="dot"></div>
                                                <div class="dot"></div><div class="dot"></div>
                                            </div>
                                            <div class="viewer-dice-face top dice-5">
                                                <div class="dot"></div><div class="dot"></div>
                                                <div class="dot"></div>
                                                <div class="dot"></div><div class="dot"></div>
                                            </div>
                                            <div class="viewer-dice-face bottom dice-2">
                                                <div class="dot"></div><div class="dot"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="viewer-center-triangle-container">
                                        <div class="viewer-center-triangle triangle-red"></div>
                                        <div class="viewer-center-triangle triangle-blue"></div>
                                        <div class="viewer-center-triangle triangle-yellow"></div>
                                        <div class="viewer-center-triangle triangle-green"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ù„Ù„Ù…Ø´Ø§Ù‡Ø¯ -->
                            <div class="viewer-action-bar">
                                <div class="message-input-container">
                                    <input type="text" id="viewer-message-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." maxlength="100">
                                    <span id="message-cooldown-display" class="cooldown-display" style="display:none;">30s</span>
                                    <button class="send-message-btn" onclick="sendViewerMessage()">â¤</button>
                                </div>
                                <button class="gift-btn" onclick="toggleGiftSheet()">ğŸ</button>
                                <button class="bet-btn" onclick="showViewerBetOptions()">Ø±Ù‡Ø§Ù†</button>
                            </div>
                            
                            <!-- Ù…Ù†Ø·Ù‚Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ -->
                            <div id="gift-display-area" class="gift-display-area"></div>
                            
                            <!-- Ù…Ù†Ø·Ù‚Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ -->
                            <div id="stream-message-display-area" class="stream-message-display-area"></div>
                            
                            <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ø§Ù„Ø³ÙÙ„ÙŠØ© -->
                            <div id="gift-bottom-sheet" class="gift-bottom-sheet">
                                <div class="gift-sheet-header">
                                    <span class="gift-sheet-title">ğŸ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§</span>
                                    <button class="gift-sheet-close" onclick="toggleGiftSheet()">âœ•</button>
                                </div>
                                <div class="gift-tabs">
                                    <button class="gift-tab active" onclick="showGiftCategory('all', this)">Ø§Ù„ÙƒÙ„</button>
                                    <button class="gift-tab" onclick="showGiftCategory('cheap', this)">Ø±Ø®ÙŠØµØ©</button>
                                    <button class="gift-tab" onclick="showGiftCategory('medium', this)">Ù…ØªÙˆØ³Ø·Ø©</button>
                                    <button class="gift-tab" onclick="showGiftCategory('expensive', this)">ÙØ§Ø®Ø±Ø©</button>
                                </div>
                                <div class="gift-items-grid" id="gift-items-grid">
                                    <div class="gift-item" data-gift-id="heart" data-price="0.10" data-category="cheap" onclick="selectGiftItem(this, 'heart', 'â¤ï¸', 'Ù‚Ù„Ø¨', 0.10)">
                                        <span class="gift-emoji">â¤ï¸</span>
                                        <span class="gift-name">Ù‚Ù„Ø¨</span>
                                        <span class="gift-price">$0.10</span>
                                        <button class="gift-send-btn" onclick="event.stopPropagation(); sendSelectedGift(this)">Ø¥Ø±Ø³Ø§Ù„</button>
                                    </div>
                                    <div class="gift-item" data-gift-id="rose" data-price="0.25" data-category="cheap" onclick="selectGiftItem(this, 'rose', 'ğŸŒ¹', 'ÙˆØ±Ø¯Ø©', 0.25)">
                                        <span class="gift-emoji">ğŸŒ¹</span>
                                        <span class="gift-name">ÙˆØ±Ø¯Ø©</span>
                                        <span class="gift-price">$0.25</span>
                                        <button class="gift-send-btn" onclick="event.stopPropagation(); sendSelectedGift(this)">Ø¥Ø±Ø³Ø§Ù„</button>
                                    </div>
                                    <div class="gift-item" data-gift-id="diamond" data-price="0.50" data-category="medium" onclick="selectGiftItem(this, 'diamond', 'ğŸ’', 'Ù…Ø§Ø³Ø©', 0.50)">
                                        <span class="gift-emoji">ğŸ’</span>
                                        <span class="gift-name">Ù…Ø§Ø³Ø©</span>
                                        <span class="gift-price">$0.50</span>
                                        <button class="gift-send-btn" onclick="event.stopPropagation(); sendSelectedGift(this)">Ø¥Ø±Ø³Ø§Ù„</button>
                                    </div>
                                    <div class="gift-item" data-gift-id="trophy" data-price="1.00" data-category="medium" onclick="selectGiftItem(this, 'trophy', 'ğŸ†', 'ÙƒØ£Ø³', 1.00)">
                                        <span class="gift-emoji">ğŸ†</span>
                                        <span class="gift-name">ÙƒØ£Ø³</span>
                                        <span class="gift-price">$1.00</span>
                                        <button class="gift-send-btn" onclick="event.stopPropagation(); sendSelectedGift(this)">Ø¥Ø±Ø³Ø§Ù„</button>
                                    </div>
                                    <div class="gift-item" data-gift-id="crown" data-price="2.00" data-category="medium" onclick="selectGiftItem(this, 'crown', 'ğŸ‘‘', 'ØªØ§Ø¬', 2.00)">
                                        <span class="gift-emoji">ğŸ‘‘</span>
                                        <span class="gift-name">ØªØ§Ø¬</span>
                                        <span class="gift-price">$2.00</span>
                                        <button class="gift-send-btn" onclick="event.stopPropagation(); sendSelectedGift(this)">Ø¥Ø±Ø³Ø§Ù„</button>
                                    </div>
                                    <div class="gift-item" data-gift-id="car" data-price="5.00" data-category="expensive" onclick="selectGiftItem(this, 'car', 'ğŸš—', 'Ø³ÙŠØ§Ø±Ø©', 5.00)">
                                        <span class="gift-emoji">ğŸš—</span>
                                        <span class="gift-name">Ø³ÙŠØ§Ø±Ø©</span>
                                        <span class="gift-price">$5.00</span>
                                        <button class="gift-send-btn" onclick="event.stopPropagation(); sendSelectedGift(this)">Ø¥Ø±Ø³Ø§Ù„</button>
                                    </div>
                                    <div class="gift-item" data-gift-id="plane" data-price="10.00" data-category="expensive" onclick="selectGiftItem(this, 'plane', 'âœˆï¸', 'Ø·Ø§Ø¦Ø±Ø©', 10.00)">
                                        <span class="gift-emoji">âœˆï¸</span>
                                        <span class="gift-name">Ø·Ø§Ø¦Ø±Ø©</span>
                                        <span class="gift-price">$10.00</span>
                                        <button class="gift-send-btn" onclick="event.stopPropagation(); sendSelectedGift(this)">Ø¥Ø±Ø³Ø§Ù„</button>
                                    </div>
                                    <div class="gift-item" data-gift-id="castle" data-price="20.00" data-category="expensive" onclick="selectGiftItem(this, 'castle', 'ğŸ°', 'Ù‚Ù„Ø¹Ø©', 20.00)">
                                        <span class="gift-emoji">ğŸ°</span>
                                        <span class="gift-name">Ù‚Ù„Ø¹Ø©</span>
                                        <span class="gift-price">$20.00</span>
                                        <button class="gift-send-btn" onclick="event.stopPropagation(); sendSelectedGift(this)">Ø¥Ø±Ø³Ø§Ù„</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙŠ Ù„Ù„Ù‡Ø¯Ø§ÙŠØ§ -->
                            <div id="giftInsufficientBalanceModal" class="gift-insufficient-modal">
                                <div class="gift-modal-content">
                                    <button class="gift-modal-close" onclick="closeGiftModal()">âœ•</button>
                                    <div class="gift-error-icon">âœ•</div>
                                    <h2 class="gift-modal-title">Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙŠ</h2>
                                    <p class="gift-modal-message">Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø±Ø³Ø§Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ù‡Ø¯ÙŠØ©ØŒ ÙŠØ±Ø¬Ù‰ Ø´Ø­Ù† Ø±ØµÙŠØ¯Ùƒ</p>
                                    <button class="gift-modal-deposit-btn" onclick="goToDepositFromGift()">Ø´Ø­Ù†</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <style>
                        /* Ø£Ù†Ù…Ø§Ø· Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ù„Ù„Ù…Ø´Ø§Ù‡Ø¯ */
                        .viewer-action-bar {
                            display: flex;
                            align-items: center;
                            gap: 10px;
                            padding: 12px;
                            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
                            border-radius: 12px;
                            margin-top: 15px;
                        }
                        .message-input-container {
                            flex: 1;
                            display: flex;
                            align-items: center;
                            background: rgba(255,255,255,0.1);
                            border-radius: 20px;
                            padding: 0 5px;
                        }
                        .message-input-container input {
                            flex: 1;
                            background: transparent;
                            border: none;
                            color: white;
                            padding: 10px 15px;
                            font-size: 14px;
                            outline: none;
                        }
                        .message-input-container input::placeholder {
                            color: rgba(255,255,255,0.5);
                        }
                        .send-message-btn {
                            background: #e11d48;
                            border: none;
                            color: white;
                            width: 36px;
                            height: 36px;
                            border-radius: 50%;
                            cursor: pointer;
                            font-size: 16px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            transition: all 0.3s;
                        }
                        .send-message-btn:hover {
                            background: #be123c;
                            transform: scale(1.1);
                        }
                        .gift-btn {
                            background: linear-gradient(135deg, #d4af37 0%, #f4e5b5 100%);
                            border: none;
                            width: 44px;
                            height: 44px;
                            border-radius: 50%;
                            cursor: pointer;
                            font-size: 22px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            transition: all 0.3s;
                            box-shadow: 0 4px 10px rgba(212, 175, 55, 0.3);
                        }
                        .gift-btn:hover {
                            transform: scale(1.1);
                            box-shadow: 0 6px 15px rgba(212, 175, 55, 0.5);
                        }
                        .bet-btn {
                            background: #e11d48;
                            border: none;
                            color: white;
                            padding: 10px 18px;
                            border-radius: 20px;
                            cursor: pointer;
                            font-size: 14px;
                            font-weight: bold;
                            transition: all 0.3s;
                        }
                        .bet-btn:hover {
                            background: #be123c;
                            transform: translateY(-2px);
                        }
                        
                        /* Ø£Ù†Ù…Ø§Ø· Ù„ÙˆØ­Ø© Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ø§Ù„Ø³ÙÙ„ÙŠØ© */
                        .gift-bottom-sheet {
                            position: fixed;
                            bottom: -100%;
                            left: 0;
                            right: 0;
                            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
                            border-radius: 20px 20px 0 0;
                            padding: 20px;
                            z-index: 1001;
                            transition: bottom 0.15s ease-out;
                            max-height: 60vh;
                            overflow-y: auto;
                        }
                        .gift-bottom-sheet.show {
                            bottom: 0;
                        }
                        .gift-sheet-header {
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 15px;
                            padding-bottom: 10px;
                            border-bottom: 1px solid rgba(255,255,255,0.1);
                        }
                        .gift-sheet-title {
                            color: #ffd700;
                            font-size: 18px;
                            font-weight: bold;
                        }
                        .gift-sheet-close {
                            background: none;
                            border: none;
                            color: white;
                            font-size: 24px;
                            cursor: pointer;
                            padding: 5px;
                        }
                        .gift-tabs {
                            display: flex;
                            gap: 8px;
                            margin-bottom: 15px;
                            overflow-x: auto;
                            padding-bottom: 5px;
                        }
                        .gift-tab {
                            background: rgba(255,255,255,0.1);
                            border: none;
                            color: white;
                            padding: 8px 16px;
                            border-radius: 20px;
                            cursor: pointer;
                            font-size: 13px;
                            white-space: nowrap;
                            transition: all 0.3s;
                        }
                        .gift-tab.active {
                            background: linear-gradient(135deg, #d4af37 0%, #f4e5b5 100%);
                            color: #1a1a2e;
                            font-weight: bold;
                        }
                        .gift-items-grid {
                            display: grid;
                            grid-template-columns: repeat(4, 1fr);
                            gap: 12px;
                        }
                        .gift-item {
                            background: rgba(255,255,255,0.05);
                            border: 2px solid transparent;
                            border-radius: 12px;
                            padding: 12px 8px;
                            text-align: center;
                            cursor: pointer;
                            transition: all 0.3s;
                        }
                        .gift-item:hover {
                            background: rgba(255,255,255,0.1);
                            border-color: #d4af37;
                            transform: translateY(-3px);
                        }
                        .gift-item.selected {
                            border-color: #e11d48;
                            background: rgba(225,29,72,0.2);
                        }
                        .gift-emoji {
                            display: block;
                            font-size: 32px;
                            margin-bottom: 5px;
                        }
                        .gift-name {
                            display: block;
                            color: white;
                            font-size: 12px;
                            margin-bottom: 3px;
                        }
                        .gift-price {
                            display: block;
                            color: #ffd700;
                            font-size: 11px;
                            font-weight: bold;
                        }
                        .gift-send-btn {
                            display: none;
                            width: 100%;
                            margin-top: 8px;
                            padding: 6px 12px;
                            background: linear-gradient(135deg, #e11d48 0%, #be123c 100%);
                            border: none;
                            border-radius: 15px;
                            color: white;
                            font-size: 12px;
                            font-weight: bold;
                            cursor: pointer;
                            transition: all 0.15s ease;
                        }
                        .gift-send-btn:hover {
                            transform: scale(1.05);
                            box-shadow: 0 3px 10px rgba(225, 29, 72, 0.4);
                        }
                        .gift-send-btn:active {
                            transform: scale(0.95);
                        }
                        .gift-send-btn.sent {
                            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
                        }
                        .gift-item.selected .gift-send-btn {
                            display: block;
                        }
                        
                        /* Ø£Ù†Ù…Ø§Ø· Ù…Ù†Ø·Ù‚Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ */
                        .gift-display-area {
                            position: fixed;
                            right: 10px;
                            top: 50%;
                            transform: translateY(-50%);
                            display: flex;
                            flex-direction: column;
                            gap: 8px;
                            z-index: 999;
                            max-height: 300px;
                            overflow: hidden;
                        }
                        .gift-notification {
                            background: linear-gradient(135deg, rgba(26,26,46,0.95) 0%, rgba(22,33,62,0.95) 100%);
                            border: 2px solid #d4af37;
                            border-radius: 30px;
                            padding: 8px 16px;
                            display: flex;
                            align-items: center;
                            gap: 8px;
                            animation: giftSlideIn 0.4s ease-out;
                            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
                        }
                        .gift-notification.hiding {
                            animation: giftSlideOut 0.3s ease-in forwards;
                        }
                        @keyframes giftSlideIn {
                            from {
                                transform: translateX(100%);
                                opacity: 0;
                            }
                            to {
                                transform: translateX(0);
                                opacity: 1;
                            }
                        }
                        @keyframes giftSlideOut {
                            from {
                                transform: translateX(0);
                                opacity: 1;
                            }
                            to {
                                transform: translateX(100%);
                                opacity: 0;
                            }
                        }
                        .gift-notification .gift-sender {
                            color: #22c55e;
                            font-size: 13px;
                            font-weight: bold;
                        }
                        .gift-notification .gift-action {
                            color: white;
                            font-size: 12px;
                        }
                        .gift-notification .gift-icon {
                            font-size: 24px;
                        }
                        .gift-notification .gift-counter {
                            background: #e11d48;
                            color: white;
                            font-size: 11px;
                            font-weight: bold;
                            padding: 2px 8px;
                            border-radius: 10px;
                            margin-right: 5px;
                        }
                        @keyframes giftCounterPulse {
                            0% { transform: scale(1); }
                            50% { transform: scale(1.3); }
                            100% { transform: scale(1); }
                        }
                        .gift-counter-pulse {
                            animation: giftCounterPulse 0.3s ease;
                        }
                        
                        /* ØªØ£Ø«ÙŠØ± Ù‡Ø¯ÙŠØ© Ø§Ù„Ø·Ø§Ø¦Ø±Ø© - Ù…Ø«Ù„ ØªÙŠÙƒ ØªÙˆÙƒ */
                        .plane-gift-overlay {
                            position: fixed;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            pointer-events: none;
                            z-index: 9999;
                            overflow: hidden;
                        }
                        .flying-plane {
                            position: absolute;
                            font-size: 80px;
                            filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.8));
                            animation: planeFlying 3s ease-in-out forwards;
                            z-index: 10000;
                        }
                        @keyframes planeFlying {
                            0% { left: -100px; top: 70%; transform: rotate(-15deg) scale(0.5); opacity: 0; }
                            10% { opacity: 1; transform: rotate(-20deg) scale(1); }
                            30% { left: 30%; top: 50%; transform: rotate(-10deg) scale(1.2); }
                            50% { left: 50%; top: 35%; transform: rotate(0deg) scale(1.4); }
                            70% { left: 70%; top: 25%; transform: rotate(10deg) scale(1.2); }
                            90% { opacity: 1; transform: rotate(15deg) scale(1); }
                            100% { left: 110%; top: 10%; transform: rotate(20deg) scale(0.8); opacity: 0; }
                        }
                        .plane-trail {
                            position: absolute;
                            width: 150px;
                            height: 4px;
                            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.8), transparent);
                            border-radius: 2px;
                            animation: trailFade 0.5s ease-out forwards;
                            filter: blur(2px);
                        }
                        @keyframes trailFade {
                            0% { opacity: 1; width: 150px; }
                            100% { opacity: 0; width: 0; }
                        }
                        .plane-sparkle {
                            position: absolute;
                            width: 10px;
                            height: 10px;
                            background: radial-gradient(circle, #ffd700, transparent);
                            border-radius: 50%;
                            animation: sparkle 0.8s ease-out forwards;
                        }
                        @keyframes sparkle {
                            0% { transform: scale(0); opacity: 1; }
                            50% { transform: scale(1.5); opacity: 0.8; }
                            100% { transform: scale(0); opacity: 0; }
                        }
                        .plane-gift-text {
                            position: fixed;
                            top: 50%;
                            left: 50%;
                            transform: translate(-50%, -50%);
                            font-size: 28px;
                            font-weight: bold;
                            color: #ffd700;
                            text-shadow: 0 0 20px rgba(255, 215, 0, 0.8), 0 0 40px rgba(255, 215, 0, 0.5), 2px 2px 4px rgba(0, 0, 0, 0.8);
                            z-index: 10001;
                            animation: giftTextAppear 3s ease-in-out forwards;
                            text-align: center;
                            direction: rtl;
                            white-space: nowrap;
                        }
                        @keyframes giftTextAppear {
                            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
                            20% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
                            30% { transform: translate(-50%, -50%) scale(1); }
                            70% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
                            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8) translateY(-30px); }
                        }
                        .plane-confetti {
                            position: absolute;
                            width: 8px;
                            height: 8px;
                            animation: confettiFall 2s ease-out forwards;
                        }
                        @keyframes confettiFall {
                            0% { opacity: 1; transform: translateY(0) rotate(0deg); }
                            100% { opacity: 0; transform: translateY(200px) rotate(720deg); }
                        }
                        
                        /* Ø£Ù†Ù…Ø§Ø· Ù…Ù†Ø·Ù‚Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */
                        .stream-message-display-area {
                            position: fixed;
                            left: 10px;
                            top: 50%;
                            transform: translateY(-50%);
                            display: flex;
                            flex-direction: column;
                            gap: 6px;
                            z-index: 999;
                            max-height: 250px;
                            overflow: hidden;
                            pointer-events: none;
                        }
                        .stream-message {
                            background: transparent;
                            padding: 6px 12px;
                            border-radius: 15px;
                            display: flex;
                            flex-direction: row;
                            align-items: center;
                            gap: 8px;
                            animation: msgSlideIn 0.3s ease-out;
                            pointer-events: none;
                            max-width: 220px;
                            border: 1.5px solid rgba(0, 0, 0, 0.4);
                            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
                        }
                        .stream-message.hiding {
                            animation: msgSlideOut 0.3s ease-in forwards;
                        }
                        @keyframes msgSlideIn {
                            from { transform: translateX(-100%); opacity: 0; }
                            to { transform: translateX(0); opacity: 1; }
                        }
                        @keyframes msgSlideOut {
                            from { transform: translateX(0); opacity: 1; }
                            to { transform: translateX(-100%); opacity: 0; }
                        }
                        .stream-message .msg-sender {
                            color: #00bfff;
                            font-size: 11px;
                            font-weight: 700;
                            white-space: nowrap;
                            text-shadow: 0 0 8px rgba(0, 191, 255, 0.6);
                        }
                        .stream-message .msg-text {
                            color: #000000;
                            font-size: 13px;
                            font-weight: 600;
                            word-break: break-word;
                            text-shadow: 0 0 1px rgba(0,0,0,0.3);
                        }
                        .cooldown-display {
                            color: #ffd700;
                            font-size: 12px;
                            font-weight: bold;
                            padding: 0 8px;
                            min-width: 30px;
                            text-align: center;
                        }
                        .send-message-btn:disabled {
                            opacity: 0.5;
                            cursor: not-allowed;
                        }
                        
                        /* Ø£Ù†Ù…Ø§Ø· Ù†Ø§ÙØ°Ø© Ø§Ù„Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙŠ Ù„Ù„Ù‡Ø¯Ø§ÙŠØ§ */
                        .gift-insufficient-modal {
                            display: none;
                            position: fixed;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            background: rgba(0, 0, 0, 0.7);
                            z-index: 1002;
                            justify-content: center;
                            align-items: center;
                        }
                        .gift-insufficient-modal.show {
                            display: flex;
                        }
                        .gift-modal-content {
                            background: #37474f;
                            border-radius: 15px;
                            padding: 40px;
                            max-width: 400px;
                            width: 90%;
                            position: relative;
                            text-align: center;
                            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
                        }
                        .gift-modal-close {
                            position: absolute;
                            top: 15px;
                            left: 15px;
                            background: none;
                            border: none;
                            color: white;
                            font-size: 30px;
                            cursor: pointer;
                            padding: 0;
                            width: 40px;
                            height: 40px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                        }
                        .gift-error-icon {
                            width: 80px;
                            height: 80px;
                            background: #e74c3c;
                            border-radius: 50%;
                            margin: 0 auto 20px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 50px;
                            color: white;
                        }
                        .gift-modal-title {
                            color: white;
                            font-size: 22px;
                            margin-bottom: 15px;
                        }
                        .gift-modal-message {
                            color: #b0bec5;
                            font-size: 16px;
                            margin-bottom: 30px;
                        }
                        .gift-modal-deposit-btn {
                            background: #8bc34a;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            padding: 15px 40px;
                            font-size: 18px;
                            font-weight: bold;
                            cursor: pointer;
                            width: 100%;
                            transition: all 0.3s;
                        }
                        .gift-modal-deposit-btn:hover {
                            background: #7cb342;
                            transform: translateY(-2px);
                        }
                        
                        /* ØªØºØ·ÙŠØ© Ø´ÙØ§ÙØ© Ù„Ù„Ø®Ù„ÙÙŠØ© */
                        .gift-sheet-overlay {
                            display: none;
                            position: fixed;
                            top: 0;
                            left: 0;
                            right: 0;
                            bottom: 0;
                            background: rgba(0,0,0,0.5);
                            z-index: 1000;
                        }
                        .gift-sheet-overlay.show {
                            display: block;
                        }
                        
                        @media (max-width: 400px) {
                            .gift-items-grid {
                                grid-template-columns: repeat(3, 1fr);
                            }
                            .gift-emoji {
                                font-size: 26px;
                            }
                        }
                        
                        .stream-card {
                            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
                            border-radius: 15px;
                            padding: 20px;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            cursor: pointer;
                            transition: all 0.3s ease;
                            border: 2px solid transparent;
                        }
                        .stream-card:hover {
                            border-color: #e11d48;
                            transform: translateY(-3px);
                            box-shadow: 0 10px 30px rgba(225, 29, 72, 0.3);
                        }
                        .stream-card .live-badge {
                            background: #dc2626;
                            color: white;
                            padding: 4px 10px;
                            border-radius: 12px;
                            font-size: 12px;
                            font-weight: bold;
                            animation: livePulse 1.5s infinite;
                        }
                        @keyframes livePulse {
                            0%, 100% { opacity: 1; }
                            50% { opacity: 0.6; }
                        }
                        .stream-card .players-info {
                            color: white;
                            font-weight: 600;
                        }
                        .stream-card .bet-info {
                            color: #ffd700;
                            font-weight: bold;
                        }
                        .stream-card .viewers-info {
                            color: #22d3ee;
                        }
                        
                        /* Ù„ÙˆØ­Ø© Ø§Ù„Ù„ÙˆØ¯Ùˆ Ù„Ù„Ù…Ø´Ø§Ù‡Ø¯ - Ù…Ø·Ø§Ø¨Ù‚Ø© ØªÙ…Ø§Ù…Ø§Ù‹ Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† */
                        #viewer-ludo-board { 
                            position: relative; 
                            width: min(85vw, 340px); 
                            height: min(85vw, 340px); 
                            background: linear-gradient(135deg, #c89b5a 0%, #b58850 50%, #a57645 100%); 
                            box-shadow: 0 0 0 4px #654321, 0 0 0 6px #8b6914, 0 10px 30px rgba(0,0,0,0.5), inset 0 0 15px rgba(0,0,0,0.15); 
                            border-radius: 8px; 
                            display: grid; 
                            grid-template-columns: 40% 20% 40%; 
                            grid-template-rows: 40% 20% 40%; 
                            gap: 0; 
                            padding: 0; 
                            margin: 0 auto;
                            transform: translateX(-5px) !important;
                            z-index: 10;
                        }
                        #viewer-ludo-board::before { 
                            content: ''; 
                            position: absolute; 
                            inset: 0; 
                            background: repeating-linear-gradient(90deg, transparent 0, transparent 2px, rgba(139,105,20,0.1) 2px, rgba(139,105,20,0.1) 4px), repeating-linear-gradient(0deg, transparent 0, transparent 2px, rgba(139,105,20,0.1) 2px, rgba(139,105,20,0.1) 4px); 
                            pointer-events: none; 
                            border-radius: 6px; 
                        }
                        #viewer-ludo-board .viewer-player-home { 
                            display: flex; 
                            align-items: center; 
                            justify-content: center; 
                            position: relative; 
                            padding: 4px; 
                        }
                        #viewer-ludo-board .viewer-player-circle { 
                            width: 85%; 
                            height: 85%; 
                            border-radius: 50%; 
                            border: 2px solid rgba(0,0,0,0.3); 
                            box-shadow: inset 0 2px 8px rgba(0,0,0,0.3), 0 2px 8px rgba(0,0,0,0.2); 
                            position: relative; 
                            display: grid; 
                            grid-template-columns: 1fr 1fr; 
                            grid-template-rows: 1fr 1fr; 
                            gap: 6%; 
                            padding: 12%; 
                        }
                        #viewer-ludo-board .viewer-player-home.green { grid-area: 1 / 1 / 2 / 2; } 
                        #viewer-ludo-board .viewer-player-home.green .viewer-player-circle { background: radial-gradient(circle, #4ade80 0%, #22c55e 100%); }
                        #viewer-ludo-board .viewer-player-home.red { grid-area: 1 / 3 / 2 / 4; } 
                        #viewer-ludo-board .viewer-player-home.red .viewer-player-circle { background: radial-gradient(circle, #f87171 0%, #ef4444 100%); }
                        #viewer-ludo-board .viewer-player-home.yellow { grid-area: 3 / 1 / 4 / 2; } 
                        #viewer-ludo-board .viewer-player-home.yellow .viewer-player-circle { background: radial-gradient(circle, #fde047 0%, #eab308 100%); }
                        #viewer-ludo-board .viewer-player-home.blue { grid-area: 3 / 3 / 4 / 4; } 
                        #viewer-ludo-board .viewer-player-home.blue .viewer-player-circle { background: radial-gradient(circle, #60a5fa 0%, #3b82f6 100%); }
                        #viewer-ludo-board .viewer-token { 
                            width: 100%; 
                            height: 100%; 
                            border-radius: 50%; 
                            border: 2px solid rgba(255,255,255,0.8); 
                            box-shadow: 0 2px 6px rgba(0,0,0,0.3), inset 0 2px 4px rgba(255,255,255,0.5), inset 0 -2px 4px rgba(0,0,0,0.2); 
                            position: relative; 
                            transition: all 0.3s ease;
                        }
                        #viewer-ludo-board .viewer-token::before { 
                            content: ''; 
                            position: absolute; 
                            top: 20%; 
                            left: 20%; 
                            width: 60%; 
                            height: 60%; 
                            border-radius: 50%; 
                            border: 1px solid rgba(255,255,255,0.4); 
                        }
                        #viewer-ludo-board .viewer-token.green { background: radial-gradient(circle at 30% 30%, #86efac, #22c55e); }
                        #viewer-ludo-board .viewer-token.red { background: radial-gradient(circle at 30% 30%, #fca5a5, #ef4444); }
                        #viewer-ludo-board .viewer-token.yellow { background: radial-gradient(circle at 30% 30%, #fef08a, #eab308); }
                        #viewer-ludo-board .viewer-token.blue { background: radial-gradient(circle at 30% 30%, #93c5fd, #3b82f6); }
                        #viewer-ludo-board .viewer-token.on-board {
                            position: absolute;
                            width: 14px;
                            height: 14px;
                            top: 50%;
                            left: 50%;
                            transform: translate(-50%, -50%);
                            z-index: 100;
                        }
                        #viewer-ludo-board .viewer-player-progress { 
                            position: absolute; 
                            bottom: 3px; 
                            left: 50%; 
                            transform: translateX(-50%); 
                            background: rgba(0,0,0,0.7); 
                            color: white; 
                            padding: 2px 6px; 
                            border-radius: 8px; 
                            font-size: 9px; 
                            font-weight: bold; 
                            z-index: 10; 
                        }
                        #viewer-ludo-board .viewer-turn-timer-ring { 
                            position: absolute; 
                            top: 50%; 
                            left: 50%; 
                            transform: translate(-50%, -50%); 
                            width: calc(85% + 2px); 
                            height: calc(85% + 2px); 
                            z-index: 5; 
                            pointer-events: none; 
                            opacity: 0; 
                            transition: opacity 0.3s ease; 
                        }
                        #viewer-ludo-board .viewer-turn-timer-ring.active { opacity: 1; }
                        #viewer-ludo-board .viewer-turn-timer-ring circle { 
                            fill: none; 
                            stroke: #000; 
                            stroke-width: 2; 
                            transform: rotate(-90deg); 
                            transform-origin: 50% 50%; 
                            transition: stroke-dashoffset 0.6s ease; 
                        }
                        #viewer-ludo-board .viewer-turn-timer-ring circle.warning { 
                            stroke: rgba(239, 68, 68, 0.8); 
                        }
                        #viewer-ludo-board .viewer-path-container { 
                            position: relative; 
                            background: transparent; 
                        }
                        #viewer-ludo-board .viewer-path-container.top { grid-area: 1 / 2 / 2 / 3; } 
                        #viewer-ludo-board .viewer-path-container.right { grid-area: 2 / 3 / 3 / 4; } 
                        #viewer-ludo-board .viewer-path-container.bottom { grid-area: 3 / 2 / 4 / 3; } 
                        #viewer-ludo-board .viewer-path-container.left { grid-area: 2 / 1 / 3 / 2; }
                        #viewer-ludo-board .viewer-path-cells { 
                            width: 100%; 
                            height: 100%; 
                            display: grid; 
                        }
                        #viewer-ludo-board .viewer-path-container.top .viewer-path-cells, 
                        #viewer-ludo-board .viewer-path-container.bottom .viewer-path-cells { 
                            grid-template-columns: repeat(3, 1fr); 
                            grid-template-rows: repeat(6, 1fr); 
                        }
                        #viewer-ludo-board .viewer-path-container.left .viewer-path-cells, 
                        #viewer-ludo-board .viewer-path-container.right .viewer-path-cells { 
                            grid-template-columns: repeat(6, 1fr); 
                            grid-template-rows: repeat(3, 1fr); 
                        }
                        #viewer-ludo-board .viewer-cell { 
                            border: 1px solid rgba(200,200,200,0.4); 
                            background: rgba(255,255,255,0.7); 
                            display: flex; 
                            align-items: center; 
                            justify-content: center; 
                            position: relative; 
                        }
                        #viewer-ludo-board .viewer-cell.red-path { background: #ef4444; } 
                        #viewer-ludo-board .viewer-cell.green-path { background: #22c55e; } 
                        #viewer-ludo-board .viewer-cell.yellow-path { background: #eab308; } 
                        #viewer-ludo-board .viewer-cell.blue-path { background: #3b82f6; }
                        #viewer-ludo-board .viewer-cell.safe { position: relative; } 
                        #viewer-ludo-board .viewer-cell.safe::before { content: 'â˜…'; position: absolute; font-size: 10px; color: rgba(255,215,0,0.8); }
                        #viewer-ludo-board .viewer-center-area { 
                            grid-area: 2 / 2 / 3 / 3; 
                            position: relative; 
                            display: flex; 
                            align-items: center; 
                            justify-content: center; 
                            perspective: 800px; 
                            perspective-origin: center center; 
                        }
                        #viewer-ludo-board .viewer-center-triangle-container { 
                            width: 70%; 
                            height: 70%; 
                            position: relative; 
                            transform: rotate(45deg); 
                        }
                        #viewer-ludo-board .viewer-center-triangle { 
                            position: absolute; 
                            width: 0; 
                            height: 0; 
                            border-style: solid; 
                        }
                        #viewer-ludo-board .triangle-red { top: 0; right: 0; border-width: 0 50% 50% 0; border-color: transparent #ef4444 transparent transparent; }
                        #viewer-ludo-board .triangle-blue { bottom: 0; right: 0; border-width: 0 0 50% 50%; border-color: transparent transparent #3b82f6 transparent; }
                        #viewer-ludo-board .triangle-yellow { bottom: 0; left: 0; border-width: 50% 0 0 50%; border-color: transparent transparent transparent #eab308; }
                        #viewer-ludo-board .triangle-green { top: 0; left: 0; border-width: 50% 50% 0 0; border-color: #22c55e transparent transparent transparent; }
                        #viewer-ludo-board .viewer-golden-ring { 
                            position: absolute; 
                            width: 80%; 
                            height: 80%; 
                            border-radius: 50%; 
                            background: radial-gradient(circle at 30% 30%, #ffd700, #ffed4e, #ffd700, #b8860b); 
                            border: 0.3mm solid #ffd700; 
                            box-shadow: 0 0 10px rgba(255, 215, 0, 0.8), 0 0 20px rgba(255, 215, 0, 0.5), inset 0 0 8px rgba(255, 255, 255, 0.6), inset 0 0 15px rgba(255, 215, 0, 0.4), 0 2px 8px rgba(0, 0, 0, 0.3); 
                            z-index: 15; 
                            animation: viewerGoldenShine 3s infinite ease-in-out; 
                        }
                        #viewer-ludo-board .viewer-golden-ring::before { 
                            content: ''; 
                            position: absolute; 
                            inset: 0.3mm; 
                            border-radius: 50%; 
                            background: #000000; 
                        }
                        @keyframes viewerGoldenShine { 
                            0%, 100% { box-shadow: 0 0 10px rgba(255, 215, 0, 0.8), 0 0 20px rgba(255, 215, 0, 0.5), inset 0 0 8px rgba(255, 255, 255, 0.6), inset 0 0 15px rgba(255, 215, 0, 0.4), 0 2px 8px rgba(0, 0, 0, 0.3); } 
                            50% { box-shadow: 0 0 15px rgba(255, 215, 0, 1), 0 0 30px rgba(255, 215, 0, 0.7), inset 0 0 10px rgba(255, 255, 255, 0.8), inset 0 0 20px rgba(255, 215, 0, 0.6), 0 2px 10px rgba(0, 0, 0, 0.4); } 
                        }
                        #viewer-ludo-board .viewer-dice { 
                            width: 35px !important; 
                            height: 35px !important; 
                            position: absolute; 
                            top: 50%; 
                            left: 50%; 
                            margin-left: -17.5px; 
                            margin-top: -17.5px; 
                            transform-style: preserve-3d; 
                            transform: translate3d(0, 0, 0) rotateX(0deg) rotateY(0deg) rotateZ(0deg); 
                            transform-origin: center center; 
                            z-index: 25; 
                            will-change: transform; 
                            transition: transform 0.5s ease-out; 
                        }
                        #viewer-ludo-board .viewer-dice-face { 
                            position: absolute; 
                            width: 35px; 
                            height: 35px; 
                            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 50%, #1d4ed8 100%); 
                            border: none; 
                            border-radius: 3px; 
                            box-shadow: inset -1px -1px 3px rgba(0,0,0,0.4), inset 1px 1px 3px rgba(255,255,255,0.2), 0 2px 6px rgba(0,0,0,0.5); 
                            backface-visibility: hidden; 
                            transition: background 0.3s ease;
                        }
                        #viewer-ludo-board .viewer-dice.green-player .viewer-dice-face { 
                            background: linear-gradient(135deg, #86efac 0%, #22c55e 50%, #16a34a 100%) !important; 
                        }
                        #viewer-ludo-board .viewer-dice.blue-player .viewer-dice-face { 
                            background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 50%, #2563eb 100%) !important; 
                        }
                        #viewer-ludo-board .viewer-dice-face::before { 
                            content: ''; 
                            position: absolute; 
                            top: 1px; 
                            left: 1px; 
                            right: 1px; 
                            bottom: 1px; 
                            background: linear-gradient(145deg, rgba(255,255,255,0.1), transparent); 
                            border-radius: 2px; 
                            pointer-events: none; 
                        }
                        #viewer-ludo-board .viewer-dice-face .dot { 
                            width: 7px; 
                            height: 7px; 
                            background: radial-gradient(circle at 30% 30%, #333, #000); 
                            border-radius: 50%; 
                            box-shadow: inset 0 1px 1px rgba(0,0,0,0.9); 
                            pointer-events: none; 
                            position: absolute; 
                        }
                        #viewer-ludo-board .viewer-dice-face.front { transform: rotateY(0deg) translateZ(17.5px); }
                        #viewer-ludo-board .viewer-dice-face.back { transform: rotateY(180deg) translateZ(17.5px); }
                        #viewer-ludo-board .viewer-dice-face.right { transform: rotateY(90deg) translateZ(17.5px); }
                        #viewer-ludo-board .viewer-dice-face.left { transform: rotateY(-90deg) translateZ(17.5px); }
                        #viewer-ludo-board .viewer-dice-face.top { transform: rotateX(90deg) translateZ(17.5px); }
                        #viewer-ludo-board .viewer-dice-face.bottom { transform: rotateX(-90deg) translateZ(17.5px); }
                        #viewer-ludo-board .dice-1 .dot { display: none; }
                        #viewer-ludo-board .dice-1 .dot:nth-child(5) { display: block; top: 50%; left: 50%; transform: translate(-50%, -50%); }
                        #viewer-ludo-board .dice-2 .dot { display: none; }
                        #viewer-ludo-board .dice-2 .dot:nth-child(1) { display: block; top: 6px; left: 6px; }
                        #viewer-ludo-board .dice-2 .dot:nth-child(2) { display: block; bottom: 6px; right: 6px; }
                        #viewer-ludo-board .dice-3 .dot { display: none; }
                        #viewer-ludo-board .dice-3 .dot:nth-child(1) { display: block; top: 6px; left: 6px; }
                        #viewer-ludo-board .dice-3 .dot:nth-child(2) { display: block; top: 50%; left: 50%; transform: translate(-50%, -50%); }
                        #viewer-ludo-board .dice-3 .dot:nth-child(3) { display: block; bottom: 6px; right: 6px; }
                        #viewer-ludo-board .dice-4 .dot { display: none; }
                        #viewer-ludo-board .dice-4 .dot:nth-child(1) { display: block; top: 6px; left: 6px; }
                        #viewer-ludo-board .dice-4 .dot:nth-child(2) { display: block; top: 6px; right: 6px; }
                        #viewer-ludo-board .dice-4 .dot:nth-child(3) { display: block; bottom: 6px; left: 6px; }
                        #viewer-ludo-board .dice-4 .dot:nth-child(4) { display: block; bottom: 6px; right: 6px; }
                        #viewer-ludo-board .dice-5 .dot { display: none; }
                        #viewer-ludo-board .dice-5 .dot:nth-child(1) { display: block; top: 6px; left: 6px; }
                        #viewer-ludo-board .dice-5 .dot:nth-child(2) { display: block; top: 6px; right: 6px; }
                        #viewer-ludo-board .dice-5 .dot:nth-child(3) { display: block; top: 50%; left: 50%; transform: translate(-50%, -50%); }
                        #viewer-ludo-board .dice-5 .dot:nth-child(4) { display: block; bottom: 6px; left: 6px; }
                        #viewer-ludo-board .dice-5 .dot:nth-child(5) { display: block; bottom: 6px; right: 6px; }
                        #viewer-ludo-board .dice-6 .dot { display: none; }
                        #viewer-ludo-board .dice-6 .dot:nth-child(1) { display: block; top: 4px; left: 7px; }
                        #viewer-ludo-board .dice-6 .dot:nth-child(2) { display: block; top: 4px; right: 7px; }
                        #viewer-ludo-board .dice-6 .dot:nth-child(3) { display: block; top: 16px; left: 7px; }
                        #viewer-ludo-board .dice-6 .dot:nth-child(4) { display: block; top: 16px; right: 7px; }
                        #viewer-ludo-board .dice-6 .dot:nth-child(5) { display: block; top: 28px; left: 7px; }
                        #viewer-ludo-board .dice-6 .dot:nth-child(6) { display: block; top: 28px; right: 7px; }
                    </style>
                </div>
                
                <!-- ØªØ¨ÙˆÙŠØ¨ Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± -->
                <div id="live-earnings-tab" class="live-tab-content">
                    <div class="live-earnings-container">
                        <h2 style="color: #e11d48; margin-bottom: 20px;">ğŸ’° Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</h2>
                        
                        <div id="earnings-summary" class="earnings-summary-box">
                            <div class="earnings-stat">
                                <span class="earnings-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</span>
                                <span id="total-earnings-value" class="earnings-value">0.00 $</span>
                            </div>
                            <div class="earnings-stat">
                                <span class="earnings-label">Ø¹Ø¯Ø¯ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©</span>
                                <span id="total-gifts-count" class="earnings-value">0</span>
                            </div>
                        </div>
                        
                        <h3 style="color: #fff; margin: 20px 0 15px; font-size: 16px;">ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ø¨Ø«ÙˆØ«</h3>
                        <div id="streams-history-list" class="streams-history-list">
                            <p style="color: #888; text-align: center; padding: 20px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
                        </div>
                    </div>
                    
                    <style>
                        .live-earnings-container {
                            padding: 15px;
                        }
                        .earnings-summary-box {
                            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
                            border-radius: 15px;
                            padding: 20px;
                            display: flex;
                            justify-content: space-around;
                            margin-bottom: 20px;
                            border: 1px solid rgba(225, 29, 72, 0.3);
                        }
                        .earnings-stat {
                            text-align: center;
                        }
                        .earnings-label {
                            display: block;
                            color: #888;
                            font-size: 12px;
                            margin-bottom: 5px;
                        }
                        .earnings-value {
                            display: block;
                            color: #22c55e;
                            font-size: 24px;
                            font-weight: bold;
                        }
                        .streams-history-list {
                            max-height: 400px;
                            overflow-y: auto;
                        }
                        .stream-history-item {
                            background: rgba(255,255,255,0.05);
                            border-radius: 10px;
                            padding: 15px;
                            margin-bottom: 10px;
                            border: 1px solid rgba(255,255,255,0.1);
                        }
                        .stream-history-header {
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 10px;
                        }
                        .stream-date {
                            color: #888;
                            font-size: 12px;
                        }
                        .stream-earnings {
                            color: #22c55e;
                            font-weight: bold;
                            font-size: 16px;
                        }
                        .stream-details {
                            display: flex;
                            gap: 20px;
                            font-size: 12px;
                            color: #aaa;
                        }
                        .stream-gifts-list {
                            margin-top: 10px;
                            padding-top: 10px;
                            border-top: 1px solid rgba(255,255,255,0.1);
                        }
                        .gift-item-row {
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            padding: 5px 0;
                            font-size: 12px;
                            color: #ccc;
                        }
                        .gift-item-row .gift-emoji {
                            font-size: 16px;
                            margin-right: 5px;
                        }
                        .gift-item-row .gift-value {
                            color: #22c55e;
                        }
                        .no-earnings-msg {
                            text-align: center;
                            color: #888;
                            padding: 40px 20px;
                        }
                        .no-earnings-msg .icon {
                            font-size: 48px;
                            margin-bottom: 15px;
                        }
                    </style>
                </div>
                
                <!-- ØªØ¨ÙˆÙŠØ¨ ØªÙØ¹ÙŠÙ„ Ù…ÙŠØ²Ø© Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± -->
                <div id="live-activate-tab" class="live-tab-content">
                    <div class="live-activate-container" style="padding: 15px;">
                        <h2 style="color: #e11d48; margin-bottom: 20px; text-align: center;">âš¡ ØªÙØ¹ÙŠÙ„ Ù…ÙŠØ²Ø© Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</h2>
                        
                        <div id="streaming-activated-msg" style="display: none; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white; padding: 20px; border-radius: 12px; text-align: center; margin-bottom: 20px;">
                            <div style="font-size: 48px; margin-bottom: 10px;">ğŸ‰</div>
                            <div style="font-size: 18px; font-weight: bold;">Ù…Ø¨Ø±ÙˆÙƒ! ØªÙ… ØªÙØ¹ÙŠÙ„ Ù…ÙŠØ²Ø© Ø§Ù„Ø¨Ø« ÙÙŠ Ø­Ø³Ø§Ø¨Ùƒ</div>
                            <div style="font-size: 14px; margin-top: 10px; opacity: 0.9;">ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø¨Ø« Ù…Ø¨Ø§Ø±ÙŠØ§ØªÙƒ Ø¹Ø¨Ø± Ø²Ø± ğŸ“º Ø¨Ø« Ø¯Ø§Ø®Ù„ ØºØ±ÙØ© Ø§Ù„Ù„Ø¹Ø¨Ø©</div>
                        </div>
                        
                        <div id="streaming-granted-free-msg" style="display: none; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 20px; border-radius: 12px; text-align: center; margin-bottom: 20px;">
                            <div style="font-size: 48px; margin-bottom: 10px;">ğŸ</div>
                            <div style="font-size: 18px; font-weight: bold;">ØªÙ… Ù…Ù†Ø­Ùƒ Ù…ÙŠØ²Ø© Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù…Ø¬Ø§Ù†Ø§Ù‹!</div>
                            <div style="font-size: 14px; margin-top: 10px; opacity: 0.9;">Ø§Ù„Ø¹Ø±Ø¶ Ù…Ø¤Ù‚Øª - Ø§Ù†ØªÙ‡Ø² Ø§Ù„ÙØ±ØµØ© ÙÙŠ Ø¬Ù†ÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ù…Ù† Ø®Ù„Ø§Ù„ Ø§Ù„Ø¨Ø«!</div>
                            <div style="font-size: 12px; margin-top: 10px; opacity: 0.8;">ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø¨Ø« Ù…Ø¨Ø§Ø±ÙŠØ§ØªÙƒ Ø¹Ø¨Ø± Ø²Ø± ğŸ“º Ø¨Ø« Ø¯Ø§Ø®Ù„ ØºØ±ÙØ© Ø§Ù„Ù„Ø¹Ø¨Ø©</div>
                        </div>
                        
                        <div id="streaming-requirements-box" style="background: rgba(0,0,0,0.3); border-radius: 12px; padding: 15px; margin-bottom: 15px;">
                            <div style="color: #fff; font-weight: bold; margin-bottom: 15px; font-size: 16px; text-align: center;">ğŸ“‹ Ø´Ø±ÙˆØ· Ø§Ù„ØªÙØ¹ÙŠÙ„</div>
                            
                            <div id="requirements-list" style="display: flex; flex-direction: column; gap: 12px;">
                                <!-- Ø§Ù„Ø´Ø±Ø· 1 -->
                                <div class="requirement-item" data-key="wins_030" style="background: rgba(255,255,255,0.05); border-radius: 8px; padding: 12px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <span style="font-size: 24px;">ğŸ®</span>
                                            <div>
                                                <div style="color: #fff; font-weight: 500; font-size: 14px;">Ø§Ù„ÙÙˆØ² ÙÙŠ Ù…Ø¨Ø§Ø±Ø§Ø© Ù„ÙˆØ¯Ùˆ Ø¨Ù‚ÙŠÙ…Ø© 0.30$</div>
                                                <div class="req-progress" style="color: #000000; font-size: 12px; margin-top: 3px; font-weight: 600;">0/7</div>
                                            </div>
                                        </div>
                                        <div class="req-status" style="padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; background: transparent; color: #ffffff; border: 2px solid #000000;">ØºÙŠØ± Ù…ÙƒØªÙ…Ù„</div>
                                    </div>
                                </div>
                                
                                <!-- Ø§Ù„Ø´Ø±Ø· 2 -->
                                <div class="requirement-item" data-key="wins_100" style="background: rgba(255,255,255,0.05); border-radius: 8px; padding: 12px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <span style="font-size: 24px;">ğŸ¯</span>
                                            <div>
                                                <div style="color: #fff; font-weight: 500; font-size: 14px;">Ø§Ù„ÙÙˆØ² ÙÙŠ Ù…Ø¨Ø§Ø±Ø§Ø© Ù„ÙˆØ¯Ùˆ Ø¨Ù‚ÙŠÙ…Ø© 1$</div>
                                                <div class="req-progress" style="color: #000000; font-size: 12px; margin-top: 3px; font-weight: 600;">0/5</div>
                                            </div>
                                        </div>
                                        <div class="req-status" style="padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; background: transparent; color: #ffffff; border: 2px solid #000000;">ØºÙŠØ± Ù…ÙƒØªÙ…Ù„</div>
                                    </div>
                                </div>
                                
                                <!-- Ø§Ù„Ø´Ø±Ø· 3 -->
                                <div class="requirement-item" data-key="wins_300" style="background: rgba(255,255,255,0.05); border-radius: 8px; padding: 12px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <span style="font-size: 24px;">ğŸ†</span>
                                            <div>
                                                <div style="color: #fff; font-weight: 500; font-size: 14px;">Ø§Ù„ÙÙˆØ² ÙÙŠ Ù…Ø¨Ø§Ø±Ø§Ø© Ù„ÙˆØ¯Ùˆ Ø¨Ù‚ÙŠÙ…Ø© 3$</div>
                                                <div class="req-progress" style="color: #000000; font-size: 12px; margin-top: 3px; font-weight: 600;">0/3</div>
                                            </div>
                                        </div>
                                        <div class="req-status" style="padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; background: transparent; color: #ffffff; border: 2px solid #000000;">ØºÙŠØ± Ù…ÙƒØªÙ…Ù„</div>
                                    </div>
                                </div>
                                
                                <!-- Ø§Ù„Ø´Ø±Ø· 4 - Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ -->
                                <div class="requirement-item" data-key="gifts_sent" style="background: rgba(255,255,255,0.05); border-radius: 8px; padding: 12px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <span style="font-size: 24px;">ğŸ</span>
                                            <div>
                                                <div style="color: #fff; font-weight: 500; font-size: 14px;">Ø¥Ø±Ø³Ø§Ù„ Ù‡Ø¯Ø§ÙŠØ§ ÙÙŠ Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ø¨Ù‚ÙŠÙ…Ø© 15$</div>
                                                <div class="req-progress" style="color: #000000; font-size: 12px; margin-top: 3px; font-weight: 600;">$0/$15</div>
                                            </div>
                                        </div>
                                        <div class="req-status" style="padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; background: transparent; color: #ffffff; border: 2px solid #000000;">ØºÙŠØ± Ù…ÙƒØªÙ…Ù„</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="text-align: center; color: #888; font-size: 12px; margin-top: 15px;">
                            <p>ğŸ”„ ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ‚Ø¯Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ ÙƒÙ„ ÙÙˆØ² Ø£Ùˆ Ø¥Ø±Ø³Ø§Ù„ Ù‡Ø¯ÙŠØ©</p>
                        </div>
                    </div>
                </div>
                
                <script>
                    let watchingGameId = null;
                    let viewerGameState = {
                        pieces: {
                            green: [{inHome: true, position: -1}, {inHome: true, position: -1}, {inHome: true, position: -1}, {inHome: true, position: -1}],
                            red: [{inHome: true, position: -1}, {inHome: true, position: -1}, {inHome: true, position: -1}, {inHome: true, position: -1}],
                            yellow: [{inHome: true, position: -1}, {inHome: true, position: -1}, {inHome: true, position: -1}, {inHome: true, position: -1}],
                            blue: [{inHome: true, position: -1}, {inHome: true, position: -1}, {inHome: true, position: -1}, {inHome: true, position: -1}]
                        }
                    };
                    
                    function showLiveTab(tabName, btn) {
                        document.querySelectorAll('.live-tab-content').forEach(el => {
                            el.classList.remove('active');
                        });
                        document.querySelectorAll('.live-tab-btn').forEach(el => {
                            el.classList.remove('active');
                        });
                        
                        document.getElementById('live-' + tabName + '-tab').classList.add('active');
                        btn.classList.add('active');
                        
                        if (tabName === 'stream') {
                            loadActiveStreams();
                        } else if (tabName === 'earnings') {
                            loadStreamEarnings();
                        } else if (tabName === 'activate') {
                            loadStreamingRequirements();
                        }
                    }
                    
                    function loadStreamingRequirements() {
                        fetch('/api/streaming-requirements')
                            .then(res => res.json())
                            .then(data => {
                                if (data.success) {
                                    updateRequirementsUI(data);
                                }
                            })
                            .catch(err => {
                                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø´Ø±ÙˆØ· Ø§Ù„ØªÙØ¹ÙŠÙ„:', err);
                            });
                    }
                    
                    function updateRequirementsUI(data) {
                        const activatedMsg = document.getElementById('streaming-activated-msg');
                        const grantedFreeMsg = document.getElementById('streaming-granted-free-msg');
                        const requirementsBox = document.getElementById('streaming-requirements-box');
                        
                        // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø£ÙˆÙ„Ø§Ù‹
                        activatedMsg.style.display = 'none';
                        grantedFreeMsg.style.display = 'none';
                        requirementsBox.style.display = 'block';
                        
                        if (data.streaming_granted_free && data.streaming_enabled) {
                            // ØªÙ… Ù…Ù†Ø­ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ù…Ø¬Ø§Ù†Ø§Ù‹
                            grantedFreeMsg.style.display = 'block';
                            requirementsBox.style.display = 'none';
                        } else if (data.streaming_enabled) {
                            // ØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø¨Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø´Ø±ÙˆØ·
                            activatedMsg.style.display = 'block';
                        }
                        
                        const progress = data.progress;
                        
                        for (const [key, info] of Object.entries(progress)) {
                            const item = document.querySelector(`.requirement-item[data-key="${key}"]`);
                            if (!item) continue;
                            
                            const progressEl = item.querySelector('.req-progress');
                            const statusEl = item.querySelector('.req-status');
                            
                            if (info.is_money) {
                                progressEl.textContent = `$${info.current.toFixed(2)}/$${info.required}`;
                            } else {
                                progressEl.textContent = `${info.current}/${info.required}`;
                            }
                            
                            if (info.completed) {
                                statusEl.textContent = 'Ù…ÙƒØªÙ…Ù„ âœ“';
                                statusEl.style.background = 'transparent';
                                statusEl.style.color = '#00ff7f';
                                statusEl.style.border = '2px solid #000000';
                                statusEl.style.textShadow = '0 0 8px rgba(0, 255, 127, 0.6)';
                            } else {
                                statusEl.textContent = 'ØºÙŠØ± Ù…ÙƒØªÙ…Ù„';
                                statusEl.style.background = 'transparent';
                                statusEl.style.color = '#ffffff';
                                statusEl.style.border = '2px solid #000000';
                                statusEl.style.textShadow = 'none';
                            }
                        }
                    }
                    
                    function loadStreamEarnings() {
                        fetch('/api/stream-earnings')
                            .then(res => res.json())
                            .then(data => {
                                if (data.success) {
                                    document.getElementById('total-earnings-value').textContent = data.total_earnings.toFixed(2) + ' $';
                                    document.getElementById('total-gifts-count').textContent = data.total_gifts;
                                    
                                    const listEl = document.getElementById('streams-history-list');
                                    if (data.streams.length === 0) {
                                        listEl.innerHTML = `
                                            <div class="no-earnings-msg">
                                                <div class="icon">ğŸ“º</div>
                                                <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø«ÙˆØ« Ø³Ø§Ø¨Ù‚Ø©</p>
                                                <p style="font-size: 12px; margin-top: 10px;">Ø§Ø¨Ø¯Ø£ Ø¨Ø« Ù…Ø¨Ø§Ø±Ø§ØªÙƒ Ù„ØªØ³ØªÙ‚Ø¨Ù„ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ù…Ù† Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ†</p>
                                            </div>
                                        `;
                                        return;
                                    }
                                    
                                    let html = '';
                                    data.streams.forEach(stream => {
                                        const date = new Date(stream.started_at);
                                        const dateStr = date.toLocaleDateString('ar-EG', { year: 'numeric', month: 'short', day: 'numeric' });
                                        const durationMins = Math.round(stream.duration_minutes || 0);
                                        
                                        html += `
                                            <div class="stream-history-item">
                                                <div class="stream-history-header">
                                                    <span class="stream-date">ğŸ“… ${dateStr}</span>
                                                    <span class="stream-earnings">+${stream.earnings.toFixed(2)} $</span>
                                                </div>
                                                <div class="stream-details">
                                                    <span>â± ${durationMins} Ø¯Ù‚ÙŠÙ‚Ø©</span>
                                                    <span>ğŸ ${stream.gifts_count} Ù‡Ø¯ÙŠØ©</span>
                                                </div>
                                                ${stream.gifts && stream.gifts.length > 0 ? `
                                                    <div class="stream-gifts-list">
                                                        ${stream.gifts.map(g => `
                                                            <div class="gift-item-row">
                                                                <span><span class="gift-emoji">${g.emoji}</span> ${g.name} Ù…Ù† ${g.sender}</span>
                                                                <span class="gift-value">+${g.value.toFixed(2)} $</span>
                                                            </div>
                                                        `).join('')}
                                                    </div>
                                                ` : ''}
                                            </div>
                                        `;
                                    });
                                    listEl.innerHTML = html;
                                }
                            })
                            .catch(err => {
                                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­:', err);
                            });
                    }
                    
                    function loadActiveStreams() {
                        console.log('ğŸ“º Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ø«ÙˆØ« Ø§Ù„Ù†Ø´Ø·Ø©...');
                        if (typeof socket !== 'undefined' && socket.connected) {
                            socket.emit('get_active_streams');
                            socket.emit('join_streams_lobby');
                        } else {
                            console.log('âš ï¸ Ø§Ù„Ø³ÙˆÙƒØª ØºÙŠØ± Ù…ØªØµÙ„ØŒ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©...');
                            setTimeout(loadActiveStreams, 1000);
                        }
                    }
                    
                    let pendingStreamSnapshot = null;
                    
                    function watchGame(gameId) {
                        watchingGameId = gameId;
                        pendingStreamSnapshot = null;
                        
                        if (typeof resetViewerBoard === 'function') {
                            resetViewerBoard();
                        }
                        
                        document.getElementById('streams-list-view').style.display = 'none';
                        document.getElementById('viewer-game-view').style.display = 'block';
                        
                        setTimeout(() => {
                            if (typeof socket !== 'undefined') {
                                socket.emit('watch_ludo_game', { game_id: gameId });
                                initViewerAudio(gameId);
                            }
                        }, 150);
                        console.log('ğŸ¥ Ø¨Ø¯Ø¡ Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©:', gameId);
                    }
                    
                    function exitWatching() {
                        if (watchingGameId && typeof socket !== 'undefined') {
                            socket.emit('leave_ludo_stream', { game_id: watchingGameId });
                        }
                        watchingGameId = null;
                        pendingStreamSnapshot = null;
                        
                        cleanupViewerAudio();
                        resetViewerBoard();
                        
                        document.getElementById('streams-list-view').style.display = 'block';
                        document.getElementById('viewer-game-view').style.display = 'none';
                        loadActiveStreams();
                    }
                    
                    function resetViewerBoard() {
                        // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ
                        stopViewerCountdown();
                        
                        // Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
                        viewerPreviousPositions.green = [0, 0, 0, 0];
                        viewerPreviousPositions.blue = [0, 0, 0, 0];
                        
                        // Ø¥Ø²Ø§Ù„Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø­Ø¬Ø§Ø± Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø±
                        document.querySelectorAll('#viewer-ludo-board .viewer-cell .viewer-token').forEach(t => t.remove());
                        
                        // Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø¸Ù‡Ø§Ø± Ø£Ø­Ø¬Ø§Ø± Ø§Ù„Ø¨ÙŠØª
                        document.querySelectorAll('#viewer-ludo-board .viewer-player-home .viewer-token').forEach(token => {
                            token.style.display = 'block';
                            token.style.opacity = '1';
                            token.classList.remove('on-board');
                        });
                        
                        // Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ù†Ø±Ø¯
                        const dice = document.getElementById('viewerDice');
                        if (dice) {
                            dice.style.transition = 'none';
                            dice.style.transform = 'translateZ(0) rotateX(0deg) rotateY(0deg)';
                        }
                        
                        console.log('ğŸ“ºğŸ”„ ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯');
                    }
                    
                    function handleActiveStreamsList(data) {
                        console.log('ğŸ“º ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¨Ø«ÙˆØ«:', data);
                        const container = document.getElementById('active-streams-list');
                        const noStreamsMsg = document.getElementById('no-streams-msg');
                        
                        if (!container || !noStreamsMsg) {
                            console.log('âš ï¸ Ø¹Ù†Ø§ØµØ± ØµÙØ­Ø© Ø§Ù„Ø¨Ø« ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
                            return;
                        }
                        
                        if (!data.streams || data.streams.length === 0) {
                            console.log('ğŸ“º Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø«ÙˆØ« Ù†Ø´Ø·Ø©');
                            container.innerHTML = '';
                            noStreamsMsg.style.display = 'block';
                            return;
                        }
                        
                        console.log('ğŸ“º Ø¹Ø¯Ø¯ Ø§Ù„Ø¨Ø«ÙˆØ«:', data.streams.length);
                        noStreamsMsg.style.display = 'none';
                        container.innerHTML = data.streams.map(s => `
                            <div class="stream-card" onclick="watchGame(${s.game_id})">
                                <div>
                                    <span class="live-badge">ğŸ”´ LIVE</span>
                                    <div class="players-info" style="margin-top: 8px;">${s.player1_name} vs ${s.player2_name}</div>
                                </div>
                                <div style="text-align: right;">
                                    <div class="bet-info">ğŸ’° ${s.bet_amount}$</div>
                                    <div class="viewers-info">ğŸ‘¤ ${s.viewer_count}</div>
                                </div>
                            </div>
                        `).join('');
                    }
                    
                    function handleLudoStreamSnapshot(data) {
                        console.log('ğŸ“ºğŸ“¸ Ø§Ø³ØªÙ„Ø§Ù… Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©:', data);
                        
                        // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù„Ø§Ø­Ù‚Ø§Ù‹
                        pendingStreamSnapshot = data;
                        
                        // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø©
                        applyStreamSnapshot(data);
                    }
                    
                    function applyStreamSnapshot(data) {
                        if (!data) return;
                        
                        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¬Ø§Ù‡Ø²ÙŠØ© DOM
                        const viewerBoard = document.getElementById('viewer-ludo-board');
                        if (!viewerBoard || viewerBoard.offsetParent === null) {
                            console.log('ğŸ“ºâ³ DOM ØºÙŠØ± Ø¬Ø§Ù‡Ø²ØŒ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©...');
                            setTimeout(() => applyStreamSnapshot(data), 50);
                            return;
                        }
                        
                        console.log('ğŸ“ºâœ… ØªØ·Ø¨ÙŠÙ‚ Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© Ù„Ù„Ù…Ø´Ø§Ù‡Ø¯');
                        
                        const p1Name = document.getElementById('viewer-player1-name');
                        const p2Name = document.getElementById('viewer-player2-name');
                        const betAmount = document.getElementById('viewer-bet-amount');
                        const viewerCount = document.getElementById('viewer-count-display');
                        
                        if (p1Name) p1Name.textContent = data.player1_name;
                        if (p2Name) p2Name.textContent = data.player2_name;
                        if (betAmount) betAmount.textContent = data.bet_amount;
                        if (viewerCount) viewerCount.textContent = 'ğŸ‘¤ ' + data.viewer_count;
                        
                        updateViewerTurnIndicator(data.current_turn, data.time_left || 30);
                        
                        if (data.last_roll) {
                            const diceValue = document.getElementById('viewer-dice-value');
                            if (diceValue) diceValue.textContent = data.last_roll;
                            setViewerDiceToResult(data.last_roll);
                        }
                        
                        if (data.player1_position && data.player2_position) {
                            const player1Pos = typeof data.player1_position === 'string' ? JSON.parse(data.player1_position) : data.player1_position;
                            const player2Pos = typeof data.player2_position === 'string' ? JSON.parse(data.player2_position) : data.player2_position;
                            
                            console.log('ğŸ“ºğŸ“ ØªÙ‡ÙŠØ¦Ø© Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ - Ø£Ø®Ø¶Ø±:', player1Pos.green, 'Ø£Ø²Ø±Ù‚:', player2Pos.blue);
                            
                            viewerPreviousPositions.green = [...(player1Pos.green || [0,0,0,0])];
                            viewerPreviousPositions.blue = [...(player2Pos.blue || [0,0,0,0])];
                            
                            updateViewerPiecesForColor('green', player1Pos.green || [0,0,0,0]);
                            updateViewerPiecesForColor('blue', player2Pos.blue || [0,0,0,0]);
                        }
                        
                        console.log('ğŸ“ºâœ… ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¨Ù†Ø¬Ø§Ø­');
                    }
                    
                    function setViewerDiceToResult(result) {
                        const dice = document.getElementById('viewerDice');
                        if (!dice) return;
                        
                        const baseDiceRotations = {
                            1: { x: 0, y: 0 },
                            2: { x: 90, y: 0 },
                            3: { x: 0, y: -90 },
                            4: { x: 0, y: 90 },
                            5: { x: -90, y: 0 },
                            6: { x: 0, y: 180 }
                        };
                        
                        const base = baseDiceRotations[result] || baseDiceRotations[1];
                        dice.style.transition = 'none';
                        dice.style.transform = `translateZ(0) rotateX(${base.x}deg) rotateY(${base.y}deg)`;
                    }
                    
                    function handleLudoUpdateForViewer(data) {
                        // Ù…Ù‚Ø§Ø±Ù†Ø© game_id ÙƒØ£Ø±Ù‚Ø§Ù… Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ØªØ·Ø§Ø¨Ù‚
                        const dataGameId = parseInt(data.game_id);
                        const currentWatching = parseInt(watchingGameId);
                        
                        console.log('ğŸ“ºğŸ” ÙØ­Øµ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯:', {
                            type: data.type,
                            dataGameId: dataGameId,
                            watchingGameId: currentWatching,
                            match: dataGameId === currentWatching
                        });
                        
                        if (currentWatching && dataGameId === currentWatching) {
                            console.log('ğŸ“ºğŸ“Š ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯:', data.type, data);
                            
                            if (data.type === 'dice_roll') {
                                console.log('ğŸ“ºğŸ² Ø±Ù…ÙŠ Ø§Ù„Ù†Ø±Ø¯ Ù„Ù„Ù…Ø´Ø§Ù‡Ø¯:', data.roll);
                                animateViewerDice(data.roll);
                                updateViewerTurnIndicator(data.current_turn, data.time_left || 30);
                            } else if (data.type === 'piece_move') {
                                console.log('ğŸ“ºğŸƒ Ø­Ø±ÙƒØ© Ø­Ø¬Ø± Ù„Ù„Ù…Ø´Ø§Ù‡Ø¯ - Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©:', JSON.stringify(viewerPreviousPositions));
                                syncViewerPieces(data.player1_position, data.player2_position);
                                updateViewerTurnIndicator(data.current_turn, data.time_left || 30);
                            } else if (data.type === 'turn_change') {
                                console.log('ğŸ“ºğŸ”„ ØªØºÙŠÙŠØ± Ø¯ÙˆØ± Ù„Ù„Ù…Ø´Ø§Ù‡Ø¯:', data.current_turn, 'Ø§Ù„ÙˆÙ‚Øª:', data.time_left);
                                updateViewerTurnIndicator(data.current_turn, data.time_left || 30);
                            } else if (data.type === 'game_over') {
                                stopViewerCountdown();
                                alert('Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©! Ø§Ù„ÙØ§Ø¦Ø²: ' + (data.winner_id === data.player1_id ? 'Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø£Ø®Ø¶Ø±' : 'Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø£Ø²Ø±Ù‚'));
                                exitWatching();
                            }
                        }
                    }
                    
                    function handleStreamEnded(data) {
                        if (watchingGameId && data.game_id === watchingGameId) {
                            stopViewerCountdown();
                            
                            let overlay = document.createElement('div');
                            overlay.id = 'streamEndedOverlay';
                            overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 99999;';
                            overlay.innerHTML = `
                                <div style="background: linear-gradient(135deg, #e11d48, #be123c); padding: 30px 50px; border-radius: 20px; text-align: center; animation: fadeIn 0.3s ease;">
                                    <div style="font-size: 50px; margin-bottom: 15px;">ğŸ“º</div>
                                    <div style="color: white; font-size: 24px; font-weight: bold; margin-bottom: 10px;">ØªÙ… Ù‚Ø·Ø¹ Ø§Ù„Ø¨Ø«</div>
                                    <div style="color: rgba(255,255,255,0.8); font-size: 16px;">Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯ØªÙƒ Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¨Ø«ÙˆØ«...</div>
                                </div>
                            `;
                            document.body.appendChild(overlay);
                            
                            setTimeout(() => {
                                if (document.getElementById('streamEndedOverlay')) {
                                    document.getElementById('streamEndedOverlay').remove();
                                }
                                watchingGameId = null;
                                document.getElementById('streams-list-view').style.display = 'block';
                                document.getElementById('viewer-game-view').style.display = 'none';
                                loadActiveStreams();
                            }, 3000);
                        }
                    }
                    
                    function handleStreamViewerUpdate(data) {
                        if (watchingGameId === data.game_id) {
                            document.getElementById('viewer-count-display').textContent = 'ğŸ‘¤ ' + data.viewer_count;
                        }
                    }
                    
                    // === Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙˆØª Ù„Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ† ===
                    let viewerPeerConnections = {};
                    let viewerAudioMuted = false;
                    
                    const viewerIceConfiguration = {
                        iceServers: [
                            { urls: 'stun:stun.l.google.com:19302' },
                            { urls: 'stun:stun1.l.google.com:19302' }
                        ]
                    };
                    
                    function initViewerAudio(gameId) {
                        console.log('ğŸ”Š ØªÙ‡ÙŠØ¦Ø© ØµÙˆØª Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ Ù„Ù„Ø¹Ø¨Ø©:', gameId);
                        
                        if (typeof socket !== 'undefined') {
                            socket.emit('viewer_request_audio', { game_id: gameId });
                        }
                        
                        document.getElementById('viewerAudioToggle').style.display = 'inline-block';
                    }
                    
                    function toggleViewerAudio() {
                        viewerAudioMuted = !viewerAudioMuted;
                        const btn = document.getElementById('viewerAudioToggle');
                        const audio1 = document.getElementById('viewerRemoteAudio1');
                        const audio2 = document.getElementById('viewerRemoteAudio2');
                        
                        if (viewerAudioMuted) {
                            btn.textContent = 'ğŸ”‡ ØµØ§Ù…Øª';
                            btn.style.background = '#dc2626';
                            if (audio1) audio1.muted = true;
                            if (audio2) audio2.muted = true;
                        } else {
                            btn.textContent = 'ğŸ”Š Ø§Ù„ØµÙˆØª';
                            btn.style.background = '#22c55e';
                            if (audio1) audio1.muted = false;
                            if (audio2) audio2.muted = false;
                        }
                    }
                    
                    async function handleViewerAudioOffer(data) {
                        const playerId = data.player_id;
                        const gameId = data.game_id;
                        
                        if (parseInt(gameId) !== parseInt(watchingGameId)) return;
                        
                        console.log('ğŸ¤ Ø§Ø³ØªÙ„Ø§Ù… Ø¹Ø±Ø¶ ØµÙˆØª Ù…Ù† Ø§Ù„Ù„Ø§Ø¹Ø¨:', playerId);
                        
                        try {
                            const pc = new RTCPeerConnection(viewerIceConfiguration);
                            viewerPeerConnections[playerId] = pc;
                            
                            pc.ontrack = (event) => {
                                console.log('ğŸ”Š ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ù…Ø³Ø§Ø± ØµÙˆØªÙŠ Ù…Ù† Ø§Ù„Ù„Ø§Ø¹Ø¨:', playerId);
                                const audioElement = playerId === 'player1' ? 
                                    document.getElementById('viewerRemoteAudio1') : 
                                    document.getElementById('viewerRemoteAudio2');
                                if (audioElement && event.streams[0]) {
                                    audioElement.srcObject = event.streams[0];
                                    audioElement.play().catch(e => console.log('ØªØ´ØºÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ:', e));
                                }
                            };
                            
                            pc.onicecandidate = (event) => {
                                if (event.candidate) {
                                    socket.emit('viewer_ice_candidate', {
                                        game_id: gameId,
                                        candidate: event.candidate,
                                        player_id: playerId
                                    });
                                }
                            };
                            
                            await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
                            const answer = await pc.createAnswer();
                            await pc.setLocalDescription(answer);
                            
                            socket.emit('viewer_audio_answer', {
                                game_id: gameId,
                                answer: answer,
                                player_id: playerId
                            });
                            
                            console.log('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø¬Ø§Ø¨Ø© ØµÙˆØª Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯');
                        } catch (e) {
                            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØª:', e);
                        }
                    }
                    
                    function handleViewerIceCandidate(data) {
                        const pc = viewerPeerConnections[data.player_id];
                        if (pc && data.candidate) {
                            pc.addIceCandidate(new RTCIceCandidate(data.candidate))
                                .catch(e => console.log('Ø®Ø·Ø£ ICE:', e));
                        }
                    }
                    
                    function cleanupViewerAudio() {
                        Object.values(viewerPeerConnections).forEach(pc => {
                            try { pc.close(); } catch(e) {}
                        });
                        viewerPeerConnections = {};
                        
                        const audio1 = document.getElementById('viewerRemoteAudio1');
                        const audio2 = document.getElementById('viewerRemoteAudio2');
                        if (audio1) audio1.srcObject = null;
                        if (audio2) audio2.srcObject = null;
                        
                        document.getElementById('viewerAudioToggle').style.display = 'none';
                    }
                    
                    let viewerCountdownInterval = null;
                    let viewerTimeLeft = 30;
                    let viewerCurrentTurn = 1;
                    
                    function updateViewerTurnIndicator(currentTurn, timeLeft = 30) {
                        viewerCurrentTurn = currentTurn;
                        const playerColor = currentTurn === 1 ? 'green' : 'blue';
                        updateViewerDiceColor(playerColor);
                        startViewerCountdown(timeLeft, playerColor);
                    }
                    
                    function startViewerCountdown(timeLeft, playerColor) {
                        if (viewerCountdownInterval) {
                            clearInterval(viewerCountdownInterval);
                        }
                        
                        viewerTimeLeft = timeLeft || 30;
                        updateViewerTimerRing(playerColor, viewerTimeLeft);
                        
                        viewerCountdownInterval = setInterval(() => {
                            viewerTimeLeft--;
                            if (viewerTimeLeft <= 0) {
                                viewerTimeLeft = 0;
                                clearInterval(viewerCountdownInterval);
                                
                                const newTurn = viewerCurrentTurn === 1 ? 2 : 1;
                                viewerCurrentTurn = newTurn;
                                const newPlayerColor = newTurn === 1 ? 'green' : 'blue';
                                
                                updateViewerDiceColor(newPlayerColor);
                                
                                document.querySelectorAll('#viewer-ludo-board .viewer-turn-timer-ring').forEach(ring => {
                                    ring.classList.remove('active');
                                    const circle = ring.querySelector('circle');
                                    if (circle) {
                                        circle.classList.remove('warning');
                                        circle.style.stroke = '#000';
                                    }
                                });
                                
                                startViewerCountdown(30, newPlayerColor);
                                return;
                            }
                            updateViewerTimerRing(playerColor, viewerTimeLeft);
                        }, 1000);
                    }
                    
                    function updateViewerTimerRing(playerColor, timeLeft) {
                        document.querySelectorAll('#viewer-ludo-board .viewer-turn-timer-ring').forEach(ring => {
                            ring.classList.remove('active');
                        });
                        
                        const timerRing = document.querySelector(`#viewer-ludo-board .viewer-turn-timer-ring[data-player="${playerColor}"]`);
                        if (timerRing) {
                            timerRing.classList.add('active');
                            const circle = timerRing.querySelector('circle');
                            if (circle) {
                                const circumference = 2 * Math.PI * 43;
                                const progress = Math.max(0, timeLeft / 30);
                                const dashOffset = circumference * (1 - progress);
                                circle.style.strokeDasharray = `${circumference} ${circumference}`;
                                circle.style.strokeDashoffset = -dashOffset;
                                
                                if (timeLeft <= 5) {
                                    circle.classList.add('warning');
                                    circle.style.stroke = 'rgba(239, 68, 68, 0.9)';
                                } else {
                                    circle.classList.remove('warning');
                                    circle.style.stroke = '#000';
                                }
                            }
                        }
                    }
                    
                    function stopViewerCountdown() {
                        if (viewerCountdownInterval) {
                            clearInterval(viewerCountdownInterval);
                            viewerCountdownInterval = null;
                        }
                    }
                    
                    function updateViewerDiceColor(playerColor) {
                        const viewerDice = document.getElementById('viewerDice');
                        if (!viewerDice) {
                            console.log('ğŸ“ºâŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø±Ø¯');
                            return;
                        }
                        
                        console.log('ğŸ“ºğŸ² ØªØºÙŠÙŠØ± Ù„ÙˆÙ† Ø§Ù„Ù†Ø±Ø¯ Ø¥Ù„Ù‰:', playerColor);
                        
                        viewerDice.classList.remove('green-player', 'blue-player');
                        
                        if (playerColor === 'green') {
                            viewerDice.classList.add('green-player');
                        } else {
                            viewerDice.classList.add('blue-player');
                        }
                    }
                    
                    function animateViewerDice(result) {
                        const dice = document.getElementById('viewerDice');
                        if (!dice) return;
                        
                        const baseDiceRotations = {
                            1: { x: 0, y: 0 },
                            2: { x: 90, y: 0 },
                            3: { x: 0, y: -90 },
                            4: { x: 0, y: 90 },
                            5: { x: -90, y: 0 },
                            6: { x: 0, y: 180 }
                        };
                        
                        const base = baseDiceRotations[result] || baseDiceRotations[1];
                        const spins = 20;
                        
                        const finalX = base.x + (spins * 360);
                        const finalY = base.y + (spins * 360);
                        const finalZ = spins * 360;
                        
                        dice.style.willChange = 'transform';
                        dice.style.transition = 'none';
                        dice.style.transform = 'translateZ(0) rotateX(0deg) rotateY(0deg) rotateZ(0deg)';
                        
                        requestAnimationFrame(() => {
                            dice.style.transition = 'transform 1500ms linear';
                            dice.style.transform = `translateZ(0) rotateX(${finalX}deg) rotateY(${finalY}deg) rotateZ(${finalZ}deg)`;
                        });
                        
                        setTimeout(() => {
                            dice.style.transition = 'none';
                            dice.style.transform = `translateZ(0) rotateX(${base.x}deg) rotateY(${base.y}deg)`;
                            dice.style.willChange = 'auto';
                        }, 1500);
                    }
                    
                    let viewerPreviousPositions = { green: [0,0,0,0], blue: [0,0,0,0] };
                    let viewerAnimationInProgress = false;
                    
                    function syncViewerPieces(p1Pos, p2Pos) {
                        try {
                            const player1Pos = typeof p1Pos === 'string' ? JSON.parse(p1Pos) : p1Pos;
                            const player2Pos = typeof p2Pos === 'string' ? JSON.parse(p2Pos) : p2Pos;
                            
                            const newGreenPos = player1Pos.green || [0,0,0,0];
                            const newBluePos = player2Pos.blue || [0,0,0,0];
                            
                            if (player1Pos.green) {
                                animateViewerPiecesForColor('green', viewerPreviousPositions.green, newGreenPos);
                                viewerPreviousPositions.green = [...newGreenPos];
                            }
                            if (player2Pos.blue) {
                                animateViewerPiecesForColor('blue', viewerPreviousPositions.blue, newBluePos);
                                viewerPreviousPositions.blue = [...newBluePos];
                            }
                            
                            updateViewerProgress('green', newGreenPos);
                            updateViewerProgress('blue', newBluePos);
                        } catch(e) {
                            console.log('Ø®Ø·Ø£ ÙÙŠ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù‚Ø·Ø¹:', e);
                        }
                    }
                    
                    function animateViewerPiecesForColor(color, oldPositions, newPositions) {
                        console.log(`ğŸ“ºğŸ¯ animateViewerPiecesForColor: ${color}`, 'Ù‚Ø¯ÙŠÙ…:', oldPositions, 'Ø¬Ø¯ÙŠØ¯:', newPositions);
                        for (let i = 0; i < 4; i++) {
                            const oldPos = oldPositions[i] || 0;
                            const newPos = newPositions[i] || 0;
                            
                            if (oldPos !== newPos && newPos > oldPos) {
                                console.log(`ğŸ“ºğŸ¬ ØªØ­Ø±ÙŠÙƒ Ø­Ø¬Ø± ${color} Ø±Ù‚Ù… ${i}: ${oldPos} â†’ ${newPos}`);
                                animateViewerPieceMovement(color, i, oldPos, newPos);
                            } else if (oldPos !== newPos) {
                                console.log(`ğŸ“ºğŸ“ ÙˆØ¶Ø¹ Ø­Ø¬Ø± ${color} Ø±Ù‚Ù… ${i} Ù…Ø¨Ø§Ø´Ø±Ø©: ${newPos}`);
                                placeViewerPieceAt(color, i, newPos);
                            }
                        }
                    }
                    
                    function animateViewerPieceMovement(color, pieceIndex, fromStep, toStep) {
                        console.log(`ğŸ¬ ØªØ­Ø±ÙŠÙƒ Ø­Ø¬Ø± Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯: ${color} Ø±Ù‚Ù… ${pieceIndex} Ù…Ù† ${fromStep} Ø¥Ù„Ù‰ ${toStep}`);
                        
                        const viewerPath = getViewerPlayerPath(color);
                        let currentStep = fromStep;
                        
                        const homeTokens = document.querySelectorAll(`#viewer-ludo-board .viewer-player-home.${color} .viewer-token`);
                        const homeToken = homeTokens[pieceIndex];
                        
                        document.querySelectorAll(`#viewer-ludo-board .viewer-token.${color}[data-piece-index="${pieceIndex}"].on-board`).forEach(t => t.remove());
                        
                        if (homeToken) {
                            homeToken.style.display = 'none';
                        }
                        
                        const movingToken = document.createElement('div');
                        movingToken.className = `viewer-token ${color} on-board`;
                        movingToken.setAttribute('data-piece-index', pieceIndex);
                        movingToken.style.boxShadow = '0 0 8px rgba(255,255,255,0.5), 0 2px 6px rgba(0,0,0,0.4)';
                        movingToken.style.position = 'absolute';
                        movingToken.style.top = '50%';
                        movingToken.style.left = '50%';
                        movingToken.style.transform = 'translate(-50%, -50%)';
                        movingToken.style.zIndex = '100';
                        
                        if (fromStep > 0 && fromStep <= viewerPath.length) {
                            const startCell = viewerPath[fromStep - 1];
                            if (startCell) {
                                startCell.style.position = 'relative';
                                startCell.appendChild(movingToken);
                            }
                        }
                        
                        const moveOneStep = () => {
                            currentStep++;
                            
                            if (currentStep > toStep) {
                                console.log(`âœ… Ø§ÙƒØªÙ…Ù„ ØªØ­Ø±ÙŠÙƒ Ø­Ø¬Ø± Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯: ${color} Ø±Ù‚Ù… ${pieceIndex}`);
                                return;
                            }
                            
                            if (currentStep > 0 && currentStep <= viewerPath.length) {
                                const targetCell = viewerPath[currentStep - 1];
                                
                                if (targetCell === null) {
                                    console.log(`ğŸ† Ø­Ø¬Ø± Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ ÙˆØµÙ„ Ù„Ù„Ù…Ø±ÙƒØ² ÙˆØ§Ø®ØªÙÙ‰: ${color} Ø±Ù‚Ù… ${pieceIndex}`);
                                    if (movingToken.parentElement) {
                                        movingToken.remove();
                                    }
                                    return;
                                }
                                
                                if (targetCell) {
                                    if (movingToken.parentElement) {
                                        movingToken.remove();
                                    }
                                    targetCell.style.position = 'relative';
                                    targetCell.appendChild(movingToken);
                                }
                            }
                            
                            if (currentStep < toStep) {
                                setTimeout(moveOneStep, 130);
                            }
                        };
                        
                        setTimeout(moveOneStep, 130);
                    }
                    
                    function placeViewerPieceAt(color, pieceIndex, position) {
                        const viewerPath = getViewerPlayerPath(color);
                        const homeTokens = document.querySelectorAll(`#viewer-ludo-board .viewer-player-home.${color} .viewer-token`);
                        const homeToken = homeTokens[pieceIndex];
                        
                        document.querySelectorAll(`#viewer-ludo-board .viewer-token.${color}[data-piece-index="${pieceIndex}"].on-board`).forEach(t => t.remove());
                        
                        if (position === 0 || position === -1) {
                            if (homeToken) {
                                homeToken.style.display = 'block';
                                homeToken.style.opacity = '1';
                            }
                        } else if (position >= 58) {
                            if (homeToken) homeToken.style.display = 'none';
                            console.log(`ğŸ† Ø­Ø¬Ø± Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ ÙÙŠ Ø§Ù„Ù…Ø±ÙƒØ² - Ù…Ø®ÙÙŠ: ${color} Ø±Ù‚Ù… ${pieceIndex}`);
                        } else if (position > 0 && position < 58) {
                            if (homeToken) homeToken.style.display = 'none';
                            const targetCell = viewerPath[position - 1];
                            if (targetCell) {
                                const boardToken = document.createElement('div');
                                boardToken.className = `viewer-token ${color} on-board`;
                                boardToken.setAttribute('data-piece-index', pieceIndex);
                                boardToken.style.boxShadow = '0 0 8px rgba(255,255,255,0.5), 0 2px 6px rgba(0,0,0,0.4)';
                                targetCell.style.position = 'relative';
                                targetCell.appendChild(boardToken);
                            }
                        }
                    }
                    
                    function getViewerAllPathCells() {
                        const topCells = Array.from(document.querySelectorAll('#viewer-ludo-board .viewer-path-container.top .viewer-cell'));
                        const rightCells = Array.from(document.querySelectorAll('#viewer-ludo-board .viewer-path-container.right .viewer-cell'));
                        const bottomCells = Array.from(document.querySelectorAll('#viewer-ludo-board .viewer-path-container.bottom .viewer-cell'));
                        const leftCells = Array.from(document.querySelectorAll('#viewer-ludo-board .viewer-path-container.left .viewer-cell'));
                        return [...topCells, ...rightCells, ...bottomCells, ...leftCells];
                    }
                    
                    function getViewerCellByNumber(cellNum) {
                        const allCells = getViewerAllPathCells();
                        return allCells[cellNum];
                    }
                    
                    function getViewerPlayerPath(player) {
                        if (player === 'blue') {
                            const bluePath = [
                                50, 47, 44, 41, 38, 30, 31, 32, 33, 34, 35, 29, 23, 22, 21, 20, 
                                19, 18, 17, 14, 11, 8, 5, 2, 1, 0, 3, 6, 9, 12, 15, 59, 58, 57, 
                                56, 55, 54, 60, 66, 67, 68, 69, 70, 71, 36, 39, 42, 45, 48, 51, 
                                52, 53, 49, 46, 43, 40, 37, null
                            ];
                            return bluePath.map(cellNum => cellNum === null ? null : getViewerCellByNumber(cellNum));
                        } else if (player === 'green') {
                            const GREEN_MAIN_LOOP = [
                                3, 6, 9, 12, 15, 59, 58, 57, 56, 55, 54, 60, 66, 67, 68, 69, 70, 71, 
                                36, 39, 42, 45, 48, 51, 52, 53, 50, 47, 44, 41, 38, 30, 31, 32, 33, 34, 35, 
                                29, 23, 22, 21, 20, 19, 18, 17, 14, 11, 8, 5, 2, 1, 0
                            ];
                            const GREEN_HOME_RUN = [4, 7, 10, 13, 16, null];
                            const fullGreenPath = [...GREEN_MAIN_LOOP, ...GREEN_HOME_RUN];
                            return fullGreenPath.map(cellNum => cellNum === null ? null : getViewerCellByNumber(cellNum));
                        }
                        return [];
                    }
                    
                    function updateViewerPiecesForColor(color, positions) {
                        const viewerPath = getViewerPlayerPath(color);
                        const homeTokens = document.querySelectorAll(`#viewer-ludo-board .viewer-player-home.${color} .viewer-token`);
                        
                        document.querySelectorAll(`#viewer-ludo-board .viewer-cell .viewer-token.${color}`).forEach(t => t.remove());
                        const goldenRing = document.querySelector('#viewer-ludo-board .viewer-golden-ring');
                        if (goldenRing) {
                            goldenRing.querySelectorAll(`.viewer-token.${color}`).forEach(t => t.remove());
                        }
                        
                        homeTokens.forEach((token, idx) => {
                            token.style.display = 'block';
                            token.style.opacity = '1';
                            token.classList.remove('on-board');
                        });
                        
                        const cellTokenCounts = {};
                        let centerTokenCount = 0;
                        
                        positions.forEach((pos, idx) => {
                            const homeToken = homeTokens[idx];
                            if (!homeToken) return;
                            
                            if (pos === 0 || pos === -1) {
                                homeToken.style.display = 'block';
                                homeToken.style.opacity = '1';
                            } else if (pos >= 58) {
                                homeToken.style.display = 'none';
                                console.log(`ğŸ† Ø­Ø¬Ø± Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ ÙÙŠ Ø§Ù„Ù…Ø±ÙƒØ² - Ù…Ø®ÙÙŠ: ${color} Ø±Ù‚Ù… ${idx}`);
                            } else if (pos > 0 && pos < 58) {
                                homeToken.style.display = 'none';
                                const targetCell = viewerPath[pos - 1];
                                if (targetCell) {
                                    const cellKey = pos;
                                    cellTokenCounts[cellKey] = (cellTokenCounts[cellKey] || 0);
                                    const stackOffset = cellTokenCounts[cellKey] * 3;
                                    
                                    const boardToken = document.createElement('div');
                                    boardToken.className = `viewer-token ${color} on-board`;
                                    boardToken.setAttribute('data-piece-index', idx);
                                    boardToken.style.boxShadow = '0 0 8px rgba(255,255,255,0.5), 0 2px 6px rgba(0,0,0,0.4)';
                                    boardToken.style.transform = `translate(calc(-50% + ${stackOffset}px), calc(-50% + ${stackOffset}px))`;
                                    boardToken.style.zIndex = 100 + cellTokenCounts[cellKey];
                                    targetCell.style.position = 'relative';
                                    targetCell.appendChild(boardToken);
                                    cellTokenCounts[cellKey]++;
                                }
                            }
                        });
                    }
                    
                    function updateViewerProgress(color, positions) {
                        const progressEl = document.getElementById(`viewer-${color}-progress`);
                        if (!progressEl) return;
                        
                        let totalProgress = 0;
                        positions.forEach(pos => {
                            if (pos >= 57) totalProgress += 25;
                            else if (pos > 0) totalProgress += Math.min(24, Math.floor(pos / 57 * 24));
                        });
                        progressEl.textContent = Math.min(100, totalProgress) + '%';
                    }
                    
                    if (typeof showPage !== 'undefined') {
                        const originalShowPage = showPage;
                        showPage = function(page) {
                            originalShowPage(page);
                            if (page === 'live') {
                                loadActiveStreams();
                            } else if (watchingGameId) {
                                exitWatching();
                            }
                        };
                    }
                    
                    window.addEventListener('beforeunload', function() {
                        if (watchingGameId && typeof socket !== 'undefined') {
                            socket.emit('leave_ludo_stream', { game_id: watchingGameId });
                        }
                    });
                    
                    window.addEventListener('pagehide', function() {
                        if (watchingGameId && typeof socket !== 'undefined') {
                            socket.emit('leave_ludo_stream', { game_id: watchingGameId });
                        }
                    });
                    
                    // ======== Ù†Ø¸Ø§Ù… Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ù„Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± ========
                    let viewerUserBalance = {{ user['balance'] }};
                    let currentWatchingGameId = null;
                    let activeGiftNotifications = [];
                    const MAX_VISIBLE_GIFTS = 5;
                    let giftCounters = {};
                    
                    function toggleGiftSheet() {
                        const sheet = document.getElementById('gift-bottom-sheet');
                        if (sheet) {
                            sheet.classList.toggle('show');
                        }
                    }
                    
                    function showGiftCategory(category, btn) {
                        document.querySelectorAll('.gift-tab').forEach(t => t.classList.remove('active'));
                        btn.classList.add('active');
                        document.querySelectorAll('.gift-item').forEach(item => {
                            if (category === 'all' || item.dataset.category === category) {
                                item.style.display = 'block';
                            } else {
                                item.style.display = 'none';
                            }
                        });
                    }
                    
                    let selectedGiftData = null;
                    
                    function selectGiftItem(element, giftId, emoji, name, price) {
                        document.querySelectorAll('.gift-item').forEach(item => item.classList.remove('selected'));
                        element.classList.add('selected');
                        selectedGiftData = { giftId, emoji, name, price, element };
                    }
                    
                    function sendSelectedGift(btnElement) {
                        if (!selectedGiftData) return;
                        
                        const { giftId, emoji, name, price } = selectedGiftData;
                        
                        if (price > viewerUserBalance) {
                            document.getElementById('giftInsufficientBalanceModal').classList.add('show');
                            return;
                        }
                        if (!watchingGameId) {
                            console.log('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨Ø« Ù„Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©');
                            return;
                        }
                        
                        btnElement.textContent = 'ØªÙ… âœ“';
                        btnElement.classList.add('sent');
                        
                        socket.emit('send_stream_gift', {
                            game_id: watchingGameId,
                            gift_id: giftId,
                            gift_emoji: emoji,
                            gift_name: name,
                            gift_price: price
                        });
                        
                        setTimeout(() => {
                            btnElement.textContent = 'Ø¥Ø±Ø³Ø§Ù„';
                            btnElement.classList.remove('sent');
                        }, 800);
                    }
                    
                    function selectGift(giftId, emoji, name, price) {
                        if (price > viewerUserBalance) {
                            document.getElementById('giftInsufficientBalanceModal').classList.add('show');
                            return;
                        }
                        if (!watchingGameId) {
                            console.log('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨Ø« Ù„Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©');
                            return;
                        }
                        socket.emit('send_stream_gift', {
                            game_id: watchingGameId,
                            gift_id: giftId,
                            gift_emoji: emoji,
                            gift_name: name,
                            gift_price: price
                        });
                        toggleGiftSheet();
                    }
                    
                    function closeGiftModal() {
                        document.getElementById('giftInsufficientBalanceModal').classList.remove('show');
                    }
                    
                    function goToDepositFromGift() {
                        closeGiftModal();
                        toggleGiftSheet();
                        if (typeof showPage === 'function') {
                            showPage('deposit');
                        }
                    }
                    
                    let messageCooldownTimer = null;
                    let messageCooldownEndTime = 0;
                    
                    function sendViewerMessage() {
                        const input = document.getElementById('viewer-message-input');
                        const sendBtn = document.querySelector('.send-message-btn');
                        
                        if (!input || !input.value.trim()) return;
                        
                        const now = Date.now();
                        if (now < messageCooldownEndTime) {
                            return;
                        }
                        
                        const message = input.value.trim().substring(0, 100);
                        
                        socket.emit('send_stream_message', {
                            game_id: watchingGameId,
                            message: message
                        });
                        
                        input.value = '';
                        startMessageCooldown(30);
                    }
                    
                    function startMessageCooldown(seconds) {
                        const sendBtn = document.querySelector('.send-message-btn');
                        const cooldownDisplay = document.getElementById('message-cooldown-display');
                        
                        messageCooldownEndTime = Date.now() + (seconds * 1000);
                        
                        if (messageCooldownTimer) clearInterval(messageCooldownTimer);
                        
                        updateCooldownDisplay();
                        messageCooldownTimer = setInterval(updateCooldownDisplay, 1000);
                    }
                    
                    function updateCooldownDisplay() {
                        const sendBtn = document.querySelector('.send-message-btn');
                        const cooldownDisplay = document.getElementById('message-cooldown-display');
                        const remaining = Math.max(0, Math.ceil((messageCooldownEndTime - Date.now()) / 1000));
                        
                        if (remaining > 0) {
                            if (sendBtn) sendBtn.disabled = true;
                            if (cooldownDisplay) {
                                cooldownDisplay.textContent = remaining + 's';
                                cooldownDisplay.style.display = 'block';
                            }
                        } else {
                            if (sendBtn) sendBtn.disabled = false;
                            if (cooldownDisplay) cooldownDisplay.style.display = 'none';
                            if (messageCooldownTimer) {
                                clearInterval(messageCooldownTimer);
                                messageCooldownTimer = null;
                            }
                        }
                    }
                    
                    function showViewerBetOptions() {
                        console.log('Ø¹Ø±Ø¶ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø±Ù‡Ø§Ù†');
                    }
                    
                    // ØªØ£Ø«ÙŠØ± Ù‡Ø¯ÙŠØ© Ø§Ù„Ø·Ø§Ø¦Ø±Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ Ù…Ø«Ù„ ØªÙŠÙƒ ØªÙˆÙƒ
                    function showPlaneGiftEffect(senderName) {
                        const overlay = document.createElement('div');
                        overlay.className = 'plane-gift-overlay';
                        overlay.id = 'planeGiftOverlay';
                        document.body.appendChild(overlay);
                        
                        const plane = document.createElement('div');
                        plane.className = 'flying-plane';
                        plane.textContent = 'âœˆï¸';
                        overlay.appendChild(plane);
                        
                        let trailInterval = setInterval(() => {
                            const planeRect = plane.getBoundingClientRect();
                            if (planeRect.left > window.innerWidth) {
                                clearInterval(trailInterval);
                                return;
                            }
                            
                            const trail = document.createElement('div');
                            trail.className = 'plane-trail';
                            trail.style.left = (planeRect.left - 100) + 'px';
                            trail.style.top = (planeRect.top + 40) + 'px';
                            overlay.appendChild(trail);
                            setTimeout(() => trail.remove(), 500);
                            
                            for (let i = 0; i < 3; i++) {
                                const sparkle = document.createElement('div');
                                sparkle.className = 'plane-sparkle';
                                sparkle.style.left = (planeRect.left - 20 + Math.random() * 40) + 'px';
                                sparkle.style.top = (planeRect.top + 20 + Math.random() * 40) + 'px';
                                overlay.appendChild(sparkle);
                                setTimeout(() => sparkle.remove(), 800);
                            }
                        }, 100);
                        
                        const giftText = document.createElement('div');
                        giftText.className = 'plane-gift-text';
                        giftText.innerHTML = `âœˆï¸ ${senderName} Ø£Ø±Ø³Ù„ Ø·Ø§Ø¦Ø±Ø©! âœˆï¸`;
                        overlay.appendChild(giftText);
                        
                        setTimeout(() => {
                            const colors = ['#ffd700', '#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#ff69b4', '#87ceeb'];
                            for (let i = 0; i < 30; i++) {
                                const confetti = document.createElement('div');
                                confetti.className = 'plane-confetti';
                                confetti.style.left = (30 + Math.random() * 40) + '%';
                                confetti.style.top = (20 + Math.random() * 20) + '%';
                                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                                confetti.style.animationDelay = (Math.random() * 0.5) + 's';
                                confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '2px';
                                overlay.appendChild(confetti);
                            }
                        }, 1500);
                        
                        setTimeout(() => {
                            clearInterval(trailInterval);
                            overlay.style.opacity = '0';
                            overlay.style.transition = 'opacity 0.5s';
                            setTimeout(() => overlay.remove(), 500);
                        }, 4000);
                    }
                    
                    function handleGiftReceived(data) {
                        const displayArea = document.getElementById('gift-display-area');
                        if (!displayArea) return;
                        
                        // ØªØ£Ø«ÙŠØ± Ø®Ø§Øµ Ù„Ù‡Ø¯ÙŠØ© Ø§Ù„Ø·Ø§Ø¦Ø±Ø©
                        if (data.gift_id === 'plane') {
                            showPlaneGiftEffect(data.sender_name);
                        }
                        
                        const senderKey = `${data.sender_id}_${data.gift_id}`;
                        const existingNotif = document.querySelector(`.gift-notification[data-sender-key="${senderKey}"]`);
                        
                        if (existingNotif && !existingNotif.classList.contains('hiding')) {
                            let counter = existingNotif.querySelector('.gift-counter');
                            if (counter) {
                                let count = parseInt(counter.textContent.replace('+', '')) || 1;
                                count++;
                                counter.textContent = '+' + count;
                                counter.classList.remove('gift-counter-pulse');
                                void counter.offsetWidth;
                                counter.classList.add('gift-counter-pulse');
                            } else {
                                counter = document.createElement('span');
                                counter.className = 'gift-counter gift-counter-pulse';
                                counter.textContent = '+2';
                                existingNotif.appendChild(counter);
                            }
                            clearTimeout(existingNotif._hideTimeout);
                            existingNotif._hideTimeout = setTimeout(() => hideGiftNotification(existingNotif), 5000);
                            return;
                        }
                        
                        while (activeGiftNotifications.length >= MAX_VISIBLE_GIFTS) {
                            const oldest = activeGiftNotifications.shift();
                            if (oldest && oldest.parentNode) {
                                oldest.classList.add('hiding');
                                setTimeout(() => oldest.remove(), 300);
                            }
                        }
                        
                        const notif = document.createElement('div');
                        notif.className = 'gift-notification';
                        notif.setAttribute('data-sender-key', senderKey);
                        notif.innerHTML = `
                            <span class="gift-sender">${data.sender_name}</span>
                            <span class="gift-action">Ø§Ø±Ø³Ù„</span>
                            <span class="gift-icon">${data.gift_emoji}</span>
                        `;
                        
                        displayArea.appendChild(notif);
                        activeGiftNotifications.push(notif);
                        
                        notif._hideTimeout = setTimeout(() => hideGiftNotification(notif), 5000);
                    }
                    
                    function hideGiftNotification(notif) {
                        if (!notif || !notif.parentNode) return;
                        notif.classList.add('hiding');
                        const idx = activeGiftNotifications.indexOf(notif);
                        if (idx > -1) activeGiftNotifications.splice(idx, 1);
                        setTimeout(() => {
                            if (notif.parentNode) notif.remove();
                        }, 300);
                    }
                    
                    
                    let activeStreamMessages = [];
                    const MAX_VISIBLE_MESSAGES = 6;
                    
                    function handleStreamMessage(data) {
                        const displayArea = document.getElementById('stream-message-display-area');
                        if (!displayArea) return;
                        
                        while (activeStreamMessages.length >= MAX_VISIBLE_MESSAGES) {
                            const oldest = activeStreamMessages.shift();
                            if (oldest && oldest.parentNode) {
                                oldest.classList.add('hiding');
                                setTimeout(() => { if (oldest.parentNode) oldest.remove(); }, 300);
                            }
                        }
                        
                        const msgEl = document.createElement('div');
                        msgEl.className = 'stream-message';
                        msgEl.innerHTML = `<span class="msg-text">${data.message}</span> <span class="msg-sender">${data.sender_name}</span>`;
                        
                        displayArea.appendChild(msgEl);
                        activeStreamMessages.push(msgEl);
                        
                        // Ø§Ø®ØªÙØ§Ø¡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†ÙŠ
                        setTimeout(() => {
                            if (msgEl && msgEl.parentNode) {
                                msgEl.classList.add('hiding');
                                const idx = activeStreamMessages.indexOf(msgEl);
                                if (idx > -1) activeStreamMessages.splice(idx, 1);
                                setTimeout(() => { if (msgEl.parentNode) msgEl.remove(); }, 300);
                            }
                        }, 5000);
                    }
                    
                    const originalWatchStream = typeof watchStream === 'function' ? watchStream : null;
                    if (originalWatchStream) {
                        window.watchStream = function(gameId) {
                            currentWatchingGameId = gameId;
                            originalWatchStream(gameId);
                        };
                    }
                    
                </script>
            </div>
        </div>
    </div>
    
    <style>
        /* Ø¨Ø¯ÙˆÙ† ÙˆÙ…ÙŠØ¶ - Ù†Ø¸Ø§Ù… SPA ÙŠØ­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ù„ÙÙŠØ© */
        /* Ø¨Ø¯ÙˆÙ† ÙˆÙ…ÙŠØ¶ - Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø£ØµÙ„ÙŠØ© ØªØ¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ù…Ø´Ø§ÙƒÙ„ */
        /* Ø¨Ø¯ÙˆÙ† ÙˆÙ…ÙŠØ¶ - Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø£ØµÙ„ÙŠØ© ØªØ¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ù…Ø´Ø§ÙƒÙ„ */
        .balance-notification-toast {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(34, 197, 94, 0.4);
            font-size: 16px;
            font-weight: 600;
            z-index: 9999;
            animation: slideInDown 0.4s ease-out, slideOutUp 0.4s ease-in 3.6s;
            pointer-events: none;
            text-align: center;
            max-width: 90%;
        }
        
        @keyframes slideInDown {
            from {
                transform: translateX(-50%) translateY(-100px);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutUp {
            from {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
            to {
                transform: translateX(-50%) translateY(-100px);
                opacity: 0;
            }
        }
    </style>
    
    <script>
        // Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ±Ø¬Ù…Ø§Øª Ø§Ù„Ø´Ø§Ù…Ù„ Ù„ÙƒÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹
        const translations = {
            ar: {
                choose_language: 'Ø§Ø®ØªØ± Ø§Ù„Ù„ØºØ©',
                account: 'Ø§Ù„Ø­Ø³Ø§Ø¨',
                games: 'Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨',
                wallet: 'Ù…Ø­ÙØ¸Ø©',
                live: 'Ù…Ø¨Ø§Ø´Ø±',
                feature_in_development: 'Ø§Ù„Ù…ÙŠØ²Ø© Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±',
                'Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨': 'Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨',
                                'Ù„Ø¹Ø¨Ø© Ø§Ù„Ù„ÙˆØ¯Ùˆ 1vs1': 'Ù„Ø¹Ø¨Ø© Ø§Ù„Ù„ÙˆØ¯Ùˆ 1vs1',
                                'Ø§Ø®ØªØ± Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ù‡Ù†Ø© Ø¨Ù‡': 'Ø§Ø®ØªØ± Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ù‡Ù†Ø© Ø¨Ù‡',
                'Ø¨Ø­Ø« Ø¹Ù† Ø®ØµÙ…...': 'Ø¨Ø­Ø« Ø¹Ù† Ø®ØµÙ…...',
                'ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø®ØµÙ…': 'ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø®ØµÙ…',
                'Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª': 'Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª',
                'Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ': 'Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ',
                'Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹': 'Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹',
                'Ø§Ù„Ø³Ø­Ø¨': 'Ø§Ù„Ø³Ø­Ø¨',
                'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„': 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„',
                'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨': 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨',
                'Ø¯Ø®ÙˆÙ„': 'Ø¯Ø®ÙˆÙ„',
                'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…': 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…',
                'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±': 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±',
                'Ø±Ù…Ø² PIN': 'Ø±Ù…Ø² PIN',
                'Ø§Ø³ØªØ±Ø¬Ø§Ø¹ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±': 'Ø§Ø³ØªØ±Ø¬Ø§Ø¹ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±',
                                'Ù„ÙˆØ¯Ùˆ': 'Ù„ÙˆØ¯Ùˆ',
                                'ÙˆØµÙ_Ù„ÙˆØ¯Ùˆ_1': 'Ù‡ÙŠ Ù„Ø¹Ø¨Ø© Ù†Ø±Ø¯ ØªÙ†Ø§ÙØ³ÙŠØ© 1 Ø¶Ø¯ 1 â€“ Ø§Ø¯Ø®Ù„ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¶Ø¯ Ù„Ø§Ø¹Ø¨ Ø­Ù‚ÙŠÙ‚ÙŠ',
                'ÙˆØµÙ_Ù„ÙˆØ¯Ùˆ_2': 'Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø°ÙŠ ÙŠØ¯Ø®Ù„ Ø£Ø±Ø¨Ø¹ Ø§Ø­Ø¬Ø§Ø±Ù‡ Ø§Ù„Ù‰ Ø§Ù„Ù…Ø±ÙƒØ² Ø£ÙˆÙ„Ø§ ÙŠÙÙˆØ²',
                'ÙˆØµÙ_Ù„ÙˆØ¯Ùˆ_3': 'ÙˆÙŠØ£Ø®Ø° Ø±Ù‡Ø§Ù† Ø®ØµÙ…Ùƒ Ø¥ÙƒØ³Ø¨ Ø§Ù„Ù…Ø§Ù„ Ø¨ÙƒÙ„ Ø³Ù‡ÙˆÙ„Ø©',
                'Ø§Ø®ØªØ±_Ù…Ø¨Ù„Øº_Ø§Ù„Ø±Ù‡Ø§Ù†': '- Ø§Ø®ØªØ± Ù…Ø¨Ù„Øº Ø§Ù„Ø±Ù‡Ø§Ù† -',
                'Ø®Ø·Ø£': 'Ø®Ø·Ø£',
                'Ø§Ù„Ø±ØµÙŠØ¯_ØºÙŠØ±_ÙƒØ§ÙÙŠ': 'Ø§Ù„Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙŠ ÙÙŠ Ø­Ø³Ø§Ø¨',
                'Ø¥ÙŠØ¯Ø§Ø¹_Ø¨Ø¯ÙˆÙ†': 'Ø¥ÙŠØ¯Ø§Ø¹'
            },
            en: {
                choose_language: 'Choose Language',
                account: 'Account',
                games: 'Games',
                wallet: 'Wallet',
                live: 'Live',
                feature_in_development: 'Feature Under Development',
                'Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨': 'Games List',
                                'Ù„ÙˆØ¯Ùˆ': 'Ludo',
                                                'Ù„Ø¹Ø¨Ø© Ø§Ù„Ù„ÙˆØ¯Ùˆ 1vs1': 'Ludo Game 1vs1',
                                'Ø§Ø®ØªØ± Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ù‡Ù†Ø© Ø¨Ù‡': 'Choose Your Betting Amount',
                'Ø¨Ø­Ø« Ø¹Ù† Ø®ØµÙ…...': 'Searching for opponent...',
                'ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø®ØµÙ…': 'Opponent Found',
                'Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª': 'Notifications',
                'Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ': 'Profile',
                'Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹': 'Deposit',
                'Ø§Ù„Ø³Ø­Ø¨': 'Withdrawal',
                'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„': 'Login',
                'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨': 'Create Account',
                'Ø¯Ø®ÙˆÙ„': 'Login',
                'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…': 'Username',
                'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±': 'Password',
                'Ø±Ù…Ø² PIN': 'PIN Code',
                'Ø§Ø³ØªØ±Ø¬Ø§Ø¹ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±': 'Recover Password',
                'ÙˆØµÙ_Ù„ÙˆØ¯Ùˆ_1': 'It is a competitive 1v1 dice game - play directly against a real player',
                'ÙˆØµÙ_Ù„ÙˆØ¯Ùˆ_2': 'The player who enters all four pieces to the center first wins',
                'ÙˆØµÙ_Ù„ÙˆØ¯Ùˆ_3': "And takes your opponent's bet - earn money easily",
                'Ø§Ø®ØªØ±_Ù…Ø¨Ù„Øº_Ø§Ù„Ø±Ù‡Ø§Ù†': '- Choose Your Bet Amount -',
                'Ø®Ø·Ø£': 'Error',
                'Ø§Ù„Ø±ØµÙŠØ¯_ØºÙŠØ±_ÙƒØ§ÙÙŠ': 'Insufficient balance in your account',
                'Ø¥ÙŠØ¯Ø§Ø¹_Ø¨Ø¯ÙˆÙ†': 'Deposit'
            },
            ru: {
                choose_language: 'Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ÑĞ·Ñ‹Ğº',
                account: 'ĞĞºĞºĞ°ÑƒĞ½Ñ‚',
                games: 'Ğ˜Ğ³Ñ€Ñ‹',
                wallet: 'ĞšĞ¾ÑˆĞµĞ»ĞµĞº',
                live: 'ĞŸÑ€ÑĞ¼Ğ¾Ğ¹ ÑÑ„Ğ¸Ñ€',
                feature_in_development: 'Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ² Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞµ',
                'Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨': 'Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ¸Ğ³Ñ€',
                                'Ù„Ø¹Ø¨Ø© Ø§Ù„Ù„ÙˆØ¯Ùˆ 1vs1': 'Ğ˜Ğ³Ñ€Ğ° Ğ›ÑƒĞ´Ğ¾ 1vs1',
                                'Ø§Ø®ØªØ± Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ù‡Ù†Ø© Ø¨Ù‡': 'Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ÑÑƒĞ¼Ğ¼Ñƒ ÑÑ‚Ğ°Ğ²ĞºĞ¸',
                'Ø¨Ø­Ø« Ø¹Ù† Ø®ØµÙ…...': 'ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ñ€Ğ¾Ñ‚Ğ¸Ğ²Ğ½Ğ¸ĞºĞ°...',
                'ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø®ØµÙ…': 'ĞŸÑ€Ğ¾Ñ‚Ğ¸Ğ²Ğ½Ğ¸Ğº Ğ½Ğ°Ğ¹Ğ´ĞµĞ½',
                'Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª': 'Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ',
                'Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ': 'ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ',
                'Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹': 'ĞŸĞ¾Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ',
                'Ø§Ù„Ø³Ø­Ø¨': 'Ğ’Ñ‹Ğ²Ğ¾Ğ´',
                'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„': 'Ğ’Ñ…Ğ¾Ğ´',
                'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨': 'Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚',
                'Ø¯Ø®ÙˆÙ„': 'Ğ’Ñ…Ğ¾Ğ´',
                'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…': 'Ğ˜Ğ¼Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ',
                'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±': 'ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ',
                'Ø±Ù…Ø² PIN': 'ĞšĞ¾Ğ´ PIN',
                'Ø§Ø³ØªØ±Ø¬Ø§Ø¹ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±': 'Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ',
                                'Ù„ÙˆØ¯Ùˆ': 'Ğ›ÑƒĞ´Ğ¾',
                                'ÙˆØµÙ_Ù„ÙˆØ¯Ùˆ_1': 'Ğ­Ñ‚Ğ¾ ĞºĞ¾Ğ½ĞºÑƒÑ€ĞµĞ½Ñ‚Ğ½Ğ°Ñ Ğ¸Ğ³Ñ€Ğ° Ğ² ĞºĞ¾ÑÑ‚Ğ¸ 1 Ğ½Ğ° 1 - Ğ¸Ğ³Ñ€Ğ°Ğ¹Ñ‚Ğµ Ğ¿Ñ€ÑĞ¼Ğ¾ Ğ¿Ñ€Ğ¾Ñ‚Ğ¸Ğ² Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ°',
                'ÙˆØµÙ_Ù„ÙˆØ¯Ùˆ_2': 'Ğ˜Ğ³Ñ€Ğ¾Ğº, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¹ Ğ²Ğ²ĞµĞ´ĞµÑ‚ Ğ²ÑĞµ Ñ‡ĞµÑ‚Ñ‹Ñ€Ğµ Ñ„Ğ¸ÑˆĞºĞ¸ Ğ² Ñ†ĞµĞ½Ñ‚Ñ€ Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¼, Ğ¿Ğ¾Ğ±ĞµĞ¶Ğ´Ğ°ĞµÑ‚',
                'ÙˆØµÙ_Ù„ÙˆØ¯Ùˆ_3': 'Ğ˜ Ğ±ĞµÑ€ĞµÑ‚ ÑÑ‚Ğ°Ğ²ĞºÑƒ Ğ²Ğ°ÑˆĞµĞ³Ğ¾ Ğ¿Ñ€Ğ¾Ñ‚Ğ¸Ğ²Ğ½Ğ¸ĞºĞ° - Ğ·Ğ°Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°Ğ¹Ñ‚Ğµ Ğ´ĞµĞ½ÑŒĞ³Ğ¸ Ğ»ĞµĞ³ĞºĞ¾',
                'Ø§Ø®ØªØ±_Ù…Ø¨Ù„Øº_Ø§Ù„Ø±Ù‡Ø§Ù†': '- Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ÑÑƒĞ¼Ğ¼Ñƒ ÑÑ‚Ğ°Ğ²ĞºĞ¸ -',
                'Ø®Ø·Ø£': 'ĞÑˆĞ¸Ğ±ĞºĞ°',
                'Ø§Ù„Ø±ØµÙŠØ¯_ØºÙŠØ±_ÙƒØ§ÙÙŠ': 'ĞĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ ÑÑ€ĞµĞ´ÑÑ‚Ğ² Ğ½Ğ° ÑÑ‡ĞµÑ‚Ğµ',
                'Ø¥ÙŠØ¯Ø§Ø¹_Ø¨Ø¯ÙˆÙ†': 'ĞŸĞ¾Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ'
            }
        };
        
        // Ø­ÙØ¸ Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ø£ØµÙ„ÙŠØ© (Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©)
        const originalTexts = {};
        
        // Ø¯Ø§Ù„Ø© ØªØ±Ø¬Ù…Ø© Ø´Ø§Ù…Ù„Ø©
        function applyTranslations(lang) {
            console.log('ğŸ”¤ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ±Ø¬Ù…Ø§Øª:', lang);
            localStorage.setItem('language', lang);
            
            // ØªØ±Ø¬Ù…Ø© Ø¬Ù…ÙŠØ¹ Ø¹Ù†Ø§ØµØ± data-i18n
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (!originalTexts[key]) {
                    originalTexts[key] = el.textContent;
                }
                if (translations[lang] && translations[lang][key]) {
                    el.textContent = translations[lang][key];
                } else if (lang === 'ar' && originalTexts[key]) {
                    el.textContent = originalTexts[key];
                }
            });
            
            // ØªØ±ÙØ¹ ÙƒÙ„Ù…Ø© Games/Ğ˜Ğ³Ñ€Ñ‹ Ø¹Ù†Ø¯Ù…Ø§ ØªÙƒÙˆÙ† Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ø£Ùˆ Ø§Ù„Ø±ÙˆØ³ÙŠØ©
            const gamesText = document.querySelector('.games-text');
            if (gamesText) {
                if (lang === 'en' || lang === 'ru') {
                    gamesText.style.transform = 'translateY(-6px)';
                } else {
                    gamesText.style.transform = '';
                }
            }
            
            console.log('âœ… ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ±Ø¬Ù…Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
        }
        
        // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ±Ø¬Ù…Ø§Øª Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        document.addEventListener('DOMContentLoaded', function() {
            const currentLang = localStorage.getItem('language') || 'ar';
            document.documentElement.lang = currentLang;
            
            // Ø±ÙØ¹ ÙƒÙ„Ù…Ø© Games/Ğ˜Ğ³Ñ€Ñ‹ Ø¹Ù†Ø¯Ù…Ø§ ØªÙƒÙˆÙ† Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ø£Ùˆ Ø§Ù„Ø±ÙˆØ³ÙŠØ©
            const gamesText = document.querySelector('.games-text');
            if (gamesText) {
                if (currentLang === 'en' || currentLang === 'ru') {
                    gamesText.style.transform = 'translateY(-6px)';
                } else {
                    gamesText.style.transform = '';
                }
            }
            
            // ØªÙ†Ù‚Ù„ Ø·Ø¨ÙŠØ¹ÙŠ - Ø¨Ø¯ÙˆÙ† ØªØ¯Ø®Ù„
            // Ù„Ø§ ØªÙ…Ù†Ø¹ Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ
            
            applyTranslations(currentLang);
        });
        
        // Ø§Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø©
        function requestNotificationPermission() {
            if ('Notification' in window) {
                console.log('ğŸ“¢ Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª:', Notification.permission);
                
                if (Notification.permission === 'granted') {
                    console.log('âœ… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…ÙØ¹Ù„Ø©');
                } else if (Notification.permission !== 'denied') {
                    Notification.requestPermission().then(function(permission) {
                        console.log('ğŸ“¢ Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø·Ù„Ø¨:', permission);
                        if (permission === 'granted') {
                            console.log('âœ… ØªÙ… Ù…Ù†Ø­ Ø§Ù„Ø¥Ø°Ù† Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª');
                        }
                    });
                }
            }
        }
        
        // Ø§Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ù…Ø¨Ø§Ø´Ø±Ø© - Ù…Ø¹ ØªØ£Ø®ÙŠØ± Ù„Ù„Ø³Ù…Ø§Ø­ Ù„Ù€ WebView Ø¨Ø§Ù„ØªÙØ§Ø¹Ù„
        async function requestInitialMicrophonePermission() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                console.log('âŒ getUserMedia ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²');
                return false;
            }
            
            try {
                console.log('ğŸ¤ Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©...');
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: true,
                    video: false 
                });
                console.log('âœ… ØªÙ… Ù…Ù†Ø­ Ø¥Ø°Ù† Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†');
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
                return true;
            } catch (err) {
                console.log('âš ï¸ Ù„Ù… ÙŠØªÙ… Ù…Ù†Ø­ Ø¥Ø°Ù† Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†:', err.message);
                return false;
            }
        }
        
        // Ø§Ø·Ù„Ø¨ Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª ÙÙˆØ±Ø§Ù‹ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        requestNotificationPermission();
        
        // Ø·Ù„Ø¨ Ø£Ø°ÙˆÙ†Ø§Øª Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†
        if (document.readyState === 'loading') {
            window.addEventListener('load', () => {
                requestInitialMicrophonePermission();
            });
        } else {
            requestInitialMicrophonePermission();
        }
        
        // Ø§ØªØµÙ„ Ø¨Ù€ SocketIO
        const socket = io({
            transports: ['websocket', 'polling'],
            reconnection: true,
            reconnectionDelay: 500,
            reconnectionDelayMax: 5000,
            reconnectionAttempts: Infinity,
            autoConnect: true
        });
        console.log('ğŸ”Œ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ SocketIO...');
        
        socket.on('connect', function() {
            console.log('ğŸŸ¢ ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ SocketIO Ø¨Ù†Ø¬Ø§Ø­');
        });
        
        socket.on('disconnect', function(reason) {
            console.log('âš ï¸ Ø§Ù†Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„:', reason);
        });
        
        socket.on('reconnect', function() {
            console.log('ğŸ”„ ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù†Ø¬Ø§Ø­');
        });
        
        // Ø§Ø³ØªÙ‚Ø¨Ù„ ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ø±ØµÙŠØ¯
        socket.on('balance_updated', function(data) {
            console.log('ğŸ’° ØªØ­Ø¯ÙŠØ« Ù…Ø³ØªÙ‚Ø¨Ù„:', data);
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„ÙÙˆØ±ÙŠ
            const balanceDisplay = document.querySelector('.balance-display');
            if (balanceDisplay && data.new_balance) {
                balanceDisplay.textContent = data.new_balance.toFixed(2) + ' $';
                balanceDisplay.style.color = '#22c55e';
                balanceDisplay.style.fontWeight = 'bold';
                setTimeout(function() {
                    balanceDisplay.style.color = '';
                    balanceDisplay.style.fontWeight = '';
                }, 2000);
                console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø±ØµÙŠØ¯ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø©');
            }
        });
        
        // Ø§Ø³ØªÙ‚Ø¨Ù„ Ø¥Ø´Ø§Ø±Ø© Ø·Ù„Ø¨ Ø´Ø­Ù† Ø¬Ø¯ÙŠØ¯ - Ù„Ø§ Ù†Ø¶ÙŠÙÙ‡ Ù‡Ù†Ø§ Ù„Ø£Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ÙŠØ¶ÙŠÙÙ‡
        socket.on('new_deposit_created', function(data) {
            console.log('ğŸ“ ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø¥Ø´Ø§Ø±Ø© Ø·Ù„Ø¨ Ø´Ø­Ù† Ø¬Ø¯ÙŠØ¯:', data);
        });
        
        // Ø§Ø³ØªÙ‚Ø¨Ù„ ØªØ­Ø¯ÙŠØ«Ø§Øª Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙÙˆØ±ÙŠ
        socket.on('deposit_status_updated', function(data) {
            console.log('ğŸ“¦ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨:', data);
            const row = document.querySelector(`[data-deposit-id="${data.deposit_id}"]`);
            if (row) {
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¨Ù„Øº
                const amountCell = row.querySelector('.deposit-amount');
                if (amountCell && data.amount) {
                    amountCell.textContent = data.amount + ' $';
                    console.log('ğŸ’° ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¨Ù„Øº:', data.amount);
                }
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©
                const statusCell = row.querySelector('.deposit-status');
                if (statusCell) {
                    if (data.status === 'approved') {
                        statusCell.innerHTML = '<span style="background: #4caf50; color: white; padding: 5px 10px; border-radius: 4px; font-size: 12px; white-space: nowrap;">âœ… Ù…Ù‚Ø¨ÙˆÙ„</span>';
                        console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ù€ Ù…Ù‚Ø¨ÙˆÙ„');
                    } else if (data.status === 'rejected') {
                        statusCell.innerHTML = '<span style="background: #f44336; color: white; padding: 5px 10px; border-radius: 4px; font-size: 12px; white-space: nowrap;">âŒ Ù…Ø±ÙÙˆØ¶</span>';
                        console.log('âŒ ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ù€ Ù…Ø±ÙÙˆØ¶');
                    }
                }
            }
        });
        
        socket.on('error', function(error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ SocketIO:', error);
        });
        
        // Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
        socket.on('active_streams_list', function(data) {
            if (typeof handleActiveStreamsList === 'function') {
                handleActiveStreamsList(data);
            }
        });
        
        socket.on('new_stream_available', function(data) {
            if (typeof loadActiveStreams === 'function') {
                loadActiveStreams();
            }
        });
        
        socket.on('stream_removed', function(data) {
            console.log('ğŸ“º ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø¨Ø«:', data.game_id);
            if (typeof loadActiveStreams === 'function') {
                loadActiveStreams();
            }
        });
        
        socket.on('ludo_stream_snapshot', function(data) {
            if (typeof handleLudoStreamSnapshot === 'function') {
                handleLudoStreamSnapshot(data);
            }
        });
        
        socket.on('stream_ended', function(data) {
            if (typeof handleStreamEnded === 'function') {
                handleStreamEnded(data);
            }
        });
        
        socket.on('stream_viewer_update', function(data) {
            if (typeof handleStreamViewerUpdate === 'function') {
                handleStreamViewerUpdate(data);
            }
        });
        
        socket.on('ludo_update', function(data) {
            if (typeof handleLudoUpdateForViewer === 'function') {
                handleLudoUpdateForViewer(data);
            }
        });
        
        // Ù…Ø³ØªÙ…Ø¹ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ù„Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
        socket.on('stream_gift_received', function(data) {
            console.log('ğŸ ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ù‡Ø¯ÙŠØ© ÙÙŠ Ø§Ù„Ø¨Ø«:', data);
            if (typeof handleGiftReceived === 'function') {
                handleGiftReceived(data);
            }
        });
        
        // Ù…Ø³ØªÙ…Ø¹ Ø§Ø³ØªÙ„Ø§Ù… Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ†
        socket.on('stream_message_received', function(data) {
            console.log('ğŸ’¬ ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ø¨Ø«:', data);
            if (typeof handleStreamMessage === 'function') {
                handleStreamMessage(data);
            }
        });
        
        // Ù…Ø³ØªÙ…Ø¹ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ÙƒÙˆÙ„Ø¯Ø§ÙˆÙ† Ù„Ù„Ø±Ø³Ø§Ø¦Ù„
        socket.on('message_cooldown', function(data) {
            if (typeof startMessageCooldown === 'function') {
                startMessageCooldown(data.remaining_seconds);
            }
        });
        
        // Ù…Ø³ØªÙ…Ø¹Ø§Øª ØµÙˆØª Ø§Ù„Ø¨Ø« Ù„Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ†
        socket.on('viewer_audio_offer', function(data) {
            if (typeof handleViewerAudioOffer === 'function') {
                handleViewerAudioOffer(data);
            }
        });
        
        socket.on('viewer_ice_candidate_from_player', function(data) {
            if (typeof handleViewerIceCandidate === 'function') {
                handleViewerIceCandidate(data);
            }
        });
        
        socket.on('stream_audio_available', function(data) {
            console.log('ğŸ”Š ØµÙˆØª Ø§Ù„Ø¨Ø« Ù…ØªØ§Ø­ Ù„Ù„Ø¹Ø¨Ø©:', data.game_id);
            if (typeof initViewerAudio === 'function' && watchingGameId === data.game_id) {
                initViewerAudio(data.game_id);
            }
        });
        
        function hideMessageAfterDelay(elementId, delay) {
            setTimeout(function() {
                var element = document.getElementById(elementId);
                if (element) {
                    element.classList.add('fade-out');
                    setTimeout(function() {
                        element.style.display = 'none';
                    }, 500);
                }
            }, delay);
        }

        // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ØºÙŠØ± Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø©
        function updateNotificationBadge() {
            fetch('{{ url_for("get_unread_notifications") }}')
                .then(response => response.json())
                .then(data => {
                    const badge = document.getElementById('notification-badge');
                    if (badge) {
                        if (data.count > 0) {
                            badge.textContent = data.badge;
                            badge.style.display = 'flex';
                        } else {
                            badge.style.display = 'none';
                        }
                    }
                })
                .catch(err => console.log('âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª:', err));
        }

        window.onload = function() {
            var successMsg = document.getElementById('success-message');
            if (successMsg) {
                hideMessageAfterDelay('success-message', 5000);
            }
            
            // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø²Ø± Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
            var liveBtn = document.getElementById('live-btn');
            if (liveBtn) {
                liveBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    showPage('live');
                });
            }
            
            // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø²Ø± ØªØºÙŠÙŠØ± Ø§Ù„Ù„ØºØ©
            var langToggle = document.getElementById('lang-toggle');
            var languageModal = document.getElementById('language-modal');
            var closeLangModal = document.getElementById('close-lang-modal');
            
            if (langToggle && languageModal && closeLangModal) {
                langToggle.addEventListener('click', function(e) {
                    e.preventDefault();
                    languageModal.classList.add('active');
                });
                
                closeLangModal.addEventListener('click', function(e) {
                    e.preventDefault();
                    languageModal.classList.remove('active');
                });
                
                languageModal.addEventListener('click', function(e) {
                    if (e.target === languageModal) {
                        languageModal.classList.remove('active');
                    }
                });
                
                // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù„ØºØ©
                var langOptions = document.querySelectorAll('.language-option');
                langOptions.forEach(function(option) {
                    option.addEventListener('click', function(e) {
                        e.preventDefault();
                        var lang = this.getAttribute('data-lang');
                        languageModal.classList.remove('active');
                        // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ±Ø¬Ù…Ø§Øª ÙÙˆØ±Ø§Ù‹ Ø¨Ø¯ÙˆÙ† reload
                        applyTranslations(lang);
                    });
                });
            }
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙÙˆØ±Ø§Ù‹ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
            updateNotificationBadge();
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙƒÙ„ 5 Ø«ÙˆØ§Ù†Ù
            setInterval(updateNotificationBadge, 5000);
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            document.body.addEventListener('click', function(e) {
                if (e.target.matches('.nav-btn, .deposit-withdraw-btn') || e.target.closest('.nav-btn, .deposit-withdraw-btn')) {
                    e.preventDefault();
                    const link = e.target.matches('.nav-btn, .deposit-withdraw-btn') ? e.target : e.target.closest('.nav-btn, .deposit-withdraw-btn');
                    const url = link.href;
                    
                    fetch(url, {
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                    .then(response => response.text())
                    .then(html => {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');
                        
                        const newContent = doc.querySelector(".page-content");
                        const currentContent = document.querySelector(".page-content");
                        if (newContent && currentContent) {
                            currentContent.style.opacity = '0.7';
                            setTimeout(function() {
                                currentContent.innerHTML = newContent.innerHTML;
                                currentContent.style.opacity = '1';
                                
                                const newBalance = doc.querySelector('.balance-display');
                                const currentBalance = document.querySelector('.balance-display');
                                if (newBalance && currentBalance) {
                                    currentBalance.innerHTML = newBalance.innerHTML;
                                }
                                
                                document.querySelectorAll('.nav-btn, .deposit-withdraw-btn').forEach(btn => {
                                    btn.classList.remove('active');
                                });
                                link.classList.add('active');
                                
                                window.history.pushState({}, '', url);
                                
                                var successMsg = document.getElementById('success-message');
                                if (successMsg) {
                                    hideMessageAfterDelay('success-message', 5000);
                                }
                            }, 90);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        window.location.href = url;
                    });
                }
            });
            
            window.addEventListener('popstate', function() {
                location.reload();
            });
        });
        
        // Ø¯ÙˆØ§Ù„ Ø´Ø­Ù† BNB
        window.copyToClipboard = function(text) {
            const btn = document.getElementById('copyBtn');
            const originalText = btn.textContent;
            
            navigator.clipboard.writeText(text);
            
            btn.textContent = 'âœ… ØªÙ… Ù†Ø³Ø®';
            btn.style.background = '#4caf50';
            
            setTimeout(() => {
                btn.textContent = originalText;
                btn.style.background = '#ffc107';
            }, 2000);
        }
        
        // Global deposit functions
        let isDepositProcessing = false;
        
        window.openBNBModal = function() {
            if (document.getElementById('bnbModal')) {
                document.getElementById('bnbModal').style.display = 'flex';
            }
        }
        
        window.closeBNBModal = function() {
            if (document.getElementById('bnbModal')) {
                document.getElementById('bnbModal').style.display = 'none';
            }
        }
        
        window.showDepositAlert = function() {
            document.getElementById('depositAlert').style.display = 'block';
            document.getElementById('depositAlertOverlay').style.display = 'block';
        }
        
        window.closeDepositAlert = function() {
            document.getElementById('depositAlert').style.display = 'none';
            document.getElementById('depositAlertOverlay').style.display = 'none';
        }
        
        window.submitDepositForm = async function() {
            // Ù…Ù†Ø¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ØªÙƒØ±Ø±Ø© ÙÙˆØ±Ø§Ù‹ Ù‚Ø¨Ù„ Ø£ÙŠ Ø´ÙŠØ¡
            if (isDepositProcessing) {
                window.showDepositAlert();
                return;
            }
            
            const fileInput = document.getElementById('depositPhoto');
            const msgDiv = document.getElementById('depositMessage');
            const depositBtn = document.getElementById('depositBtn');
            
            if (!fileInput || !fileInput.files || !fileInput.files[0]) {
                if (msgDiv) {
                    msgDiv.style.display = 'block';
                    msgDiv.style.background = '#ffebee';
                    msgDiv.style.color = '#c62828';
                    msgDiv.textContent = 'âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø©';
                }
                return;
            }
            
            // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© ÙÙˆØ±Ø§Ù‹ Ù„Ù…Ù†Ø¹ Ø£ÙŠ Ø·Ù„Ø¨Ø§Øª Ø£Ø®Ø±Ù‰
            isDepositProcessing = true;
            const originalText = depositBtn.textContent;
            depositBtn.textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';
            depositBtn.disabled = true;
            
            if (msgDiv) {
                msgDiv.textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨Ùƒ...';
                msgDiv.style.background = '#e3f2fd';
                msgDiv.style.color = '#1565c0';
                msgDiv.style.display = 'block';
            }
            
            try {
                const formData = new FormData();
                formData.append('photo', fileInput.files[0]);
                
                const response = await fetch('{{ url_for("submit_deposit") }}', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    if (msgDiv) {
                        msgDiv.style.background = '#e8f5e9';
                        msgDiv.style.color = '#2e7d32';
                        msgDiv.textContent = `âœ… ${data.message}`;
                    }
                    fileInput.value = '';
                    
                    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø¬Ø¯ÙˆÙ„ ÙÙˆØ±Ø§Ù‹ Ø¨Ø¯ÙˆÙ† reload
                    try {
                        if (data.deposit_id) {
                            const today = new Date().toISOString().split('T')[0];
                            
                            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù€ container Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ID
                            const containerDiv = document.getElementById('deposit-history-container');
                            
                            if (containerDiv) {
                                let table = containerDiv.querySelector('table');
                                
                                if (!table) {
                                    // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ØŒ Ø£Ù†Ø´Ø¦ Ø¬Ø¯ÙˆÙ„ Ø¬Ø¯ÙŠØ¯
                                    containerDiv.innerHTML = `
                                        <table style="width: 100%; border-collapse: collapse;">
                                            <tr style="background: #f0e6ff; border-bottom: 2px solid #667eea;">
                                                <th style="padding: 12px; text-align: right;">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                                <th style="padding: 12px; text-align: right;">Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                                <th style="padding: 12px; text-align: right;">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                            </tr>
                                        </table>
                                    `;
                                    table = containerDiv.querySelector('table');
                                }
                                
                                // Ø£Ø¶Ù Ø§Ù„ØµÙ Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰ (Ø¨Ø¹Ø¯ ØµÙ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†)
                                const newRow = document.createElement('tr');
                                newRow.setAttribute('data-deposit-id', data.deposit_id);
                                newRow.style.borderBottom = '1px solid #e0e0e0';
                                newRow.innerHTML = `
                                    <td style="padding: 12px;">${today}</td>
                                    <td style="padding: 12px;" class="deposit-amount">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</td>
                                    <td style="padding: 12px; white-space: nowrap;" class="deposit-status">
                                        <span style="background: #ff9800; color: white; padding: 5px 10px; border-radius: 4px; font-size: 12px; white-space: nowrap;">â³ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</span>
                                    </td>
                                `;
                                // Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„ØµÙ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¨Ø¹Ø¯ ØµÙ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù…Ø¨Ø§Ø´Ø±Ø© (ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰)
                                const allRows = table.querySelectorAll('tr');
                                if (allRows.length > 1) {
                                    // Ø£Ø¯Ø®Ù„ Ø¨Ø¹Ø¯ ØµÙ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„)
                                    allRows[0].insertAdjacentElement('afterend', newRow);
                                } else {
                                    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ØµÙ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙÙ‚Ø·
                                    table.appendChild(newRow);
                                }
                                console.log('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ø¬Ø¯ÙˆÙ„ ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰');
                            } else {
                                console.log('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ container Ø§Ù„Ø³Ø¬Ù„Ø§Øª');
                            }
                        }
                    } catch (e) {
                        console.log('âš ï¸ ØªØ­Ø°ÙŠØ± Ø¹Ù†Ø¯ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ù„Ø¨:', e.message);
                    }
                    
                    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø²Ø± Ø¨Ø¹Ø¯ 2 Ø«Ø§Ù†ÙŠØ©
                    setTimeout(() => {
                        isDepositProcessing = false;
                        depositBtn.textContent = originalText;
                        depositBtn.disabled = false;
                    }, 2000);
                } else {
                    if (msgDiv) {
                        msgDiv.style.background = '#ffebee';
                        msgDiv.style.color = '#c62828';
                        msgDiv.textContent = `âŒ ${data.message}`;
                    }
                    // Ø¨Ø¹Ø¯ Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ØŒ Ø§Ø³Ù…Ø­ Ø¨Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†ÙŠ
                    setTimeout(() => {
                        isDepositProcessing = false;
                        depositBtn.textContent = originalText;
                        depositBtn.disabled = false;
                    }, 3000);
                }
            } catch (err) {
                if (msgDiv) {
                    msgDiv.style.background = '#ffebee';
                    msgDiv.style.color = '#c62828';
                    msgDiv.textContent = `âŒ Ø®Ø·Ø£: ${err.message}`;
                }
                // Ø¨Ø¹Ø¯ Ø®Ø·Ø£ØŒ Ø§Ø³Ù…Ø­ Ø¨Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†ÙŠ
                setTimeout(() => {
                    isDepositProcessing = false;
                    depositBtn.textContent = originalText;
                    depositBtn.disabled = false;
                }, 3000);
            }
        }
        
        window.verifyTransaction = async function() {
            const txHash = document.getElementById('txHash').value.trim();
            const msgDiv = document.getElementById('verifyMessage');
            
            if (!txHash) {
                msgDiv.style.display = 'block';
                msgDiv.style.background = '#ffebee';
                msgDiv.style.color = '#c62828';
                msgDiv.textContent = 'âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ©';
                return;
            }
            
            msgDiv.textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...';
            msgDiv.style.background = '#e3f2fd';
            msgDiv.style.color = '#1565c0';
            msgDiv.style.display = 'block';
            
            try {
                const response = await fetch('/verify-bnb-deposit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tx_hash: txHash })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    msgDiv.style.background = '#e8f5e9';
                    msgDiv.style.color = '#2e7d32';
                    msgDiv.textContent = `âœ… ${data.message}`;
                    document.getElementById('txHash').value = '';
                    setTimeout(() => location.reload(), 2000);
                } else {
                    msgDiv.style.background = '#ffebee';
                    msgDiv.style.color = '#c62828';
                    msgDiv.textContent = `âŒ ${data.message}`;
                }
            } catch (err) {
                msgDiv.style.background = '#ffebee';
                msgDiv.style.color = '#c62828';
                msgDiv.textContent = `âŒ Ø®Ø·Ø£: ${err.message}`;
            }
        }
    </script>
</body>
</html>
'''

GAMES_PAGE = DASHBOARD_PAGE.replace('{% block page_content %}{% endblock %}', '''
{% block page_content %}
    <h1 style="margin-top: 30px;" data-i18n="Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨">ğŸ® Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨</h1>
    
    <div class="games-grid">
        <a href="{{ url_for('ludo_game_page') }}" class="game-card">
            <div style="font-size: 80px; margin-top: 30px;">ğŸ²</div>
            <div class="game-card-title" data-i18n="Ù„ÙˆØ¯Ùˆ">Ù„ÙˆØ¯Ùˆ</div>
        </a>
        
        </div>
{% endblock %}
''')


LUDO_BET_INFO_PAGE = DASHBOARD_PAGE.replace('{% block page_content %}{% endblock %}', '''
{% block page_content %}
    <style>
        /* Ø¨Ø¯ÙˆÙ† ÙˆÙ…ÙŠØ¶ - Ù†Ø¸Ø§Ù… SPA ÙŠØ­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ù„ÙÙŠØ© */
        /* Ø¨Ø¯ÙˆÙ† ÙˆÙ…ÙŠØ¶ - Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø£ØµÙ„ÙŠØ© ØªØ¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ù…Ø´Ø§ÙƒÙ„ */
        /* Ø¨Ø¯ÙˆÙ† ÙˆÙ…ÙŠØ¶ - Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø£ØµÙ„ÙŠØ© ØªØ¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ù…Ø´Ø§ÙƒÙ„ */
        .game-rules {
            background: linear-gradient(135deg, #d4af37 0%, #f4e5b5 100%);
            color: #2c2c2c;
            padding: 25px;
            border-radius: 15px;
            margin-top: 50px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.4);
        }
        
        .game-rules h2 {
            color: #2c2c2c;
            font-size: 24px;
            margin-bottom: 15px;
            font-weight: bold;
        }
        
        .game-rules p {
            font-size: 16px;
            line-height: 1.8;
            margin-bottom: 10px;
        }
        
        .bet-buttons-container {
            margin-top: 30px;
        }
        
        .bet-buttons-container h3 {
            text-align: center;
            color: #667eea;
            font-size: 20px;
            margin-bottom: 20px;
        }
        
        .bet-buttons-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .bet-button {
            background: linear-gradient(135deg, #d4af37 0%, #f4e5b5 100%);
            color: #2c2c2c;
            border: none;
            border-radius: 10px;
            padding: 20px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 10px rgba(212, 175, 55, 0.3);
        }
        
        .bet-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(212, 175, 55, 0.6);
        }
        
        .insufficient-balance-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .insufficient-balance-modal.show {
            display: flex;
        }
        
        .modal-content {
            background: #37474f;
            border-radius: 15px;
            padding: 40px;
            max-width: 400px;
            width: 90%;
            position: relative;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        
        .close-modal {
            position: absolute;
            top: 15px;
            left: 15px;
            background: none;
            border: none;
            color: white;
            font-size: 30px;
            cursor: pointer;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close-modal:hover {
            opacity: 0.7;
        }
        
        .error-icon {
            width: 80px;
            height: 80px;
            background: #e74c3c;
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 50px;
            color: white;
        }
        
        .modal-title {
            color: white;
            font-size: 22px;
            margin-bottom: 15px;
        }
        
        .modal-message {
            color: #b0bec5;
            font-size: 16px;
            margin-bottom: 30px;
        }
        
        .modal-deposit-btn {
            background: #8bc34a;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 15px 40px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s;
        }
        
        .modal-deposit-btn:hover {
            background: #7cb342;
            transform: translateY(-2px);
        }
        
        @media (max-width: 768px) {
            .bet-buttons-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }
            
            .bet-button {
                padding: 15px;
                font-size: 16px;
            }
            
            .game-rules h2 {
                font-size: 20px;
            }
            
            .game-rules p {
                font-size: 14px;
            }
        }
    </style>
    
    <div class="game-rules">
        <h2 data-i18n="Ù„Ø¹Ø¨Ø© Ø§Ù„Ù„ÙˆØ¯Ùˆ 1vs1">Ù„Ø¹Ø¨Ø© Ù„ÙˆØ¯Ùˆ 1vs1</h2>
        <p data-i18n="ÙˆØµÙ_Ù„ÙˆØ¯Ùˆ_1">Ù‡ÙŠ Ù„Ø¹Ø¨Ø© Ù†Ø±Ø¯ ØªÙ†Ø§ÙØ³ÙŠØ© 1 Ø¶Ø¯ 1 â€“ Ø§Ø¯Ø®Ù„ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¶Ø¯ Ù„Ø§Ø¹Ø¨ Ø­Ù‚ÙŠÙ‚ÙŠ</p>
        <p data-i18n="ÙˆØµÙ_Ù„ÙˆØ¯Ùˆ_2">Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø°ÙŠ  ÙŠØ¯Ø®Ù„ Ø£Ø±Ø¨Ø¹ Ø§Ø­Ø¬Ø§Ø±Ù‡ Ø§Ù„Ù‰ Ø§Ù„Ù…Ø±ÙƒØ² Ø£ÙˆÙ„Ø§ ÙŠÙÙˆØ²</p>
        <p data-i18n="ÙˆØµÙ_Ù„ÙˆØ¯Ùˆ_3">ÙˆÙŠØ£Ø®Ø° Ø±Ù‡Ø§Ù† Ø®ØµÙ…Ù‡ Ø¥ÙƒØ³Ø¨ Ø§Ù„Ù…Ø§Ù„ Ø¨ÙƒÙ„ Ø³Ù‡ÙˆÙ„Ø©</p>
    </div>
    
    <div class="bet-buttons-container">
        <h3 data-i18n="Ø§Ø®ØªØ±_Ù…Ø¨Ù„Øº_Ø§Ù„Ø±Ù‡Ø§Ù†">- Ø§Ø®ØªØ± Ù…Ø¨Ù„Øº Ø§Ù„Ø±Ù‡Ø§Ù† -</h3>
        <div class="bet-buttons-grid">
            <button class="bet-button" onclick="selectBet(0.30)">$0.30</button>
            <button class="bet-button" onclick="selectBet(1)">$1</button>
            <button class="bet-button" onclick="selectBet(3)">$3</button>
            <button class="bet-button" onclick="selectBet(5)">$5</button>
            <button class="bet-button" onclick="selectBet(10)">$10</button>
            <button class="bet-button" onclick="selectBet(50)">$50</button>
        </div>
    </div>
    
    <div id="insufficientBalanceModal" class="insufficient-balance-modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal()">âœ•</button>
            <div class="error-icon">âœ•</div>
            <h2 class="modal-title" data-i18n="Ø®Ø·Ø£">Ø®Ø·Ø£</h2>
            <p class="modal-message" data-i18n="Ø§Ù„Ø±ØµÙŠØ¯_ØºÙŠØ±_ÙƒØ§ÙÙŠ">Ø§Ù„Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙŠ ÙÙŠ Ø­Ø³Ø§Ø¨</p>
            <button class="modal-deposit-btn" data-i18n="Ø¥ÙŠØ¯Ø§Ø¹_Ø¨Ø¯ÙˆÙ†" onclick="goToDeposit()">Ø¥ÙŠØ¯Ø§Ø¹</button>
        </div>
    </div>
    
    <script>
        const userBalance = {{ user['balance'] }};
        
        function selectBet(amount) {
            if (amount > userBalance) {
                document.getElementById('insufficientBalanceModal').classList.add('show');
            } else {
                window.location.href = '/play-ludo/' + amount;
            }
        }
        
        function closeModal() {
            document.getElementById('insufficientBalanceModal').classList.remove('show');
        }
        
        function goToDeposit() {
            showPage('deposit'); return false;
        }
        
        window.onclick = function(event) {
            const modal = document.getElementById('insufficientBalanceModal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
{% endblock %}
''')



LUDO_GAME_PAGE = '''
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <!-- Ø£Ø°ÙˆÙ†Ø§Øª Android Ù„Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† ÙˆØ§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª -->
    <meta name="permissions" content="android.permission.RECORD_AUDIO,android.permission.ACCESS_NOTIFICATION_POLICY">
    <meta name="android-permissions" content="RECORD_AUDIO">
    <meta name="mobile-permission" content="microphone">
    <!-- ØªÙØ¹ÙŠÙ„ WebRTC ÙÙŠ WebView -->
    <meta name="disable-webrtc-hw-encoding" content="false">
    <meta name="disable-webrtc-hw-decoding" content="false">
    <!-- Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù€ Android -->
    <meta name="required-permissions" content="RECORD_AUDIO,INTERNET,MODIFY_AUDIO_SETTINGS,ACCESS_NETWORK_STATE">
    <meta name="android-webview-enabled" content="true">
    <meta name="webrtc-enabled" content="true">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#d4a574">
    <title>Ù„Ø¹Ø¨Ø© Ù„ÙˆØ¯Ùˆ</title>
    <style>
        /* Ø¨Ø¯ÙˆÙ† ÙˆÙ…ÙŠØ¶ - Ù†Ø¸Ø§Ù… SPA ÙŠØ­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ù„ÙÙŠØ© */
        /* Ø¨Ø¯ÙˆÙ† ÙˆÙ…ÙŠØ¶ - Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø£ØµÙ„ÙŠØ© ØªØ¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ù…Ø´Ø§ÙƒÙ„ */
        /* Ø¨Ø¯ÙˆÙ† ÙˆÙ…ÙŠØ¶ - Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø£ØµÙ„ÙŠØ© ØªØ¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ù…Ø´Ø§ÙƒÙ„ */
    </style>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cannon-es@0.20.0/dist/cannon-es.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        (function() {
            var lastTime = 0;
            var vendors = ['webkit', 'moz'];
            for(var x = 0; x < vendors.length && !window.requestAnimationFrame; ++x) {
                window.requestAnimationFrame = window[vendors[x]+'RequestAnimationFrame'];
                window.cancelAnimationFrame = window[vendors[x]+'CancelAnimationFrame'] || window[vendors[x]+'CancelRequestAnimationFrame'];
            }
            if (!window.requestAnimationFrame)
                window.requestAnimationFrame = function(callback, element) {
                    var currTime = new Date().getTime();
                    var timeToCall = Math.max(0, 16 - (currTime - lastTime));
                    var id = window.setTimeout(function() { callback(currTime + timeToCall); }, timeToCall);
                    lastTime = currTime + timeToCall;
                    return id;
                };
            if (!window.cancelAnimationFrame)
                window.cancelAnimationFrame = function(id) {
                    clearTimeout(id);
                };
        }());
    </script>
    <style>
        /* Ø¨Ø¯ÙˆÙ† ÙˆÙ…ÙŠØ¶ - Ù†Ø¸Ø§Ù… SPA ÙŠØ­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ù„ÙÙŠØ© */
        /* Ø¨Ø¯ÙˆÙ† ÙˆÙ…ÙŠØ¶ - Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø£ØµÙ„ÙŠØ© ØªØ¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ù…Ø´Ø§ÙƒÙ„ */
        /* Ø¨Ø¯ÙˆÙ† ÙˆÙ…ÙŠØ¶ - Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø£ØµÙ„ÙŠØ© ØªØ¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ù…Ø´Ø§ÙƒÙ„ */
        * { margin: 0; padding: 0; box-sizing: border-box; touch-action: manipulation; -webkit-tap-highlight-color: transparent; -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; }
        html { -webkit-text-size-adjust: 100%; text-size-adjust: 100%; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #000000; min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 10px; overflow: hidden; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; position: relative; }
        body::before { content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-image: 
            radial-gradient(1px 1px at 10% 15%, white, rgba(255,255,255,0)), 
            radial-gradient(1px 1px at 20% 8%, #ffd700, rgba(255,215,0,0)),
            radial-gradient(1px 1px at 30% 22%, #87ceeb, rgba(135,206,235,0)),
            radial-gradient(1px 1px at 40% 5%, white, rgba(255,255,255,0)),
            radial-gradient(1px 1px at 50% 18%, #ffd700, rgba(255,215,0,0)),
            radial-gradient(1px 1px at 60% 12%, white, rgba(255,255,255,0)),
            radial-gradient(1px 1px at 70% 25%, #87ceeb, rgba(135,206,235,0)),
            radial-gradient(1px 1px at 80% 8%, white, rgba(255,255,255,0)),
            radial-gradient(1px 1px at 90% 20%, #ffd700, rgba(255,215,0,0)),
            radial-gradient(1px 1px at 15% 35%, white, rgba(255,255,255,0)),
            radial-gradient(1px 1px at 25% 42%, #87ceeb, rgba(135,206,235,0)),
            radial-gradient(1px 1px at 35% 30%, white, rgba(255,255,255,0)),
            radial-gradient(1px 1px at 45% 38%, #ffd700, rgba(255,215,0,0)),
            radial-gradient(1px 1px at 55% 32%, white, rgba(255,255,255,0)),
            radial-gradient(1px 1px at 65% 40%, #87ceeb, rgba(135,206,235,0)),
            radial-gradient(1px 1px at 75% 35%, white, rgba(255,255,255,0)),
            radial-gradient(1px 1px at 85% 42%, #ffd700, rgba(255,215,0,0)),
            radial-gradient(1px 1px at 12% 55%, white, rgba(255,255,255,0)),
            radial-gradient(1px 1px at 22% 62%, #87ceeb, rgba(135,206,235,0)),
            radial-gradient(1px 1px at 32% 50%, white, rgba(255,255,255,0)),
            radial-gradient(1px 1px at 42% 58%, #ffd700, rgba(255,215,0,0)),
            radial-gradient(1px 1px at 52% 52%, white, rgba(255,255,255,0)),
            radial-gradient(1px 1px at 62% 60%, #87ceeb, rgba(135,206,235,0)),
            radial-gradient(1px 1px at 72% 55%, white, rgba(255,255,255,0)),
            radial-gradient(1px 1px at 82% 62%, #ffd700, rgba(255,215,0,0)),
            radial-gradient(1px 1px at 18% 75%, white, rgba(255,255,255,0)),
            radial-gradient(1px 1px at 28% 82%, #87ceeb, rgba(135,206,235,0)),
            radial-gradient(1px 1px at 38% 70%, white, rgba(255,255,255,0)),
            radial-gradient(1px 1px at 48% 78%, #ffd700, rgba(255,215,0,0)),
            radial-gradient(1px 1px at 58% 72%, white, rgba(255,255,255,0)),
            radial-gradient(1px 1px at 68% 80%, #87ceeb, rgba(135,206,235,0)),
            radial-gradient(1px 1px at 78% 75%, white, rgba(255,255,255,0)),
            radial-gradient(1px 1px at 88% 82%, #ffd700, rgba(255,215,0,0)),
            radial-gradient(1px 1px at 5% 90%, white, rgba(255,255,255,0)),
            radial-gradient(1px 1px at 15% 95%, #87ceeb, rgba(135,206,235,0)),
            radial-gradient(1px 1px at 25% 88%, white, rgba(255,255,255,0)),
            radial-gradient(1px 1px at 35% 92%, #ffd700, rgba(255,215,0,0)),
            radial-gradient(1px 1px at 45% 87%, white, rgba(255,255,255,0)),
            radial-gradient(1px 1px at 55% 93%, #87ceeb, rgba(135,206,235,0)),
            radial-gradient(1px 1px at 65% 89%, white, rgba(255,255,255,0)),
            radial-gradient(1px 1px at 75% 94%, #ffd700, rgba(255,215,0,0)),
            radial-gradient(1px 1px at 85% 91%, white, rgba(255,255,255,0)),
            radial-gradient(1px 1px at 95% 87%, #87ceeb, rgba(135,206,235,0));
        background-size: 200% 200%;
        background-repeat: repeat;
        pointer-events: none;
        z-index: 1;
        }
        .gift-display-area {
            position: fixed;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 999;
            max-height: 300px;
            overflow: hidden;
            pointer-events: none;
        }
        .gift-notification {
            background: linear-gradient(135deg, rgba(26,26,46,0.95) 0%, rgba(22,33,62,0.95) 100%);
            border: 2px solid #d4af37;
            border-radius: 30px;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            animation: giftSlideIn 0.4s ease-out;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            pointer-events: none;
        }
        .gift-notification.hiding {
            animation: giftSlideOut 0.3s ease-in forwards;
        }
        @keyframes giftSlideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes giftSlideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        .gift-notification .gift-sender {
            color: #22c55e;
            font-size: 13px;
            font-weight: bold;
        }
        .gift-notification .gift-action {
            color: white;
            font-size: 12px;
        }
        .gift-notification .gift-icon {
            font-size: 24px;
        }
        .gift-notification .gift-counter {
            background: #e11d48;
            color: white;
            font-size: 11px;
            font-weight: bold;
            padding: 2px 8px;
            border-radius: 10px;
            margin-right: 5px;
        }
        @keyframes giftCounterPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
        .gift-counter-pulse {
            animation: giftCounterPulse 0.3s ease;
        }
        
        /* ØªØ£Ø«ÙŠØ± Ù‡Ø¯ÙŠØ© Ø§Ù„Ø·Ø§Ø¦Ø±Ø© - Ù…Ø«Ù„ ØªÙŠÙƒ ØªÙˆÙƒ */
        .plane-gift-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
            overflow: hidden;
        }
        .flying-plane {
            position: absolute;
            font-size: 80px;
            filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.8));
            animation: planeFlying 3s ease-in-out forwards;
            z-index: 10000;
        }
        @keyframes planeFlying {
            0% {
                left: -100px;
                top: 70%;
                transform: rotate(-15deg) scale(0.5);
                opacity: 0;
            }
            10% {
                opacity: 1;
                transform: rotate(-20deg) scale(1);
            }
            30% {
                left: 30%;
                top: 50%;
                transform: rotate(-10deg) scale(1.2);
            }
            50% {
                left: 50%;
                top: 35%;
                transform: rotate(0deg) scale(1.4);
            }
            70% {
                left: 70%;
                top: 25%;
                transform: rotate(10deg) scale(1.2);
            }
            90% {
                opacity: 1;
                transform: rotate(15deg) scale(1);
            }
            100% {
                left: 110%;
                top: 10%;
                transform: rotate(20deg) scale(0.8);
                opacity: 0;
            }
        }
        .plane-trail {
            position: absolute;
            width: 150px;
            height: 4px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.8), transparent);
            border-radius: 2px;
            animation: trailFade 0.5s ease-out forwards;
            filter: blur(2px);
        }
        @keyframes trailFade {
            0% { opacity: 1; width: 150px; }
            100% { opacity: 0; width: 0; }
        }
        .plane-sparkle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: radial-gradient(circle, #ffd700, transparent);
            border-radius: 50%;
            animation: sparkle 0.8s ease-out forwards;
        }
        @keyframes sparkle {
            0% { transform: scale(0); opacity: 1; }
            50% { transform: scale(1.5); opacity: 0.8; }
            100% { transform: scale(0); opacity: 0; }
        }
        .plane-gift-text {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 28px;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.8), 0 0 40px rgba(255, 215, 0, 0.5), 2px 2px 4px rgba(0, 0, 0, 0.8);
            z-index: 10001;
            animation: giftTextAppear 3s ease-in-out forwards;
            text-align: center;
            direction: rtl;
            white-space: nowrap;
        }
        @keyframes giftTextAppear {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
            30% { transform: translate(-50%, -50%) scale(1); }
            70% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8) translateY(-30px); }
        }
        .plane-confetti {
            position: absolute;
            width: 8px;
            height: 8px;
            animation: confettiFall 2s ease-out forwards;
        }
        @keyframes confettiFall {
            0% { opacity: 1; transform: translateY(0) rotate(0deg); }
            100% { opacity: 0; transform: translateY(200px) rotate(720deg); }
        }
        
        .stream-message-display-area {
            position: fixed;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 6px;
            z-index: 999;
            max-height: 250px;
            overflow: hidden;
            pointer-events: none;
        }
        .stream-message {
            background: transparent;
            padding: 6px 12px;
            border-radius: 15px;
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 8px;
            animation: msgSlideIn 0.3s ease-out;
            pointer-events: none;
            max-width: 220px;
            border: 1.5px solid rgba(0, 0, 0, 0.4);
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .stream-message.hiding {
            animation: msgSlideOut 0.3s ease-in forwards;
        }
        @keyframes msgSlideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes msgSlideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(-100%); opacity: 0; }
        }
        .stream-message .msg-sender {
            color: #00bfff;
            font-size: 11px;
            font-weight: 700;
            white-space: nowrap;
            text-shadow: 0 0 8px rgba(0, 191, 255, 0.6);
        }
        .stream-message .msg-text {
            color: #000000;
            font-size: 13px;
            font-weight: 600;
            word-break: break-word;
            text-shadow: 0 0 1px rgba(0,0,0,0.3);
        }
        .turn-indicator { position: fixed; top: 10px; left: 50%; -webkit-transform: translateX(-50%); -moz-transform: translateX(-50%); -ms-transform: translateX(-50%); transform: translateX(-50%); background: rgba(255, 255, 255, 0.95); padding: 15px 30px; border-radius: 25px; font-size: 20px; font-weight: bold; color: #2c3e50; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 1000; -webkit-animation: pulse 2s infinite; -moz-animation: pulse 2s infinite; animation: pulse 2s infinite; }
        @-webkit-keyframes pulse { 0%, 100% { -webkit-transform: translateX(-50%) scale(1); transform: translateX(-50%) scale(1); } 50% { -webkit-transform: translateX(-50%) scale(1.05); transform: translateX(-50%) scale(1.05); } }
        @-moz-keyframes pulse { 0%, 100% { -moz-transform: translateX(-50%) scale(1); transform: translateX(-50%) scale(1); } 50% { -moz-transform: translateX(-50%) scale(1.05); transform: translateX(-50%) scale(1.05); } }
        @keyframes pulse { 0%, 100% { -webkit-transform: translateX(-50%) scale(1); -moz-transform: translateX(-50%) scale(1); -ms-transform: translateX(-50%) scale(1); transform: translateX(-50%) scale(1); } 50% { -webkit-transform: translateX(-50%) scale(1.05); -moz-transform: translateX(-50%) scale(1.05); -ms-transform: translateX(-50%) scale(1.05); transform: translateX(-50%) scale(1.05); } }
        .game-container { position: relative; width: min(95vmin, 600px); height: min(95vmin, 600px); background: linear-gradient(135deg, #c89b5a 0%, #b58850 50%, #a57645 100%); box-shadow: 0 0 0 8px #654321, 0 0 0 12px #8b6914, 0 20px 60px rgba(0,0,0,0.5), inset 0 0 30px rgba(0,0,0,0.15); border-radius: 8px; display: grid; grid-template-columns: 40% 20% 40%; grid-template-rows: 40% 20% 40%; gap: 0; padding: 0; z-index: 10; }
        .game-container::before { content: ''; position: absolute; inset: 0; background: repeating-linear-gradient(90deg, transparent 0, transparent 2px, rgba(139,105,20,0.1) 2px, rgba(139,105,20,0.1) 4px), repeating-linear-gradient(0deg, transparent 0, transparent 2px, rgba(139,105,20,0.1) 2px, rgba(139,105,20,0.1) 4px); pointer-events: none; border-radius: 8px; }
        .player-home { display: flex; align-items: center; justify-content: center; position: relative; padding: 8px; }
        .player-circle { width: 85%; height: 85%; border-radius: 50%; border: 4px solid rgba(0,0,0,0.3); box-shadow: inset 0 4px 12px rgba(0,0,0,0.3), 0 4px 12px rgba(0,0,0,0.2); position: relative; display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 8%; padding: 15%; }
        .player-home.green { grid-area: 1 / 1 / 2 / 2; } .player-home.green .player-circle { background: radial-gradient(circle, #4ade80 0%, #22c55e 100%); }
        .player-home.red { grid-area: 1 / 3 / 2 / 4; } .player-home.red .player-circle { background: radial-gradient(circle, #f87171 0%, #ef4444 100%); }
        .player-home.yellow { grid-area: 3 / 1 / 4 / 2; } .player-home.yellow .player-circle { background: radial-gradient(circle, #fde047 0%, #eab308 100%); }
        .player-home.blue { grid-area: 3 / 3 / 4 / 4; } .player-home.blue .player-circle { background: radial-gradient(circle, #60a5fa 0%, #3b82f6 100%); }
        .token { width: 100%; height: 100%; border-radius: 50%; border: 3px solid rgba(255,255,255,0.8); box-shadow: 0 2px 8px rgba(0,0,0,0.3), inset 0 2px 4px rgba(255,255,255,0.5), inset 0 -2px 4px rgba(0,0,0,0.2); position: relative; cursor: pointer; -webkit-transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); -moz-transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); -ms-transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); will-change: transform; }
        .token::before { content: ''; position: absolute; top: 20%; left: 20%; width: 60%; height: 60%; border-radius: 50%; border: 2px solid rgba(255,255,255,0.4); }
        .token:hover { -webkit-transform: scale(1.1); -moz-transform: scale(1.1); -ms-transform: scale(1.1); transform: scale(1.1); }
        .token.green { background: radial-gradient(circle at 30% 30%, #86efac, #22c55e); }
        .token.red { background: radial-gradient(circle at 30% 30%, #fca5a5, #ef4444); }
        .token.yellow { background: radial-gradient(circle at 30% 30%, #fef08a, #eab308); }
        .token.blue { background: radial-gradient(circle at 30% 30%, #93c5fd, #3b82f6); }
        .token.green.selectable { -webkit-animation: greenPulse 1s infinite ease-in-out; -moz-animation: greenPulse 1s infinite ease-in-out; animation: greenPulse 1s infinite ease-in-out; }
        .token.blue.selectable { -webkit-animation: bluePulse 1s infinite ease-in-out; -moz-animation: bluePulse 1s infinite ease-in-out; animation: bluePulse 1s infinite ease-in-out; }
        .token.red.selectable { -webkit-animation: bluePulse 1s infinite ease-in-out; -moz-animation: bluePulse 1s infinite ease-in-out; animation: bluePulse 1s infinite ease-in-out; }
        .token.yellow.selectable { -webkit-animation: bluePulse 1s infinite ease-in-out; -moz-animation: bluePulse 1s infinite ease-in-out; animation: bluePulse 1s infinite ease-in-out; }
        @-webkit-keyframes greenPulse { 0%, 100% { box-shadow: 0 2px 8px rgba(0,0,0,0.3), inset 0 2px 4px rgba(255,255,255,0.5), inset 0 -2px 4px rgba(0,0,0,0.2), 0 0 5px 2px rgba(34, 197, 94, 0.6); } 50% { box-shadow: 0 2px 12px rgba(0,0,0,0.4), inset 0 2px 4px rgba(255,255,255,0.6), inset 0 -2px 4px rgba(0,0,0,0.2), 0 0 15px 6px rgba(34, 197, 94, 1); } }
        @-moz-keyframes greenPulse { 0%, 100% { box-shadow: 0 2px 8px rgba(0,0,0,0.3), inset 0 2px 4px rgba(255,255,255,0.5), inset 0 -2px 4px rgba(0,0,0,0.2), 0 0 5px 2px rgba(34, 197, 94, 0.6); } 50% { box-shadow: 0 2px 12px rgba(0,0,0,0.4), inset 0 2px 4px rgba(255,255,255,0.6), inset 0 -2px 4px rgba(0,0,0,0.2), 0 0 15px 6px rgba(34, 197, 94, 1); } }
        @keyframes greenPulse { 0%, 100% { box-shadow: 0 2px 8px rgba(0,0,0,0.3), inset 0 2px 4px rgba(255,255,255,0.5), inset 0 -2px 4px rgba(0,0,0,0.2), 0 0 5px 2px rgba(34, 197, 94, 0.6); } 50% { box-shadow: 0 2px 12px rgba(0,0,0,0.4), inset 0 2px 4px rgba(255,255,255,0.6), inset 0 -2px 4px rgba(0,0,0,0.2), 0 0 15px 6px rgba(34, 197, 94, 1); } }
        @-webkit-keyframes bluePulse { 0%, 100% { box-shadow: 0 2px 8px rgba(0,0,0,0.3), inset 0 2px 4px rgba(255,255,255,0.5), inset 0 -2px 4px rgba(0,0,0,0.2), 0 0 5px 2px rgba(59, 130, 246, 0.6); } 50% { box-shadow: 0 2px 12px rgba(0,0,0,0.4), inset 0 2px 4px rgba(255,255,255,0.6), inset 0 -2px 4px rgba(0,0,0,0.2), 0 0 15px 6px rgba(59, 130, 246, 1); } }
        @-moz-keyframes bluePulse { 0%, 100% { box-shadow: 0 2px 8px rgba(0,0,0,0.3), inset 0 2px 4px rgba(255,255,255,0.5), inset 0 -2px 4px rgba(0,0,0,0.2), 0 0 5px 2px rgba(59, 130, 246, 0.6); } 50% { box-shadow: 0 2px 12px rgba(0,0,0,0.4), inset 0 2px 4px rgba(255,255,255,0.6), inset 0 -2px 4px rgba(0,0,0,0.2), 0 0 15px 6px rgba(59, 130, 246, 1); } }
        @keyframes bluePulse { 0%, 100% { box-shadow: 0 2px 8px rgba(0,0,0,0.3), inset 0 2px 4px rgba(255,255,255,0.5), inset 0 -2px 4px rgba(0,0,0,0.2), 0 0 5px 2px rgba(59, 130, 246, 0.6); } 50% { box-shadow: 0 2px 12px rgba(0,0,0,0.4), inset 0 2px 4px rgba(255,255,255,0.6), inset 0 -2px 4px rgba(0,0,0,0.2), 0 0 15px 6px rgba(59, 130, 246, 1); } }
        @-webkit-keyframes tokenPulse { 0%, 100% { -webkit-transform: scale(1); transform: scale(1); } 50% { -webkit-transform: scale(1.08); transform: scale(1.08); } }
        @-moz-keyframes tokenPulse { 0%, 100% { -moz-transform: scale(1); transform: scale(1); } 50% { -moz-transform: scale(1.08); transform: scale(1.08); } }
        @keyframes tokenPulse { 0%, 100% { -webkit-transform: scale(1); -moz-transform: scale(1); -ms-transform: scale(1); transform: scale(1); } 50% { -webkit-transform: scale(1.08); -moz-transform: scale(1.08); -ms-transform: scale(1.08); transform: scale(1.08); } }
        .player-label { position: absolute; top: 5px; left: 50%; -webkit-transform: translateX(-50%); -moz-transform: translateX(-50%); -ms-transform: translateX(-50%); transform: translateX(-50%); background: rgba(255,255,255,0.9); padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold; box-shadow: 0 2px 6px rgba(0,0,0,0.2); z-index: 10; }
        .player-home.red .player-label,
        .player-home.yellow .player-label {
            display: none !important;
        }
        .player-home.blue .player-label.hidden-label,
        .player-home.green .player-label.hidden-label {
            display: none !important;
        }
        .player-progress { position: absolute; bottom: 5px; left: 50%; -webkit-transform: translateX(-50%); -moz-transform: translateX(-50%); -ms-transform: translateX(-50%); transform: translateX(-50%); background: rgba(0,0,0,0.7); color: white; padding: 3px 10px; border-radius: 10px; font-size: 11px; font-weight: bold; z-index: 10; }
        .turn-timer-ring { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: calc(85% + 4px); height: calc(85% + 4px); z-index: 5; pointer-events: none; opacity: 0; transition: opacity 0.3s ease; }
        .turn-timer-ring.active { opacity: 1; }
        .turn-timer-ring circle { fill: none; stroke: #000; stroke-width: 3; transform: rotate(-90deg); transform-origin: 50% 50%; transition: stroke-dashoffset 0.6s ease; }
        .turn-timer-ring circle.warning { stroke: rgba(239, 68, 68, 0.8); }
        .path-container { position: relative; background: transparent; }
        .path-container.top { grid-area: 1 / 2 / 2 / 3; } .path-container.right { grid-area: 2 / 3 / 3 / 4; } .path-container.bottom { grid-area: 3 / 2 / 4 / 3; } .path-container.left { grid-area: 2 / 1 / 3 / 2; }
        .path-cells { width: 100%; height: 100%; display: grid; }
        .path-container.top .path-cells, .path-container.bottom .path-cells { grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(6, 1fr); }
        .path-container.left .path-cells, .path-container.right .path-cells { grid-template-columns: repeat(6, 1fr); grid-template-rows: repeat(3, 1fr); }
        .cell { border: 1px solid rgba(200,200,200,0.4); background: rgba(255,255,255,0.7); display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: bold; color: #333; position: relative; }
        .cell-number { position: absolute; top: 2px; left: 2px; font-size: 9px; color: rgba(0,0,0,0.5); z-index: 1; pointer-events: none; display: none; }
        .cell.red-path { background: #ef4444; } .cell.green-path { background: #22c55e; } .cell.yellow-path { background: #eab308; } .cell.blue-path { background: #3b82f6; }
        .cell.safe { position: relative; } .cell.safe::before { content: 'â˜…'; position: absolute; font-size: 16px; color: rgba(255,215,0,0.8); }
        .center-area { grid-area: 2 / 2 / 3 / 3; position: relative; display: flex; align-items: center; justify-content: center; perspective: 1500px; perspective-origin: center center; }
        .center-triangle-container { width: 70%; height: 70%; position: relative; -webkit-transform: rotate(45deg); -moz-transform: rotate(45deg); -ms-transform: rotate(45deg); transform: rotate(45deg); }
        .center-triangle { position: absolute; width: 0; height: 0; border-style: solid; }
        .triangle-red { top: 0; right: 0; border-width: 0 50% 50% 0; border-color: transparent #ef4444 transparent transparent; }
        .triangle-blue { bottom: 0; right: 0; border-width: 0 0 50% 50%; border-color: transparent transparent #3b82f6 transparent; }
        .triangle-yellow { bottom: 0; left: 0; border-width: 50% 0 0 50%; border-color: transparent transparent transparent #eab308; }
        .triangle-green { top: 0; left: 0; border-width: 50% 50% 0 0; border-color: #22c55e transparent transparent transparent; }
        .golden-ring { position: absolute; width: 95%; height: 95%; border-radius: 50%; background: radial-gradient(circle at 30% 30%, #ffd700, #ffed4e, #ffd700, #b8860b); border: 0.5mm solid #ffd700; box-shadow: 0 0 20px rgba(255, 215, 0, 0.8), 0 0 40px rgba(255, 215, 0, 0.5), inset 0 0 15px rgba(255, 255, 255, 0.6), inset 0 0 30px rgba(255, 215, 0, 0.4), 0 4px 15px rgba(0, 0, 0, 0.3); z-index: 15; -webkit-animation: goldenShine 3s infinite ease-in-out; -moz-animation: goldenShine 3s infinite ease-in-out; animation: goldenShine 3s infinite ease-in-out; }
        .golden-ring::before { content: ''; position: absolute; inset: 0.5mm; border-radius: 50%; background: #000000; }
        @-webkit-keyframes goldenShine { 0%, 100% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.8), 0 0 40px rgba(255, 215, 0, 0.5), inset 0 0 15px rgba(255, 255, 255, 0.6), inset 0 0 30px rgba(255, 215, 0, 0.4), 0 4px 15px rgba(0, 0, 0, 0.3); } 50% { box-shadow: 0 0 30px rgba(255, 215, 0, 1), 0 0 60px rgba(255, 215, 0, 0.7), inset 0 0 20px rgba(255, 255, 255, 0.8), inset 0 0 40px rgba(255, 215, 0, 0.6), 0 4px 20px rgba(0, 0, 0, 0.4); } }
        @-moz-keyframes goldenShine { 0%, 100% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.8), 0 0 40px rgba(255, 215, 0, 0.5), inset 0 0 15px rgba(255, 255, 255, 0.6), inset 0 0 30px rgba(255, 215, 0, 0.4), 0 4px 15px rgba(0, 0, 0, 0.3); } 50% { box-shadow: 0 0 30px rgba(255, 215, 0, 1), 0 0 60px rgba(255, 215, 0, 0.7), inset 0 0 20px rgba(255, 255, 255, 0.8), inset 0 0 40px rgba(255, 215, 0, 0.6), 0 4px 20px rgba(0, 0, 0, 0.4); } }
        @keyframes goldenShine { 0%, 100% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.8), 0 0 40px rgba(255, 215, 0, 0.5), inset 0 0 15px rgba(255, 255, 255, 0.6), inset 0 0 30px rgba(255, 215, 0, 0.4), 0 4px 15px rgba(0, 0, 0, 0.3); } 50% { box-shadow: 0 0 30px rgba(255, 215, 0, 1), 0 0 60px rgba(255, 215, 0, 0.7), inset 0 0 20px rgba(255, 255, 255, 0.8), inset 0 0 40px rgba(255, 215, 0, 0.6), 0 4px 20px rgba(0, 0, 0, 0.4); } }
        .dice { width: 46px !important; height: 46px !important; position: absolute; top: 50%; left: 50%; margin-left: -23px; margin-top: -23px; transform-style: preserve-3d; transform: translate3d(0, 0, 0) rotateX(0deg) rotateY(0deg) rotateZ(0deg); transform-origin: center center; z-index: 25; will-change: transform; transition: none; -webkit-transform-style: preserve-3d; -moz-transform-style: preserve-3d; }
        .dice-face { position: absolute; width: 46px; height: 46px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 50%, #1d4ed8 100%); border: none; border-radius: 5px; box-shadow: inset -2px -2px 5px rgba(0,0,0,0.4), inset 2px 2px 5px rgba(255,255,255,0.2), 0 3px 10px rgba(0,0,0,0.5); backface-visibility: hidden; -webkit-backface-visibility: hidden; -moz-backface-visibility: hidden; }
        .dice-face::before { content: ''; position: absolute; top: 2px; left: 2px; right: 2px; bottom: 2px; background: linear-gradient(145deg, rgba(255,255,255,0.1), transparent); border-radius: 3px; pointer-events: none; }
        .dot { width: 8px; height: 8px; background: radial-gradient(circle at 30% 30%, #333, #000); border-radius: 50%; box-shadow: inset 0 1px 2px rgba(0,0,0,0.9); pointer-events: none; position: absolute; }
        .dice-face.front { transform: rotateY(0deg) translateZ(23px); }
        .dice-face.back { transform: rotateY(180deg) translateZ(23px); }
        .dice-face.right { transform: rotateY(90deg) translateZ(23px); }
        .dice-face.left { transform: rotateY(-90deg) translateZ(23px); }
        .dice-face.top { transform: rotateX(90deg) translateZ(23px); }
        .dice-face.bottom { transform: rotateX(-90deg) translateZ(23px); }
        .dice-1 .dot { display: none; }
        .dice-1 .dot:nth-child(5) { display: block; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .dice-2 .dot { display: none; }
        .dice-2 .dot:nth-child(1) { display: block; top: 7px; left: 7px; }
        .dice-2 .dot:nth-child(2) { display: block; bottom: 7px; right: 7px; }
        .dice-3 .dot { display: none; }
        .dice-3 .dot:nth-child(1) { display: block; top: 7px; left: 7px; }
        .dice-3 .dot:nth-child(2) { display: block; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .dice-3 .dot:nth-child(3) { display: block; bottom: 7px; right: 7px; }
        .dice-4 .dot { display: none; }
        .dice-4 .dot:nth-child(1) { display: block; top: 7px; left: 7px; }
        .dice-4 .dot:nth-child(2) { display: block; top: 7px; right: 7px; }
        .dice-4 .dot:nth-child(3) { display: block; bottom: 7px; left: 7px; }
        .dice-4 .dot:nth-child(4) { display: block; bottom: 7px; right: 7px; }
        .dice-5 .dot { display: none; }
        .dice-5 .dot:nth-child(1) { display: block; top: 7px; left: 7px; }
        .dice-5 .dot:nth-child(2) { display: block; top: 7px; right: 7px; }
        .dice-5 .dot:nth-child(3) { display: block; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .dice-5 .dot:nth-child(4) { display: block; bottom: 7px; left: 7px; }
        .dice-5 .dot:nth-child(5) { display: block; bottom: 7px; right: 7px; }
        .dice-6 .dot { display: none; }
        .dice-6 .dot:nth-child(1) { display: block; top: 3px; left: 8px; }
        .dice-6 .dot:nth-child(2) { display: block; top: 3px; right: 8px; }
        .dice-6 .dot:nth-child(3) { display: block; top: 19px; left: 8px; }
        .dice-6 .dot:nth-child(4) { display: block; top: 19px; right: 8px; }
        .dice-6 .dot:nth-child(5) { display: block; top: 33px; left: 8px; }
        .dice-6 .dot:nth-child(6) { display: block; top: 33px; right: 8px; }
        .roll-dice-button { position: fixed; bottom: 30px; left: 50%; -webkit-transform: translateX(-50%); -moz-transform: translateX(-50%); -ms-transform: translateX(-50%); transform: translateX(-50%); background: linear-gradient(135deg, #ffd700, #b8860b); color: #000; border: none; border-radius: 25px; padding: 15px 40px; font-size: 18px; font-weight: bold; cursor: pointer; box-shadow: 0 6px 20px rgba(255, 215, 0, 0.4), 0 0 30px rgba(255, 215, 0, 0.3); z-index: 1000; -webkit-transition: all 0.3s; -moz-transition: all 0.3s; transition: all 0.3s; pointer-events: auto; }
        .roll-dice-button:hover { -webkit-transform: translateX(-50%) scale(1.05); -moz-transform: translateX(-50%) scale(1.05); -ms-transform: translateX(-50%) scale(1.05); transform: translateX(-50%) scale(1.05); box-shadow: 0 8px 25px rgba(255, 215, 0, 0.6), 0 0 40px rgba(255, 215, 0, 0.5); }
        .roll-dice-button:active { -webkit-transform: translateX(-50%) scale(0.95); -moz-transform: translateX(-50%) scale(0.95); -ms-transform: translateX(-50%) scale(0.95); transform: translateX(-50%) scale(0.95); }
        .roll-dice-button:disabled { opacity: 0.5; cursor: not-allowed; }
        .back-button { display: none; position: fixed; top: 10px; right: 10px; background: rgba(239,68,68,0.9); color: white; border: none; border-radius: 20px; padding: 10px 20px; font-size: 16px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 1000; -webkit-transition: transform 0.2s; -moz-transition: transform 0.2s; transition: transform 0.2s; }
        .back-button:hover { -webkit-transform: scale(1.05); -moz-transform: scale(1.05); -ms-transform: scale(1.05); transform: scale(1.05); }
        .piece-selector-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; align-items: center; justify-content: center; }
        .piece-selector-modal.show { display: flex; }
        .piece-selector-content { background: white; border-radius: 20px; padding: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); text-align: center; min-width: 300px; }
        .piece-selector-title { font-size: 20px; font-weight: bold; color: #333; margin-bottom: 20px; }
        .piece-selector-buttons { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        .piece-btn { padding: 12px 20px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; transition: transform 0.2s; background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%); color: white; box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3); }
        .piece-btn:hover { transform: scale(1.05); box-shadow: 0 6px 15px rgba(59, 130, 246, 0.5); }
        .piece-btn:active { transform: scale(0.95); }
        .voice-icon { position: relative; width: 45px; height: 45px; cursor: pointer; transition: all 0.3s; }
        .voice-icon svg { width: 100%; height: 100%; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3)); }
        .voice-icon:hover { transform: scale(1.1); }
        .voice-icon.muted::after { content: ''; position: absolute; top: -2px; left: 50%; transform: translateX(-50%) rotate(45deg); width: 3px; height: 50px; background: linear-gradient(to bottom, #ff0000, #cc0000); border-radius: 2px; box-shadow: 0 0 8px rgba(255,0,0,0.8); z-index: 10; }
        .player-label.has-voice { display: flex; align-items: center; justify-content: center; gap: 5px; }
        @keyframes micPulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        .voice-icon.active { animation: micPulse 1s infinite; }
        .voice-status { position: fixed; top: 50px; left: 50%; transform: translateX(-50%); z-index: 2000; display: flex; align-items: center; justify-content: center; gap: 15px; }
        .voice-status.show { display: flex !important; }
        .voice-status.connected { }
        .voice-status.disconnected { }
        .center-voice-icon { width: 130px; height: 110px; cursor: pointer; transition: all 0.3s; flex-shrink: 0; }
        .center-voice-icon svg { width: 100%; height: 100%; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3)); }
        .center-voice-icon:hover { transform: scale(1.1); }
        .center-voice-icon.active { animation: micPulse 1s infinite; }
        .voice-control-buttons { display: flex; gap: 15px; align-items: center; }
        .voice-btn { padding: 8px 16px; border: none; border-radius: 8px; font-size: 14px; font-weight: bold; cursor: pointer; transition: transform 0.2s; background: #ffd700; color: black; box-shadow: 0 4px 10px rgba(255, 215, 0, 0.5); }
        .voice-btn:hover { transform: scale(1.05); box-shadow: 0 6px 15px rgba(0, 0, 0, 0.5); }
        .voice-btn:active { transform: scale(0.95); }
        .sound-toggle-icon { position: fixed; top: 10px; left: 10px; width: 36px; height: 36px; border-radius: 50%; background: #22c55e; border: none; cursor: pointer; z-index: 1001; display: flex; align-items: center; justify-content: center; transition: all 0.3s; box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
        .sound-toggle-icon:hover { transform: scale(1.1); }
        .sound-toggle-icon.muted { background: #ef4444; }
        .sound-toggle-icon svg { width: 20px; height: 20px; fill: white; }
        
        .stream-btn {
            position: fixed;
            top: 10px;
            left: 50px;
            background: linear-gradient(135deg, #e11d48 0%, #be123c 100%);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(225, 29, 72, 0.4);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }
        .stream-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(225, 29, 72, 0.6);
        }
        .stream-btn.streaming {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.4);
            animation: streamPulse 2s infinite;
        }
        @keyframes streamPulse {
            0%, 100% { box-shadow: 0 4px 15px rgba(34, 197, 94, 0.4); }
            50% { box-shadow: 0 4px 25px rgba(34, 197, 94, 0.8), 0 0 30px rgba(34, 197, 94, 0.5); }
        }
        .stream-btn .live-dot {
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            animation: liveDot 1s infinite;
        }
        @keyframes liveDot {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        .stream-viewer-count {
            position: fixed;
            top: 14px;
            left: 150px;
            background: #22c55e;
            color: white;
            padding: 8px 12px;
            border-radius: 15px;
            font-size: 14px;
            z-index: 1000;
            display: none;
        }
        .stream-viewer-count.show {
            display: block;
        }
        
        .warning-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        
        .warning-modal {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            text-align: center;
            max-width: 400px;
        }
        
        .warning-icon {
            font-size: 60px;
            margin-bottom: 20px;
        }
        
        .warning-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }
        
        .warning-message {
            font-size: 18px;
            color: #666;
            margin-bottom: 30px;
        }
        
        .warning-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        
        .warning-btn {
            border: none;
            border-radius: 10px;
            padding: 12px 30px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .warning-btn:hover {
            transform: scale(1.05);
        }
        
        .warning-btn:active {
            transform: scale(0.95);
        }
        
        .warning-btn-exit {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            box-shadow: 0 4px 10px rgba(239, 68, 68, 0.3);
        }
        
        .warning-btn-stay {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            box-shadow: 0 4px 10px rgba(34, 197, 94, 0.3);
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        
        .modal-content {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border-radius: 25px;
            padding: 50px 40px;
            max-width: 450px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.7), 0 0 0 10px rgba(212,175,55,0.3);
            border: 4px solid #d4af37;
        }
        
        .winner-emoji {
            font-size: 100px;
            margin-bottom: 20px;
            animation: bounce 0.5s ease-in-out;
        }
        
        @keyframes bounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
        
        .modal-title {
            font-size: 32px;
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 20px;
            text-shadow: 0 2px 10px rgba(255,215,0,0.5);
        }
        
        .modal-message {
            font-size: 20px;
            color: #e2e8f0;
            line-height: 1.6;
        }
        
        .exit-countdown-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10001;
            justify-content: center;
            align-items: center;
        }
        
        .exit-countdown-content {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            border-radius: 25px;
            padding: 50px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(239, 68, 68, 0.7);
            border: 4px solid #fca5a5;
        }
        
        .exit-countdown-title {
            font-size: 28px;
            font-weight: bold;
            color: white;
            margin-bottom: 30px;
        }
        
        .exit-countdown-number {
            font-size: 120px;
            font-weight: bold;
            color: white;
            margin: 20px 0;
            text-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            animation: countdownPulse 1s infinite;
        }
        
        @keyframes countdownPulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }
    </style>
</head>
<body>
    
    <button class="back-button" onclick="window.location.href='/games'">Ø±Ø¬ÙˆØ¹</button>
    <audio id="remoteAudio" playsinline style="display:none;"></audio>
    <audio id="pieceMoveSoundEffect" style="display:none;" preload="auto">
        <source src="data:audio/mpeg;base64,SUQzAwAAAAAAaVRBTEIAAAANAAAATHVkbyBDbGFzc2ljVElUMgAAAA0AAABEaWNlIFJvbGxpbmdUWUVSAAAABQAAADIwMTdURFJDAAAABQAAADIwMTdUUEUxAAAAEwAAAFN1ZGhha2FyIEthbmFrYXJhav/7wGQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEluZm8AAAAPAAAABQAAESQAMzMzMzMzMzMzMzMzMzMzMzMzM2ZmZmZmZmZmZmZmZmZmZmZmZmZmmZmZmZmZmZmZmZmZmZmZmZmZmZnMzMzMzMzMzMzMzMzMzMzMzMzMzP//////////////////////////AAAAOUxBTUUzLjk4cgHCAAAAAAAAAAA04CQGwE0AAOAAABEkuIGntQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//vAZAAJJc99vbAmY/JhCyisDCP0EOH9DACZm4Ltv6JUxJsoAGQgAfkoES/EREQ7YQznp0YQhybIEED04uydtF6eAESdRwRDd7EIhyacOTqH1984MKMLDA8hMHM5e/dfGv+nMLKr7rObM3+vjlIV6+69fAYGZmvX267a/mDAwiOz/7zv0hfWRYZvzra/+3r3uvXtr36ONrzM/yk4s5u+nZm/sywYGFb4hHjb52T35k7JYhk9IeJ1bBmIYHwbiWT2jBz6a2IYH1eQxPnCgrgTI4gEwEwDkoPA7CsSye8eAAqyAAAF5ziE5xISImiR/9EicQqBv+7nwqem7xPgAR/om7n6dRM4miDHjHABlAuYBvIHAAxknksxjHq/4AA/XfDv9d3/6ILQvp8RCcWfawTvDwgcs/ggUKHO7/UCAIeoMf//u+mZ6i+JDohzkUEznFvrFxF1/57OeZ7gyY2j43NVJPmTjZ2QbwzmtaGZ6bEs/i09ZIy2xqPMzEVtJpu/H2GNS3GwrLfa8T3eyp0rS4yOuIbo37iOhDrsnNkxRqG5Z0GYpt56JyBpezkvvPH691e46yhLE/6sV8eOk47VasNg7cJByrLbe6cMWjqM+OW0E2Zk4Sh+6IZs7EEhmWiWuTCefeH9oDEvrGrNGeiAVzLG1qqa7jMyJCvICoBUthBgaFI60SSXejYZFbwgbLR7R5AgHiqLgcwQBpBFpNhNGdEqlWksu6eoFS6RRCQJuSGRWjIDKhSEFVVKZbcCbTS07Ypgm7lE0BR60ULMZCdA5lu6AO2KrLLInMt9vJ7Pam6szPsNNXGc35faJd9QQ5muxSUwYazzRmnKTcjpoYkeUjSRhq8V//y/Xf3z88RXtVc3ckdz/LT1Tvo6VScQ43OYm1ZJiRo+7WTVkRIJOqLOgnhDFhCyWKoVpWIqBlyOokYNspVPsbY9jZhMbMD6SpRqmeRStsUmkR2Imla7PuL/+8JkLIAEpH9DBQUAAOGPyGWksABY4Zc9uPmAAr6y57cS8ADiGeehYsztXiCyBWDxo4qBZRBIPtJHYwthgKigbSOsHVDwlhQnFADicEQyI5oPiAaCQhAQD8Eg8D4PiVAQAAAkIsApYGBQRALoFgVMmBlQhOB4Gqcma+cF8lndC8TBasJ5TLwAi2NWJ5oNBkGIktoKZ9cMiQrRpQ7EdwkDy8OJgiLI/px7I6CVCKgB+XCqQCcOwNC+IZQdLkJCjR0EEXgPKi7fp5RPDhhOdmKUraeJC2baX/NIN09YicH51XGeH5TOEJozRDx8RYri5WclyBQ6kRVu1ZEwer0b6xbdmvqjii09usm/rGkJyrGf25BvXZhibLLTzz7J46lbvdr4k7DFkJhz42iwvXVdlXU5rVvcZfWFhgrWEt5iN+i07xUNggMXAIPAMKgUDicaz+NFyHX9J9hRBfPz2aCRoKgTwC7xaxAK0PXFfHeH5CDBqIIXBs2FlA7A9AlhqB6h1/E/CyCyFzgkgrYhw3RGAWsX2hjMaY+wxOG+FUb4OEK1EpkEPfykFzYarHeAEAOUIIWRc7kyUjpO/8GwYHqE6OWJzC0ABvYGKQDWBy0iJqHUM+FuxMxZ7WfbwtIE3hZWB7GGcBawQ9EWWFh4uIQKRAipiV08xURJSH/oIR2Gf/L5fXGbW/+PshxegCYcEgcEgUEgcDgUAShKb+SXBCykYvRGbKAZ9TPNKim9ND8M4WiOGm2W1rCHpMOMWM+j1QULW/rguxAznJeI4jCeuB2ly+qfWg0GNIJQ64x4h2MqNe23v//oYQ8vhYCTj4Rkc3jhYoY+P/j5vvGjIVlX6fZhRAFhDU/ZV4O4fK04oun/+//+crNoWs7zzplXlzZoLIX8zHCB/XC1///////4l/////e/7P////+1wrK4ABxRCIMpANBoABESuuY80FP5pqirNOBlOvx9jrlTGY68CYX/+8BEEgAFbWZX7j3gAK1sux3HvAAVpVll2boAArqu7LcfMAHLK10hxAaCFu39LarmW6sLGr38+L0eXz9vEYhasCDz5nfZ16x8PNXfgxE6o2Nql9vDgal093DhZVB1oetmWc6Pp9+8OkPd8+l67kmmL+o2MnZYwDgFQSSJNLN//6+lZb7/+b6OOO8Lm7975Z2+f/////Nf3J59//f/lhY6jWYeIbPt4wKiRQLB1zpIuB2MtClwhkRCkuILfXjvTf1iPYX7dij2UVwWyykjUXQNhxpNNF4/GlWY7izwffKgByBgFgYF3uG423n7DTHIMQBzFzZWbE9fq2/To8B3BvnGdbnh/Ndtjxr3vbyV8BOKAy1e54//iONJdf/43ntsfdFOjwwBwHRf21Dn//9vEgN7un1q8dWQBxoW/OA5FhD33///////+//////+TgGm+QhPtysS2U4W844Be8EkATAEAVADAMMJEAPDU5E7gdq43ZeHEQVAOVe2AcFlgShmHcOBMgBmSkoHCeA0CkDBAQEkgUDCykkTFAL3CAYN1RDXokNanAwRUDBFgWVAY8ICQkmiLG7o/BZCAATAzREOQHYDaRDS8s1Rb8G9xBYcoG1jwW+iCijE1RRWY/xzTIXMM6Q0dpcK5PJUVoopOv/kaQU0OEWPrSSLxe///8cTmBeWpEyWXVJHw7kmQEgAAAAAgEAgEAgADUAwwlEGKf6POI/rOExfh/EiLDFvYiosQ1yJD+XAvyDcokRmw5FQuQhiRDhXQuSR7qEJhPyFExAjoAaQhwgGQWS5idJ1K2DRwZZDOgsqGOIMUqSX+NUcoR0LPD4hzRc1daReT/jMkCJ8niiOaUCJFRJ16Kkkv+TJdMDhuXVl1EjiJfX//4sYjoTsPsVsLKHyTQtxAiMGWGmITDaSRZLXW1RkKgAQAQiNtaEJQWbVqf5yKjNay/zfQ2m3/+AAjA2SNLgVXBsoNv/7wmQSAAU0aM2eYoAAom0Zs8zQABKR+vrcFAALCD+gW5KQAEo3Xh2Qy6FhIWi1OY+KREajPCFR2pVUfj4H4SkJ2IcRZWj/pFIiR02WRVVJdFf8mi2M8K1FwlghpIjnaldaP/EYiOhKQpwNrBZoc4d5EQ/YZM1NVLqLpdNTIvXda0OtQ5pNDKi5SyQUjBSIzIrws0iAhYmSMf1opLRWpS1//9I4Xj6gAAAASm5ZTQpNo2gt90NAgxPkqy2c2JxH2cv8AUgBY2yWBsMoAoIWWUTFVThkUdwdCAABXor5AhlisYnKSX8zI4SkJ2Lxl2X/IsUisUTZEybWqj/IaLlFwmLEOIaREmlXSdl0fdT1jGoEOKAuYZohw4jpAi3RpVLrUktJT2QfYuiziNFylkc0c0ckukOKJ4gRwiyWtazFK1Rxd1q19vpHC8fUDkIQo/3IT4Q/s3KirdcMzX//syqv/7MzNf+18qqr/wzM1cMzMzLKqqrX8qqqpJQsLCx1yoq2q/DXAsLCzKHINQag2Fm5XYpVlVUkVFbUVBqDUPTdoZrlVVf/lRUVa+VFRUOQaixzMzMzKqrqpIqzM16kiraqq1FlB0DYGwfWoqKiwsLHNJIqKtIqDUBUBUBUGoNRYaAOIkYtCKRSKRSKRSh1UhFIpFIpCopRTQikEQRDIpISIVEzVkIIgBACKpSksiIhUKhS5ZFK1RSKUW2qhIRSKRS1sWUMaRIo+UpWhFIVRIkSJqVqodVQxpEKhUKkKFChjGMY/xQkIpFIpQtb4//+KEhFIpFIpFIpRb88kQqFRLlb//KKFDGkSJEiVQoWY5SyL1KX9xj7jGMY5////KUfcYxjGMpS21UIpFKKW+4x/9xjn8peUkSJERCoVIY5UlkQqFSGNUxBTUUzLjk4LjJVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVf/7wGQeD/AAAGkAAAAIAAANIAAAAQAAAaQAAAAgAAA0gAAABFVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVTEFNRTMuOTguMlVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV" type="audio/mpeg">
    </audio>
    <audio id="diceRollSoundEffect" style="display:none;" preload="auto">
        <source src="data:audio/mpeg;base64,SUQzAwAAAAAReENPTU0AAAA4AAABZW5n//4AAP/+aAB0AHQAcABzADoALwAvAHMAbwB1AG4AZABzAC0AbQBwADMALgBjAG8AbQAAAFRDT04AAAArAAAB//5TAG8AdQBuAGQAIABFAGYAZgBlAGMAdABzACAAfAAgAG0AcAAzAAAAUE9QTQAAABYAAEVhc3kgQ0QtREEgRXh0cmFjdG9yAP9USVQyAAAAMQAAAf/+aAB0AHQAcABzADoALwAvAHMAbwB1AG4AZABzAC0AbQBwADMALgBjAG8AbQAAAFdYWFgAAAAcAAAB//4AAGh0dHA6Ly93YXYtbGlicmFyeS5uZXQvAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/+5BkAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABYaW5nAAAADwAAAE8AAEeRAAQLFh8fIy44QEBJUFdgYGt0d319gISKio+RlJaWl52ipaWrsba4uLm7vLy+v8HCwsTFx8jIysvNzs7Q0dPT1NbX2dna3N3f3+Di4+Xl5ujp6evs7u/v8fL09fX3+Pr7+/3+/wAAADxMQU1FMy45OHIErwAAAAAAAAAANCAkCLhNAAHMAABHkYvY6+oAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/+3BkAAAAqADS+CAACCDAGh0AAAEI1QND7LBHIbUFZj2cMBUACAAAAAGAH4AGUcj//5P//+v//iAABsKQCDAYcA+QoPtn0FAACDvnP/UGHr//8//////xOH4rbzHdGWR3+4A0RzJ8B0htAlYoJXLsOYggJHwZewewK2MfdfYqoqAzd0O4l2UqPqtHZZLPI/lZ//6sBG////8ylKbylqoCylDMiEJAlW5E6GQjnYe5OoKOAzmDNaBIESSJIkmJ7WW4V0hR3/iK/4v////0///8UVCCQUFBQUKCgoKCQUFBUIUFBQUEgoKCgoUFBQUEgoKCgoUFBQUEgoKCgoUFBQUEgoKC////////v////ioVeHgxACIL9wAMMGwmIYqN7nSVFAl+xSUVaC8Ll2ZJhcoZ+9tNZC5aOxSM//ugZBWAAlQiTP1gwAohgHnfrAABGX07W7m8NAKIp2q/M4RAna8ZTXkXnf05qP/e76fAAPDw+OOAAAzoAIjh5c//8PNph4YCCMBwAAG7ARY3tPuDW/84CCwfpDGUB8P5T/h8Th+6WogUBgICMdiwOp/AAxOQC4YYkbg4OXaYeNsHQBgYMMODgcHmHBy7FtPi08wIOAxAGLZIy+aOqTGFryx2hUkOOGhWxUt3EVOInipe7i5GSJJo+NpICzEHUzJ8lYYuziUoB2HrvfurDaJgiQ3CNIPwertakM1lL41F4w7D8MTd+vSOxAiSCqqfTqUUDxGE3puLuJScpKSxLLFqWZ8w/4KisFqrvnK7OUUYm1+Lw5Sc7Uw7/a+WFvX/7n43GXv27/Hfy58/3lPDcPu5GLDI8IBsCgEmDkFw8FQketAByMC00oigMEDiGBjIPIztrGEQh9iaCRajTI+7k4BiKCFvwedQCPQVEW0p7z7wd/9sc+2/d/DdyKUEsicjicTi1Sxunp6j928Jf13J/WGHy+kpLFvD88/7//u33887G69uxvt6nt5//P+9eyqWM8KnKSkrssdyKS+nz53D/7Yu2/+ntbhyWWPoZ//u179JKKSX09+xQoBgAgAABElFWTfgAddzCh806NMOUQaNmYgpjwWDj4KARjACpoJEpmIQYeDjy6acZmMC4ODl//vAZBuABgVJV25vAJKpSPrtzeASFbE7TfmngAJdJuk3NPAAYRwKe4QR6guJkCepZgveoCkOkM/z/mGgIiDmqUr5SWVdKn3b6f7NQUy6rMYxqnxlGcCy6ZdVYarSV/jsetTk9Yu6paSJfVgWMzMzqNOVBMBXsaljJ9b+OPbcyu13ebl0rdqembb1SrWXe43JqXQzU1j//y1AUEuTAsw/WP/GY/FZvCRR2/h5VxXv9w4FAJBCAYjaVXVvAACLxI5OwOTbEwFNxkAUYQIufFhoDNPJAQUqvEAKngzIRiAiAE9Z8wlHg5php8xxm7ULT9NBtw9AFSRYPywCRV6blrHWNzGrLohFrcUx1lvUotxqNu1FqeB5TLK9Sjq2blLZu3aWkq43IbsWYvXqW5d2O0uduO0spf2my3l/WB4QHA0O1JVR73Ds7+fP/981+eO9f//qb5nZJYNLOkjEUgIkAAAAqN2X7PXDYAGEKFqxJuwMxlQWFAE4VBIkDEBEmLGzuqYg0ARAlMxgiXtGUBXGsJOEoCTCtVhpXbSaBYDAPw53cuRcSan4sVGCDlQn9kbGO0GGhJ1mOKWSolg1FfFatMTe/UqU0jJUecDtE0W3uXJXMbCr1VFOVnbFQ3XdyMvxMo5VZd7rX7DBVDtjY/+WOqGKZDmC68oP/////eP9f///LJSD8PJY5za6AYBQirjWcz8g9ABCLaEAJSVwNNSEKhiEGyZ2RIaZ8U2NjEicmWtRBJk1XZulgOdOr6uQo8S/qh6uH5c0q6WS4asCdOVrUdrTWamFXw1Kp9sSmfqmH82/ZWJUH0lVe3slKxmOXWMfd3KZ42MTAybaoMyzGjRspaSBX/uWp431v9XPYSsz5Mz//////f9P///l/Hh3o4WGQyUAADMQMgGzJZvJaTgAxoExJ40PM6S0wzcwwVtDOtTJE1FxEGMgPMyZCG5jBwgNJEhwoIIh0SWALTFIOUH/+7BkH4AGfU1W/msgApNJCu/MvBIOwS1X/YQAIUibbH+yMAXBwi/GbtEMMJyHetOQ5TTG0M2IwkQUK4rP3insWPJGMsbEgkaS7K8XCbLnJnZmLUOOw/EsvyiMtxd2MyrJ25+QTOVFDj956lD+Q4+0M1H+lM47ViKRaeppiXZPo7im799dty37jtmCnRZa+uqWMz9WOV/rwxUyex23fdShi8OXb//En6+5LqbVN//arSqrTWRsCAkgAIAIAYgBEwaLIcvABwUhZIAqJIlUljkUdsGCiEEwXjQUcuXiJQ16AoKhNHGXME8F2CJKd+4PDyIEijTxDpqnJMfyrmVrBH9Ke93ksCY9lNmA4s2FW8iR6mU++sQXqTxJWH/e8T+ApWWS8SNaK3zRN3/xSJrf9/iChrDa27OG4doLNN73+751/+plFPAUUOvVDM5CAAQAxuPcIdRMw3UEgRWEZS2iDawtuJLubI2R2p19nlUEQ9BYJxQwaHpQTEQYIBgNCxpLC009rcENI5lpz+hYh2ol1Xob3LpUrMyVwMPMe5PPFVUkwbTa8EMUcqk0K2VpMioqIpCOfU1UvzbvL9V/IuLi75XIzihoqv//oAWZFbgcsuYAAiECNRKGnJztfzVNcvUBEI4EGFjOhJs5ysJmR//2UKQjIGtUODEijchugi8Vo61tzdWL+MzNk1XNAgMSwO/4VIqaqHYiEya2vv4Irm5ZAIAGISqcOqo6sR21QALw7MwmRmiBlwkRhIiNNTknBCoVSPhHPymo0zcYS8yW0dja2c7eXq+7bt+xm8RsFlzJUle6/Zpnopo3M5utrbziyXtCs/tFb//7cGQxAANTStf7DDIoQgP7H2EiTw4FJ1X1kwApMx4qvrJQBAzVd7vnf7Y5M9+y7iiLfvfQAsIDLHOQNUjmZwCAaX9WifFCJw9/T04kvj+zis7fbCUEAmQvmr//tZSzuhXcYMoX3CJMa+npxEit71rSQiAAC9bNwNTgK86JQOiADSJFMpu6EEC334f2ncmPv7KGSo06URxhZFrZqvWFwxCfv/3fRiRUmHBhyBRZAlWblZ/3fN7XCNIIJRULajUWbZM7Vf6CRH7B+d+xUyQTJuijiuac02YhVkkp7b2S3CiteiADAGpLJwAuAcOxnBwKFBzBQb1d4Qo2Sb7rmOG+FCgMU5W8zuwgLChBsxW/UqkeZxjlRzpe7OZdHKi2Lm2dFMpftpcehyXSmiyDVViaVgAQExIyMppbvv7/+8BkBoAFaE5Sfm3gAI+H6j/NvAAazTVXuayQSm2faPczgADL6ACYhLnAMCMDADLj8ADpi5mm8YCJiIFIQIwQLcpsuKRap3QIhFjuR4AOMg/U+TcpmpzLy3NouAcZq4OlcNTgxH/utLHSyKdOLZ/rhYgti6aFDHgsupXNzUEPUGxeVSlM1kU6ysqc6JLuEiViuD5x7yRXysCEWcIhyuESj6A/Y+1wY0lvNhwZ7Tbb1XnNK6///dwIVa+Pj/oexsbRiR8/hbg0MBE0NiAyV+11v8AwAM0FDCBMyUXdc0SeMJPDBwExsUbu5TitUeVg8lp4/CjxN4rjuAliSJXKPJaXdGvFWflca6Wco0RlNNVvPr1h3RMNjnjLt7ZDFBEUMB8uHtob2C51pjVHn3Ciwpob7do7hNR7BhXVOVPK5skGCx3n7ezIvDnV5P3FXtzPGvbET/71CXAAAwoDJpPw2rL6ADAJDpcgguDyBhoJQdO8uIbRiSTJjPKzCpT3UhagEJk7jKDGNHDCctKNxfoaXM4AIXNc8kQf9/y9JhIIPqbHAULfomQKtGNRlgSVKijM33MY4eECAw4xVdrLWi807YhyMxqYpV/pju06l5TN2aWHZNTQ216jhmzhWn42+DBG7M0cuM3b0Nbyl37yvS+xLxIxG8v2zFBd+4DhcMMygZlNavKe1aXKneu9GZb81bFi0BCTBeRxUT0YJP//JbLtdgqTxKj//gbKas6rZAMBgACAQCAc3gUK3AAICE1BUp/jKjMpe7LUIpCICS/ooECkDJIZ6nTFAGd5i5wIKsA7rVmkM4VYsLSN2dx95Asdh7fw1Gdw60uBqaCHsl9u7fndwDKspx9n1jb+WKmNuvak77NacqCWuyGvLaW52kt0l1+JK6/N8l2VNTXe5Y0MxLoTG5+Nz+dP3nM5TTv7DNmI2alm5frf20n7lQ9wAQcPX3om2yEADR/ziPjgO1RHnf/7wGQKgAUZN83WawAAegep7cy8ABpBO1X5vBICXCWqPzbyQED4sQtjrrzRJTOjAe1NWpAQ0XHmFKmgDD1ocEJ7CaxG1N4wqDhg5ICSkckOj46YQpaIQsYwIIohPswNsMJpGquExTw8JYK3JYMFGci1HFgoGsWpuFv0vlLVKqXynOBaXOzFPYDA0CSqvSdZddj0Tf1DWUSrVeZdmdy3yHLdeR7hiLcq46zdnK1lz3lv+nSAgoEAGDQJFL+ppYAAAY/QqOYMKWJyNoDy4KdS7HKNYcgBUyW/ABah3n9ZgMpzFhUogq8rV0o0+jw61cJApVLptVrv8zzIVOWZWKJhhQb1hWdNkdNdn1rdrUr/+r7f/5/a6Qb/+TD7/5V8T9b1/tWxv3ut3gq3X/8k8qlaKomYAIABEE0/20resAAGLTJQUsCSFojQjc+siASgcEY2ASIzUFNKKAQFr5CAYRhRhw8Y0DMnm6dWxQYuQ3ekfuLvzCl6IBy4bpQLMxZsUIhLsF+zogvg0x+7cpsW0Y2eT7BHMPIWZMEUvrYNDnaGV07+2oRHvwfgu+XLUvL0NhgvDkDvxVg+ETFifnJfSO+XYcSciCgDJJZUsS//qXYXfx5XvbmL9MweT+7ambJy8CRDJJPh+Mca5h/f95pvB38YDpI/fw9k9BDjluW/a6GuTio7SquAgAIBqG4nEakgdABglcWeNPmS1hqx4OARiYIIgU1dJNpAIYaoTEKChMFhgU0hphRpuOQyRsc6vy2DdTLx+/cjxZmpcJVaapywKidxWFWjdj1E+VSmNosDz/y6+I/gsmE0j2b4pRnv/4lf9ahb/963995xW9s//cKNK/ZM0oyPEMeKd+/Qx48/////8eHv///8002qptZjEAJAAAAA+l82dz+YAMlqzTFU0xNAhCeHUnM/JiAqEBQXEjHg8wMHQHgoGZWRBhbEEBEgAahugSKhO8zk4pRNTeQl//ugZCKABhFOWP5t4JCbKMp/zbwADkktV/2EACFnIOq/sGAEXMhKVcGC1LR3F2Z122ikH42sAPodaKN0XFCTQd5akMa2BoR6pYUNOWEvuaufMrmyGhAV6sYIJo1bjmrXLgzYc1qG59UK94+neaUpysTMumVlXNtStsRRQlE7YGuO9nOhPPZy/M0sp+ltN4XKD+u+5tcq7hR4X8aJPCis8eIrwzEAgCgAoAgLZWPByqQAZ+FGLBJt0SZISGotDAjJA0FAY8Jhw+uqCEVhQHUFljPGWCFBDgJMZRrHoozNOVxgXJ6W0x0AUINkUmzK9kePoj9hi6r1wdWMTpFcSuob6VFKaPe8WK8y9vfF4L57CfRoUJ8zs7BFfskd5eOyWjVq9e4vF1CjP4i2yQWF5DcM7xf41nVY3////hQP5B2WGUAAABnm0oLUnhx1oqxTFUpeouiupUsArviTox2UxJrwCoehyKioqrrcVSGB0HQNlgZR0RbCGaL9OkQtjXNHGGyxQsd/ssX3dxEKcLXKqrfK7MecULC2zMNLokVFRxTAqNb1i1WOSRVVpWb/+blSTVZaZ2MBAAnv7gGAAxSED9lyhCZ+G6qNKw42pqve5WyIvlNDU3/+Zjfs9ftUPk5jf50qZLa3921vfenl0afyaijpAconn/eZn/zNoFybBV+c/pIt/JEjMy2uRmp4//uwZACAAvw91H1gwAg+ZUqvrIgBGYE9R/m8AAIYn6n/NPIAdlchEgBWvuAZEZfnnpqMMgMoEJK5nGWnBDKpQ7zly+ml1BZEGIkUNPnmHE0yqIkipTyk8aYX/tf8tDkKzM/bJIqOVRi+9I52JE0iCHv7gOll2m/z/////sQvxRDKCLh5pWNSUgp/3wE8jDjGoHofZw0nVyZSmLY3KnaTClO7BhYUpPTMnIzIm5/t0aOvzKVHqGBkAnooAYawr//FkrRwgmQKQAgg4ZrteLtbUAGDGAOAziW8zYWM8jAOMmKmBiIIDg0FAhq56YGWjAoylYRsZhiEZkCPNF2hNKOc0LoCj1dHBYokAveDkonQzS4ycvMJUbmyx4YcaYiu8LdGX6ij2RekvXVBVVFg1osgrwRK8KSksSzusPaXAL+OXA6YFBJoZpY/lIZZRXZiMS+YYfAbsOG6b6ROv+fKCau9/DOxhf5IN/Xljv7fyS5SB3//Cxn////Sw/k5NJYsUks/1U1kI9sBpGBuS0J7NtgNIOQGwAwBADL42r+AYAHSfjg01mMoZwEsOY5QgOEBEtTPNYCGRoz322uMsH4giuQgr4jVjZpnOhERLTRa+xb2Mx2zeIe94/8SLfcCA3wozXJKh6reTXvFc2pwtaDiSWduVDhHveP4j+2twmZlcozjHfz/tbMY//36Vi4340rm56/zH/+cNdsAAay2z3328l18gAMFpjokifAgXENa8GbmQOdpg0OY2xhHDBqFoVAfowy3qTRasTDhZnKl0hkqupZMyaOpYs3QRsidZybTbuXWd1TBpkjrvZPR6S1IEhcvh+Cn5lr/+6BkL4AGPk5UbmcAAKBJar/NPJAOTS1V/YMAKW+dqv+yYAXdm/X9D+cufWI4TkslecvsM1YbIVvsGh+Fx2q+tal3e/Vykuxt+Hdhpd8KZS0bKgz1UjUqtTbN5ROdvy+D6SysE77JF0rfWEZ0/7OMafKkm3+lL8y3/r01i9+dG7lF/wc9TxymMvo6DL0I0YwQSMoOjUo/NLKuZoABDWBBAQFWvM8TONEKCoQ0hQSBMsf0WFq9BRxLR258SQLsepHH2rBUAAAQCMnowm6OJ6jVN0WiEMfKumKzoqMT18+jvo17s2nh0OLC9kU12Zdx2eOc8SP+yRHN/pXK3Em4jxhns4KqJSsJPIlRXo9g1/zYlb7ReIRjjEeKnfzXGdfN///Df7/sx7/6ZPLP73eSppakAiBHN5s6AQk7EO9F5GNI01bykoeBI4DZq0mGJuYjMpHUaRVM/Ry0KIy0UcvGalh0gkV11DbPU5FSNPD01fyajXebn+mwlVaaRBbIgZBjUZmtmWrTiSJsCxmkumDBW/9iSX/51tp2f+SOdiMVZEAgSzc4ZgaLbv/KA2AKMDVCt4SKBiAUeXhHFTLLxpYZnN8xs0xJmK1q85u6ttvUNpu+a1sxTVueqp/2/756JJduSqq7vlVVgpFnLRlQMuTSSX/8znqt/cpLu+xI1gKqWdRAAIRqjnDcxCuFMC//+6BkBwAC2TnRbWUACEWIej2slAEWcS1DuawAAeMbqH808ADahYIHLIJXzbDnVwlkANUf6Ye8BcOQqPFdEKabFDnpXk5R7JA1ajkd/wVh2HnVGwtR8vE3lTf/7jn9DgaKNNo6v///xuaLCn8sSt+Ej0a+zJRUdHdAX8ZNBNpFYTSq4EhlhWxsAf7GRT9TK+JWcaxFd29FncVGGIPQiyozHOjSO0oqv//7t9iB4EL//6M9P//4mLxPuwgAQuFVbze3d2wAEVgy5IZEAQ8YFKJnQIkN2HOs2DVZAROwNRzDg5iiwGcGOamGLvpVEQCyA8Ysi2NikMKWOQuwairDBEptv3EGmK7mmWTOTqxp5JqMw5QMnsS9xJttsZTG4pKLUrgt9ZyF1oIdSF3sY7IJdhGs8Y+s5+OfD8tm83L7c3M2ZbAXatPNwuWTM7/PRUjDW0WP/VxmkNQU707//ql5//////8Tv//////xDrIdAjgAgBoBEVT8u0yVAABl4ptAZpGqShi6iPRotAkeljbA5GXkMgFQnw5G0OaCWElxSGFDy7M8mSna7rT7xayWrHRaP75ihbpq9FRXb/dbQWKemoKXft2v47I/ZrdtXSu/+M78f4ZEW+8/88rj8U9rd5r+HWfmfDVQTAAAhZKKZfy62NgAAxF80wMxN0RsjQAjmTjdMwciEBozCkywc6z/+7BkE4AFNT1O7msAAHnl6e/NPAAVWTlTuaeSAnKnKf8zAkDI14QxAUoEjQQLrSiermD16s1Q8NRJazJ6hERB9eRbMJopmzt4J+Zlz7TcBwfAqgcPQBOynuphljuy2UreZoxNuLrP/FIpGqKrEWS0T9wmPPkrAsO+DvNWv85TTPMoxqWzeWsF3tzdz/7G6jtT8/lz8qb936WB///WIxmFsvpM8hgkApABg7gSncP1tGEAAAY/+aw+a5UDR8tYiDQoOYgocHCEgy44NLIIXbai+dEc8os4nDetmC8Q4AqJwc05jyWtF0jUZFcJ368qYWmWMzPHjmyKJ+zwIzyCyPIbErlKdKflZERDfyZaFfu8qtYYW3kf/H7NG1P/6klA6VgGKhK3LNnvM5xaADBkgUoMdVSNApMZJGHbFri8pQ2DnZmRxlVAQ2DiLODJhmcghQuBHRCiSkeCqwnjFSYy2AqTRZnjkJKV6y+uXxQwW1W3J6pnasRCEOc6WVydTzxiNJyV7ZC7Gxz476ZjXEulOuT9Z4jeaUBOOCsV7WywbWztuYpIydzF//OdD3OC79KdKMVleyas1w/////+wKCjcrImr7/c52C2czXIUQiAGAjA1l071ub1tD4AMugElCI8YLLzMhN84yxy8L1zdMChC/TvxhHpbhHkTEcEHEAVEVMkR8yYPqLoNnwtLALQboi5xmiXHYgYmUsEaMiMaNkvl9Mn3TSKRFC+5iVSYKRP0zhFJEGN0y6gkY/mBm+tymTyKBgXSgm+UjE2UakkX3QTM6lJqPTQnC0VyKf/TTdabuh3JxzN41CoaWZyMQQSAhEBcknaaP/7wGQGgAZtTlV+awAQp8ka385gEhcBMUW5nAAJ0h3p/zECQDhYAJmBkHxyYBmFR6HZgWAKAGiNGPbBUQgyMBSgow0t0xIIAsqCo0GlyvA2zWV0NGUsQDNIR+oosqZnbBU64gzqW21yy14ZujDpo2NQQUUfiMIYcw5tohTwDI4qHDYW58OWq7IZilou6gGxL4JwwpIPciywRubL60plsSrV3BylNJnWl9Mudv3ckUy77P2hssxlNn9yn6WzMxa3KqaGpVKqAiUABK8LMLlLpq9YPr/iNI5VaGrVbLf/FoCvx2zhds9ctBkACEEDIAwfPoZDCYAGtA+ZKEZxtNGCSgaGM5hAXw5BZgkBgwCspd2vSL4f6Z+1yGJ8xqZVT0sPwDIuPypjAs067WHU3yM/jq3Sz7tv2+8nmqOMzMZi7TIcp4qwRvnIvXaZ3ZLGaL9Zy59t6uYVL1PVl+q2Vq7TV3Zi0A2bOrXxe5Y1/27ksu45f+F2luUtPZ3yArl/+/+9Yd//+U2fpYDcnOzwcbXPmovYvZnbP7dbbdAANrguATAMoQ36AOoCoijMW2aICUwRGydOZPeLGyCXMLxgAjYYMCJF5bT3wGbSoQlmVL0eiYDyRKHGcpVNs9C5mlvPFnbgiVQfJY62laR0fsFYNADeMnpoAmrXNUzlXaebrNMdqnjj9UMNRGkgGmiM3zGKymkpLsfh/3LnIHuWqb/1nActrRupnKL27MpmoFe+HKaEReDsYHhPPs485z//PKli0O9///8P1fEiQoiHAI7KqKauHfGxCgAAA2EAgRKoYVG2Wmcww5Jxl8ZS2ViDFJcZ2wFwWsBaDoBwj0iUxHIlEdYuA0UeFOHOGWE7C4isRQmS6X5wxKp08USWJlZYLz6bjHlInjCkTJqiimfS6zev55aFZfdj7azOtv2/y68183cDEBAQRQPF4vK577gAwQBBoWmIxoYWBRz5KGdqsYdA//uwZBEABgdO1v5x5ICHJ5pfzbwAD3krU72EgCkcGSw/sDAFJCBTDAvMrC4wcCSYEJ4p0g0OrTXKuIfx1FChZbxyZMW6OLmpDQDEECMVSnKHKjCWIY9DHYVaarxpRynhFgbbtp1jxZXxbV5Sn6xQ37ZHLG2RIDw8iVR1OzPW1lfvkJZn+lZqeKr47bBVNy2sCHPKsr94xVgxkLXTI8ifv4h6I4/aTfcpoI/TG/3TH3+aZzpdTrp7pvp+pVwtKKErWBf0cyMuJgigpAoBkOxKPKAAAFAZa5uY2YcLGxS5oINPUBmwYWqAIWHArsuyxaldta5xGinh8oMmNULRhp5fo5ds2X6dU/zD6Hoe3KtgcmVVQW+RkQjULCdZ1hphtivywxMw50+54gzKpijXlp/G3AgKxwVjfeV83/L1eScb0//6FyOs///Bcl272tjAAABds8EjBckzjSNrwyZTJE5kziO0y6SKbclWEpTIQqAUAKeShKSTTXZTQw1pF6RIkSHJSlv+asiRNbHMiyq5ZNRVCmhQoc6asZYrDX2i2KJvG1KkrBJ7a7KF0du+zHdpnbYIZFpHWm0KFDZChQytC8tpOlLrImpXxuf2XBERLxf+AFFTX4m+2xJIRzUMQOcqtSxHmu5ZcVSYND7aSsqqF6q1VKf//9Vb/n+dVQrMOzPqAhhQ88bp6kpRhLDVvBQpqKh4FDI3dd9+Efz4DEKipg5EwwAUFAaxGxtRgWtDdm5FoNJAgizCjMmphyVyhBREkaUdnLQyFtspvHV4gTqkUABBg0p/3CUX5E6CSOj0lMceKJGBB1bpD4xtwaBxNYCYy+iAKBT/+2BkMoADVEfV+yYb2D1F6r9nBQkMkOFDrKRtYNoE6z2XsBQnWD1RuRqNl5FBNntr4AHKPKIrzEAaMxJXRKqSUzrUluBhqq1nR6iJJl6Q6cLZ6E/T3lfrRualfR0ZyCzO0iigjnpKWxkAAAFlIcJJG2SCVDlNEjR4kaKWgmaz5nMAxRlTviHSTCdgDQbQqoVWETCwmQ25dtrOmziNYBomiX4GtgIwzCSgoiG3Utv/4QbxgqVTYhHBKIAkGZAzH+g+oJthPQdBmnTCR6mfItYQ0l+/wAwO9YEeqldMPUN8mCkfgSuxGQUzni4iIQ7ZDiWHSIN5GhWhBQqPXrOlj7VCXkmHdWT/+4BkAYATCULRe0kTejpkWp9kxXMKgNNH7LDIoNuSab2XjGwkIRCkUvAEYg9SIyDAxoNPYFFUDi8SHr6vk/kFQ9B4gRB7Rtkh11XUpsLSTqcdQutZmkW4lsovpvfGNyViq6Vss9XU3/rqKBzIEwbDiRYlxgIz8xvmMBKJoBG+gElG08Y0Taq60/uADAT8IJt6jXnGGgBordeQUrMnKi7sxWpCWoigUrcOhnubKWamif/oLqVisgfWIOv92SWHhmNRE3LfuAHNDpwJeVQwU8m4XJLzr/b4bmiofjQyHo+hejDpZ9WWniP7JieifhxW8pKEj7S7c5JpPzayXVIxykyxqK////53cwKxgz/5UZRKUck6mLmyNZduXUCYigrgVggSbNM/nhpsqGIUso9SOHxSvDhhxP7VU/n1yoi1/h3+MykXsEGof/3qV6xnVERHbvuAGKgKhdCIALQjQh0MiVGG1bNA0AvzF5TYtRaxM//7YGQSgBJ+M1H7BixYNiRqX2UjSUlMkznsPMbg0BHnfaeMdEqiIf4Y5up0rkdIm5vIG3KKuj7dWm/fstVbdFCwEGHiqD/8zlalSm8SaHZW8eVZ3a3fgAAGgHJ4PXWUA5QUYIACBeSNRBGNb8zwNnVDd5/ZyvGI/vkVOZdzZfvH8TCUe65rDm4IIAA5PgAyE5xRNDJrEJTFa2Di9LtID8joQ8RZwJUlyCWkmX5QlraoA0y3Lz9rX8VaU0YxytS5ewrS4W8Qv/g0DR4OhqoJB02mDcSUiCs9GGAhO01wEeIuOMYj18MmJ/StcSs8jKzlz6nlG/LhZlHWnREhkei0FxTA0AmqWv/7YGQAgRHoJFD7JhsoN0RJz2EiRUekez21hIAouQ2ndrBQBKiYVUQ5PuAAGAkwI26EFLGQkF638VVZQ87+0kAQg8YBycCkaHVWrSFOU2YaQDEhQ+OGJUVL6eiMh+XAJkGIdmYzBvXgABfJoAUCuPOh9A8JS/amnGBwcLOjggEM5b+5WuNVlQtQouGEhQJAgjzGCM8UDGxu3mmiTm4LyLTNQjMoDELeKBohr/h2Ew/VcuLwHIZAWXQtsxuuoj36pO5oBMhbytVz3cBhAhqUrVkUMQihU1+6szU/7lMnCRQ3XdmwytsUDx6QXOdp+YPMcChwODl/1NzdA6hylxEh3UFB4K01Vf/7kGQBAASmPs1+ZmAAVMYqX8zMEgu1C039koAgxpLpN5hQBFR2JlVpd1T274ShsIAAEVI2kcRlKHCmcJRigQeaAgEOMR0QmGQEgJDhWykKKxBBguwCiBQABlgIlDGYpEaYB6QNCAMhAILHYHtlEMtjhHeLhKopUkhyR3kSJ4zIUxUMyLPG2XBO5MDqGaHQGXieb5EBKZWLhPl8fx1CdiJFwmP9/nC1lw4v/snmZuaa1Zqke/3+Zlmp0tBuKyICJHwvAoFAAAOITMySa4gHhultQARBMHlNhy7c1TSgbA6iJhsIAmAMQhybk8fcfZMmHoO0zM0ip/l8vn2LxRMf00PKBqXUEm///l05/pd4hVNCNbt/dQGxsnBMpvhAaBV6PQ8onXDb9N7L27PJAdqxEBQJg4cVCGookIjxBiO9GcilcliizCZQOAg0eKHcpUMpGOhZ920b/ujOjKilFkL/QTjniTfiDRoggTJ7YsZDbtfUABaoA2aCWrWXt0MDlOb84FwAFGa/2yXf+6opKEOZyK//KdCjxMw7/iYBoc9ZQU4tfv/7cGQDARKjQtBrBhPYPqY53Twilwcsfzus4MMokIlldYYIrLGAPRAxBsgVCJLMMVLC9cjVI/i5NNBpIItUyI0pIstJ8nGnGxTQDIHvUPTTG8lTakAh0iBSjAb9HZ1TK2jG/2Ujo/NR/6Cpsrfhi4MgcS13oI7nr9eAB2ABwvMYGqQpnS5ZFLVT4VbEWKVdI0xaWTEfeV8yixRc2FOYhqFBCyOnQzziTAJZf//zFMVAqZvpQC9NuEkAueDhjBjNyCFbQF5rmkTkOdJIXXALWSkiEkP/kKbWw3Lq2IOcp39mt0kq/BZIooo8i0QyAABBwApI0iDMSwLhWoTievErlqwEn5hLp8vWxkl39TsKfrVB2UERh7gAAOgJAGatxeEiQjmFiLubi7SvzgMHyYVT6VEqbBbwabFfV9X/+0BkFQExwBzMawlCuiJCKW1hhSdGqHMtrDELIFAC63mXhFRzrwdKhzWSR3AC1AruCgG4zABOAAAAvFIwazAqpmjHQ+lQBbtom1kodMHhL/40Ct6DmcSOj+4YeX7MZQc4uQNHSgAAV1wM5UKNGQyWLyDEsq+tW4xhL+0aILrj+bPOKyeIXVa8D7zu/+vgAIBd4PJTBOV7zqFyjqCo1Q01CynJ+AAAsdTAADHEoUEo5oJ2LtMZuv/7QGQMATG2HMtrKTrYFMFa3mGCEwX4bS2sMEsgVgVpuYC83O6HOThgCiwJGYTSQO6XzaWdTXpnjShpZRFAf8CjmF7/drQDwAAAAm34CQ2w3gOCIW3+KGIbaAEvVALbNsBXAIRqSSjMAQEFBqbcl3TgIoJxUnOVDzKBLX5aBcDMv65ncMBegmangtQ8ASEnkI47F6hZMijkzf5F1WUqR2aP78AAAG1MlZTAU4efWykB8D3Z9MTE//sgZAyDcVULS2svMTgW4Pp+Ye0TAwAfVcw8wOAtg6s4HAgMSZoOSk1ASiGp5QNcs9Z0FXS01WhvhoAAAALDsoKy4lJIazLpRGRS4lfv7u8PACMspLGFWBaKdUkiL1amBk0aAZr+4Asbe+0Znl+GFJ7+4AAAAAAADY5NaQZAKjA07//7EGQJB3CJA9XzEAiIDOBK/j4AAUHgDVPVgAAoHIEr+pgABOgAAAAAAABgqQdJDc793jgVLItatNAErQWwAM8AADgqBVFVNERmBVBUBWB43wuAgAAIAL1042M7Qe2k9BcILIPqHKDV//uQZBCAAuomTH5mIAA7A7qPzBwCEPUVNVmpAAFBj2j/NPBIH+7cjWHZBkHOCbyM7GqwO8csi/mBsQ8iYncR4HyB0m7oGizAyJsXAwxg+RzvzQ0XyVFpHGb/6Dn///+GMxwyQyAxg1u+QOBwAAAAAEZeiUou1+Lf9/q64E/9WLD948QGgTc48oGB49uMA7CAgJANGTf/Qwwbn/pBBAADDSif1rbcQALXBAwxYwlTm/kg0QAQIEAk0YZGGDTAwCHE2cGcMpjkIdSREwCXBDgVsNEAVoN7EfA3YJzFlBqsLmhbxJByx2lg8GqjY0IoUByB7MzQuGY7R7LxJlQ+O8ZopE0ZOLkI5B81Hki3F2LSXTXqEM+onfrb/9H/S/1mx7/jku8jAKwMAAIAIG4Jl7AAAAAAAxUueiZBh5x5rl8agx+IbFroKJ0maX68VjwFDjFEpy2KXVX6hvEXLSpl58jJ3sHeEwwMR/bf+PrWJcwG2kJ7F3pVBCQACAhDps7AAAAAIAHX5lCI+OESQzpIWWlzCUuYcyA9JjzwXFJ1GCDmhqg5//twZBaABBtGy25qgABW47oPzOASB9xjMP2HgCCdiKl/sGAEcYpANJw6QOsAsWA0BQLKgBAY1Ryx2BxIDBUA4GKcJeHNHQSZmN0PgDLYN4wAgArqjU4iwnosLBYcJ0DVYwIGOAgRBAVBC4UqX//////////9D/rK/rNIAWRgAUBSB2yfcAAAAAAAG8qIQjBuT5EJ7djZXAYqXaiIVIUvs0ryRcyAWroQKkAwHJEJUwG7xK/bpoERyvRu+/1O/sv5+cu1+Oeef/HXbhrL2QOWwWlIAAeAAAD7CNBK03AEhD3WTC20vU927oJi5wb0gEGFZrAr56NsTUQ5seMCfbKSyKtlcvvMOJ4kkt48C9Ywlw6cPFSDEi8AAAAVCoEi9Qwhw2Cw8zRZDLnR13UHQQ/I/E8mH8vG9Ra1Sv/7YGQAgRGZGc/rD0G4K6LpV2HnOQa8ZzW1pAAgjwhmdrBgBDqJIbfAAAA04dEtcDIXUNDYCkaghpIo0VSlHJQt8jmkApBatM5SRbGrX1zTd0LCws6mABE4AAAipiOL+d1rLvOHJrMrsgQGYylWhri2IsxVxgVBavMJCZTW0FS+DlINYwCSrwCd+Yki9ZWCKEABEEQgs83NSbwwHAba2cYjSBFAoQwqlFCrEyWY/5dwRRDlh+cY2Kl+JARHoAOa18P1LQnTk00d3ayh/fNcw6RUTIIEjM//oLJH/UqMbUuVG6b//gAAAAAAA1U/McGQVTCATFVYzwBMpAhCBmSi4sLHuhZpJP/7kGQUgALYHMxubeAANoIKrs08ABMBLT+5qZIBfpLovzbCQc3WnR6Z8LHim4LEV9Umkry2CQo9MBvlOjidJ4srwmxtTylJ6ph81IKrkLz/z/W/+qT76q377v7n7fDwAAAAAANZILiDgOKCgUBM1vREuxC2uNNgGcQHvQr57A2R9pFixUlrKjInrCq2gHOwKliw+T13MABcCgA2/4WQmdIANAbuMH0SqtVnLfBiUywQ1Y9313xVzlDgEUD8R2iciRFCBYYKkXBvDrTEGBY4IDAYBDqOidiTHkXGQpMAfABq4OwDd4xw0yusmx2FUxFkEoB6cCgA1WAcQXKfIoXEE4ucL7h8BCEFGmJ3EACbHGPB//////9s4LkNKyfFKGn///xzCplAGie1ZAUGYnYPdcwAAAAAAsPL8MRH22OmRDD0RLmMloCEEGgQzAwn5VDshXo+6mwMqCIeH7lL3SSnEvj9+64QBwMF8Jm/fKUovN3CWOYkhWsBuRppTukDYM6FcMMof+rVeUuAQGCQMEi/AFkbAAM5aTVicwHjNSLzFUMAB//7kGQOAATqQ03ubmAAbmRqH85gEkece0O9gwAgyI5nt7IwBABOxopMQNw4RMgBAgwMOKw4ZMZHFsmQAqnAqYH4oaIG9AdCh6oXMCbhRxHpEhWwYuH2QgdGGDgbPBhIgQ6SHlImB0F4cghorwnYZYZoXMShVIAXhnTo4kR0juHUM0QYyNiGGAspWeot///84O89jmy0R6jbl4onjH6+Tx/5KHy3Bp2LDYwRCNAQAWz3UAAAAAAw+ch4OGU6qYuGZiwTItGKyWYFJQ6AlNUTlHy36QpEAE0Vsu4BRrkLlNQCxX4YHCoTNR2y6jxqK8msvs55TUCzUuephq7VS2q81MvpDsy4+M1NWoduy1yf+pyNOFfoLNu6VZG5wAAIDIIgcgCcDll6yzIVKu1ojAmAU3YOsw1kCEgYFWYckSXCIAMIQ5VNW3iaaalpUrIKvPEFkYeuhAbQk4AADAgTUexKCqxKZlUDv5hyrhW3/fIUHECkBCSMWokiK+DFoDPccpABT9GCmm4AAAC/EAUpLYnbKLyAUAmSrT4e5pzTY8wdNRX4xf/7gGQPAQMAP8zTDBNadCY5jWUmOUeUcTHsGGyhSganPPMljXmpCLZAEMsJz06KZtjB2cFUss81Jkcpn3FVBLHRDkOagYd2/uwsIUhToSdyORjuRldXRldP///o05hAQHgI4ECfW3DgAQAAH+2wQDgEQ/Gw4dpLaDAK3S52UwULi4IA6SEgrSGk15TsmjBMRrkmuH9Vnz1re2rme9jL29jBYWCBB4QBhZQANAZwASBCIWsIUTTPTMQPTMIORLETwIweIHj4EeBEjwM0iRGkZbLESxhh5g8SIHyTiiq8Gioct/xrSN3XqhUO8pFyodBpTsxyRAFEGKsUTGkr61WcS1LlVnI1iNrKRrRIdCR7rARZH///4CLIoR4iJdlhrv//gESZIixHiGsiHOSlVy+QVcGUfoYkFHLIwGlXS5MVBkqVE2wUKmlTTThQ0WKliwoUWFjjliiS4sNsFCpI400aKGixUs0LLW//nedqTEFN//sQZAGP8AAAaQAAAAgAAA0gAAABAAABpAAAACAAADSAAAAERTMuOTguMqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqTEFNRTMuOTguMqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqr/+xBkI4/wAABpAAAACAAADSAAAAEAAAGkAAAAIAAANIAAAASqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqpMQU1FMy45OC4yqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqv/7EGRFj/AAAGkAAAAIAAANIAAAAQAAAaQAAAAgAAA0gAAABKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqkxBTUUzLjk4LjKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//sQZGeP8AAAaQAAAAgAAA0gAAABAAABpAAAACAAADSAAAAEqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqTEFNRTMuOTguMqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqr/+xBkiY/wAABpAAAACAAADSAAAAEAAAGkAAAAIAAANIAAAASqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqpMQU1FMy45OC4yqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqv/7EGSrj/AAAGkAAAAIAAANIAAAAQAAAaQAAAAgAAA0gAAABKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqkxBTUUzLjk4LjKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//sQZM2P8AAAaQAAAAgAAA0gAAABAAABpAAAACAAADSAAAAEqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqTEFNRTMuOTguMqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqr/+xBk74/wAABpAAAACAAADSAAAAEAAAGkAAAAIAAANIAAAASqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqpMQU1FMy45OC4yqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqv/7EGT/j/AAAGkAAAAIAAANIAAAAQAAAaQAAAAgAAA0gAAABKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqkxBTUUzLjk4LjKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//sQZP+P8AAAaQAAAAgAAA0gAAABAAABpAAAACAAADSAAAAEqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqTEFNRTMuOTguMqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqr/+xBk/4/wAABpAAAACAAADSAAAAEAAAGkAAAAIAAANIAAAASqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqpMQU1FMy45OC4yqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqv/7EGT/j/AAAGkAAAAIAAANIAAAAQAAAaQAAAAgAAA0gAAABKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqkxBTUUzLjk4LjKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//sQZP+P8AAAaQAAAAgAAA0gAAABAAABpAAAACAAADSAAAAEqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqTEFNRTMuOTguMqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqr/+xBk/4/wAABpAAAACAAADSAAAAEAAAGkAAAAIAAANIAAAASqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqpMQU1FMy45OC4yqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqv/7EGT/j/AAAGkAAAAIAAANIAAAAQAAAaQAAAAgAAA0gAAABKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqkxBTUUzLjk4LjKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//sQZP+P8AAAaQAAAAgAAA0gAAABAAABpAAAACAAADSAAAAEqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqTEFNRTMuOTguMqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqr/+xBk/4/wAABpAAAACAAADSAAAAEAAAGkAAAAIAAANIAAAASqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqpMQU1FMy45OC4yqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqv/7EGT/j/AAAGkAAAAIAAANIAAAAQAAAaQAAAAgAAA0gAAABKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqkxBTUUzLjk4LjKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//sQZP+P8AAAaQAAAAgAAA0gAAABAAABpAAAACAAADSAAAAEqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqTEFNRTMuOTguMqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqr/+xBk/4/wAABpAAAACAAADSAAAAEAAAGkAAAAIAAANIAAAASqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqpMQU1FMy45OC4yqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqv/7EGT/j/AAAGkAAAAIAAANIAAAAQAAAaQAAAAgAAA0gAAABKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqkxBTUUzLjk4LjKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//sQZP+P8AAAaQAAAAgAAA0gAAABAAABpAAAACAAADSAAAAEqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqTEFNRTMuOTguMqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqr/+xBk/4/wAABpAAAACAAADSAAAAEAAAGkAAAAIAAANIAAAASqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqpMQU1FMy45OC4yqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqv/7EGT/j/AAAGkAAAAIAAANIAAAAQAAAaQAAAAgAAA0gAAABKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqkxBTUUzLjk4LjKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//sQZP+P8AAAaQAAAAgAAA0gAAABAAABpAAAACAAADSAAAAEqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqTEFNRTMuOTguMqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqr/+xBk/4/wAABpAAAACAAADSAAAAEAAAGkAAAAIAAANIAAAASqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqpMQU1FMy45OC4yqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqv/7EGT/j/AAAGkAAAAIAAANIAAAAQAAAaQAAAAgAAA0gAAABKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqkxBTUUzLjk4LjKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//sQZP+P8AAAaQAAAAgAAA0gAAABAAABpAAAACAAADSAAAAEqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqTEFNRTMuOTguMqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqr/+xBk/4/wAABpAAAACAAADSAAAAEAAAGkAAAAIAAANIAAAASqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqpMQU1FMy45OC4yqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqv/7EGT/j/AAAGkAAAAIAAANIAAAAQAAAaQAAAAgAAA0gAAABKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqkxBTUUzLjk4LjKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//sQZP+P8AAAaQAAAAgAAA0gAAABAAABpAAAACAAADSAAAAEqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqTEFNRTMuOTguMqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqr/+xBk/4/wAABpAAAACAAADSAAAAEAAAGkAAAAIAAANIAAAASqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqpMQU1FMy45OC4yqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqv/7EGT/j/AAAGkAAAAIAAANIAAAAQAAAaQAAAAgAAA0gAAABKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqkxBTUUzLjk4LjKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//sQZP+P8AAAaQAAAAgAAA0gAAABAAABpAAAACAAADSAAAAEqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqTEFNRTMuOTguMqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqr/+xBk/4/wAABpAAAACAAADSAAAAEAAAGkAAAAIAAANIAAAASqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqpMQU1FMy45OC4yqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqv/7EGT/j/AAAGkAAAAIAAANIAAAAQAAAaQAAAAgAAA0gAAABKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqkxBTUUzLjk4LjKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//sQZP+P8AAAaQAAAAgAAA0gAAABAAABpAAAACAAADSAAAAEqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqTEFNRTMuOTguMqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqr/+xBk/4/wAABpAAAACAAADSAAAAEAAAGkAAAAIAAANIAAAASqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqpMQU1FMy45OC4yqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqv/7EGT/j/AAAGkAAAAIAAANIAAAAQAAAaQAAAAgAAA0gAAABKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqkxBTUUzLjk4LjKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//sQZP+P8AAAaQAAAAgAAA0gAAABAAABpAAAACAAADSAAAAEqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqTEFNRTMuOTguMqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqr/+xBk/4/wAABpAAAACAAADSAAAAEAAAGkAAAAIAAANIAAAASqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqpMQU1FMy45OC4yqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqv/7EGT/j/AAAGkAAAAIAAANIAAAAQAAAaQAAAAgAAA0gAAABKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqkxBTUUzLjk4LjKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//sQZP+P8AAAaQAAAAgAAA0gAAABAAABpAAAACAAADSAAAAEqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqr/+xBk/4/wAABpAAAACAAADSAAAAEAAAGkAAAAIAAANIAAAASqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqv/7EGT/j/AAAGkAAAAIAAANIAAAAQAAAaQAAAAgAAA0gAAABKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//sQZP+P8AAAaQAAAAgAAA0gAAABAAABpAAAACAAADSAAAAEqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqr/+xBk/4/wAABpAAAACAAADSAAAAEAAAGkAAAAIAAANIAAAASqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqv/7EGT/j/AAAGkAAAAIAAANIAAAAQAAAaQAAAAgAAA0gAAABKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//sQZP+P8AAAaQAAAAgAAA0gAAABAAABpAAAACAAADSAAAAEqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqpBUEVUQUdFWNAHAABQAAAAAgAAAAAAAKAAAAAAAAAAAA4AAAAAAAAAQXJ0aXN0AFNvdW5kQmlibGUuY29tBQAAAAAAAABHZW5yZQBPdGhlckFQRVRBR0VY0AcAAFAAAAACAAAAAAAAgAAAAAAAAAAAVEFHaHR0cHM6Ly9zb3VuZHMtbXAzLmNvbQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGh0dHBzOi8vc291bmRzLW1wMy5jb20AAAAAAAAAAP8=" type="audio/mpeg">
    </audio>
    <button class="sound-toggle-icon" id="voiceChatToggleBtn" onclick="toggleVoiceChat()">
        <svg viewBox="0 0 24 24" id="micOnIcon"><path d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z"/></svg>
        <svg viewBox="0 0 24 24" id="micOffIcon" style="display:none;"><path d="M19 11h-1.7c0 .74-.16 1.43-.43 2.05l1.23 1.23c.56-.98.9-2.09.9-3.28zm-4.02.17c0-.06.02-.11.02-.17V5c0-1.66-1.34-3-3-3S9 3.34 9 5v.18l5.98 5.99zM4.27 3L3 4.27l6.01 6.01V11c0 1.66 1.33 3 2.99 3 .22 0 .44-.03.65-.08l1.66 1.66c-.71.33-1.5.52-2.31.52-2.76 0-5.3-2.1-5.3-5.1H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c.91-.13 1.77-.45 2.54-.9L19.73 21 21 19.73 4.27 3z"/></svg>
    </button>
    <div class="voice-status" id="voiceStatus" style="display:none;"></div>
    <div class="game-container">
        <div class="player-home green"><svg class="turn-timer-ring" data-player="green"><circle cx="50%" cy="50%" r="43%" stroke-dasharray="0 1000" id="timerRingGreen"></circle></svg><div class="player-circle"><div class="token green" data-piece-player="green" data-piece-index="0"></div><div class="token green" data-piece-player="green" data-piece-index="1"></div><div class="token green" data-piece-player="green" data-piece-index="2"></div><div class="token green" data-piece-player="green" data-piece-index="3"></div></div><div class="player-progress">0%</div></div>
        <div class="player-home red"><div class="player-circle"><div class="token red" data-piece-player="red" data-piece-index="0"></div><div class="token red" data-piece-player="red" data-piece-index="1"></div><div class="token red" data-piece-player="red" data-piece-index="2"></div><div class="token red" data-piece-player="red" data-piece-index="3"></div></div><div class="player-progress">0%</div></div>
        <div class="player-home yellow"><div class="player-circle"><div class="token yellow" data-piece-player="yellow" data-piece-index="0"></div><div class="token yellow" data-piece-player="yellow" data-piece-index="1"></div><div class="token yellow" data-piece-player="yellow" data-piece-index="2"></div><div class="token yellow" data-piece-player="yellow" data-piece-index="3"></div></div><div class="player-progress">0%</div></div>
        <div class="player-home blue"><svg class="turn-timer-ring" data-player="blue"><circle cx="50%" cy="50%" r="43%" stroke-dasharray="0 1000" id="timerRingBlue"></circle></svg><div class="player-circle"><div class="token blue" data-piece-player="blue" data-piece-index="0"></div><div class="token blue" data-piece-player="blue" data-piece-index="1"></div><div class="token blue" data-piece-player="blue" data-piece-index="2"></div><div class="token blue" data-piece-player="blue" data-piece-index="3"></div></div><div class="player-progress">0%</div></div>
        <div class="path-container top"><div class="path-cells"><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell safe green-path"></div><div class="cell green-path"></div><div class="cell safe"></div><div class="cell"></div><div class="cell green-path"></div><div class="cell"></div><div class="cell"></div><div class="cell green-path"></div><div class="cell"></div><div class="cell"></div><div class="cell green-path"></div><div class="cell"></div><div class="cell"></div><div class="cell green-path"></div><div class="cell"></div></div></div>
        <div class="path-container right"><div class="path-cells"><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell safe red-path"></div><div class="cell"></div><div class="cell red-path"></div><div class="cell red-path"></div><div class="cell red-path"></div><div class="cell red-path"></div><div class="cell red-path"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell safe"></div><div class="cell"></div></div></div>
        <div class="path-container bottom"><div class="path-cells"><div class="cell"></div><div class="cell blue-path"></div><div class="cell"></div><div class="cell"></div><div class="cell blue-path"></div><div class="cell"></div><div class="cell"></div><div class="cell blue-path"></div><div class="cell"></div><div class="cell"></div><div class="cell blue-path"></div><div class="cell"></div><div class="cell safe"></div><div class="cell blue-path"></div><div class="cell safe blue-path"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div></div></div>
        <div class="path-container left"><div class="path-cells"><div class="cell"></div><div class="cell safe"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell yellow-path"></div><div class="cell yellow-path"></div><div class="cell yellow-path"></div><div class="cell yellow-path"></div><div class="cell yellow-path"></div><div class="cell"></div><div class="cell safe yellow-path"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div></div></div>
        <div class="center-area">
            <div class="golden-ring">
                <div class="dice" id="ludoDice">
                    <div class="dice-face front dice-1">
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                    </div>
                    <div class="dice-face back dice-6">
                        <div class="dot"></div><div class="dot"></div>
                        <div class="dot"></div><div class="dot"></div>
                        <div class="dot"></div><div class="dot"></div>
                    </div>
                    <div class="dice-face right dice-3">
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                    </div>
                    <div class="dice-face left dice-4">
                        <div class="dot"></div><div class="dot"></div>
                        <div class="dot"></div><div class="dot"></div>
                    </div>
                    <div class="dice-face top dice-5">
                        <div class="dot"></div><div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div><div class="dot"></div>
                    </div>
                    <div class="dice-face bottom dice-2">
                        <div class="dot"></div>
                        <div class="dot"></div>
                    </div>
                </div>
            </div>
            <div class="center-triangle-container">
                <div class="center-triangle triangle-red"></div>
                <div class="center-triangle triangle-blue"></div>
                <div class="center-triangle triangle-yellow"></div>
                <div class="center-triangle triangle-green"></div>
            </div>
        </div>
    </div>
    <button class="roll-dice-button" id="rollButton" onclick="rollDiceButton()">Ø§Ø±Ù…ÙŠ Ø§Ù„Ù†Ø±Ø¯ ğŸ²</button>
    
    {% if can_stream %}
    <button class="stream-btn" id="streamBtn" onclick="toggleStream()">
        <span class="live-dot" style="display:none;"></span>
        <span id="streamBtnText">ğŸ“º Ø¨Ø«</span>
    </button>
    <div class="stream-viewer-count" id="streamViewerCount">ğŸ‘¤ 0</div>
    {% elif is_streaming %}
    <div class="stream-viewer-count" id="streamViewerCount">ğŸ‘¤ {{ stream_viewer_count }}</div>
    {% endif %}
    
    <div class="piece-selector-modal" id="pieceSelectorModal">
        <div class="piece-selector-content">
            <div class="piece-selector-title" id="selectorTitle">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø¬Ø± Ø§Ù„Ù…Ø±Ø§Ø¯ ØªØ­Ø±ÙŠÙƒÙ‡</div>
            <div class="piece-selector-buttons" id="selectorButtons"></div>
        </div>
    </div>
    
    <script>
        const baseDiceRotations = {
            1: { x: 0, y: 0 },
            2: { x: 90, y: 0 },
            3: { x: 0, y: -90 },
            4: { x: 0, y: 90 },
            5: { x: -90, y: 0 },
            6: { x: 0, y: 180 }
        };
        
        const playerColors = {
            green: { name: 'Ø§Ù„Ø£Ø®Ø¶Ø±', color: '#22c55e', gradient: 'linear-gradient(135deg, #4ade80 0%, #22c55e 100%)', startPos: 5 },
            red: { name: 'Ø§Ù„Ø£Ø­Ù…Ø±', color: '#ef4444', gradient: 'linear-gradient(135deg, #f87171 0%, #ef4444 100%)', startPos: 18 },
            yellow: { name: 'Ø§Ù„Ø£ØµÙØ±', color: '#eab308', gradient: 'linear-gradient(135deg, #fde047 0%, #eab308 100%)', startPos: 31 },
            blue: { name: 'Ø§Ù„Ø£Ø²Ø±Ù‚', color: '#3b82f6', gradient: 'linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%)', startPos: 44 }
        };
        
        const gameId = {{ game_id }};
        const myPlayer = {{ player_number }};
        let myPlayerColor = myPlayer === 1 ? 'green' : 'blue';
        const opponentName = "{{ opponent_name }}";
        let pollInterval = null;
        
        let gameState = {
            currentPlayer: myPlayer === 1 ? 'green' : 'blue',
            lastRoll: 0,
            lastRollTimestamp: null,
            canRollAgain: false,
            selectedPieceIndex: -1,
            waitingForPieceSelection: false,
            pieces: {
                green: [{ inHome: true, position: -1 }, { inHome: true, position: -1 }, { inHome: true, position: -1 }, { inHome: true, position: -1 }],
                red: [{ inHome: true, position: -1 }, { inHome: true, position: -1 }, { inHome: true, position: -1 }, { inHome: true, position: -1 }],
                yellow: [{ inHome: true, position: -1 }, { inHome: true, position: -1 }, { inHome: true, position: -1 }, { inHome: true, position: -1 }],
                blue: [{ inHome: true, position: -1 }, { inHome: true, position: -1 }, { inHome: true, position: -1 }, { inHome: true, position: -1 }]
            }
        };
        
        let isRolling = false;
        let rollTimeout = null;
        let isWarmedUp = false;
        let clickedPieces = new Set();
        let gameFinished = false;
        let warningShown = false;
        let lastDiceResult = 0;
        let diceInitialized = false;
        let lastRollTime = 0;
        let rollRequestPending = false;
        let lastResumedTimestamp = null;
        let animationInProgress = false;
        let myLastLocalRollTimestamp = null;
        let lastAnimationEndTime = 0;
        let pieceSelectionTimeout = null;
        
        const ANIMATION_DURATION_MS = 1500;
        const MIN_ROLL_INTERVAL_MS = 1500;
        const MIN_COOLDOWN_AFTER_ANIM_MS = 200;
        const MIN_RESUME_THRESHOLD_MS = 200;
        const PIECE_SELECTION_TIMEOUT_MS = 35000;
        
        const socket = io({
            transports: ['websocket', 'polling'],
            reconnection: true,
            reconnectionDelay: 500,
            reconnectionDelayMax: 5000,
            reconnectionAttempts: Infinity,
            autoConnect: true
        });
        socket.on('connect', () => {
            console.log('âœ… Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ± Ø¹Ø¨Ø± WebSocket');
            socket.emit('join_ludo_game', { game_id: gameId });
        });
        socket.on('disconnect', (reason) => {
            console.log('âš ï¸ Ø§Ù†Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ ÙÙŠ Ludo:', reason);
        });
        socket.on('reconnect', () => {
            console.log('ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ ÙÙŠ Ludo Ø¨Ù†Ø¬Ø§Ø­');
            socket.emit('join_ludo_game', { game_id: gameId });
        });
        
        function startPieceSelectionTimeout() {
            if (pieceSelectionTimeout) {
                clearTimeout(pieceSelectionTimeout);
            }
            
            pieceSelectionTimeout = setTimeout(async () => {
                if (gameState.waitingForPieceSelection) {
                    console.log('â° Ø§Ù†ØªÙ‡Ù‰ ÙˆÙ‚Øª Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚Ø·Ø¹Ø© - Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø­Ø§Ù„Ø©');
                    try {
                        await restoreGameStateFromServer();
                        console.log('âœ… ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¨Ù†Ø¬Ø§Ø­ Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ù…Ù‡Ù„Ø©');
                    } catch (error) {
                        console.error('âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©:', error);
                        gameState.waitingForPieceSelection = false;
                        updateRollButtonDisplay();
                    }
                }
            }, PIECE_SELECTION_TIMEOUT_MS);
        }
        
        function clearPieceSelectionTimeout() {
            if (pieceSelectionTimeout) {
                clearTimeout(pieceSelectionTimeout);
                pieceSelectionTimeout = null;
            }
        }
        
        let voiceChatInitialized = false;
        let pendingIceCandidates = [];
        let connectionRetryCount = 0;
        const MAX_RETRIES = 5;
        let reconnectTimeout = null;
        let isReconnecting = false;
        let voiceStateInterval = null;
        let soundEffectsEnabled = true;
        
        // Ø§Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ù…Ø«Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª - Ù…Ø­Ø³Ù‘Ù† Ù„Ù€ Android
        async function requestMicrophonePermission() {
            // ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙˆÙØ± mediaDevices
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                console.log('âŒ getUserMedia ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²');
                return false;
            }
            
            try {
                console.log('ğŸ¤ Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† (Ù…Ø­Ø§ÙˆÙ„Ø© 1)...');
                
                // Ù…Ø­Ø§ÙˆÙ„Ø© 1: Ø·Ù„Ø¨ Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ø¨Ù…Ø¹Ø§ÙŠÙŠØ± Ø¹Ø§Ù„ÙŠØ©
                const constraints = isAndroid ? 
                {
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    },
                    video: false
                } :
                {
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true,
                        sampleRate: 48000
                    },
                    video: false 
                };
                
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                console.log('âœ… ØªÙ… Ù…Ù†Ø­ Ø¥Ø°Ù† Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†');
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
                return true;
            } catch (err) {
                console.log('âš ï¸ Ù…Ø­Ø§ÙˆÙ„Ø© 1 ÙØ´Ù„Øª:', err.message);
                
                // Ù…Ø­Ø§ÙˆÙ„Ø© 2: Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ© Ø¬Ø¯Ø§Ù‹
                try {
                    console.log('ğŸ¤ Ù…Ø­Ø§ÙˆÙ„Ø© 2 Ø¨Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ©...');
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        audio: true,
                        video: false 
                    });
                    console.log('âœ… ØªÙ… Ù…Ù†Ø­ Ø¥Ø°Ù† Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† (Ù…Ø­Ø§ÙˆÙ„Ø© 2)');
                    if (stream) {
                        stream.getTracks().forEach(track => track.stop());
                    }
                    return true;
                } catch (err2) {
                    console.log('âŒ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª ÙØ´Ù„Øª:', err2.message);
                    return false;
                }
            }
        }
        
        socket.on('ludo_update', async (data) => {
            console.log('ğŸ“¨ ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ:', data);
            
            // Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ø¹Ù†Ø¯ Ø£ÙˆÙ„ update
            if (!voiceChatInitialized) {
                voiceChatInitialized = true;
                console.log('ğŸ¤ Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†...');
                await requestMicrophonePermission();
                if (typeof initializeVoiceChat === 'function') {
                    console.log('ğŸ¤ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„ØµÙˆØªÙŠØ©...');
                    initializeVoiceChat();
                }
            }
            
            if (data.type === 'dice_roll') {
                const isMyOwnRoll = (myLastLocalRollTimestamp && data.roll_timestamp === myLastLocalRollTimestamp);
                if (!isMyOwnRoll && !isRolling && !animationInProgress) {
                    await animateDiceRoll(data.roll);
                    gameState.lastRoll = data.roll;
                    gameState.lastRollTimestamp = data.roll_timestamp;
                    gameState.waitingForPieceSelection = data.waiting_for_piece_selection === 1;
                    
                    if (gameState.waitingForPieceSelection) {
                        startPieceSelectionTimeout();
                        setTimeout(() => setupPieceClickListeners(), 100);
                    }
                    
                    updateRollButtonDisplay();
                }
            } else if (data.type === 'piece_move') {
                console.log('ğŸ”„ ØªØ­Ø¯ÙŠØ« Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ù‚Ø·Ø¹ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±');
                syncPiecesFromServer(data.player1_position, data.player2_position, data.game_event_version);
                
                if (data.captured_pieces && data.captured_pieces.length > 0) {
                    console.log(`ğŸ¯ ØªÙ… Ø£ÙƒÙ„ ${data.captured_pieces.length} Ø­Ø¬Ø±`);
                    
                    if (initialSyncDone && soundEffectsEnabled) {
                        const captureSound = document.getElementById('pieceMoveSoundEffect');
                        if (captureSound) {
                            captureSound.currentTime = 0;
                            captureSound.volume = 1.0;
                            captureSound.play().catch(e => console.log('ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ø£ÙƒÙ„:', e));
                        }
                        
                        if (navigator.vibrate) {
                            navigator.vibrate([100, 50, 100]);
                        }
                    }
                }
                
                clearPieceSelectionTimeout();
                clearSelectablePieces();
                gameState.currentPlayer = data.current_turn === 1 ? 'green' : 'blue';
                gameState.waitingForPieceSelection = (data.waiting_for_piece_selection === 1) ? true : false;
                lastButtonState = null;
                
                // Ø¥Ø²Ø§Ù„Ø© Ù‚ÙÙ„ Ø§Ù„Ø²Ø± ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª
                buttonHideLock = false;
                if (buttonHideLockTimeout) {
                    clearTimeout(buttonHideLockTimeout);
                    buttonHideLockTimeout = null;
                }
                
                if (data.bonus_roll) {
                    console.log('ğŸ² Ø±Ù…ÙŠØ© Ø¥Ø¶Ø§ÙÙŠØ©! - Ø§Ù„Ø²Ø± Ù…ÙØ¹Ù„ Ù„Ù„Ø±Ù…ÙŠØ© Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©');
                    const rollBtn = document.querySelector('.roll-dice-button');
                    if (rollBtn) {
                        rollBtn.style.display = 'block';
                        rollBtn.disabled = false;
                        rollBtn.style.opacity = '1';
                        rollBtn.style.pointerEvents = 'auto';
                    }
                    stopTurnTimer();
                    setTimeout(() => {
                        try {
                            updateRollButtonDisplay();
                        } catch (err) {
                            console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø²Ø±:', err);
                        }
                    }, 100);
                } else {
                    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø²Ø± ÙÙˆØ±Ø§Ù‹ Ø¨Ø¯ÙˆÙ† ØªØ£Ø®ÙŠØ± Ø¹Ù†Ø¯ Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø±Ù…ÙŠØ© Ø¥Ø¶Ø§ÙÙŠØ©
                    const rollBtn = document.querySelector('.roll-dice-button');
                    if (rollBtn) {
                        rollBtn.style.display = 'none';
                        rollBtn.style.opacity = '0';
                        rollBtn.style.pointerEvents = 'none';
                        rollBtn.disabled = true;
                    }
                    // ØªØ£Ø¬ÙŠÙ„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯ÙˆØ± Ø­ØªÙ‰ Ù†Ù†ØªÙ‡ÙŠ Ù…Ù† Ø­Ø±ÙƒØ© Ø§Ù„Ø­Ø¬Ø± Ø¥Ù† ÙˆØ¬Ø¯Øª
                    setTimeout(() => {
                        try {
                            updateTurnDisplay(data.time_left);
                        } catch (err) {
                            console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯ÙˆØ±:', err);
                        }
                    }, 300);
                }
            } else if (data.type === 'turn_change') {
                console.log('ğŸ”„ turn_change event Ù…Ø³ØªÙ‚Ø¨Ù„ - isAnimating:', isAnimating);
                clearPieceSelectionTimeout();
                clearSelectablePieces();
                gameState.currentPlayer = data.current_turn === 1 ? 'green' : 'blue';
                gameState.waitingForPieceSelection = (data.waiting_for_piece_selection === 1) ? true : false;
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø²Ø± Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø¯ÙˆØ± - Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹!
                buttonHideLock = false;
                isRolling = false;
                animationInProgress = false;
                rollRequestPending = false;
                if (buttonHideLockTimeout) {
                    clearTimeout(buttonHideLockTimeout);
                    buttonHideLockTimeout = null;
                }
                lastButtonState = null;
                
                const myPlayerColor = myPlayer === 1 ? 'green' : 'blue';
                const isMyTurn = gameState.currentPlayer === myPlayerColor;
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø²Ø± ÙÙˆØ±Ø§Ù‹
                const rollBtn = document.querySelector('.roll-dice-button');
                if (rollBtn) {
                    if (isMyTurn) {
                        rollBtn.style.display = 'block';
                        rollBtn.disabled = false;
                        rollBtn.style.opacity = '1';
                        rollBtn.style.pointerEvents = 'auto';
                        console.log('âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø²Ø± Ø§Ù„Ù†Ø±Ø¯ - Ø¯ÙˆØ±ÙŠ Ø§Ù„Ø¢Ù†');
                    } else {
                        rollBtn.style.display = 'none';
                        rollBtn.disabled = true;
                        rollBtn.style.opacity = '0';
                        rollBtn.style.pointerEvents = 'none';
                    }
                }
                
                // ØªØ£Ø¬ÙŠÙ„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø²Ø± Ù„Ù„ØªØ£ÙƒØ¯
                setTimeout(() => {
                    console.log('ğŸ“ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø²Ø± Ø¨Ø¹Ø¯ turn_change - isAnimating Ø§Ù„Ø¢Ù†:', isAnimating);
                    buttonHideLock = false;
                    isRolling = false;
                    animationInProgress = false;
                    updateRollButtonDisplay();
                }, 400);
                updateTurnDisplay(data.time_left);
            } else if (data.type === 'game_over') {
                console.log('ğŸ Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©!', data);
                const myUserId = {{ user.id }};
                const iWon = data.winner_id === myUserId;
                showLudoResult({
                    i_won: iWon,
                    bet_amount: data.bet_amount,
                    prize: data.prize
                });
            }
        });
        
        function closeWarningGame() {
            const warningOverlay = document.getElementById('warningOverlay');
            if (warningOverlay) {
                warningShown = false;
                warningOverlay.style.display = 'none';
            }
        }
        
        function confirmExitGame() {
            const warningOverlay = document.getElementById('warningOverlay');
            const exitCountdownModal = document.getElementById('exitCountdownModal');
            const exitCountdownNumber = document.getElementById('exitCountdownNumber');
            
            if (warningOverlay) {
                gameFinished = true;
                warningOverlay.style.display = 'none';
            }
            
            if (exitCountdownModal) {
                exitCountdownModal.style.display = 'flex';
                
                const startTime = Date.now();
                const endTime = startTime + 4000;
                
                const updateCountdown = () => {
                    const now = Date.now();
                    const timeRemaining = Math.ceil((endTime - now) / 1000);
                    
                    if (timeRemaining > 0) {
                        exitCountdownNumber.textContent = timeRemaining;
                        setTimeout(updateCountdown, 100);
                    } else {
                        exitCountdownNumber.textContent = '0';
                        socket.emit('forfeit_ludo_game', {});
                    }
                };
                
                updateCountdown();
            } else {
                socket.emit('forfeit_ludo_game', {});
            }
        }
        
        socket.on('forfeit_confirmed', function(data) {
            console.log('âœ… ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ù†Ø³Ø­Ø§Ø¨ ÙÙˆØ±Ø§Ù‹');
            if (data.redirect) {
                window.location.href = data.redirect;
            }
        });
        
        socket.on('forfeit_error', function(data) {
            console.log('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ù†Ø³Ø­Ø§Ø¨:', data.error);
            window.location.href = '/games/ludo';
        });
        
        function showLudoResult(data) {
            try {
                console.log('ğŸ“Š Ø¹Ø±Ø¶ Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©:', data);
                gameFinished = true;
                
                disableWakeLock();
                
                const warningOverlay = document.getElementById('warningOverlay');
                if (warningOverlay) {
                    warningOverlay.style.display = 'none';
                }
                
                const modal = document.getElementById('resultModal');
                if (!modal) {
                    console.error('âŒ resultModal ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ DOM');
                    return;
                }
                
                const emoji = document.getElementById('resultEmoji');
                const title = document.getElementById('resultTitle');
                const message = document.getElementById('resultMessage');
                
                if (!emoji || !title || !message) {
                    console.error('âŒ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù†ØªÙŠØ¬Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
                    return;
                }
                
                if (data.i_won) {
                    emoji.textContent = 'ğŸ‰';
                    title.textContent = 'Ù…Ø¨Ø±ÙˆÙƒ Ù„Ù‚Ø¯ ÙØ²Øª!';
                    const prize = data.prize !== undefined ? data.prize : 0.20;
                    message.innerHTML = `ØªÙ… Ø¥Ø¶Ø§ÙØ© ${prize.toFixed(2)}$ Ù…ÙƒØ§ÙØ£Ø© Ø¥Ù„Ù‰ Ø­Ø³Ø§Ø¨Ùƒ<br>+ Ø¥Ø±Ø¬Ø§Ø¹ Ù…Ø¨Ù„Øº Ø§Ù„Ø±Ù‡Ø§Ù† ${data.bet_amount.toFixed(2)}$`;
                    console.log('ğŸ† ÙØ§Ø² Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø¨Ù€:', prize);
                } else {
                    emoji.textContent = 'ğŸ˜¢';
                    title.textContent = 'Ù„Ù„Ø£Ø³Ù Ø®Ø³Ø±Øª!';
                    message.innerHTML = `Ø­Ø¸ Ø£ÙØ¶Ù„ ÙÙŠ Ø§Ù„Ù…Ø±Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©`;
                    console.log('ğŸ˜¢ Ø®Ø³Ø± Ø§Ù„Ù„Ø§Ø¹Ø¨');
                }
                
                modal.style.display = 'flex';
                console.log('âœ… ØªÙ… Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†ØªÙŠØ¬Ø©');
                
                setTimeout(() => {
                    window.location.href = '/games/ludo';
                }, 3000);
            } catch (err) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø©:', err);
            }
        }
        
        function initializeBackButtonWarning() {
            const warningOverlay = document.getElementById('warningOverlay');
            
            if (!warningOverlay) {
                console.error('âŒ warningOverlay ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                return;
            }
            
            console.log('âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ù…ÙŠØ²Ø© Ø§Ù„ØªØ­Ø°ÙŠØ± Ø¹Ù†Ø¯ Ø§Ù„Ø±Ø¬ÙˆØ¹');
            
            history.pushState(null, null, location.href);
            
            window.addEventListener('popstate', function(e) {
                if (gameFinished) {
                    console.log('ğŸ Ø§Ù„Ù„Ø¹Ø¨Ø© Ù…Ù†ØªÙ‡ÙŠØ© - ØªØ¬Ø§Ù‡Ù„ Ø§Ù„ØªØ­Ø°ÙŠØ±');
                    return;
                }
                
                e.preventDefault();
                e.stopPropagation();
                
                history.pushState(null, null, location.href);
                
                if (!warningShown && warningOverlay) {
                    console.log('âš ï¸ Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ­Ø°ÙŠØ±');
                    warningShown = true;
                    warningOverlay.style.display = 'flex';
                }
            });
            
            window.addEventListener('pagehide', function(e) {
                if (!gameFinished && !e.persisted) {
                    navigator.sendBeacon('/games/ludo');
                }
            });
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeBackButtonWarning);
        } else {
            initializeBackButtonWarning();
        }
        
        const safeCells = [3, 5, 22, 34, 48, 50, 55, 58, 67];
        
        function getCellNumber(cell) {
            const numberSpan = cell.querySelector('.cell-number');
            if (numberSpan) {
                return parseInt(numberSpan.textContent);
            }
            return -1;
        }
        
        function sendPieceBackHome(player, pieceIndex) {
            const piece = gameState.pieces[player][pieceIndex];
            
            if (piece.steps >= 58) {
                console.log(`âš ï¸ Ø§Ù„Ø­Ø¬Ø± ${player} Ø±Ù‚Ù… ${pieceIndex} Ø£Ù†Ù‡Ù‰ Ù…Ø³Ø§Ø±Ù‡ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø±Ø¬Ø§Ø¹Ù‡ (steps: ${piece.steps})`);
                return;
            }
            
            piece.inHome = true;
            piece.steps = 0;
            piece.position = -1;
            
            const allCells = document.querySelectorAll('.cell');
            allCells.forEach(cell => {
                const tokens = cell.querySelectorAll(`.token.${player}`);
                tokens.forEach(token => {
                    const tokenPieceIndex = parseInt(token.getAttribute('data-piece-index'));
                    if (tokenPieceIndex === pieceIndex) {
                        token.remove();
                    }
                });
            });
            
            const goldenRing = document.querySelector('.golden-ring');
            if (goldenRing) {
                const ringTokens = goldenRing.querySelectorAll(`.token.${player}`);
                ringTokens.forEach(token => {
                    const tokenPieceIndex = parseInt(token.getAttribute('data-piece-index'));
                    if (tokenPieceIndex === pieceIndex) {
                        token.remove();
                    }
                });
            }
            
            const playerHome = document.querySelector(`.player-home.${player}`);
            if (playerHome) {
                const homeTokens = playerHome.querySelectorAll('.token');
                homeTokens.forEach(token => {
                    const tokenPieceIndex = parseInt(token.getAttribute('data-piece-index'));
                    if (tokenPieceIndex === pieceIndex) {
                        token.style.display = 'block';
                        token.style.opacity = '1';
                        token.style.width = '';
                        token.style.height = '';
                        token.style.position = '';
                        token.style.top = '';
                        token.style.left = '';
                        token.style.transform = '';
                        token.style.zIndex = '';
                        token.style.pointerEvents = '';
                        token.classList.remove('selectable');
                    }
                });
            }
            
            console.log(`âœ… ØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ Ø­Ø¬Ø± ${player} Ø±Ù‚Ù… ${pieceIndex} Ø¥Ù„Ù‰ Ø§Ù„Ø¯Ø§Ø¦Ø±Ø©`);
        }
        
        function captureOpponentPiece(targetCell, currentPlayer) {
            const cellNumber = getCellNumber(targetCell);
            if (safeCells.includes(cellNumber)) {
                console.log(`ğŸ›¡ï¸ Ù…Ù†Ø·Ù‚Ø© Ø¢Ù…Ù†Ø© - Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø£ÙƒÙ„ ÙÙŠ Ø§Ù„Ù…Ø±Ø¨Ø¹ ${cellNumber}`);
                return [];
            }
            
            const opponentPlayer = currentPlayer === 'blue' ? 'green' : 'blue';
            const opponentTokens = targetCell.querySelectorAll(`.token.${opponentPlayer}`);
            
            const capturedPieces = [];
            opponentTokens.forEach(token => {
                const pieceIndex = parseInt(token.getAttribute('data-piece-index'));
                const opponentPiece = gameState.pieces[opponentPlayer][pieceIndex];
                
                if (opponentPiece && opponentPiece.steps >= 58) {
                    console.log(`âš ï¸ ØªØ¬Ø§Ù‡Ù„ Ù…Ø­Ø§ÙˆÙ„Ø© Ø£ÙƒÙ„ Ø­Ø¬Ø± ${opponentPlayer} Ø±Ù‚Ù… ${pieceIndex} - ÙÙŠ Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ`);
                    return;
                }
                
                capturedPieces.push(pieceIndex);
                console.log(`ğŸ¯ ØªÙ… Ø£ÙƒÙ„ Ø­Ø¬Ø± ${opponentPlayer} Ø±Ù‚Ù… ${pieceIndex} - Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±`);
            });
            
            if (capturedPieces.length > 0) {
                console.log(`ğŸ¯ ØªÙ… Ø£ÙƒÙ„ ${capturedPieces.length} Ø­Ø¬Ø± Ù…Ù† ${opponentPlayer}`);
            }
            
            return capturedPieces;
        }
        
        function updateDiceColor(playerColor) {
            const diceFaces = document.querySelectorAll('.dice-face');
            const playerInfo = playerColors[playerColor];
            
            diceFaces.forEach(face => {
                face.style.background = playerInfo.gradient;
                face.style.borderColor = playerInfo.color;
            });
        }
        
        let lastButtonState = null;
        let buttonUpdateTimeout = null;
        let buttonUpdatePending = false;
        let buttonHideLock = false;
        let buttonHideLockTimeout = null;
        let buttonDebounceTimer = null;
        let lastButtonUpdate = 0;
        const BUTTON_DEBOUNCE_MS = 100;
        
        function updateRollButtonDisplay() {
            const rollBtn = document.querySelector('.roll-dice-button');
            if (!rollBtn) return;
            
            const myPlayerColor = myPlayer === 1 ? 'green' : 'blue';
            const isMyTurn = gameState.currentPlayer === myPlayerColor;
            const canRoll = !gameState.waitingForPieceSelection && !isRolling;
            
            const newState = `${isMyTurn}-${canRoll}`;
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù‚ÙÙ„ Ù…ÙØ¹Ù„ ÙˆÙŠØ­Ø§ÙˆÙ„ Ø§Ù„Ø²Ø± Ø§Ù„Ø¸Ù‡ÙˆØ±ØŒ ØªØ¬Ø§Ù‡Ù„
            if (buttonHideLock && isMyTurn) {
                return;
            }
            
            // Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø± Ø§Ù„Ø³Ø±ÙŠØ¹
            if (lastButtonState === newState) {
                return;
            }
            
            // Ù…Ù†Ø¹ Ø§Ù„ÙˆÙ…ÙŠØ¶ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… debounce
            const now = Date.now();
            if (now - lastButtonUpdate < BUTTON_DEBOUNCE_MS) {
                if (buttonDebounceTimer) {
                    clearTimeout(buttonDebounceTimer);
                }
                buttonDebounceTimer = setTimeout(() => {
                    applyButtonState(rollBtn, isMyTurn, canRoll, newState);
                }, BUTTON_DEBOUNCE_MS);
                return;
            }
            
            applyButtonState(rollBtn, isMyTurn, canRoll, newState);
        }
        
        function applyButtonState(rollBtn, isMyTurn, canRoll, newState) {
            lastButtonState = newState;
            lastButtonUpdate = Date.now();
            
            if (isMyTurn) {
                rollBtn.style.transition = 'none';
                rollBtn.style.display = 'block';
                
                if (canRoll) {
                    rollBtn.disabled = false;
                    rollBtn.style.opacity = '1';
                    rollBtn.style.pointerEvents = 'auto';
                } else {
                    rollBtn.disabled = true;
                    rollBtn.style.opacity = '0.5';
                    rollBtn.style.pointerEvents = 'none';
                }
            } else {
                // Ø¥Ø®ÙØ§Ø¡ ÙÙˆØ±ÙŠ Ø¨Ø¯ÙˆÙ† transition Ø¹Ù†Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¯ÙˆØ±
                rollBtn.style.transition = 'none';
                rollBtn.style.display = 'none';
                rollBtn.style.opacity = '0';
                rollBtn.disabled = true;
                rollBtn.style.pointerEvents = 'none';
            }
        }
        
        function hideButtonWithLock() {
            const rollBtn = document.querySelector('.roll-dice-button');
            if (!rollBtn) return;
            
            // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù‚ÙÙ„
            buttonHideLock = true;
            if (buttonHideLockTimeout) {
                clearTimeout(buttonHideLockTimeout);
            }
            
            // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø²Ø± ÙÙˆØ±Ø§Ù‹
            rollBtn.style.transition = 'none';
            rollBtn.style.display = 'none';
            rollBtn.style.opacity = '0';
            rollBtn.disabled = true;
            rollBtn.style.pointerEvents = 'none';
            lastButtonState = 'locked';
            
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù‚ÙÙ„ Ø¨Ø¹Ø¯ 600ms
            buttonHideLockTimeout = setTimeout(() => {
                buttonHideLock = false;
                lastButtonState = null;
            }, 600);
        }
        
        let turnTimerInterval = null;
        let turnTimeRemaining = 0;
        const TURN_DURATION = 30;
        const WARNING_TIME = 5;
        let serverTimeLeft = null;
        let lastTimerTurn = null;
        
        function startTurnTimer(initialTimeLeft = null) {
            const currentTurn = gameState.currentPlayer;
            
            if (lastTimerTurn === currentTurn && turnTimerInterval !== null) {
                return;
            }
            
            lastTimerTurn = currentTurn;
            stopTurnTimer();
            
            const myPlayerColor = myPlayer === 1 ? 'green' : 'blue';
            const isMyTurn = gameState.currentPlayer === myPlayerColor;
            const targetColor = gameState.currentPlayer;
            
            console.log('ğŸ•’ Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ - Ø¯ÙˆØ±:', gameState.currentPlayer, 'Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ:', myPlayerColor, 'Ù‡Ù„ Ù‡Ø°Ø§ Ø¯ÙˆØ±ÙŠ:', isMyTurn);
            
            document.querySelectorAll('.turn-timer-ring').forEach(ring => {
                ring.classList.remove('active');
            });
            
            const timerRing = document.querySelector(`.turn-timer-ring[data-player="${targetColor}"]`);
            const circle = timerRing ? timerRing.querySelector('circle') : null;
            
            if (!timerRing || !circle) {
                console.error('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¹Ø¯Ø§Ø¯');
                return;
            }
            
            timerRing.classList.add('active');
            circle.classList.remove('warning');
            
            const radius = circle.r.baseVal.value;
            const circumference = 2 * Math.PI * radius;
            
            if (initialTimeLeft !== null && initialTimeLeft !== undefined) {
                turnTimeRemaining = Math.max(0, initialTimeLeft);
                if (initialTimeLeft > 0) {
                    console.log(`âœ… Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ù†Ø´Ø· - ${initialTimeLeft} Ø«Ø§Ù†ÙŠØ© Ù…ØªØ¨Ù‚ÙŠØ© (Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±)`);
                } else {
                    console.log('â° Ø§Ù„ÙˆÙ‚Øª Ø§Ù†ØªÙ‡Ù‰ Ø¨Ø§Ù„ÙØ¹Ù„ - 0 Ø«Ø§Ù†ÙŠØ© Ù…ØªØ¨Ù‚ÙŠØ©');
                }
            } else {
                turnTimeRemaining = TURN_DURATION;
                console.log(`âœ… Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ù†Ø´Ø· - ${TURN_DURATION} Ø«Ø§Ù†ÙŠØ© Ù…ØªØ¨Ù‚ÙŠØ©`);
            }
            
            const progress = turnTimeRemaining / TURN_DURATION;
            const offset = circumference * (1 - progress);
            circle.style.strokeDasharray = `${circumference} ${circumference}`;
            circle.style.strokeDashoffset = -offset;
            
            turnTimerInterval = setInterval(() => {
                turnTimeRemaining--;
                console.log(`â±ï¸ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${turnTimeRemaining} Ø«Ø§Ù†ÙŠØ©`);
                
                const progress = turnTimeRemaining / TURN_DURATION;
                const offset = circumference * (1 - progress);
                
                circle.style.strokeDasharray = `${circumference} ${circumference}`;
                circle.style.strokeDashoffset = -offset;
                
                if (turnTimeRemaining <= WARNING_TIME && turnTimeRemaining > 0) {
                    if (!circle.classList.contains('warning')) {
                        console.log('âš ï¸ ØªØ­Ø°ÙŠØ±: 5 Ø«ÙˆØ§Ù†Ù Ù…ØªØ¨Ù‚ÙŠØ© - ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù„ÙˆÙ† Ø¥Ù„Ù‰ Ø£Ø­Ù…Ø±');
                        circle.classList.add('warning');
                    }
                }
                
                if (turnTimeRemaining <= 0) {
                    console.log('â° Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª! Ù†Ù‚Ù„ Ø§Ù„Ø¯ÙˆØ± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹...');
                    stopTurnTimer();
                    timerRing.classList.remove('active');
                    
                    hideButtonWithLock();
                    nextPlayer();
                }
            }, 1000);
        }
        
        function stopTurnTimer() {
            if (turnTimerInterval) {
                console.log('ğŸ›‘ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ');
                clearInterval(turnTimerInterval);
                turnTimerInterval = null;
            }
            lastTimerTurn = null;
            
            const myPlayerColor = myPlayer === 1 ? 'green' : 'blue';
            const timerRing = document.querySelector(`.turn-timer-ring[data-player="${myPlayerColor}"]`);
            if (timerRing) {
                timerRing.classList.remove('active');
                const circle = timerRing.querySelector('circle');
                if (circle) {
                    circle.classList.remove('warning');
                    circle.style.strokeDasharray = '0 1000';
                    circle.style.strokeDashoffset = '0';
                }
            }
        }
        
        function updateTurnDisplay(timeLeft = null) {
            updateDiceColor(gameState.currentPlayer);
            updateRollButtonDisplay();
            startTurnTimer(timeLeft);
        }
        
        function warmupDice() {
            if (isWarmedUp) return;
            const dice = document.getElementById('ludoDice');
            if (!dice) return;
            
            isWarmedUp = true;
        }
        
        function numberCells() {
            const topCells = document.querySelectorAll('.path-container.top .cell');
            const rightCells = document.querySelectorAll('.path-container.right .cell');
            const bottomCells = document.querySelectorAll('.path-container.bottom .cell');
            const leftCells = document.querySelectorAll('.path-container.left .cell');
            
            let cellNumber = 0;
            
            topCells.forEach(cell => {
                const numberSpan = document.createElement('span');
                numberSpan.className = 'cell-number';
                numberSpan.textContent = cellNumber++;
                cell.appendChild(numberSpan);
            });
            
            rightCells.forEach(cell => {
                const numberSpan = document.createElement('span');
                numberSpan.className = 'cell-number';
                numberSpan.textContent = cellNumber++;
                cell.appendChild(numberSpan);
            });
            
            bottomCells.forEach(cell => {
                const numberSpan = document.createElement('span');
                numberSpan.className = 'cell-number';
                numberSpan.textContent = cellNumber++;
                cell.appendChild(numberSpan);
            });
            
            leftCells.forEach(cell => {
                const numberSpan = document.createElement('span');
                numberSpan.className = 'cell-number';
                numberSpan.textContent = cellNumber++;
                cell.appendChild(numberSpan);
            });
        }
        
        async function pollGameState() {
            try {
                const response = await fetch(`/api/ludo-state/${gameId}`);
                
                if (response.status === 401) {
                    clearInterval(pollInterval);
                    window.location.href = '/login';
                    return;
                }
                
                if (!response.ok) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø®Ø§Ø¯Ù…:', response.status);
                    return;
                }
                
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    console.error('Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù„ÙŠØ³Øª JSON');
                    return;
                }
                
                const data = await response.json();
                
                if (!data.success) {
                    if (data.error === 'ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„') {
                        clearInterval(pollInterval);
                        window.location.href = '/login';
                    }
                    return;
                }
                
                const serverTurn = data.current_turn;
                const myPlayerColor = myPlayer === 1 ? 'green' : 'blue';
                const expectedColor = serverTurn === 1 ? 'green' : 'blue';
                
                let stateChanged = false;
                
                if (gameState.currentPlayer !== expectedColor) {
                    gameState.currentPlayer = expectedColor;
                    gameState.waitingForPieceSelection = false;
                    stateChanged = true;
                    
                    if (rollTimeout) {
                        clearTimeout(rollTimeout);
                        rollTimeout = null;
                        isRolling = false;
                        animationInProgress = false;
                    }
                }
                
                const oldWaitingState = gameState.waitingForPieceSelection;
                
                if (data.waiting_for_piece_selection && data.last_roll && gameState.currentPlayer === myPlayerColor) {
                    gameState.waitingForPieceSelection = true;
                    gameState.lastRoll = data.last_roll;
                    if (!isRolling) {
                        setupPieceClickListeners();
                    }
                } else {
                    gameState.waitingForPieceSelection = false;
                }
                
                if (oldWaitingState !== gameState.waitingForPieceSelection) {
                    stateChanged = true;
                }
                
                if (stateChanged) {
                    updateTurnDisplay(data.time_left);
                }
                
                if (!diceInitialized && data.last_roll && (!data.dice_animation || !data.dice_animation.is_rolling)) {
                    setDiceToResult(data.last_roll);
                    gameState.lastRoll = data.last_roll;
                    gameState.lastRollTimestamp = data.last_roll_timestamp;
                    return;
                }
                
                if (data.dice_animation) {
                    const diceAnim = data.dice_animation;
                    const timeSinceLastRoll = Date.now() - lastRollTime;
                    const timeSinceAnimEnd = Date.now() - lastAnimationEndTime;
                    
                    if (diceAnim.is_rolling && !isRolling && !animationInProgress && !rollRequestPending) {
                        const remainingMs = diceAnim.remaining_time * 1000;
                        const isMyOwnRoll = (myLastLocalRollTimestamp && data.last_roll_timestamp === myLastLocalRollTimestamp);
                        
                        if (!isMyOwnRoll && remainingMs > MIN_RESUME_THRESHOLD_MS && data.last_roll && data.last_roll_timestamp !== lastResumedTimestamp && timeSinceLastRoll > MIN_ROLL_INTERVAL_MS && timeSinceAnimEnd > MIN_COOLDOWN_AFTER_ANIM_MS) {
                            resumeDiceAnimation(data.last_roll, remainingMs, data.last_roll_timestamp);
                        } else if (data.last_roll && !isMyOwnRoll && timeSinceAnimEnd > MIN_COOLDOWN_AFTER_ANIM_MS) {
                            setDiceToResult(data.last_roll);
                            gameState.lastRoll = data.last_roll;
                            gameState.lastRollTimestamp = data.last_roll_timestamp;
                        }
                    } else if (!diceAnim.is_rolling && data.last_roll && !rollRequestPending) {
                        const isMyOwnRoll = (myLastLocalRollTimestamp && data.last_roll_timestamp === myLastLocalRollTimestamp);
                        
                        if (!isMyOwnRoll && timeSinceAnimEnd > MIN_COOLDOWN_AFTER_ANIM_MS && (data.last_roll !== gameState.lastRoll || data.last_roll_timestamp !== gameState.lastRollTimestamp)) {
                            setDiceToResult(data.last_roll);
                            gameState.lastRoll = data.last_roll;
                            gameState.lastRollTimestamp = data.last_roll_timestamp;
                        }
                    }
                } else if (data.last_roll && !isRolling && !animationInProgress && !rollRequestPending && data.last_roll_timestamp) {
                    const rollFromServer = data.last_roll;
                    const timestampFromServer = data.last_roll_timestamp;
                    const timeSinceAnimEnd = Date.now() - lastAnimationEndTime;
                    const timeSinceLastRoll = Date.now() - lastRollTime;
                    const isMyOwnRoll = (myLastLocalRollTimestamp && timestampFromServer === myLastLocalRollTimestamp);
                    
                    if (!isMyOwnRoll && timeSinceAnimEnd > MIN_COOLDOWN_AFTER_ANIM_MS) {
                        if (timestampFromServer !== gameState.lastRollTimestamp) {
                            await animateDiceRoll(rollFromServer);
                            gameState.lastRoll = rollFromServer;
                            gameState.lastRollTimestamp = timestampFromServer;
                        } else if (gameState.lastRoll !== rollFromServer) {
                            setDiceToResult(rollFromServer);
                            gameState.lastRoll = rollFromServer;
                            gameState.lastRollTimestamp = timestampFromServer;
                        }
                    }
                }
                
                if (data.player1_position && data.player2_position) {
                    syncPiecesFromServer(data.player1_position, data.player2_position, data.game_event_version);
                }
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©:', error);
            }
        }
        
        let lastSyncedState = null;
        let lastSyncedEventVersion = null;
        let isAnimating = false;
        let lastSoundPlayTime = 0;
        let hasGameStarted = false;
        let initialSyncDone = false;
        
        function syncPiecesFromServer(player1PosStr, player2PosStr, eventVersion = null) {
            try {
                const currentState = player1PosStr + '|' + player2PosStr;
                if (lastSyncedState === currentState) {
                    return;
                }
                
                if (eventVersion !== null && lastSyncedEventVersion === eventVersion) {
                    console.log('â¸ï¸ ØªØ¬Ø§Ù‡Ù„: ØªÙ… Ù…Ø¹Ø§Ù„Ø¬Ø© Ù‡Ø°Ø§ Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø¨Ø§Ù„ÙØ¹Ù„');
                    return;
                }
                
                if (isAnimating) {
                    console.log('â³ ØªØ£Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©: Ø±Ø³ÙˆÙ… Ù…ØªØ­Ø±ÙƒØ© Ø¬Ø§Ø±ÙŠØ©');
                    setTimeout(() => {
                        syncPiecesFromServer(player1PosStr, player2PosStr, eventVersion);
                    }, 200);
                    return;
                }
                
                lastSyncedState = currentState;
                if (eventVersion !== null) {
                    lastSyncedEventVersion = eventVersion;
                }
                
                const player1Pos = JSON.parse(player1PosStr);
                const player2Pos = JSON.parse(player2PosStr);
                
                const greenData = player1Pos.green || [0, 0, 0, 0];
                const blueData = player2Pos.blue || [0, 0, 0, 0];
                
                updatePlayerPieces('green', greenData);
                updatePlayerPieces('blue', blueData);
                
                if (!initialSyncDone) {
                    initialSyncDone = true;
                    console.log('âœ… Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ© Ù„Ù„Ø¹Ø¨Ø©');
                }
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù‚Ø·Ø¹:', error);
            }
        }
        
        function updatePlayerPieces(color, positionsArray) {
            const pieces = gameState.pieces[color];
            const playerPath = getPlayerPath(color);
            
            const isMyTurn = gameState.currentPlayer === color;
            const shouldPreserveAnimation = isMyTurn && gameState.waitingForPieceSelection;
            
            const allColorTokens = document.querySelectorAll(`.token.${color}`);
            allColorTokens.forEach(token => {
                if (!shouldPreserveAnimation) {
                    token.classList.remove('selectable');
                    token.style.animation = '';
                    token.style.cursor = 'default';
                }
            });
            
            for (let i = 0; i < 4; i++) {
                const serverPos = positionsArray[i];
                const localPiece = pieces[i];
                
                if (serverPos === 0) {
                    if (localPiece.steps >= 58) {
                        console.log(`âš ï¸ ØªØ¬Ø§Ù‡Ù„ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø±Ø¬Ø§Ø¹ Ø­Ø¬Ø± ${color} Ø±Ù‚Ù… ${i} Ù…Ù† Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ`);
                        continue;
                    }
                    
                    localPiece.inHome = true;
                    localPiece.position = -1;
                    localPiece.steps = 0;
                    
                    const allCells = document.querySelectorAll('.cell');
                    allCells.forEach(cell => {
                        const tokensInCell = cell.querySelectorAll(`.token.${color}[data-piece-index="${i}"]`);
                        tokensInCell.forEach(token => token.remove());
                    });
                    
                    const goldenRing = document.querySelector('.golden-ring');
                    if (goldenRing) {
                        const ringTokens = goldenRing.querySelectorAll(`.token.${color}[data-piece-index="${i}"]`);
                        ringTokens.forEach(token => token.remove());
                    }
                    
                    const homeTokens = document.querySelectorAll(`.player-home.${color} .token`);
                    homeTokens.forEach(token => {
                        const tokenPieceIndex = parseInt(token.getAttribute('data-piece-index'));
                        if (tokenPieceIndex === i) {
                            token.style.display = 'block';
                            token.style.opacity = '1';
                            token.style.width = '';
                            token.style.height = '';
                            token.style.position = '';
                            token.style.top = '';
                            token.style.left = '';
                            token.style.transform = '';
                            token.style.zIndex = '';
                            token.style.pointerEvents = '';
                            token.classList.remove('selectable');
                        }
                    });
                    
                    console.log(`ğŸ”„ ØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ Ø­Ø¬Ø± ${color} Ø±Ù‚Ù… ${i} Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±`);
                
                } else if (serverPos > 0 && serverPos !== localPiece.steps) {
                    const previousSteps = localPiece.steps;
                    localPiece.inHome = false;
                    localPiece.position = serverPos;
                    
                    if (serverPos >= 58) {
                        // Remove token from board cells and golden ring
                        const boardTokens = document.querySelectorAll(`.token.${color}[data-piece-index="${i}"]`);
                        boardTokens.forEach(token => token.remove());
                        console.log(`${color} piece ${i} is in center - hidden`);
                        
                        // Hide transparent token from home circle (keep in DOM for event listeners)
                        const homeTokens = document.querySelectorAll(`.player-home.${color} .token`);
                        homeTokens.forEach(token => {
                            const tokenPieceIndex = parseInt(token.getAttribute('data-piece-index'));
                            if (tokenPieceIndex === i) {
                                token.style.display = 'none';
                                token.style.pointerEvents = 'none';
                                token.classList.remove('selectable');
                            }
                        });
                        
                        if (initialSyncDone && navigator.vibrate) {
                            navigator.vibrate(200);
                            console.log('ğŸ“³ Ø§Ù‡ØªØ²Ø§Ø²: Ø¯Ø®ÙˆÙ„ Ø­Ø¬Ø± Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø±ÙƒØ²');
                        }
                        
                        localPiece.steps = serverPos;
                        localPiece.inHome = false;
                        continue;
                    }
                    
                    const existingToken = document.querySelector(`.cell .token.${color}[data-piece-index="${i}"]`);
                    const myPlayerColor = myPlayer === 1 ? 'green' : 'blue';
                    
                    if (existingToken && previousSteps > 0 && serverPos > previousSteps && color !== myPlayerColor) {
                        animatePieceMovement(color, i, previousSteps, serverPos, existingToken);
                        localPiece.steps = serverPos;
                    } else if (existingToken) {
                        const targetCell = playerPath[serverPos - 1];
                        if (targetCell && targetCell !== existingToken.parentElement) {
                            targetCell.style.position = 'relative';
                            targetCell.appendChild(existingToken);
                        }
                        localPiece.steps = serverPos;
                    } else {
                        const targetCell = playerPath[serverPos - 1];
                        if (targetCell) {
                            targetCell.style.position = 'relative';
                            
                            const homeTokens = document.querySelectorAll(`.player-home.${color} .token`);
                            let targetHomeToken = null;
                            homeTokens.forEach(token => {
                                if (parseInt(token.getAttribute('data-piece-index')) === i) {
                                    targetHomeToken = token;
                                }
                            });
                            
                            if (targetHomeToken) {
                                const delayBeforeShow = isRolling || animationInProgress ? 1900 : 0;
                                
                                setTimeout(() => {
                                    const newToken = document.createElement('div');
                                    newToken.className = `token ${color}`;
                                    newToken.style.width = '20px';
                                    newToken.style.height = '20px';
                                    newToken.style.position = 'absolute';
                                    newToken.style.top = '50%';
                                    newToken.style.left = '50%';
                                    newToken.style.transform = 'translate(-50%, -50%)';
                                    newToken.style.zIndex = '10';
                                    newToken.style.cursor = 'pointer';
                                    newToken.style.borderRadius = '50%';
                                    newToken.style.background = playerColors[color].gradient;
                                    newToken.style.border = '2px solid white';
                                    newToken.style.boxShadow = '0 2px 5px rgba(0,0,0,0.3)';
                                    newToken.setAttribute('data-piece-player', color);
                                    newToken.setAttribute('data-piece-index', i);
                                    
                                    newToken.addEventListener('click', function() {
                                        if (gameState.waitingForPieceSelection && gameState.currentPlayer === color) {
                                            const pieceIndex = parseInt(this.getAttribute('data-piece-index'));
                                            handlePieceClick(color, pieceIndex);
                                        }
                                    });
                                    
                                    targetCell.appendChild(newToken);
                                    targetHomeToken.style.opacity = '0.3';
                                    targetHomeToken.style.display = 'none';
                                    
                                    const now = Date.now();
                                    if (now - lastSoundPlayTime > 100 && soundEffectsEnabled) {
                                        const exitSoundEffect = document.getElementById('pieceMoveSoundEffect');
                                        if (exitSoundEffect) {
                                            exitSoundEffect.currentTime = 0;
                                            exitSoundEffect.play().catch(e => console.log('ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª:', e));
                                            lastSoundPlayTime = now;
                                        }
                                    }
                                }, delayBeforeShow);
                            }
                        }
                        localPiece.steps = serverPos;
                    }
                }
            }
        }
        
        function handlePieceClick(color, pieceIndex) {
            if (!gameState.waitingForPieceSelection || gameState.currentPlayer !== color) {
                return;
            }
            
            if (!canPieceMove(color, pieceIndex, gameState.lastRoll)) {
                return;
            }
            
            gameState.waitingForPieceSelection = false;
            
            const allTokens = document.querySelectorAll('.token');
            allTokens.forEach(t => t.classList.remove('selectable'));
            
            movePiece(gameState.lastRoll, pieceIndex);
            clickedPieces.clear();
            
            const rollBtn = document.querySelector('.roll-dice-button');
            if (gameState.lastRoll === 6) {
                if (rollBtn) {
                    rollBtn.disabled = false;
                    rollBtn.style.opacity = '1';
                    rollBtn.style.pointerEvents = 'auto';
                }
            } else {
                hideButtonWithLock();
                nextPlayer();
            }
        }
        
        function animateDiceRoll(result) {
            return new Promise((resolve) => {
                const dice = document.getElementById('ludoDice');
                if (!dice || isRolling) {
                    resolve();
                    return;
                }
                
                isRolling = true;
                gameState.lastRoll = result;
                
                if (soundEffectsEnabled) {
                    const diceSound = document.getElementById('diceRollSoundEffect');
                    if (diceSound) {
                        diceSound.currentTime = 0;
                        diceSound.volume = 1.0;
                        diceSound.play().catch(e => console.log('ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ù†Ø±Ø¯:', e));
                    }
                }
                
                dice.style.willChange = 'transform';
                dice.style.transition = 'none';
                dice.style.transform = 'translateZ(0) rotateX(0deg) rotateY(0deg) rotateZ(0deg)';
                
                const base = baseDiceRotations[result];
                const spins = 20;
                
                const finalX = base.x + (spins * 360);
                const finalY = base.y + (spins * 360);
                const finalZ = spins * 360;
                
                requestAnimationFrame(() => {
                    dice.style.transition = 'transform 1500ms linear';
                    dice.style.transform = `translateZ(0) rotateX(${finalX}deg) rotateY(${finalY}deg) rotateZ(${finalZ}deg)`;
                });
                
                lastDiceResult = result;
                
                setTimeout(() => {
                    dice.style.transition = 'none';
                    dice.style.transform = `translateZ(0) rotateX(${base.x}deg) rotateY(${base.y}deg)`;
                    dice.style.willChange = 'auto';
                    isRolling = false;
                    animationInProgress = false;
                    resolve();
                }, 1500);
            });
        }
        
        function resumeDiceAnimation(result, remainingMs, timestamp) {
            const dice = document.getElementById('ludoDice');
            const currentTime = Date.now();
            
            if (isRolling || animationInProgress || rollRequestPending) return;
            
            const timeSinceLastRoll = currentTime - lastRollTime;
            const timeSinceAnimEnd = currentTime - lastAnimationEndTime;
            
            if (timeSinceLastRoll < MIN_ROLL_INTERVAL_MS) {
                return;
            }
            
            if (lastAnimationEndTime > 0 && timeSinceAnimEnd < MIN_COOLDOWN_AFTER_ANIM_MS) {
                return;
            }
            
            if (timestamp && timestamp === lastResumedTimestamp) {
                return;
            }
            
            remainingMs = Math.max(MIN_RESUME_THRESHOLD_MS, Math.min(remainingMs, ANIMATION_DURATION_MS));
            
            if (remainingMs < MIN_RESUME_THRESHOLD_MS) {
                setDiceToResult(result);
                return;
            }
            
            if (rollTimeout) {
                clearTimeout(rollTimeout);
                rollTimeout = null;
            }
            
            rollRequestPending = true;
            isRolling = true;
            animationInProgress = true;
            lastResumedTimestamp = timestamp;
            lastRollTime = currentTime;
            gameState.lastRoll = result;
            
            dice.style.animation = 'none';
            void dice.offsetWidth;
            
            const base = baseDiceRotations[result];
            const elapsed = 2000 - remainingMs;
            const progress = Math.min(Math.max(elapsed / 2000, 0), 1);
            const remainingSpins = Math.max((1 - progress) * 4, 0);
            
            const finalX = base.x + (remainingSpins * 360);
            const finalY = base.y + (remainingSpins * 360);
            const finalZ = remainingSpins * 180;
            
            dice.style.transition = `transform ${remainingMs/1000}s cubic-bezier(0.25, 0.46, 0.45, 0.94)`;
            dice.style.transform = `translateZ(0) rotateX(${finalX}deg) rotateY(${finalY}deg) rotateZ(${finalZ}deg)`;
            
            lastDiceResult = result;
            
            setTimeout(() => {
                dice.style.transition = 'none';
                dice.style.animation = 'none';
                void dice.offsetWidth;
                dice.style.transform = `translateZ(0) rotateX(${base.x}deg) rotateY(${base.y}deg)`;
                
                requestAnimationFrame(() => {
                    dice.style.willChange = 'auto';
                    rollRequestPending = false;
                    isRolling = false;
                    animationInProgress = false;
                    lastAnimationEndTime = Date.now();
                });
            }, remainingMs);
        }
        
        function setDiceToResult(result) {
            const dice = document.getElementById('ludoDice');
            if (!dice) return;
            
            const base = baseDiceRotations[result];
            dice.style.transition = 'none';
            dice.style.transform = `translateZ(0) rotateX(${base.x}deg) rotateY(${base.y}deg) rotateZ(0deg)`;
            lastDiceResult = result;
            diceInitialized = true;
        }
        
        async function restoreGameStateFromServer() {
            try {
                const response = await fetch(`/api/ludo-state/${gameId}`);
                if (!response.ok) {
                    console.error('ÙØ´Ù„ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø§Ù„Ø©:', response.status);
                    return false;
                }
                
                const data = await response.json();
                if (!data.success) {
                    console.error('ÙØ´Ù„ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø§Ù„Ø©:', data.error);
                    return false;
                }
                
                console.log('âœ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±:', data);
                
                gameState.currentPlayer = data.current_turn === 1 ? 'green' : 'blue';
                gameState.lastRoll = data.last_roll || 0;
                gameState.lastRollTimestamp = data.last_roll_timestamp;
                gameState.waitingForPieceSelection = data.waiting_for_piece_selection === 1;
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø²Ø±
                isRolling = false;
                animationInProgress = false;
                rollRequestPending = false;
                buttonHideLock = false;
                if (buttonHideLockTimeout) {
                    clearTimeout(buttonHideLockTimeout);
                    buttonHideLockTimeout = null;
                }
                lastButtonState = null;
                
                if (data.player1_position && data.player2_position) {
                    syncPiecesFromServer(data.player1_position, data.player2_position, data.game_event_version);
                }
                
                if (data.last_roll && data.last_roll > 0) {
                    setDiceToResult(data.last_roll);
                }
                
                updateDiceColor(gameState.currentPlayer);
                updateRollButtonDisplay();
                updateTurnDisplay(data.time_left);
                
                const isMyTurn = gameState.currentPlayer === myPlayerColor;
                if (gameState.waitingForPieceSelection && isMyTurn && gameState.lastRoll > 0) {
                    setTimeout(() => setupPieceClickListeners(), 100);
                }
                
                console.log('âœ… ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­ - Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¬Ø§Ù‡Ø²Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø±ÙØ±Ø´');
                return true;
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø§Ù„Ø©:', error);
                return false;
            }
        }
        
        let audioEnabled = false;
        
        function enableBackgroundAudio() {
            if (audioEnabled) return;
            
            try {
                const pieceSound = document.getElementById('pieceMoveSoundEffect');
                const diceSound = document.getElementById('diceRollSoundEffect');
                
                if (pieceSound) {
                    pieceSound.volume = 0.01;
                    pieceSound.play().then(() => {
                        pieceSound.pause();
                        pieceSound.currentTime = 0;
                        pieceSound.volume = 1.0;
                        console.log('âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ ØµÙˆØª Ø­Ø±ÙƒØ© Ø§Ù„Ø­Ø¬Ø±');
                    }).catch(e => console.log('ØªÙØ¹ÙŠÙ„ ØµÙˆØª Ø­Ø±ÙƒØ© Ø§Ù„Ø­Ø¬Ø±:', e));
                }
                
                if (diceSound) {
                    diceSound.volume = 0.01;
                    diceSound.play().then(() => {
                        diceSound.pause();
                        diceSound.currentTime = 0;
                        diceSound.volume = 1.0;
                        console.log('âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ ØµÙˆØª Ø±Ù…ÙŠ Ø§Ù„Ù†Ø±Ø¯');
                    }).catch(e => console.log('ØªÙØ¹ÙŠÙ„ ØµÙˆØª Ø±Ù…ÙŠ Ø§Ù„Ù†Ø±Ø¯:', e));
                }
                
                audioEnabled = true;
                console.log('ğŸµ ØªÙ… ØªÙØ¹ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ØµÙˆØ§Øª ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©');
                
                document.removeEventListener('click', enableBackgroundAudio);
                document.removeEventListener('touchstart', enableBackgroundAudio);
                document.removeEventListener('keydown', enableBackgroundAudio);
            } catch (error) {
                console.log('Ø®Ø·Ø£ ÙÙŠ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£ØµÙˆØ§Øª:', error);
            }
        }
        
        let wakeLock = null;
        
        async function enableWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('ğŸ”’ ØªÙ… ØªÙØ¹ÙŠÙ„ Wake Lock - Ø§Ù„Ø´Ø§Ø´Ø© Ù„Ù† ØªÙ†Ø·ÙØ¦ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©');
                    
                    wakeLock.addEventListener('release', () => {
                        console.log('ğŸ”“ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Wake Lock');
                    });
                } else {
                    console.log('âš ï¸ Wake Lock API ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­');
                }
            } catch (err) {
                console.log('âš ï¸ ÙØ´Ù„ ØªÙØ¹ÙŠÙ„ Wake Lock:', err.message);
            }
        }
        
        async function disableWakeLock() {
            if (wakeLock !== null) {
                try {
                    await wakeLock.release();
                    wakeLock = null;
                    console.log('ğŸ”“ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Wake Lock Ø¨Ù†Ø¬Ø§Ø­');
                } catch (err) {
                    console.log('âš ï¸ ÙØ´Ù„ Ø¥Ù„ØºØ§Ø¡ Wake Lock:', err.message);
                }
            }
        }
        
        document.addEventListener('visibilitychange', async () => {
            if (wakeLock !== null && document.visibilityState === 'visible') {
                await enableWakeLock();
            }
        });
        
        async function initializeGame() {
            console.log('ğŸ® Ø¨Ø¯Ø¡ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©...');
            numberCells();
            warmupDice();
            
            await restoreGameStateFromServer();
            
            // Ø¥Ø®ÙØ§Ø¡ Ø§ÙØªØ§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø§Ù„Ø¢Ø®Ø±ÙŠÙ†
            const hideOpponentLabel = () => {
                if (myPlayerColor === 'green') {
                    const blueLabel = document.querySelector('.player-home.blue .player-label');
                    if (blueLabel) blueLabel.classList.add('hidden-label');
                } else if (myPlayerColor === 'blue') {
                    const greenLabel = document.querySelector('.player-home.green .player-label');
                    if (greenLabel) greenLabel.classList.add('hidden-label');
                }
            };
            hideOpponentLabel();
            
            pollInterval = setInterval(pollGameState, 500);
            console.log('âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¨Ù†Ø¬Ø§Ø­');
            
            await enableWakeLock();
            
            document.addEventListener('click', enableBackgroundAudio, { once: false });
            document.addEventListener('touchstart', enableBackgroundAudio, { once: false });
            document.addEventListener('keydown', enableBackgroundAudio, { once: false });
        }
        
        window.addEventListener('load', () => {
            console.log('ğŸ“± ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© - Ø¨Ø¯Ø¡ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©');
            initializeGame();
        });
        
        window.addEventListener('pageshow', (event) => {
            if (event.persisted) {
                console.log('ğŸ”„ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„ØµÙØ­Ø© Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ©');
                restoreGameStateFromServer();
            }
        });
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ÙÙˆØ² Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø­Ù„ÙŠØ§Ù‹
        function checkSavedVictoryMessages() {
            const savedVictory = localStorage.getItem('ludoVictory');
            if (savedVictory) {
                console.log('ğŸ‰ ÙˆØ¬Ø¯Øª Ø±Ø³Ø§Ù„Ø© ÙÙˆØ² Ù…Ø­ÙÙˆØ¸Ø©:', savedVictory);
                try {
                    const victoryData = JSON.parse(savedVictory);
                    // Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
                    showLudoResult(victoryData);
                    // Ø­Ø°Ù Ù…Ù† localStorage Ø¨Ø¹Ø¯ Ø¹Ø±Ø¶Ù‡Ø§
                    localStorage.removeItem('ludoVictory');
                } catch (e) {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„ÙÙˆØ²:', e);
                }
            }
        }
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        window.addEventListener('load', () => {
            console.log('ğŸ“± ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© - Ø¨Ø¯Ø¡ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©');
            setTimeout(checkSavedVictoryMessages, 500);
            initializeGame();
        });
        
        async function releasePieceFromHome(specificPieceIndex = -1) {
            const player = gameState.currentPlayer;
            const pieces = gameState.pieces[player];
            
            for (let i = 0; i < pieces.length; i++) {
                if (specificPieceIndex >= 0 && i !== specificPieceIndex) continue;
                
                if (pieces[i].inHome) {
                    pieces[i].inHome = false;
                    
                    if (player === 'green') {
                        pieces[i].steps = 1;
                    } else if (player === 'blue') {
                        pieces[i].steps = 1;
                    }
                    
                    pieces[i].pieceIndex = i;
                    
                    const tokenElements = document.querySelectorAll(`.player-home.${player} .token`);
                    let targetToken = null;
                    tokenElements.forEach(token => {
                        if (parseInt(token.getAttribute('data-piece-index')) === i) {
                            targetToken = token;
                        }
                    });
                    
                    if (targetToken) {
                        const playerPath = getPlayerPath(player);
                        const targetCell = playerPath[pieces[i].steps - 1];
                        
                        if (targetCell) {
                            captureOpponentPiece(targetCell, player);
                            
                            const newToken = targetToken.cloneNode(true);
                            newToken.style.width = '20px';
                            newToken.style.height = '20px';
                            newToken.style.position = 'absolute';
                            newToken.style.top = '50%';
                            newToken.style.left = '50%';
                            newToken.style.transform = 'translate(-50%, -50%)';
                            newToken.style.zIndex = '10';
                            newToken.style.cursor = 'pointer';
                            newToken.setAttribute('data-piece-player', player);
                            newToken.setAttribute('data-piece-index', i);
                            targetCell.style.position = 'relative';
                            targetCell.appendChild(newToken);
                            targetToken.style.opacity = '0.3';
                            targetToken.style.display = 'none';
                            setupPieceClickListeners();
                        }
                    }
                    
                    await sendGameStateToServer(true);
                    return true;
                }
            }
            return false;
        }
        
        function getAllPathCells() {
            const topCells = Array.from(document.querySelectorAll('.path-container.top .cell'));
            const rightCells = Array.from(document.querySelectorAll('.path-container.right .cell'));
            const bottomCells = Array.from(document.querySelectorAll('.path-container.bottom .cell'));
            const leftCells = Array.from(document.querySelectorAll('.path-container.left .cell'));
            
            return [...topCells, ...rightCells, ...bottomCells, ...leftCells];
        }
        
        function getCellByNumber(cellNum) {
            const allCells = getAllPathCells();
            return allCells[cellNum];
        }
        
        function getPlayerPath(player) {
            if (player === 'blue') {
                const bluePath = [
                    50, 47, 44, 41, 38, 30, 31, 32, 33, 34, 35, 29, 23, 22, 21, 20, 
                    19, 18, 17, 14, 11, 8, 5, 2, 1, 0, 3, 6, 9, 12, 15, 59, 58, 57, 
                    56, 55, 54, 60, 66, 67, 68, 69, 70, 71, 36, 39, 42, 45, 48, 51, 
                    52, 53, 49, 46, 43, 40, 37, null
                ];
                return bluePath.map(cellNum => cellNum === null ? null : getCellByNumber(cellNum));
            } else if (player === 'green') {
                const GREEN_MAIN_LOOP = [
                    3, 6, 9, 12, 15, 59, 58, 57, 56, 55, 54, 60, 66, 67, 68, 69, 70, 71, 
                    36, 39, 42, 45, 48, 51, 52, 53, 50, 47, 44, 41, 38, 30, 31, 32, 33, 34, 35, 
                    29, 23, 22, 21, 20, 19, 18, 17, 14, 11, 8, 5, 2, 1, 0
                ];
                const GREEN_HOME_RUN = [4, 7, 10, 13, 16, null];
                const fullGreenPath = [...GREEN_MAIN_LOOP, ...GREEN_HOME_RUN];
                return fullGreenPath.map(cellNum => cellNum === null ? null : getCellByNumber(cellNum));
            }
            return [];
        }
        
        function countPiecesOutside() {
            const player = gameState.currentPlayer;
            const pieces = gameState.pieces[player];
            let count = 0;
            for (let i = 0; i < pieces.length; i++) {
                if (!pieces[i].inHome) {
                    count++;
                }
            }
            return count;
        }
        
        function countMovablePieces(diceRoll) {
            const player = gameState.currentPlayer;
            const pieces = gameState.pieces[player];
            let count = 0;
            for (let i = 0; i < pieces.length; i++) {
                if (canPieceMove(player, i, diceRoll)) {
                    count++;
                }
            }
            return count;
        }
        
        function getRemainingSteps(player, pieceIndex) {
            const pieces = gameState.pieces[player];
            const piece = pieces[pieceIndex];
            
            if (piece.inHome) {
                return -1;
            }
            
            const totalPathLength = 58;
            
            const currentSteps = piece.steps || 0;
            const remaining = totalPathLength - currentSteps;
            
            return remaining;
        }
        
        function canPieceMove(player, pieceIndex, diceRoll) {
            const pieces = gameState.pieces[player];
            const piece = pieces[pieceIndex];
            
            if (piece.inHome) {
                return diceRoll === 6;
            }
            
            const remainingSteps = getRemainingSteps(player, pieceIndex);
            
            if (remainingSteps < 0) {
                return false;
            }
            
            const canMove = diceRoll <= remainingSteps;
            
            return canMove;
        }
        
        function showPieceSelector(cell, movablePieces) {
            const modal = document.getElementById('pieceSelectorModal');
            const buttonsContainer = document.getElementById('selectorButtons');
            const titleElement = document.getElementById('selectorTitle');
            
            buttonsContainer.innerHTML = '';
            
            if (movablePieces.length === 2) {
                titleElement.textContent = 'Ø§Ø®ØªØ± ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø­Ø¬Ø± 1 Ø£Ùˆ 2';
            } else if (movablePieces.length === 3) {
                titleElement.textContent = 'Ø§Ø®ØªØ± ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø­Ø¬Ø± 1 Ø£Ùˆ 2 Ø£Ùˆ 3';
            } else if (movablePieces.length === 4) {
                titleElement.textContent = 'Ø§Ø®ØªØ± ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø­Ø¬Ø± 1 Ø£Ùˆ 2 Ø£Ùˆ 3 Ø£Ùˆ 4';
            } else {
                titleElement.textContent = 'Ø§Ø®ØªØ± Ø§Ù„Ø­Ø¬Ø± Ø§Ù„Ù…Ø±Ø§Ø¯ ØªØ­Ø±ÙŠÙƒÙ‡';
            }
            
            movablePieces.forEach((pieceIndex, index) => {
                const button = document.createElement('button');
                button.className = 'piece-btn';
                button.textContent = (index + 1).toString();
                button.onclick = function() {
                    modal.classList.remove('show');
                    gameState.waitingForPieceSelection = false;
                    
                    clearSelectablePieces();
                    
                    movePiece(gameState.lastRoll, pieceIndex);
                    clickedPieces.clear();
                    
                    const rollBtn = document.querySelector('.roll-dice-button');
                    if (gameState.lastRoll === 6) {
                        if (rollBtn) {
                            rollBtn.disabled = false;
                            rollBtn.style.opacity = '1';
                            rollBtn.style.pointerEvents = 'auto';
                        }
                    } else {
                        hideButtonWithLock();
                        nextPlayer();
                    }
                };
                buttonsContainer.appendChild(button);
            });
            
            modal.classList.add('show');
        }
        
        function clearSelectablePieces() {
            const allTokens = document.querySelectorAll('.token');
            allTokens.forEach(token => {
                token.classList.remove('selectable');
                token.style.animation = '';
                token.style.cursor = 'default';
            });
        }
        
        function setupPieceClickListeners() {
            console.log('ğŸ”§ Ø¨Ø¯Ø¡ setupPieceClickListeners:', {
                waitingForPieceSelection: gameState.waitingForPieceSelection,
                lastRoll: gameState.lastRoll,
                currentPlayer: gameState.currentPlayer
            });
            
            const allCells = document.querySelectorAll('.cell');
            
            clearSelectablePieces();
            
            const allTokens = document.querySelectorAll('.token');
            allTokens.forEach(token => {
                token.onclick = null;
            });
            
            const player = gameState.currentPlayer;
            const playerHome = document.querySelector(`.player-home.${player}`);
            console.log('ğŸ” playerHome:', {
                player,
                found: !!playerHome
            });
            
            allCells.forEach(cell => {
                const tokens = cell.querySelectorAll('.token');
                tokens.forEach(token => {
                    const piecePlayer = token.getAttribute('data-piece-player');
                    const pieceIndex = parseInt(token.getAttribute('data-piece-index'));
                    
                    if (gameState.waitingForPieceSelection && 
                        piecePlayer === gameState.currentPlayer && 
                        myPlayerColor === gameState.currentPlayer &&
                        canPieceMove(piecePlayer, pieceIndex, gameState.lastRoll)) {
                        token.classList.add('selectable');
                    }
                });
                
                cell.onclick = function(e) {
                    if (!gameState.waitingForPieceSelection) return;
                    
                    const cellTokens = cell.querySelectorAll(`.token.${gameState.currentPlayer}`);
                    const movablePieces = [];
                    
                    cellTokens.forEach(token => {
                        const piecePlayer = token.getAttribute('data-piece-player');
                        const pieceIndex = parseInt(token.getAttribute('data-piece-index'));
                        
                        if (piecePlayer === gameState.currentPlayer && 
                            canPieceMove(piecePlayer, pieceIndex, gameState.lastRoll)) {
                            movablePieces.push(pieceIndex);
                        }
                    });
                    
                    if (movablePieces.length === 0) return;
                    
                    if (movablePieces.length === 1) {
                        gameState.waitingForPieceSelection = false;
                        
                        clearSelectablePieces();
                        
                        movePiece(gameState.lastRoll, movablePieces[0]);
                        clickedPieces.clear();
                        
                        const rollBtn = document.querySelector('.roll-dice-button');
                        if (gameState.lastRoll === 6) {
                            if (rollBtn) {
                                rollBtn.disabled = false;
                                rollBtn.style.opacity = '1';
                                rollBtn.style.pointerEvents = 'auto';
                            }
                        } else {
                            hideButtonWithLock();
                            nextPlayer();
                        }
                    } else {
                        showPieceSelector(cell, movablePieces);
                    }
                };
            });
            
            console.log('â³ ÙØ­Øµ Ø§Ù„Ø´Ø±ÙˆØ·:', {
                cond1_waiting: gameState.waitingForPieceSelection,
                cond2_roll6: gameState.lastRoll === 6,
                cond3_home: !!playerHome,
                allTrue: gameState.waitingForPieceSelection && gameState.lastRoll === 6 && playerHome
            });
            
            if (gameState.waitingForPieceSelection && gameState.lastRoll === 6 && playerHome && myPlayerColor === gameState.currentPlayer) {
                const pieces = gameState.pieces[player];
                const hasUnreleasedPiece = pieces.some(p => p.inHome);
                
                console.log('ğŸ  ÙØ­Øµ Ø£Ø­Ø¬Ø§Ø± Ø§Ù„Ø¯Ø§Ø¦Ø±Ø©:', {
                    player,
                    waitingForPieceSelection: gameState.waitingForPieceSelection,
                    lastRoll: gameState.lastRoll,
                    hasUnreleasedPiece,
                    pieces: pieces.map((p, i) => ({ index: i, inHome: p.inHome, steps: p.steps }))
                });
                
                if (hasUnreleasedPiece) {
                    const homeTokens = playerHome.querySelectorAll('.token');
                    homeTokens.forEach((token) => {
                        const tokenPieceIndex = parseInt(token.getAttribute('data-piece-index'));
                        
                        if (pieces[tokenPieceIndex] && pieces[tokenPieceIndex].inHome) {
                            const canMove = canPieceMove(player, tokenPieceIndex, gameState.lastRoll);
                            console.log(`ğŸ¯ Ø­Ø¬Ø± ${tokenPieceIndex} ÙÙŠ Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© (Ø§Ù„Ø¨Ø­Ø« Ø¨Ø±Ù…Ø² Ø§Ù„Ø¹Ù†ØµØ±):`, {
                                inHome: pieces[tokenPieceIndex].inHome,
                                canMove,
                                dataAttribute: token.getAttribute('data-piece-index')
                            });
                            
                            if (canMove) {
                                console.log(`âœ… Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ± ÙˆØ§Ù…Ø¶ Ù„Ù„Ø­Ø¬Ø± ${tokenPieceIndex}`);
                                token.classList.add('selectable');
                                token.style.cursor = 'pointer';
                                token.style.animation = 'tokenPulse 1s infinite ease-in-out';
                                
                                token.onclick = function(e) {
                                    e.stopPropagation();
                                    if (!gameState.waitingForPieceSelection) return;
                                    
                                    gameState.waitingForPieceSelection = false;
                                    
                                    clearSelectablePieces();
                                    
                                    releasePieceFromHome(tokenPieceIndex);
                                    clickedPieces.clear();
                                    
                                    const rollBtn = document.querySelector('.roll-dice-button');
                                    if (rollBtn) {
                                        rollBtn.disabled = false;
                                        rollBtn.style.opacity = '1';
                                        rollBtn.style.pointerEvents = 'auto';
                                    }
                                };
                            }
                        }
                    });
                }
            }
        }
        
        async function movePiece(steps, specificPieceIndex = -1) {
            const player = gameState.currentPlayer;
            const pieces = gameState.pieces[player];
            
            for (let i = 0; i < pieces.length; i++) {
                if (specificPieceIndex >= 0 && i !== specificPieceIndex) continue;
                
                if (!pieces[i].inHome && pieces[i].steps >= 0) {
                    if (!canPieceMove(player, i, steps)) {
                        console.log(`Cannot move piece ${i}: exceeds path length`);
                        return false;
                    }
                    
                    const currentSteps = pieces[i].steps;
                    const newSteps = currentSteps + steps;
                    
                    const allCells = document.querySelectorAll('.cell');
                    const goldenRing = document.querySelector('.golden-ring');
                    let currentToken = null;
                    
                    allCells.forEach(cell => {
                        const tokens = cell.querySelectorAll(`.token.${player}`);
                        tokens.forEach(token => {
                            const tokenPieceIndex = parseInt(token.getAttribute('data-piece-index'));
                            if (tokenPieceIndex === i) {
                                currentToken = token.cloneNode(true);
                                token.remove();
                            }
                        });
                    });
                    
                    if (!currentToken && goldenRing) {
                        const tokens = goldenRing.querySelectorAll(`.token.${player}`);
                        tokens.forEach(token => {
                            const tokenPieceIndex = parseInt(token.getAttribute('data-piece-index'));
                            if (tokenPieceIndex === i) {
                                currentToken = token.cloneNode(true);
                                token.remove();
                            }
                        });
                    }
                    
                    if (currentToken) {
                        animatePieceMovement(player, i, currentSteps, newSteps, currentToken);
                    }
                    
                    pieces[i].steps = newSteps;
                    const shouldKeepTurn = gameState.lastRoll === 6;
                    await sendGameStateToServer(shouldKeepTurn);
                    return true;
                }
            }
            return false;
        }
        
        function animatePieceMovement(player, pieceIndex, fromStep, toStep, token) {
            isAnimating = true;
            const playerPath = getPlayerPath(player);
            let currentStep = fromStep;
            let isFirstMove = true;
            
            const moveOneStep = () => {
                currentStep++;
                
                if (currentStep > toStep) {
                    isAnimating = false;
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø²Ø± Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø­Ø±ÙƒØ© Ø§Ù„Ø­Ø¬Ø± Ù…Ø¨Ø§Ø´Ø±Ø©
                    setTimeout(() => updateRollButtonDisplay(), 50);
                    return;
                }
                
                if (currentStep > 0 && currentStep <= playerPath.length) {
                    const targetCell = playerPath[currentStep - 1];
                    
                    if (targetCell === null) {
                        console.log(`${player} piece ${pieceIndex} reached center - hidden from display`);
                        
                        if (initialSyncDone && navigator.vibrate) {
                            navigator.vibrate(200);
                            console.log('ğŸ“³ Ø§Ù‡ØªØ²Ø§Ø²: Ø¯Ø®ÙˆÙ„ Ø­Ø¬Ø± Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø±ÙƒØ²');
                        }
                        
                        if (token.parentElement) {
                            token.remove();
                        }
                        
                        // Hide transparent token from home circle (keep in DOM for event listeners)
                        const homeTokens = document.querySelectorAll(`.player-home.${player} .token`);
                        homeTokens.forEach(token => {
                            const tokenPieceIndex = parseInt(token.getAttribute('data-piece-index'));
                            if (tokenPieceIndex === pieceIndex) {
                                token.style.display = 'none';
                                token.style.pointerEvents = 'none';
                                token.classList.remove('selectable');
                            }
                        });
                        
                        const allTokens = document.querySelectorAll('.token');
                        allTokens.forEach(t => t.classList.remove('selectable'));
                        isAnimating = false;
                        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø²Ø± Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø­Ø±ÙƒØ© Ø§Ù„Ø­Ø¬Ø± Ù…Ø¨Ø§Ø´Ø±Ø©
                        setTimeout(() => updateRollButtonDisplay(), 50);
                        return;
                    }
                    
                    if (targetCell) {
                        if (token.parentElement) {
                            token.remove();
                        }
                        
                        if (currentStep === toStep) {
                            captureOpponentPiece(targetCell, player);
                        }
                        
                        targetCell.style.position = 'relative';
                        token.style.cursor = 'pointer';
                        token.classList.remove('selectable');
                        token.setAttribute('data-piece-player', player);
                        token.setAttribute('data-piece-index', pieceIndex);
                        targetCell.appendChild(token);
                        
                        const now = Date.now();
                        if (initialSyncDone && now - lastSoundPlayTime > 50 && soundEffectsEnabled) {
                            const moveSoundEffect = document.getElementById('pieceMoveSoundEffect');
                            if (moveSoundEffect) {
                                moveSoundEffect.currentTime = 0;
                                moveSoundEffect.play().catch(e => console.log('ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª:', e));
                                lastSoundPlayTime = now;
                            }
                        }
                        
                        if (currentStep === toStep) {
                            const allTokens = document.querySelectorAll('.token');
                            allTokens.forEach(t => t.classList.remove('selectable'));
                            isAnimating = false;
                            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø²Ø± Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø­Ø±ÙƒØ© Ø§Ù„Ø­Ø¬Ø± Ù…Ø¨Ø§Ø´Ø±Ø©
                            setTimeout(() => updateRollButtonDisplay(), 50);
                        }
                    }
                }
                
                if (currentStep < toStep) {
                    setTimeout(moveOneStep, 130);
                } else {
                    isAnimating = false;
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø²Ø± Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø­Ø±ÙƒØ© Ø§Ù„Ø­Ø¬Ø± Ù…Ø¨Ø§Ø´Ø±Ø©
                    setTimeout(() => updateRollButtonDisplay(), 50);
                }
            };
            
            moveOneStep();
        }
        
        let isSendingToServer = false;
        
        async function sendGameStateToServer(keepCurrentTurn = false) {
            try {
                const myPlayerColor = myPlayer === 1 ? 'green' : 'blue';
                
                if (gameState.currentPlayer !== myPlayerColor) {
                    console.log('âš ï¸ ØªÙ… ØªØ®Ø·ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: Ù„ÙŠØ³ Ø¯ÙˆØ±ÙŠ');
                    return;
                }
                
                if (isSendingToServer) {
                    console.log('âš ï¸ ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„ØŒ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...');
                    return;
                }
                
                isSendingToServer = true;
                
                const positions = {
                    red: [0, 0, 0, 0],
                    green: myPlayerColor === 'green' ? gameState.pieces.green.map(p => p.steps || 0) : [0, 0, 0, 0],
                    yellow: [0, 0, 0, 0],
                    blue: myPlayerColor === 'blue' ? gameState.pieces.blue.map(p => p.steps || 0) : [0, 0, 0, 0]
                };
                
                let nextTurn;
                if (keepCurrentTurn) {
                    nextTurn = gameState.currentPlayer === 'green' ? 1 : 2;
                } else {
                    nextTurn = gameState.currentPlayer === 'green' ? 2 : 1;
                }
                
                const response = await fetch(`/api/ludo-move/${gameId}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        position: positions,
                        next_turn: nextTurn
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    console.log('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø­Ø±ÙƒØ© Ø¨Ù†Ø¬Ø§Ø­');
                } else {
                    console.warn('âš ï¸ ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©:', data.error);
                }
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©:', error);
            } finally {
                setTimeout(() => {
                    isSendingToServer = false;
                }, 500);
            }
        }
        
        async function nextPlayer() {
            await sendGameStateToServer(false);
            
            if (gameState.currentPlayer === 'blue') {
                gameState.currentPlayer = 'green';
            } else {
                gameState.currentPlayer = 'blue';
            }
        }
        
        async function rollDiceButton() {
            console.log('ğŸ² Ø±Ù…ÙŠ Ø§Ù„Ù†Ø±Ø¯ - Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ');
            stopTurnTimer();
            
            const dice = document.getElementById('ludoDice');
            const rollBtn = document.querySelector('.roll-dice-button');
            
            if (!dice || !rollBtn) return;
            
            // âœ¨ ØªØ£Ø«ÙŠØ± ØªØ¸Ù„ÙŠÙ„ ÙÙˆØ±ÙŠ Ù„Ù…Ù†Ø¹ Ø§Ù„Ø¶ØºØ· Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬
            rollBtn.style.opacity = '0.3';
            rollBtn.style.transition = 'opacity 0.1s ease';
            
            const currentTime = Date.now();
            
            if (isRolling || rollRequestPending || animationInProgress) {
                console.log('Ø±Ù…ÙŠ Ø¬Ø§Ø±ÙŠ Ø¨Ø§Ù„ÙØ¹Ù„ - ØªÙ… ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ù†Ù‚Ø±Ø©');
                rollBtn.style.opacity = '1';
                return;
            }
            
            if (currentTime - lastRollTime < MIN_ROLL_INTERVAL_MS) {
                console.log('ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø¨Ù„ Ø§Ù„Ø±Ù…ÙŠ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰');
                rollBtn.style.opacity = '1';
                return;
            }
            
            if (currentTime - lastAnimationEndTime < MIN_COOLDOWN_AFTER_ANIM_MS) {
                console.log('ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ø­ØªÙ‰ ØªÙ†ØªÙ‡ÙŠ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ù…ØªØ­Ø±ÙƒØ© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©');
                rollBtn.style.opacity = '1';
                return;
            }
            
            const myPlayerColor = myPlayer === 1 ? 'green' : 'blue';
            if (gameState.currentPlayer !== myPlayerColor) {
                alert('Ù„ÙŠØ³ Ø¯ÙˆØ±Ùƒ!');
                rollBtn.style.opacity = '1';
                return;
            }
            
            isRolling = true;
            rollRequestPending = true;
            animationInProgress = true;
            rollBtn.disabled = true;
            rollBtn.style.pointerEvents = 'none';
            lastRollTime = currentTime;
            
            if (rollTimeout) {
                clearTimeout(rollTimeout);
                rollTimeout = null;
            }
            
            let result;
            try {
                const response = await fetch(`/api/ludo-roll/${gameId}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                const data = await response.json();
                
                rollRequestPending = false;
                
                if (!data.success) {
                    alert(data.error || 'ÙØ´Ù„ Ø±Ù…ÙŠ Ø§Ù„Ù†Ø±Ø¯');
                    isRolling = false;
                    animationInProgress = false;
                    rollRequestPending = false;
                    rollBtn.disabled = false;
                    rollBtn.style.pointerEvents = 'auto';
                    rollBtn.style.opacity = '1';
                    return;
                }
                
                result = data.roll;
                gameState.lastRoll = result;
                gameState.lastRollTimestamp = data.roll_timestamp || new Date().toISOString();
                myLastLocalRollTimestamp = gameState.lastRollTimestamp;
                
                if (soundEffectsEnabled) {
                    const diceSound = document.getElementById('diceRollSoundEffect');
                    if (diceSound) {
                        try {
                            if (!diceSound.paused) {
                                diceSound.pause();
                            }
                            diceSound.currentTime = 0;
                            diceSound.volume = 1.0;
                            diceSound.play().catch(e => console.log('ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ù†Ø±Ø¯:', e));
                        } catch (e) {
                            console.log('Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª:', e);
                        }
                    }
                }
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø±Ù…ÙŠ Ø§Ù„Ù†Ø±Ø¯:', error);
                rollRequestPending = false;
                isRolling = false;
                animationInProgress = false;
                rollBtn.disabled = false;
                rollBtn.style.pointerEvents = 'auto';
                rollBtn.style.opacity = '1';
                return;
            }
            
            dice.style.transition = 'none';
            dice.style.animation = 'none';
            dice.style.willChange = 'transform';
            dice.style.transform = 'translateZ(0) rotateX(0deg) rotateY(0deg) rotateZ(0deg)';
            
            void dice.offsetWidth;
            
            const base = baseDiceRotations[result];
            const randomSpinsX = 20;
            const randomSpinsY = 20;
            const randomSpinsZ = 20;
            
            const finalX = base.x + (randomSpinsX * 360);
            const finalY = base.y + (randomSpinsY * 360);
            const finalZ = randomSpinsZ * 360;
            
            const duration = 1.5;
            
            requestAnimationFrame(() => {
                dice.style.transition = `transform ${duration}s linear`;
                dice.style.transform = `translate3d(0, 0, 0) rotateX(${finalX}deg) rotateY(${finalY}deg) rotateZ(${finalZ}deg)`;
            });
            
            lastDiceResult = result;
            
            rollTimeout = setTimeout(() => {
                dice.style.transition = 'none';
                dice.style.animation = 'none';
                void dice.offsetWidth;
                dice.style.transform = `translateZ(0) rotateX(${base.x}deg) rotateY(${base.y}deg)`;
                
                requestAnimationFrame(() => {
                    dice.style.willChange = 'auto';
                });
                
                isRolling = false;
                animationInProgress = false;
                lastAnimationEndTime = Date.now();
                rollBtn.disabled = false;
                rollBtn.style.pointerEvents = 'auto';
                rollBtn.style.opacity = '1';
                
                const player = gameState.currentPlayer;
                const pieces = gameState.pieces[player];
                const movablePiecesCount = countMovablePieces(result);
                
                if (result === 6) {
                    let hasUnreleasedPiece = pieces.some(p => p.inHome);
                    const allPiecesInHome = pieces.every(p => p.inHome);
                    const piecesOutside = pieces.filter(p => !p.inHome).length;
                    
                    if (allPiecesInHome) {
                        releasePieceFromHome(0);
                    } else if (hasUnreleasedPiece && piecesOutside > 0 && movablePiecesCount > 1) {
                        gameState.waitingForPieceSelection = true;
                        startPieceSelectionTimeout();
                        rollBtn.disabled = true;
                        rollBtn.style.opacity = '0.5';
                        rollBtn.style.pointerEvents = 'none';
                        setTimeout(() => setupPieceClickListeners(), 100);
                    } else if (movablePiecesCount === 1) {
                        for (let i = 0; i < pieces.length; i++) {
                            if (canPieceMove(player, i, result)) {
                                if (pieces[i].inHome) {
                                    releasePieceFromHome(i);
                                } else {
                                    movePiece(result, i);
                                }
                                break;
                            }
                        }
                    } else if (movablePiecesCount > 1) {
                        gameState.waitingForPieceSelection = true;
                        startPieceSelectionTimeout();
                        rollBtn.disabled = true;
                        rollBtn.style.opacity = '0.5';
                        rollBtn.style.pointerEvents = 'none';
                        setTimeout(() => setupPieceClickListeners(), 100);
                    }
                } else {
                    const allPiecesInHome = pieces.every(p => p.inHome);
                    
                    if (allPiecesInHome) {
                        hideButtonWithLock();
                        nextPlayer();
                    } else {
                        if (movablePiecesCount > 1) {
                            gameState.waitingForPieceSelection = true;
                            startPieceSelectionTimeout();
                            rollBtn.disabled = true;
                            rollBtn.style.opacity = '0.5';
                            rollBtn.style.pointerEvents = 'none';
                            setTimeout(() => setupPieceClickListeners(), 100);
                        } else if (movablePiecesCount === 1) {
                            for (let i = 0; i < pieces.length; i++) {
                                if (canPieceMove(player, i, result)) {
                                    const moved = movePiece(result, i);
                                    if (moved) {
                                        hideButtonWithLock();
                                        nextPlayer();
                                    }
                                    break;
                                }
                            }
                        } else {
                            hideButtonWithLock();
                            nextPlayer();
                        }
                    }
                }
            }, 1500);
        }
        
        let localStream = null;
        let peerConnection = null;
        let isMuted = true;
        let voiceSocket = null;
        let tracksAddedToPeer = false;
        let audioInitialized = false;
        let voiceChatInitializing = false;
        let currentRemoteStream = null;
        let voiceSocketListenersAttached = false;
        
        function toggleVoiceChat() {
            const btn = document.getElementById('voiceChatToggleBtn');
            const micOnIcon = document.getElementById('micOnIcon');
            const micOffIcon = document.getElementById('micOffIcon');
            
            if (!localStream || localStream.getTracks().length === 0) {
                initializeVoiceChat().then(() => {
                    if (localStream && localStream.getTracks().length > 0) {
                        isMuted = false;
                        localStream.getAudioTracks().forEach(track => {
                            track.enabled = true;
                        });
                        if (btn) btn.classList.remove('muted');
                        if (micOnIcon) micOnIcon.style.display = 'block';
                        if (micOffIcon) micOffIcon.style.display = 'none';
                        if (voiceSocket) {
                            voiceSocket.emit('toggle_mute', {
                                game_id: ludoGameId,
                                muted: false
                            });
                        }
                        saveVoiceState();
                        console.log('ğŸ¤ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ù…ÙØ¹Ù‘Ù„');
                    } else {
                        console.log('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙ„Ø§Ø­ÙŠØ§Øª Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†');
                    }
                });
            } else {
                isMuted = !isMuted;
                localStream.getAudioTracks().forEach(track => {
                    track.enabled = !isMuted;
                });
                
                if (isMuted) {
                    if (btn) btn.classList.add('muted');
                    if (micOnIcon) micOnIcon.style.display = 'none';
                    if (micOffIcon) micOffIcon.style.display = 'block';
                    console.log('ğŸ”‡ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ù…ÙƒØªÙˆÙ…');
                } else {
                    if (btn) btn.classList.remove('muted');
                    if (micOnIcon) micOnIcon.style.display = 'block';
                    if (micOffIcon) micOffIcon.style.display = 'none';
                    console.log('ğŸ¤ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ù…ÙØ¹Ù‘Ù„');
                }
                
                if (voiceSocket) {
                    voiceSocket.emit('toggle_mute', {
                        game_id: ludoGameId,
                        muted: isMuted
                    });
                }
                
                saveVoiceState();
            }
        }
        
        function updateVoiceChatIcon() {
            const btn = document.getElementById('voiceChatToggleBtn');
            const micOnIcon = document.getElementById('micOnIcon');
            const micOffIcon = document.getElementById('micOffIcon');
            
            if (isMuted) {
                if (btn) btn.classList.add('muted');
                if (micOnIcon) micOnIcon.style.display = 'none';
                if (micOffIcon) micOffIcon.style.display = 'block';
            } else {
                if (btn) btn.classList.remove('muted');
                if (micOnIcon) micOnIcon.style.display = 'block';
                if (micOffIcon) micOffIcon.style.display = 'none';
            }
        }
        
        function playSoundEffect(elementId) {
            const sound = document.getElementById(elementId);
            if (sound) {
                sound.currentTime = 0;
                sound.play().catch(e => console.log('ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª:', e));
            }
        }
        
        (function initVoiceChatState() {
            setTimeout(() => {
                updateVoiceChatIcon();
            }, 100);
        })();
        let iceCandidatesQueue = [];
        const ludoGameId = {{ game_id }};
        const myPlayerNumber = {{ 1 if is_player1 else 2 }};
        const isPlayer1 = {{ 'true' if is_player1 else 'false' }};
        
        const VOICE_STATE_KEY = 'ludo_voice_state_' + ludoGameId;
        const VOICE_PERMISSION_KEY = 'ludo_voice_permission_' + ludoGameId;
        
        function saveVoiceState() {
            try {
                const state = {
                    gameId: ludoGameId,
                    isPlayer1: isPlayer1,
                    isMuted: isMuted,
                    hasPermission: localStream !== null,
                    timestamp: Date.now()
                };
                localStorage.setItem(VOICE_STATE_KEY, JSON.stringify(state));
                console.log('ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„ØµÙˆØªÙŠØ©');
            } catch (e) {
                console.warn('âš ï¸ ÙØ´Ù„ Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©:', e);
            }
        }
        
        function loadVoiceState() {
            try {
                const saved = localStorage.getItem(VOICE_STATE_KEY);
                if (saved) {
                    const state = JSON.parse(saved);
                    const age = Date.now() - state.timestamp;
                    if (age < 10 * 60 * 1000) {
                        console.log('ğŸ“‚ ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„ØµÙˆØªÙŠØ©');
                        return state;
                    }
                }
            } catch (e) {
                console.warn('âš ï¸ ÙØ´Ù„ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©:', e);
            }
            return null;
        }
        
        function clearVoiceState() {
            try {
                localStorage.removeItem(VOICE_STATE_KEY);
                console.log('ğŸ—‘ï¸ ØªÙ… Ù…Ø³Ø­ Ø­Ø§Ù„Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„ØµÙˆØªÙŠØ©');
            } catch (e) {
                console.warn('âš ï¸ ÙØ´Ù„ Ù…Ø³Ø­ Ø­Ø§Ù„Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©:', e);
            }
        }
        
        function updateCenterVoiceIcon() {
            updateVoiceChatIcon();
        }
        
        // ÙƒØ´Ù Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø² Ù…Ø­Ù…ÙˆÙ„
        const isMobileWebView = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const isAndroid = /Android/i.test(navigator.userAgent);
        
        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ICE Ù…Ø­Ø³Ù‘Ù†Ø© Ù„Ù„Ù€ Android
        const iceConfiguration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' },
                { urls: 'stun:stun3.l.google.com:19302' },
                { urls: 'stun:stun4.l.google.com:19302' },
                {
                    urls: 'turn:openrelay.metered.ca:80',
                    username: 'openrelayproject',
                    credential: 'openrelayproject'
                },
                {
                    urls: 'turn:openrelay.metered.ca:443',
                    username: 'openrelayproject',
                    credential: 'openrelayproject'
                },
                {
                    urls: 'turn:openrelay.metered.ca:443?transport=tcp',
                    username: 'openrelayproject',
                    credential: 'openrelayproject'
                }
            ],
            iceCandidatePoolSize: isMobileWebView ? 5 : 10,
            iceTransportPolicy: 'all',
            bundlePolicy: 'max-bundle',
            rtcpMuxPolicy: 'require'
        };
        
        async function initializeVoiceChat(isReconnect = false) {
            if (voiceSocket && !isReconnect) {
                console.log('ğŸ”Š Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„ØµÙˆØªÙŠØ© Ù…ÙØ¹Ù„Ø© Ø¨Ø§Ù„ÙØ¹Ù„');
                return;
            }
            
            if (isReconnecting && !isReconnect) {
                console.log('â³ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¬Ø§Ø±ÙŠØ©...');
                return;
            }
            
            // Ù…Ù†Ø¹ Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø© Ø§Ù„Ù…ØªØ²Ø§Ù…Ù†Ø©
            if (voiceChatInitializing) {
                console.log('â³ Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø¬Ø§Ø±ÙŠØ© Ø¨Ø§Ù„ÙØ¹Ù„ - ØªØ¬Ø§Ù‡Ù„');
                return;
            }
            voiceChatInitializing = true;
            
            // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù‚Ø¨Ù„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ‡ÙŠØ¦Ø©
            if (isReconnect) {
                console.log('ğŸ§¹ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©...');
                
                // Ø¥ØºÙ„Ø§Ù‚ peerConnection Ø§Ù„Ù‚Ø¯ÙŠÙ…
                if (peerConnection) {
                    try {
                        peerConnection.close();
                    } catch(e) {}
                    peerConnection = null;
                }
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª ÙˆØ§Ù„ØµÙˆØª
                tracksAddedToPeer = false;
                audioInitialized = false;
                currentRemoteStream = null;
                
                // Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ voiceSocket Ø§Ù„Ù‚Ø¯ÙŠÙ… ÙˆØ¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ†
                if (voiceSocket) {
                    voiceSocket.removeAllListeners();
                    voiceSocket.disconnect();
                    voiceSocket = null;
                }
                
                // Ù…Ø³Ø­ interval Ø§Ù„Ù‚Ø¯ÙŠÙ…
                if (voiceStateInterval) {
                    clearInterval(voiceStateInterval);
                    voiceStateInterval = null;
                }
                
                // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØµÙˆØª Ø§Ù„Ø­Ø§Ù„ÙŠ
                const remoteAudio = document.getElementById('remoteAudio');
                if (remoteAudio) {
                    remoteAudio.pause();
                    remoteAudio.srcObject = null;
                }
            }
            
            try {
                const savedState = loadVoiceState();
                
                if (!localStream) {
                    try {
                        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ stream Ø¨Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø­Ø³Ù‘Ù†Ø©
                        try {
                            // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ØµÙˆØª Ù…Ø¹ Ø¥Ù„ØºØ§Ø¡ ØµØ¯Ù‰ Ù‚ÙˆÙŠ
                            const audioConstraints = {
                                audio: {
                                    echoCancellation: true,
                                    noiseSuppression: true,
                                    autoGainControl: true,
                                    channelCount: 1
                                },
                                video: false
                            };
                            
                            localStream = await navigator.mediaDevices.getUserMedia(audioConstraints);
                            console.log('ğŸ¤ ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¥Ø°Ù† Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†');
                        } catch (err1) {
                            console.log('âš ï¸ ÙØ´Ù„Øª Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© 1ØŒ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ©...');
                            try {
                                localStream = await navigator.mediaDevices.getUserMedia({ 
                                    audio: true,
                                    video: false 
                                });
                                console.log('ğŸ¤ ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¥Ø°Ù† Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ø¨Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ©');
                            } catch (err2) {
                                // Ø¥Ù†Ø´Ø§Ø¡ stream ÙØ§Ø±Øº Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„ØµÙˆØª Ù…Ù† Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±
                                console.log('âš ï¸ ØªÙ… Ø±ÙØ¶ Ø¥Ø°Ù† Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† - Ø¥Ù†Ø´Ø§Ø¡ stream ÙØ§Ø±Øº Ù„Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„');
                                localStream = new MediaStream();
                                console.log('ğŸ“¡ Ø³ÙŠØªÙ… Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„ØµÙˆØª Ù…Ù† Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø± ÙÙ‚Ø·');
                            }
                        }
                    } catch (micError) {
                        console.log('âŒ Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹:', micError.message);
                        // Ø¥Ù†Ø´Ø§Ø¡ stream ÙØ§Ø±Øº ÙƒØ®Ø·Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
                        localStream = new MediaStream();
                        console.log('ğŸ“¡ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ stream ÙØ§Ø±Øº - ÙˆØ¶Ø¹ Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ ÙÙ‚Ø·');
                    }
                } else {
                    console.log('â™»ï¸ Ø§Ø³ØªØ®Ø¯Ø§Ù… stream Ù…ÙˆØ¬ÙˆØ¯');
                }
                
                // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† ÙˆØªØ·Ø¨ÙŠÙ‚Ù‡Ø§ ÙÙˆØ±Ø§Ù‹ Ø¹Ù„Ù‰ tracks
                if (savedState && savedState.isMuted !== undefined) {
                    isMuted = savedState.isMuted;
                    console.log('ğŸ”„ ØªØ·Ø¨ÙŠÙ‚ Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©:', isMuted ? 'Ù…ÙƒØªÙˆÙ…' : 'Ù†Ø´Ø·');
                } else {
                    isMuted = true;
                }
                
                // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ø§Ù„Ø© Ø¹Ù„Ù‰ audio tracks (Ø¥Ù† ÙˆØ¬Ø¯Øª)
                if (localStream && localStream.getTracks().length > 0) {
                    localStream.getAudioTracks().forEach(track => {
                        track.enabled = !isMuted;
                    });
                    
                    // ØªØ­Ø¯ÙŠØ« Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† ÙÙˆØ±Ø§Ù‹
                    updateVoiceChatIcon();
                }
                
                // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… Socket Ù…ÙˆØ¬ÙˆØ¯ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªØµÙ„Ø§Ù‹
                let needNewSocket = false;
                if (!voiceSocket) {
                    needNewSocket = true;
                    console.log('ğŸ”Œ Ø¥Ù†Ø´Ø§Ø¡ Socket Ø¬Ø¯ÙŠØ¯ - Ù„Ø§ ÙŠÙˆØ¬Ø¯ socket');
                } else if (!voiceSocket.connected && isReconnect) {
                    voiceSocket.removeAllListeners();
                    voiceSocket.disconnect();
                    voiceSocket = null;
                    voiceSocketListenersAttached = false;
                    needNewSocket = true;
                    console.log('ğŸ”Œ Ø¥Ù†Ø´Ø§Ø¡ Socket Ø¬Ø¯ÙŠØ¯ - Ø¥Ø¹Ø§Ø¯Ø© Ø§ØªØµØ§Ù„');
                } else if (voiceSocket.connected) {
                    console.log('â™»ï¸ Ø§Ø³ØªØ®Ø¯Ø§Ù… Socket Ù…ÙˆØ¬ÙˆØ¯ ÙˆÙ…ØªØµÙ„');
                    needNewSocket = false;
                } else {
                    needNewSocket = true;
                }
                
                if (needNewSocket) {
                    voiceSocket = io({
                        transports: ['websocket', 'polling'],
                        reconnection: true,
                        reconnectionDelay: 500,
                        reconnectionDelayMax: 5000,
                        reconnectionAttempts: Infinity,
                        autoConnect: true
                    });
                    voiceSocketListenersAttached = false;
                }
                
                // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ† Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·
                if (!voiceSocketListenersAttached) {
                    voiceSocketListenersAttached = true;
                    console.log('ğŸ“¡ ØªØ³Ø¬ÙŠÙ„ Ù…Ø³ØªÙ…Ø¹ÙŠ Socket Ù„Ù„Ù…Ø±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰');
                    
                    voiceSocket.on('connect', () => {
                        console.log(isReconnect ? 'ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù†Ø¬Ø§Ø­' : 'âœ… Socket Ù…ØªØµÙ„');
                        voiceSocket.emit('join_ludo_game', { game_id: ludoGameId });
                        isReconnecting = false;
                        
                        saveVoiceState();
                        
                        if (isPlayer1 && !peerConnection) {
                            console.log('ğŸ¯ Player 1 - Ø¨Ø¯Ø¡ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© ÙÙˆØ±Ø§Ù‹');
                            requestAnimationFrame(() => {
                                if (!peerConnection) {
                                    initiateCall();
                                }
                            });
                        } else if (!isPlayer1 && peerConnection) {
                            console.log('ğŸ”„ Player 2 - Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø¹Ø¯ Ø§Ù„Ø±ÙØ±Ø´');
                            const oldConnection = peerConnection;
                            peerConnection = null;
                            if (oldConnection) {
                                oldConnection.close();
                            }
                        }
                    });
                
                    voiceSocket.on('webrtc_offer', async (data) => {
                    try {
                        console.log('ğŸ“¥ Ø§Ø³ØªÙ„Ø§Ù… Ø¹Ø±Ø¶ WebRTC Ù…Ù† Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø¢Ø®Ø±');
                        
                        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ localStream Ù‚Ø¨Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„
                        if (!localStream || localStream.getAudioTracks().length === 0) {
                            console.log('ğŸ¤ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¥Ø°Ù† Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ù„Ù„Ø§Ø¹Ø¨ 2...');
                            try {
                                localStream = await navigator.mediaDevices.getUserMedia({
                                    audio: {
                                        echoCancellation: true,
                                        noiseSuppression: true,
                                        autoGainControl: true,
                                        channelCount: 1
                                    },
                                    video: false
                                });
                                console.log('âœ… ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ù„Ù„Ø§Ø¹Ø¨ 2');
                            } catch (micErr) {
                                console.log('âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† - ÙˆØ¶Ø¹ Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ ÙÙ‚Ø·');
                                if (!localStream) {
                                    localStream = new MediaStream();
                                }
                            }
                        }
                        
                        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ù‚Ø¨Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§ØªØµØ§Ù„ Ø¬Ø¯ÙŠØ¯
                        tracksAddedToPeer = false;
                        
                        // Ø¥Ù†Ø´Ø§Ø¡ Ø§ØªØµØ§Ù„ Ø¬Ø¯ÙŠØ¯ - createPeerConnection Ø³ÙŠØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„ØªÙ†Ø¸ÙŠÙ ÙˆØ§Ù„Ù…Ø³Ø§Ø±Ø§Øª
                        createPeerConnection();
                        
                        await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
                        
                        for (const candidate of pendingIceCandidates) {
                            await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                        }
                        pendingIceCandidates = [];
                        
                        const answer = await peerConnection.createAnswer();
                        await peerConnection.setLocalDescription(answer);
                        
                        voiceSocket.emit('webrtc_answer', {
                            game_id: ludoGameId,
                            answer: answer
                        });
                        console.log('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯ Ø¨Ù†Ø¬Ø§Ø­ - Player 2');
                    } catch (error) {
                        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¹Ø±Ø¶:', error);
                        retryConnection();
                    }
                });
                
                voiceSocket.on('webrtc_answer', async (data) => {
                    try {
                        if (peerConnection && peerConnection.signalingState !== 'stable') {
                            await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
                            console.log('âœ… ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¯ - Player 1');
                            
                            for (const candidate of pendingIceCandidates) {
                                await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                            }
                            pendingIceCandidates = [];
                        }
                    } catch (error) {
                        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¯:', error);
                    }
                });
                
                voiceSocket.on('webrtc_ice_candidate', async (data) => {
                    try {
                        if (peerConnection && peerConnection.remoteDescription) {
                            await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
                            console.log('âœ… ICE candidate ØªÙ…Øª Ø¥Ø¶Ø§ÙØªÙ‡');
                        } else {
                            pendingIceCandidates.push(data.candidate);
                            console.log('ğŸ“¦ ICE candidate Ù…Ø­ÙÙˆØ¸ Ù„Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹');
                        }
                    } catch (error) {
                        console.error('âŒ Ø®Ø·Ø£ ICE:', error);
                    }
                });
                
                voiceSocket.on('peer_connected', () => {
                    console.log('ğŸ‘¥ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø¢Ø®Ø± Ø§Ù†Ø¶Ù… Ù„Ù„ØºØ±ÙØ©');
                    if (isPlayer1 && !peerConnection) {
                        requestAnimationFrame(() => initiateCall());
                    }
                });
                
                voiceSocket.on('peer_muted', (data) => {
                    console.log('ğŸ”‡ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø¢Ø®Ø± ÙƒØªÙ… Ø§Ù„ØµÙˆØª:', data.muted);
                });
                
                // === Ø¨Ø« Ø§Ù„ØµÙˆØª Ù„Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ† ===
                let viewerConnections = {};
                
                voiceSocket.on('viewer_wants_audio', async (data) => {
                    const viewerSid = data.viewer_sid;
                    const gameId = data.game_id;
                    
                    if (!localStream || localStream.getAudioTracks().length === 0) {
                        console.log('âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØµÙˆØª Ù…Ø­Ù„ÙŠ Ù„Ø¥Ø±Ø³Ø§Ù„Ù‡ Ù„Ù„Ù…Ø´Ø§Ù‡Ø¯');
                        return;
                    }
                    
                    console.log('ğŸ”Š Ù…Ø´Ø§Ù‡Ø¯ Ø·Ù„Ø¨ Ø§Ù„ØµÙˆØª:', viewerSid);
                    
                    try {
                        const viewerPC = new RTCPeerConnection({
                            iceServers: [
                                { urls: 'stun:stun.l.google.com:19302' },
                                { urls: 'stun:stun1.l.google.com:19302' }
                            ]
                        });
                        
                        viewerConnections[viewerSid] = viewerPC;
                        
                        localStream.getAudioTracks().forEach(track => {
                            viewerPC.addTrack(track, localStream);
                        });
                        
                        viewerPC.onicecandidate = (event) => {
                            if (event.candidate) {
                                voiceSocket.emit('player_ice_to_viewer', {
                                    game_id: gameId,
                                    viewer_sid: viewerSid,
                                    candidate: event.candidate,
                                    player_id: isPlayer1 ? 'player1' : 'player2'
                                });
                            }
                        };
                        
                        const offer = await viewerPC.createOffer();
                        await viewerPC.setLocalDescription(offer);
                        
                        voiceSocket.emit('player_audio_offer_to_viewer', {
                            game_id: gameId,
                            viewer_sid: viewerSid,
                            offer: offer,
                            player_id: isPlayer1 ? 'player1' : 'player2'
                        });
                        
                        console.log('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø±Ø¶ ØµÙˆØª Ù„Ù„Ù…Ø´Ø§Ù‡Ø¯');
                    } catch (e) {
                        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ ØµÙˆØª Ù„Ù„Ù…Ø´Ø§Ù‡Ø¯:', e);
                    }
                });
                
                voiceSocket.on('viewer_audio_answer_from_viewer', async (data) => {
                    const viewerSid = data.viewer_sid;
                    const pc = viewerConnections[viewerSid];
                    const myPlayerId = isPlayer1 ? 'player1' : 'player2';
                    
                    if (pc && data.player_id === myPlayerId) {
                        try {
                            await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
                            console.log('âœ… ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯');
                        } catch (e) {
                            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯:', e);
                        }
                    }
                });
                
                voiceSocket.on('viewer_ice_from_viewer', async (data) => {
                    const viewerSid = data.viewer_sid;
                    const pc = viewerConnections[viewerSid];
                    const myPlayerId = isPlayer1 ? 'player1' : 'player2';
                    
                    if (pc && data.candidate && data.player_id === myPlayerId) {
                        try {
                            await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
                        } catch (e) {
                            console.log('Ø®Ø·Ø£ ICE Ù…Ø´Ø§Ù‡Ø¯:', e);
                        }
                    }
                });
                
                } else {
                    // Socket Ù…ÙˆØ¬ÙˆØ¯ - ÙÙ‚Ø· Ø£Ø¹Ø¯ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ØºØ±ÙØ©
                    console.log('â™»ï¸ Socket Ù…ÙˆØ¬ÙˆØ¯ - Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ØºØ±ÙØ©');
                    voiceSocket.emit('join_ludo_game', { game_id: ludoGameId });
                }
                
                updateVoiceStatus('âœ… Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„ØµÙˆØªÙŠØ©', 'connected');
                voiceChatInitializing = false;
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„ØµÙˆØªÙŠØ©:', error.message || error.toString(), error);
                voiceChatInitializing = false;
                
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø¨Ø¹Ø¯ 2 Ø«Ø§Ù†ÙŠØ© ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ÙØ´Ù„
                if (!isReconnect && !isReconnecting) {
                    console.log('ğŸ”„ Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¹Ø¯ 2 Ø«Ø§Ù†ÙŠØ©...');
                    isReconnecting = true;
                    setTimeout(() => {
                        isReconnecting = false;
                        initializeVoiceChat(true);
                    }, 2000);
                }
            }
        }
        
        function retryConnection() {
            if (connectionRetryCount < MAX_RETRIES) {
                connectionRetryCount++;
                console.log(`ğŸ”„ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ ${connectionRetryCount}/${MAX_RETRIES}`);
                
                // ØªÙ†Ø¸ÙŠÙ ÙƒØ§Ù…Ù„
                if (peerConnection) {
                    try {
                        peerConnection.close();
                    } catch (e) {
                        console.log('âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø¥ØºÙ„Ø§Ù‚ connection:', e);
                    }
                    peerConnection = null;
                }
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª ÙˆØ§Ù„ØµÙˆØª
                tracksAddedToPeer = false;
                audioInitialized = false;
                currentRemoteStream = null;
                
                // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØµÙˆØª Ø§Ù„Ø­Ø§Ù„ÙŠ
                const remoteAudio = document.getElementById('remoteAudio');
                if (remoteAudio && remoteAudio.srcObject) {
                    remoteAudio.pause();
                    remoteAudio.srcObject = null;
                }
                
                // Ù„Ø§ Ù†ÙˆÙ‚Ù Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© - Ù†Ø­ØªÙØ¸ Ø¨Ù‡Ø§ Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„
                // ÙÙ‚Ø· Ù†Ø¹ÙŠØ¯ ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø¶Ø§ÙØ©
                
                // Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
                setTimeout(() => {
                    if (isPlayer1) {
                        console.log('ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ - Player 1');
                        initiateCall();
                    }
                }, 1000 + (connectionRetryCount * 500));
            } else {
                console.error('âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø¹Ø¯ Ø¹Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø§Øª');
                updateVoiceStatus('âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„ØµÙˆØªÙŠ', 'disconnected');
            }
        }
        
        function createPeerConnection() {
            if (peerConnection && peerConnection.connectionState !== 'closed' && peerConnection.connectionState !== 'failed') {
                console.log('âš ï¸ PeerConnection Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙˆØªØ¹Ù…Ù„');
                return;
            }
            
            // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¥Ù† ÙˆØ¬Ø¯
            if (peerConnection) {
                try {
                    peerConnection.close();
                } catch(e) {}
                peerConnection = null;
            }
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª
            tracksAddedToPeer = false;
            
            console.log('ğŸ”§ Ø¥Ù†Ø´Ø§Ø¡ PeerConnection Ø¬Ø¯ÙŠØ¯');
            try {
                peerConnection = new RTCPeerConnection(iceConfiguration);
                console.log('âœ… RTCPeerConnection ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡ Ø¨Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø©');
            } catch (err) {
                console.log('âš ï¸ ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ RTCPeerConnection Ø¨Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø©ØŒ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø¨Ø³Ø·Ø©...');
                try {
                    const simplifiedConfig = {
                        iceServers: [
                            { urls: 'stun:stun.l.google.com:19302' },
                            { urls: 'stun:stun1.l.google.com:19302' }
                        ]
                    };
                    peerConnection = new RTCPeerConnection(simplifiedConfig);
                    console.log('âœ… RTCPeerConnection ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡ Ø¨Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø¨Ø³Ø·Ø©');
                } catch (err2) {
                    console.error('âŒ ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ RTCPeerConnection ØªÙ…Ø§Ù…Ø§Ù‹:', err2);
                    throw err2;
                }
            }
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·
            if (localStream && localStream.getAudioTracks().length > 0 && !tracksAddedToPeer) {
                localStream.getAudioTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                    console.log('â• ØªÙ… Ø¥Ø¶Ø§ÙØ© track Ù„Ù„Ø§ØªØµØ§Ù„');
                });
                tracksAddedToPeer = true;
            } else if (!localStream || localStream.getTracks().length === 0) {
                console.log('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³Ø§Ø±Ø§Øª Ù…Ø­Ù„ÙŠØ© - ÙˆØ¶Ø¹ Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ ÙÙ‚Ø·');
            }
            
            peerConnection.ontrack = (event) => {
                console.log('ğŸµ Ø§Ø³ØªÙ„Ø§Ù… audio track Ù…Ù† Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø¢Ø®Ø±');
                const remoteAudio = document.getElementById('remoteAudio');
                if (remoteAudio && event.streams && event.streams.length > 0) {
                    const newStream = event.streams[0];
                    const newStreamId = newStream.id;
                    
                    console.log('ğŸ”Š Ù…Ø¹Ø§Ù„Ø¬Ø© stream Ø¬Ø¯ÙŠØ¯:', newStreamId);
                    
                    try {
                        // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù…Ø¨Ø§Ø´Ø±Ø©
                        currentRemoteStream = newStreamId;
                        remoteAudio.srcObject = newStream;
                        remoteAudio.volume = 1.0;
                        remoteAudio.muted = false;
                        
                        // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª
                        const playPromise = remoteAudio.play();
                        if (playPromise !== undefined) {
                            playPromise
                                .then(() => {
                                    console.log('âœ… Ø§Ù„ØµÙˆØª ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¢Ù†! Ù…Ø¹Ø±Ù:', newStreamId);
                                    updateVoiceStatus('ğŸ”Š Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„ØµÙˆØªÙŠØ© Ù…ØªØµÙ„Ø©', 'connected');
                                    connectionRetryCount = 0;
                                    audioInitialized = true;
                                })
                                .catch(e => {
                                    console.log('âš ï¸ Ø®Ø·Ø£ ØªØ´ØºÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ:', e.message);
                                    // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ´ØºÙŠÙ„ Ø¨Ø¹Ø¯ ØªÙØ§Ø¹Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                                    document.addEventListener('click', function playOnClick() {
                                        remoteAudio.play().then(() => {
                                            console.log('âœ… Ø§Ù„ØµÙˆØª ÙŠØ¹Ù…Ù„ Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ù‚Ø±');
                                            audioInitialized = true;
                                        }).catch(() => {});
                                        document.removeEventListener('click', playOnClick);
                                    }, { once: true });
                                });
                        }
                    } catch (trackError) {
                        console.error('âŒ Ø®Ø·Ø£ Ù…Ø¹Ø§Ù„Ø¬Ø© track:', trackError);
                    }
                }
            };
            
            peerConnection.onicecandidate = (event) => {
                if (event.candidate && voiceSocket) {
                    voiceSocket.emit('webrtc_ice_candidate', {
                        game_id: ludoGameId,
                        candidate: event.candidate
                    });
                    console.log('ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ ICE candidate');
                }
            };
            
            peerConnection.onconnectionstatechange = () => {
                console.log('ğŸ”„ Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„:', peerConnection.connectionState);
                
                if (peerConnection.connectionState === 'connected') {
                    console.log('âœ… WebRTC Ù…ØªØµÙ„ Ø¨Ù†Ø¬Ø§Ø­!');
                    updateVoiceStatus('ğŸ”Š Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„ØµÙˆØªÙŠØ© Ù…ØªØµÙ„Ø©', 'connected');
                    connectionRetryCount = 0;
                    isReconnecting = false;
                    saveVoiceState();
                } else if (peerConnection.connectionState === 'failed' || peerConnection.connectionState === 'disconnected') {
                    console.log('âš ï¸ ÙØ´Ù„ Ø£Ùˆ Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ - Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ±Ø¬Ø§Ø¹...');
                    retryConnection();
                } else if (peerConnection.connectionState === 'connecting') {
                    console.log('â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...');
                    updateVoiceStatus('â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...', 'disconnected');
                } else if (peerConnection.connectionState === 'failed') {
                    console.error('âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ - Ù…Ø­Ø§ÙˆÙ„Ø© ICE restart');
                    updateVoiceStatus('ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§ØªØµØ§Ù„...', 'disconnected');
                    
                    if (!isReconnecting && connectionRetryCount < MAX_RETRIES) {
                        isReconnecting = true;
                        connectionRetryCount++;
                        
                        if (reconnectTimeout) {
                            clearTimeout(reconnectTimeout);
                        }
                        
                        reconnectTimeout = setTimeout(async () => {
                            try {
                                if (peerConnection && isPlayer1) {
                                    console.log('ğŸ”„ Ù…Ø­Ø§ÙˆÙ„Ø© ICE restart');
                                    const offer = await peerConnection.createOffer({ iceRestart: true });
                                    await peerConnection.setLocalDescription(offer);
                                    voiceSocket.emit('webrtc_offer', {
                                        game_id: ludoGameId,
                                        offer: offer
                                    });
                                } else {
                                    peerConnection.close();
                                    peerConnection = null;
                                    retryConnection();
                                }
                            } catch (e) {
                                console.error('âŒ ÙØ´Ù„ ICE restart:', e);
                                peerConnection.close();
                                peerConnection = null;
                                retryConnection();
                            }
                        }, 100);
                    } else {
                        peerConnection.close();
                        peerConnection = null;
                        retryConnection();
                    }
                } else if (peerConnection.connectionState === 'disconnected') {
                    console.warn('âš ï¸ Ø§Ù†Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ - Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø©...');
                    updateVoiceStatus('ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„...', 'disconnected');
                    
                    if (!isReconnecting) {
                        isReconnecting = true;
                        if (reconnectTimeout) {
                            clearTimeout(reconnectTimeout);
                        }
                        reconnectTimeout = setTimeout(() => {
                            if (peerConnection && peerConnection.connectionState === 'disconnected') {
                                console.log('ğŸ”„ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø¹Ø¯ Ø§Ù†Ù‚Ø·Ø§Ø¹ ÙÙˆØ±Ø§Ù‹');
                                peerConnection.close();
                                peerConnection = null;
                                isReconnecting = false;
                                if (isPlayer1) {
                                    requestAnimationFrame(() => initiateCall());
                                }
                            }
                        }, 500);
                    }
                }
            };
            
            peerConnection.onicegatheringstatechange = () => {
                console.log('ğŸ§Š ICE gathering state:', peerConnection.iceGatheringState);
                if (peerConnection.iceGatheringState === 'complete') {
                    console.log('âœ… ICE candidates Ø¬Ø§Ù‡Ø²Ø©');
                }
            };
            
            peerConnection.oniceconnectionstatechange = () => {
                console.log('ğŸ§Š ICE connection state:', peerConnection.iceConnectionState);
            };
        }
        
        function updateVoiceStatus(message, className) {
            const statusDiv = document.getElementById('voiceStatus');
            if (statusDiv) {
                statusDiv.className = 'voice-status show';
            }
        }
        
        let offerInProgress = false;
        
        async function initiateCall() {
            if (!localStream) {
                console.log('âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ stream Ù…Ø­Ù„ÙŠ');
                return;
            }
            
            if (offerInProgress) {
                console.log('â³ Ø¹Ø±Ø¶ Ø¬Ø§Ø±ÙŠ Ø¨Ø§Ù„ÙØ¹Ù„...');
                return;
            }
            
            try {
                offerInProgress = true;
                console.log('ğŸ“ Ø¨Ø¯Ø¡ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© Ø§Ù„ØµÙˆØªÙŠØ©');
                createPeerConnection();
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                voiceSocket.emit('webrtc_offer', {
                    game_id: ludoGameId,
                    offer: offer
                });
            } catch (err) {
                console.error('âŒ ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ø±Ø¶:', err);
            } finally {
                offerInProgress = false;
            }
        }
        
        function toggleMute(player) {
            toggleVoiceChat();
        }
        
        // Ø¶Ù…Ø§Ù† Ø¹Ù…Ù„ Ø§Ù„ØµÙˆØª ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© ÙˆØ¹Ù†Ø¯ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø©
        document.addEventListener('visibilitychange', async function() {
            if (document.hidden) {
                console.log('ğŸ“± Ø§Ù„ØµÙØ­Ø© ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© - Ø§Ù„ØµÙˆØª ÙŠØ¹Ù…Ù„ ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©');
                // Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø®Ù„ÙÙŠØ©
                saveVoiceState();
            } else {
                console.log('ğŸ“± Ø§Ù„ØµÙØ­Ø© Ù†Ø´Ø·Ø© - Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø­Ø§Ù„Ø©...');
                
                // Ø§Ù†ØªØ¸Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„Ø¥Ø¹Ø·Ø§Ø¡ Ø§Ù„Ø¬Ù‡Ø§Ø² ÙˆÙ‚ØªØ§Ù‹ Ù„Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©
                await new Promise(resolve => setTimeout(resolve, 300));
                
                try {
                    await restoreGameStateFromServer();
                    console.log('âœ… ØªÙ…Øª Ù…Ø²Ø§Ù…Ù†Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¨Ø¹Ø¯ Ø¹ÙˆØ¯Ø© Ø§Ù„ØµÙØ­Ø©');
                    
                    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒØ§Ù…Ù„Ø© Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø²Ø± Ø¨Ø¹Ø¯ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø§Ù„Ø©
                    buttonHideLock = false;
                    isRolling = false;
                    animationInProgress = false;
                    rollRequestPending = false;
                    if (buttonHideLockTimeout) {
                        clearTimeout(buttonHideLockTimeout);
                        buttonHideLockTimeout = null;
                    }
                    lastButtonState = null;
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø²Ø± Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
                    updateRollButtonDisplay();
                    console.log('ğŸ”„ ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„Ø²Ø± Ø¨Ø¹Ø¯ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø§Ù„Ø©');
                } catch (error) {
                    console.error('âŒ ÙØ´Ù„ ÙÙŠ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ø¹Ø¯ Ø¹ÙˆØ¯Ø© Ø§Ù„ØµÙØ­Ø©:', error);
                }
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„ØµÙˆØªÙŠ (Ù„Ø§ Ù†Ø¹ÙŠØ¯ Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† ÙÙŠ Ø­Ø§Ù„Ø© connecting Ø£Ùˆ checking)
                if (localStream) {
                    const state = peerConnection?.connectionState;
                    
                    // ÙÙ‚Ø· Ù†Ø¹ÙŠØ¯ Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ù†ÙØµÙ„ Ø£Ùˆ ÙØ§Ø´Ù„ Ø£Ùˆ Ù…ØºÙ„Ù‚
                    if (!peerConnection || state === 'disconnected' || state === 'failed' || state === 'closed') {
                        console.log('ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„ØµÙˆØªÙŠ... (Ø­Ø§Ù„Ø©:', state || 'ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', ')');
                        initializeVoiceChat(true);
                    } else {
                        console.log('âœ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„ØµÙˆØªÙŠ Ù„Ø§ ÙŠØ²Ø§Ù„ Ù†Ø´Ø·Ø§Ù‹:', state);
                        // Ù„Ø§ Ù†Ø¹ÙŠØ¯ Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† ÙÙŠ Ø­Ø§Ù„Ø© connecting Ø£Ùˆ checking
                    }
                }
            }
        });
        
        // Ø­ÙØ¸ Ø¯ÙˆØ±ÙŠ Ù„Ù„Ø­Ø§Ù„Ø© ÙƒÙ„ 3 Ø«ÙˆØ§Ù†ÙŠ (Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±)
        if (voiceStateInterval) {
            clearInterval(voiceStateInterval);
        }
        voiceStateInterval = setInterval(() => {
            if (localStream) {
                saveVoiceState();
            }
        }, 3000);
        
        // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¹Ù†Ø¯ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© (pageshow event)
        window.addEventListener('pageshow', (event) => {
            if (event.persisted) {
                console.log('ğŸ”„ Ø§Ù„ØµÙØ­Ø© ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯ØªÙ‡Ø§ Ù…Ù† bfcache - Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙˆØª...');
                setTimeout(() => {
                    initializeVoiceChat(true);
                }, 200);
            }
        });
        
        // ØªÙ†Ø¸ÙŠÙ Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø© Ø£Ùˆ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù…Ù†Ù‡Ø§
        window.addEventListener('beforeunload', () => {
            console.log('ğŸ§¹ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ù‚Ø¨Ù„ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø©...');
            
            // Ù…Ø³Ø­ interval
            if (voiceStateInterval) {
                clearInterval(voiceStateInterval);
                voiceStateInterval = null;
            }
            
            // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª
            if (peerConnection) {
                peerConnection.close();
            }
            
            if (voiceSocket) {
                voiceSocket.disconnect();
            }
        });
        
        // ØªÙ‡ÙŠØ¦Ø© ÙÙˆØ±ÙŠØ© Ù„Ù„ØµÙˆØª Ø¨Ø¯ÙˆÙ† Ø£ÙŠ ØªØ£Ø®ÙŠØ±
        console.log('ğŸš€ Ø¨Ø¯Ø¡ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„ØµÙˆØªÙŠØ© ÙÙˆØ±Ø§Ù‹...');
        const savedState = loadVoiceState();
        
        // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ù…Ù† localStorage
        if (savedState && savedState.isMuted !== undefined) {
            isMuted = savedState.isMuted;
            console.log('ğŸ¤ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†:', isMuted ? 'Ù…ÙƒØªÙˆÙ…' : 'Ù†Ø´Ø·');
            
            // ØªØ­Ø¯ÙŠØ« Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† ÙÙˆØ±Ø§Ù‹
            updateVoiceChatIcon();
        }
        
        // ØªÙ‡ÙŠØ¦Ø© ÙÙˆØ±ÙŠØ© Ø¨Ø¯ÙˆÙ† setTimeout
        if (savedState && savedState.hasPermission) {
            console.log('âœ… Ø¥Ø°Ù† Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ù…ÙˆØ¬ÙˆØ¯ - ØªÙ‡ÙŠØ¦Ø© ÙÙˆØ±ÙŠØ©');
            initializeVoiceChat(true);
        } else {
            console.log('âš¡ ØªÙ‡ÙŠØ¦Ø© Ø£ÙˆÙ„ÙŠØ© Ù„Ù„ØµÙˆØª');
            initializeVoiceChat();
        }
        
        // ============= Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± =============
        let isStreaming = {{ 'true' if is_streaming else 'false' }};
        let streamViewerCount = {{ stream_viewer_count|default(0) }};
        
        // ØªÙ‡ÙŠØ¦Ø© Ø­Ø§Ù„Ø© Ø²Ø± Ø§Ù„Ø¨Ø« Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        (function initStreamState() {
            if (isStreaming) {
                const streamBtn = document.getElementById('streamBtn');
                const streamBtnText = document.getElementById('streamBtnText');
                const liveDot = streamBtn ? streamBtn.querySelector('.live-dot') : null;
                const viewerCountDiv = document.getElementById('streamViewerCount');
                
                if (streamBtn) {
                    streamBtn.classList.add('streaming');
                }
                if (liveDot) {
                    liveDot.style.display = 'block';
                }
                if (streamBtnText) {
                    streamBtnText.textContent = 'ğŸ”´ Ù…Ø¨Ø§Ø´Ø±';
                }
                if (viewerCountDiv) {
                    viewerCountDiv.classList.add('show');
                    viewerCountDiv.textContent = 'ğŸ‘¤ ' + streamViewerCount;
                }
                console.log('ğŸ“º ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø« Ø§Ù„Ù†Ø´Ø·');
            }
        })();
        
        function toggleStream() {
            const streamBtn = document.getElementById('streamBtn');
            const streamBtnText = document.getElementById('streamBtnText');
            const liveDot = streamBtn.querySelector('.live-dot');
            const viewerCountDiv = document.getElementById('streamViewerCount');
            
            if (!isStreaming) {
                socket.emit('start_ludo_stream', {
                    game_id: gameId,
                    user_id: {{ user_id }}
                });
            } else {
                socket.emit('stop_ludo_stream', {
                    game_id: gameId,
                    user_id: {{ user_id }}
                });
            }
        }
        
        socket.on('stream_started', (data) => {
            console.log('ğŸ“º Ø¨Ø¯Ø£ Ø§Ù„Ø¨Ø«:', data);
            isStreaming = true;
            const streamBtn = document.getElementById('streamBtn');
            const streamBtnText = document.getElementById('streamBtnText');
            const liveDot = streamBtn.querySelector('.live-dot');
            const viewerCountDiv = document.getElementById('streamViewerCount');
            
            streamBtn.classList.add('streaming');
            liveDot.style.display = 'block';
            streamBtnText.textContent = 'ğŸ”´ Ù…Ø¨Ø§Ø´Ø±';
            viewerCountDiv.classList.add('show');
            viewerCountDiv.textContent = 'ğŸ‘¤ ' + (data.viewer_count || 0);
        });
        
        socket.on('stream_stopped', (data) => {
            console.log('â¹ï¸ ØªÙˆÙ‚Ù Ø§Ù„Ø¨Ø«:', data);
            isStreaming = false;
            const streamBtn = document.getElementById('streamBtn');
            const streamBtnText = document.getElementById('streamBtnText');
            const liveDot = streamBtn.querySelector('.live-dot');
            const viewerCountDiv = document.getElementById('streamViewerCount');
            
            streamBtn.classList.remove('streaming');
            liveDot.style.display = 'none';
            streamBtnText.textContent = 'ğŸ“º Ø¨Ø«';
            viewerCountDiv.classList.remove('show');
        });
        
        socket.on('stream_error', (data) => {
            console.log('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø«:', data);
            showStreamNotification(data.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø«', 'error');
        });
        
        function showStreamNotification(message, type = 'info') {
            let existingNotif = document.getElementById('streamNotification');
            if (existingNotif) existingNotif.remove();
            
            let notif = document.createElement('div');
            notif.id = 'streamNotification';
            let bgColor = type === 'error' ? 'linear-gradient(135deg, #e11d48, #be123c)' : 'linear-gradient(135deg, #10b981, #059669)';
            let icon = type === 'error' ? 'âŒ' : 'âœ…';
            notif.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: ${bgColor};
                color: white;
                padding: 15px 25px;
                border-radius: 12px;
                font-size: 16px;
                font-weight: bold;
                z-index: 99999;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                display: flex;
                align-items: center;
                gap: 10px;
                opacity: 1;
                transition: opacity 0.3s ease, transform 0.3s ease;
            `;
            notif.innerHTML = `<span style="font-size: 20px;">${icon}</span> ${message}`;
            document.body.appendChild(notif);
            
            window.setTimeout(function() {
                let el = document.getElementById('streamNotification');
                if (el) {
                    el.style.opacity = '0';
                    el.style.transform = 'translateX(-50%) translateY(-20px)';
                    window.setTimeout(function() {
                        let el2 = document.getElementById('streamNotification');
                        if (el2) el2.remove();
                    }, 300);
                }
            }, 3000);
        }
        
        socket.on('stream_viewer_update', (data) => {
            if (data.game_id === gameId) {
                streamViewerCount = data.viewer_count;
                const viewerCountDiv = document.getElementById('streamViewerCount');
                viewerCountDiv.textContent = 'ğŸ‘¤ ' + data.viewer_count;
            }
        });
        
        socket.on('watcher_joined', (data) => {
            console.log('ğŸ¥ Ù…Ø´Ø§Ù‡Ø¯ Ø¬Ø¯ÙŠØ¯:', data);
        });
        
        let ludoActiveGiftNotifications = [];
        const LUDO_MAX_VISIBLE_GIFTS = 5;
        const GIFT_DISPLAY_DURATION = 5000;
        
        socket.on('stream_gift_received', function(data) {
            handleLudoGiftReceived(data);
        });
        
        // ØªØ£Ø«ÙŠØ± Ù‡Ø¯ÙŠØ© Ø§Ù„Ø·Ø§Ø¦Ø±Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ Ù…Ø«Ù„ ØªÙŠÙƒ ØªÙˆÙƒ
        function showPlaneGiftAnimation(senderName) {
            // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ø¨Ù‚Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
            const overlay = document.createElement('div');
            overlay.className = 'plane-gift-overlay';
            overlay.id = 'planeGiftOverlay';
            document.body.appendChild(overlay);
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ø§Ø¦Ø±Ø©
            const plane = document.createElement('div');
            plane.className = 'flying-plane';
            plane.textContent = 'âœˆï¸';
            overlay.appendChild(plane);
            
            // Ø¥Ø¶Ø§ÙØ© Ø£Ø«Ø± Ø§Ù„Ø·Ø§Ø¦Ø±Ø© ÙˆØ§Ù„Ø´Ø±Ø§Ø±Ø§Øª Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø·ÙŠØ±Ø§Ù†
            let trailInterval = setInterval(() => {
                const planeRect = plane.getBoundingClientRect();
                if (planeRect.left > window.innerWidth) {
                    clearInterval(trailInterval);
                    return;
                }
                
                // Ø£Ø«Ø± Ø§Ù„Ø¯Ø®Ø§Ù†
                const trail = document.createElement('div');
                trail.className = 'plane-trail';
                trail.style.left = (planeRect.left - 100) + 'px';
                trail.style.top = (planeRect.top + 40) + 'px';
                overlay.appendChild(trail);
                setTimeout(() => trail.remove(), 500);
                
                // Ø´Ø±Ø§Ø±Ø§Øª Ø°Ù‡Ø¨ÙŠØ©
                for (let i = 0; i < 3; i++) {
                    const sparkle = document.createElement('div');
                    sparkle.className = 'plane-sparkle';
                    sparkle.style.left = (planeRect.left - 20 + Math.random() * 40) + 'px';
                    sparkle.style.top = (planeRect.top + 20 + Math.random() * 40) + 'px';
                    overlay.appendChild(sparkle);
                    setTimeout(() => sparkle.remove(), 800);
                }
            }, 100);
            
            // Ù†Øµ Ø§Ù„Ù‡Ø¯ÙŠØ© ÙÙŠ Ø§Ù„Ù…Ù†ØªØµÙ
            const giftText = document.createElement('div');
            giftText.className = 'plane-gift-text';
            giftText.innerHTML = `âœˆï¸ ${senderName} Ø£Ø±Ø³Ù„ Ø·Ø§Ø¦Ø±Ø©! âœˆï¸`;
            overlay.appendChild(giftText);
            
            // Ù‚ØµØ§ØµØ§Øª Ù…Ù„ÙˆÙ†Ø© Ø¹Ù†Ø¯ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…Ù†ØªØµÙ
            setTimeout(() => {
                const colors = ['#ffd700', '#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#ff69b4', '#87ceeb'];
                for (let i = 0; i < 30; i++) {
                    const confetti = document.createElement('div');
                    confetti.className = 'plane-confetti';
                    confetti.style.left = (30 + Math.random() * 40) + '%';
                    confetti.style.top = (20 + Math.random() * 20) + '%';
                    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.animationDelay = (Math.random() * 0.5) + 's';
                    confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '2px';
                    overlay.appendChild(confetti);
                }
            }, 1500);
            
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ£Ø«ÙŠØ± Ø¨Ø¹Ø¯ 4 Ø«ÙˆØ§Ù†ÙŠ
            setTimeout(() => {
                clearInterval(trailInterval);
                overlay.style.opacity = '0';
                overlay.style.transition = 'opacity 0.5s';
                setTimeout(() => overlay.remove(), 500);
            }, 4000);
        }
        
        function handleLudoGiftReceived(data) {
            const displayArea = document.getElementById('ludo-gift-display-area');
            if (!displayArea) return;
            
            // ØªØ£Ø«ÙŠØ± Ø®Ø§Øµ Ù„Ù‡Ø¯ÙŠØ© Ø§Ù„Ø·Ø§Ø¦Ø±Ø©
            if (data.gift_id === 'plane') {
                showPlaneGiftAnimation(data.sender_name);
            }
            
            const senderKey = `${data.sender_id}_${data.gift_id}`;
            const existingNotif = displayArea.querySelector(`.gift-notification[data-sender-key="${senderKey}"]`);
            
            if (existingNotif && !existingNotif.classList.contains('hiding')) {
                let counter = existingNotif.querySelector('.gift-counter');
                if (counter) {
                    let count = parseInt(counter.textContent.replace('+', '')) || 1;
                    count++;
                    counter.textContent = '+' + count;
                    counter.classList.remove('gift-counter-pulse');
                    void counter.offsetWidth;
                    counter.classList.add('gift-counter-pulse');
                } else {
                    counter = document.createElement('span');
                    counter.className = 'gift-counter gift-counter-pulse';
                    counter.textContent = '+2';
                    existingNotif.appendChild(counter);
                }
                clearTimeout(existingNotif._hideTimeout);
                existingNotif._hideTimeout = setTimeout(() => hideLudoGiftNotification(existingNotif), GIFT_DISPLAY_DURATION);
                return;
            }
            
            while (ludoActiveGiftNotifications.length >= LUDO_MAX_VISIBLE_GIFTS) {
                const oldest = ludoActiveGiftNotifications.shift();
                if (oldest && oldest.parentNode) {
                    clearTimeout(oldest._hideTimeout);
                    oldest.classList.add('hiding');
                    setTimeout(() => { if (oldest.parentNode) oldest.remove(); }, 300);
                }
            }
            
            const notif = document.createElement('div');
            notif.className = 'gift-notification';
            notif.setAttribute('data-sender-key', senderKey);
            notif.innerHTML = `
                <span class="gift-sender">${data.sender_name}</span>
                <span class="gift-action">Ø§Ø±Ø³Ù„</span>
                <span class="gift-icon">${data.gift_emoji}</span>
            `;
            
            displayArea.appendChild(notif);
            ludoActiveGiftNotifications.push(notif);
            
            notif._hideTimeout = setTimeout(() => hideLudoGiftNotification(notif), GIFT_DISPLAY_DURATION);
        }
        
        function hideLudoGiftNotification(notif) {
            if (!notif || !notif.parentNode) return;
            notif.classList.add('hiding');
            const idx = ludoActiveGiftNotifications.indexOf(notif);
            if (idx > -1) ludoActiveGiftNotifications.splice(idx, 1);
            setTimeout(() => { if (notif.parentNode) notif.remove(); }, 300);
        }
        
        socket.on('stream_message_received', function(data) {
            handleLudoStreamMessage(data);
        });
        
        let ludoActiveStreamMessages = [];
        
        function handleLudoStreamMessage(data) {
            const displayArea = document.getElementById('ludo-message-display-area');
            if (!displayArea) return;
            
            while (ludoActiveStreamMessages.length >= 6) {
                const oldest = ludoActiveStreamMessages.shift();
                if (oldest && oldest.parentNode) {
                    oldest.classList.add('hiding');
                    setTimeout(() => { if (oldest.parentNode) oldest.remove(); }, 300);
                }
            }
            
            const msgEl = document.createElement('div');
            msgEl.className = 'stream-message';
            msgEl.innerHTML = `<span class="msg-text">${data.message}</span> <span class="msg-sender">${data.sender_name}</span>`;
            
            displayArea.appendChild(msgEl);
            ludoActiveStreamMessages.push(msgEl);
            
            // Ø§Ø®ØªÙØ§Ø¡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†ÙŠ
            setTimeout(() => {
                if (msgEl && msgEl.parentNode) {
                    msgEl.classList.add('hiding');
                    const idx = ludoActiveStreamMessages.indexOf(msgEl);
                    if (idx > -1) ludoActiveStreamMessages.splice(idx, 1);
                    setTimeout(() => { if (msgEl.parentNode) msgEl.remove(); }, 300);
                }
            }, 5000);
        }
    </script>
    
    <div class="modal-overlay" id="resultModal">
        <div class="modal-content">
            <div class="winner-emoji" id="resultEmoji"></div>
            <div class="modal-title" id="resultTitle"></div>
            <div class="modal-message" id="resultMessage"></div>
        </div>
    </div>
    
    <div class="exit-countdown-modal" id="exitCountdownModal">
        <div class="exit-countdown-content">
            <div class="exit-countdown-title">Ø¬Ø§Ø±ÙŠ Ø¥Ø®Ø±Ø§Ø¬Ùƒ Ù…Ù† Ø§Ù„Ù„Ø¹Ø¨Ø©</div>
            <div class="exit-countdown-number" id="exitCountdownNumber">4</div>
        </div>
    </div>
    
    <div class="warning-overlay" id="warningOverlay">
        <div class="warning-modal">
            <div class="warning-icon">âš ï¸</div>
            <div class="warning-title">ØªØ­Ø°ÙŠØ±</div>
            <div class="warning-message">ÙÙŠ Ø­Ø§Ù„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ù„Ø¹Ø¨Ø© Ø³ØªØ®Ø³Ø± Ù‚ÙŠÙ…Ø© Ø§Ù„Ø±Ù‡Ø§Ù†!</div>
            <div class="warning-buttons">
                <button class="warning-btn warning-btn-exit" onclick="confirmExitGame()">Ø®Ø±ÙˆØ¬</button>
                <button class="warning-btn warning-btn-stay" onclick="closeWarningGame()">Ø§Ù„Ø¨Ù‚Ø§Ø¡</button>
            </div>
        </div>
    </div>
    
    <div id="ludo-message-display-area" class="stream-message-display-area"></div>
    <div id="ludo-gift-display-area" class="gift-display-area"></div>
</body>
</html>
'''




DEPOSIT_PAGE = DASHBOARD_PAGE.replace('{% block page_content %}{% endblock %}', '''
{% block page_content %}
    <div class="deposit-withdraw-nav">
        <a href="{{ url_for('deposit_page') }}" class="deposit-withdraw-btn active">ğŸ’³ Ø´Ø­Ù† Ø§Ù„Ø­Ø³Ø§Ø¨</a>
        <a href="{{ url_for('withdraw_page') }}" class="deposit-withdraw-btn">ğŸ’° Ø³Ø­Ø¨ Ø±ØµÙŠØ¯</a>
    </div>
    
    <h1>ğŸ’³ Ø´Ø­Ù† Ø§Ù„Ø­Ø³Ø§Ø¨</h1>
    
    <div style="background: #e8f4f8; border-right: 4px solid #00bcd4; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
        <h3 style="color: #00bcd4; margin-bottom: 15px;">ğŸ¯ Ø·Ø±ÙŠÙ‚Ø©  Ø´Ø­Ù† Ù…Ù† BNB Ù…Ø¨Ø§Ø´Ø±!</h3>
        <p style="margin-bottom: 10px;"><strong>âœ… Ø§Ù„Ø®Ø·ÙˆØ§Øª:</strong></p>
        <ol style="margin-right: 20px; color: #333;">
            <li>Ø§Ù†Ø³Ø® Ø¹Ù†ÙˆØ§Ù† Ù…Ø­ÙØ¸ØªÙ†Ø§ Ù…Ù† Ø§Ù„Ø£Ø³ÙÙ„</li>
            <li>Ø¥Ø¯Ø®Ù„ Ø§Ù„Ù‰ Ø§ÙŠ Ù…Ù†ØµØ© ØªØ¯Ø¹Ù… BNB Smart Chain . BSC</li>
            <li>Ø§Ù„ØµÙ‚ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ£Ø±Ø³Ù„ Ø§Ù„Ù…Ø¨Ù„Øº</li>
            <li>Ø§Ù†Ø³Ø® Ù…Ø¹Ø±Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ÙˆØ¶Ø¹Ù‡ ÙÙŠ Ø§Ù„Ø­Ù‚Ù„ Ø£Ø³ÙÙ„Ù‡</li>
            <li>Ø§Ø¶ØºØ· ØªØ­Ù‚Ù‚ - Ø³ÙŠØªÙ… Ø´Ø­Ù†Ùƒ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹!</li>
        </ol>
    </div>
    
    <div style="background: #fff3cd; border: 2px dashed #ffc107; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
        <h3 style="color: #ff6f00; margin-bottom: 15px;">ğŸ“ Ø¹Ù†ÙˆØ§Ù† Ù…Ø­ÙØ¸ØªÙ†Ø§ BNB:</h3>
        <div style="background: white; padding: 15px; border-radius: 6px; word-break: break-all; font-family: monospace; font-size: 14px; user-select: all;">
            {{ bnb_wallet }}
        </div>
        <button id="copyBtn" onclick="copyToClipboard('{{ bnb_wallet }}')" style="margin-top: 10px; padding: 10px 20px; background: #ffc107; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">ğŸ“‹ Ø§Ù†Ø³Ø® Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</button>
    </div>
    
    <div style="background: #f0f8ff; border-left: 4px solid #2196f3; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
        <h3 style="color: #2196f3; margin-bottom: 15px;">ğŸ” Ø£Ø¯Ø®Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ©:</h3>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <input type="text" id="txHash" placeholder="Ø£Ø¯Ø®Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ©" style="flex: 1; min-width: 250px; padding: 12px; border: 2px solid #2196f3; border-radius: 6px; font-size: 14px;">
            <button onclick="verifyTransaction()" style="padding: 12px 30px; background: #2196f3; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">âœ… ØªØ­Ù‚Ù‚</button>
        </div>
        <div id="verifyMessage" style="margin-top: 15px; padding: 15px; border-radius: 6px; display: none;"></div>
    </div>
    
    <div class="upload-section">
        <h2 style="color: #667eea; margin-bottom: 20px;">ğŸ“¤ Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©: Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹</h2>
        
        <div style="background: linear-gradient(135deg, #e8f4fd 0%, #f0e6ff 100%); border: 2px solid #667eea; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
            <h3 style="color: #667eea; margin-bottom: 15px; font-size: 18px;">ğŸ“‹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹:</h3>
            <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                <p style="font-size: 16px; margin: 8px 0; color: #333;">ğŸ’³ <strong>Ø¨Ø§ÙŠÙŠØ±:</strong> <span style="color: #667eea; font-weight: bold; font-size: 18px;">P1069518585</span></p>
                <p style="font-size: 16px; margin: 8px 0; color: #333;">ğŸ’ <strong>Ø¨Ø§ÙŠÙ†Ø§Ù†Ø³:</strong> <span style="color: #f0b90b; font-weight: bold; font-size: 18px;">474900045</span></p>
            </div>
            <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 12px; margin-top: 10px;">
                <p style="color: #856404; margin: 0; font-size: 14px;">âš ï¸ <strong>Ø¨Ø¹Ø¯ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº ÙˆÙŠØ´ØªØ±Ø· Ø£Ù† ÙŠÙƒÙˆÙ† Ø£ÙƒØ«Ø± Ù…Ù† 0.30 Ø¯ÙˆÙ„Ø§Ø±</strong></p>
                <p style="color: #856404; margin: 5px 0 0 0; font-size: 14px;">Ø¨Ø¹Ø¯Ù‡Ø§ Ù…Ø¨Ø§Ø´Ø±Ø© Ù‚Ù… Ø¨Ø¥Ø±Ø³Ø§Ù„ ØµÙˆØ±Ø© Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹</p>
            </div>
        </div>
        
        <p style="color: #666; margin-bottom: 15px;">Ù‚Ù… Ø¨ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø© ÙˆØ§Ø¶Ø­Ø© Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹</p>
        <form id="depositForm" enctype="multipart/form-data">
            <input type="file" id="depositPhoto" name="photo" accept="image/*" required>
            <button id="depositBtn" type="button" class="btn" onclick="submitDepositForm()">Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø´Ø­Ù†</button>
        </form>
        <div id="depositMessage" style="margin-top: 15px; padding: 15px; border-radius: 6px; display: none;"></div>
    </div>
    
    <!-- Ø±Ø³Ø§Ù„Ø© Ù…Ù†ØªØµÙ Ø§Ù„Ø´Ø§Ø´Ø© -->
    <div id="depositAlert" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border: 3px solid #ff6b6b; border-radius: 15px; padding: 30px; z-index: 10000; text-align: center; max-width: 400px; box-shadow: 0 10px 50px rgba(0, 0, 0, 0.4);">
        <div style="font-size: 48px; margin-bottom: 15px;">âš ï¸</div>
        <h3 style="color: #ff6b6b; margin: 0 0 15px 0; font-size: 20px;">Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨ Ù…Ø±ØªÙŠÙ†</h3>
        <p style="color: #666; margin: 0; font-size: 16px;">Ø§Ù†ØªØ¸Ø± Ø­ØªÙ‰ ÙŠØªÙ… Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ</p>
        <button onclick="closeDepositAlert()" style="margin-top: 20px; padding: 10px 25px; background: #ff6b6b; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">Ø­Ø³Ù†Ù†Ø§</button>
    </div>
    
    <!-- Ø®Ù„ÙÙŠØ© Ø´ÙØ§ÙØ© Ù„Ù„Ù€ alert -->
    <div id="depositAlertOverlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 9999;"></div>
    
    <h2 style="margin-top: 40px;">ğŸ“Š Ø¹Ù…Ù„ÙŠØ§Øª BNB Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</h2>
    {% if bnb_transactions %}
    <table>
        <tr>
            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
            <th>Ù…Ø¹Ø±Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th>
            <th>Ø§Ù„Ù…Ø¨Ù„Øº (BNB)</th>
            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
        </tr>
        {% for tx in bnb_transactions %}
        <tr>
            <td>{{ tx['created_at'][:10] }}</td>
            <td style="font-family: monospace; font-size: 12px; direction: ltr;">{{ tx['tx_hash'][:16] }}...</td>
            <td>{{ "%.6f"|format(tx['amount']) }} BNB</td>
            <td>
                {% if tx['status'] == 'confirmed' %}
                <span class="badge badge-approved" style="background: #4caf50; color: white; padding: 5px 10px; border-radius: 4px;">âœ… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚</span>
                {% else %}
                <span class="badge badge-pending" style="background: #ff9800; color: white; padding: 5px 10px; border-radius: 4px;">â³ Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ù‚Ù‚</span>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </table>
    {% else %}
    <p style="text-align: center; color: #666; padding: 40px; font-size: 18px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª BNB Ø³Ø§Ø¨Ù‚Ø©</p>
    {% endif %}
    
    <h2 style="margin-top: 40px;">ğŸ“‹ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø­Ù† Ø¨Ø§Ù„ØµÙˆØ± Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</h2>
    {% if deposits %}
    <table>
        <tr>
            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
            <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
        </tr>
        {% for deposit in deposits %}
        <tr>
            <td>{{ deposit['created_at'] }}</td>
            <td>{{ "%.2f"|format(deposit['amount']) if deposit['amount'] else 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©' }} $</td>
            <td>
                {% if deposit['status'] == 'pending' %}
                <span class="badge badge-pending">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</span>
                {% elif deposit['status'] == 'approved' %}
                <span class="badge badge-approved">ØªÙ… Ø§Ù„Ù‚Ø¨ÙˆÙ„</span>
                {% else %}
                <span class="badge badge-rejected">Ù…Ø±ÙÙˆØ¶</span>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </table>
    {% else %}
    <p style="text-align: center; color: #666; padding: 40px; font-size: 18px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø´Ø­Ù† Ø³Ø§Ø¨Ù‚Ø©</p>
    {% endif %}
    
    <script>
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                const btn = document.getElementById('copyBtn');
                const originalText = btn.textContent;
                btn.textContent = 'âœ… ØªÙ… Ù†Ø³Ø®';
                btn.style.background = '#4caf50';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '#ffc107';
                }, 2000);
            });
        }
        
        
        async function verifyTransaction() {
            const txHash = document.getElementById('txHash').value.trim();
            const msgDiv = document.getElementById('verifyMessage');
            
            if (!txHash) {
                msgDiv.style.display = 'block';
                msgDiv.style.background = '#ffebee';
                msgDiv.style.color = '#c62828';
                msgDiv.textContent = 'âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ©';
                return;
            }
            
            msgDiv.textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...';
            msgDiv.style.background = '#e3f2fd';
            msgDiv.style.color = '#1565c0';
            msgDiv.style.display = 'block';
            
            try {
                const response = await fetch('{{ url_for("verify_bnb_deposit") }}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tx_hash: txHash })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    msgDiv.style.background = '#e8f5e9';
                    msgDiv.style.color = '#2e7d32';
                    msgDiv.textContent = `âœ… ${data.message}`;
                    document.getElementById('txHash').value = '';
                    setTimeout(() => location.reload(), 2000);
                } else {
                    msgDiv.style.background = '#ffebee';
                    msgDiv.style.color = '#c62828';
                    msgDiv.textContent = `âŒ ${data.message}`;
                }
            } catch (err) {
                msgDiv.style.background = '#ffebee';
                msgDiv.style.color = '#c62828';
                msgDiv.textContent = `âŒ Ø®Ø·Ø£: ${err.message}`;
            }
        }
        
        document.getElementById('txHash').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') verifyTransaction();
        });
    </script>
{% endblock %}
''')

WITHDRAW_PAGE = DASHBOARD_PAGE.replace('{% block page_content %}{% endblock %}', '''
{% block page_content %}
    <div class="deposit-withdraw-nav">
        <a href="{{ url_for('deposit_page') }}" class="deposit-withdraw-btn">ğŸ’³ Ø´Ø­Ù† Ø§Ù„Ø­Ø³Ø§Ø¨</a>
        <a href="{{ url_for('withdraw_page') }}" class="deposit-withdraw-btn active">ğŸ’° Ø³Ø­Ø¨ Ø±ØµÙŠØ¯</a>
    </div>
    
    <h1>ğŸ’° Ø³Ø­Ø¨ Ø§Ù„Ø±ØµÙŠØ¯</h1>
    
    <div class="note" style="margin-bottom: 25px;">
        Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø³Ø­Ø¨: 1.00 $
    </div>
    
    {% if has_pending_withdrawal %}
    <div style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 25px; text-align: center;">
        <div style="font-size: 40px; margin-bottom: 10px;">â³</div>
        <h3 style="margin: 0 0 10px 0;">Ù„Ø¯ÙŠÙƒ Ø·Ù„Ø¨ Ø³Ø­Ø¨ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</h3>
        <p style="margin: 0; opacity: 0.9;">Ø§Ù„Ù…Ø¨Ù„Øº: {{ "%.2f"|format(pending_withdrawal['amount']) }} $</p>
        <p style="margin: 5px 0 0 0; font-size: 13px; opacity: 0.8;">ÙŠØ±Ø¬Ù‰ Ø§Ù†ØªØ¸Ø§Ø± Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</p>
    </div>
    {% else %}
    <form method="POST" action="{{ url_for('submit_withdrawal') }}" id="withdrawal-form">
        <div class="form-group">
            <label>Ø§Ù„Ù…Ø¨Ù„Øº ($)</label>
            <input type="number" name="amount" step="0.01" min="1" required>
        </div>
        
        <div class="form-group">
            <label>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø³Ø­Ø¨</label>
            <select name="method" required>
                <option value="payeer">Payeer</option>
                <option value="binance">Binance</option>
            </select>
        </div>
        
        <div class="form-group">
            <label>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨</label>
            <input type="text" name="account_info" required placeholder="Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ Ø£Ùˆ Ø§Ù„Ù…Ø­ÙØ¸Ø©">
        </div>
        
        <button type="submit" class="btn" id="withdraw-btn">Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨</button>
    </form>
    {% endif %}
    
    <h2 style="margin-top: 40px;">ğŸ“‹ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</h2>
    {% if withdrawals %}
    <table>
        <tr>
            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
            <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
            <th>Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©</th>
            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
        </tr>
        {% for withdrawal in withdrawals %}
        <tr>
            <td>{{ withdrawal['created_at'] }}</td>
            <td>{{ "%.2f"|format(withdrawal['amount']) }} $</td>
            <td>{{ withdrawal['method'] }}</td>
            <td>
                {% if withdrawal['status'] == 'pending' %}
                <span class="badge badge-pending">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</span>
                {% elif withdrawal['status'] == 'approved' %}
                <span class="badge badge-approved">Ù…ÙƒØªÙ…Ù„</span>
                {% else %}
                <span class="badge badge-rejected">Ù…Ø±ÙÙˆØ¶</span>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </table>
    {% else %}
    <p style="text-align: center; color: #666; padding: 40px; font-size: 18px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø³Ø­Ø¨ Ø³Ø§Ø¨Ù‚Ø©</p>
    {% endif %}
{% endblock %}
''')

PROFILE_PAGE = DASHBOARD_PAGE.replace('{% block page_content %}{% endblock %}', '''
{% block page_content %}
    <h1 style="margin-top: 30px;">ğŸ‘¤ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h1>
    
    <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 30px;">
        <p style="margin-bottom: 10px;"><strong>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</strong> {{ user['username'] }}</p>
        <p style="margin-bottom: 10px;"><strong>Ø§Ù„Ø±ØµÙŠØ¯:</strong> {{ "%.2f"|format(user['balance']) }} $</p>
        <p style="margin-bottom: 10px;"><strong>Ø§Ù„ØªØ­Ø°ÙŠØ±Ø§Øª:</strong> {{ user['warnings'] }}</p>
        <p><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„:</strong> {{ user['created_at'] }}</p>
    </div>
    
    <h2>ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h2>
    <form method="POST" action="{{ url_for('change_username') }}">
        <div class="form-group">
            <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯</label>
            <input type="text" name="new_username" required minlength="3" maxlength="15" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯">
            <div class="note">ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙƒÙ„ 30 ÙŠÙˆÙ…</div>
        </div>
        
        <button type="submit" class="btn">ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù…</button>
    </form>
    
    <div style="margin-top: 60px; padding-top: 30px; border-top: 2px solid #e0e0e0; text-align: center;">
        <form method="GET" action="{{ url_for('logout') }}" style="display: inline;">
            <button type="submit" class="btn" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); padding: 12px 30px; font-size: 16px;">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
        </form>
    </div>
{% endblock %}
''')

NOTIFICATIONS_PAGE = DASHBOARD_PAGE.replace('{% block page_content %}{% endblock %}', '''
{% block page_content %}
    <style>
        .notifications-tabs {
            display: flex;
            gap: 8px;
            margin-top: 50px;
            margin-bottom: 25px;
            flex-wrap: nowrap;
            justify-content: center;
            white-space: nowrap;
        }
        .notifications-tab-btn {
            padding: 10px 16px;
            background: linear-gradient(135deg, #e0e0e0 0%, #c0c0c0 100%);
            color: #555;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }
        .notifications-tab-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .notifications-tab-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        .notifications-tab-content {
            display: none;
            animation: fadeInTab 0.3s ease;
        }
        .notifications-tab-content.active {
            display: block;
        }
        @keyframes fadeInTab {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .messages-container, .support-container {
            max-width: 800px;
            text-align: center;
            padding: 60px 40px;
        }
        .coming-soon-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }
        .coming-soon-text {
            color: #666;
            font-size: 18px;
            margin-bottom: 10px;
        }
        .coming-soon-subtext {
            color: #999;
            font-size: 14px;
        }
    </style>
    
    <div class="notifications-tabs" id="page-notifications-tabs">
        <button class="notifications-tab-btn active" onclick="showPageNotificationsTab('page-notif', this)">ğŸ”” Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</button>
        <button class="notifications-tab-btn" onclick="showPageNotificationsTab('page-messages', this)" style="position: relative;">ğŸ’¬ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„<span id="page-messages-badge" style="position: absolute; top: -8px; right: -8px; background: #dc3545; color: white; border-radius: 50%; min-width: 20px; height: 20px; font-size: 11px; font-weight: bold; display: none; align-items: center; justify-content: center; padding: 0 4px;">0</span></button>
        <button class="notifications-tab-btn" onclick="showPageNotificationsTab('page-support', this)">ğŸ§ Ø§Ù„Ø¯Ø¹Ù…</button>
    </div>
    
    <div id="page-notif-tab-content" class="notifications-tab-content active">
        {% if notifications %}
        <div style="max-width: 800px;">
            {% for notification in notifications %}
            <div style="background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); border-left: 5px solid #28a745; padding: 16px; margin-bottom: 12px; border-radius: 8px; box-shadow: 0 2px 8px rgba(40, 167, 69, 0.2);">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div style="flex: 1;">
                        <p style="color: #155724; margin: 0; font-weight: 500; font-size: 15px;">âœ… {{ notification['message'] }}</p>
                        <p style="color: #0c5460; margin-top: 8px; font-size: 12px;">{{ notification['created_at'] }}</p>
                    </div>
                    {% if notification['is_read'] == 0 %}
                    <span style="background: #28a745; color: white; padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: bold;">Ø¬Ø¯ÙŠØ¯</span>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p style="text-align: center; color: #666; padding: 60px 40px; font-size: 18px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</p>
        {% endif %}
    </div>
    
    <div id="page-messages-tab-content" class="notifications-tab-content">
        <div id="page-messages-container" style="max-width: 800px;">
            <p style="text-align: center; color: #666; padding: 60px 40px; font-size: 18px;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„...</p>
        </div>
    </div>
    
    <div id="page-support-tab-content" class="notifications-tab-content">
        <div class="support-container" style="max-width: 800px; margin: 0 auto;">
            <h3 style="text-align: center; color: #333; margin-bottom: 20px;">ğŸ§ Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©</h3>
            
            <div class="support-category-tabs" style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-bottom: 20px;">
                <button class="support-cat-btn" onclick="showPageSupportCategory('page-withdrawal', this)" style="padding: 12px 20px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; border-radius: 25px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">ğŸ’¸ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø³Ø­Ø¨</button>
                <button class="support-cat-btn" onclick="showPageSupportCategory('page-deposit', this)" style="padding: 12px 20px; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white; border: none; border-radius: 25px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">ğŸ’³ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø´Ø­Ù†</button>
                <button class="support-cat-btn" onclick="showPageSupportCategory('page-cheat', this)" style="padding: 12px 20px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none; border-radius: 25px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">ğŸš« Ø´ÙƒÙˆÙ‰ Ø¶Ø¯ Ø§Ù„ØºØ´</button>
                <button class="support-cat-btn" onclick="showPageSupportCategory('page-other', this)" style="padding: 12px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 25px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">ğŸ“ Ø´ÙŠØ¡ Ø¢Ø®Ø±</button>
            </div>
            
            <div id="page-withdrawal-form" class="support-form-section" style="display: none;">
                <div style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); border: 2px solid #ef4444; border-radius: 15px; padding: 20px;">
                    <h4 style="color: #dc2626; margin-bottom: 15px;">ğŸ’¸ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø³Ø­Ø¨</h4>
                    <textarea id="page-withdrawal-message" placeholder="Ø§ÙƒØªØ¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ù‡Ù†Ø§..." style="width: 100%; height: 120px; padding: 12px; border: 1px solid #fca5a5; border-radius: 10px; font-size: 14px; resize: vertical;"></textarea>
                    <button onclick="submitPageSupportTicket('withdrawal', 'page-withdrawal-message')" style="margin-top: 15px; width: 100%; padding: 14px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer;">ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„</button>
                </div>
            </div>
            
            <div id="page-deposit-form" class="support-form-section" style="display: none;">
                <div style="background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); border: 2px solid #22c55e; border-radius: 15px; padding: 20px;">
                    <h4 style="color: #16a34a; margin-bottom: 15px;">ğŸ’³ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø´Ø­Ù†</h4>
                    <textarea id="page-deposit-message" placeholder="Ø§ÙƒØªØ¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ù‡Ù†Ø§..." style="width: 100%; height: 120px; padding: 12px; border: 1px solid #86efac; border-radius: 10px; font-size: 14px; resize: vertical;"></textarea>
                    <button onclick="submitPageSupportTicket('deposit', 'page-deposit-message')" style="margin-top: 15px; width: 100%; padding: 14px; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer;">ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„</button>
                </div>
            </div>
            
            <div id="page-cheat-form" class="support-form-section" style="display: none;">
                <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #f59e0b; border-radius: 15px; padding: 20px;">
                    <h4 style="color: #d97706; margin-bottom: 15px;">ğŸš« Ø´ÙƒÙˆÙ‰ Ø¶Ø¯ Ø§Ù„ØºØ´</h4>
                    <textarea id="page-cheat-message" placeholder="Ø§ÙƒØªØ¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø´ÙƒÙˆÙ‰ ÙˆØ§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ù…Ø´ÙƒÙˆÙƒ Ø¨Ù‡..." style="width: 100%; height: 120px; padding: 12px; border: 1px solid #fcd34d; border-radius: 10px; font-size: 14px; resize: vertical;"></textarea>
                    <button onclick="submitPageSupportTicket('cheat', 'page-cheat-message')" style="margin-top: 15px; width: 100%; padding: 14px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer;">ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„</button>
                </div>
            </div>
            
            <div id="page-other-form" class="support-form-section" style="display: none;">
                <div style="background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); border: 2px solid #667eea; border-radius: 15px; padding: 20px;">
                    <h4 style="color: #764ba2; margin-bottom: 15px;">ğŸ“ Ø´ÙŠØ¡ Ø¢Ø®Ø±</h4>
                    <textarea id="page-other-message" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..." style="width: 100%; height: 120px; padding: 12px; border: 1px solid #a5b4fc; border-radius: 10px; font-size: 14px; resize: vertical;"></textarea>
                    <button onclick="submitPageSupportTicket('other', 'page-other-message')" style="margin-top: 15px; width: 100%; padding: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer;">ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        function showPageNotificationsTab(tabName, btn) {
            var container = document.getElementById('page-notifications-tabs').parentElement;
            container.querySelectorAll('.notifications-tab-content').forEach(el => el.classList.remove('active'));
            container.querySelectorAll('.notifications-tab-btn').forEach(el => el.classList.remove('active'));
            
            document.getElementById(tabName + '-tab-content').classList.add('active');
            btn.classList.add('active');
            
            if (tabName === 'page-messages') {
                loadPageAdminMessages();
            }
        }
        
        function loadPageAdminMessages() {
            fetch('/api/admin-messages')
                .then(response => response.json())
                .then(data => {
                    var container = document.getElementById('page-messages-container');
                    if (data.messages && data.messages.length > 0) {
                        var html = '';
                        data.messages.forEach(msg => {
                            var readClass = msg.is_read ? 'read' : 'unread';
                            html += '<div class="message-item ' + readClass + '" style="background: ' + (msg.is_read ? '#f8f9fa' : 'linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%)') + '; border: 2px solid ' + (msg.is_read ? '#e0e0e0' : '#4caf50') + '; border-radius: 15px; padding: 15px; margin-bottom: 15px; cursor: pointer;" onclick="markPageMessageRead(' + msg.id + ', this)">';
                            html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">';
                            html += '<span style="font-weight: bold; color: #333;">ğŸ“© Ø±Ø¯ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</span>';
                            html += '<span style="font-size: 12px; color: #666;">' + msg.date + '</span>';
                            html += '</div>';
                            html += '<p style="color: #444; line-height: 1.6; margin: 0; white-space: pre-wrap;">' + msg.message + '</p>';
                            if (!msg.is_read) {
                                html += '<span style="display: inline-block; margin-top: 10px; background: #4caf50; color: white; padding: 3px 10px; border-radius: 10px; font-size: 11px;">Ø¬Ø¯ÙŠØ¯</span>';
                            }
                            html += '</div>';
                        });
                        container.innerHTML = html;
                    } else {
                        container.innerHTML = '<div style="text-align: center; padding: 60px 40px;"><div style="font-size: 64px; margin-bottom: 20px;">ğŸ“­</div><p style="color: #666; font-size: 18px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø­Ø§Ù„ÙŠØ§Ù‹</p><p style="color: #999; font-size: 14px;">Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ Ø±Ø¯ÙˆØ¯ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø¹Ù„Ù‰ Ø´ÙƒØ§ÙˆØ§Ùƒ</p></div>';
                    }
                })
                .catch(error => {
                    console.error('Error loading messages:', error);
                });
        }
        
        function markPageMessageRead(msgId, element) {
            fetch('/api/mark-message-read', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({message_id: msgId})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    element.style.background = '#f8f9fa';
                    element.style.border = '2px solid #e0e0e0';
                    var newBadge = element.querySelector('span[style*="background: #4caf50"]');
                    if (newBadge) newBadge.remove();
                    updatePageMessagesBadge();
                }
            });
        }
        
        function updatePageMessagesBadge() {
            fetch('/api/unread-messages-count')
                .then(response => response.json())
                .then(data => {
                    var badge = document.getElementById('page-messages-badge');
                    if (badge) {
                        if (data.count > 0) {
                            badge.style.display = 'flex';
                            badge.textContent = data.count > 9 ? '+9' : data.count;
                        } else {
                            badge.style.display = 'none';
                        }
                    }
                });
        }
        
        updatePageMessagesBadge();
        setInterval(updatePageMessagesBadge, 10000);
        
        function showPageSupportCategory(category, btn) {
            document.querySelectorAll('#page-support-tab-content .support-form-section').forEach(el => {
                el.style.display = 'none';
            });
            document.querySelectorAll('#page-support-tab-content .support-cat-btn').forEach(el => {
                el.style.opacity = '0.6';
                el.style.transform = 'scale(0.95)';
            });
            
            document.getElementById(category + '-form').style.display = 'block';
            btn.style.opacity = '1';
            btn.style.transform = 'scale(1.05)';
        }
        
        function submitPageSupportTicket(category, textareaId) {
            var message = document.getElementById(textareaId).value.trim();
            if (!message) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø±Ø³Ø§Ù„ØªÙƒ Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }
            
            fetch('/api/support/submit', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({category: category, message: message})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­! Ø³ÙŠØªÙ… Ø§Ù„Ø±Ø¯ Ø¹Ù„ÙŠÙƒ Ù‚Ø±ÙŠØ¨Ø§Ù‹');
                    document.getElementById(textareaId).value = '';
                } else {
                    alert(data.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„');
                }
            })
            .catch(error => {
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
            });
        }
    </script>
{% endblock %}
''')

ADMIN_PAGE = '''<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</title>
    <style>
        /* Ø¨Ø¯ÙˆÙ† ÙˆÙ…ÙŠØ¶ - Ù†Ø¸Ø§Ù… SPA ÙŠØ­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ù„ÙÙŠØ© */
        /* Ø¨Ø¯ÙˆÙ† ÙˆÙ…ÙŠØ¶ - Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø£ØµÙ„ÙŠØ© ØªØ¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ù…Ø´Ø§ÙƒÙ„ */
        /* Ø¨Ø¯ÙˆÙ† ÙˆÙ…ÙŠØ¶ - Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø£ØµÙ„ÙŠØ© ØªØ¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ù…Ø´Ø§ÙƒÙ„ */
    </style>
    <style>
        /* Ø¨Ø¯ÙˆÙ† ÙˆÙ…ÙŠØ¶ - Ù†Ø¸Ø§Ù… SPA ÙŠØ­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ù„ÙÙŠØ© */
        /* Ø¨Ø¯ÙˆÙ† ÙˆÙ…ÙŠØ¶ - Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø£ØµÙ„ÙŠØ© ØªØ¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ù…Ø´Ø§ÙƒÙ„ */
        /* Ø¨Ø¯ÙˆÙ† ÙˆÙ…ÙŠØ¶ - Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø£ØµÙ„ÙŠØ© ØªØ¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ù…Ø´Ø§ÙƒÙ„ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) fixed;
            min-height: 100vh;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: transparent;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 20px;
            padding: 0;
            max-width: 1400px;
            margin: 0 auto;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .admin-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .admin-header h1 { margin: 0; font-size: 32px; }
        .navbar {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
            overflow-x: auto;
            min-height: 140px;
            align-items: center;
            padding: 0;
            width: 100%;
        }
        .nav-btn {
            flex: 1;
            padding: 45px 40px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            white-space: nowrap;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 120px;
        }
        .nav-btn:hover { background: #f0f0f0; }
        .nav-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: white;
        }
        .content {
            padding: 40px;
            min-height: 500px;
        }
        .page {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        .page.active { display: block; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        .stat-value { font-size: 28px; font-weight: bold; margin-bottom: 5px; }
        .stat-label { font-size: 13px; opacity: 0.9; }
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .card h2 { margin-bottom: 20px; color: #667eea; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; text-align: right; border-bottom: 1px solid #e0e0e0; }
        th { background: #f5f5f5; font-weight: 600; }
        tr:hover { background: #f9f9f9; }
        .btn {
            padding: 8px 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            margin: 2px;
        }
        .btn-success { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .btn-danger { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        .btn:hover { opacity: 0.9; }
        .image-preview { max-width: 150px; max-height: 150px; cursor: pointer; border-radius: 6px; }
        input, textarea {
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            margin-left: 10px;
            font-family: inherit;
        }
        textarea { width: 100%; margin: 10px 0; }
        .form-group { margin-bottom: 15px; }
        .form-group label { font-weight: 600; display: inline-block; min-width: 120px; }
        .alert { padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; background: #d1ecf1; color: #0c5460; border: 1px solid #0c5460; }
        .footer {
            padding: 20px;
            text-align: center;
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
        }
        .logout-btn { color: #dc3545; text-decoration: none; font-weight: 600; cursor: pointer; background: none; border: none; font-size: 14px; }
        .logout-btn:hover { text-decoration: underline; }
        
        .deposit-reports {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(75px, 1fr));
            gap: 8px;
            margin-bottom: 20px;
        }
        .report-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 9px;
            border: none;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
        .report-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        .pagination-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .pagination-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .pagination-btn:hover:not(:disabled) {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .pagination-info {
            font-weight: 600;
            color: #667eea;
            font-size: 13px;
            min-width: 100px;
            text-align: center;
        }
        .deposits-button-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .deposits-action-btn {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        .deposits-action-btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        .badge {
            display: inline-block;
            background: #ff6b6b;
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            margin-left: 8px;
            font-weight: 700;
        }
        .reports-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .reports-modal-overlay.active {
            display: flex;
        }
        .reports-modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.3);
        }
        .reports-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 15px;
        }
        .reports-modal-header h2 { margin: 0; color: #667eea; font-size: 22px; }
        .reports-modal-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 30px;
            height: 30px;
        }
        .reports-modal-close:hover { color: #333; }
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-overlay.active {
            display: flex;
        }
        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.3);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 15px;
        }
        .modal-header h2 { margin: 0; color: #667eea; font-size: 22px; }
        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-close:hover { color: #333; }
        .info-row {
            display: flex;
            margin-bottom: 20px;
            flex-direction: column;
        }
        .info-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 14px;
        }
        .info-value {
            color: #666;
            font-size: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            word-break: break-all;
        }
        .modal-image {
            width: 100%;
            max-width: 300px;
            height: auto;
            border-radius: 8px;
            margin: 15px auto;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        .modal-image:hover { transform: scale(1.05); }
        .image-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1001;
            justify-content: center;
            align-items: center;
        }
        .image-modal.active {
            display: flex;
        }
        .image-modal img {
            max-width: 90%;
            max-height: 90%;
            border-radius: 8px;
        }
        .modal-actions {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 25px;
            border-top: 2px solid #e0e0e0;
            padding-top: 20px;
        }
        .action-group {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        .action-group input {
            flex: 1;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }
        .action-group button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .btn-approve-modal {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }
        .btn-approve-modal:hover { opacity: 0.9; }
        .btn-reject-modal {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: white;
        }
        .btn-reject-modal:hover { opacity: 0.9; }
        
        .add-balance-section {
            display: none;
        }
        .add-balance-section.active {
            display: block;
            animation: slideDown 0.3s ease;
        }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .search-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .search-container input {
            flex: 1;
            padding: 12px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 15px;
        }
        .search-container button {
            padding: 12px 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .search-container button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        .search-result {
            display: none;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .search-result.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        .search-result.error {
            background: #fee;
            border: 2px solid #fa709a;
            text-align: center;
            color: #c33;
            font-weight: 600;
        }
        .user-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        .user-info-item {
            display: flex;
            flex-direction: column;
        }
        .user-info-item label {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
            font-size: 14px;
        }
        .user-info-item span {
            color: #666;
            font-size: 15px;
            padding: 8px;
            background: white;
            border-radius: 6px;
        }
        .balance-input-group {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        .balance-input-group input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
        }
        .balance-input-group button {
            padding: 12px 25px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .balance-input-group button:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        @media (max-width: 768px) {
            body { padding: 10px; }
            .container { border-radius: 10px; }
            .admin-header { padding: 20px; }
            .admin-header h1 { font-size: 24px; }
            .navbar { flex-wrap: wrap; min-height: 115px; padding: 0; width: 100%; }
            .nav-btn { flex: 1 1 48%; padding: 35px 25px; font-size: 12px; min-width: 100px; }
            .content { padding: 15px; min-height: 300px; }
            .stats { grid-template-columns: 1fr; gap: 10px; }
            .stat-value { font-size: 24px; }
            .stat-label { font-size: 12px; }
            .card { padding: 15px; margin-bottom: 15px; }
            .card h2 { font-size: 18px; margin-bottom: 15px; }
            table { font-size: 12px; }
            th, td { padding: 8px; }
            .btn { padding: 6px 10px; font-size: 11px; margin: 2px 1px; }
            .image-preview { max-width: 100px; max-height: 100px; }
            input, textarea { padding: 6px; font-size: 14px; margin-left: 5px; }
            .form-group label { display: block; min-width: auto; margin-bottom: 5px; }
            .footer { padding: 15px; }
        }
        
        @media (max-width: 480px) {
            body { padding: 5px; }
            .admin-header { padding: 15px; }
            .admin-header h1 { font-size: 20px; }
            .navbar { overflow-x: auto; min-height: 110px; padding: 0; width: 100%; }
            .nav-btn { flex: 0 0 45%; padding: 32px 20px; font-size: 11px; white-space: normal; min-width: 90px; }
            .content { padding: 10px; }
            .card { padding: 12px; }
            .card h2 { font-size: 16px; }
            table { font-size: 11px; }
            th, td { padding: 6px; }
            .btn { padding: 5px 8px; font-size: 10px; margin: 1px; }
            .image-preview { max-width: 80px; max-height: 80px; }
            input { width: 100% !important; margin-left: 0 !important; margin-top: 5px; }
            textarea { margin: 5px 0 !important; font-size: 13px; }
            .form-group { margin-bottom: 10px; }
            .form-group label { font-size: 14px; }
            .alert { padding: 10px; font-size: 12px; }
            
            table { display: block; overflow-x: auto; white-space: nowrap; }
            tbody { display: block; }
            tr { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #e0e0e0; }
            th { background: #667eea; color: white; }
            td { flex: 1; text-align: center; }
        }
    </style>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body>
    
    <div class="container">
        <div class="admin-header">
            <h1>ğŸ›¡ï¸ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h1>
        </div>
        
        <div class="navbar">
            <button class="nav-btn active" onclick="switchPage('dashboard')">ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
            <button class="nav-btn" onclick="switchPage('deposits')">ğŸ’³ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø­Ù†</button>
            <button class="nav-btn" onclick="switchPage('withdrawals')">ğŸ’° Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨</button>
            <button class="nav-btn" onclick="switchPage('users')">ğŸ‘¥ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†</button>
            <button class="nav-btn" onclick="switchPage('settings')">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
            <button class="nav-btn" onclick="switchPage('support')">ğŸ§ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯Ø¹Ù…</button>
            <button class="nav-btn" onclick="switchPage('review')">ğŸ” Ù‚Ø³Ù… Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</button>
        </div>
        
        <div class="content">
            {% with messages = get_flashed_messages() %}
            {% if messages %}
                {% for message in messages %}
                <div class="alert">{{ message }}</div>
                {% endfor %}
            {% endif %}
            {% endwith %}
            
            <!-- ØµÙØ­Ø© Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… -->
            <div id="dashboard" class="page active">
                <h2 style="margin-bottom: 20px; color: #667eea;">ğŸ“Š Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©</h2>
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-value" id="pendingDepositsCount">{{ pending_deposits }}</div>
                        <div class="stat-label">Ø·Ù„Ø¨Ø§Øª Ø´Ø­Ù†</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="pendingWithdrawalsCount">{{ pending_withdrawals }}</div>
                        <div class="stat-label">Ø·Ù„Ø¨Ø§Øª Ø³Ø­Ø¨</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalUsersCount">{{ total_users }}</div>
                        <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</div>
                    </div>
                </div>
            </div>
            
            <!-- ØµÙØ­Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø­Ù† -->
            <div id="deposits" class="page">
                <div class="card">
                    <div class="deposits-button-group">
                        <button type="button" class="deposits-action-btn" onclick="toggleReportsSection()">ğŸ’³ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø­Ù† Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© <span class="badge">{{ deposits|length }}</span></button>
                        <button type="button" class="deposits-action-btn" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);" onclick="toggleAddBalance()">ğŸ’¸ Ø¥Ø¶Ø§ÙØ© Ø±ØµÙŠØ¯ Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…</button>
                    </div>
                </div>
                
                <div id="reportsSection" class="card" style="display: none; margin-top: 20px;">
                    <h2 style="margin-bottom: 20px; color: #667eea;">ğŸ“‹ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø­Ù† Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©</h2>
                    <div id="depositReportsContainer" class="deposit-reports"></div>
                    <div id="paginationContainer" class="pagination-container" style="display: none; margin-top: 20px;">
                        <button type="button" class="pagination-btn" id="prevBtn" onclick="goToPreviousPage()">â—€ï¸ Ø±Ø¬ÙˆØ¹</button>
                        <div class="pagination-info">
                            <span id="pageInfo">Ø§Ù„ØµÙØ­Ø© 1</span>
                        </div>
                        <button type="button" class="pagination-btn" id="nextBtn" onclick="goToNextPage()">Ø§Ù„ØªØ§Ù„ÙŠ â–¶ï¸</button>
                    </div>
                </div>
                    
                    <div id="addBalanceSection" class="add-balance-section">
                        <div class="search-container">
                            <input type="text" id="searchUsername" placeholder="Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" onkeypress="if(event.key==='Enter') searchUser()">
                            <button type="button" onclick="searchUser()">ğŸ” Ø¨Ø­Ø«</button>
                        </div>
                        
                        <div id="searchErrorMessage" style="display: none; background: #fee; padding: 15px; border-radius: 8px; border: 2px solid #dc3545; text-align: center; margin-bottom: 15px;">
                            <span style="color: #dc3545; font-weight: 600;">âŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯</span>
                        </div>
                        <div id="searchResult" class="search-result">
                            <div class="user-info">
                                <div class="user-info-item">
                                    <label>Ø§Ù„Ø§Ø³Ù…:</label>
                                    <span id="resultUsername"></span>
                                </div>
                                <div class="user-info-item">
                                    <label>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ:</label>
                                    <span id="resultBalance"></span>
                                </div>
                            </div>
                            <div class="balance-input-group">
                                <input type="number" id="addAmount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø±Ø§Ø¯ Ø¥Ø¶Ø§ÙØªÙ‡" step="0.01" min="0.01">
                                <button type="button" onclick="submitAddBalance()">â• Ø¥Ø¶Ø§ÙØ©</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ØµÙØ­Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨ -->
            <div id="withdrawals" class="page">
                <div class="card">
                    <h2>ğŸ’° Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©</h2>
                    <div id="admin-withdrawals-container">
                        {% if withdrawals %}
                        <table id="admin-withdrawals-table">
                            <thead>
                            <tr>
                                <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                                <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                <th>Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©</th>
                                <th>Ø§Ù„Ø­Ø³Ø§Ø¨</th>
                                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                            </thead>
                            <tbody id="admin-withdrawals-tbody">
                            {% for withdrawal in withdrawals %}
                            <tr data-withdrawal-id="{{ withdrawal['id'] }}">
                                <td>{{ withdrawal['username'] }}</td>
                                <td>{{ "%.2f"|format(withdrawal['amount']) }} $</td>
                                <td>{{ withdrawal['method'] }}</td>
                                <td>{{ withdrawal['account_info'] }}</td>
                                <td>
                                    <form method="POST" action="{{ url_for('admin_approve_withdrawal', withdrawal_id=withdrawal['id']) }}" style="display: inline;">
                                        <button type="submit" class="btn btn-success">Ù‚Ø¨ÙˆÙ„</button>
                                    </form>
                                    <form method="POST" action="{{ url_for('admin_reject_withdrawal', withdrawal_id=withdrawal['id']) }}" style="display: inline;">
                                        <button type="submit" class="btn btn-danger">Ø±ÙØ¶</button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                        {% else %}
                        <p id="no-admin-withdrawals-msg" style="text-align: center; color: #999; padding: 40px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø³Ø­Ø¨ Ù…Ø¹Ù„Ù‚Ø©</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- ØµÙØ­Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† -->
            <div id="users" class="page">
                <div class="card">
                    <h2>ğŸ‘¥ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†</h2>
                    
                    <!-- Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¨ÙˆÙŠØ¨ -->
                    <div class="users-tabs" style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e0e0e0; padding-bottom: 15px;">
                        <button class="users-tab-btn active" onclick="switchUsersTab('list')" id="usersListTabBtn" style="padding: 12px 25px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</button>
                        <button class="users-tab-btn" onclick="switchUsersTab('search')" id="usersSearchTabBtn" style="padding: 12px 25px; background: #f0f0f0; color: #666; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">ğŸ” Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</button>
                    </div>
                    
                    <!-- ØªØ¨ÙˆÙŠØ¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† -->
                    <div id="usersListTab" class="users-tab-content" style="display: block;">
                        {% if users %}
                        <table>
                            <tr>
                                <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                                <th>Ø§Ù„Ø±ØµÙŠØ¯</th>
                                <th>Ø§Ù„ØªØ­Ø°ÙŠØ±Ø§Øª</th>
                                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            </tr>
                            {% for user in users %}
                            <tr>
                                <td>{{ user['username'] }}</td>
                                <td>{{ "%.2f"|format(user['balance']) }} $</td>
                                <td>{{ user['warnings'] }}</td>
                                <td>
                                    {% if user['is_banned'] == 1 %}
                                    <span style="color: #dc3545; font-weight: 600;">ğŸš« Ù…Ø­Ø¸ÙˆØ±</span>
                                    {% else %}
                                    <span style="color: #28a745; font-weight: 600;">âœ… Ù†Ø´Ø·</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </table>
                        {% else %}
                        <p style="text-align: center; color: #999; padding: 40px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</p>
                        {% endif %}
                    </div>
                    
                    <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… -->
                    <div id="usersSearchTab" class="users-tab-content" style="display: none;">
                        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                            <input type="text" id="searchUsernameInput" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…..." style="flex: 1; padding: 12px; border: 2px solid #667eea; border-radius: 8px; font-size: 15px;">
                            <button onclick="searchUserByUsername()" style="padding: 12px 25px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">ğŸ” Ø¨Ø­Ø«</button>
                        </div>
                        
                        <!-- Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø¨Ø­Ø« -->
                        <div id="userSearchResult" style="display: none;">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
            <div id="settings" class="page">
                <div class="card">
                    <h2>âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹</h2>
                    
                    <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª -->
                    <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                        <button type="button" onclick="switchSettingsTab('general')" id="settingsTabGeneral" class="settings-tab-btn active" style="padding: 12px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø©</button>
                        <button type="button" onclick="switchSettingsTab('streaming')" id="settingsTabStreaming" class="settings-tab-btn" style="padding: 12px 20px; background: #e5e7eb; color: #374151; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">ğŸ“º Ù…Ù†Ø­ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¨Ø«</button>
                    </div>
                    
                    <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© -->
                    <div id="settingsGeneralTab" class="settings-tab-content">
                        <form method="POST" action="{{ url_for('admin_update_settings') }}">
                            <div class="form-group">
                                <label>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹:</label>
                            </div>
                            <textarea name="deposit_info" rows="8" placeholder="Ø£Ø¯Ø®Ù„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹...">{{ deposit_info }}</textarea>
                            <button type="submit" class="btn" style="margin-top: 10px;">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
                        </form>
                    </div>
                    
                    <!-- ØªØ¨ÙˆÙŠØ¨ Ù…Ù†Ø­ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¨Ø« -->
                    <div id="settingsStreamingTab" class="settings-tab-content" style="display: none;">
                        <h3 style="color: #667eea; margin-bottom: 15px;">ğŸ“º Ø¥Ø¯Ø§Ø±Ø© ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</h3>
                        <p style="color: #666; margin-bottom: 20px;">Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù…Ù†Ø­ Ø£Ùˆ Ø¥Ù„ØºØ§Ø¡ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</p>
                        
                        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                            <input type="text" id="streamingSearchInput" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…..." style="flex: 1; padding: 12px; border: 2px solid #667eea; border-radius: 8px; font-size: 15px;">
                            <button onclick="searchUserForStreaming()" style="padding: 12px 25px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">ğŸ” Ø¨Ø­Ø«</button>
                        </div>
                        
                        <!-- Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø¨Ø­Ø« -->
                        <div id="streamingSearchResult" style="display: none; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border-radius: 15px; padding: 20px; border: 2px solid #667eea;">
                            <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 15px;">
                                <div>
                                    <h4 style="color: #22d3ee; margin-bottom: 5px;">ğŸ‘¤ <span id="streamingUserName"></span></h4>
                                    <p id="streamingUserStatus" style="margin: 0;"></p>
                                </div>
                                <div id="streamingActionButtons"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <script>
                    function switchSettingsTab(tabName) {
                        document.querySelectorAll('.settings-tab-content').forEach(tab => tab.style.display = 'none');
                        document.querySelectorAll('.settings-tab-btn').forEach(btn => {
                            btn.style.background = '#e5e7eb';
                            btn.style.color = '#374151';
                        });
                        
                        if (tabName === 'general') {
                            document.getElementById('settingsGeneralTab').style.display = 'block';
                            document.getElementById('settingsTabGeneral').style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                            document.getElementById('settingsTabGeneral').style.color = 'white';
                        } else if (tabName === 'streaming') {
                            document.getElementById('settingsStreamingTab').style.display = 'block';
                            document.getElementById('settingsTabStreaming').style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                            document.getElementById('settingsTabStreaming').style.color = 'white';
                        }
                    }
                    
                    function searchUserForStreaming() {
                        const username = document.getElementById('streamingSearchInput').value.trim();
                        if (!username) {
                            alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
                            return;
                        }
                        
                        fetch('/admin/api/search-user-streaming', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({username: username})
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                document.getElementById('streamingSearchResult').style.display = 'block';
                                document.getElementById('streamingUserName').textContent = data.username;
                                
                                const statusEl = document.getElementById('streamingUserStatus');
                                const actionsEl = document.getElementById('streamingActionButtons');
                                
                                if (data.streaming_enabled) {
                                    statusEl.innerHTML = '<span style="color: #22c55e; font-weight: 600;">âœ… Ù…ÙŠØ²Ø© Ø§Ù„Ø¨Ø« Ù…ÙØ¹Ù„Ø©</span>';
                                    actionsEl.innerHTML = '<button onclick="revokeStreamingPermission(' + data.user_id + ')" style="padding: 12px 20px; background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">ğŸš« Ø¥Ù„ØºØ§Ø¡ Ù…ÙŠØ²Ø© Ø§Ù„Ø¨Ø«</button>';
                                } else {
                                    statusEl.innerHTML = '<span style="color: #f59e0b; font-weight: 600;">âš ï¸ Ù…ÙŠØ²Ø© Ø§Ù„Ø¨Ø« ØºÙŠØ± Ù…ÙØ¹Ù„Ø©</span>';
                                    actionsEl.innerHTML = '<button onclick="grantStreamingPermission(' + data.user_id + ')" style="padding: 12px 20px; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">ğŸ Ù…Ù†Ø­ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¨Ø¯ÙˆÙ† Ø´Ø±ÙˆØ·</button>';
                                }
                            } else {
                                alert(data.error || 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                                document.getElementById('streamingSearchResult').style.display = 'none';
                            }
                        })
                        .catch(error => {
                            alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
                        });
                    }
                    
                    function grantStreamingPermission(userId) {
                        if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ù†Ø­ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¨Ø« Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø¯ÙˆÙ† Ø´Ø±ÙˆØ·ØŸ')) return;
                        
                        fetch('/admin/api/grant-streaming', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({user_id: userId})
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                alert('ØªÙ… Ù…Ù†Ø­ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¨Ø« Ø¨Ù†Ø¬Ø§Ø­!');
                                searchUserForStreaming();
                            } else {
                                alert(data.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£');
                            }
                        })
                        .catch(error => {
                            alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
                        });
                    }
                    
                    function revokeStreamingPermission(userId) {
                        if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù„ØºØ§Ø¡ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¨Ø« Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ Ø³ÙŠØ­ØªØ§Ø¬ Ù„Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø´Ø±ÙˆØ· Ù…Ù† Ø¬Ø¯ÙŠØ¯.')) return;
                        
                        fetch('/admin/api/revoke-streaming', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({user_id: userId})
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                alert('ØªÙ… Ø¥Ù„ØºØ§Ø¡ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¨Ø« Ø¨Ù†Ø¬Ø§Ø­!');
                                searchUserForStreaming();
                            } else {
                                alert(data.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£');
                            }
                        })
                        .catch(error => {
                            alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
                        });
                    }
                </script>
            </div>
            
            <!-- ØµÙØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯Ø¹Ù… -->
            <div id="support" class="page">
                <div class="card">
                    <h2>ğŸ§ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ</h2>
                    
                    <div class="deposits-button-group">
                        <button type="button" class="deposits-action-btn" onclick="toggleComplaintsSection()">ğŸ“‹ Ø§Ù„Ø´ÙƒØ§ÙˆÙŠ Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© <span class="badge">{{ pending_tickets }}</span></button>
                    </div>
                </div>
                
                <div id="complaintsSection" class="card" style="display: none; margin-top: 20px;">
                    <h2 style="margin-bottom: 20px; color: #667eea;">ğŸ“‹ Ø§Ù„Ø´ÙƒØ§ÙˆÙŠ Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©</h2>
                    <div id="complaintsReportsContainer" class="deposit-reports"></div>
                    <div id="complaintsPaginationContainer" class="pagination-container" style="display: none; margin-top: 20px;">
                        <button type="button" class="pagination-btn" id="complaintsPrevBtn" onclick="goToPreviousComplaintsPage()">â—€ï¸ Ø±Ø¬ÙˆØ¹</button>
                        <div class="pagination-info">
                            <span id="complaintsPageInfo">Ø§Ù„ØµÙØ­Ø© 1</span>
                        </div>
                        <button type="button" class="pagination-btn" id="complaintsNextBtn" onclick="goToNextComplaintsPage()">Ø§Ù„ØªØ§Ù„ÙŠ â–¶ï¸</button>
                    </div>
                </div>
            </div>
            
            <!-- Modal for Support Tickets -->
            <div id="ticketModal" class="modal-overlay" style="display: none;">
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h2 id="ticketModalTitle">ğŸ“‹ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´ÙƒÙˆÙ‰</h2>
                        <button class="modal-close" onclick="closeTicketModal()">âœ•</button>
                    </div>
                    <div class="info-row">
                        <div class="info-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</div>
                        <div class="info-value" id="ticketUsername"></div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©:</div>
                        <div class="info-value" id="ticketCategory"></div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">Ø§Ù„ØªØ§Ø±ÙŠØ®:</div>
                        <div class="info-value" id="ticketDate"></div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">Ø§Ù„Ø±Ø³Ø§Ù„Ø©:</div>
                        <div class="info-value" id="ticketMessage" style="white-space: pre-wrap; max-height: 200px; overflow-y: auto;"></div>
                    </div>
                    
                    <!-- Ù‚Ø³Ù… Ø§Ù„Ø±Ø¯ Ù„Ù„Ø´ÙƒØ§ÙˆÙŠ Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© (Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø´Ø­Ù†) -->
                    <div id="replySection" style="display: none; margin-top: 20px;">
                        <div class="modal-actions">
                            <button id="showReplyBtn" onclick="showReplyInput()" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer;">ğŸ“© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯</button>
                        </div>
                        <div id="replyInputSection" style="display: none; margin-top: 15px;">
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="text" id="ticketReplyInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø¯Ùƒ Ù‡Ù†Ø§..." style="flex: 1; padding: 12px; border: 2px solid #667eea; border-radius: 8px; font-size: 14px;">
                                <button onclick="sendTicketReply()" style="padding: 12px 20px; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; white-space: nowrap;">ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ù‚Ø³Ù… Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„Ù„Ø´ÙƒØ§ÙˆÙŠ Ø§Ù„Ø®Ø§ØµØ© (Ø§Ù„ØºØ´ ÙˆØ´ÙŠØ¡ Ø¢Ø®Ø±) -->
                    <div id="reviewSection" style="display: none; margin-top: 20px;">
                        <div class="modal-actions">
                            <button onclick="transferToReview()" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer;">ğŸ”„ ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Ù‚Ø³Ù… Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <script>
                let currentTicketId = null;
                let currentTicketCategory = null;
                
                const complaintsData = [
                    {% for ticket in support_tickets if ticket['status'] == 'pending' %}
                    {
                        id: {{ ticket['id'] }},
                        username: '{{ ticket['username'] }}',
                        category: '{{ ticket['category'] }}',
                        message: `{{ ticket['message'] | replace('`', "'") | replace('\n', ' ') | replace('\r', '') }}`,
                        date: '{{ ticket['created_at'] }}',
                        reportNumber: {{ loop.index }}
                    },
                    {% endfor %}
                ];
                
                const COMPLAINTS_PER_PAGE = 33;
                let currentComplaintsPage = 1;
                
                function toggleComplaintsSection() {
                    const section = document.getElementById('complaintsSection');
                    const isHidden = section.style.display === 'none';
                    
                    if (isHidden) {
                        section.style.display = 'block';
                        displayComplaintsPage(1);
                        updateComplaintsPaginationButtons();
                    } else {
                        section.style.display = 'none';
                    }
                }
                
                function displayComplaintsPage(pageNum) {
                    currentComplaintsPage = pageNum;
                    const start = (pageNum - 1) * COMPLAINTS_PER_PAGE;
                    const end = start + COMPLAINTS_PER_PAGE;
                    const pageData = complaintsData.slice(start, end);
                    
                    const container = document.getElementById('complaintsReportsContainer');
                    container.innerHTML = '';
                    
                    if (pageData.length === 0) {
                        container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px; font-size: 16px; grid-column: 1/-1;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´ÙƒØ§ÙˆÙŠ Ù…Ø¹Ù„Ù‚Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</p>';
                        return;
                    }
                    
                    pageData.forEach(ticket => {
                        const btn = document.createElement('button');
                        btn.type = 'button';
                        btn.className = 'report-btn';
                        btn.id = 'complaint-btn-' + ticket.id;
                        
                        let categoryIcon = 'ğŸ“';
                        let statusColor = '#667eea';
                        
                        if (ticket.category === 'withdrawal') {
                            categoryIcon = 'ğŸ’¸';
                            statusColor = '#ef4444';
                        } else if (ticket.category === 'deposit') {
                            categoryIcon = 'ğŸ’³';
                            statusColor = '#22c55e';
                        } else if (ticket.category === 'cheat') {
                            categoryIcon = 'ğŸš«';
                            statusColor = '#f59e0b';
                        }
                        
                        btn.textContent = categoryIcon + ' Ø´ÙƒÙˆÙ‰ ' + ticket.reportNumber;
                        btn.style.backgroundImage = `linear-gradient(135deg, ${statusColor} 0%, ${statusColor}dd 100%)`;
                        btn.onclick = () => openTicketModal(ticket.id, ticket.username, ticket.category, ticket.message, ticket.date);
                        
                        container.appendChild(btn);
                    });
                    
                    document.getElementById('complaintsPageInfo').textContent = 'Ø§Ù„ØµÙØ­Ø© ' + pageNum;
                }
                
                function showReplyInput() {
                    document.getElementById('showReplyBtn').style.display = 'none';
                    document.getElementById('replyInputSection').style.display = 'block';
                    document.getElementById('ticketReplyInput').focus();
                }
                
                function sendTicketReply() {
                    if (!currentTicketId) return;
                    
                    const replyText = document.getElementById('ticketReplyInput').value.trim();
                    if (!replyText) {
                        alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø±Ø¯ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„');
                        return;
                    }
                    
                    fetch('/admin/api/reply-ticket', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ticket_id: currentTicketId, reply: replyText})
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯ Ø¨Ù†Ø¬Ø§Ø­');
                            location.reload();
                        } else {
                            alert(data.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£');
                        }
                    })
                    .catch(error => {
                        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
                    });
                }
                
                function transferToReview() {
                    if (!currentTicketId) return;
                    
                    fetch('/admin/api/transfer-ticket', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ticket_id: currentTicketId})
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('ØªÙ… ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø´ÙƒÙˆÙ‰ Ø¥Ù„Ù‰ Ù‚Ø³Ù… Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¨Ù†Ø¬Ø§Ø­');
                            location.reload();
                        } else {
                            alert(data.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£');
                        }
                    })
                    .catch(error => {
                        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
                    });
                }
                
                function updateComplaintsPaginationButtons() {
                    const totalPages = Math.ceil(complaintsData.length / COMPLAINTS_PER_PAGE);
                    const paginationContainer = document.getElementById('complaintsPaginationContainer');
                    const prevBtn = document.getElementById('complaintsPrevBtn');
                    const nextBtn = document.getElementById('complaintsNextBtn');
                    
                    if (complaintsData.length > COMPLAINTS_PER_PAGE) {
                        paginationContainer.style.display = 'flex';
                        prevBtn.disabled = currentComplaintsPage === 1;
                        nextBtn.disabled = currentComplaintsPage === totalPages;
                    } else {
                        paginationContainer.style.display = 'none';
                    }
                }
                
                function goToNextComplaintsPage() {
                    const totalPages = Math.ceil(complaintsData.length / COMPLAINTS_PER_PAGE);
                    if (currentComplaintsPage < totalPages) {
                        displayComplaintsPage(currentComplaintsPage + 1);
                        updateComplaintsPaginationButtons();
                    }
                }
                
                function goToPreviousComplaintsPage() {
                    if (currentComplaintsPage > 1) {
                        displayComplaintsPage(currentComplaintsPage - 1);
                        updateComplaintsPaginationButtons();
                    }
                }
                
                function openTicketModal(id, username, category, message, date) {
                    currentTicketId = id;
                    currentTicketCategory = category;
                    document.getElementById('ticketUsername').textContent = username;
                    
                    const categoryNames = {
                        'withdrawal': 'ğŸ’¸ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø³Ø­Ø¨',
                        'deposit': 'ğŸ’³ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø´Ø­Ù†',
                        'cheat': 'ğŸš« Ø´ÙƒÙˆÙ‰ Ø¶Ø¯ Ø§Ù„ØºØ´',
                        'other': 'ğŸ“ Ø´ÙŠØ¡ Ø¢Ø®Ø±'
                    };
                    document.getElementById('ticketCategory').textContent = categoryNames[category] || category;
                    document.getElementById('ticketDate').textContent = date;
                    document.getElementById('ticketMessage').textContent = message;
                    
                    // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø£ÙˆÙ„Ø§Ù‹
                    document.getElementById('replySection').style.display = 'none';
                    document.getElementById('reviewSection').style.display = 'none';
                    document.getElementById('showReplyBtn').style.display = 'block';
                    document.getElementById('replyInputSection').style.display = 'none';
                    document.getElementById('ticketReplyInput').value = '';
                    
                    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø´ÙƒÙˆÙ‰
                    if (category === 'withdrawal' || category === 'deposit') {
                        // Ø´ÙƒØ§ÙˆÙŠ Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø´Ø­Ù† - Ø¥Ø¸Ù‡Ø§Ø± Ù‚Ø³Ù… Ø§Ù„Ø±Ø¯
                        document.getElementById('replySection').style.display = 'block';
                    } else {
                        // Ø´ÙƒØ§ÙˆÙŠ Ø§Ù„ØºØ´ ÙˆØ´ÙŠØ¡ Ø¢Ø®Ø± - Ø¥Ø¸Ù‡Ø§Ø± Ù‚Ø³Ù… Ø§Ù„ØªØ­ÙˆÙŠÙ„
                        document.getElementById('reviewSection').style.display = 'block';
                    }
                    
                    document.getElementById('ticketModal').style.display = 'flex';
                }
                
                function closeTicketModal() {
                    document.getElementById('ticketModal').style.display = 'none';
                    currentTicketId = null;
                    currentTicketCategory = null;
                    document.getElementById('ticketReplyInput').value = '';
                    document.getElementById('showReplyBtn').style.display = 'block';
                    document.getElementById('replyInputSection').style.display = 'none';
                }
                
                function resolveTicket() {
                    if (!currentTicketId) return;
                    
                    fetch('/admin/api/resolve-ticket', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ticket_id: currentTicketId})
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('ØªÙ… Ø­Ù„ Ø§Ù„Ø´ÙƒÙˆÙ‰ Ø¨Ù†Ø¬Ø§Ø­');
                            location.reload();
                        } else {
                            alert(data.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£');
                        }
                    })
                    .catch(error => {
                        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
                    });
                }
            </script>
        </div>
        
        <!-- ØµÙØ­Ø© Ù‚Ø³Ù… Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© -->
        <div id="review" class="page">
            <div class="card">
                <h2 style="margin-bottom: 20px; color: #f59e0b;">ğŸ” Ù‚Ø³Ù… Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</h2>
                <p style="color: #666; margin-bottom: 20px;">Ø§Ù„Ø´ÙƒØ§ÙˆÙŠ Ø§Ù„Ù…Ø­ÙˆÙ„Ø© Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© (Ø´ÙƒØ§ÙˆÙŠ Ø§Ù„ØºØ´ ÙˆØ§Ù„Ø£Ø®Ø±Ù‰)</p>
                
                <div id="reviewTicketsContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin-top: 20px;">
                    {% set review_tickets = [] %}
                    {% for ticket in support_tickets if ticket['status'] == 'under_review' %}
                    <button type="button" class="report-btn" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); padding: 12px 15px; border: none; border-radius: 10px; color: white; font-weight: 600; font-size: 13px; cursor: pointer; transition: all 0.3s ease;" onclick="openReviewTicketModal({{ ticket['id'] }}, '{{ ticket['username'] }}', '{{ ticket['category'] }}', `{{ ticket['message'] | replace('`', \"'\") | replace('\n', ' ') | replace('\r', '') }}`, '{{ ticket['created_at'] }}')">
                        {% if ticket['category'] == 'cheat' %}ğŸš«{% else %}ğŸ“{% endif %} Ù…Ø±Ø§Ø¬Ø¹Ø© {{ loop.index }}
                    </button>
                    {% endfor %}
                </div>
                
                {% if not support_tickets or support_tickets|selectattr('status', 'equalto', 'under_review')|list|length == 0 %}
                <p style="text-align: center; color: #666; padding: 40px; font-size: 16px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´ÙƒØ§ÙˆÙŠ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</p>
                {% endif %}
            </div>
            
            <!-- Modal for Review Tickets -->
            <div id="reviewTicketModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center;">
                <div style="background: white; border-radius: 20px; padding: 25px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #f59e0b; padding-bottom: 15px;">
                        <h3 style="color: #d97706; margin: 0;">ğŸ” ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø´ÙƒÙˆÙ‰</h3>
                        <button onclick="closeReviewTicketModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">âœ•</button>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <strong style="color: #333;">ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</strong>
                        <span id="reviewTicketUsername" style="color: #666;"></span>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <strong style="color: #333;">ğŸ“ Ù†ÙˆØ¹ Ø§Ù„Ø´ÙƒÙˆÙ‰:</strong>
                        <span id="reviewTicketCategory" style="color: #666;"></span>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <strong style="color: #333;">ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong>
                        <span id="reviewTicketDate" style="color: #666;"></span>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <strong style="color: #333;">ğŸ“ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:</strong>
                        <p id="reviewTicketMessage" style="background: #fef3c7; padding: 15px; border-radius: 10px; margin-top: 10px; color: #92400e; line-height: 1.6;"></p>
                    </div>
                    
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="performCheatAudit()" id="cheatAuditBtn" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer;">ğŸ”¬ ÙØ­Øµ Ø¯Ù‚ÙŠÙ‚</button>
                        <button onclick="resolveReviewTicket()" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer;">âœ… ØªÙ… Ø§Ù„Ø­Ù„</button>
                        <button onclick="showReviewReplyInput()" id="showReviewReplyBtn" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer;">ğŸ“© Ø¥Ø±Ø³Ø§Ù„ Ø±Ø¯</button>
                    </div>
                    
                    <!-- Ù‚Ø³Ù… Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙØ­Øµ Ø§Ù„Ø¯Ù‚ÙŠÙ‚ -->
                    <div id="cheatAuditResultSection" style="display: none; margin-top: 20px; background: #1a1a2e; border-radius: 15px; padding: 20px; border: 2px solid #f59e0b;">
                        <h4 style="color: #f59e0b; margin: 0 0 15px 0; text-align: center;">ğŸ”¬ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙØ­Øµ Ø§Ù„Ø¯Ù‚ÙŠÙ‚</h4>
                        
                        <div id="auditGameInfo" style="background: #16213e; padding: 12px; border-radius: 10px; margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 10px;">
                                <span style="color: #94a3b8;">ğŸ® Ø§Ù„Ù„Ø¹Ø¨Ø©: <strong id="auditGameId" style="color: #22d3ee;"></strong></span>
                                <span style="color: #94a3b8;">ğŸ’° Ø§Ù„Ø±Ù‡Ø§Ù†: <strong id="auditBetAmount" style="color: #22d3ee;"></strong></span>
                            </div>
                            <div style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 10px; margin-top: 8px;">
                                <span style="color: #94a3b8;">ğŸ‘¤ Ø§Ù„Ù…Ø´ØªÙƒÙŠ: <strong id="auditComplainant" style="color: #60a5fa;"></strong></span>
                                <span style="color: #94a3b8;">ğŸ¯ Ø§Ù„Ø®ØµÙ…: <strong id="auditOpponent" style="color: #f87171;"></strong></span>
                            </div>
                        </div>
                        
                        <div id="auditChecksContainer" style="max-height: 250px; overflow-y: auto;"></div>
                        
                        <div id="auditVerdict" style="margin-top: 15px; padding: 15px; border-radius: 10px; text-align: center; font-weight: 700; font-size: 16px;"></div>
                        
                        <div id="auditActions" style="display: none; margin-top: 15px; display: flex; gap: 10px;">
                            <button onclick="banCheater()" id="banCheaterBtn" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer;">â›” Ø­Ø¸Ø± Ø§Ù„ØºØ´Ø§Ø´</button>
                            <button onclick="refundVictim()" id="refundBtn" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer;">ğŸ’µ ØªØ¹ÙˆÙŠØ¶ Ø§Ù„Ø¶Ø­ÙŠØ©</button>
                        </div>
                    </div>
                    
                    <div id="reviewReplyInputSection" style="display: none; margin-top: 15px;">
                        <textarea id="reviewTicketReplyInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø¯Ùƒ Ù‡Ù†Ø§..." style="width: 100%; height: 80px; padding: 12px; border: 2px solid #f59e0b; border-radius: 10px; font-size: 14px; resize: vertical;"></textarea>
                        <button onclick="sendReviewTicketReply()" style="margin-top: 10px; width: 100%; padding: 12px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer;">ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„</button>
                    </div>
                </div>
            </div>
            
            <script>
                let currentReviewTicketId = null;
                let currentReviewCategory = null;
                let currentAuditData = null;
                
                function openReviewTicketModal(id, username, category, message, date) {
                    currentReviewTicketId = id;
                    currentReviewCategory = category;
                    document.getElementById('reviewTicketUsername').textContent = username;
                    
                    const categoryNames = {
                        'cheat': 'ğŸš« Ø´ÙƒÙˆÙ‰ Ø¶Ø¯ Ø§Ù„ØºØ´',
                        'other': 'ğŸ“ Ø´ÙŠØ¡ Ø¢Ø®Ø±'
                    };
                    document.getElementById('reviewTicketCategory').textContent = categoryNames[category] || category;
                    document.getElementById('reviewTicketDate').textContent = date;
                    document.getElementById('reviewTicketMessage').textContent = message;
                    document.getElementById('reviewReplyInputSection').style.display = 'none';
                    document.getElementById('showReviewReplyBtn').style.display = 'block';
                    document.getElementById('reviewTicketReplyInput').value = '';
                    document.getElementById('cheatAuditResultSection').style.display = 'none';
                    
                    // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„ÙØ­Øµ Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø´ÙƒÙˆÙ‰
                    const auditBtn = document.getElementById('cheatAuditBtn');
                    if (category === 'cheat') {
                        auditBtn.style.display = 'block';
                    } else {
                        auditBtn.style.display = 'none';
                    }
                    
                    document.getElementById('reviewTicketModal').style.display = 'flex';
                }
                
                function performCheatAudit() {
                    if (!currentReviewTicketId) return;
                    
                    const btn = document.getElementById('cheatAuditBtn');
                    btn.disabled = true;
                    btn.innerHTML = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙØ­Øµ...';
                    
                    fetch('/admin/api/cheat-audit', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ticket_id: currentReviewTicketId})
                    })
                    .then(response => response.json())
                    .then(data => {
                        btn.disabled = false;
                        btn.innerHTML = 'ğŸ”¬ ÙØ­Øµ Ø¯Ù‚ÙŠÙ‚';
                        
                        if (data.success) {
                            currentAuditData = data.audit;
                            displayAuditResults(data.audit);
                        } else {
                            alert(data.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ÙØ­Øµ');
                        }
                    })
                    .catch(error => {
                        btn.disabled = false;
                        btn.innerHTML = 'ğŸ”¬ ÙØ­Øµ Ø¯Ù‚ÙŠÙ‚';
                        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
                    });
                }
                
                function displayAuditResults(audit) {
                    document.getElementById('cheatAuditResultSection').style.display = 'block';
                    
                    // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø© Ù…Ù† game_info Ø§Ù„Ø¬Ø¯ÙŠØ¯
                    const gameInfo = audit.game_info || {};
                    document.getElementById('auditGameId').textContent = gameInfo.game_id || audit.game_id || 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
                    document.getElementById('auditBetAmount').textContent = ((gameInfo.bet_amount || audit.bet_amount || 0)).toFixed(2) + ' $';
                    document.getElementById('auditComplainant').textContent = gameInfo.complainant_name || audit.complainant_name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                    document.getElementById('auditOpponent').textContent = gameInfo.opponent_name || audit.opponent_name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                    
                    // Ø¹Ø±Ø¶ Ø¯Ø±Ø¬Ø© Ø§Ù„Ø®Ø·ÙˆØ±Ø©
                    const cheatScore = audit.cheat_score || 0;
                    
                    // Ø¹Ø±Ø¶ Ø§Ù„ÙØ­ÙˆØµØ§Øª
                    const checksContainer = document.getElementById('auditChecksContainer');
                    checksContainer.innerHTML = '';
                    
                    // Ø¥Ø¶Ø§ÙØ© Ø´Ø±ÙŠØ· Ø¯Ø±Ø¬Ø© Ø§Ù„Ø®Ø·ÙˆØ±Ø©
                    let scoreColor = cheatScore >= 80 ? '#dc2626' : cheatScore >= 40 ? '#f59e0b' : '#22c55e';
                    checksContainer.innerHTML = `
                        <div style="background: #16213e; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                            <div style="color: #94a3b8; font-size: 12px; margin-bottom: 8px;">ğŸ“Š Ø¯Ø±Ø¬Ø© Ø§Ù„Ø®Ø·ÙˆØ±Ø©</div>
                            <div style="background: #0f172a; border-radius: 8px; height: 20px; overflow: hidden;">
                                <div style="background: ${scoreColor}; height: 100%; width: ${Math.min(cheatScore, 100)}%; transition: width 0.5s;"></div>
                            </div>
                            <div style="text-align: center; color: ${scoreColor}; font-weight: 700; margin-top: 8px; font-size: 18px;">${cheatScore}/100</div>
                        </div>
                    `;
                    
                    if (audit.checks && audit.checks.length > 0) {
                        audit.checks.forEach(check => {
                            let bgColor, borderColor;
                            if (check.status === 'pass') {
                                bgColor = '#064e3b';
                                borderColor = '#22c55e';
                            } else if (check.status === 'fail') {
                                bgColor = '#7f1d1d';
                                borderColor = '#ef4444';
                            } else {
                                bgColor = '#78350f';
                                borderColor = '#f59e0b';
                            }
                            
                            checksContainer.innerHTML += `
                                <div style="background: ${bgColor}; border-right: 4px solid ${borderColor}; padding: 10px 12px; margin-bottom: 8px; border-radius: 8px;">
                                    <div style="color: white; font-weight: 600; margin-bottom: 4px;">${check.icon || 'ğŸ”'} ${check.name}</div>
                                    <div style="color: #d1d5db; font-size: 13px;">${check.details}</div>
                                </div>
                            `;
                        });
                    } else {
                        checksContainer.innerHTML += `
                            <div style="background: #78350f; border-right: 4px solid #f59e0b; padding: 10px 12px; margin-bottom: 8px; border-radius: 8px;">
                                <div style="color: white; font-weight: 600;">âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ­ÙˆØµØ§Øª</div>
                                <div style="color: #d1d5db; font-size: 13px;">Ù„Ù… ÙŠØªÙ… Ø¥Ø¬Ø±Ø§Ø¡ Ø£ÙŠ ÙØ­ÙˆØµØ§Øª</div>
                            </div>
                        `;
                    }
                    
                    // Ø§Ù„Ø­ÙƒÙ… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
                    const verdictDiv = document.getElementById('auditVerdict');
                    const actionsDiv = document.getElementById('auditActions');
                    
                    if (audit.verdict === 'cheating_detected') {
                        verdictDiv.style.background = 'linear-gradient(135deg, #dc2626 0%, #991b1b 100%)';
                        verdictDiv.innerHTML = `â›” ${audit.summary}`;
                        actionsDiv.style.display = 'flex';
                    } else if (audit.verdict === 'suspicious') {
                        verdictDiv.style.background = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
                        verdictDiv.innerHTML = `âš ï¸ ${audit.summary}`;
                        actionsDiv.style.display = 'flex';
                    } else {
                        verdictDiv.style.background = 'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)';
                        verdictDiv.innerHTML = `âœ… ${audit.summary}`;
                        actionsDiv.style.display = 'none';
                    }
                }
                
                function banCheater() {
                    if (!currentAuditData || !currentAuditData.cheater_id) {
                        alert('Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ ØºØ´Ø§Ø´');
                        return;
                    }
                    
                    if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø¸Ø± Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ØŸ')) {
                        fetch('/admin/api/ban-user', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({user_id: currentAuditData.cheater_id, reason: 'ØºØ´ ÙÙŠ Ø§Ù„Ù„Ø¹Ø¨Ø©'})
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                alert('ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­');
                            } else {
                                alert(data.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£');
                            }
                        });
                    }
                }
                
                function refundVictim() {
                    if (!currentAuditData || !currentAuditData.complainant_id) {
                        alert('Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¶Ø­ÙŠØ©');
                        return;
                    }
                    
                    const amount = currentAuditData.cheat_amount || (currentAuditData.bet_amount * 2);
                    if (confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ¹ÙˆÙŠØ¶ Ø§Ù„Ù…Ø´ØªÙƒÙŠ Ø¨Ù…Ø¨Ù„Øº ${amount.toFixed(2)} $ØŸ`)) {
                        fetch('/admin/api/refund-user', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({user_id: currentAuditData.complainant_id, amount: amount, reason: 'ØªØ¹ÙˆÙŠØ¶ Ø¹Ù† Ø§Ù„ØºØ´'})
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                alert('ØªÙ… ØªØ¹ÙˆÙŠØ¶ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­');
                            } else {
                                alert(data.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£');
                            }
                        });
                    }
                }
                
                function closeReviewTicketModal() {
                    document.getElementById('reviewTicketModal').style.display = 'none';
                    currentReviewTicketId = null;
                }
                
                function showReviewReplyInput() {
                    document.getElementById('showReviewReplyBtn').style.display = 'none';
                    document.getElementById('reviewReplyInputSection').style.display = 'block';
                    document.getElementById('reviewTicketReplyInput').focus();
                }
                
                function resolveReviewTicket() {
                    if (!currentReviewTicketId) return;
                    
                    fetch('/admin/api/resolve-review-ticket', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ticket_id: currentReviewTicketId})
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('ØªÙ… Ø­Ù„ Ø§Ù„Ø´ÙƒÙˆÙ‰ Ø¨Ù†Ø¬Ø§Ø­');
                            location.reload();
                        } else {
                            alert(data.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£');
                        }
                    })
                    .catch(error => {
                        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
                    });
                }
                
                function sendReviewTicketReply() {
                    if (!currentReviewTicketId) return;
                    
                    const replyText = document.getElementById('reviewTicketReplyInput').value.trim();
                    if (!replyText) {
                        alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø±Ø¯ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„');
                        return;
                    }
                    
                    fetch('/admin/api/reply-review-ticket', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ticket_id: currentReviewTicketId, reply: replyText})
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯ Ø¨Ù†Ø¬Ø§Ø­');
                            location.reload();
                        } else {
                            alert(data.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£');
                        }
                    })
                    .catch(error => {
                        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
                    });
                }
            </script>
        </div>
        
        <div class="footer">
            <form method="GET" action="{{ url_for('logout') }}" style="display: inline;">
                <button type="submit" class="logout-btn">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
            </form>
        </div>
    </div>
    
    <!-- Modal for Deposits -->
    <div id="depositModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ“‹ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø·Ù„Ø¨</h2>
                <button class="modal-close" onclick="closeDepositModal()">âœ•</button>
            </div>
            <div class="info-row">
                <div class="info-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</div>
                <div class="info-value" id="modalUsername"></div>
            </div>
            <div class="info-row">
                <div class="info-label">Ø§Ù„ØªØ§Ø±ÙŠØ®:</div>
                <div class="info-value" id="modalDate"></div>
            </div>
            <div class="info-row">
                <div class="info-label">Ø§Ù„ØµÙˆØ±Ø©:</div>
                <img id="modalImage" class="modal-image" onclick="openImageModal()" style="display: none;">
            </div>
            <div class="modal-actions">
                <div class="action-group">
                    <input type="number" id="approveAmount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¹ØªÙ…Ø¯" step="0.01" min="0.01">
                    <button class="btn-approve-modal" onclick="submitApproveDeposit()">âœ… Ù‚Ø¨ÙˆÙ„</button>
                </div>
                <div class="action-group">
                    <input type="text" id="rejectReason" placeholder="Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶">
                    <button class="btn-reject-modal" onclick="submitRejectDeposit()">âŒ Ø±ÙØ¶</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Image Modal -->
    <div id="imageModal" class="image-modal" onclick="closeImageModal()">
        <img id="enlargedImage">
    </div>
    
    <script>
        let currentDepositId = null;
        let currentDepositUsername = null;
        let currentSearchedUserId = null;
        
        const depositsData = [
            {% for deposit in deposits %}
            {
                id: {{ deposit['id'] }},
                username: '{{ deposit['username'] }}',
                date: '{{ deposit['created_at'] }}',
                photo: '{% if deposit['photo_data'] %}data:image/jpeg;base64,{{ deposit['photo_data'] }}{% endif %}',
                status: '{{ deposit['status'] }}',
                reportNumber: {{ loop.index }}
            }{{ "," if not loop.last }}
            {% endfor %}
        ];
        
        const REPORTS_PER_PAGE = 33;
        let currentPage = 1;
        
        function toggleReportsSection() {
            const section = document.getElementById('reportsSection');
            const isHidden = section.style.display === 'none';
            
            if (isHidden) {
                section.style.display = 'block';
                displayPage(1);
                updatePaginationButtons();
            } else {
                section.style.display = 'none';
            }
        }
        
        function displayPage(pageNum) {
            currentPage = pageNum;
            const start = (pageNum - 1) * REPORTS_PER_PAGE;
            const end = start + REPORTS_PER_PAGE;
            const pageData = depositsData.slice(start, end);
            
            const container = document.getElementById('depositReportsContainer');
            container.innerHTML = '';
            
            pageData.forEach(deposit => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'report-btn';
                btn.id = 'deposit-btn-' + deposit.id;
                
                let statusBadge = 'â³ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©';
                let statusColor = '#ffc107';
                
                if (deposit.status === 'approved') {
                    statusBadge = 'âœ… Ù…Ù‚Ø¨ÙˆÙ„';
                    statusColor = '#28a745';
                } else if (deposit.status === 'rejected') {
                    statusBadge = 'âŒ Ù…Ø±ÙÙˆØ¶';
                    statusColor = '#dc3545';
                }
                
                btn.textContent = 'ğŸ“‹ ØªÙ‚Ø±ÙŠØ± Ø±Ù‚Ù… ' + deposit.reportNumber + ' - ' + statusBadge;
                btn.style.backgroundImage = `linear-gradient(135deg, ${statusColor} 0%, ${statusColor} 100%)`;
                btn.style.opacity = deposit.status !== 'pending' ? '0.6' : '1';
                btn.style.pointerEvents = deposit.status !== 'pending' ? 'none' : 'auto';
                
                if (deposit.status === 'pending') {
                    btn.onclick = () => openDepositModal(deposit.id, deposit.username, deposit.date, deposit.photo);
                }
                
                container.appendChild(btn);
            });
            
            document.getElementById('pageInfo').textContent = 'Ø§Ù„ØµÙØ­Ø© ' + pageNum;
        }
        
        function updatePaginationButtons() {
            const totalPages = Math.ceil(depositsData.length / REPORTS_PER_PAGE);
            const paginationContainer = document.getElementById('paginationContainer');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            if (depositsData.length > REPORTS_PER_PAGE) {
                paginationContainer.style.display = 'flex';
                prevBtn.disabled = currentPage === 1;
                nextBtn.disabled = currentPage === totalPages;
            } else {
                paginationContainer.style.display = 'none';
            }
        }
        
        function goToNextPage() {
            const totalPages = Math.ceil(depositsData.length / REPORTS_PER_PAGE);
            if (currentPage < totalPages) {
                displayPage(currentPage + 1);
                updatePaginationButtons();
            }
        }
        
        function goToPreviousPage() {
            if (currentPage > 1) {
                displayPage(currentPage - 1);
                updatePaginationButtons();
            }
        }
        
        function switchPage(pageName) {
            const pages = document.querySelectorAll('.page');
            const buttons = document.querySelectorAll('.nav-btn');
            
            pages.forEach(page => page.classList.remove('active'));
            buttons.forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(pageName).classList.add('active');
            event.target.classList.add('active');
        }
        
        function toggleAddBalance() {
            const section = document.getElementById('addBalanceSection');
            section.classList.toggle('active');
            if (!section.classList.contains('active')) {
                document.getElementById('searchResult').classList.remove('active', 'error');
                document.getElementById('searchUsername').value = '';
                document.getElementById('addAmount').value = '';
            }
        }
        
        function searchUser() {
            const username = document.getElementById('searchUsername').value.trim();
            if (!username) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
                return;
            }
            
            // Send search request to server
            fetch('/admin/search-user', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: 'username=' + encodeURIComponent(username)
            })
            .then(response => response.json())
            .then(data => {
                const resultDiv = document.getElementById('searchResult');
                const errorDiv = document.getElementById('searchErrorMessage');
                
                if (data.found) {
                    currentSearchedUserId = data.user_id;
                    document.getElementById('resultUsername').textContent = data.username;
                    document.getElementById('resultBalance').textContent = data.balance.toFixed(2) + ' $';
                    document.getElementById('addAmount').value = '';
                    
                    resultDiv.classList.remove('error');
                    resultDiv.classList.add('active');
                    if (errorDiv) errorDiv.style.display = 'none';
                } else {
                    resultDiv.classList.remove('active');
                    if (errorDiv) {
                        errorDiv.style.display = 'block';
                        setTimeout(function() {
                            errorDiv.style.display = 'none';
                        }, 2000);
                    } else {
                        alert('âŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¨Ø­Ø«');
            });
        }
        
        function submitAddBalance() {
            const amount = document.getElementById('addAmount').value;
            if (!amount || parseFloat(amount) <= 0) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­');
                return;
            }
            
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/admin/add-balance/' + currentSearchedUserId;
            
            const amountInput = document.createElement('input');
            amountInput.type = 'hidden';
            amountInput.name = 'amount';
            amountInput.value = amount;
            
            form.appendChild(amountInput);
            document.body.appendChild(form);
            form.submit();
        }
        
        function openDepositModal(depositId, username, date, imageData) {
            currentDepositId = depositId;
            currentDepositUsername = username;
            
            document.getElementById('modalUsername').textContent = username;
            document.getElementById('modalDate').textContent = date;
            document.getElementById('approveAmount').value = '';
            document.getElementById('rejectReason').value = '';
            
            const imageElement = document.getElementById('modalImage');
            if (imageData) {
                imageElement.src = imageData;
                imageElement.style.display = 'block';
            } else {
                imageElement.style.display = 'none';
            }
            
            document.getElementById('depositModal').classList.add('active');
        }
        
        function closeDepositModal() {
            document.getElementById('depositModal').classList.remove('active');
            currentDepositId = null;
        }
        
        function openImageModal() {
            const imageData = document.getElementById('modalImage').src;
            document.getElementById('enlargedImage').src = imageData;
            document.getElementById('imageModal').classList.add('active');
        }
        
        function closeImageModal() {
            document.getElementById('imageModal').classList.remove('active');
        }
        
        function submitApproveDeposit() {
            const amount = document.getElementById('approveAmount').value;
            if (!amount || parseFloat(amount) <= 0) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­');
                return;
            }
            
            const formData = new FormData();
            formData.append('amount', amount);
            
            fetch(`/admin/approve-deposit/${currentDepositId}`, {
                method: 'POST',
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ø£ÙˆÙ„Ø§Ù‹
                    const depositIndex = depositsData.findIndex(d => d.id === currentDepositId);
                    if (depositIndex !== -1) {
                        depositsData[depositIndex].status = 'approved';
                    }
                    
                    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù€ modal
                    closeDepositModal();
                    
                    // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„ØµÙØ­Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¨Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                    displayPage(currentPage);
                    
                    // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
                    alert('âœ… ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­');
                    
                    // Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø¹Ø¯ ØªØ£Ø®ÙŠØ± Ù‚Ù„ÙŠÙ„ (Ø¨Ø¹Ø¯ Ø¸Ù‡ÙˆØ± Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©)
                    setTimeout(() => {
                        const idx = depositsData.findIndex(d => d.id === currentDepositId);
                        if (idx !== -1) {
                            depositsData.splice(idx, 1);
                            displayPage(currentPage);
                        }
                    }, 800);
                } else {
                    alert('âŒ ' + data.message);
                }
            })
            .catch(err => {
                console.error('Error:', err);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨');
            });
        }
        
        function submitRejectDeposit() {
            const reason = document.getElementById('rejectReason').value;
            if (!reason.trim()) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶');
                return;
            }
            
            const formData = new FormData();
            formData.append('reason', reason);
            
            fetch(`/admin/reject-deposit/${currentDepositId}`, {
                method: 'POST',
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ø£ÙˆÙ„Ø§Ù‹
                    const depositIndex = depositsData.findIndex(d => d.id === currentDepositId);
                    if (depositIndex !== -1) {
                        depositsData[depositIndex].status = 'rejected';
                    }
                    
                    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù€ modal
                    closeDepositModal();
                    
                    // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„ØµÙØ­Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¨Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                    displayPage(currentPage);
                    
                    // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
                    alert('âœ… ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨');
                    
                    // Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø¹Ø¯ ØªØ£Ø®ÙŠØ± Ù‚Ù„ÙŠÙ„ (Ø¨Ø¹Ø¯ Ø¸Ù‡ÙˆØ± Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©)
                    setTimeout(() => {
                        const idx = depositsData.findIndex(d => d.id === currentDepositId);
                        if (idx !== -1) {
                            depositsData.splice(idx, 1);
                            displayPage(currentPage);
                        }
                    }, 800);
                } else {
                    alert('âŒ ' + data.message);
                }
            })
            .catch(err => {
                console.error('Error:', err);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨');
            });
        }
        
        // Close modal when clicking outside
        document.getElementById('depositModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeDepositModal();
            }
        });
        
        // SocketIO Ù„Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙÙˆØ±ÙŠ Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
        const adminSocket = io({
            transports: ['websocket', 'polling'],
            reconnection: true,
            reconnectionAttempts: 10,
            reconnectionDelay: 1000
        });
        
        adminSocket.on('connect', function() {
            console.log('âœ… Ø§Ù„Ø£Ø¯Ù…Ù† Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø³ÙˆÙƒÙŠØª');
            // Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„ØºØ±ÙØ© Ø§Ù„Ø£Ø¯Ù…Ù†
            adminSocket.emit('join_admin_room');
        });
        
        // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø·Ù„Ø¨ Ø´Ø­Ù† Ø¬Ø¯ÙŠØ¯
        adminSocket.on('admin_new_deposit', function(data) {
            console.log('ğŸ“ Ø·Ù„Ø¨ Ø´Ø­Ù† Ø¬Ø¯ÙŠØ¯:', data);
            const depositsCountEl = document.getElementById('pendingDepositsCount');
            if (depositsCountEl) {
                const currentCount = parseInt(depositsCountEl.textContent) || 0;
                depositsCountEl.textContent = currentCount + 1;
                depositsCountEl.style.color = '#4caf50';
                depositsCountEl.style.transform = 'scale(1.2)';
                setTimeout(() => {
                    depositsCountEl.style.color = '';
                    depositsCountEl.style.transform = '';
                }, 1500);
            }
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©
            if (data.deposit) {
                depositsData.push({
                    id: data.deposit.id,
                    username: data.deposit.username,
                    date: data.deposit.created_at,
                    photo: data.deposit.photo_data ? 'data:image/jpeg;base64,' + data.deposit.photo_data : '',
                    status: 'pending'
                });
                displayPage(currentPage);
            }
            // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø²Ø±
            const badge = document.querySelector('.deposits-action-btn .badge');
            if (badge) {
                badge.textContent = depositsData.filter(d => d.status === 'pending').length;
            }
        });
        
        // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø·Ù„Ø¨ Ø³Ø­Ø¨ Ø¬Ø¯ÙŠØ¯
        adminSocket.on('admin_new_withdrawal', function(data) {
            console.log('ğŸ’° Ø·Ù„Ø¨ Ø³Ø­Ø¨ Ø¬Ø¯ÙŠØ¯:', data);
            const withdrawalsCountEl = document.getElementById('pendingWithdrawalsCount');
            if (withdrawalsCountEl) {
                const currentCount = parseInt(withdrawalsCountEl.textContent) || 0;
                withdrawalsCountEl.textContent = currentCount + 1;
                withdrawalsCountEl.style.color = '#ff9800';
                withdrawalsCountEl.style.transform = 'scale(1.2)';
                setTimeout(() => {
                    withdrawalsCountEl.style.color = '';
                    withdrawalsCountEl.style.transform = '';
                }, 1500);
            }
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø¬Ø¯ÙˆÙ„ ÙÙˆØ±Ø§Ù‹
            if (data.withdrawal) {
                addWithdrawalToAdminTable(data.withdrawal);
            }
        });
        
        // Ø¯Ø§Ù„Ø© Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨ Ù„Ù„Ø¬Ø¯ÙˆÙ„
        function addWithdrawalToAdminTable(withdrawal) {
            const container = document.getElementById('admin-withdrawals-container');
            const noWithdrawalsMsg = document.getElementById('no-admin-withdrawals-msg');
            let table = document.getElementById('admin-withdrawals-table');
            let tbody = document.getElementById('admin-withdrawals-tbody');
            
            // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø¬Ø¯ÙˆÙ„ØŒ Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ§Ø­Ø¯ Ø¬Ø¯ÙŠØ¯
            if (!table) {
                if (noWithdrawalsMsg) {
                    noWithdrawalsMsg.remove();
                }
                container.innerHTML = `
                    <table id="admin-withdrawals-table">
                        <thead>
                        <tr>
                            <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                            <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                            <th>Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©</th>
                            <th>Ø§Ù„Ø­Ø³Ø§Ø¨</th>
                            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                        </thead>
                        <tbody id="admin-withdrawals-tbody">
                        </tbody>
                    </table>
                `;
                tbody = document.getElementById('admin-withdrawals-tbody');
            }
            
            // Ø¥Ù†Ø´Ø§Ø¡ ØµÙ Ø¬Ø¯ÙŠØ¯
            const newRow = document.createElement('tr');
            newRow.setAttribute('data-withdrawal-id', withdrawal.id);
            newRow.style.animation = 'fadeIn 0.5s ease-in';
            newRow.style.background = '#fffde7';
            newRow.innerHTML = `
                <td>${withdrawal.username}</td>
                <td>${parseFloat(withdrawal.amount).toFixed(2)} $</td>
                <td>${withdrawal.method}</td>
                <td>${withdrawal.account_info}</td>
                <td>
                    <form method="POST" action="/admin/approve-withdrawal/${withdrawal.id}" style="display: inline;">
                        <button type="submit" class="btn btn-success">Ù‚Ø¨ÙˆÙ„</button>
                    </form>
                    <form method="POST" action="/admin/reject-withdrawal/${withdrawal.id}" style="display: inline;">
                        <button type="submit" class="btn btn-danger">Ø±ÙØ¶</button>
                    </form>
                </td>
            `;
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙ ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
            tbody.insertBefore(newRow, tbody.firstChild);
            
            // Ø¥Ø²Ø§Ù„Ø© Ù„ÙˆÙ† Ø§Ù„Ø®Ù„ÙÙŠØ© Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØªÙŠÙ†
            setTimeout(() => {
                newRow.style.background = '';
            }, 2000);
            
            console.log('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨ Ù„Ù„Ø¬Ø¯ÙˆÙ„ ÙÙˆØ±Ø§Ù‹');
        }
        
        // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ ØªØ­Ø¯ÙŠØ« Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
        adminSocket.on('admin_new_user', function(data) {
            console.log('ğŸ‘¤ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯:', data);
            const usersCountEl = document.getElementById('totalUsersCount');
            if (usersCountEl) {
                const currentCount = parseInt(usersCountEl.textContent) || 0;
                usersCountEl.textContent = currentCount + 1;
            }
        });
        
        adminSocket.on('disconnect', function() {
            console.log('âŒ Ø§Ù„Ø£Ø¯Ù…Ù† ØºÙŠØ± Ù…ØªØµÙ„');
        });
        
        // ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ¥Ø¯Ø§Ø±ØªÙ‡
        let searchedUserId = null;
        let searchedUserBalance = 0;
        
        function switchUsersTab(tabName) {
            // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
            document.getElementById('usersListTab').style.display = 'none';
            document.getElementById('usersSearchTab').style.display = 'none';
            
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù€ active Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
            document.getElementById('usersListTabBtn').style.background = '#f0f0f0';
            document.getElementById('usersListTabBtn').style.color = '#666';
            document.getElementById('usersSearchTabBtn').style.background = '#f0f0f0';
            document.getElementById('usersSearchTabBtn').style.color = '#666';
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø®ØªØ§Ø±
            if (tabName === 'list') {
                document.getElementById('usersListTab').style.display = 'block';
                document.getElementById('usersListTabBtn').style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                document.getElementById('usersListTabBtn').style.color = 'white';
            } else {
                document.getElementById('usersSearchTab').style.display = 'block';
                document.getElementById('usersSearchTabBtn').style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                document.getElementById('usersSearchTabBtn').style.color = 'white';
            }
        }
        
        function searchUserByUsername() {
            const username = document.getElementById('searchUsernameInput').value.trim();
            if (!username) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
                return;
            }
            
            fetch('/admin/api/search-user', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ username: username })
            })
            .then(response => response.json())
            .then(data => {
                const resultDiv = document.getElementById('userSearchResult');
                
                if (data.found) {
                    searchedUserId = data.user_id;
                    searchedUserBalance = data.balance;
                    
                    resultDiv.innerHTML = `
                        <div style="background: #f8f9fa; padding: 25px; border-radius: 12px; border: 2px solid #667eea;">
                            <div style="margin-bottom: 20px;">
                                <label style="font-weight: 600; color: #333; font-size: 16px;">Ø§Ù„Ø§Ø³Ù…:</label>
                                <span style="color: #667eea; font-size: 18px; margin-right: 10px; font-weight: bold;">${data.username}</span>
                                ${data.is_banned ? '<span style="color: #dc3545; font-weight: 600; margin-right: 10px;">ğŸš« Ù…Ø­Ø¸ÙˆØ±</span>' : '<span style="color: #28a745; font-weight: 600; margin-right: 10px;">âœ… Ù†Ø´Ø·</span>'}
                            </div>
                            
                            <div style="margin-bottom: 20px; display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                                <label style="font-weight: 600; color: #333; font-size: 16px;">Ø§Ù„Ø±ØµÙŠØ¯:</label>
                                <span id="displayedBalance" style="color: #28a745; font-size: 20px; font-weight: bold;">${data.balance.toFixed(2)} $</span>
                                <input type="number" id="newBalanceInput" placeholder="Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯" step="0.01" min="0" style="padding: 10px; border: 2px solid #667eea; border-radius: 8px; font-size: 14px; width: 150px;">
                                <button onclick="changeUserBalance()" style="padding: 10px 20px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">ØªØºÙŠÙŠØ± Ø§Ù„Ø±ØµÙŠØ¯</button>
                            </div>
                            
                            <div style="margin-top: 25px; padding-top: 20px; border-top: 2px solid #e0e0e0;">
                                ${data.is_banned ? 
                                    `<button onclick="unbanUser()" style="padding: 12px 30px; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 15px;">âœ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¸Ø±</button>` :
                                    `<button onclick="banUser()" style="padding: 12px 30px; background: linear-gradient(135deg, #dc3545 0%, #ff6b6b 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 15px;">ğŸš« Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</button>`
                                }
                            </div>
                        </div>
                    `;
                    resultDiv.style.display = 'block';
                } else {
                    resultDiv.innerHTML = `
                        <div style="background: #fee; padding: 20px; border-radius: 8px; border: 2px solid #dc3545; text-align: center;">
                            <span style="color: #dc3545; font-weight: 600; font-size: 16px;">âŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯</span>
                        </div>
                    `;
                    resultDiv.style.display = 'block';
                    
                    setTimeout(() => {
                        resultDiv.style.display = 'none';
                    }, 2000);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¨Ø­Ø«');
            });
        }
        
        function changeUserBalance() {
            const newBalance = document.getElementById('newBalanceInput').value;
            if (newBalance === '' || parseFloat(newBalance) < 0) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±ØµÙŠØ¯ ØµØ­ÙŠØ­');
                return;
            }
            
            fetch('/admin/api/set-balance', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    user_id: searchedUserId,
                    new_balance: parseFloat(newBalance)
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('displayedBalance').textContent = parseFloat(newBalance).toFixed(2) + ' $';
                    document.getElementById('newBalanceInput').value = '';
                    alert('âœ… ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø±ØµÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­');
                } else {
                    alert('âŒ ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØºÙŠÙŠØ± Ø§Ù„Ø±ØµÙŠØ¯');
            });
        }
        
        function banUser() {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø¸Ø± Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ')) {
                return;
            }
            
            fetch('/admin/api/ban-user', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ user_id: searchedUserId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('âœ… ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­');
                    // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¨Ø­Ø« Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©
                    searchUserByUsername();
                } else {
                    alert('âŒ ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
            });
        }
        
        function unbanUser() {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø± Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ')) {
                return;
            }
            
            fetch('/admin/api/unban-user', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ user_id: searchedUserId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('âœ… ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­');
                    // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¨Ø­Ø« Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©
                    searchUserByUsername();
                } else {
                    alert('âŒ ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¸Ø±');
            });
        }
        
        // Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchUsernameInput');
            if (searchInput) {
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchUserByUsername();
                    }
                });
            }
        });
    </script>
</body>
</html>
'''

@app.route('/')
def index():
    if 'user_id' in session:
        if session.get('is_admin'):
            return redirect(url_for('admin_dashboard'))
        return redirect(url_for('dashboard'))
    return redirect(url_for('login'))

@app.route('/register', methods=['GET', 'POST'])
def register():
    if request.method == 'POST':
        username = request.form.get('username', '').strip()
        password = request.form.get('password', '')
        pin = request.form.get('pin', '')
        
        if len(username) < 3 or len(username) > 15:
            return render_template_string(REGISTER_PAGE, error='Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨ÙŠÙ† 3 Ùˆ 15 Ø­Ø±Ù')
        
        if contains_emoji(username):
            return render_template_string(REGISTER_PAGE, error='Ù„Ø§ ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ ÙÙŠ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…')
        
        if has_bad_words(username):
            return render_template_string(REGISTER_PAGE, error='Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… ØºÙŠØ± Ù…Ù‚Ø¨ÙˆÙ„')
        
        if len(password) < 6:
            return render_template_string(REGISTER_PAGE, error='ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„')
        
        if not pin.isdigit() or len(pin) != 3:
            return render_template_string(REGISTER_PAGE, error='Ø±Ù…Ø² PIN ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 3 Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·')
        
        if ADMIN_ENABLED and username == ADMIN_USERNAME:
            return render_template_string(REGISTER_PAGE, error='Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø¬ÙˆØ²ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ø³Ù… Ø¢Ø®Ø±')
        
        conn = get_db()
        cursor = conn.cursor()
        cursor.execute('SELECT id FROM users WHERE username = ?', (username,))
        existing = cursor.fetchone()
        
        if existing:
            conn.close()
            return render_template_string(REGISTER_PAGE, error='Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ø³Ù… Ø¢Ø®Ø±')
        
        new_session_id = ''.join(random.choices(string.ascii_letters + string.digits, k=32))
        
        cursor.execute('''
            INSERT INTO users (username, password_hash, pin, session_id, session_created_at)
            VALUES (?, ?, ?, ?, CURRENT_TIMESTAMP)
        ''', (username, hash_password(password), pin, new_session_id))
        user_id = cursor.lastrowid
        conn.commit()
        conn.close()
        
        session.permanent = True
        session['user_id'] = user_id
        session['username'] = username
        session['is_admin'] = False
        session['custom_session_id'] = new_session_id
        return redirect(url_for('dashboard'))
    
    return render_template_string(REGISTER_PAGE)

@app.route('/login', methods=['GET', 'POST'])
def login():
    if request.method == 'POST':
        username = request.form.get('username', '').strip()
        password = request.form.get('password', '')
        
        if ADMIN_ENABLED and username == ADMIN_USERNAME and password == ADMIN_PASSWORD:
            new_session_id = ''.join(random.choices(string.ascii_letters + string.digits, k=32))
            session.permanent = True
            session['user_id'] = 'admin'
            session['username'] = username
            session['is_admin'] = True
            session['custom_session_id'] = new_session_id
            return redirect(url_for('admin_dashboard'))
        
        conn = get_db()
        cursor = conn.cursor()
        cursor.execute('SELECT id, password_hash, is_admin, is_banned FROM users WHERE username = ?', (username,))
        user = cursor.fetchone()
        
        if not user:
            conn.close()
            return render_template_string(LOGIN_PAGE, error='ÙŠØ¨Ø¯Ùˆ Ø£Ù†Ùƒ Ø£Ø¯Ø®Ù„Øª Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø®Ø§Ø·Ø¦Ø©')
        
        if user['is_banned']:
            conn.close()
            return render_template_string(LOGIN_PAGE, error='Ø­Ø³Ø§Ø¨Ùƒ Ù…Ø­Ø¸ÙˆØ±')
        
        if not check_password_hash(user['password_hash'], password):
            conn.close()
            return render_template_string(LOGIN_PAGE, error='ÙŠØ¨Ø¯Ùˆ Ø£Ù†Ùƒ Ø£Ø¯Ø®Ù„Øª Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø®Ø§Ø·Ø¦Ø©')
        
        cursor.execute('''
            SELECT COUNT(*) as count FROM ludo_active_games 
            WHERE (player1_id = ? OR player2_id = ?) AND game_status = 'playing'
        ''', (user['id'], user['id']))
        has_active_ludo = cursor.fetchone()['count'] > 0
        
        cursor.execute('''
            SELECT COUNT(*) as count FROM active_games 
            WHERE (player1_id = ? OR player2_id = ?) AND game_status = 'playing'
        ''', (user['id'], user['id']))
        has_active_dice = cursor.fetchone()['count'] > 0
        
        cursor.execute('''
            SELECT COUNT(*) as count FROM domino_active_games 
            WHERE (player1_id = ? OR player2_id = ?) AND game_status = 'playing'
        ''', (user['id'], user['id']))
        has_active_domino = cursor.fetchone()['count'] > 0
        
        cursor.execute('SELECT session_id FROM users WHERE id = ?', (user['id'],))
        current_user = cursor.fetchone()
        existing_session_id = current_user['session_id'] if current_user else None
        
        if has_active_ludo or has_active_dice or has_active_domino:
            if existing_session_id:
                new_session_id = existing_session_id
                cursor.execute('UPDATE users SET session_created_at = CURRENT_TIMESTAMP WHERE id = ?', (user['id'],))
                print(f"â™»ï¸ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… session_id Ù…ÙˆØ¬ÙˆØ¯ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… {user['id']} Ø¨Ø³Ø¨Ø¨ ÙˆØ¬ÙˆØ¯ Ù„Ø¹Ø¨Ø© Ù†Ø´Ø·Ø©")
            else:
                new_session_id = ''.join(random.choices(string.ascii_letters + string.digits, k=32))
                cursor.execute('UPDATE users SET session_id = ?, session_created_at = CURRENT_TIMESTAMP WHERE id = ?', 
                              (new_session_id, user['id']))
                print(f"ğŸ†• Ø¥Ù†Ø´Ø§Ø¡ session_id Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… {user['id']} Ù…Ø¹ Ù„Ø¹Ø¨Ø© Ù†Ø´Ø·Ø©")
        else:
            new_session_id = ''.join(random.choices(string.ascii_letters + string.digits, k=32))
            cursor.execute('UPDATE users SET session_id = ?, session_created_at = CURRENT_TIMESTAMP WHERE id = ?', 
                          (new_session_id, user['id']))
            print(f"ğŸ†• Ø¥Ù†Ø´Ø§Ø¡ session_id Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… {user['id']} Ø¨Ø¯ÙˆÙ† Ø£Ù„Ø¹Ø§Ø¨ Ù†Ø´Ø·Ø©")
        
        conn.commit()
        
        session.permanent = True
        session['user_id'] = user['id']
        session['username'] = username
        session['is_admin'] = bool(user['is_admin'])
        session['custom_session_id'] = new_session_id
        
        if has_active_ludo:
            cursor.execute('''
                SELECT id FROM ludo_active_games 
                WHERE (player1_id = ? OR player2_id = ?) AND game_status = 'playing'
                LIMIT 1
            ''', (user['id'], user['id']))
            active_game = cursor.fetchone()
            conn.close()
            
            if active_game:
                print(f"ğŸ® Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ù„Ø§Ø¹Ø¨ {user['id']} Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ù„Ø¹Ø¨Ø© Ludo {active_game['id']}")
                return redirect(url_for('ludo_arena', game_id=active_game['id']))
        
        if has_active_dice:
            cursor.execute('''
                SELECT id FROM active_games 
                WHERE (player1_id = ? OR player2_id = ?) AND game_status = 'playing'
                LIMIT 1
            ''', (user['id'], user['id']))
            active_game = cursor.fetchone()
            conn.close()
            
            if active_game:
                                return redirect(url_for('game_arena', game_id=active_game['id']))
        
        if has_active_domino:
            cursor.execute('''
                SELECT id FROM domino_active_games 
                WHERE (player1_id = ? OR player2_id = ?) AND game_status = 'playing'
                LIMIT 1
            ''', (user['id'], user['id']))
            active_game = cursor.fetchone()
            conn.close()
            
            if active_game:
                                return redirect(url_for('domino_arena', game_id=active_game['id']))
        
        conn.close()
        
        if user['is_admin']:
            return redirect(url_for('admin_dashboard'))
        return redirect(url_for('dashboard'))
    
    return render_template_string(LOGIN_PAGE)

@app.route('/forgot-password', methods=['GET', 'POST'])
def forgot_password():
    if request.method == 'POST':
        username = request.form.get('username', '').strip()
        pin = request.form.get('pin', '')
        new_password = request.form.get('new_password', '')
        
        conn = get_db()
        cursor = conn.cursor()
        cursor.execute('SELECT id, pin, is_banned FROM users WHERE username = ?', (username,))
        user = cursor.fetchone()
        
        if not user or user['pin'] != pin:
            conn.close()
            return render_template_string(FORGOT_PASSWORD_PAGE, error='Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ Ø±Ù…Ø² PIN ØºÙŠØ± ØµØ­ÙŠØ­')
        
        if user['is_banned']:
            conn.close()
            return render_template_string(FORGOT_PASSWORD_PAGE, error='Ø­Ø³Ø§Ø¨Ùƒ Ù…Ø­Ø¸ÙˆØ±')
        
        cursor.execute('UPDATE users SET password_hash = ? WHERE id = ?', (hash_password(new_password), user['id']))
        conn.commit()
        conn.close()
        
        return render_template_string(FORGOT_PASSWORD_PAGE, success='ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­! Ø§Ø³ØªØ®Ø¯Ù… ÙƒÙ„Ù…ØªÙƒ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©')

    
    return render_template_string(FORGOT_PASSWORD_PAGE)

@app.route('/dashboard')
@login_required
def dashboard():
    if session.get('is_admin'):
        return redirect(url_for('admin_dashboard'))
    return redirect(url_for('games_page'))

@app.route('/games')
@login_required
def games_page():
    if session.get('is_admin'):
        return redirect(url_for('admin_dashboard'))
    
    conn = get_db()
    cursor = conn.cursor()
    
    cursor.execute('SELECT * FROM users WHERE id = ?', (session['user_id'],))
    user = cursor.fetchone()
    
    cursor.execute('''
        SELECT * FROM bnb_transactions 
        WHERE user_id = ? 
        ORDER BY created_at DESC 
        LIMIT 10
    ''', (session['user_id'],))
    bnb_transactions = cursor.fetchall()
    
    cursor.execute('''
        SELECT * FROM deposit_requests 
        WHERE user_id = ? 
        ORDER BY created_at DESC 
        LIMIT 10
    ''', (session['user_id'],))
    deposits = cursor.fetchall()
    
    cursor.execute('''
        SELECT * FROM withdrawal_requests 
        WHERE user_id = ? 
        ORDER BY created_at DESC 
        LIMIT 10
    ''', (session['user_id'],))
    withdrawals = cursor.fetchall()
    
    conn.close()
    
    return render_template_string(GAMES_PAGE, 
                                 user=user,
                                 bnb_transactions=bnb_transactions,
                                 deposits=deposits,
                                 withdrawals=withdrawals,
                                 page='games')

@app.route('/games/ludo')
@login_required
def ludo_game_page():
    if session.get('is_admin'):
        return redirect(url_for('admin_dashboard'))
    
    conn = get_db()
    cursor = conn.cursor()
    
    cursor.execute('''
        DELETE FROM ludo_matchmaking_queue 
        WHERE user_id = ? AND status = 'matched'
    ''', (session['user_id'],))
    
    conn.commit()
    
    cursor.execute('SELECT * FROM users WHERE id = ?', (session['user_id'],))
    user = cursor.fetchone()
    
    conn.close()
    
    if 'game_message' in session:
        flash(session.pop('game_message'))
    
    return render_template_string(LUDO_BET_INFO_PAGE, 
                                 user=user,
                                 page='games')



@app.route('/play-ludo/<amount>')
@login_required
def play_ludo(amount):
    try:
        amount = float(amount)
    except ValueError:
        flash('Ù…Ø¨Ù„Øº Ø§Ù„Ø±Ù‡Ø§Ù† ØºÙŠØ± ØµØ­ÙŠØ­')
        return redirect(url_for('ludo_game_page'))
    
    if session.get('is_admin'):
        return redirect(url_for('admin_dashboard'))
    
    conn = get_db()
    cursor = conn.cursor()
    
    cursor.execute('''
        DELETE FROM ludo_matchmaking_queue 
        WHERE user_id = ? AND status = 'matched'
    ''', (session['user_id'],))
    
    conn.commit()
    
    cursor.execute('SELECT * FROM users WHERE id = ?', (session['user_id'],))
    user = cursor.fetchone()
    
    cursor.execute('''
        SELECT g.id, g.game_status, u.username as opponent_name, g.bet_amount
        FROM ludo_active_games g
        LEFT JOIN users u ON (
            CASE 
                WHEN g.player1_id = ? THEN g.player2_id
                ELSE g.player1_id
            END = u.id
        )
        WHERE (g.player1_id = ? OR g.player2_id = ?) 
        AND g.game_status = 'playing'
        ORDER BY g.created_at DESC LIMIT 1
    ''', (session['user_id'], session['user_id'], session['user_id']))
    existing_game = cursor.fetchone()
    
    if existing_game:
        opponent_name = existing_game['opponent_name'] if existing_game['opponent_name'] else 'Ù…Ù†Ø§ÙØ³'
        conn.close()
        return render_template_string(MATCHMAKING_PAGE, 
                                     user=user,
                                     bet_amount=existing_game['bet_amount'],
                                     queue_id=-1,
                                     already_matched=True,
                                     game_id=existing_game['id'],
                                     opponent_name=opponent_name,
                                     time_left=0,
                                     game_type='ludo')
    
    if amount > user['balance']:
        flash('Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙŠ')
        conn.close()
        return redirect(url_for('ludo_game_page'))
    
    cursor.execute('UPDATE users SET balance = balance - ? WHERE id = ?', (amount, session['user_id']))
    
    expires_at = (datetime.now() + timedelta(seconds=40)).strftime('%Y-%m-%d %H:%M:%S')
    
    cursor.execute('''
        INSERT INTO ludo_matchmaking_queue (user_id, bet_amount, status, expires_at, lock_version)
        VALUES (?, ?, 'queued', ?, 0)
        ON CONFLICT(user_id) DO UPDATE SET
            bet_amount = excluded.bet_amount,
            status = 'queued',
            expires_at = excluded.expires_at,
            lock_version = 0,
            created_at = CURRENT_TIMESTAMP
    ''', (session['user_id'], amount, expires_at))
    
    queue_id = cursor.lastrowid
    if queue_id == 0:
        queue_id = cursor.execute('SELECT id FROM ludo_matchmaking_queue WHERE user_id = ?', 
                                 (session['user_id'],)).fetchone()['id']
    
    conn.commit()
    conn.close()
    
    return render_template_string(MATCHMAKING_PAGE, 
                                 user=user,
                                 bet_amount=amount,
                                 queue_id=queue_id,
                                 already_matched=False,
                                 game_id=0,
                                 opponent_name='',
                                 time_left=40,
                                 game_type='ludo')

@app.route('/ludo-arena/<int:game_id>')
@login_required
def ludo_arena(game_id):
    if session.get('is_admin'):
        return redirect(url_for('admin_dashboard'))
    
    conn = get_db()
    cursor = conn.cursor()
    
    cursor.execute('''
        SELECT g.*, 
               u1.username as player1_name,
               u2.username as player2_name
        FROM ludo_active_games g
        LEFT JOIN users u1 ON g.player1_id = u1.id
        LEFT JOIN users u2 ON g.player2_id = u2.id
        WHERE g.id = ? AND (g.player1_id = ? OR g.player2_id = ?)
    ''', (game_id, session['user_id'], session['user_id']))
    
    game = cursor.fetchone()
    
    if not game:
        flash('Ø§Ù„Ù„Ø¹Ø¨Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©')
        conn.close()
        return redirect(url_for('ludo_game_page'))
    
    if game['game_status'] != 'playing':
        flash('Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù†ØªÙ‡Øª')
        conn.close()
        return redirect(url_for('ludo_game_page'))
    
    cursor.execute('SELECT * FROM users WHERE id = ?', (session['user_id'],))
    user = cursor.fetchone()
    
    player_number = 1 if game['player1_id'] == session['user_id'] else 2
    is_player1 = (player_number == 1)
    opponent_name = game['player2_name'] if player_number == 1 else game['player1_name']
    
    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ø¹Ø¨Ø©
    cursor.execute('''
        SELECT is_active, viewer_count, streamer_id 
        FROM ludo_streams 
        WHERE game_id = ? AND is_active = 1
    ''', (game_id,))
    stream_info = cursor.fetchone()
    
    is_streaming = False
    stream_viewer_count = 0
    current_streamer_id = None
    if stream_info:
        is_streaming = True
        stream_viewer_count = stream_info['viewer_count'] or 0
        current_streamer_id = stream_info['streamer_id']
    
    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙØ¹ÙŠÙ„ Ù…ÙŠØ²Ø© Ø§Ù„Ø¨Ø« Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
    my_streaming_enabled = check_user_streaming_enabled(session['user_id'])
    
    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙØ¹ÙŠÙ„ Ù…ÙŠØ²Ø© Ø§Ù„Ø¨Ø« Ù„Ù„Ø®ØµÙ…
    opponent_id = game['player2_id'] if is_player1 else game['player1_id']
    opponent_streaming_enabled = check_user_streaming_enabled(opponent_id)
    
    # Ù…Ù†Ø·Ù‚ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©: Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø£ÙˆÙ„ (player1) Ù„Ù‡ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù† Ù„Ø¯ÙŠÙ‡ Ø§Ù„Ø¨Ø« Ù…ÙØ¹Ù„
    # ÙŠÙ…ÙƒÙ† Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¨Ø« ÙÙ‚Ø· Ø¥Ø°Ø§:
    # 1. Ù„Ø¯ÙŠÙ‡ Ù…ÙŠØ²Ø© Ø§Ù„Ø¨Ø« Ù…ÙØ¹Ù„Ø©
    # 2. ÙˆØ¥Ù…Ø§ Ø£Ù†Ù‡ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø£ÙˆÙ„ØŒ Ø£Ùˆ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø£ÙˆÙ„ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙ‡ Ø¨Ø« Ù…ÙØ¹Ù„
    can_stream = False
    if my_streaming_enabled:
        if is_player1:
            # Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø£ÙˆÙ„ Ø¯Ø§Ø¦Ù…Ø§Ù‹ ÙŠÙ…ÙƒÙ†Ù‡ Ø§Ù„Ø¨Ø« Ø¥Ø°Ø§ Ù„Ø¯ÙŠÙ‡ Ø§Ù„Ù…ÙŠØ²Ø© Ù…ÙØ¹Ù„Ø©
            can_stream = True
        else:
            # Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø«Ø§Ù†ÙŠ ÙŠÙ…ÙƒÙ†Ù‡ Ø§Ù„Ø¨Ø« ÙÙ‚Ø· Ø¥Ø°Ø§ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø£ÙˆÙ„ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙ‡ Ø¨Ø« Ù…ÙØ¹Ù„
            can_stream = not opponent_streaming_enabled
    
    # Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø¨Ø« Ù†Ø´Ø· Ù…Ù† Ø§Ù„Ø®ØµÙ…ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¨Ø«
    if is_streaming and current_streamer_id and current_streamer_id != session['user_id']:
        can_stream = False
    
    conn.close()
    
    return render_template_string(LUDO_GAME_PAGE, 
                                 game=game,
                                 user=user,
                                 current_user=user,
                                 game_id=game_id,
                                 player_number=player_number,
                                 is_player1=is_player1,
                                 opponent_name=opponent_name,
                                 bet_amount=game['bet_amount'],
                                 user_id=session['user_id'],
                                 is_streaming=is_streaming,
                                 stream_viewer_count=stream_viewer_count,
                                 streaming_enabled=my_streaming_enabled,
                                 can_stream=can_stream)

@app.route('/api/ludo-roll/<int:game_id>', methods=['POST'])
@api_login_required
def ludo_roll(game_id):
    if not check_ludo_rate_limit(session['user_id'], 'roll'):
        return jsonify({'success': False, 'error': 'Ø§Ù†ØªØ¸Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù‚Ø¨Ù„ Ø§Ù„Ø±Ù…ÙŠ Ù…Ø¬Ø¯Ø¯Ø§Ù‹'})
    
    conn = get_db()
    cursor = conn.cursor()
    
    cursor.execute('''
        SELECT * FROM ludo_active_games 
        WHERE id = ? AND (player1_id = ? OR player2_id = ?) AND game_status = 'playing'
    ''', (game_id, session['user_id'], session['user_id']))
    game = cursor.fetchone()
    
    if not game:
        conn.close()
        return jsonify({'success': False, 'error': 'Ø§Ù„Ù„Ø¹Ø¨Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©'})
    
    player_number = 1 if game['player1_id'] == session['user_id'] else 2
    
    if game['current_turn'] != player_number:
        conn.close()
        return jsonify({'success': False, 'error': 'Ù„ÙŠØ³ Ø¯ÙˆØ±Ùƒ'})
    
    dice_result = secrets.randbelow(6) + 1
    
    player_color = 'green' if player_number == 1 else 'blue'
    position_column = 'player1_position' if player_number == 1 else 'player2_position'
    position_data = json.loads(game[position_column])
    pieces = position_data.get(player_color, [0, 0, 0, 0])
    
    pieces_outside = sum(1 for p in pieces if p > 0 and p < 58)
    pieces_in_home = sum(1 for p in pieces if p == 0)
    pieces_finished = sum(1 for p in pieces if p >= 58)
    
    movable_pieces = []
    for i, p in enumerate(pieces):
        if p == 0 and dice_result == 6:
            movable_pieces.append(i)
        elif p > 0 and p < 58:
            # Check remaining steps: must have enough steps to reach position 58
            remaining_steps = 58 - p
            if dice_result <= remaining_steps:
                movable_pieces.append(i)
    
    now = datetime.now()
    timestamp_with_ms = now.strftime('%Y-%m-%d %H:%M:%S.%f')
    dice_start_time = now.isoformat()
    
    # Check for auto-release: only when no outside pieces can move
    movable_outside = [i for i in movable_pieces if pieces[i] > 0 and pieces[i] < 58]
    home_indices = [i for i, p in enumerate(pieces) if p == 0]
    
    # Auto-release ONLY if:
    # 1. Roll is 6
    # 2. There are pieces waiting in home
    # 3. NO pieces outside can move (movable_outside is empty)
    should_auto_release = (dice_result == 6 and 
                          len(home_indices) > 0 and 
                          len(movable_outside) == 0)
    
    if should_auto_release:
        first_home_piece = home_indices[0]
        pieces[first_home_piece] = 1
        position_data[player_color] = pieces
        
        cursor.execute(f'''
            UPDATE ludo_active_games 
            SET {position_column} = ?,
                last_roll = ?,
                last_roll_timestamp = ?,
                dice_roll_start_time = ?,
                dice_animation_state = 'rolling',
                game_event_version = game_event_version + 1,
                last_event_timestamp = ?,
                turn_deadline = datetime(CURRENT_TIMESTAMP, '+30 seconds'),
                waiting_for_piece_selection = 0
            WHERE id = ?
        ''', (json.dumps(position_data), dice_result, timestamp_with_ms, dice_start_time, timestamp_with_ms, game_id))
        
        conn.commit()
        
        log_game_event(game_id, 'dice_roll', session['user_id'], {
            'roll': dice_result,
            'player_number': player_number,
            'auto_released': True,
            'piece_index': first_home_piece
        }, state_before={'pieces': game[position_column]}, state_after={'pieces': json.dumps(position_data)})
        
        conn.close()
        
        dice_update = {
            'type': 'dice_roll',
            'game_id': game_id,
            'roll': dice_result,
            'roll_timestamp': timestamp_with_ms,
            'dice_start_time': dice_start_time,
            'waiting_for_piece_selection': 0,
            'current_turn': player_number,
            'time_left': 30
        }
        socketio.emit('ludo_update', dice_update, room=f'ludo_game_{game_id}')
        socketio.emit('ludo_update', dice_update, room=f'ludo_stream_{game_id}')
        
        piece_update = {
            'type': 'piece_move',
            'game_id': game_id,
            'player1_position': game['player1_position'] if player_number == 2 else json.dumps(position_data),
            'player2_position': game['player2_position'] if player_number == 1 else json.dumps(position_data),
            'current_turn': player_number,
            'captured_pieces': [],
            'bonus_roll': True,
            'time_left': 30,
            'game_event_version': game['game_event_version']
        }
        socketio.emit('ludo_update', piece_update, room=f'ludo_game_{game_id}')
        socketio.emit('ludo_update', piece_update, room=f'ludo_stream_{game_id}')
        
        return jsonify({
            'success': True, 
            'roll': dice_result,
            'roll_timestamp': timestamp_with_ms,
            'dice_start_time': dice_start_time,
            'animation_duration': 2.0,
            'auto_released': True
        })
    
    waiting_for_selection = 0
    if len(movable_pieces) > 1:
        all_in_home = all(pieces[i] == 0 for i in movable_pieces)
        if not all_in_home:
            waiting_for_selection = 1
    elif len(movable_pieces) == 1:
        waiting_for_selection = 0
    else:
        waiting_for_selection = 0
    
    cursor.execute('''
        UPDATE ludo_active_games 
        SET last_roll = ?,
            last_roll_timestamp = ?,
            dice_roll_start_time = ?,
            dice_animation_state = 'rolling',
            game_event_version = game_event_version + 1,
            last_event_timestamp = ?,
            turn_deadline = datetime(CURRENT_TIMESTAMP, '+30 seconds'),
            waiting_for_piece_selection = ?
        WHERE id = ?
    ''', (dice_result, timestamp_with_ms, dice_start_time, timestamp_with_ms, waiting_for_selection, game_id))
    
    conn.commit()
    
    log_game_event(game_id, 'dice_roll', session['user_id'], {
        'roll': dice_result,
        'player_number': player_number,
        'movable_pieces': movable_pieces,
        'waiting_for_selection': waiting_for_selection
    })
    
    conn.close()
    
    dice_update = {
        'type': 'dice_roll',
        'game_id': game_id,
        'roll': dice_result,
        'roll_timestamp': timestamp_with_ms,
        'dice_start_time': dice_start_time,
        'waiting_for_piece_selection': waiting_for_selection,
        'current_turn': player_number,
        'time_left': 30
    }
    socketio.emit('ludo_update', dice_update, room=f'ludo_game_{game_id}')
    socketio.emit('ludo_update', dice_update, room=f'ludo_stream_{game_id}')
    
    return jsonify({
        'success': True, 
        'roll': dice_result,
        'roll_timestamp': timestamp_with_ms,
        'dice_start_time': dice_start_time,
        'animation_duration': 2.0
    })

@app.route('/api/ludo-state/<int:game_id>')
@api_login_required
def ludo_state(game_id):
    conn = get_db()
    cursor = conn.cursor()
    
    cursor.execute('''
        SELECT g.*, 
               u1.username as player1_name,
               u2.username as player2_name
        FROM ludo_active_games g
        LEFT JOIN users u1 ON g.player1_id = u1.id
        LEFT JOIN users u2 ON g.player2_id = u2.id
        WHERE g.id = ? AND (g.player1_id = ? OR g.player2_id = ?)
    ''', (game_id, session['user_id'], session['user_id']))
    game = cursor.fetchone()
    
    if not game:
        conn.close()
        return jsonify({'success': False, 'error': 'Ø§Ù„Ù„Ø¹Ø¨Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©'})
    
    player_number = 1 if game['player1_id'] == session['user_id'] else 2
    
    conn.close()
    
    realtime_state = get_ludo_game_realtime_state(game_id)
    
    waiting_for_selection = 0
    if game['current_turn'] == player_number:
        try:
            waiting_for_selection = game['waiting_for_piece_selection'] if 'waiting_for_piece_selection' in game.keys() else 0
        except:
            waiting_for_selection = 0
    else:
        waiting_for_selection = 0
    
    time_left = None
    if game['turn_deadline']:
        try:
            deadline = datetime.strptime(game['turn_deadline'], '%Y-%m-%d %H:%M:%S')
            remaining = (deadline - datetime.now()).total_seconds()
            time_left = max(0, int(remaining))
        except:
            time_left = None
    
    return jsonify({
        'success': True,
        'current_turn': game['current_turn'],
        'last_roll': game['last_roll'],
        'last_roll_timestamp': game['last_roll_timestamp'] if 'last_roll_timestamp' in game.keys() else None,
        'game_status': game['game_status'],
        'player_number': player_number,
        'player1_position': game['player1_position'],
        'player2_position': game['player2_position'],
        'dice_animation': realtime_state['dice_animation'] if realtime_state else None,
        'piece_animations': realtime_state['piece_animations'] if realtime_state else {},
        'game_event_version': realtime_state['game_event_version'] if realtime_state else 0,
        'waiting_for_piece_selection': waiting_for_selection,
        'time_left': time_left
    })

def validate_ludo_move(old_pieces, new_pieces, dice_roll, player_color):
    """
    Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø­Ø±ÙƒØ© Ø§Ù„Ù„ÙˆØ¯Ùˆ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù…
    ÙŠÙ…Ù†Ø¹ Ø£ÙŠ ØªÙ„Ø§Ø¹Ø¨ Ù…Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„
    """
    if not dice_roll or dice_roll < 1 or dice_roll > 6:
        return False, "Ø±Ù…ÙŠØ© Ù†Ø±Ø¯ ØºÙŠØ± ØµØ§Ù„Ø­Ø©"
    
    if not old_pieces or not new_pieces:
        return False, "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± ØµØ§Ù„Ø­Ø©"
    
    if len(old_pieces) != 4 or len(new_pieces) != 4:
        return False, "Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø­Ø¬Ø§Ø± ØºÙŠØ± ØµØ­ÙŠØ­"
    
    moved_pieces = []
    for i in range(4):
        old_pos = old_pieces[i] if i < len(old_pieces) else 0
        new_pos = new_pieces[i] if i < len(new_pieces) else 0
        
        if new_pos < 0 or new_pos > 58:
            return False, f"Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø¬Ø± {i+1} ØºÙŠØ± Ù‚Ø§Ù†ÙˆÙ†ÙŠ: {new_pos}"
        
        if old_pos != new_pos:
            moved_pieces.append({
                'index': i,
                'old': old_pos,
                'new': new_pos,
                'distance': new_pos - old_pos
            })
    
    if len(moved_pieces) == 0:
        return True, "Ù„Ù… ÙŠØªØ­Ø±Ùƒ Ø£ÙŠ Ø­Ø¬Ø± (ØªØ®Ø·ÙŠ Ø§Ù„Ø¯ÙˆØ±)"
    
    if len(moved_pieces) > 1:
        return False, "Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ø±ÙŠÙƒ Ø£ÙƒØ«Ø± Ù…Ù† Ø­Ø¬Ø± ÙˆØ§Ø­Ø¯ ÙÙŠ Ø§Ù„Ø¯ÙˆØ±"
    
    move = moved_pieces[0]
    
    if move['old'] == 0 and move['new'] == 1:
        if dice_roll != 6:
            return False, "ÙŠØ¬Ø¨ Ø±Ù…ÙŠ 6 Ù„Ø¥Ø®Ø±Ø§Ø¬ Ø­Ø¬Ø± Ù…Ù† Ø§Ù„Ø¨ÙŠØª"
        return True, "Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ø¨ÙŠØª ØµØ­ÙŠØ­"
    
    if move['old'] == 0 and move['new'] != 1:
        return False, "Ø§Ù„Ø­Ø¬Ø± ÙÙŠ Ø§Ù„Ø¨ÙŠØª ÙŠØ¬Ø¨ Ø£Ù† ÙŠØªØ­Ø±Ùƒ Ù„Ù„Ù…ÙˆÙ‚Ø¹ 1 ÙÙ‚Ø·"
    
    if move['old'] > 0 and move['old'] < 58:
        expected_new = move['old'] + dice_roll
        if expected_new > 58:
            expected_new = 58
        
        if move['new'] != expected_new and move['new'] != 58:
            if move['new'] > move['old'] + dice_roll:
                return False, f"Ø§Ù„Ø­Ø¬Ø± ØªØ­Ø±Ùƒ Ø£ÙƒØ«Ø± Ù…Ù† Ø§Ù„Ù…Ø³Ù…ÙˆØ­ ({move['new'] - move['old']} Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† {dice_roll})"
    
    if move['new'] > 58:
        return False, "Ø§Ù„Ø­Ø¬Ø± ØªØ¬Ø§ÙˆØ² Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ"
    
    return True, "Ø­Ø±ÙƒØ© ØµØ­ÙŠØ­Ø©"

@app.route('/api/ludo-move/<int:game_id>', methods=['POST'])
@login_required
def ludo_move(game_id):
    if not check_ludo_rate_limit(session['user_id'], 'move'):
        return jsonify({'success': False, 'error': 'Ø§Ù†ØªØ¸Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù‚Ø¨Ù„ Ø§Ù„ØªØ­Ø±ÙŠÙƒ Ù…Ø¬Ø¯Ø¯Ø§Ù‹'})
    
    data = request.get_json()
    
    conn = get_db()
    cursor = conn.cursor()
    
    cursor.execute('''
        SELECT * FROM ludo_active_games 
        WHERE id = ? AND (player1_id = ? OR player2_id = ?) AND game_status = 'playing'
    ''', (game_id, session['user_id'], session['user_id']))
    game = cursor.fetchone()
    
    if not game:
        conn.close()
        return jsonify({'success': False, 'error': 'Ø§Ù„Ù„Ø¹Ø¨Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©'})
    
    player_number = 1 if game['player1_id'] == session['user_id'] else 2
    
    if game['current_turn'] != player_number:
        conn.close()
        return jsonify({'success': False, 'error': 'Ù„ÙŠØ³ Ø¯ÙˆØ±Ùƒ'})
    
    position_data = data.get('position')
    
    last_roll = game['last_roll'] if game['last_roll'] else 0
    
    player1_pos_str = game['player1_position']
    player2_pos_str = game['player2_position']
    
    player1_pos = json.loads(player1_pos_str)
    player2_pos = json.loads(player2_pos_str)
    
    if player_number == 1:
        new_player1_pos = position_data
        new_player2_pos = player2_pos
        player_color = 'green'
        old_pieces = player1_pos.get('green', [0, 0, 0, 0])
        new_pieces = position_data.get('green', [0, 0, 0, 0]) if position_data else [0, 0, 0, 0]
    else:
        new_player1_pos = player1_pos
        new_player2_pos = position_data
        player_color = 'blue'
        old_pieces = player2_pos.get('blue', [0, 0, 0, 0])
        new_pieces = position_data.get('blue', [0, 0, 0, 0]) if position_data else [0, 0, 0, 0]
    
    is_valid, validation_message = validate_ludo_move(old_pieces, new_pieces, last_roll, player_color)
    if not is_valid:
        conn.close()
        print(f"âš ï¸ Ù…Ø­Ø§ÙˆÙ„Ø© ØºØ´ Ù…Ø±ÙÙˆØ¶Ø©: {validation_message} - Ø§Ù„Ù„Ø§Ø¹Ø¨ {session['user_id']}")
        log_game_event(game_id, 'invalid_move_attempt', session['user_id'], {
            'dice_roll': last_roll,
            'old_pieces': old_pieces,
            'attempted_pieces': new_pieces,
            'validation_message': validation_message
        })
        return jsonify({'success': False, 'error': validation_message})
    
    log_game_event(game_id, 'piece_move', session['user_id'], {
        'dice_roll': last_roll,
        'player_number': player_number,
        'player_color': player_color,
        'old_pieces': old_pieces,
        'new_pieces': new_pieces
    }, state_before={'player1_pos': player1_pos_str, 'player2_pos': player2_pos_str})
    
    player1_green_steps = new_player1_pos.get('green', [0, 0, 0, 0])
    player2_blue_steps = new_player2_pos.get('blue', [0, 0, 0, 0])
    
    final_player1_pos = {
        'red': new_player1_pos.get('red', [0, 0, 0, 0]),
        'green': list(new_player1_pos.get('green', [0, 0, 0, 0])),
        'yellow': new_player1_pos.get('yellow', [0, 0, 0, 0]),
        'blue': new_player1_pos.get('blue', [0, 0, 0, 0])
    }
    final_player2_pos = {
        'red': new_player2_pos.get('red', [0, 0, 0, 0]),
        'green': new_player2_pos.get('green', [0, 0, 0, 0]),
        'yellow': new_player2_pos.get('yellow', [0, 0, 0, 0]),
        'blue': list(new_player2_pos.get('blue', [0, 0, 0, 0]))
    }
    
    captured_pieces = []
    
    SAFE_CELLS = [3, 5, 22, 34, 48, 50, 55, 67]
    
    GREEN_MAIN_LOOP = [
        3, 6, 9, 12, 15, 59, 58, 57, 56, 55, 54, 60, 66, 67, 68, 69, 70, 71, 
        36, 39, 42, 45, 48, 51, 52, 53, 50, 47, 44, 41, 38, 30, 31, 32, 33, 34, 35, 
        29, 23, 22, 21, 20, 19, 18, 17, 14, 11, 8, 5, 2, 1, 0
    ]
    GREEN_HOME_RUN = [4, 7, 10, 13, 16, None]
    GREEN_PATH = GREEN_MAIN_LOOP + GREEN_HOME_RUN
    
    BLUE_PATH = [
        50, 47, 44, 41, 38, 30, 31, 32, 33, 34, 35, 29, 23, 22, 21, 20, 
        19, 18, 17, 14, 11, 8, 5, 2, 1, 0, 3, 6, 9, 12, 15, 59, 58, 57, 
        56, 55, 54, 60, 66, 67, 68, 69, 70, 71, 36, 39, 42, 45, 48, 51, 
        52, 53, 49, 46, 43, 40, 37, None
    ]
    
    for i, green_step in enumerate(final_player1_pos['green']):
        if green_step > 0 and green_step < 58:
            green_cell_num = GREEN_PATH[green_step - 1] if green_step <= len(GREEN_PATH) else None
            if green_cell_num is not None:
                for j, blue_step in enumerate(final_player2_pos['blue']):
                    if blue_step > 0 and blue_step < 58:
                        blue_cell_num = BLUE_PATH[blue_step - 1] if blue_step <= len(BLUE_PATH) else None
                        if blue_cell_num is not None and green_cell_num == blue_cell_num:
                            if green_cell_num in SAFE_CELLS:
                                print(f"ğŸ›¡ï¸ Ù…Ù†Ø·Ù‚Ø© Ø¢Ù…Ù†Ø© - Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø£ÙƒÙ„ ÙÙŠ Ø§Ù„Ù…Ø±Ø¨Ø¹ {green_cell_num}")
                                continue
                            if player_number == 1:
                                final_player2_pos['blue'][j] = 0
                                captured_pieces.append({'player': 'blue', 'index': j})
                                print(f"ğŸ¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ 1 (Ø£Ø®Ø¶Ø±) Ø£ÙƒÙ„ Ø­Ø¬Ø± Ø£Ø²Ø±Ù‚ Ø±Ù‚Ù… {j} ÙÙŠ Ø§Ù„Ø®Ù„ÙŠØ© {blue_cell_num}")
                            else:
                                final_player1_pos['green'][i] = 0
                                captured_pieces.append({'player': 'green', 'index': i})
                                print(f"ğŸ¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ 2 (Ø£Ø²Ø±Ù‚) Ø£ÙƒÙ„ Ø­Ø¬Ø± Ø£Ø®Ø¶Ø± Ø±Ù‚Ù… {i} ÙÙŠ Ø§Ù„Ø®Ù„ÙŠØ© {blue_cell_num}")
    
    player1_finished = sum(1 for p in final_player1_pos['green'] if p >= 58)
    player2_finished = sum(1 for p in final_player2_pos['blue'] if p >= 58)
    
    game_over = False
    winner_id = None
    result_data = {}
    
    if player1_finished == 4:
        game_over = True
        winner_id = game['player1_id']
    elif player2_finished == 4:
        game_over = True
        winner_id = game['player2_id']
    
    if game_over and winner_id:
        bet_amount = game['bet_amount']
        bet_return = bet_amount
        
        if bet_amount == 0.30:
            prize = 0.20
        elif bet_amount == 1.00:
            prize = 0.80
        elif bet_amount == 3.00:
            prize = 2.50
        elif bet_amount == 5.00:
            prize = 4.00
        elif bet_amount == 10.00:
            prize = 7.00
        elif bet_amount == 50.00:
            prize = 40.00
        else:
            prize = bet_amount * 0.67
        
        cursor.execute('''
            UPDATE ludo_active_games 
            SET player1_position = ?,
                player2_position = ?,
                game_status = 'finished',
                winner_id = ?,
                finished_at = CURRENT_TIMESTAMP,
                waiting_for_piece_selection = 0
            WHERE id = ?
        ''', (json.dumps(final_player1_pos), json.dumps(final_player2_pos), winner_id, game_id))
        
        cursor.execute('UPDATE users SET balance = balance + ? WHERE id = ?', 
                      (bet_return + prize, winner_id))
        
        # Ø¥Ø¶Ø§ÙØ© Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„ÙÙˆØ² ÙˆØ§Ù„Ø®Ø³Ø§Ø±Ø©
        loser_id = game['player2_id'] if winner_id == game['player1_id'] else game['player1_id']
        total_winnings = bet_return + prize
        
        # Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„ÙØ§Ø¦Ø²
        cursor.execute('''
            INSERT INTO notifications (user_id, message)
            VALUES (?, ?)
        ''', (winner_id, f'ğŸ‰ Ù…Ø¨Ø±ÙˆÙƒ! ÙØ²Øª ÙÙŠ Ù„Ø¹Ø¨Ø© Ù„ÙˆØ¯Ùˆ ÙˆØ±Ø¨Ø­Øª {total_winnings:.2f} $'))
        
        # Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø®Ø§Ø³Ø±
        cursor.execute('''
            INSERT INTO notifications (user_id, message)
            VALUES (?, ?)
        ''', (loser_id, f'ğŸ˜” Ù„Ù„Ø£Ø³ÙØŒ Ø®Ø³Ø±Øª ÙÙŠ Ù„Ø¹Ø¨Ø© Ù„ÙˆØ¯Ùˆ'))
        
        conn.commit()
        
        result_data = {
            'i_won': winner_id == session['user_id'],
            'bet_amount': bet_return,
            'prize': prize
        }
        
        conn_end = get_db()
        cursor_end = conn_end.cursor()
        cursor_end.execute('SELECT game_event_version FROM ludo_active_games WHERE id = ?', (game_id,))
        end_row = cursor_end.fetchone()
        end_version = end_row['game_event_version'] if end_row else 0
        conn_end.close()
        
        piece_update = {
            'type': 'piece_move',
            'game_id': game_id,
            'player1_position': json.dumps(final_player1_pos),
            'player2_position': json.dumps(final_player2_pos),
            'current_turn': 3 - player_number,
            'captured_pieces': captured_pieces,
            'bonus_roll': False,
            'game_event_version': end_version
        }
        socketio.emit('ludo_update', piece_update, room=f'ludo_game_{game_id}')
        socketio.emit('ludo_update', piece_update, room=f'ludo_stream_{game_id}')
        
        cursor.execute('''
            UPDATE ludo_active_games 
            SET game_status = 'finished', 
                winner_id = ?,
                finished_at = CURRENT_TIMESTAMP
            WHERE id = ?
        ''', (winner_id, game_id))
        
        conn.commit()
        conn.close()
        
        game_over_update = {
            'type': 'game_over',
            'game_id': game_id,
            'winner_id': winner_id,
            'bet_amount': bet_return,
            'prize': prize,
            'player1_id': game['player1_id'],
            'player2_id': game['player2_id']
        }
        socketio.emit('ludo_update', game_over_update, room=f'ludo_game_{game_id}')
        socketio.emit('ludo_update', game_over_update, room=f'ludo_stream_{game_id}')
        
        def delete_game_after_win(gid, p1_id, p2_id, bet_amt, w_id, p1_final, p2_final):
            time.sleep(1)
            try:
                conn_delayed = get_db()
                cursor_delayed = conn_delayed.cursor()
                
                cursor_delayed.execute('SELECT created_at FROM ludo_active_games WHERE id = ?', (gid,))
                game_row = cursor_delayed.fetchone()
                created_at = game_row['created_at'] if game_row else None
                
                cursor_delayed.execute('''
                    SELECT event_data FROM game_events_log 
                    WHERE game_id = ? AND event_type = 'dice_roll'
                    ORDER BY server_timestamp
                ''', (gid,))
                dice_rolls = [row['event_data'] for row in cursor_delayed.fetchall()]
                
                cursor_delayed.execute('''
                    SELECT event_data FROM game_events_log 
                    WHERE game_id = ? AND event_type IN ('piece_move', 'piece_move_complete')
                    ORDER BY server_timestamp
                ''', (gid,))
                moves = [row['event_data'] for row in cursor_delayed.fetchall()]
                
                cursor_delayed.execute('SELECT balance FROM users WHERE id = ?', (p1_id,))
                p1_balance = cursor_delayed.fetchone()
                balance_after_p1 = p1_balance['balance'] if p1_balance else 0
                
                cursor_delayed.execute('SELECT balance FROM users WHERE id = ?', (p2_id,))
                p2_balance = cursor_delayed.fetchone()
                balance_after_p2 = p2_balance['balance'] if p2_balance else 0
                
                game_duration = len(dice_rolls) * 5
                total_moves = len(moves)
                
                game_string = f"{gid}:{p1_id}:{p2_id}:{w_id}:{bet_amt}:{datetime.now().isoformat()}"
                game_hash = hashlib.sha256(game_string.encode()).hexdigest()[:32]
                
                cursor_delayed.execute('''
                    INSERT INTO ludo_game_history 
                    (game_id, player1_id, player2_id, bet_amount, winner_id, game_duration, total_moves,
                     player1_final_position, player2_final_position, dice_rolls_log, moves_log,
                     balance_after_p1, balance_after_p2, game_hash, created_at, finished_at)
                    VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP)
                ''', (
                    gid, p1_id, p2_id, bet_amt, w_id, game_duration, total_moves,
                    json.dumps(p1_final), json.dumps(p2_final),
                    json.dumps(dice_rolls, ensure_ascii=False),
                    json.dumps(moves, ensure_ascii=False),
                    balance_after_p1, balance_after_p2, game_hash, created_at
                ))
                
                cursor_delayed.execute('DELETE FROM ludo_active_games WHERE id = ?', (gid,))
                conn_delayed.commit()
                conn_delayed.close()
                print(f'âœ… ØªÙ… Ø­ÙØ¸ Ù„Ø¹Ø¨Ø© Ù„ÙˆØ¯Ùˆ {gid} ÙÙŠ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠ ÙˆØ­Ø°ÙÙ‡Ø§ Ø¨Ø¹Ø¯ 1 Ø«Ø§Ù†ÙŠØ©')
            except Exception as e:
                print(f'âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸/Ø­Ø°Ù Ø§Ù„Ù„Ø¹Ø¨Ø©: {e}')
        
        threading.Thread(target=delete_game_after_win, args=(
            game_id, game['player1_id'], game['player2_id'], bet_amount, 
            winner_id, final_player1_pos, final_player2_pos
        ), daemon=True).start()
        
        return jsonify({
            'success': True, 
            'game_over': True,
            'i_won': result_data['i_won'],
            'bet_amount': result_data['bet_amount'],
            'prize': result_data['prize']
        })
    
    next_turn = 3 - player_number
    
    if last_roll == 6:
        next_turn = player_number
        print(f"ğŸ² Ø±Ù…ÙŠØ© Ø¥Ø¶Ø§ÙÙŠØ©! Ø§Ù„Ù„Ø§Ø¹Ø¨ {player_number} ÙŠØ­ØµÙ„ Ø¹Ù„Ù‰ Ø¯ÙˆØ± Ø¥Ø¶Ø§ÙÙŠ Ø¨Ø³Ø¨Ø¨ Ø±Ù…ÙŠ 6")
    
    if len(captured_pieces) > 0:
        next_turn = player_number
        print(f"ğŸ¯ Ø±Ù…ÙŠØ© Ø¥Ø¶Ø§ÙÙŠØ©! Ø§Ù„Ù„Ø§Ø¹Ø¨ {player_number} ÙŠØ­ØµÙ„ Ø¹Ù„Ù‰ Ø¯ÙˆØ± Ø¥Ø¶Ø§ÙÙŠ Ø¨Ø³Ø¨Ø¨ Ø£ÙƒÙ„ Ø­Ø¬Ø± Ø§Ù„Ø®ØµÙ…")
    
    turn_deadline = (datetime.now() + timedelta(seconds=30)).strftime('%Y-%m-%d %H:%M:%S')
    
    cursor.execute(f'''
        UPDATE ludo_active_games 
        SET player1_position = ?,
            player2_position = ?,
            current_turn = ?,
            waiting_for_piece_selection = 0,
            turn_deadline = ?
        WHERE id = ?
    ''', (json.dumps(final_player1_pos), json.dumps(final_player2_pos), next_turn, turn_deadline, game_id))
    
    conn.commit()
    
    log_game_event(game_id, 'piece_move_complete', session['user_id'], {
        'dice_roll': last_roll,
        'player_number': player_number,
        'player_color': player_color,
        'old_pieces': old_pieces,
        'new_pieces': new_pieces,
        'captured_pieces': captured_pieces,
        'next_turn': next_turn,
        'bonus_roll': (last_roll == 6) or (len(captured_pieces) > 0)
    }, state_after={'player1_pos': json.dumps(final_player1_pos), 'player2_pos': json.dumps(final_player2_pos)})
    
    conn.close()
    
    bonus_roll = (last_roll == 6) or (len(captured_pieces) > 0)
    
    conn_version = get_db()
    cursor_version = conn_version.cursor()
    cursor_version.execute('SELECT game_event_version FROM ludo_active_games WHERE id = ?', (game_id,))
    version_row = cursor_version.fetchone()
    current_version = version_row['game_event_version'] if version_row else 0
    conn_version.close()
    
    piece_update = {
        'type': 'piece_move',
        'game_id': game_id,
        'player1_position': json.dumps(final_player1_pos),
        'player2_position': json.dumps(final_player2_pos),
        'current_turn': next_turn,
        'captured_pieces': captured_pieces,
        'bonus_roll': bonus_roll,
        'time_left': 30,
        'game_event_version': current_version
    }
    socketio.emit('ludo_update', piece_update, room=f'ludo_game_{game_id}')
    socketio.emit('ludo_update', piece_update, room=f'ludo_stream_{game_id}')
    
    turn_update = {
        'type': 'turn_change',
        'game_id': game_id,
        'current_turn': next_turn,
        'bonus_roll': bonus_roll,
        'time_left': 30,
        'waiting_for_piece_selection': 0
    }
    socketio.emit('ludo_update', turn_update, room=f'ludo_game_{game_id}')
    socketio.emit('ludo_update', turn_update, room=f'ludo_stream_{game_id}')
    
    return jsonify({'success': True, 'captured_pieces': captured_pieces, 'bonus_roll': bonus_roll})

@app.route('/check-ludo-match/<int:queue_id>')
@login_required
def check_ludo_match(queue_id):
    conn = get_db()
    cursor = conn.cursor()
    
    cursor.execute('''
        SELECT status, matched_user_id, expires_at, bet_amount 
        FROM ludo_matchmaking_queue 
        WHERE id = ?
    ''', (queue_id,))
    queue_entry = cursor.fetchone()
    
    if not queue_entry:
        conn.close()
        return jsonify({'matched': False, 'expired': True})
    
    if queue_entry['status'] == 'matched':
        cursor.execute('''
            SELECT id FROM ludo_active_games 
            WHERE (player1_id = ? OR player2_id = ?) 
            AND game_status = 'playing'
            ORDER BY created_at DESC LIMIT 1
        ''', (session['user_id'], session['user_id']))
        game = cursor.fetchone()
        
        if not game:
            conn.close()
            return jsonify({'matched': False, 'expired': False})
        
        cursor.execute('SELECT username FROM users WHERE id = ?', (queue_entry['matched_user_id'],))
        opponent = cursor.fetchone()
        opponent_name = opponent['username'] if opponent else 'Ù…Ù†Ø§ÙØ³'
        
        conn.close()
        return jsonify({
            'matched': True, 
            'game_id': game['id'],
            'opponent_name': opponent_name
        })
    
    expires_at = datetime.strptime(queue_entry['expires_at'], '%Y-%m-%d %H:%M:%S')
    if datetime.now() > expires_at:
        bet_amount = queue_entry['bet_amount'] if 'bet_amount' in queue_entry.keys() else 0
        cursor.execute('UPDATE users SET balance = balance + ? WHERE id = ?', (bet_amount, session['user_id']))
        cursor.execute('DELETE FROM ludo_matchmaking_queue WHERE id = ?', (queue_id,))
        conn.commit()
        conn.close()
        return jsonify({'matched': False, 'expired': True})
    
    conn.close()
    return jsonify({'matched': False, 'expired': False})

@app.route('/cancel-ludo-matchmaking')
@login_required
def cancel_ludo_matchmaking():
    conn = get_db()
    cursor = conn.cursor()
    
    cursor.execute('''
        SELECT bet_amount FROM ludo_matchmaking_queue 
        WHERE user_id = ? AND status = 'waiting'
    ''', (session['user_id'],))
    queue_entry = cursor.fetchone()
    
    if queue_entry:
        cursor.execute('UPDATE users SET balance = balance + ? WHERE id = ?', 
                      (queue_entry['bet_amount'], session['user_id']))
    
    cursor.execute('DELETE FROM ludo_matchmaking_queue WHERE user_id = ?', 
                  (session['user_id'],))
    conn.commit()
    conn.close()
    
    return redirect(url_for('ludo_game_page'))



@app.route('/forfeit-bet')
@login_required
def forfeit_bet():
    conn = get_db()
    cursor = conn.cursor()
    
    cursor.execute('''
        DELETE FROM matchmaking_queue WHERE user_id = ? AND status = 'waiting'
    ''', (session['user_id'],))
    
    cursor.execute('''
        UPDATE active_games 
        SET game_status = 'forfeited', finished_at = datetime('now')
        WHERE (player1_id = ? OR player2_id = ?) 
        AND game_status = 'playing'
    ''', (session['user_id'], session['user_id']))
    
    conn.commit()
    conn.close()
    
    return redirect(url_for('dashboard'))

@app.route('/exit-active-game')
@login_required
def exit_active_game():
    session['intentional_exit'] = True
    
    conn = get_db()
    cursor = conn.cursor()
    
    cursor.execute('''
        SELECT id, player1_id, player2_id, bet_amount 
        FROM active_games 
        WHERE (player1_id = ? OR player2_id = ?) 
        AND game_status = 'playing'
        LIMIT 1
    ''', (session['user_id'], session['user_id']))
    game = cursor.fetchone()
    
    if game:
        opponent_id = game['player2_id'] if game['player1_id'] == session['user_id'] else game['player1_id']
        
        bet_return = game['bet_amount']
        
        if game['bet_amount'] == 0.30:
            prize = 0.20
        elif game['bet_amount'] == 1.00:
            prize = 0.80
        elif game['bet_amount'] == 3.00:
            prize = 2.50
        elif game['bet_amount'] == 5.00:
            prize = 4.00
        elif game['bet_amount'] == 10.00:
            prize = 7.00
        elif game['bet_amount'] == 50.00:
            prize = 40.00
        else:
            prize = 0.20
        
        cursor.execute('''
            UPDATE active_games 
            SET game_status = 'finished', 
                winner_id = ?,
                finished_at = datetime('now')
            WHERE id = ?
        ''', (opponent_id, game['id']))
        
        cursor.execute('''
            UPDATE users 
            SET balance = balance + ?
            WHERE id = ?
        ''', (bet_return + prize, opponent_id))
        
        conn.commit()
    
    cursor.execute('''
        DELETE FROM matchmaking_queue 
        WHERE user_id = ?
    ''', (session['user_id'],))
    
    conn.commit()
    conn.close()
    return redirect(url_for('dashboard'))

@app.route('/exit-ludo-game')
@login_required
def exit_ludo_game():
    """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø®Ø±ÙˆØ¬ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù…Ù† Ù„Ø¹Ø¨Ø© Ù„ÙˆØ¯Ùˆ Ù…Ø¹ Ù†Ø¸Ø§Ù… Ø­Ù…Ø§ÙŠØ© Ù…ØªÙ‚Ø¯Ù…"""
    session['intentional_exit'] = True
    
    # Ø¬Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ù…Ø§Ù† Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø´Ø±Ø¹ÙŠØ© Ø§Ù„Ø§Ù†Ø³Ø­Ø§Ø¨
    security_data = {
        'ip_address': request.remote_addr,
        'user_agent': request.headers.get('User-Agent', ''),
        'referer': request.headers.get('Referer', ''),
        'origin': request.headers.get('Origin', ''),
        'session_id': session.get('_id', ''),
        'request_method': request.method,
        'timestamp': datetime.now().isoformat()
    }
    
    conn = get_db()
    cursor = conn.cursor()
    
    cursor.execute('''
        SELECT id, player1_id, player2_id, bet_amount 
        FROM ludo_active_games 
        WHERE (player1_id = ? OR player2_id = ?) 
        AND game_status = 'playing'
        LIMIT 1
    ''', (session['user_id'], session['user_id']))
    game = cursor.fetchone()
    
    if game:
        opponent_id = game['player2_id'] if game['player1_id'] == session['user_id'] else game['player1_id']
        
        bet_return = game['bet_amount']
        
        if game['bet_amount'] == 0.30:
            prize = 0.20
        elif game['bet_amount'] == 1.00:
            prize = 0.80
        elif game['bet_amount'] == 3.00:
            prize = 2.50
        elif game['bet_amount'] == 5.00:
            prize = 4.00
        elif game['bet_amount'] == 10.00:
            prize = 7.00
        elif game['bet_amount'] == 50.00:
            prize = 40.00
        else:
            prize = 0.20
        
        cursor.execute('''
            UPDATE ludo_active_games 
            SET game_status = 'forfeited', 
                winner_id = ?,
                finished_at = CURRENT_TIMESTAMP
            WHERE id = ?
        ''', (opponent_id, game['id']))
        
        cursor.execute('''
            UPDATE users 
            SET balance = balance + ?
            WHERE id = ?
        ''', (bet_return + prize, opponent_id))
        
        # ØªØ³Ø¬ÙŠÙ„ Ø­Ø¯Ø« Ø§Ù„Ø§Ù†Ø³Ø­Ø§Ø¨ Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ù…Ø§Ù† Ø§Ù„ÙƒØ§Ù…Ù„Ø©
        log_game_event(game['id'], 'player_forfeit', session['user_id'], {
            'forfeiter_id': session['user_id'],
            'winner_id': opponent_id,
            'bet_amount': game['bet_amount'],
            'forfeit_type': 'voluntary_exit',
            'security': security_data,
            'verification': {
                'has_valid_referer': 'ludo' in security_data['referer'].lower() if security_data['referer'] else False,
                'request_from_game_page': bool(security_data['referer']),
                'normal_user_agent': len(security_data['user_agent']) > 20
            }
        })
        
        # Ø¥Ø¶Ø§ÙØ© Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø§Ù†Ø³Ø­Ø§Ø¨
        total_winnings = bet_return + prize
        
        # Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø®ØµÙ… (Ø§Ù„ÙØ§Ø¦Ø² Ø¨Ø³Ø¨Ø¨ Ø§Ù„Ø§Ù†Ø³Ø­Ø§Ø¨)
        cursor.execute('''
            INSERT INTO notifications (user_id, message)
            VALUES (?, ?)
        ''', (opponent_id, f'ğŸ‰ ÙØ²Øª ÙÙŠ Ù„Ø¹Ø¨Ø© Ù„ÙˆØ¯Ùˆ Ø¨Ø³Ø¨Ø¨ Ø§Ù†Ø³Ø­Ø§Ø¨ Ø§Ù„Ø®ØµÙ… ÙˆØ±Ø¨Ø­Øª {total_winnings:.2f} $'))
        
        # Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ù†Ø³Ø­Ø¨ (Ø§Ù„Ø®Ø§Ø³Ø±)
        cursor.execute('''
            INSERT INTO notifications (user_id, message)
            VALUES (?, ?)
        ''', (session['user_id'], f'âŒ ØªÙ… Ø§Ø¹ØªØ¨Ø§Ø±Ùƒ Ø®Ø§Ø³Ø± ÙÙŠ Ù„Ø¹Ø¨Ø© Ù„ÙˆØ¯Ùˆ Ø¨Ø³Ø¨Ø¨ Ø§Ù„Ø§Ù†Ø³Ø­Ø§Ø¨'))
        
        cursor.execute('''
            DELETE FROM ludo_matchmaking_queue 
            WHERE user_id = ?
        ''', (session['user_id'],))
        
        conn.commit()
        
        game_over_update = {
            'type': 'game_over',
            'game_id': game['id'],
            'winner_id': opponent_id,
            'bet_amount': bet_return,
            'prize': prize,
            'player1_id': game['player1_id'],
            'player2_id': game['player2_id']
        }
        socketio.emit('ludo_update', game_over_update, room=f'ludo_game_{game["id"]}')
        socketio.emit('ludo_update', game_over_update, room=f'ludo_stream_{game["id"]}')
        
        def delete_game_after_exit(gid, p1_id, p2_id, bet_amt, w_id, forfeiter_id):
            time.sleep(1)
            try:
                conn_delayed = get_db()
                cursor_delayed = conn_delayed.cursor()
                
                cursor_delayed.execute('SELECT player1_position, player2_position, created_at FROM ludo_active_games WHERE id = ?', (gid,))
                game_row = cursor_delayed.fetchone()
                if game_row:
                    p1_pos = game_row['player1_position']
                    p2_pos = game_row['player2_position']
                    created_at = game_row['created_at']
                else:
                    p1_pos = '{}'
                    p2_pos = '{}'
                    created_at = None
                
                cursor_delayed.execute('''
                    SELECT event_data FROM game_events_log 
                    WHERE game_id = ? AND event_type = 'dice_roll'
                    ORDER BY server_timestamp
                ''', (gid,))
                dice_rolls = [row['event_data'] for row in cursor_delayed.fetchall()]
                
                cursor_delayed.execute('''
                    SELECT event_data FROM game_events_log 
                    WHERE game_id = ? AND event_type IN ('piece_move', 'piece_move_complete')
                    ORDER BY server_timestamp
                ''', (gid,))
                moves = [row['event_data'] for row in cursor_delayed.fetchall()]
                
                cursor_delayed.execute('SELECT balance FROM users WHERE id = ?', (p1_id,))
                p1_balance = cursor_delayed.fetchone()
                balance_after_p1 = p1_balance['balance'] if p1_balance else 0
                
                cursor_delayed.execute('SELECT balance FROM users WHERE id = ?', (p2_id,))
                p2_balance = cursor_delayed.fetchone()
                balance_after_p2 = p2_balance['balance'] if p2_balance else 0
                
                game_duration = len(dice_rolls) * 5
                total_moves = len(moves)
                
                game_string = f"{gid}:{p1_id}:{p2_id}:{w_id}:{bet_amt}:forfeit:{forfeiter_id}:{datetime.now().isoformat()}"
                game_hash = hashlib.sha256(game_string.encode()).hexdigest()[:32]
                
                cursor_delayed.execute('''
                    INSERT INTO ludo_game_history 
                    (game_id, player1_id, player2_id, bet_amount, winner_id, game_duration, total_moves,
                     player1_final_position, player2_final_position, dice_rolls_log, moves_log,
                     balance_after_p1, balance_after_p2, game_hash, created_at, finished_at)
                    VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP)
                ''', (
                    gid, p1_id, p2_id, bet_amt, w_id, game_duration, total_moves,
                    p1_pos, p2_pos,
                    json.dumps(dice_rolls, ensure_ascii=False),
                    json.dumps(moves, ensure_ascii=False),
                    balance_after_p1, balance_after_p2, game_hash, created_at
                ))
                
                cursor_delayed.execute('DELETE FROM ludo_active_games WHERE id = ?', (gid,))
                conn_delayed.commit()
                conn_delayed.close()
                print(f'âœ… ØªÙ… Ø­ÙØ¸ Ù„Ø¹Ø¨Ø© Ù„ÙˆØ¯Ùˆ {gid} (Ø§Ù†Ø³Ø­Ø§Ø¨) ÙÙŠ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠ ÙˆØ­Ø°ÙÙ‡Ø§')
            except Exception as e:
                print(f'âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸/Ø­Ø°Ù Ø§Ù„Ù„Ø¹Ø¨Ø©: {e}')
        
        threading.Thread(target=delete_game_after_exit, args=(
            game['id'], game['player1_id'], game['player2_id'], 
            game['bet_amount'], opponent_id, session['user_id']
        ), daemon=True).start()
        
        conn.close()
    else:
        cursor.execute('''
            DELETE FROM ludo_matchmaking_queue 
            WHERE user_id = ?
        ''', (session['user_id'],))
        
        conn.commit()
        conn.close()
    
    return redirect(url_for('ludo_game_page'))











def check_and_process_expired_turns(game_id, cursor):
    """ÙØ­Øµ ÙˆÙ…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹"""
    cursor.execute('SELECT * FROM active_games WHERE id = ? AND game_status = "playing"', (game_id,))
    game = cursor.fetchone()
    
    if not game or not game['turn_deadline']:
        return False
    
    try:
        deadline = datetime.strptime(game['turn_deadline'], '%Y-%m-%d %H:%M:%S')
        now = datetime.now()
        
        if now < deadline:
            return False
        
        roll_value = secrets.randbelow(6) + 1
        
        player1_rolls = json.loads(game['player1_rolls'])
        player2_rolls = json.loads(game['player2_rolls'])
        
        if game['current_turn'] == 1:
            player1_rolls.append(roll_value)
            cursor.execute('UPDATE active_games SET player1_rolls = ?, player1_total = ? WHERE id = ?', 
                          (json.dumps(player1_rolls), sum(player1_rolls), game_id))
        else:
            player2_rolls.append(roll_value)
            cursor.execute('UPDATE active_games SET player2_rolls = ?, player2_total = ? WHERE id = ?', 
                          (json.dumps(player2_rolls), sum(player2_rolls), game_id))
        
        max_rounds = 1 if game['is_tiebreaker'] else 3
        
        next_turn = 3 - game['current_turn']
        next_round = game['round_number']
        
        if game['current_turn'] == 2:
            next_round += 1
            next_turn = 1
        
        cursor.execute('''UPDATE active_games 
                          SET current_turn = ?, 
                              round_number = ?, 
                              last_action_time = CURRENT_TIMESTAMP,
                              turn_start_time = CURRENT_TIMESTAMP,
                              turn_deadline = datetime(CURRENT_TIMESTAMP, '+15 seconds')
                          WHERE id = ?''', 
                      (next_turn, next_round, game_id))
        
        if next_round > max_rounds:
            cursor.execute('SELECT * FROM active_games WHERE id = ?', (game_id,))
            game = cursor.fetchone()
            
            p1_total = game['player1_total']
            p2_total = game['player2_total']
            
            if p1_total > p2_total:
                winner_id = game['player1_id']
            elif p2_total > p1_total:
                winner_id = game['player2_id']
            else:
                winner_id = None
            
            if winner_id is None and not game['is_tiebreaker']:
                cursor.execute('''UPDATE active_games 
                                  SET is_tiebreaker = 1, 
                                      current_turn = 1, 
                                      round_number = 1, 
                                      player1_rolls = "[]", 
                                      player2_rolls = "[]", 
                                      player1_total = 0, 
                                      player2_total = 0,
                                      turn_start_time = CURRENT_TIMESTAMP,
                                      turn_deadline = datetime(CURRENT_TIMESTAMP, '+15 seconds')
                                  WHERE id = ?''', (game_id,))
            elif winner_id:
                bet_return = game['bet_amount']
                
                if game['bet_amount'] == 0.30:
                    prize = 0.20
                elif game['bet_amount'] == 1.00:
                    prize = 0.80
                elif game['bet_amount'] == 3.00:
                    prize = 2.50
                elif game['bet_amount'] == 5.00:
                    prize = 4.00
                elif game['bet_amount'] == 10.00:
                    prize = 7.00
                elif game['bet_amount'] == 50.00:
                    prize = 40.00
                else:
                    prize = 0.20
                
                cursor.execute('UPDATE active_games SET winner_id = ?, game_status = "finished", finished_at = CURRENT_TIMESTAMP WHERE id = ?', 
                              (winner_id, game_id))
                cursor.execute('UPDATE users SET balance = balance + ? WHERE id = ?', 
                              (bet_return + prize, winner_id))
            else:
                cursor.execute('UPDATE active_games SET game_status = "finished", finished_at = CURRENT_TIMESTAMP WHERE id = ?', (game_id,))
                cursor.execute('UPDATE users SET balance = balance + ? WHERE id = ?', (game['bet_amount'], game['player1_id']))
                cursor.execute('UPDATE users SET balance = balance + ? WHERE id = ?', (game['bet_amount'], game['player2_id']))
        
        return True
        
    except Exception as e:
        print(f"Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ù…Ù†ØªÙ‡ÙŠ: {e}")
        return False



@app.route('/deposit')
@login_required
def deposit_page():
    if session.get('is_admin'):
        return redirect(url_for('admin_dashboard'))
    
    conn = get_db()
    cursor = conn.cursor()
    
    cursor.execute('SELECT * FROM users WHERE id = ?', (session['user_id'],))
    user = cursor.fetchone()
    
    cursor.execute('''
        SELECT * FROM deposit_requests 
        WHERE user_id = ? 
        ORDER BY created_at DESC 
        LIMIT 10
    ''', (session['user_id'],))
    deposits = cursor.fetchall()
    
    cursor.execute('SELECT * FROM bnb_transactions WHERE user_id = ? ORDER BY created_at DESC LIMIT 10', 
                  (session['user_id'],))
    bnb_transactions = cursor.fetchall()
    
    cursor.execute('SELECT value FROM settings WHERE key = ?', ('deposit_info',))
    result = cursor.fetchone()
    deposit_info = result['value'] if result else DEFAULT_DEPOSIT_INFO
    
    conn.close()
    
    return render_template_string(DEPOSIT_PAGE, 
                                 user=user,
                                 deposits=deposits,
                                 bnb_transactions=bnb_transactions,
                                 bnb_wallet=BNB_WALLET_ADDRESS,
                                 deposit_info=deposit_info,
                                 page='deposit')

@app.route('/verify-bnb-deposit', methods=['POST'])
@login_required
def verify_bnb_deposit():
    """Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ù…Ù„ÙŠØ© BNB ÙˆØ´Ø­Ù† Ø§Ù„Ø­Ø³Ø§Ø¨ - Ù…Ø¹ Ø­Ù…Ø§ÙŠØ© Ø±Ø¨Ø· Ø§Ù„Ù…Ø­ÙØ¸Ø©"""
    data = request.get_json()
    tx_hash = data.get('tx_hash', '').strip()
    
    if not tx_hash:
        return jsonify({'success': False, 'message': 'Ù…Ø¹Ø±Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù…ÙÙ‚ÙˆØ¯'})
    
    conn = get_db()
    cursor = conn.cursor()
    
    cursor.execute('SELECT * FROM bnb_transactions WHERE tx_hash = ?', (tx_hash,))
    existing = cursor.fetchone()
    if existing:
        conn.close()
        return jsonify({'success': False, 'message': 'Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù†Ù‡Ø§ Ù…Ø³Ø¨Ù‚Ø§Ù‹'})
    
    verification = verify_bnb_transaction(tx_hash)
    
    if not verification['valid']:
        conn.close()
        return jsonify({'success': False, 'message': verification.get('error', 'ÙØ´Ù„ Ø§Ù„ØªØ­Ù‚Ù‚')})
    
    amount = verification['amount']
    user_id = session['user_id']
    from_address = verification['from'].lower() if verification['from'] else ''
    
    if not from_address:
        conn.close()
        return jsonify({'success': False, 'message': 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø±Ø³Ù„'})
    
    cursor.execute('''
        SELECT user_id FROM user_bnb_wallets WHERE LOWER(wallet_address) = ?
    ''', (from_address,))
    wallet_owner = cursor.fetchone()
    
    if wallet_owner:
        if wallet_owner['user_id'] != user_id:
            conn.close()
            return jsonify({
                'success': False, 
                'message': 'âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø­ÙØ¸Ø© Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø­Ø³Ø§Ø¨ Ù…Ø³ØªØ®Ø¯Ù… Ø¢Ø®Ø±. Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¹Ù…Ù„ÙŠØ§Øª Ù…Ù† Ù…Ø­Ø§ÙØ¸ Ø§Ù„Ø¢Ø®Ø±ÙŠÙ†.'
            })
    else:
        try:
            cursor.execute('''
                INSERT INTO user_bnb_wallets (user_id, wallet_address, is_verified)
                VALUES (?, ?, 1)
            ''', (user_id, from_address))
            print(f"âœ… ØªÙ… Ø±Ø¨Ø· Ø§Ù„Ù…Ø­ÙØ¸Ø© {from_address[:10]}... Ø¨Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… {user_id} ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹")
        except Exception as e:
            print(f"âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø±Ø¨Ø· Ø§Ù„Ù…Ø­ÙØ¸Ø©: {e}")
    
    try:
        cursor.execute('''
            INSERT INTO bnb_transactions (user_id, tx_hash, amount, status, from_address, to_address, verified_at)
            VALUES (?, ?, ?, 'confirmed', ?, ?, ?)
        ''', (user_id, tx_hash, amount, from_address, verification['to'], datetime.now().isoformat()))
        
        cursor.execute('UPDATE users SET balance = balance + ? WHERE id = ?', (amount, user_id))
        
        conn.commit()
        conn.close()
        
        return jsonify({
            'success': True, 
            'message': f'âœ… ØªÙ… Ø´Ø­Ù† {amount} BNB Ø¨Ù†Ø¬Ø§Ø­!',
            'amount': amount
        })
    except Exception as e:
        conn.rollback()
        conn.close()
        return jsonify({'success': False, 'message': f'Ø®Ø·Ø£: {str(e)}'})

@app.route('/withdraw')
@login_required
def withdraw_page():
    if session.get('is_admin'):
        return redirect(url_for('admin_dashboard'))
    
    conn = get_db()
    cursor = conn.cursor()
    
    cursor.execute('SELECT * FROM users WHERE id = ?', (session['user_id'],))
    user = cursor.fetchone()
    
    cursor.execute('''
        SELECT * FROM withdrawal_requests 
        WHERE user_id = ? 
        ORDER BY created_at DESC 
        LIMIT 10
    ''', (session['user_id'],))
    withdrawals = cursor.fetchall()
    
    cursor.execute('''
        SELECT id, amount, created_at FROM withdrawal_requests 
        WHERE user_id = ? AND status = 'pending'
        ORDER BY created_at DESC LIMIT 1
    ''', (session['user_id'],))
    pending_withdrawal = cursor.fetchone()
    
    conn.close()
    
    return render_template_string(WITHDRAW_PAGE, 
                                 user=user,
                                 withdrawals=withdrawals,
                                 has_pending_withdrawal=pending_withdrawal is not None,
                                 pending_withdrawal=pending_withdrawal,
                                 page='withdraw')

@app.route('/profile')
@login_required
def profile_page():
    if session.get('is_admin'):
        return redirect(url_for('admin_dashboard'))
    
    conn = get_db()
    cursor = conn.cursor()
    
    cursor.execute('SELECT * FROM users WHERE id = ?', (session['user_id'],))
    user = cursor.fetchone()
    
    conn.close()
    
    return render_template_string(PROFILE_PAGE, 
                                 user=user,
                                 page='profile')

@app.route('/notifications')
@login_required
def notifications_page():
    if session.get('is_admin'):
        return redirect(url_for('admin_dashboard'))
    
    conn = get_db()
    cursor = conn.cursor()
    
    cursor.execute('SELECT * FROM users WHERE id = ?', (session['user_id'],))
    user = cursor.fetchone()
    
    cursor.execute('''
        SELECT * FROM notifications 
        WHERE user_id = ? 
        ORDER BY created_at DESC 
        LIMIT 50
    ''', (session['user_id'],))
    notifications = cursor.fetchall()
    
    cursor.execute('''
        UPDATE notifications 
        SET is_read = 1 
        WHERE user_id = ? AND is_read = 0
    ''', (session['user_id'],))
    conn.commit()
    conn.close()
    
    return render_template_string(NOTIFICATIONS_PAGE, 
                                 user=user,
                                 notifications=notifications,
                                 page='notifications')

MATCHMAKING_PAGE = '''
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†Ø§ÙØ³</title>
    <style>
        /* Ø¨Ø¯ÙˆÙ† ÙˆÙ…ÙŠØ¶ - Ù†Ø¸Ø§Ù… SPA ÙŠØ­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ù„ÙÙŠØ© */
        /* Ø¨Ø¯ÙˆÙ† ÙˆÙ…ÙŠØ¶ - Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø£ØµÙ„ÙŠØ© ØªØ¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ù…Ø´Ø§ÙƒÙ„ */
        /* Ø¨Ø¯ÙˆÙ† ÙˆÙ…ÙŠØ¶ - Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø£ØµÙ„ÙŠØ© ØªØ¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ù…Ø´Ø§ÙƒÙ„ */
    </style>
    <style>
        /* Ø¨Ø¯ÙˆÙ† ÙˆÙ…ÙŠØ¶ - Ù†Ø¸Ø§Ù… SPA ÙŠØ­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ù„ÙÙŠØ© */
        /* Ø¨Ø¯ÙˆÙ† ÙˆÙ…ÙŠØ¶ - Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø£ØµÙ„ÙŠØ© ØªØ¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ù…Ø´Ø§ÙƒÙ„ */
        /* Ø¨Ø¯ÙˆÙ† ÙˆÙ…ÙŠØ¶ - Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø£ØµÙ„ÙŠØ© ØªØ¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ù…Ø´Ø§ÙƒÙ„ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a3a2e 0%, #0d1f1a 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            color: white;
            overflow: hidden;
        }
        
        .back-button {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            color: white;
            font-size: 24px;
            z-index: 100;
        }
        
        .back-button:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }
        
        .countdown-timer {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.5);
            border: 3px solid #d4af37;
            border-radius: 50%;
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: bold;
            color: #d4af37;
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.5);
            z-index: 10;
        }
        
        .prize-banner {
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(212, 175, 55, 0.5);
            border-radius: 15px;
            padding: 15px 30px;
            margin: 120px auto 50px;
            display: flex;
            align-items: center;
            gap: 15px;
            justify-content: center;
        }
        
        .prize-label {
            font-size: 18px;
            font-weight: 600;
            color: #d4af37;
        }
        
        .diamond-icon {
            font-size: 24px;
        }
        
        .prize-amount {
            font-size: 28px;
            font-weight: bold;
            color: white;
        }
        
        .arena-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .players-container {
            display: flex;
            align-items: center;
            gap: 60px;
            margin-bottom: 60px;
        }
        
        .player {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        
        .player-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 5px solid #d4af37;
            background: linear-gradient(135deg, #2a4a3e 0%, #1a3a2e 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            box-shadow: 0 8px 30px rgba(212, 175, 55, 0.3);
            position: relative;
        }
        
        .searching-avatar {
            border-color: #4a6a5e;
        }
        
        .searching-avatar::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 5px solid transparent;
            border-top-color: #d4af37;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .vs-text {
            font-size: 56px;
            font-weight: bold;
            background: linear-gradient(135deg, #f4e5b5 0%, #d4af37 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 20px rgba(212, 175, 55, 0.5);
        }
        
        .player-name {
            font-size: 20px;
            font-weight: 600;
            color: white;
        }
        
        .searching-text {
            color: #8bc34a;
            font-size: 18px;
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .cancel-button {
            background: rgba(231, 76, 60, 0.8);
            color: white;
            border: 2px solid rgba(231, 76, 60, 1);
            border-radius: 12px;
            padding: 15px 50px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }
        
        .cancel-button:hover {
            background: rgba(231, 76, 60, 1);
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(231, 76, 60, 0.4);
        }
        
        .no-match-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(231, 76, 60, 0.95);
            color: white;
            padding: 30px 50px;
            border-radius: 15px;
            font-size: 20px;
            font-weight: 600;
            text-align: center;
            display: none;
            z-index: 1000;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }
        
        .match-found-message {
            position: fixed;
            top: 42%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #4CAF50 0%, #66BB6A 100%);
            color: white;
            padding: 8px 60px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            text-align: center;
            display: none;
            z-index: 1000;
            box-shadow: 0 10px 40px rgba(76, 175, 80, 0.6);
            animation: scaleIn 0.5s ease-out;
            border: 2px solid #2E7D32;
            min-width: 300px;
            height: 50px;
            line-height: 34px;
        }
        
        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.5);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }
        
        .match-found-message .icon {
            font-size: 20px;
            display: inline-block;
            margin: 0 5px;
        }
        
        .match-found-message .opponent-name {
            font-size: 16px;
            margin: 0;
            color: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            display: inline;
            font-weight: bold;
        }
        
        .match-found-message .countdown-small {
            font-size: 18px;
            margin: 0;
            color: #C8E6C9;
            font-weight: 700;
            display: inline-block;
            text-shadow: 0 2px 8px rgba(129, 199, 132, 0.5);
        }
        
        .countdown-timer.green {
            background: linear-gradient(135deg, #4CAF50, #81C784);
            border-color: #2E7D32;
            color: white;
            box-shadow: 0 0 30px rgba(76, 175, 80, 0.7);
        }
        
        .warning-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        
        .warning-modal {
            background: linear-gradient(135deg, #1a3a2e 0%, #0d1f1a 100%);
            border: 3px solid #d4af37;
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(212, 175, 55, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }
        
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .warning-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }
        
        .warning-title {
            font-size: 24px;
            font-weight: bold;
            color: #d4af37;
            margin-bottom: 15px;
        }
        
        .warning-message {
            font-size: 18px;
            color: white;
            margin-bottom: 30px;
            line-height: 1.6;
        }
        
        .warning-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        
        .warning-btn {
            padding: 15px 40px;
            font-size: 18px;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .warning-btn-exit {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }
        
        .warning-btn-exit:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(231, 76, 60, 0.5);
        }
        
        .warning-btn-stay {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
        }
        
        .warning-btn-stay:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(39, 174, 96, 0.5);
        }
        
        @media (max-width: 768px) {
            .countdown-timer {
                width: 60px;
                height: 60px;
                font-size: 24px;
            }
            
            .players-container {
                gap: 30px;
            }
            
            .player-avatar {
                width: 100px;
                height: 100px;
                font-size: 40px;
            }
            
            .vs-text {
                font-size: 40px;
            }
            
            .prize-banner {
                margin: 100px auto 40px;
                padding: 12px 20px;
            }
            
            .prize-amount {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    
    <div class="countdown-timer" id="countdown">40</div>
    
    <div class="prize-banner">
        <span class="prize-label">Ù…Ø¨Ù„Øº Ø±Ù‡Ø§Ù†Ùƒ Ù‡Ùˆ:</span>
        <span class="prize-amount">{{ "%.2f"|format(bet_amount) }} $</span>
    </div>
    
    <div class="arena-container">
        <div class="players-container">
            <div class="player">
                <div class="player-avatar">
                    ğŸ‘¤
                </div>
                <div class="player-name">{{ user['username'] }}</div>
            </div>
            
            <div class="vs-text">VS</div>
            
            <div class="player">
                <div class="player-avatar searching-avatar">
                    â³
                </div>
                <div class="searching-text">...Search</div>
            </div>
        </div>
    </div>
    
    <div class="no-match-message" id="noMatchMsg">
        Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù†Ø§ÙØ³ Ø­Ø§Ù„ÙŠØ§Ù‹
    </div>
    
    <div class="match-found-message" id="matchFoundMsg">
        <span class="icon">âœ…</span>
        <span>ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù†Ø§ÙØ³: </span>
        <span class="opponent-name" id="opponentNameDisplay"></span>
    </div>
    
    <div class="warning-overlay" id="warningOverlay">
        <div class="warning-modal">
            <div class="warning-icon">âš ï¸</div>
            <div class="warning-title">ØªØ­Ø°ÙŠØ±</div>
            <div class="warning-message">ÙÙŠ Ø­Ø§Ù„ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø³ØªÙÙ‚Ø¯ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø±Ù‡Ø§Ù†</div>
            <div class="warning-buttons">
                <button class="warning-btn warning-btn-exit" onclick="confirmExit()">Ø®Ø±ÙˆØ¬</button>
                <button class="warning-btn warning-btn-stay" onclick="closeWarning()">Ø§Ù„Ø¨Ù‚Ø§Ø¡</button>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        let countdown = 40;
        const countdownEl = document.getElementById('countdown');
        const noMatchMsg = document.getElementById('noMatchMsg');
        const matchFoundMsg = document.getElementById('matchFoundMsg');
        const opponentNameDisplay = document.getElementById('opponentNameDisplay');
        const warningOverlay = document.getElementById('warningOverlay');
        let matchCheckInterval;
        let isMatched = false;
        let warningShown = false;
        let matchFoundProcessing = false;
        let socket = null;
        
        const alreadyMatched = {{ 'true' if already_matched else 'false' }};
        const gameId = {{ game_id }};
        const opponentNamePre = '{{ opponent_name }}';
        const gameType = '{{ game_type if game_type is defined else "dice" }}';
        const queueId = {{ queue_id }};
        
        countdownEl.textContent = countdown;
        countdownEl.classList.remove('green');
        
        console.log('ğŸ• Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ Ù…Ù† 40 Ø«Ø§Ù†ÙŠØ©');
        
        history.pushState(null, null, location.href);
        
        window.addEventListener('popstate', function(e) {
            history.pushState(null, null, location.href);
            
            if (!warningShown) {
                warningShown = true;
                warningOverlay.style.display = 'flex';
            }
        });
        
        window.addEventListener('beforeunload', function(e) {
            if (isMatched || matchFoundProcessing) {
                return;
            }
            
            e.preventDefault();
            e.returnValue = 'ÙÙŠ Ø­Ø§Ù„ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø³ØªÙÙ‚Ø¯ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø±Ù‡Ø§Ù†';
            return 'ÙÙŠ Ø­Ø§Ù„ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø³ØªÙÙ‚Ø¯ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø±Ù‡Ø§Ù†';
        });
        
        window.addEventListener('pagehide', function(e) {
            if (!isMatched && !matchFoundProcessing && !e.persisted) {
                navigator.sendBeacon('{{ url_for("forfeit_bet") }}');
            }
        });
        
        function closeWarning() {
            warningShown = false;
            warningOverlay.style.display = 'none';
        }
        
        function confirmExit() {
            if (isMatched || matchFoundProcessing) {
                warningOverlay.style.display = 'none';
                return;
            }
            isMatched = true;
            warningOverlay.style.display = 'none';
            if (gameType === 'ludo') {
                window.location.href = '{{ url_for("cancel_ludo_matchmaking") }}';
            } else {
                window.location.href = '{{ url_for("forfeit_bet") }}';
            }
        }
        
        function handleMatchFound(opponentName, gId) {
            console.log('ğŸ¯ handleMatchFound Ø¨Ø¯Ø£Øª Ø§Ù„ØªÙ†ÙÙŠØ°');
            console.log('Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø§ÙØ³:', opponentName);
            console.log('Ù…Ø¹Ø±Ù Ø§Ù„Ù„Ø¹Ø¨Ø©:', gId);
            
            isMatched = true;
            matchFoundProcessing = true;
            console.log('âœ… ØªÙ… ØªØ¹ÙŠÙŠÙ† isMatched Ùˆ matchFoundProcessing');
            
            if (warningOverlay.style.display === 'flex') {
                warningOverlay.style.display = 'none';
            }
            warningShown = false;
            
            const searchingAvatar = document.querySelector('.searching-avatar');
            const searchingText = document.querySelector('.searching-text');
            
            if (searchingAvatar) {
                searchingAvatar.classList.remove('searching-avatar');
                searchingAvatar.innerHTML = 'ğŸ‘¤';
                console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†Ø§ÙØ³');
            }
            if (searchingText) {
                searchingText.textContent = opponentName;
                searchingText.classList.remove('searching-text');
                searchingText.style.color = 'white';
                console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø§ÙØ³');
            }
            
            opponentNameDisplay.textContent = opponentName;
            console.log('âœ… ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø§ÙØ³ ÙÙŠ Ø§Ù„Ø±Ø³Ø§Ù„Ø©');
            
            matchFoundMsg.style.display = 'block';
            console.log('âœ…âœ…âœ… ØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø¶Ø±Ø§Ø¡!');
            console.log('Ø­Ø§Ù„Ø© matchFoundMsg.style.display:', matchFoundMsg.style.display);
            
            countdownEl.classList.add('green');
            console.log('âœ… ØªÙ… ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø®Ø¶Ø±');
            console.log('classList:', countdownEl.classList.toString());
            
            let startCountdown = 5;
            countdownEl.textContent = startCountdown;
            console.log('âœ… Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø¨Ø¯Ø£ Ù…Ù† 5');
            
            const matchTimer = setInterval(() => {
                startCountdown--;
                countdownEl.textContent = startCountdown;
                console.log('â±ï¸ Ø§Ù„Ø¹Ø¯Ø§Ø¯:', startCountdown);
                
                if (startCountdown <= 0) {
                    clearInterval(matchTimer);
                    console.log('ğŸš€ Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ø³Ø§Ø­Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©...');
                    if (gameType === 'ludo') {
                        window.location.href = '/ludo-arena/' + gId;
                    } else {
                        window.location.href = '/game-arena/' + gId;
                    }
                }
            }, 1000);
            
            console.log('âœ… handleMatchFound Ø§Ù†ØªÙ‡Øª Ø¨Ù†Ø¬Ø§Ø­');
        }
        
        if (alreadyMatched) {
            handleMatchFound(opponentNamePre, gameId);
        } else {
            countdownEl.classList.remove('green');
            countdownEl.textContent = countdown;
            
            const localTimer = setInterval(() => {
                if (isMatched || matchFoundProcessing) {
                    clearInterval(localTimer);
                    return;
                }
                
                countdown--;
                countdownEl.textContent = countdown;
                console.log('â±ï¸ Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ:', countdown);
                
                if (countdown <= 0) {
                    clearInterval(localTimer);
                    noMatchMsg.style.display = 'block';
                    setTimeout(() => {
                        if (gameType === 'ludo') {
                            window.location.href = '{{ url_for("ludo_game_page") }}';
                        } else {
                            window.location.href = '{{ url_for("ludo_game_page") }}';
                        }
                    }, 1500);
                }
            }, 1000);
            
            socket = io({
                transports: ['websocket', 'polling'],
                upgrade: true,
                rememberUpgrade: true,
                reconnection: true,
                reconnectionDelay: 500,
                reconnectionAttempts: 10
            });
            
            socket.on('connect', () => {
                console.log('âœ… Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ± - Socket ID:', socket.id);
                socket.emit('join_matchmaking', { 
                    queue_id: queueId, 
                    game_type: gameType 
                });
                console.log('ğŸ“¤ ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„ØºØ±ÙØ© Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©');
            });
            
            socket.on('disconnect', (reason) => {
                console.log('âŒ Ø§Ù†Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±:', reason);
            });
            
            socket.on('reconnect', (attemptNumber) => {
                console.log('ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ± - Ù…Ø­Ø§ÙˆÙ„Ø©:', attemptNumber);
                socket.emit('join_matchmaking', { 
                    queue_id: queueId, 
                    game_type: gameType 
                });
            });
            
            socket.on('timer_update', (data) => {
                countdown = data.time_left;
                countdownEl.textContent = countdown;
                console.log('ğŸ• Timer Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±:', countdown);
            });
            
            socket.on('joined_queue', (data) => {
                console.log('âœ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ØºØ±ÙØ©:', data);
            });
            
            socket.on('match_found', (data) => {
                console.log('ğŸ‰ğŸ‰ğŸ‰ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù†Ø§ÙØ³ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±!', data);
                console.log('Game ID:', data.game_id);
                console.log('Opponent:', data.opponent_name);
                console.log('Queue ID:', data.queue_id);
                
                if (!isMatched && !matchFoundProcessing) {
                    const opponentName = data.opponent_name || 'Ù…Ù†Ø§ÙØ³';
                    console.log('ğŸ“¢ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ handleMatchFound...');
                    handleMatchFound(opponentName, data.game_id);
                    
                    if (socket) {
                        setTimeout(() => {
                            socket.disconnect();
                        }, 1000);
                    }
                } else {
                    console.log('âš ï¸ ØªÙ… ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± - Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© ØªÙ…Øª Ø¨Ø§Ù„ÙØ¹Ù„');
                }
            });
            
            socket.on('matchmaking_expired', () => {
                console.log('â° Ø§Ù†ØªÙ‡Øª Ù…Ø¯Ø© Ø§Ù„Ø¨Ø­Ø«');
                if (socket) {
                    socket.disconnect();
                }
                noMatchMsg.style.display = 'block';
                setTimeout(() => {
                    if (gameType === 'ludo') {
                        window.location.href = '{{ url_for("ludo_game_page") }}';
                    } else {
                        window.location.href = '{{ url_for("ludo_game_page") }}';
                    }
                }, 1000);
            });
            
            socket.on('connect_error', (error) => {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„:', error);
            });
            
            matchCheckInterval = setInterval(() => {
                if (isMatched || matchFoundProcessing) {
                    clearInterval(matchCheckInterval);
                    return;
                }
                
                const checkUrl = gameType === 'ludo' ? 
                    '/check-ludo-match/' + queueId : 
                    '/check-match/' + queueId;
                    
                fetch(checkUrl)
                    .then(response => response.json())
                    .then(data => {
                        if (data.matched) {
                            console.log('ğŸ” [Polling] ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù†Ø§ÙØ³ Ù…Ù† Ø§Ù„ÙØ­Øµ Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ!', data);
                            clearInterval(matchCheckInterval);
                            
                            const opponentName = data.opponent_name || 'Ù…Ù†Ø§ÙØ³';
                            handleMatchFound(opponentName, data.game_id);
                            
                            if (socket) {
                                setTimeout(() => {
                                    socket.disconnect();
                                }, 1000);
                            }
                        } else if (data.expired) {
                            console.log('â° [Polling] Ø§Ù†ØªÙ‡Øª Ù…Ø¯Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±');
                            clearInterval(matchCheckInterval);
                            if (socket) {
                                socket.disconnect();
                            }
                            noMatchMsg.style.display = 'block';
                            setTimeout(() => {
                                if (gameType === 'ludo') {
                                    window.location.href = '{{ url_for("ludo_game_page") }}';
                                } else {
                                    window.location.href = '{{ url_for("ludo_game_page") }}';
                                }
                            }, 1000);
                        }
                    })
                    .catch(error => {
                        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©:', error);
                    });
            }, 1000);
        }
    </script>
</body>
</html>
'''


@app.route('/admin')
@admin_required
def admin_dashboard():
    conn = get_db()
    cursor = conn.cursor()
    
    cursor.execute('''
        SELECT d.*, u.username 
        FROM deposit_requests d 
        JOIN users u ON d.user_id = u.id 
        WHERE d.status = 'pending' 
        ORDER BY d.created_at ASC
    ''')
    deposits = cursor.fetchall()
    
    cursor.execute('''
        SELECT w.*, u.username 
        FROM withdrawal_requests w 
        JOIN users u ON w.user_id = u.id 
        WHERE w.status = 'pending' 
        ORDER BY w.created_at ASC
    ''')
    withdrawals = cursor.fetchall()
    
    cursor.execute('SELECT * FROM users WHERE is_admin = 0 ORDER BY created_at DESC')
    users = cursor.fetchall()
    
    cursor.execute('SELECT COUNT(*) as count FROM deposit_requests WHERE status = ?', ('pending',))
    pending_deposits = cursor.fetchone()['count']
    
    cursor.execute('SELECT COUNT(*) as count FROM withdrawal_requests WHERE status = ?', ('pending',))
    pending_withdrawals = cursor.fetchone()['count']
    
    cursor.execute('SELECT COUNT(*) as count FROM users WHERE is_admin = 0')
    total_users = cursor.fetchone()['count']
    
    cursor.execute('SELECT value FROM settings WHERE key = ?', ('deposit_info',))
    result = cursor.fetchone()
    deposit_info = result['value'] if result else DEFAULT_DEPOSIT_INFO
    
    cursor.execute('''
        SELECT s.*, u.username 
        FROM support_tickets s 
        JOIN users u ON s.user_id = u.id 
        WHERE s.status = 'pending' 
        ORDER BY s.created_at ASC
    ''')
    pending_support_tickets = cursor.fetchall()
    
    cursor.execute('''
        SELECT s.*, u.username 
        FROM support_tickets s 
        JOIN users u ON s.user_id = u.id 
        WHERE s.status = 'under_review' 
        ORDER BY s.created_at ASC
    ''')
    review_tickets = cursor.fetchall()
    
    support_tickets = list(pending_support_tickets) + list(review_tickets)
    
    cursor.execute('SELECT COUNT(*) as count FROM support_tickets WHERE status = ?', ('pending',))
    pending_tickets = cursor.fetchone()['count']
    
    conn.close()
    
    return render_template_string(ADMIN_PAGE,
                                 deposits=deposits,
                                 withdrawals=withdrawals,
                                 users=users,
                                 pending_deposits=pending_deposits,
                                 pending_withdrawals=pending_withdrawals,
                                 total_users=total_users,
                                 deposit_info=deposit_info,
                                 support_tickets=support_tickets,
                                 pending_tickets=pending_tickets)

@app.route('/submit-deposit', methods=['POST'])
@login_required
def submit_deposit():
    if 'photo' not in request.files:
        return jsonify({'success': False, 'message': 'Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø©'})
    
    photo = request.files['photo']
    if photo.filename == '':
        return jsonify({'success': False, 'message': 'Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø©'})
    
    photo_bytes = photo.read()
    
    is_valid, error_msg = validate_image(photo_bytes)
    if not is_valid:
        return jsonify({'success': False, 'message': f'âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØµÙˆØ±Ø©: {error_msg}'})
    
    photo_data = compress_image(photo_bytes, quality=30, max_size=(800, 800))
    
    conn = get_db()
    cursor = conn.cursor()
    
    # Ù…Ù†Ø¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ØªÙƒØ±Ø±Ø© - ÙØ­Øµ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø·Ù„Ø¨ Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù…Ù† Ù†ÙØ³ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø¨ØºØ¶ Ø§Ù„Ù†Ø¸Ø± Ø¹Ù† Ø§Ù„ÙˆÙ‚Øª)
    cursor.execute('''
        SELECT COUNT(*) as count FROM deposit_requests 
        WHERE user_id = ? AND status = ?
    ''', (session['user_id'], 'pending'))
    
    if cursor.fetchone()['count'] > 0:
        conn.close()
        return jsonify({'success': False, 'message': 'Ù„Ø§ÙŠÙ…ÙƒÙ† Ù…Ø¹Ø§Ù„Ø¬Øª Ù†ÙØ³ Ø·Ù„Ø¨ Ù…Ø±ØªÙŠÙ†ØŒ Ø§Ù†ØªØ¸Ø± Ø­ØªÙ‰ ÙŠØªÙ… Ù…Ø¹Ø§Ù„Ø¬Øª Ø·Ù„Ø¨Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ'})
    
    cursor.execute('''
        INSERT INTO deposit_requests (user_id, photo_data)
        VALUES (?, ?)
    ''', (session['user_id'], photo_data))
    conn.commit()
    
    # Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯
    deposit_id = cursor.lastrowid
    
    # Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆØ§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    cursor.execute('SELECT created_at FROM deposit_requests WHERE id = ?', (deposit_id,))
    deposit = cursor.fetchone()
    created_at = deposit['created_at'][:10] if deposit else ''
    
    # Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    cursor.execute('SELECT username FROM users WHERE id = ?', (session['user_id'],))
    user = cursor.fetchone()
    username = user['username'] if user else 'Ù…Ø³ØªØ®Ø¯Ù…'
    
    conn.close()
    
    # Ø£Ø±Ø³Ù„ Ø¥Ø´Ø§Ø±Ø© WebSocket Ù„Ù„Ø¹Ù…ÙŠÙ„ Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ù„Ø¨ ÙÙˆØ±Ø§Ù‹
    socketio.emit('new_deposit_created', {
        'deposit_id': deposit_id,
        'created_at': created_at
    }, room=f"user_{session['user_id']}")
    
    # Ø£Ø±Ø³Ù„ Ø¥Ø´Ø¹Ø§Ø± ÙÙˆØ±ÙŠ Ù„Ù„Ø£Ø¯Ù…Ù†
    socketio.emit('admin_new_deposit', {
        'deposit': {
            'id': deposit_id,
            'username': username,
            'created_at': created_at,
            'photo_data': photo_data
        }
    }, room='admin_room')
    print(f'ğŸ“ ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø·Ù„Ø¨ Ø´Ø­Ù† Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø£Ø¯Ù…Ù† - Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: {username}')
    
    return jsonify({
        'success': True, 
        'message': 'âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø´Ø­Ù† Ø¥Ù„Ù‰ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø¨Ù†Ø¬Ø§Ø­',
        'deposit_id': deposit_id
    })

withdrawal_rate_limits = {}
WITHDRAWAL_RATE_LIMIT_SECONDS = 10

@app.route('/submit-withdrawal', methods=['POST'])
@login_required
def submit_withdrawal():
    user_id = session['user_id']
    current_time = time.time()
    
    is_ajax = request.headers.get('X-Requested-With') == 'XMLHttpRequest' or request.is_json
    
    if user_id in withdrawal_rate_limits:
        last_time = withdrawal_rate_limits[user_id]
        if current_time - last_time < WITHDRAWAL_RATE_LIMIT_SECONDS:
            if is_ajax:
                return jsonify({'success': False, 'message': 'âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø¨Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø¢Ø®Ø±'})
            flash('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø¨Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø¢Ø®Ø±')
            return redirect(url_for('withdraw_page'))
    
    withdrawal_rate_limits[user_id] = current_time
    
    method = request.form.get('method')
    account_info = request.form.get('account_info')
    try:
        amount = float(request.form.get('amount'))
    except (ValueError, TypeError):
        if is_ajax:
            return jsonify({'success': False, 'message': 'âš ï¸ Ø§Ù„Ù…Ø¨Ù„Øº ØºÙŠØ± ØµØ­ÙŠØ­'})
        flash('âš ï¸ Ø§Ù„Ù…Ø¨Ù„Øº ØºÙŠØ± ØµØ­ÙŠØ­')
        return redirect(url_for('withdraw_page'))
    
    conn = get_db()
    cursor = conn.cursor()
    
    cursor.execute('''
        SELECT id, amount, created_at FROM withdrawal_requests 
        WHERE user_id = ? AND status = 'pending'
        ORDER BY created_at DESC LIMIT 1
    ''', (user_id,))
    pending_withdrawal = cursor.fetchone()
    
    if pending_withdrawal:
        conn.close()
        if is_ajax:
            return jsonify({'success': False, 'message': 'âš ï¸ Ù„Ø¯ÙŠÙƒ Ø·Ù„Ø¨ Ø³Ø­Ø¨ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¨Ø§Ù„ÙØ¹Ù„. ÙŠØ±Ø¬Ù‰ Ø§Ù†ØªØ¸Ø§Ø± Ù…Ø¹Ø§Ù„Ø¬ØªÙ‡ Ù‚Ø¨Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯.'})
        flash('âš ï¸ Ù„Ø¯ÙŠÙƒ Ø·Ù„Ø¨ Ø³Ø­Ø¨ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¨Ø§Ù„ÙØ¹Ù„. ÙŠØ±Ø¬Ù‰ Ø§Ù†ØªØ¸Ø§Ø± Ù…Ø¹Ø§Ù„Ø¬ØªÙ‡ Ù‚Ø¨Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯.')
        return redirect(url_for('withdraw_page'))
    
    cursor.execute('SELECT balance FROM users WHERE id = ?', (user_id,))
    user = cursor.fetchone()
    
    if amount < 1.0:
        if is_ajax:
            conn.close()
            return jsonify({'success': False, 'message': 'Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø³Ø­Ø¨ 1.00 $'})
        flash('Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø³Ø­Ø¨ 1.00 $')
        conn.close()
        return redirect(url_for('withdraw_page'))
    
    if amount > user['balance']:
        if is_ajax:
            conn.close()
            return jsonify({'success': False, 'message': 'Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙŠ'})
        flash('Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙŠ')
        conn.close()
        return redirect(url_for('withdraw_page'))
    
    cursor.execute('UPDATE users SET balance = balance - ? WHERE id = ?', (amount, user_id))
    cursor.execute('''
        INSERT INTO withdrawal_requests (user_id, amount, method, account_info)
        VALUES (?, ?, ?, ?)
    ''', (user_id, amount, method, account_info))
    withdrawal_id = cursor.lastrowid
    
    cursor.execute('SELECT created_at FROM withdrawal_requests WHERE id = ?', (withdrawal_id,))
    withdrawal_data = cursor.fetchone()
    created_at = withdrawal_data['created_at'][:10] if withdrawal_data else datetime.now().strftime('%Y-%m-%d')
    
    new_balance = user['balance'] - amount
    
    cursor.execute('SELECT username FROM users WHERE id = ?', (user_id,))
    user_data = cursor.fetchone()
    username = user_data['username'] if user_data else 'Ù…Ø³ØªØ®Ø¯Ù…'
    
    conn.commit()
    conn.close()
    
    socketio.emit('new_withdrawal_created', {
        'withdrawal_id': withdrawal_id,
        'created_at': created_at,
        'amount': amount,
        'method': method,
        'new_balance': new_balance
    }, room=f"user_{user_id}")
    print(f'ğŸ“ ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø·Ù„Ø¨ Ø³Ø­Ø¨ Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… {username}')
    
    socketio.emit('admin_new_withdrawal', {
        'withdrawal': {
            'id': withdrawal_id,
            'username': username,
            'amount': amount,
            'method': method,
            'account_info': account_info,
            'created_at': created_at
        }
    }, room='admin_room')
    print(f'ğŸ’° ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø·Ù„Ø¨ Ø³Ø­Ø¨ Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø£Ø¯Ù…Ù† - Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: {username} - Ø§Ù„Ù…Ø¨Ù„Øº: {amount}')
    
    if is_ajax:
        return jsonify({
            'success': True,
            'message': 'âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨ Ø¨Ù†Ø¬Ø§Ø­',
            'withdrawal_id': withdrawal_id,
            'new_balance': new_balance
        })
    
    flash('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨ Ø¨Ù†Ø¬Ø§Ø­')
    return redirect(url_for('withdraw_page'))

@app.route('/create-game', methods=['POST'])
@login_required
def create_game():
    bet_amount = float(request.form.get('bet_amount'))
    
    conn = get_db()
    cursor = conn.cursor()
    cursor.execute('SELECT balance FROM users WHERE id = ?', (session['user_id'],))
    user = cursor.fetchone()
    
    if bet_amount < 1.0:
        flash('Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø±Ù‡Ø§Ù† 1.00 $')
        conn.close()
        return redirect(url_for('games_page'))
    
    if bet_amount > user['balance']:
        flash('Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙŠ')
        conn.close()
        return redirect(url_for('games_page'))
    
    cursor.execute('UPDATE users SET balance = balance - ? WHERE id = ?', (bet_amount, session['user_id']))
    
    cursor.execute('''
        INSERT INTO game_rooms (game_type, bet_amount, max_players)
        VALUES ('dice_1v1', ?, 2)
    ''', (bet_amount,))
    room_id = cursor.lastrowid
    
    cursor.execute('''
        INSERT INTO game_players (room_id, user_id)
        VALUES (?, ?)
    ''', (room_id, session['user_id']))
    
    conn.commit()
    conn.close()
    
    flash('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ© Ø¨Ù†Ø¬Ø§Ø­ØŒ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø«Ø§Ù†ÙŠ')
    return redirect(url_for('games_page'))

@app.route('/join-game/<int:room_id>', methods=['POST'])
@login_required
def join_game(room_id):
    conn = get_db()
    cursor = conn.cursor()
    
    cursor.execute('SELECT * FROM game_rooms WHERE id = ? AND status = ?', (room_id, 'waiting'))
    room = cursor.fetchone()
    
    if not room:
        flash('Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ØªØ§Ø­Ø©')
        conn.close()
        return redirect(url_for('games_page'))
    
    cursor.execute('SELECT balance FROM users WHERE id = ?', (session['user_id'],))
    user = cursor.fetchone()
    
    if room['bet_amount'] > user['balance']:
        flash('Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙŠ')
        conn.close()
        return redirect(url_for('games_page'))
    
    cursor.execute('SELECT COUNT(*) as count FROM game_players WHERE room_id = ? AND user_id = ?', (room_id, session['user_id']))
    if cursor.fetchone()['count'] > 0:
        flash('Ø£Ù†Øª Ù…Ø´ØªØ±Ùƒ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ØºØ±ÙØ©')
        conn.close()
        return redirect(url_for('games_page'))
    
    cursor.execute('UPDATE users SET balance = balance - ? WHERE id = ?', (room['bet_amount'], session['user_id']))
    
    cursor.execute('''
        INSERT INTO game_players (room_id, user_id)
        VALUES (?, ?)
    ''', (room_id, session['user_id']))
    
    dice_result = secrets.randbelow(6) + 1
    
    cursor.execute('''
        UPDATE game_rooms 
        SET status = 'finished', result = ?, started_at = CURRENT_TIMESTAMP, finished_at = CURRENT_TIMESTAMP
        WHERE id = ?
    ''', (dice_result, room_id))
    
    cursor.execute('SELECT user_id FROM game_players WHERE room_id = ?', (room_id,))
    players = cursor.fetchall()
    
    winner_id = random.choice(players)['user_id']
    total_pot = room['bet_amount'] * 2
    
    cursor.execute('UPDATE game_players SET won = 1, profit = ? WHERE room_id = ? AND user_id = ?', 
                  (total_pot, room_id, winner_id))
    cursor.execute('UPDATE users SET balance = balance + ? WHERE id = ?', (total_pot, winner_id))
    
    for player in players:
        if player['user_id'] == winner_id:
            message = f"ğŸ‰ Ù…Ø¨Ø±ÙˆÙƒ! ÙØ²Øª ÙÙŠ Ø§Ù„Ù„Ø¹Ø¨Ø© #{room_id} ÙˆØ±Ø¨Ø­Øª {total_pot:.2f} $\nÙ†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ø±Ø¯: {DICE_EMOJIS[dice_result]}"
        else:
            message = f"ğŸ˜” Ù„Ù„Ø£Ø³ÙØŒ Ø®Ø³Ø±Øª ÙÙŠ Ø§Ù„Ù„Ø¹Ø¨Ø© #{room_id}\nÙ†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ø±Ø¯: {DICE_EMOJIS[dice_result]}"
        
        cursor.execute('''
            INSERT INTO notifications (user_id, message)
            VALUES (?, ?)
        ''', (player['user_id'], message))
    
    conn.commit()
    conn.close()
    
    if winner_id == session['user_id']:
        flash(f'ğŸ‰ Ù…Ø¨Ø±ÙˆÙƒ! ÙØ²Øª ÙˆØ±Ø¨Ø­Øª {total_pot:.2f} $')
    else:
        flash(f'ğŸ˜” Ù„Ù„Ø£Ø³ÙØŒ Ø®Ø³Ø±Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø¬ÙˆÙ„Ø©')
    
    return redirect(url_for('games_page'))

@app.route('/change-username', methods=['POST'])
@login_required
def change_username():
    new_username = request.form.get('new_username', '').strip()
    
    if len(new_username) < 3 or len(new_username) > 15:
        flash('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨ÙŠÙ† 3 Ùˆ 15 Ø­Ø±Ù')
        return redirect(url_for('games_page'))
    
    if contains_emoji(new_username):
        flash('Ù„Ø§ ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ ÙÙŠ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…')
        return redirect(url_for('games_page'))
    
    if has_bad_words(new_username):
        flash('Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… ØºÙŠØ± Ù…Ù‚Ø¨ÙˆÙ„')
        return redirect(url_for('games_page'))
    
    conn = get_db()
    cursor = conn.cursor()
    
    cursor.execute('SELECT last_username_change FROM users WHERE id = ?', (session['user_id'],))
    user = cursor.fetchone()
    
    if user['last_username_change']:
        last_change = datetime.fromisoformat(user['last_username_change'])
        next_change = last_change + timedelta(days=30)
        if datetime.now() < next_change:
            days_left = (next_change - datetime.now()).days
            flash(f'ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø¹Ø¯ {days_left} ÙŠÙˆÙ…')
            conn.close()
            return redirect(url_for('games_page'))
    
    cursor.execute('SELECT id FROM users WHERE username = ? AND id != ?', (new_username, session['user_id']))
    if cursor.fetchone():
        flash('Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… ØªÙ… Ø§Ø®ØªÙŠØ§Ø±Ù‡ Ù…Ù† Ù‚Ø¨Ù„')
        conn.close()
        return redirect(url_for('games_page'))
    
    cursor.execute('''
        UPDATE users 
        SET username = ?, last_username_change = CURRENT_TIMESTAMP
        WHERE id = ?
    ''', (new_username, session['user_id']))
    conn.commit()
    conn.close()
    
    session['username'] = new_username
    flash('ØªÙ… ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­')
    return redirect(url_for('games_page'))

@app.route('/api/change-username', methods=['POST'])
@login_required
def api_change_username():
    data = request.get_json()
    new_username = data.get('new_username', '').strip() if data else ''
    
    if len(new_username) < 3 or len(new_username) > 15:
        return jsonify({'success': False, 'message': 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨ÙŠÙ† 3 Ùˆ 15 Ø­Ø±Ù'})
    
    if contains_emoji(new_username):
        return jsonify({'success': False, 'message': 'Ù„Ø§ ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ ÙÙŠ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…'})
    
    if has_bad_words(new_username):
        return jsonify({'success': False, 'message': 'Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… ØºÙŠØ± Ù…Ù‚Ø¨ÙˆÙ„'})
    
    conn = get_db()
    cursor = conn.cursor()
    
    cursor.execute('SELECT last_username_change FROM users WHERE id = ?', (session['user_id'],))
    user = cursor.fetchone()
    
    if user['last_username_change']:
        last_change = datetime.fromisoformat(user['last_username_change'])
        next_change = last_change + timedelta(days=30)
        if datetime.now() < next_change:
            days_left = (next_change - datetime.now()).days
            conn.close()
            return jsonify({'success': False, 'message': f'ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø¹Ø¯ {days_left} ÙŠÙˆÙ…'})
    
    cursor.execute('SELECT id FROM users WHERE username = ? AND id != ?', (new_username, session['user_id']))
    if cursor.fetchone():
        conn.close()
        return jsonify({'success': False, 'message': 'Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… ØªÙ… Ø§Ø®ØªÙŠØ§Ø±Ù‡ Ù…Ù† Ù‚Ø¨Ù„'})
    
    cursor.execute('''
        UPDATE users 
        SET username = ?, last_username_change = CURRENT_TIMESTAMP
        WHERE id = ?
    ''', (new_username, session['user_id']))
    conn.commit()
    conn.close()
    
    session['username'] = new_username
    return jsonify({'success': True, 'message': 'ØªÙ… ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­', 'new_username': new_username})

@app.route('/api/support/submit', methods=['POST'])
@login_required
def submit_support_ticket():
    data = request.get_json()
    if not data:
        return jsonify({'success': False, 'error': 'Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ§Ù„Ø­Ø©'})
    
    category = data.get('category', '').strip()
    message = data.get('message', '').strip()
    
    if not category or not message:
        return jsonify({'success': False, 'error': 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„'})
    
    category_names = {
        'withdrawal': 'Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø³Ø­Ø¨',
        'deposit': 'Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø´Ø­Ù†',
        'cheat': 'Ø´ÙƒÙˆÙ‰ Ø¶Ø¯ Ø§Ù„ØºØ´',
        'other': 'Ø´ÙŠØ¡ Ø¢Ø®Ø±'
    }
    
    if category not in category_names:
        return jsonify({'success': False, 'error': 'ÙØ¦Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø©'})
    
    conn = get_db()
    cursor = conn.cursor()
    
    try:
        cursor.execute('''
            INSERT INTO support_tickets (user_id, category, message, status, created_at)
            VALUES (?, ?, ?, 'pending', CURRENT_TIMESTAMP)
        ''', (session['user_id'], category, message))
        conn.commit()
        conn.close()
        return jsonify({'success': True, 'message': 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­'})
    except Exception as e:
        conn.close()
        return jsonify({'success': False, 'error': 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„'})

@app.route('/api/admin-messages')
@login_required
def get_admin_messages():
    conn = get_db()
    cursor = conn.cursor()
    
    cursor.execute('''
        SELECT id, message, is_read, created_at 
        FROM notifications 
        WHERE user_id = ? AND message LIKE '%Ø±Ø¯ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©%'
        ORDER BY created_at DESC
        LIMIT 50
    ''', (session['user_id'],))
    
    messages = cursor.fetchall()
    conn.close()
    
    result = []
    for msg in messages:
        result.append({
            'id': msg['id'],
            'message': msg['message'],
            'is_read': msg['is_read'] == 1,
            'date': msg['created_at'][:16] if msg['created_at'] else ''
        })
    
    return jsonify({'messages': result})

@app.route('/api/unread-messages-count')
@login_required
def get_unread_messages_count():
    conn = get_db()
    cursor = conn.cursor()
    
    cursor.execute('''
        SELECT COUNT(*) as count 
        FROM notifications 
        WHERE user_id = ? AND is_read = 0 AND message LIKE '%Ø±Ø¯ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©%'
    ''', (session['user_id'],))
    
    result = cursor.fetchone()
    conn.close()
    
    return jsonify({'count': result['count'] if result else 0})

@app.route('/api/mark-message-read', methods=['POST'])
@login_required
def mark_message_read():
    data = request.get_json()
    if not data:
        return jsonify({'success': False})
    
    message_id = data.get('message_id')
    if not message_id:
        return jsonify({'success': False})
    
    conn = get_db()
    cursor = conn.cursor()
    
    cursor.execute('''
        UPDATE notifications 
        SET is_read = 1 
        WHERE id = ? AND user_id = ?
    ''', (message_id, session['user_id']))
    
    conn.commit()
    conn.close()
    
    return jsonify({'success': True})

@app.route('/api/stream-earnings')
@login_required
def get_stream_earnings():
    """Ø¬Ù„Ø¨ Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…"""
    user_id = session['user_id']
    
    try:
        conn = get_db()
        cursor = conn.cursor()
        
        cursor.execute('''
            SELECT COALESCE(SUM(calculated_value), 0) as total_earnings, COUNT(*) as total_gifts
            FROM stream_gift_transactions
            WHERE receiver_id = ? AND status = 'completed'
        ''', (user_id,))
        totals = cursor.fetchone()
        total_earnings = float(totals['total_earnings']) if totals else 0
        total_gifts = int(totals['total_gifts']) if totals else 0
        
        cursor.execute('''
            SELECT s.id, s.game_id, s.started_at, s.ended_at, s.total_earnings,
                   CASE 
                       WHEN s.ended_at IS NOT NULL 
                       THEN (julianday(s.ended_at) - julianday(s.started_at)) * 24 * 60
                       ELSE (julianday('now') - julianday(s.started_at)) * 24 * 60
                   END as duration_minutes
            FROM ludo_streams s
            WHERE s.streamer_id = ?
            ORDER BY s.started_at DESC
            LIMIT 50
        ''', (user_id,))
        streams_rows = cursor.fetchall()
        
        streams = []
        for stream in streams_rows:
            stream_id = stream['id']
            
            cursor.execute('''
                SELECT g.gift_emoji, g.gift_name, g.calculated_value, u.username as sender_name
                FROM stream_gift_transactions g
                JOIN users u ON g.sender_id = u.id
                WHERE g.stream_id = ? AND g.status = 'completed'
                ORDER BY g.created_at DESC
                LIMIT 20
            ''', (stream_id,))
            gifts_rows = cursor.fetchall()
            
            cursor.execute('''
                SELECT COUNT(*) as count FROM stream_gift_transactions
                WHERE stream_id = ? AND status = 'completed'
            ''', (stream_id,))
            gifts_count_row = cursor.fetchone()
            gifts_count = gifts_count_row['count'] if gifts_count_row else 0
            
            gifts = []
            for g in gifts_rows:
                gifts.append({
                    'emoji': g['gift_emoji'] or 'ğŸ',
                    'name': g['gift_name'],
                    'value': float(g['calculated_value']),
                    'sender': g['sender_name']
                })
            
            streams.append({
                'id': stream_id,
                'game_id': stream['game_id'],
                'started_at': stream['started_at'],
                'ended_at': stream['ended_at'],
                'earnings': float(stream['total_earnings'] or 0),
                'duration_minutes': float(stream['duration_minutes'] or 0),
                'gifts_count': gifts_count,
                'gifts': gifts
            })
        
        conn.close()
        
        return jsonify({
            'success': True,
            'total_earnings': total_earnings,
            'total_gifts': total_gifts,
            'streams': streams
        })
        
    except Exception as e:
        print(f'âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ø¨Ø«: {e}')
        import traceback
        traceback.print_exc()
        return jsonify({
            'success': False,
            'error': 'Ø­Ø¯Ø« Ø®Ø·Ø£',
            'total_earnings': 0,
            'total_gifts': 0,
            'streams': []
        })

@app.route('/api/streaming-requirements')
@login_required
def get_streaming_requirements():
    """Ø¬Ù„Ø¨ ØªÙ‚Ø¯Ù… Ø´Ø±ÙˆØ· ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±"""
    user_id = session['user_id']
    
    try:
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ù†Ø­ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ Ø£ÙˆÙ„Ø§Ù‹
        conn = get_db()
        cursor = conn.cursor()
        cursor.execute('SELECT streaming_enabled, streaming_granted_free FROM users WHERE id = ?', (user_id,))
        user = cursor.fetchone()
        conn.close()
        
        streaming_granted_free = user['streaming_granted_free'] == 1 if user and user['streaming_granted_free'] else False
        
        progress_data = get_streaming_requirements_progress(user_id)
        return jsonify({
            'success': True,
            'streaming_granted_free': streaming_granted_free,
            **progress_data
        })
    except Exception as e:
        print(f'âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø´Ø±ÙˆØ· Ø§Ù„Ø¨Ø«: {e}')
        return jsonify({
            'success': False,
            'error': 'Ø­Ø¯Ø« Ø®Ø·Ø£',
            'progress': {},
            'all_completed': False,
            'streaming_enabled': False,
            'streaming_granted_free': False
        })

@app.route('/api/check-streaming-enabled')
@login_required
def check_streaming_enabled():
    """Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙØ¹ÙŠÙ„ Ù…ÙŠØ²Ø© Ø§Ù„Ø¨Ø« Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…"""
    user_id = session['user_id']
    is_enabled = check_user_streaming_enabled(user_id)
    return jsonify({
        'success': True,
        'streaming_enabled': is_enabled
    })

@app.route('/admin/api/resolve-ticket', methods=['POST'])
@admin_required
def resolve_support_ticket():
    data = request.get_json()
    if not data:
        return jsonify({'success': False, 'error': 'Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ§Ù„Ø­Ø©'})
    
    ticket_id = data.get('ticket_id')
    if not ticket_id:
        return jsonify({'success': False, 'error': 'Ù…Ø¹Ø±Ù Ø§Ù„ØªØ°ÙƒØ±Ø© Ù…ÙÙ‚ÙˆØ¯'})
    
    conn = get_db()
    cursor = conn.cursor()
    
    try:
        cursor.execute('''
            UPDATE support_tickets 
            SET status = 'resolved', processed_at = CURRENT_TIMESTAMP, processed_by = ?
            WHERE id = ?
        ''', (session['user_id'], ticket_id))
        conn.commit()
        conn.close()
        return jsonify({'success': True, 'message': 'ØªÙ… Ø­Ù„ Ø§Ù„Ø´ÙƒÙˆÙ‰ Ø¨Ù†Ø¬Ø§Ø­'})
    except Exception as e:
        conn.close()
        return jsonify({'success': False, 'error': 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©'})

@app.route('/admin/api/reply-ticket', methods=['POST'])
@admin_required
def reply_support_ticket():
    data = request.get_json()
    if not data:
        return jsonify({'success': False, 'error': 'Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ§Ù„Ø­Ø©'})
    
    ticket_id = data.get('ticket_id')
    reply = data.get('reply', '').strip()
    
    if not ticket_id:
        return jsonify({'success': False, 'error': 'Ù…Ø¹Ø±Ù Ø§Ù„ØªØ°ÙƒØ±Ø© Ù…ÙÙ‚ÙˆØ¯'})
    
    if not reply:
        return jsonify({'success': False, 'error': 'Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø±Ø¯'})
    
    conn = get_db()
    cursor = conn.cursor()
    
    try:
        cursor.execute('SELECT user_id, category FROM support_tickets WHERE id = ?', (ticket_id,))
        ticket = cursor.fetchone()
        
        if not ticket:
            conn.close()
            return jsonify({'success': False, 'error': 'Ø§Ù„Ø´ÙƒÙˆÙ‰ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©'})
        
        cursor.execute('''
            UPDATE support_tickets 
            SET status = 'resolved', admin_response = ?, processed_at = CURRENT_TIMESTAMP, processed_by = ?
            WHERE id = ?
        ''', (reply, session['user_id'], ticket_id))
        
        category_names = {
            'withdrawal': 'Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø³Ø­Ø¨',
            'deposit': 'Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø´Ø­Ù†'
        }
        category_name = category_names.get(ticket['category'], 'Ø´ÙƒÙˆÙ‰')
        
        cursor.execute('''
            INSERT INTO notifications (user_id, message, is_read, created_at)
            VALUES (?, ?, 0, CURRENT_TIMESTAMP)
        ''', (ticket['user_id'], f"ğŸ“© Ø±Ø¯ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø¹Ù„Ù‰ Ø´ÙƒÙˆØ§Ùƒ ({category_name}):\n{reply}"))
        
        conn.commit()
        conn.close()
        return jsonify({'success': True, 'message': 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯ Ø¨Ù†Ø¬Ø§Ø­'})
    except Exception as e:
        conn.close()
        return jsonify({'success': False, 'error': 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©'})

@app.route('/admin/api/transfer-ticket', methods=['POST'])
@admin_required
def transfer_support_ticket():
    data = request.get_json()
    if not data:
        return jsonify({'success': False, 'error': 'Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ§Ù„Ø­Ø©'})
    
    ticket_id = data.get('ticket_id')
    if not ticket_id:
        return jsonify({'success': False, 'error': 'Ù…Ø¹Ø±Ù Ø§Ù„ØªØ°ÙƒØ±Ø© Ù…ÙÙ‚ÙˆØ¯'})
    
    conn = get_db()
    cursor = conn.cursor()
    
    try:
        cursor.execute('SELECT user_id, category FROM support_tickets WHERE id = ?', (ticket_id,))
        ticket = cursor.fetchone()
        
        if not ticket:
            conn.close()
            return jsonify({'success': False, 'error': 'Ø§Ù„Ø´ÙƒÙˆÙ‰ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©'})
        
        cursor.execute('''
            UPDATE support_tickets 
            SET status = 'under_review', processed_at = CURRENT_TIMESTAMP, processed_by = ?
            WHERE id = ?
        ''', (session['user_id'], ticket_id))
        
        category_names = {
            'cheat': 'Ø´ÙƒÙˆÙ‰ Ø¶Ø¯ Ø§Ù„ØºØ´',
            'other': 'Ø´ÙŠØ¡ Ø¢Ø®Ø±'
        }
        category_name = category_names.get(ticket['category'], 'Ø´ÙƒÙˆÙ‰')
        
        cursor.execute('''
            INSERT INTO notifications (user_id, message, is_read, created_at)
            VALUES (?, ?, 0, CURRENT_TIMESTAMP)
        ''', (ticket['user_id'], f"ğŸ”„ ØªÙ… ØªØ­ÙˆÙŠÙ„ Ø´ÙƒÙˆØ§Ùƒ ({category_name}) Ø¥Ù„Ù‰ Ù‚Ø³Ù… Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©. Ø³ÙŠØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ù‚Ø±ÙŠØ¨Ø§Ù‹."))
        
        conn.commit()
        conn.close()
        return jsonify({'success': True, 'message': 'ØªÙ… ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø´ÙƒÙˆÙ‰ Ø¥Ù„Ù‰ Ù‚Ø³Ù… Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¨Ù†Ø¬Ø§Ø­'})
    except Exception as e:
        conn.close()
        return jsonify({'success': False, 'error': 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©'})

@app.route('/admin/api/cheat-audit', methods=['POST'])
@admin_required
def cheat_audit():
    """API Ù„Ù„ÙØ­Øµ Ø§Ù„Ø°ÙƒÙŠ Ø¶Ø¯ Ø§Ù„ØºØ´"""
    data = request.get_json()
    if not data:
        return jsonify({'success': False, 'error': 'Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ§Ù„Ø­Ø©'})
    
    ticket_id = data.get('ticket_id')
    if not ticket_id:
        return jsonify({'success': False, 'error': 'Ù…Ø¹Ø±Ù Ø§Ù„ØªØ°ÙƒØ±Ø© Ù…ÙÙ‚ÙˆØ¯'})
    
    conn = get_db()
    cursor = conn.cursor()
    
    try:
        cursor.execute('SELECT user_id, category FROM support_tickets WHERE id = ?', (ticket_id,))
        ticket = cursor.fetchone()
        
        if not ticket:
            conn.close()
            return jsonify({'success': False, 'error': 'Ø§Ù„Ø´ÙƒÙˆÙ‰ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©'})
        
        if ticket['category'] != 'cheat':
            conn.close()
            return jsonify({'success': False, 'error': 'Ù‡Ø°Ù‡ Ù„ÙŠØ³Øª Ø´ÙƒÙˆÙ‰ ØºØ´'})
        
        conn.close()
        
        audit_result = perform_cheat_audit(ticket_id, ticket['user_id'])
        
        return jsonify({
            'success': True,
            'audit': audit_result
        })
    except Exception as e:
        conn.close()
        return jsonify({'success': False, 'error': f'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ÙØ­Øµ: {str(e)}'})

@app.route('/admin/api/resolve-review-ticket', methods=['POST'])
@admin_required
def resolve_review_ticket():
    data = request.get_json()
    if not data:
        return jsonify({'success': False, 'error': 'Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ§Ù„Ø­Ø©'})
    
    ticket_id = data.get('ticket_id')
    if not ticket_id:
        return jsonify({'success': False, 'error': 'Ù…Ø¹Ø±Ù Ø§Ù„ØªØ°ÙƒØ±Ø© Ù…ÙÙ‚ÙˆØ¯'})
    
    conn = get_db()
    cursor = conn.cursor()
    
    try:
        cursor.execute('SELECT user_id, category FROM support_tickets WHERE id = ?', (ticket_id,))
        ticket = cursor.fetchone()
        
        if not ticket:
            conn.close()
            return jsonify({'success': False, 'error': 'Ø§Ù„Ø´ÙƒÙˆÙ‰ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©'})
        
        cursor.execute('''
            UPDATE support_tickets 
            SET status = 'resolved', processed_at = CURRENT_TIMESTAMP, processed_by = ?
            WHERE id = ?
        ''', (session['user_id'], ticket_id))
        
        category_names = {
            'cheat': 'Ø´ÙƒÙˆÙ‰ Ø¶Ø¯ Ø§Ù„ØºØ´',
            'other': 'Ø´ÙŠØ¡ Ø¢Ø®Ø±'
        }
        category_name = category_names.get(ticket['category'], 'Ø´ÙƒÙˆÙ‰')
        
        cursor.execute('''
            INSERT INTO notifications (user_id, message, is_read, created_at)
            VALUES (?, ?, 0, CURRENT_TIMESTAMP)
        ''', (ticket['user_id'], f"âœ… ØªÙ… Ø­Ù„ Ø´ÙƒÙˆØ§Ùƒ ({category_name}) Ø¨Ù†Ø¬Ø§Ø­. Ø´ÙƒØ±Ø§Ù‹ Ù„ØªÙˆØ§ØµÙ„Ùƒ Ù…Ø¹Ù†Ø§."))
        
        conn.commit()
        conn.close()
        return jsonify({'success': True, 'message': 'ØªÙ… Ø­Ù„ Ø§Ù„Ø´ÙƒÙˆÙ‰ Ø¨Ù†Ø¬Ø§Ø­'})
    except Exception as e:
        conn.close()
        return jsonify({'success': False, 'error': 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©'})

@app.route('/admin/api/reply-review-ticket', methods=['POST'])
@admin_required
def reply_review_ticket():
    data = request.get_json()
    if not data:
        return jsonify({'success': False, 'error': 'Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ§Ù„Ø­Ø©'})
    
    ticket_id = data.get('ticket_id')
    reply = data.get('reply', '').strip()
    
    if not ticket_id:
        return jsonify({'success': False, 'error': 'Ù…Ø¹Ø±Ù Ø§Ù„ØªØ°ÙƒØ±Ø© Ù…ÙÙ‚ÙˆØ¯'})
    
    if not reply:
        return jsonify({'success': False, 'error': 'Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø±Ø¯'})
    
    conn = get_db()
    cursor = conn.cursor()
    
    try:
        cursor.execute('SELECT user_id, category FROM support_tickets WHERE id = ?', (ticket_id,))
        ticket = cursor.fetchone()
        
        if not ticket:
            conn.close()
            return jsonify({'success': False, 'error': 'Ø§Ù„Ø´ÙƒÙˆÙ‰ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©'})
        
        cursor.execute('''
            UPDATE support_tickets 
            SET status = 'resolved', admin_response = ?, processed_at = CURRENT_TIMESTAMP, processed_by = ?
            WHERE id = ?
        ''', (reply, session['user_id'], ticket_id))
        
        category_names = {
            'cheat': 'Ø´ÙƒÙˆÙ‰ Ø¶Ø¯ Ø§Ù„ØºØ´',
            'other': 'Ø´ÙŠØ¡ Ø¢Ø®Ø±'
        }
        category_name = category_names.get(ticket['category'], 'Ø´ÙƒÙˆÙ‰')
        
        cursor.execute('''
            INSERT INTO notifications (user_id, message, is_read, created_at)
            VALUES (?, ?, 0, CURRENT_TIMESTAMP)
        ''', (ticket['user_id'], f"ğŸ“© Ø±Ø¯ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø¹Ù„Ù‰ Ø´ÙƒÙˆØ§Ùƒ ({category_name}):\n{reply}"))
        
        conn.commit()
        conn.close()
        return jsonify({'success': True, 'message': 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯ Ø¨Ù†Ø¬Ø§Ø­'})
    except Exception as e:
        conn.close()
        return jsonify({'success': False, 'error': 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©'})

@app.route('/admin/search-user', methods=['POST'])
@admin_required
def admin_search_user():
    username = request.form.get('username', '').strip()
    
    conn = get_db()
    cursor = conn.cursor()
    cursor.execute('SELECT id, username, balance FROM users WHERE username = ?', (username,))
    user = cursor.fetchone()
    conn.close()
    
    if user:
        return jsonify({
            'found': True,
            'user_id': user['id'],
            'username': user['username'],
            'balance': user['balance']
        })
    else:
        return jsonify({
            'found': False
        })

@app.route('/admin/api/search-user', methods=['POST'])
@admin_required
def admin_api_search_user():
    data = request.get_json()
    username = data.get('username', '').strip() if data else ''
    
    conn = get_db()
    cursor = conn.cursor()
    cursor.execute('SELECT id, username, balance, is_banned FROM users WHERE username = ?', (username,))
    user = cursor.fetchone()
    conn.close()
    
    if user:
        return jsonify({
            'found': True,
            'user_id': user['id'],
            'username': user['username'],
            'balance': user['balance'],
            'is_banned': user['is_banned'] == 1
        })
    else:
        return jsonify({
            'found': False
        })

@app.route('/admin/api/set-balance', methods=['POST'])
@admin_required
def admin_api_set_balance():
    data = request.get_json()
    user_id = data.get('user_id') if data else None
    new_balance = data.get('new_balance') if data else None
    
    if not user_id or new_balance is None:
        return jsonify({'success': False, 'message': 'Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©'})
    
    if new_balance < 0:
        return jsonify({'success': False, 'message': 'Ø§Ù„Ø±ØµÙŠØ¯ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† Ø³Ø§Ù„Ø¨Ø§Ù‹'})
    
    conn = get_db()
    cursor = conn.cursor()
    
    cursor.execute('SELECT id FROM users WHERE id = ?', (user_id,))
    if not cursor.fetchone():
        conn.close()
        return jsonify({'success': False, 'message': 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'})
    
    cursor.execute('UPDATE users SET balance = ? WHERE id = ?', (new_balance, user_id))
    conn.commit()
    conn.close()
    
    return jsonify({'success': True, 'message': 'ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø±ØµÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­'})

@app.route('/admin/api/ban-user', methods=['POST'])
@admin_required
def admin_api_ban_user():
    data = request.get_json()
    user_id = data.get('user_id') if data else None
    
    if not user_id:
        return jsonify({'success': False, 'message': 'Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©'})
    
    conn = get_db()
    cursor = conn.cursor()
    
    cursor.execute('SELECT id, is_admin FROM users WHERE id = ?', (user_id,))
    user = cursor.fetchone()
    
    if not user:
        conn.close()
        return jsonify({'success': False, 'message': 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'})
    
    if user['is_admin'] == 1:
        conn.close()
        return jsonify({'success': False, 'message': 'Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø¸Ø± Ø§Ù„Ù…Ø´Ø±Ù'})
    
    cursor.execute('UPDATE users SET is_banned = 1, session_id = NULL WHERE id = ?', (user_id,))
    conn.commit()
    conn.close()
    
    return jsonify({'success': True, 'message': 'ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­'})

@app.route('/admin/api/unban-user', methods=['POST'])
@admin_required
def admin_api_unban_user():
    data = request.get_json()
    user_id = data.get('user_id') if data else None
    
    if not user_id:
        return jsonify({'success': False, 'message': 'Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©'})
    
    conn = get_db()
    cursor = conn.cursor()
    
    cursor.execute('SELECT id FROM users WHERE id = ?', (user_id,))
    if not cursor.fetchone():
        conn.close()
        return jsonify({'success': False, 'message': 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'})
    
    cursor.execute('UPDATE users SET is_banned = 0 WHERE id = ?', (user_id,))
    conn.commit()
    conn.close()
    
    return jsonify({'success': True, 'message': 'ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­'})

@app.route('/admin/api/refund-user', methods=['POST'])
@admin_required
def admin_api_refund_user():
    """ØªØ¹ÙˆÙŠØ¶ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ØªØ¶Ø±Ø± Ù…Ù† Ø§Ù„ØºØ´"""
    data = request.get_json()
    user_id = data.get('user_id') if data else None
    amount = data.get('amount') if data else None
    reason = data.get('reason', 'ØªØ¹ÙˆÙŠØ¶ Ù…Ù† Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©')
    
    if not user_id or not amount:
        return jsonify({'success': False, 'message': 'Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©'})
    
    try:
        amount = float(amount)
        if amount <= 0:
            return jsonify({'success': False, 'message': 'Ø§Ù„Ù…Ø¨Ù„Øº ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±'})
    except:
        return jsonify({'success': False, 'message': 'Ù…Ø¨Ù„Øº ØºÙŠØ± ØµØ§Ù„Ø­'})
    
    conn = get_db()
    cursor = conn.cursor()
    
    cursor.execute('SELECT id, username, balance FROM users WHERE id = ?', (user_id,))
    user = cursor.fetchone()
    
    if not user:
        conn.close()
        return jsonify({'success': False, 'message': 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'})
    
    cursor.execute('UPDATE users SET balance = balance + ? WHERE id = ?', (amount, user_id))
    
    cursor.execute('''
        INSERT INTO notifications (user_id, message, is_read, created_at)
        VALUES (?, ?, 0, CURRENT_TIMESTAMP)
    ''', (user_id, f'ğŸ’° ØªÙ… Ø¥Ø¶Ø§ÙØ© {amount:.2f} $ Ø¥Ù„Ù‰ Ø±ØµÙŠØ¯Ùƒ - Ø§Ù„Ø³Ø¨Ø¨: {reason}'))
    
    conn.commit()
    
    cursor.execute('SELECT balance FROM users WHERE id = ?', (user_id,))
    new_balance = cursor.fetchone()['balance']
    
    conn.close()
    
    return jsonify({
        'success': True, 
        'message': f'ØªÙ… ØªØ¹ÙˆÙŠØ¶ {user["username"]} Ø¨Ù…Ø¨Ù„Øº {amount:.2f} $ Ø¨Ù†Ø¬Ø§Ø­',
        'new_balance': new_balance
    })

@app.route('/admin/api/search-user-streaming', methods=['POST'])
@admin_required
def admin_api_search_user_streaming():
    """Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø¥Ø¯Ø§Ø±Ø© ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¨Ø«"""
    data = request.get_json()
    username = data.get('username', '').strip() if data else ''
    
    if not username:
        return jsonify({'success': False, 'error': 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…'})
    
    conn = get_db()
    cursor = conn.cursor()
    
    cursor.execute('SELECT id, username, streaming_enabled, streaming_granted_free FROM users WHERE username = ?', (username,))
    user = cursor.fetchone()
    conn.close()
    
    if not user:
        return jsonify({'success': False, 'error': 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'})
    
    return jsonify({
        'success': True,
        'user_id': user['id'],
        'username': user['username'],
        'streaming_enabled': user['streaming_enabled'] == 1,
        'streaming_granted_free': user['streaming_granted_free'] == 1 if user['streaming_granted_free'] else False
    })

@app.route('/admin/api/grant-streaming', methods=['POST'])
@admin_required
def admin_api_grant_streaming():
    """Ù…Ù†Ø­ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¨Ø« Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø¯ÙˆÙ† Ø´Ø±ÙˆØ·"""
    data = request.get_json()
    user_id = data.get('user_id') if data else None
    
    if not user_id:
        return jsonify({'success': False, 'error': 'Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©'})
    
    conn = get_db()
    cursor = conn.cursor()
    
    cursor.execute('SELECT id, username FROM users WHERE id = ?', (user_id,))
    user = cursor.fetchone()
    
    if not user:
        conn.close()
        return jsonify({'success': False, 'error': 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'})
    
    # ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¨Ø« ÙˆØªØ³Ø¬ÙŠÙ„ Ø£Ù†Ù‡ Ù…Ù†Ø­ Ù…Ø¬Ø§Ù†ÙŠ
    cursor.execute('UPDATE users SET streaming_enabled = 1, streaming_granted_free = 1 WHERE id = ?', (user_id,))
    
    # Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
    notification_message = f'''ğŸ Ù…Ø±Ø­Ø¨Ø§Ù‹ {user["username"]}! 
ØªÙ… Ù…Ù†Ø­Ùƒ Ù…ÙŠØ²Ø© Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù…Ø¬Ø§Ù†Ø§Ù‹ ÙƒØ¹Ø±Ø¶ ØªØ±Ø­ÙŠØ¨ÙŠ Ù…Ø¤Ù‚Øª!
Ø§Ù†ØªÙ‡Ø² Ø§Ù„ÙØ±ØµØ© ÙÙŠ Ø¬Ù†ÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ù…Ù† Ø®Ù„Ø§Ù„ Ø§Ù„Ø¨Ø«. Ø¨Ø§Ù„ØªÙˆÙÙŠÙ‚! ğŸ‰'''
    
    cursor.execute('''
        INSERT INTO notifications (user_id, message, is_read, created_at)
        VALUES (?, ?, 0, CURRENT_TIMESTAMP)
    ''', (user_id, notification_message))
    
    conn.commit()
    conn.close()
    
    # Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± ÙÙˆØ±ÙŠ Ø¹Ø¨Ø± Socket.IO
    try:
        socketio.emit('new_notification', {
            'message': notification_message,
            'type': 'streaming_granted'
        }, room=f'user_{user_id}')
    except:
        pass
    
    return jsonify({'success': True, 'message': 'ØªÙ… Ù…Ù†Ø­ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¨Ø« Ø¨Ù†Ø¬Ø§Ø­'})

@app.route('/admin/api/revoke-streaming', methods=['POST'])
@admin_required
def admin_api_revoke_streaming():
    """Ø¥Ù„ØºØ§Ø¡ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¨Ø« Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…"""
    data = request.get_json()
    user_id = data.get('user_id') if data else None
    
    if not user_id:
        return jsonify({'success': False, 'error': 'Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©'})
    
    conn = get_db()
    cursor = conn.cursor()
    
    cursor.execute('SELECT id, username FROM users WHERE id = ?', (user_id,))
    user = cursor.fetchone()
    
    if not user:
        conn.close()
        return jsonify({'success': False, 'error': 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'})
    
    # Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¨Ø« ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ù†Ø­ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ
    cursor.execute('UPDATE users SET streaming_enabled = 0, streaming_granted_free = 0 WHERE id = ?', (user_id,))
    
    conn.commit()
    conn.close()
    
    return jsonify({'success': True, 'message': 'ØªÙ… Ø¥Ù„ØºØ§Ø¡ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¨Ø« Ø¨Ù†Ø¬Ø§Ø­'})

@app.route('/admin/approve-deposit/<int:deposit_id>', methods=['POST'])
@admin_required
def admin_approve_deposit(deposit_id):
    amount = float(request.form.get('amount'))
    
    conn = get_db()
    cursor = conn.cursor()
    
    cursor.execute('SELECT user_id FROM deposit_requests WHERE id = ?', (deposit_id,))
    deposit = cursor.fetchone()
    
    if deposit:
        cursor.execute('UPDATE users SET balance = balance + ? WHERE id = ?', (amount, deposit['user_id']))
        cursor.execute('''
            UPDATE deposit_requests 
            SET status = 'approved', amount = ?, processed_at = CURRENT_TIMESTAMP, processed_by = ?
            WHERE id = ?
        ''', (amount, session['user_id'], deposit_id))
        
        cursor.execute('''
            INSERT INTO notifications (user_id, message)
            VALUES (?, ?)
        ''', (deposit['user_id'], f'ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø·Ù„Ø¨ Ø§Ù„Ø´Ø­Ù† ÙˆØ¥Ø¶Ø§ÙØ© {amount:.2f} $ Ø¥Ù„Ù‰ Ø±ØµÙŠØ¯Ùƒ'))
        
        cursor.execute('SELECT balance FROM users WHERE id = ?', (deposit['user_id'],))
        new_balance = cursor.fetchone()['balance']
        
        conn.commit()
        
        # Ø£Ø±Ø³Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„ÙÙˆØ±ÙŠ Ø¹Ø¨Ø± SocketIO
        socketio.emit('balance_updated', {
            'new_balance': new_balance,
            'added_amount': amount
        }, room=f"user_{deposit['user_id']}")
        
        # Ø£Ø±Ø³Ù„ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„ÙÙˆØ±ÙŠ
        socketio.emit('deposit_status_updated', {
            'deposit_id': deposit_id,
            'status': 'approved',
            'amount': f"{amount:.2f}"
        }, room=f"user_{deposit['user_id']}")
        
        conn.close()
        return jsonify({'success': True, 'message': 'ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­', 'status': 'âœ… Ù…Ù‚Ø¨ÙˆÙ„'})
    
    conn.close()
    return jsonify({'success': False, 'message': 'Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'})

@app.route('/admin/reject-deposit/<int:deposit_id>', methods=['POST'])
@admin_required
def admin_reject_deposit(deposit_id):
    reason = request.form.get('reason')
    
    conn = get_db()
    cursor = conn.cursor()
    
    cursor.execute('SELECT user_id FROM deposit_requests WHERE id = ?', (deposit_id,))
    deposit = cursor.fetchone()
    
    if deposit:
        cursor.execute('''
            UPDATE deposit_requests 
            SET status = 'rejected', reject_reason = ?, processed_at = CURRENT_TIMESTAMP, processed_by = ?
            WHERE id = ?
        ''', (reason, session['user_id'], deposit_id))
        
        cursor.execute('UPDATE users SET warnings = warnings + 1 WHERE id = ?', (deposit['user_id'],))
        
        cursor.execute('''
            INSERT INTO notifications (user_id, message)
            VALUES (?, ?)
        ''', (deposit['user_id'], f'ØªÙ… Ø±ÙØ¶ Ø·Ù„Ø¨ Ø§Ù„Ø´Ø­Ù†. Ø§Ù„Ø³Ø¨Ø¨: {reason}. ØªÙ… Ø¥Ø¶Ø§ÙØ© ØªØ­Ø°ÙŠØ± Ù„Ø­Ø³Ø§Ø¨Ùƒ'))
        
        conn.commit()
        
        # Ø£Ø±Ø³Ù„ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„ÙÙˆØ±ÙŠ
        socketio.emit('deposit_status_updated', {
            'deposit_id': deposit_id,
            'status': 'rejected'
        }, room=f"user_{deposit['user_id']}")
        
        conn.close()
        return jsonify({'success': True, 'message': 'ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨', 'status': 'âŒ Ù…Ø±ÙÙˆØ¶'})
    
    conn.close()
    return jsonify({'success': False, 'message': 'Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'})

@app.route('/admin/approve-withdrawal/<int:withdrawal_id>', methods=['POST'])
@admin_required
def admin_approve_withdrawal(withdrawal_id):
    conn = get_db()
    cursor = conn.cursor()
    
    cursor.execute('SELECT user_id, amount FROM withdrawal_requests WHERE id = ?', (withdrawal_id,))
    withdrawal = cursor.fetchone()
    
    if withdrawal:
        cursor.execute('''
            UPDATE withdrawal_requests 
            SET status = 'approved', processed_at = CURRENT_TIMESTAMP, processed_by = ?
            WHERE id = ?
        ''', (session['user_id'], withdrawal_id))
        
        cursor.execute('''
            INSERT INTO notifications (user_id, message)
            VALUES (?, ?)
        ''', (withdrawal['user_id'], f'ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨ Ø¨Ù‚ÙŠÙ…Ø© {withdrawal["amount"]:.2f} $'))
        
        conn.commit()
    
    conn.close()
    flash('ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨')
    return redirect(url_for('admin_dashboard'))

@app.route('/admin/reject-withdrawal/<int:withdrawal_id>', methods=['POST'])
@admin_required
def admin_reject_withdrawal(withdrawal_id):
    conn = get_db()
    cursor = conn.cursor()
    
    cursor.execute('SELECT user_id, amount FROM withdrawal_requests WHERE id = ?', (withdrawal_id,))
    withdrawal = cursor.fetchone()
    
    if withdrawal:
        cursor.execute('UPDATE users SET balance = balance + ? WHERE id = ?', (withdrawal['amount'], withdrawal['user_id']))
        
        cursor.execute('''
            UPDATE withdrawal_requests 
            SET status = 'rejected', processed_at = CURRENT_TIMESTAMP, processed_by = ?
            WHERE id = ?
        ''', (session['user_id'], withdrawal_id))
        
        cursor.execute('''
            INSERT INTO notifications (user_id, message)
            VALUES (?, ?)
        ''', (withdrawal['user_id'], 'ØªÙ… Ø±ÙØ¶ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨ ÙˆØ¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ø¨Ù„Øº Ù„Ø±ØµÙŠØ¯Ùƒ'))
        
        conn.commit()
    
    conn.close()
    flash('ØªÙ… Ø±ÙØ¶ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨ ÙˆØ¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ø¨Ù„Øº Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…')
    return redirect(url_for('admin_dashboard'))

@app.route('/admin/add-balance/<int:user_id>', methods=['POST'])
@admin_required
def admin_add_balance(user_id):
    amount = float(request.form.get('amount'))
    
    conn = get_db()
    cursor = conn.cursor()
    cursor.execute('UPDATE users SET balance = balance + ? WHERE id = ?', (amount, user_id))
    
    # Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯
    cursor.execute('SELECT balance FROM users WHERE id = ?', (user_id,))
    new_balance = cursor.fetchone()['balance']
    
    cursor.execute('''
        INSERT INTO notifications (user_id, message)
        VALUES (?, ?)
    ''', (user_id, f'ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© {amount:.2f} $ Ø¥Ù„Ù‰ Ø±ØµÙŠØ¯Ùƒ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©'))
    conn.commit()
    conn.close()
    
    # Ø£Ø±Ø³Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ Ø¹Ø¨Ø± SocketIO Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
    socketio.emit('balance_updated', {
        'new_balance': new_balance,
        'added_amount': amount
    }, room=f'user_{user_id}')
    
    flash('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±ØµÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­')
    return redirect(url_for('admin_dashboard'))

@app.route('/admin/update-settings', methods=['POST'])
@admin_required
def admin_update_settings():
    deposit_info = request.form.get('deposit_info')
    
    conn = get_db()
    cursor = conn.cursor()
    cursor.execute('''
        INSERT OR REPLACE INTO settings (key, value) 
        VALUES ('deposit_info', ?)
    ''', (deposit_info,))
    conn.commit()
    conn.close()
    
    flash('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­')
    return redirect(url_for('admin_dashboard'))

@app.route('/static/<path:filename>')
def serve_static(filename):
    response = send_from_directory(STATIC_DIR, filename)
    response.headers['Cache-Control'] = 'public, max-age=31536000'
    return response

@app.route('/get-unread-notifications')
@login_required
def get_unread_notifications():
    conn = get_db()
    cursor = conn.cursor()
    cursor.execute('''
        SELECT COUNT(*) as count FROM notifications 
        WHERE user_id = ? AND is_read = 0
    ''', (session['user_id'],))
    result = cursor.fetchone()
    conn.close()
    
    count = result['count'] if result else 0
    badge_text = str(count) if count <= 9 else '9+'
    
    return jsonify({'count': count, 'badge': badge_text})


@app.route('/logout')
def logout():
    session.clear()
    return redirect(url_for('login'))



def background_cleanup_worker():
    """Ø¹Ù…Ù„ÙŠØ© Ø®Ù„ÙÙŠØ© Ù„Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ 6 Ø³Ø§Ø¹Ø§Øª"""
    while True:
        try:
            time.sleep(21600)
            print("ğŸ§¹ Ø¨Ø¯Ø¡ Ø§Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©...")
            cleanup_old_data()
            print("âœ… Ø§ÙƒØªÙ…Ù„ Ø§Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ù†Ø¬Ø§Ø­")
        except Exception as e:
            print(f"âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ: {e}")
        time.sleep(60)

def background_timer_worker():
    """Ø¹Ù…Ù„ÙŠØ© Ø®Ù„ÙÙŠØ© ØªÙØ­Øµ Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ© ÙƒÙ„ 5 Ø«ÙˆØ§Ù†Ù"""
    while True:
        conn = None
        try:
            time.sleep(5)
            
            conn = get_db()
            cursor = conn.cursor()
            
            cursor.execute('SELECT id FROM active_games WHERE game_status = "playing"')
            active_games = cursor.fetchall()
            
            for game_row in active_games:
                try:
                    game_id = game_row['id']
                    check_and_process_expired_turns(game_id, cursor)
                except Exception as game_error:
                    print(f"Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© {game_row['id']}: {game_error}")
                    continue
            
            conn.commit()
            
        except Exception as e:
            print(f"Ø®Ø·Ø£ ÙÙŠ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø®Ù„ÙÙŠØ©: {e}")
        finally:
            if conn:
                conn.close()
            time.sleep(1)

matchmaking_lock = threading.Lock()

def smart_matchmaking_worker(worker_id=0):
    """Optimized multi-thread matchmaking worker with batch processing"""
    while True:
        try:
            conn = sqlite3.connect(DATABASE_PATH, timeout=10.0, isolation_level=None)
            conn.row_factory = sqlite3.Row
            conn.execute('PRAGMA journal_mode=WAL')
            conn.execute('PRAGMA busy_timeout=10000')
            cursor = conn.cursor()
            
            bet_amounts = cursor.execute('''
                SELECT DISTINCT bet_amount 
                FROM ludo_matchmaking_queue 
                WHERE status = 'queued'
            ''').fetchall()
            
            for bet_row in bet_amounts:
                bet_amount = bet_row['bet_amount']
                
                conn.execute('BEGIN IMMEDIATE')
                
                try:
                    players = cursor.execute('''
                        SELECT id, user_id, lock_version
                        FROM ludo_matchmaking_queue
                        WHERE status = 'queued' 
                        AND bet_amount = ?
                        ORDER BY created_at ASC
                        LIMIT 20
                    ''', (bet_amount,)).fetchall()
                    
                    matched_count = 0
                    for i in range(0, len(players) - 1, 2):
                        if i + 1 >= len(players):
                            break
                            
                        player1 = players[i]
                        player2 = players[i + 1]
                        
                        updated1 = cursor.execute('''
                            UPDATE ludo_matchmaking_queue 
                            SET status = 'matching', lock_version = lock_version + 1
                            WHERE id = ? AND status = 'queued' AND lock_version = ?
                        ''', (player1['id'], player1['lock_version'])).rowcount
                        
                        updated2 = cursor.execute('''
                            UPDATE ludo_matchmaking_queue 
                            SET status = 'matching', lock_version = lock_version + 1
                            WHERE id = ? AND status = 'queued' AND lock_version = ?
                        ''', (player2['id'], player2['lock_version'])).rowcount
                        
                        if updated1 == 1 and updated2 == 1:
                            cursor.execute('''
                                INSERT INTO ludo_active_games (player1_id, player2_id, bet_amount, turn_deadline)
                                VALUES (?, ?, ?, datetime(CURRENT_TIMESTAMP, '+30 seconds'))
                            ''', (player1['user_id'], player2['user_id'], bet_amount))
                            
                            game_id = cursor.lastrowid
                            
                            cursor.execute('''
                                UPDATE ludo_matchmaking_queue 
                                SET status = 'matched', match_id = ?, matched_user_id = ?
                                WHERE id = ?
                            ''', (game_id, player2['user_id'], player1['id']))
                            
                            cursor.execute('''
                                UPDATE ludo_matchmaking_queue 
                                SET status = 'matched', match_id = ?, matched_user_id = ?
                                WHERE id = ?
                            ''', (game_id, player1['user_id'], player2['id']))
                            
                            p1_name = cursor.execute('SELECT username FROM users WHERE id = ?', 
                                                    (player1['user_id'],)).fetchone()
                            p2_name = cursor.execute('SELECT username FROM users WHERE id = ?', 
                                                    (player2['user_id'],)).fetchone()
                            
                            conn.commit()
                            
                            match_data_p1 = {
                                'game_id': game_id,
                                'opponent_name': p2_name['username'] if p2_name else 'Ù…Ù†Ø§ÙØ³',
                                'queue_id': player1['id']
                            }
                            
                            match_data_p2 = {
                                'game_id': game_id,
                                'opponent_name': p1_name['username'] if p1_name else 'Ù…Ù†Ø§ÙØ³',
                                'queue_id': player2['id']
                            }
                            
                            print(f'âœ… Match created: Game {game_id} - Player {player1["user_id"]} ({p1_name["username"] if p1_name else "?"}) vs Player {player2["user_id"]} ({p2_name["username"] if p2_name else "?"}) - {bet_amount}$')
                            
                            def send_match_notifications():
                                try:
                                    time.sleep(0.3)
                                    
                                    for attempt in range(20):
                                        try:
                                            socketio.emit('match_found', match_data_p1, room=f'ludo_queue_{player1["id"]}', namespace='/')
                                            socketio.emit('match_found', match_data_p2, room=f'ludo_queue_{player2["id"]}', namespace='/')
                                            socketio.emit('match_found', match_data_p1, room=f'user_{player1["user_id"]}', namespace='/')
                                            socketio.emit('match_found', match_data_p2, room=f'user_{player2["user_id"]}', namespace='/')
                                            
                                            if attempt == 0 or attempt == 5 or attempt == 10:
                                                print(f'ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© #{attempt+1} - Ø§Ù„Ù„Ø¹Ø¨Ø© {game_id} - P1:{player1["user_id"]} P2:{player2["user_id"]}')
                                        except Exception as emit_error:
                                            print(f'âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ù…Ø­Ø§ÙˆÙ„Ø© #{attempt+1} Ù„Ù„Ø¹Ø¨Ø© {game_id}: {emit_error}')
                                        
                                        time.sleep(0.4)
                                    
                                    print(f'âœ… Ø§ÙƒØªÙ…Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ø¹Ø¨Ø© {game_id}')
                                    
                                except Exception as notify_error:
                                    print(f'âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù„Ù„Ø¹Ø¨Ø© {game_id}: {notify_error}')
                            
                            notification_thread = threading.Thread(target=send_match_notifications, daemon=True)
                            notification_thread.start()
                            matched_count += 1
                        else:
                            conn.rollback()
                    
                    if matched_count > 0:
                        print(f'âœ… Worker {worker_id}: ØªÙ… Ù…Ø·Ø§Ø¨Ù‚Ø© {matched_count} Ø²ÙˆØ¬ Ù…Ù† Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†')
                    
                    if matched_count == 0:
                        conn.rollback()
                        
                except Exception as e:
                    conn.rollback()
                    print(f"Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©: {e}")
            
            now = datetime.now()
            expired_queues = cursor.execute('''
                SELECT id, user_id, bet_amount 
                FROM ludo_matchmaking_queue
                WHERE status = 'queued' AND datetime(expires_at) <= datetime(?)
            ''', (now.strftime('%Y-%m-%d %H:%M:%S'),)).fetchall()
            
            for expired in expired_queues:
                conn.execute('BEGIN IMMEDIATE')
                try:
                    cursor.execute('UPDATE users SET balance = balance + ? WHERE id = ?', 
                                 (expired['bet_amount'], expired['user_id']))
                    cursor.execute('DELETE FROM ludo_matchmaking_queue WHERE id = ?', (expired['id'],))
                    conn.commit()
                    socketio.emit('matchmaking_expired', {}, room=f'ludo_queue_{expired["id"]}')
                    socketio.emit('matchmaking_expired', {}, room=f'user_{expired["user_id"]}')
                except:
                    conn.rollback()
            
        except Exception as e:
            print(f"Ø®Ø·Ø£ ÙÙŠ matchmaking worker {worker_id}: {e}")
        finally:
            if conn:
                conn.close()
            time.sleep(0.01)

def matchmaking_timer_worker():
    """Sends timer updates to waiting players"""
    while True:
        try:
            conn = sqlite3.connect(DATABASE_PATH, timeout=5.0)
            conn.row_factory = sqlite3.Row
            cursor = conn.cursor()
            
            cursor.execute('''
                SELECT id, user_id, bet_amount, created_at, expires_at
                FROM ludo_matchmaking_queue
                WHERE status = 'queued'
            ''')
            waiting_queues = cursor.fetchall()
            
            for queue in waiting_queues:
                queue_id = queue['id']
                expires_at = datetime.strptime(queue['expires_at'], '%Y-%m-%d %H:%M:%S')
                now = datetime.now()
                
                time_left = int((expires_at - now).total_seconds())
                
                if time_left > 0:
                    socketio.emit('timer_update', {
                        'time_left': time_left
                    }, room=f'ludo_queue_{queue_id}')
            
        except Exception as e:
            print(f"Ø®Ø·Ø£ ÙÙŠ timer worker: {e}")
        finally:
            if conn:
                conn.close()
            time.sleep(1)

def start_background_workers():
    timer_thread = threading.Thread(target=background_timer_worker, daemon=True)
    timer_thread.start()

    cleanup_thread = threading.Thread(target=background_cleanup_worker, daemon=True)
    cleanup_thread.start()
    print("âœ… Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¬Ø§Ù‡Ø² (ÙŠØ¹Ù…Ù„ ÙƒÙ„ 6 Ø³Ø§Ø¹Ø§Øª)")

    auto_skip_thread = threading.Thread(target=auto_skip_worker, daemon=True)
    auto_skip_thread.start()
    print("âœ… Ù†Ø¸Ø§Ù… ØªØ®Ø·ÙŠ Ø§Ù„Ø¯ÙˆØ± Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¬Ø§Ù‡Ø² (ÙŠØ¹Ù…Ù„ ÙƒÙ„ 2 Ø«Ø§Ù†ÙŠØ© - ÙŠØ¹Ù…Ù„ Ø­ØªÙ‰ Ù…Ø¹ ØºÙŠØ§Ø¨ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†)")

    print("ğŸš€ Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ù…Ø­Ø³Ù‘Ù† Ù…Ø¹ 10 Workers Ù…ØªÙˆØ§Ø²ÙŠØ©...")
    for worker_num in range(10):
        matchmaking_thread = threading.Thread(
            target=smart_matchmaking_worker, 
            args=(worker_num,), 
            daemon=True,
            name=f"MatchmakingWorker-{worker_num}"
        )
        matchmaking_thread.start()
        print(f"   âœ… Worker {worker_num} Ø¬Ø§Ù‡Ø²")

    matchmaking_timer = threading.Thread(target=matchmaking_timer_worker, daemon=True)
    matchmaking_timer.start()

    print("âœ… Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ù…Ø­Ø³Ù‘Ù† Ø¬Ø§Ù‡Ø² - ÙŠØ¯Ø¹Ù… Ø¢Ù„Ø§Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØªØ²Ø§Ù…Ù†ÙŠÙ†!")

@socketio.on('connect')
def handle_connect():
    user_id = session.get('user_id')
    if user_id and user_id != 'admin':
        user_room = f'user_{user_id}'
        join_room(user_room)
        print(f'âœ… User {user_id} connected and joined room: {user_room}')
        emit('connection_established', {'status': 'connected', 'user_id': user_id})

@socketio.on('join_matchmaking')
def handle_join_matchmaking(data):
    queue_id = data.get('queue_id')
    game_type = data.get('game_type', 'ludo')
    user_id = session.get('user_id')
    
    if user_id:
        user_room = f'user_{user_id}'
        join_room(user_room)
        print(f'âœ… User {user_id} joined user room: {user_room}')
    
    if queue_id:
        room = f'{game_type}_queue_{queue_id}'
        join_room(room)
        print(f'âœ… User {user_id} joined {game_type} matchmaking room: {room}')
        
        emit('joined_queue', {
            'queue_id': queue_id,
            'room': room,
            'message': 'Ø§Ù†Ø¶Ù…Ù…Øª Ø¨Ù†Ø¬Ø§Ø­ Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±'
        })
        
        conn = get_db()
        cursor = conn.cursor()
        cursor.execute('''
            SELECT status, match_id, matched_user_id 
            FROM ludo_matchmaking_queue 
            WHERE id = ?
        ''', (queue_id,))
        queue_entry = cursor.fetchone()
        
        if queue_entry and queue_entry['status'] == 'matched' and queue_entry['match_id']:
            cursor.execute('SELECT username FROM users WHERE id = ?', (queue_entry['matched_user_id'],))
            opponent = cursor.fetchone()
            opponent_name = opponent['username'] if opponent else 'Ù…Ù†Ø§ÙØ³'
            
            for i in range(3):
                emit('match_found', {
                    'game_id': queue_entry['match_id'],
                    'opponent_name': opponent_name,
                    'queue_id': queue_id
                })
            
            print(f'ğŸ‰ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„ÙÙˆØ±ÙŠ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… {user_id} - Ø§Ù„Ù„Ø¹Ø¨Ø© {queue_entry["match_id"]}')
        
        conn.close()

@socketio.on('join_ludo_game')
def handle_join_ludo_game(data):
    game_id = data.get('game_id')
    if game_id:
        room = f'ludo_game_{game_id}'
        join_room(room)
        print(f'User joined ludo game room: {room}')
        emit('peer_connected', room=room, skip_sid=request.sid)

@socketio.on('webrtc_offer')
def handle_webrtc_offer(data):
    game_id = data.get('game_id')
    offer = data.get('offer')
    if game_id:
        room = f'ludo_game_{game_id}'
        emit('webrtc_offer', {'offer': offer}, room=room, include_self=False)
        print(f'WebRTC offer forwarded to room: {room}')

@socketio.on('webrtc_answer')
def handle_webrtc_answer(data):
    game_id = data.get('game_id')
    answer = data.get('answer')
    if game_id:
        room = f'ludo_game_{game_id}'
        emit('webrtc_answer', {'answer': answer}, room=room, include_self=False)
        print(f'WebRTC answer forwarded to room: {room}')

@socketio.on('webrtc_ice_candidate')
def handle_webrtc_ice_candidate(data):
    game_id = data.get('game_id')
    candidate = data.get('candidate')
    if game_id:
        room = f'ludo_game_{game_id}'
        emit('webrtc_ice_candidate', {'candidate': candidate}, room=room, include_self=False)
        print(f'ICE candidate forwarded to room: {room}')

@socketio.on('toggle_mute')
def handle_toggle_mute(data):
    game_id = data.get('game_id')
    muted = data.get('muted')
    if game_id:
        room = f'ludo_game_{game_id}'
        emit('peer_muted', {'muted': muted}, room=room, include_self=False)
        print(f'Mute status {muted} forwarded to room: {room}')

@socketio.on('watch_ludo_game')
def handle_watch_ludo_game(data):
    """Ù…Ø¹Ø§Ù„Ø¬ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ Ù„ØºØ±ÙØ© Ø§Ù„Ù„Ø¹Ø¨Ø© Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±"""
    game_id = data.get('game_id')
    if game_id:
        room = f'ludo_stream_{game_id}'
        sid = request.sid
        
        with stream_viewers_lock:
            if sid in stream_viewers and stream_viewers[sid] == game_id:
                print(f'âš ï¸ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ {sid} Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ø¨Ø« {game_id}')
                return
            
            if sid in stream_viewers:
                old_game_id = stream_viewers[sid]
                if old_game_id != game_id:
                    _decrement_viewer_count(old_game_id, sid)
            
            stream_viewers[sid] = game_id
        
        join_room(room)
        
        try:
            conn = get_db()
            cursor = conn.cursor()
            
            cursor.execute('SELECT * FROM ludo_active_games WHERE id = ?', (game_id,))
            game = cursor.fetchone()
            
            if game:
                cursor.execute('SELECT username FROM users WHERE id = ?', (game['player1_id'],))
                p1 = cursor.fetchone()
                cursor.execute('SELECT username FROM users WHERE id = ?', (game['player2_id'],))
                p2 = cursor.fetchone()
                
                cursor.execute('UPDATE ludo_streams SET viewer_count = viewer_count + 1 WHERE game_id = ? AND is_active = 1', (game_id,))
                conn.commit()
                
                cursor.execute('SELECT viewer_count FROM ludo_streams WHERE game_id = ? AND is_active = 1', (game_id,))
                stream_info = cursor.fetchone()
                viewer_count = stream_info['viewer_count'] if stream_info else 1
                
                time_left = 30
                if game['turn_deadline']:
                    try:
                        deadline = datetime.strptime(game['turn_deadline'], '%Y-%m-%d %H:%M:%S')
                        remaining = (deadline - datetime.now()).total_seconds()
                        time_left = max(0, int(remaining))
                    except:
                        time_left = 30
                
                emit('ludo_stream_snapshot', {
                    'game_id': game_id,
                    'player1_name': p1['username'] if p1 else 'Ù„Ø§Ø¹Ø¨ 1',
                    'player2_name': p2['username'] if p2 else 'Ù„Ø§Ø¹Ø¨ 2',
                    'player1_position': game['player1_position'],
                    'player2_position': game['player2_position'],
                    'current_turn': game['current_turn'],
                    'last_roll': game['last_roll'],
                    'game_status': game['game_status'],
                    'bet_amount': game['bet_amount'],
                    'viewer_count': viewer_count,
                    'time_left': time_left
                })
                
                socketio.emit('stream_viewer_update', {
                    'game_id': game_id,
                    'viewer_count': viewer_count
                }, room=f'ludo_game_{game_id}')
            
            conn.close()
        except Exception as e:
            print(f'âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©: {e}')
        
        emit('watcher_joined', {'message': 'Ù…Ø´Ø§Ù‡Ø¯ Ø¬Ø¯ÙŠØ¯ Ø¯Ø®Ù„ Ø§Ù„ØºØ±ÙØ©'}, room=room, include_self=False)
        print(f'ğŸ¥ Ù…Ø´Ø§Ù‡Ø¯ Ø¯Ø®Ù„ ØºØ±ÙØ© Ø§Ù„Ø¨Ø«: {room} (SID: {sid})')

@socketio.on('start_ludo_stream')
def handle_start_ludo_stream(data):
    """Ø¨Ø¯Ø¡ Ø¨Ø« Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ø¹Ø¨Ø© Ù„ÙˆØ¯Ùˆ"""
    game_id = data.get('game_id')
    user_id = data.get('user_id')
    
    if not game_id or not user_id:
        emit('stream_error', {'error': 'Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©'})
        return
    
    try:
        conn = get_db()
        cursor = conn.cursor()
        
        cursor.execute('SELECT * FROM ludo_active_games WHERE id = ? AND game_status = "playing"', (game_id,))
        game = cursor.fetchone()
        
        if not game:
            emit('stream_error', {'error': 'Ø§Ù„Ù„Ø¹Ø¨Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© Ø£Ùˆ Ø§Ù†ØªÙ‡Øª'})
            conn.close()
            return
        
        if game['player1_id'] != user_id and game['player2_id'] != user_id:
            emit('stream_error', {'error': 'Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¨Ø« Ù„Ø¹Ø¨Ø© Ù„Ø³Øª Ù…Ø´Ø§Ø±ÙƒØ§Ù‹ ÙÙŠÙ‡Ø§'})
            conn.close()
            return
        
        cursor.execute('SELECT * FROM ludo_streams WHERE game_id = ?', (game_id,))
        existing = cursor.fetchone()
        
        with stream_viewers_lock:
            sids_to_remove = [sid for sid, gid in stream_viewers.items() if gid == game_id]
            for sid in sids_to_remove:
                del stream_viewers[sid]
        
        if existing:
            cursor.execute('''
                UPDATE ludo_streams 
                SET is_active = 1, viewer_count = 0, started_at = CURRENT_TIMESTAMP, ended_at = NULL, streamer_id = ?
                WHERE game_id = ?
            ''', (user_id, game_id))
            conn.commit()
            
            emit('stream_started', {
                'game_id': game_id,
                'message': 'ØªÙ… Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø« Ø¨Ù†Ø¬Ø§Ø­',
                'viewer_count': 0
            })
            
            socketio.emit('new_stream_available', {
                'game_id': game_id,
                'bet_amount': game['bet_amount']
            }, room='live_streams_lobby')
        else:
            cursor.execute('''
                INSERT INTO ludo_streams (game_id, streamer_id, is_active, viewer_count)
                VALUES (?, ?, 1, 0)
            ''', (game_id, user_id))
            conn.commit()
            
            emit('stream_started', {
                'game_id': game_id,
                'message': 'ØªÙ… Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø« Ø¨Ù†Ø¬Ø§Ø­',
                'viewer_count': 0
            })
            
            socketio.emit('new_stream_available', {
                'game_id': game_id,
                'bet_amount': game['bet_amount']
            }, room='live_streams_lobby')
        
        conn.close()
        print(f'ğŸ“º ØªÙ… Ø¨Ø¯Ø¡ Ø¨Ø« Ø§Ù„Ù„Ø¹Ø¨Ø© {game_id}')
        
    except Exception as e:
        print(f'âŒ Ø®Ø·Ø£ ÙÙŠ Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø«: {e}')
        import traceback
        traceback.print_exc()
        emit('stream_error', {'error': 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø«'})

@socketio.on('stop_ludo_stream')
def handle_stop_ludo_stream(data):
    """Ø¥ÙŠÙ‚Ø§Ù Ø¨Ø« Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ø¹Ø¨Ø© Ù„ÙˆØ¯Ùˆ"""
    game_id = data.get('game_id')
    user_id = data.get('user_id')
    
    if not game_id:
        return
    
    try:
        conn = get_db()
        cursor = conn.cursor()
        
        cursor.execute('''
            UPDATE ludo_streams 
            SET is_active = 0, ended_at = CURRENT_TIMESTAMP, viewer_count = 0
            WHERE game_id = ? AND is_active = 1
        ''', (game_id,))
        conn.commit()
        conn.close()
        
        with stream_viewers_lock:
            sids_to_remove = [sid for sid, gid in stream_viewers.items() if gid == game_id]
            for sid in sids_to_remove:
                del stream_viewers[sid]
        
        socketio.emit('stream_ended', {
            'game_id': game_id,
            'message': 'ØªÙ… Ù‚Ø·Ø¹ Ø§Ù„Ø¨Ø«'
        }, room=f'ludo_stream_{game_id}')
        
        socketio.emit('stream_removed', {
            'game_id': game_id
        }, room='live_streams_lobby')
        
        emit('stream_stopped', {
            'game_id': game_id,
            'message': 'ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨Ø« Ø¨Ù†Ø¬Ø§Ø­'
        })
        
        print(f'â¹ï¸ ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø¨Ø« Ø§Ù„Ù„Ø¹Ø¨Ø© {game_id}')
        
    except Exception as e:
        print(f'âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨Ø«: {e}')

@socketio.on('get_active_streams')
def handle_get_active_streams():
    """Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¨Ø«ÙˆØ« Ø§Ù„Ù†Ø´Ø·Ø©"""
    try:
        conn = get_db()
        cursor = conn.cursor()
        
        cursor.execute('''
            SELECT s.game_id, s.viewer_count, s.started_at, g.bet_amount,
                   u1.username as player1_name, u2.username as player2_name
            FROM ludo_streams s
            JOIN ludo_active_games g ON s.game_id = g.id
            JOIN users u1 ON g.player1_id = u1.id
            JOIN users u2 ON g.player2_id = u2.id
            WHERE s.is_active = 1 AND g.game_status = 'playing'
            ORDER BY s.viewer_count DESC, s.started_at DESC
            LIMIT 20
        ''')
        streams = cursor.fetchall()
        conn.close()
        
        streams_list = []
        for s in streams:
            streams_list.append({
                'game_id': s['game_id'],
                'viewer_count': s['viewer_count'],
                'bet_amount': s['bet_amount'],
                'player1_name': s['player1_name'],
                'player2_name': s['player2_name'],
                'started_at': s['started_at']
            })
        
        emit('active_streams_list', {'streams': streams_list})
        
    except Exception as e:
        print(f'âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨Ø«ÙˆØ«: {e}')
        emit('active_streams_list', {'streams': []})

@socketio.on('leave_ludo_stream')
def handle_leave_ludo_stream(data):
    """Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ Ù„ØºØ±ÙØ© Ø§Ù„Ø¨Ø«"""
    game_id = data.get('game_id')
    if game_id:
        sid = request.sid
        room = f'ludo_stream_{game_id}'
        
        should_decrement = False
        with stream_viewers_lock:
            if sid in stream_viewers and stream_viewers[sid] == game_id:
                del stream_viewers[sid]
                should_decrement = True
        
        leave_room(room)
        
        if should_decrement:
            _decrement_viewer_count(game_id, sid)
        
        print(f'ğŸ‘‹ Ù…Ø´Ø§Ù‡Ø¯ ØºØ§Ø¯Ø± ØºØ±ÙØ© Ø§Ù„Ø¨Ø«: {room} (SID: {sid})')

@socketio.on('viewer_request_audio')
def handle_viewer_request_audio(data):
    """Ø·Ù„Ø¨ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ Ù„Ù„ØµÙˆØª - Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ù„Ø¨Ø« ØµÙˆØªÙ‡Ù…"""
    game_id = data.get('game_id')
    if game_id:
        viewer_sid = request.sid
        emit('viewer_wants_audio', {
            'game_id': game_id,
            'viewer_sid': viewer_sid
        }, room=f'ludo_game_{game_id}')
        print(f'ğŸ”Š Ù…Ø´Ø§Ù‡Ø¯ Ø·Ù„Ø¨ Ø§Ù„ØµÙˆØª Ù„Ù„Ø¹Ø¨Ø©: {game_id}')

@socketio.on('player_audio_offer_to_viewer')
def handle_player_audio_offer_to_viewer(data):
    """Ø§Ù„Ù„Ø§Ø¹Ø¨ ÙŠØ±Ø³Ù„ Ø¹Ø±Ø¶ ØµÙˆØª Ù„Ù„Ù…Ø´Ø§Ù‡Ø¯"""
    viewer_sid = data.get('viewer_sid')
    game_id = data.get('game_id')
    offer = data.get('offer')
    player_id = data.get('player_id')
    
    if viewer_sid and offer:
        emit('viewer_audio_offer', {
            'game_id': game_id,
            'offer': offer,
            'player_id': player_id
        }, to=viewer_sid)
        print(f'ğŸ¤ ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø±Ø¶ ØµÙˆØª Ù…Ù† {player_id} Ù„Ù„Ù…Ø´Ø§Ù‡Ø¯')

@socketio.on('viewer_audio_answer')
def handle_viewer_audio_answer(data):
    """Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ ÙŠØ±Ø³Ù„ Ø¥Ø¬Ø§Ø¨Ø© Ù„Ù„Ø§Ø¹Ø¨"""
    game_id = data.get('game_id')
    answer = data.get('answer')
    player_id = data.get('player_id')
    viewer_sid = request.sid
    
    if game_id and answer:
        emit('viewer_audio_answer_from_viewer', {
            'answer': answer,
            'player_id': player_id,
            'viewer_sid': viewer_sid
        }, room=f'ludo_game_{game_id}')
        print(f'ğŸ“© ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø¬Ø§Ø¨Ø© ØµÙˆØª Ù…Ù† Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ Ù„Ù„Ø¹Ø¨Ø©: {game_id}')

@socketio.on('viewer_ice_candidate')
def handle_viewer_ice_candidate(data):
    """ICE candidate Ù…Ù† Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯"""
    game_id = data.get('game_id')
    candidate = data.get('candidate')
    player_id = data.get('player_id')
    viewer_sid = request.sid
    
    if game_id and candidate:
        emit('viewer_ice_from_viewer', {
            'candidate': candidate,
            'player_id': player_id,
            'viewer_sid': viewer_sid
        }, room=f'ludo_game_{game_id}')

@socketio.on('player_ice_to_viewer')
def handle_player_ice_to_viewer(data):
    """ICE candidate Ù…Ù† Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù„Ù„Ù…Ø´Ø§Ù‡Ø¯"""
    viewer_sid = data.get('viewer_sid')
    candidate = data.get('candidate')
    player_id = data.get('player_id')
    game_id = data.get('game_id')
    
    if viewer_sid and candidate:
        emit('viewer_ice_candidate_from_player', {
            'candidate': candidate,
            'player_id': player_id,
            'game_id': game_id
        }, to=viewer_sid)

@socketio.on('send_stream_gift')
def handle_send_stream_gift(data):
    """Ù…Ø¹Ø§Ù„Ø¬ Ø¥Ø±Ø³Ø§Ù„ Ù‡Ø¯ÙŠØ© Ù„Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù…Ø¹ Ø­Ù…Ø§ÙŠØ© Ø¶Ø¯ Ø§Ù„ØºØ´"""
    game_id = data.get('game_id')
    gift_id = data.get('gift_id')
    gift_emoji = data.get('gift_emoji')
    gift_name = data.get('gift_name')
    gift_price = float(data.get('gift_price', 0))
    
    if 'user_id' not in session:
        emit('gift_error', {'error': 'ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„'})
        return
    
    user_id = session['user_id']
    
    is_valid, error_msg = validate_gift_request(gift_id, gift_price)
    if not is_valid:
        print(f'âš ï¸ Ù…Ø­Ø§ÙˆÙ„Ø© ØºØ´ ÙÙŠ Ø§Ù„Ù‡Ø¯ÙŠØ© Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… {user_id}: {error_msg}')
        emit('gift_error', {'error': 'Ù‡Ø¯ÙŠØ© ØºÙŠØ± ØµØ§Ù„Ø­Ø©'})
        return
    
    transaction_token = generate_gift_token()
    
    with gift_processing_lock:
        if transaction_token in processed_gift_tokens:
            emit('gift_error', {'error': 'ØªÙ… Ù…Ø¹Ø§Ù„Ø¬Ø© Ù‡Ø°Ù‡ Ø§Ù„Ù‡Ø¯ÙŠØ© Ù…Ø³Ø¨Ù‚Ø§Ù‹'})
            return
        processed_gift_tokens.add(transaction_token)
        if len(processed_gift_tokens) > 100000:
            old_tokens = list(processed_gift_tokens)[:50000]
            for token in old_tokens:
                processed_gift_tokens.discard(token)
    
    try:
        conn = get_db()
        cursor = conn.cursor()
        
        cursor.execute('SELECT id, username, balance FROM users WHERE id = ?', (user_id,))
        sender = cursor.fetchone()
        
        if not sender:
            emit('gift_error', {'error': 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'})
            conn.close()
            return
        
        current_balance = float(sender['balance'])
        if current_balance < gift_price:
            print(f'âš ï¸ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø±Ø³Ø§Ù„ Ù‡Ø¯ÙŠØ© Ø¨Ø¯ÙˆÙ† Ø±ØµÙŠØ¯ ÙƒØ§ÙÙŠ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… {user_id}: Ø§Ù„Ø±ØµÙŠØ¯ {current_balance} < Ø§Ù„Ø³Ø¹Ø± {gift_price}')
            emit('gift_error', {'error': 'Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙŠ'})
            conn.close()
            return
        
        cursor.execute('SELECT id, streamer_id FROM ludo_streams WHERE game_id = ? AND is_active = 1', (game_id,))
        stream = cursor.fetchone()
        
        if not stream:
            emit('gift_error', {'error': 'Ø§Ù„Ø¨Ø« ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'})
            conn.close()
            return
        
        stream_id = stream['id']
        streamer_id = stream['streamer_id']
        
        if user_id == streamer_id:
            emit('gift_error', {'error': 'Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø±Ø³Ø§Ù„ Ù‡Ø¯ÙŠØ© Ù„Ù†ÙØ³Ùƒ'})
            conn.close()
            return
        
        calculated_value = calculate_gift_value(gift_price)
        
        cursor.execute('SELECT transaction_token FROM stream_gift_transactions WHERE transaction_token = ?', (transaction_token,))
        if cursor.fetchone():
            emit('gift_error', {'error': 'Ù…Ø¹Ø§Ù…Ù„Ø© Ù…ÙƒØ±Ø±Ø©'})
            conn.close()
            return
        
        cursor.execute('UPDATE users SET balance = balance - ? WHERE id = ? AND balance >= ?', 
                      (gift_price, user_id, gift_price))
        if cursor.rowcount == 0:
            emit('gift_error', {'error': 'Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙŠ'})
            conn.close()
            return
        
        cursor.execute('UPDATE users SET balance = balance + ? WHERE id = ?', (calculated_value, streamer_id))
        
        cursor.execute('UPDATE ludo_streams SET total_earnings = COALESCE(total_earnings, 0) + ? WHERE game_id = ? AND is_active = 1', 
                      (calculated_value, game_id))
        
        cursor.execute('''
            INSERT INTO stream_gift_transactions 
            (transaction_token, stream_id, game_id, sender_id, receiver_id, gift_id, gift_name, gift_emoji, original_price, calculated_value, status)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 'completed')
        ''', (transaction_token, stream_id, game_id, user_id, streamer_id, gift_id, gift_name, gift_emoji, gift_price, calculated_value))
        
        conn.commit()
        
        gift_payload = {
            'gift_id': gift_id,
            'gift_emoji': gift_emoji,
            'gift_name': gift_name,
            'gift_price': gift_price,
            'calculated_value': calculated_value,
            'sender_id': user_id,
            'sender_name': sender['username'],
            'game_id': game_id,
            'transaction_token': transaction_token,
            'timestamp': datetime.now().isoformat()
        }
        
        socketio.emit('stream_gift_received', gift_payload, room=f'ludo_game_{game_id}')
        socketio.emit('stream_gift_received', gift_payload, room=f'ludo_stream_{game_id}')
        
        cursor.execute('SELECT balance FROM users WHERE id = ?', (user_id,))
        new_balance_row = cursor.fetchone()
        sender_new_balance = new_balance_row['balance'] if new_balance_row else 0
        emit('balance_updated', {'new_balance': sender_new_balance})
        
        cursor.execute('SELECT balance FROM users WHERE id = ?', (streamer_id,))
        streamer_balance_row = cursor.fetchone()
        streamer_new_balance = streamer_balance_row['balance'] if streamer_balance_row else 0
        socketio.emit('balance_updated', {'new_balance': streamer_new_balance}, room=f'user_{streamer_id}')
        socketio.emit('gift_earnings_update', {
            'gift_value': calculated_value,
            'total_earnings': cursor.execute('SELECT total_earnings FROM ludo_streams WHERE game_id = ?', (game_id,)).fetchone()['total_earnings'] or 0
        }, room=f'ludo_game_{game_id}')
        
        conn.close()
        print(f'ğŸ Ù‡Ø¯ÙŠØ© Ù†Ø§Ø¬Ø­Ø©: {gift_emoji} {gift_name} Ù…Ù† {sender["username"]} Ù„Ù„Ø¨Ø« {game_id} | Ø§Ù„Ø³Ø¹Ø±: ${gift_price} | Ù„Ù„Ù…Ø³ØªÙ„Ù…: ${calculated_value} | Token: {transaction_token[:20]}...')
        
    except Exception as e:
        print(f'âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù‡Ø¯ÙŠØ©: {e}')
        import traceback
        traceback.print_exc()
        emit('gift_error', {'error': 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù‡Ø¯ÙŠØ©'})

message_cooldowns = {}

@socketio.on('send_stream_message')
def handle_send_stream_message(data):
    """Ù…Ø¹Ø§Ù„Ø¬ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±"""
    try:
        if 'user_id' not in session:
            emit('message_error', {'error': 'ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„'})
            return
        
        user_id = session['user_id']
        game_id = data.get('game_id')
        message = data.get('message', '').strip()[:100]
        
        if not game_id or not message:
            emit('message_error', {'error': 'Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ§Ù„Ø­Ø©'})
            return
        
        current_time = time.time()
        cooldown_key = str(user_id)
        
        if cooldown_key in message_cooldowns:
            last_time = message_cooldowns[cooldown_key]
            time_passed = current_time - last_time
            if time_passed < 30:
                remaining = int(30 - time_passed)
                emit('message_cooldown', {'remaining_seconds': remaining})
                return
        
        message_cooldowns[cooldown_key] = current_time
        
        conn = get_db()
        cursor = conn.cursor()
        
        cursor.execute('SELECT username FROM users WHERE id = ?', (user_id,))
        user = cursor.fetchone()
        if not user:
            conn.close()
            emit('message_error', {'error': 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'})
            return
        
        sender_name = user['username']
        
        cursor.execute('''
            INSERT INTO stream_messages (game_id, sender_id, sender_name, message)
            VALUES (?, ?, ?, ?)
        ''', (game_id, user_id, sender_name, message))
        
        cursor.execute('''
            DELETE FROM stream_messages 
            WHERE id IN (
                SELECT id FROM stream_messages 
                WHERE game_id = ? 
                ORDER BY created_at DESC 
                LIMIT -1 OFFSET 6
            )
        ''', (game_id,))
        
        conn.commit()
        conn.close()
        
        message_payload = {
            'game_id': game_id,
            'sender_id': user_id,
            'sender_name': sender_name,
            'message': message,
            'timestamp': datetime.now().isoformat()
        }
        
        socketio.emit('stream_message_received', message_payload, room=f'ludo_game_{game_id}')
        socketio.emit('stream_message_received', message_payload, room=f'ludo_stream_{game_id}')
        
        emit('message_cooldown', {'remaining_seconds': 30})
        
        print(f'ğŸ’¬ Ø±Ø³Ø§Ù„Ø© Ø¨Ø«: {sender_name} ÙÙŠ Ø§Ù„Ù„Ø¹Ø¨Ø© {game_id}: {message[:30]}...')
        
    except Exception as e:
        print(f'âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¨Ø«: {e}')
        import traceback
        traceback.print_exc()
        emit('message_error', {'error': 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©'})

@socketio.on('forfeit_ludo_game')
def handle_forfeit_ludo_game(data):
    """Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„ÙÙˆØ±ÙŠ Ù…Ù† Ù„Ø¹Ø¨Ø© Ù„ÙˆØ¯Ùˆ Ø¹Ø¨Ø± Socket.IO"""
    if 'user_id' not in session:
        emit('forfeit_error', {'error': 'ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„'})
        return
    
    user_id = session['user_id']
    
    try:
        conn = get_db()
        cursor = conn.cursor()
        
        cursor.execute('''
            SELECT id, player1_id, player2_id, bet_amount 
            FROM ludo_active_games 
            WHERE (player1_id = ? OR player2_id = ?) 
            AND game_status = 'playing'
            LIMIT 1
        ''', (user_id, user_id))
        game = cursor.fetchone()
        
        if not game:
            emit('forfeit_confirmed', {'success': True, 'redirect': '/games/ludo'})
            conn.close()
            return
        
        opponent_id = game['player2_id'] if game['player1_id'] == user_id else game['player1_id']
        bet_return = game['bet_amount']
        
        if game['bet_amount'] == 0.30:
            prize = 0.20
        elif game['bet_amount'] == 1.00:
            prize = 0.80
        elif game['bet_amount'] == 3.00:
            prize = 2.50
        elif game['bet_amount'] == 5.00:
            prize = 4.00
        elif game['bet_amount'] == 10.00:
            prize = 7.00
        elif game['bet_amount'] == 50.00:
            prize = 40.00
        else:
            prize = 0.20
        
        cursor.execute('''
            UPDATE ludo_active_games 
            SET game_status = 'forfeited', 
                winner_id = ?,
                finished_at = CURRENT_TIMESTAMP
            WHERE id = ?
        ''', (opponent_id, game['id']))
        
        cursor.execute('''
            UPDATE users 
            SET balance = balance + ?
            WHERE id = ?
        ''', (bet_return + prize, opponent_id))
        
        total_winnings = bet_return + prize
        
        cursor.execute('''
            INSERT INTO notifications (user_id, message)
            VALUES (?, ?)
        ''', (opponent_id, f'ğŸ‰ ÙØ²Øª ÙÙŠ Ù„Ø¹Ø¨Ø© Ù„ÙˆØ¯Ùˆ Ø¨Ø³Ø¨Ø¨ Ø§Ù†Ø³Ø­Ø§Ø¨ Ø§Ù„Ø®ØµÙ… ÙˆØ±Ø¨Ø­Øª {total_winnings:.2f} $'))
        
        cursor.execute('''
            INSERT INTO notifications (user_id, message)
            VALUES (?, ?)
        ''', (user_id, f'âŒ ØªÙ… Ø§Ø¹ØªØ¨Ø§Ø±Ùƒ Ø®Ø§Ø³Ø± ÙÙŠ Ù„Ø¹Ø¨Ø© Ù„ÙˆØ¯Ùˆ Ø¨Ø³Ø¨Ø¨ Ø§Ù„Ø§Ù†Ø³Ø­Ø§Ø¨'))
        
        cursor.execute('''
            DELETE FROM ludo_matchmaking_queue 
            WHERE user_id = ?
        ''', (user_id,))
        
        conn.commit()
        
        game_over_update = {
            'type': 'game_over',
            'game_id': game['id'],
            'winner_id': opponent_id,
            'bet_amount': bet_return,
            'prize': prize,
            'player1_id': game['player1_id'],
            'player2_id': game['player2_id'],
            'forfeit': True,
            'forfeiter_id': user_id
        }
        socketio.emit('ludo_update', game_over_update, room=f'ludo_game_{game["id"]}')
        socketio.emit('ludo_update', game_over_update, room=f'ludo_stream_{game["id"]}')
        
        emit('forfeit_confirmed', {'success': True, 'redirect': '/games/ludo'})
        
        game_id = game['id']
        p1_id = game['player1_id']
        p2_id = game['player2_id']
        bet_amt = game['bet_amount']
        
        def save_forfeit_history():
            time.sleep(0.5)
            try:
                conn2 = get_db()
                cursor2 = conn2.cursor()
                
                cursor2.execute('SELECT player1_position, player2_position, created_at FROM ludo_active_games WHERE id = ?', (game_id,))
                game_row = cursor2.fetchone()
                if game_row:
                    p1_pos = game_row['player1_position']
                    p2_pos = game_row['player2_position']
                    created_at = game_row['created_at']
                else:
                    p1_pos = '{}'
                    p2_pos = '{}'
                    created_at = None
                
                game_string = f"{game_id}:{p1_id}:{p2_id}:{opponent_id}:{bet_amt}:forfeit:{user_id}:{datetime.now().isoformat()}"
                game_hash = hashlib.sha256(game_string.encode()).hexdigest()[:32]
                
                cursor2.execute('''
                    INSERT INTO ludo_game_history 
                    (game_id, player1_id, player2_id, bet_amount, winner_id, game_duration, total_moves,
                     player1_final_position, player2_final_position, game_hash, created_at, finished_at)
                    VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP)
                ''', (game_id, p1_id, p2_id, bet_amt, opponent_id, 0, 0, p1_pos, p2_pos, game_hash, created_at))
                
                cursor2.execute('DELETE FROM ludo_active_games WHERE id = ?', (game_id,))
                conn2.commit()
                conn2.close()
                print(f'âœ… ØªÙ… Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„ÙÙˆØ±ÙŠ Ù„Ù„Ø¹Ø¨Ø© {game_id}')
            except Exception as e:
                print(f'âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„Ø®Ø±ÙˆØ¬: {e}')
        
        threading.Thread(target=save_forfeit_history, daemon=True).start()
        
        conn.close()
        print(f'âš¡ Ø®Ø±ÙˆØ¬ ÙÙˆØ±ÙŠ: Ø§Ù„Ù„Ø§Ø¹Ø¨ {user_id} Ø§Ù†Ø³Ø­Ø¨ Ù…Ù† Ø§Ù„Ù„Ø¹Ø¨Ø© {game["id"]} - Ø§Ù„ÙØ§Ø¦Ø²: {opponent_id}')
        
    except Exception as e:
        print(f'âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„ÙÙˆØ±ÙŠ: {e}')
        import traceback
        traceback.print_exc()
        emit('forfeit_error', {'error': 'Ø­Ø¯Ø« Ø®Ø·Ø£'})

@socketio.on('join_streams_lobby')
def handle_join_streams_lobby():
    """Ø§Ù†Ø¶Ù…Ø§Ù… Ù„ØºØ±ÙØ© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¨Ø«ÙˆØ«"""
    join_room('live_streams_lobby')
    print('ğŸ“º Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù†Ø¶Ù… Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¨Ø«ÙˆØ«')

@socketio.on('join_admin_room')
def handle_join_admin_room():
    """Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù†Ø¶Ù…Ø§Ù… Ø§Ù„Ø£Ø¯Ù…Ù† Ù„ØºØ±ÙØ© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª"""
    join_room('admin_room')
    print('âœ… Ø§Ù„Ø£Ø¯Ù…Ù† Ø§Ù†Ø¶Ù… Ù„ØºØ±ÙØ© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª')

@socketio.on('disconnect')
def handle_disconnect():
    sid = request.sid
    
    game_id_to_decrement = None
    with stream_viewers_lock:
        if sid in stream_viewers:
            game_id_to_decrement = stream_viewers[sid]
            del stream_viewers[sid]
    
    if game_id_to_decrement:
        _decrement_viewer_count(game_id_to_decrement, sid)
        print(f'ğŸ‘‹ Ù…Ø´Ø§Ù‡Ø¯ Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆØªÙ… Ø¥Ù†Ù‚Ø§ØµÙ‡ Ù…Ù† Ø§Ù„Ø¨Ø« {game_id_to_decrement} (SID: {sid})')
    
    print(f'Client disconnected (SID: {sid})')

if __name__ == '__main__':
    init_db()
    start_background_workers()
    port = int(os.getenv('PORT', 5000))
    socketio.run(app, host='0.0.0.0', port=port, debug=False, allow_unsafe_werkzeug=True)